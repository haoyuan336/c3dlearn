var previewer=function(e){"use strict";function t(e,t,n,r,i,s,o){try{var a=e[s](o),c=a.value}catch(e){return void n(e)}a.done?t(c):Promise.resolve(c).then(r,i)}function n(e){return function(){var n=this,r=arguments;return new Promise(function(i,s){var o=e.apply(n,r);function a(e){t(o,i,s,a,c,"next",e)}function c(e){t(o,i,s,a,c,"throw",e)}a(void 0)})}}function r(e,t){for(var n=0;n<t.length;n++){var r=t[n];r.enumerable=r.enumerable||!1,r.configurable=!0,"value"in r&&(r.writable=!0),Object.defineProperty(e,r.key,r)}}function i(e,t){(null==t||t>e.length)&&(t=e.length);for(var n=0,r=new Array(t);n<t;n++)r[n]=e[n];return r}function s(e){if("undefined"==typeof Symbol||null==e[Symbol.iterator]){if(Array.isArray(e)||(e=function(e,t){if(e){if("string"==typeof e)return i(e,t);var n=Object.prototype.toString.call(e).slice(8,-1);return"Object"===n&&e.constructor&&(n=e.constructor.name),"Map"===n||"Set"===n?Array.from(n):"Arguments"===n||/^(?:Ui|I)nt(?:8|16|32)(?:Clamped)?Array$/.test(n)?i(e,t):void 0}}(e))){var t=0,n=function(){};return{s:n,n:function(){return t>=e.length?{done:!0}:{done:!1,value:e[t++]}},e:function(e){throw e},f:n}}throw new TypeError("Invalid attempt to iterate non-iterable instance.\nIn order to be iterable, non-array objects must have a [Symbol.iterator]() method.")}var r,s,o=!0,a=!1;return{s:function(){r=e[Symbol.iterator]()},n:function(){var e=r.next();return o=e.done,e},e:function(e){a=!0,s=e},f:function(){try{o||null==r.return||r.return()}finally{if(a)throw s}}}}var o={error:!1},a=function(){function e(t){!function(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}(this,e),this._query=void 0,this._toolbar=void 0,this._canvas=void 0,this._select=void 0,this._optsDebugMode=void 0,this._rotateButton=void 0,this._pauseButton=void 0,this._stepButton=void 0,this._showFpsButton=void 0,this._setFpsInput=void 0,this._progressBar=void 0,this._splash=void 0,this._gameContainer=void 0,this._rotated=void 0,this._devices=void 0,this._emit=void 0,this._devices=t.devices,this._emit=t.emit,this._query=document.querySelector.bind(document),this._canvas=this._queryChecked("#GameCanvas"),this._toolbar=this._queryChecked(".toolbar"),this._footer=this._queryChecked(".footer"),this._select=this._queryChecked("#opts-device"),this._optsDebugMode=this._queryChecked("#opts-debug-mode"),this._rotateButton=this._queryChecked("#btn-rotate"),this._pauseButton=this._queryChecked("#btn-pause"),this._stepButton=this._queryChecked("#btn-step"),this._showFpsButton=this._queryChecked("#btn-show-fps"),this._setFpsInput=this._queryChecked("#input-set-fps"),this._progressBar=this._queryChecked("#splash .progress-bar span"),this._select.value=this._select.getAttribute("value"),this._optsDebugMode.value=this._optsDebugMode.getAttribute("value"),this._rotated="checked"===this._rotateButton.className,this.setGameDivSize(),this.showLoading()}var t,n,i;return t=e,(n=[{key:"showLoading",value:function(e){if(!o.error)if(this._splash)this._splash.style.display=e?"":"none";else{var t=this._getEmulatedScreenSize(),n=t.width,r=t.height;this._splash=this._queryChecked("#splash");var i=this._queryChecked("#GameDiv");this._splash.style.width="".concat(Math.min(n,screen.width),"px"),this._splash.style.height="".concat(Math.min(r,screen.height),"px"),this._splash.style.display="",this._progressBar.style.width="0%",this._splash.style.width<this._splash.style.height&&(this._splash.style.backgroundImage='url("./../splash_portrait.png")'),i&&(i.style.visibility="visible"),this._isMobile()||(this._canvas.width=n,this._canvas.height=r)}}},{key:"setGameDivSize",value:function(){var e=this._queryChecked("#GameDiv"),t=this._getEmulatedScreenSize();e.style.width=t.width+"px",e.style.height=t.height+"px",this._isFullScreen()?(c(this._toolbar,"hide",!0),c(this._footer,"hide",!0)):(c(this._toolbar,"hide",!1),c(this._footer,"hide",!1))}},{key:"showError",value:function(e){this._queryChecked("#splash").style.display="none",this._queryChecked("#error").style.display="block",this._queryChecked("#error .error-main").innerText+=e,e="[preview-error]"+e,this._emit("preview error",e)}},{key:"hideSplash",value:function(){this._splash&&(this._splash.style.display="none")}},{key:"hintEmptyScene",value:function(){this._queryChecked("#bulletin").style.display="block",this._queryChecked("#sceneIsEmpty").style.display="block"}},{key:"bindEngine",value:function(e){var t=this;window.addEventListener("resize",function(){t.setGameDivSize(),t._updateResolution(e)}),this._rotateButton.addEventListener("click",function(){t._rotated=!t._rotated,c(t._rotateButton,"checked"),t.setGameDivSize(),t._updateResolution(e),t._emit("changeOption","rotate",t._rotated)}),this._select.addEventListener("change",function(n){t.setGameDivSize(),t._updateResolution(e),t._emit("changeOption","device",n.target.value)}),this._showFpsButton.addEventListener("click",function(){var n=!e.isDisplayStats();e.setDisplayStats(n),c(t._showFpsButton,"checked"),t._emit("changeOption","showFps",n)}),this._pauseButton.addEventListener("click",function(){!e.game.isPaused()?e.game.pause():e.game.resume(),c(t._pauseButton,"checked"),c(t._stepButton,"show")}),this._optsDebugMode.addEventListener("change",function(e){var n=e.target.value;window.cc.debug._resetDebugSetting(parseInt(n,10)),t._emit("changeOption","debugMode",n)}),this._setFpsInput.addEventListener("change",function(n){var r=parseInt(t._setFpsInput.value,10);isNaN(r)&&(r=60,t._setFpsInput.value=r.toString()),e.game.setFrameRate(r)}),this._stepButton.addEventListener("click",function(){e.game.step()}),c(this._toolbar,"disabled",!1)}},{key:"reportLoadProgress",value:function(e){this._progressBar.style.width=e.toFixed(2)+"%"}},{key:"_queryChecked",value:function(e){var t=this._query(e);if(t)return t;throw new Error("UI element ".concat(e," doesn't exist."))}},{key:"getRotatedCurrentSize",value:function(){var e=this._devices[this._select.value]&&this._devices[this._select.value].width||960,t=this._devices[this._select.value]&&this._devices[this._select.value].height||640;return this._rotated?{height:e,width:t}:{width:e,height:t}}},{key:"_getEmulatedScreenSize",value:function(){if(this._isFullScreen()){var e=screen,t=e.width,n=e.height;return this._rotated?{height:t,width:n}:{width:t,height:n}}return this.getRotatedCurrentSize()}},{key:"_isFullScreen",value:function(){return!!this._isMobile()||this.getRotatedCurrentSize().width>screen.width}},{key:"_isMobile",value:function(){var e,t=!1;return e=navigator.userAgent||navigator.vendor||window.opera,(/(android|bb\d+|meego).+mobile|avantgo|bada\/|blackberry|blazer|compal|elaine|fennec|hiptop|iemobile|ip(hone|od)|iris|kindle|lge |maemo|midp|mmp|mobile.+firefox|netfront|opera m(ob|in)i|palm( os)?|phone|p(ixi|re)\/|plucker|pocket|psp|series(4|6)0|symbian|treo|up\.(browser|link)|vodafone|wap|windows ce|xda|xiino|android|ipad|playbook|silk/i.test(e)||/1207|6310|6590|3gso|4thp|50[1-6]i|770s|802s|a wa|abac|ac(er|oo|s\-)|ai(ko|rn)|al(av|ca|co)|amoi|an(ex|ny|yw)|aptu|ar(ch|go)|as(te|us)|attw|au(di|\-m|r |s )|avan|be(ck|ll|nq)|bi(lb|rd)|bl(ac|az)|br(e|v)w|bumb|bw\-(n|u)|c55\/|capi|ccwa|cdm\-|cell|chtm|cldc|cmd\-|co(mp|nd)|craw|da(it|ll|ng)|dbte|dc\-s|devi|dica|dmob|do(c|p)o|ds(12|\-d)|el(49|ai)|em(l2|ul)|er(ic|k0)|esl8|ez([4-7]0|os|wa|ze)|fetc|fly(\-|_)|g1 u|g560|gene|gf\-5|g\-mo|go(\.w|od)|gr(ad|un)|haie|hcit|hd\-(m|p|t)|hei\-|hi(pt|ta)|hp( i|ip)|hs\-c|ht(c(\-| |_|a|g|p|s|t)|tp)|hu(aw|tc)|i\-(20|go|ma)|i230|iac( |\-|\/)|ibro|idea|ig01|ikom|im1k|inno|ipaq|iris|ja(t|v)a|jbro|jemu|jigs|kddi|keji|kgt( |\/)|klon|kpt |kwc\-|kyo(c|k)|le(no|xi)|lg( g|\/(k|l|u)|50|54|\-[a-w])|libw|lynx|m1\-w|m3ga|m50\/|ma(te|ui|xo)|mc(01|21|ca)|m\-cr|me(rc|ri)|mi(o8|oa|ts)|mmef|mo(01|02|bi|de|do|t(\-| |o|v)|zz)|mt(50|p1|v )|mwbp|mywa|n10[0-2]|n20[2-3]|n30(0|2)|n50(0|2|5)|n7(0(0|1)|10)|ne((c|m)\-|on|tf|wf|wg|wt)|nok(6|i)|nzph|o2im|op(ti|wv)|oran|owg1|p800|pan(a|d|t)|pdxg|pg(13|\-([1-8]|c))|phil|pire|pl(ay|uc)|pn\-2|po(ck|rt|se)|prox|psio|pt\-g|qa\-a|qc(07|12|21|32|60|\-[2-7]|i\-)|qtek|r380|r600|raks|rim9|ro(ve|zo)|s55\/|sa(ge|ma|mm|ms|ny|va)|sc(01|h\-|oo|p\-)|sdk\/|se(c(\-|0|1)|47|mc|nd|ri)|sgh\-|shar|sie(\-|m)|sk\-0|sl(45|id)|sm(al|ar|b3|it|t5)|so(ft|ny)|sp(01|h\-|v\-|v )|sy(01|mb)|t2(18|50)|t6(00|10|18)|ta(gt|lk)|tcl\-|tdg\-|tel(i|m)|tim\-|t\-mo|to(pl|sh)|ts(70|m\-|m3|m5)|tx\-9|up(\.b|g1|si)|utst|v400|v750|veri|vi(rg|te)|vk(40|5[0-3]|\-v)|vm40|voda|vulc|vx(52|53|60|61|70|80|81|83|85|98)|w3c(\-| )|webc|whit|wi(g |nc|nw)|wmlb|wonu|x700|yas\-|your|zeto|zte\-/i.test(e.substr(0,4)))&&(t=!0),t}},{key:"_updateResolution",value:function(e){var t=this._getEmulatedScreenSize(),n=t.width,r=t.height;this._gameContainer&&!this._gameContainer.style||(this._gameContainer=this._queryChecked("#Cocos3dGameContainer")),this._gameContainer.style.width="".concat(n,"px"),this._gameContainer.style.height="".concat(r,"px"),e.view._adjustSizeKeepCanvasSize()}},{key:"gameCanvas",get:function(){return this._canvas}},{key:"showFps",get:function(){return"checked"===this._showFpsButton.className}},{key:"debugMode",get:function(){return parseInt(this._optsDebugMode.value,10)}},{key:"frameRate",get:function(){return parseInt(this._setFpsInput.value,10)}}])&&r(t.prototype,n),i&&r(t,i),e}();function c(e,t,n){(void 0===n?!e.classList.contains(t):n)?e.classList.add(t):e.classList.remove(t)}function u(e){var t,n,r,i,s,o=e?e instanceof HTMLElement?e:document.querySelector(e)||document.querySelector("#"+e):null;return o&&"CANVAS"===o.tagName?(t=o.width,n=o.height,s=o,i=document.createElement("div"),s&&s.parentNode&&s.parentNode.insertBefore(i,s),i.setAttribute("id","Cocos3dGameContainer"),i.appendChild(s),r=i.parentNode===document.body?document.documentElement:i.parentNode,function(e,t){(" "+e.className+" ").indexOf(" "+t+" ")>-1||(e.className&&(e.className+=" "),e.className+=t)}(s,"gameCanvas"),s.setAttribute("width",t||"480"),s.setAttribute("height",n||"320"),s.setAttribute("tabindex","99"),{frame:r,container:i,canvas:s}):null}function h(e,t){return d.apply(this,arguments)}function d(){return(d=n(regeneratorRuntime.mark(function e(t,r){var i,o,a,c,h,d,p,m,v,g,f,_,y;return regeneratorRuntime.wrap(function(e){for(;;)switch(e.prev=e.next){case 0:return e.next=2,System.import("cc");case 2:if((i=e.sent).loader.onProgress=function(e,n){var r=100*e/n*.6;t.reportLoadProgress(r)},i.macro.ENABLE_TRANSPARENT_CANVAS=!0,i.macro.ENABLE_WEBGL_ANTIALIAS=!0,window.CC_WECHATGAME=!1,o={libraryPath:"res/import",rawAssetsBase:"res/raw-",rawAssets:r.settings.rawAssets},a=u(t.gameCanvas)){e.next=11;break}throw new Error(i.debug.getError(200));case 11:c={id:t.gameCanvas,showFPS:t.showFps,scenes:r.settings.scenes,debugMode:t.debugMode,frameRate:t.frameRate,groupList:r.settings.groupList,collisionMatrix:r.settings.collisionMatrix,adapter:a,renderPipeline:r.settings.renderPipeline,assetOptions:o,customJointTextureLayouts:r.settings.customJointTextureLayouts||[]},h=(r.settings.jsList||[]).map(function(e){return o.rawAssetsBase+e}),r.settings.jsBundleForWebPreview&&h.push(r.settings.jsBundleForWebPreview),d=s(h),e.prev=15,m=regeneratorRuntime.mark(function e(){var t;return regeneratorRuntime.wrap(function(e){for(;;)switch(e.prev=e.next){case 0:return t=p.value,e.next=3,new Promise(function(e,n){var r;function i(e){e.filename===t&&(r=e.error)}window.addEventListener("error",i);var s=document.createElement("script");s.charset="utf-8",s.async=!0,s.crossOrigin="anonymous",s.addEventListener("error",function(){window.removeEventListener("error",i),n(Error("Error loading "+t))}),s.addEventListener("load",function(){window.removeEventListener("error",i),document.head.removeChild(s),r?n(r):e()}),s.src=t,document.head.appendChild(s)});case 3:case"end":return e.stop()}},e)}),d.s();case 18:if((p=d.n()).done){e.next=22;break}return e.delegateYield(m(),"t0",20);case 20:e.next=18;break;case 22:e.next=27;break;case 24:e.prev=24,e.t1=e.catch(15),d.e(e.t1);case 27:return e.prev=27,d.f(),e.finish(27);case 30:return e.next=32,Promise.all(r.settings.scripts.map(function(){var e=n(regeneratorRuntime.mark(function e(t){return regeneratorRuntime.wrap(function(e){for(;;)switch(e.prev=e.next){case 0:if(t.defer){e.next=2;break}return e.abrupt("return",System.import(t.moduleId));case 2:case"end":return e.stop()}},e)}));return function(t){return e.apply(this,arguments)}}()));case 32:return e.next=34,new Promise(function(e){i.game.init(c),i.game.run(e)});case 34:return i.game.canvas.setAttribute("tabindex",-1),i.game.canvas.style.backgroundColor="",i.director.once(i.Director.EVENT_AFTER_SCENE_LAUNCH,function(){t.hideSplash(),l(i)&&t.hintEmptyScene()}),i.view.enableRetina(!0),i.view.resizeWithBrowserSize(!0),i.view.enableAutoFullScreen(!1),v=r.settings.designResolution,g=v.width,f=v.height,_=v.policy,i.view.setDesignResolutionSize(Number(g),Number(f),_||i.ResolutionPolicy.FIXED_HEIGHT),i.game.pause(),e.next=45,new Promise(function(e,t){var n=new XMLHttpRequest;n.responseType="text",n.addEventListener("load",function(){200===n.status&&e(JSON.parse(n.response))}),n.open("GET","current-scene.json",!0),n.send()});case 45:return y=e.sent,i.AssetLibrary.loadJson(y,function(e,t){if(e)i.error(e.stack);else{var n=t.scene;n._name=t._name,i.director.runSceneImmediate(n,function(){i.game.resume()}),i.loader.onProgress=null}}),e.next=49,new Promise(function(e){setTimeout(e,100)});case 49:case"end":return e.stop()}},e,null,[[15,24,27,30]])}))).apply(this,arguments)}function l(e){var t=e.director.getScene();if(t&&0!==t.children.length){if(t.children.length>1)return!1;var n=t.children[0];return!(n.children.length>0||n._components.length>1||n._components.length>0&&!(n.child0[0]instanceof e.CanvasComponent))}return!0}function p(e){return m.apply(this,arguments)}function m(){return(m=n(regeneratorRuntime.mark(function e(t){var r,i,s,c,u,d,l;return regeneratorRuntime.wrap(function(e){for(;;)switch(e.prev=e.next){case 0:return l=function(){return(l=n(regeneratorRuntime.mark(function e(){var t,n;return regeneratorRuntime.wrap(function(e){for(;;)switch(e.prev=e.next){case 0:return e.next=2,System.import("/socket.io/socket.io.js");case 2:return t=e.sent,(n=t.default()).on("browser:reload",function(){window.location.reload()}),n.on("browser:disconnect",function(){window.location.reload()}),e.abrupt("return",n);case 7:case"end":return e.stop()}},e)}))).apply(this,arguments)},d=function(){return l.apply(this,arguments)},u=function(){window.addEventListener("error",function(e){o.error=!0;var t=[].toString.call(e,e);return console.error(e),"[object Event]"===t?i.showError("load ".concat(e.target.src," failed")):i.showError("".concat(e.message," in ").concat(e.filename)),!0},!0)},function(e){for(var t={imports:{}},n=0;n<e.settings.scripts.length;++n){var r=e.settings.scripts[n];t.imports[r.moduleId]=r.file}var i=document.createElement("script");i.type="systemjs-importmap",i.text=JSON.stringify(t,void 0,2),document.body.appendChild(i),System.register("cc",[e.engine],function(e,t){var n;return{setters:[function(e){n=e.default}],execute:function(){e(n)}}})}(t),e.next=7,d();case 7:return r=e.sent,i=new a({devices:t.devices,emit:function(e){for(var t=arguments.length,n=new Array(t>1?t-1:0),i=1;i<t;i++)n[i-1]=arguments[i];r.emit.apply(r,[e].concat(n))}}),u(),e.next=12,System.import(t.engine);case 12:return s=e.sent,c=s.default,System.register("cc",[],function(e,t){return{setters:[],execute:function(){e(c)}}}),i.bindEngine(c),e.next=18,h(i,t);case 18:case"end":return e.stop()}},e)}))).apply(this,arguments)}return e.bootstrap=function(e){n(regeneratorRuntime.mark(function t(){return regeneratorRuntime.wrap(function(t){for(;;)switch(t.prev=t.next){case 0:return t.next=2,p(e);case 2:case"end":return t.stop()}},t)}))()},e}({});