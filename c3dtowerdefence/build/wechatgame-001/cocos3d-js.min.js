"use strict";Object.defineProperty(exports,"__esModule",{value:!0});var e="undefined"==typeof window?global:window,t=e.cc=e.cc||{};t.internal=t.internal||{},t._global=e,e.CC_BUILD=!0,e.CC_TEST=!1,e.CC_EDITOR=!1,e.CC_PREVIEW=!1,e.CC_DEV=!1,e.CC_DEBUG=!1,e.CC_JSB=!1,e.CC_WECHAT=!0,e.CC_ALIPAY=!1,e.CC_XIAOMI=!1,e.CC_BAIDU=!1,e.CC_BYTEDANCE=!1,e.CC_COCOSPLAY=!1,e.CC_MINIGAME=!0,e.CC_RUNTIME_BASED=!1,e.CC_SUPPORT_JIT=!1,e.CC_PHYSICS_BUILTIN=!0,e.CC_PHYSICS_CANNON=!1,e.CC_PHYSICS_AMMO=!1;e.CocosEngine=t.ENGINE_VERSION="1.1.2",Object.defineProperty(e,"CC_PHYSICS_BUILT_IN",{get:function(){return console.warn("CC_PHYSICS_BUILT_IN is deprecated, please using CC_PHYSICS_BUILTIN instead."),e.CC_PHYSICS_BUILTIN}});var i="https://github.com/cocos-creator/engine/blob/3d/EngineErrorMap.md",n=null,r=console.log,a=console.log,o=console.log,s=function(e,t){if(!e){for(var i=arguments.length,n=new Array(i>2?i-2:0),r=2;r<i;r++)n[r-2]=arguments[r];console.log("ASSERT: "+l.apply(void 0,[t].concat(n)))}};function l(e){for(var t=arguments.length,i=new Array(t>1?t-1:0),n=1;n<t;n++)i[n-1]=arguments[n];return cc.js.formatStr.apply(null,[e].concat(i))}function u(e){for(var t=arguments.length,i=new Array(t>1?t-1:0),n=1;n<t;n++)i[n-1]=arguments[n];return r.apply(void 0,[e].concat(i))}function c(e){for(var t=arguments.length,i=new Array(t>1?t-1:0),n=1;n<t;n++)i[n-1]=arguments[n];return a.apply(void 0,[e].concat(i))}function h(e){for(var t=arguments.length,i=new Array(t>1?t-1:0),n=1;n<t;n++)i[n-1]=arguments[n];return o.apply(void 0,[e].concat(i))}function p(e,t){for(var i=arguments.length,n=new Array(i>2?i-2:0),r=2;r<i;r++)n[r-2]=arguments[r];return s.apply(void 0,[e,t].concat(n))}function _(e){if(r=a=o=s=function(){},e!==T.NONE){if(e>T.ERROR){var t=function(e){if(cc.game.canvas){if(!n){var t=document.createElement("Div");t.setAttribute("id","logInfoDiv"),t.setAttribute("width","200"),t.setAttribute("height",cc.game.canvas.height);var i=t.style;i.zIndex="99999",i.position="absolute",i.top=i.left="0",(n=document.createElement("textarea")).setAttribute("rows","20"),n.setAttribute("cols","30"),n.setAttribute("disabled","true");var r=n.style;r.backgroundColor="transparent",r.borderBottom="1px solid #cccccc",r.borderTopWidth=r.borderLeftWidth=r.borderRightWidth="0px",r.borderTopStyle=r.borderLeftStyle=r.borderRightStyle="none",r.padding="0px",r.margin="0px",t.appendChild(n),cc.game.canvas.parentNode.appendChild(t)}n.value=n.value+e+"\r\n",n.scrollTop=n.scrollHeight}};o=function(e){for(var i=arguments.length,n=new Array(i>1?i-1:0),r=1;r<i;r++)n[r-1]=arguments[r];t("ERROR :  "+l.apply(void 0,[e].concat(n)))},s=function(e,i){if(!e){for(var n=arguments.length,r=new Array(n>2?n-2:0),a=2;a<n;a++)r[a-2]=arguments[a];t("ASSERT: "+l.apply(void 0,[i].concat(r)))}},e!==T.ERROR_FOR_WEB_PAGE&&(a=function(e){for(var i=arguments.length,n=new Array(i>1?i-1:0),r=1;r<i;r++)n[r-1]=arguments[r];t("WARN :  "+l.apply(void 0,[e].concat(n)))}),e===T.INFO_FOR_WEB_PAGE&&(r=function(e){for(var i=arguments.length,n=new Array(i>1?i-1:0),r=1;r<i;r++)n[r-1]=arguments[r];t(l.apply(void 0,[e].concat(n)))})}else console&&console.log.apply&&(console.error||(console.error=console.log),console.warn||(console.warn=console.log),o=console.error.bind?console.error.bind(console):function(e){for(var t=arguments.length,i=new Array(t>1?t-1:0),n=1;n<t;n++)i[n-1]=arguments[n];return console.error.apply(console,[e].concat(i))},s=function(e,t){if(!e){for(var i=arguments.length,n=new Array(i>2?i-2:0),r=2;r<i;r++)n[r-2]=arguments[r];var a=l.apply(void 0,[t].concat(n));throw new Error(a)}});e!==T.ERROR&&(a=console.warn.bind?console.warn.bind(console):function(e){for(var t=arguments.length,i=new Array(t>1?t-1:0),n=1;n<t;n++)i[n-1]=arguments[n];return console.warn.apply(console,[e].concat(i))}),e===T.INFO&&(r=console.log.bind?console.log.bind(console):function(e){for(var t=arguments.length,i=new Array(t>1?t-1:0),n=1;n<t;n++)i[n-1]=arguments[n];return console.log.apply(console,[e].concat(i))})}}function f(e){var t=e.stack;h(t||e)}function d(e){return function(t){for(var n="".concat(e," ").concat(t,", please go to ").concat(i,"#").concat(t," to see details."),r=arguments.length,a=new Array(r>1?r-1:0),o=1;o<r;o++)a[o-1]=arguments[o];return 0===a.length?n:n+" Arguments: "+a.join(", ")}}var m=d("Log");function v(e){for(var t=arguments.length,i=new Array(t>1?t-1:0),n=1;n<t;n++)i[n-1]=arguments[n];u(m.apply(void 0,[e].concat(i)))}var y=d("Warning");function g(e){for(var t=arguments.length,i=new Array(t>1?t-1:0),n=1;n<t;n++)i[n-1]=arguments[n];c(y.apply(void 0,[e].concat(i)))}var x=d("Error");function b(e){for(var t=arguments.length,i=new Array(t>1?t-1:0),n=1;n<t;n++)i[n-1]=arguments[n];h(x.apply(void 0,[e].concat(i)))}var T,S=d("Assert");function E(e,t){if(!e){for(var i=arguments.length,n=new Array(i>2?i-2:0),r=2;r<i;r++)n[r-2]=arguments[r];p(!1,S.apply(void 0,[t].concat(n)))}}function w(e){for(var t=arguments.length,i=new Array(t>1?t-1:0),n=1;n<t;n++)i[n-1]=arguments[n];return x.apply(void 0,[e].concat(i))}function C(){return!!cc.profiler&&cc.profiler.isShowingStats()}function A(e){cc.profiler&&(e?cc.profiler.showStats():cc.profiler.hideStats(),cc.game.config.showFPS=!!e)}!function(e){e[e.NONE=0]="NONE",e[e.INFO=1]="INFO",e[e.WARN=2]="WARN",e[e.ERROR=3]="ERROR",e[e.INFO_FOR_WEB_PAGE=4]="INFO_FOR_WEB_PAGE",e[e.WARN_FOR_WEB_PAGE=5]="WARN_FOR_WEB_PAGE",e[e.ERROR_FOR_WEB_PAGE=6]="ERROR_FOR_WEB_PAGE"}(T||(T={}));var O=Object.freeze({__proto__:null,log:u,warn:c,error:h,assert:p,_resetDebugSetting:_,_throw:f,logID:v,warnID:g,errorID:b,assertID:E,get DebugMode(){return T},getError:w,isDisplayStats:C,setDisplayStats:A}),k=/(\.[^\.\/\?\\]*)(\?.*)?$/,R=/((.*)(\/|\\|\\\\))?(.*?\..*$)?/,F=/[^\.\/]+\/\.\.\//;function M(){for(var e="",t=arguments.length,i=new Array(t),n=0;n<t;n++)i[n]=arguments[n];for(var r=0,a=i;r<a.length;r++){var o=a[r];e=(e+(""===e?"":"/")+o).replace(/(\/|\\\\)$/,"")}return e}function I(e){var t=k.exec(e);return t?t[1]:""}function P(e){if(e){var t=e.lastIndexOf(".");if(-1!==t)return e.substring(0,t)}return e}function L(e,t){var i=e.indexOf("?");i>0&&(e=e.substring(0,i));var n=/(\/|\\)([^\/\\]+)$/g.exec(e.replace(/(\/|\\)$/,""));if(!n)return"";var r=n[2];return t&&e.substring(e.length-t.length).toLowerCase()===t.toLowerCase()?r.substring(0,r.length-t.length):r}function D(e){var t=R.exec(e);return t?t[2]:""}function N(e,t){t=t||"";var i=e.indexOf("?"),n="";return i>0&&(n=e.substring(i),e=e.substring(0,i)),(i=e.lastIndexOf("."))<0?e+t+n:e.substring(0,i)+t+n}function z(e,t,i){if(0===t.indexOf("."))return N(e,t);var n=e.indexOf("?"),r="",a=i?I(e):"";return n>0&&(r=e.substring(n),e=e.substring(0,n)),n=(n=e.lastIndexOf("/"))<=0?0:n+1,e.substring(0,n)+t+a+r}function B(e){var t=e=String(e);do{t=e,e=e.replace(F,"")}while(t.length!==e.length);return e}function G(e){return e.replace(/[\/\\]$/,"")}function U(){return cc.sys.os===cc.sys.OS_WINDOWS?"\\":"/"}var X=Object.freeze({__proto__:null,join:M,extname:I,mainFileName:P,basename:L,dirname:D,changeExtname:N,changeBasename:z,_normalize:B,stripSep:G,getSeperator:U});cc.log=u,cc.warn=c,cc.error=h,cc.assert=p,cc._throw=f,cc.logID=v,cc.warnID=g,cc.errorID=b,cc.assertID=E,cc.debug=O,cc.path={join:M,extname:I,mainFileName:P,basename:L,dirname:D,changeExtname:N,changeBasename:z,_normalize:B,stripSep:G,get sep(){return U()}};var V={SHAPE_RAY:1,SHAPE_LINE:2,SHAPE_SPHERE:4,SHAPE_AABB:8,SHAPE_OBB:16,SHAPE_PLANE:32,SHAPE_TRIANGLE:64,SHAPE_FRUSTUM:128,SHAPE_FRUSTUM_ACCURATE:256,SHAPE_CAPSULE:512};function H(e){return(e>0)-(e<0)}function W(e){var t=32;return(e&=-e)&&t--,65535&e&&(t-=16),16711935&e&&(t-=8),252645135&e&&(t-=4),858993459&e&&(t-=2),1431655765&e&&(t-=1),t}function j(e){return e+=0===e,--e,e|=e>>>1,e|=e>>>2,e|=e>>>4,e|=e>>>8,(e|=e>>>16)+1}var q=new Array(256);!function(e){for(var t=0;t<256;++t){var i=t,n=t,r=7;for(i>>>=1;i;i>>>=1)n<<=1,n|=1&i,--r;e[t]=n<<r&255}}(q);var Y=Object.freeze({__proto__:null,INT_BITS:32,INT_MAX:2147483647,INT_MIN:-1<<31,sign:H,abs:function(e){var t=e>>31;return(e^t)-t},min:function(e,t){return t^(e^t)&-(e<t)},max:function(e,t){return e^(e^t)&-(e<t)},isPow2:function(e){return!(e&e-1||!e)},log2:function(e){var t,i;return t=(e>65535)<<4,t|=i=((e>>>=t)>255)<<3,t|=i=((e>>>=i)>15)<<2,(t|=i=((e>>>=i)>3)<<1)|(e>>>=i)>>1},log10:function(e){return e>=1e9?9:e>=1e8?8:e>=1e7?7:e>=1e6?6:e>=1e5?5:e>=1e4?4:e>=1e3?3:e>=100?2:e>=10?1:0},popCount:function(e){return 16843009*((e=(858993459&(e-=e>>>1&1431655765))+(e>>>2&858993459))+(e>>>4)&252645135)>>>24},countTrailingZeros:W,nextPow2:j,prevPow2:function(e){return e|=e>>>1,e|=e>>>2,e|=e>>>4,e|=e>>>8,(e|=e>>>16)-(e>>>1)},parity:function(e){return e^=e>>>16,e^=e>>>8,e^=e>>>4,27030>>>(e&=15)&1},reverse:function(e){return q[255&e]<<24|q[e>>>8&255]<<16|q[e>>>16&255]<<8|q[e>>>24&255]},interleave2:function(e,t){return(e=1431655765&((e=858993459&((e=252645135&((e=16711935&((e&=65535)|e<<8))|e<<4))|e<<2))|e<<1))|(t=1431655765&((t=858993459&((t=252645135&((t=16711935&((t&=65535)|t<<8))|t<<4))|t<<2))|t<<1))<<1},deinterleave2:function(e,t){return(e=65535&((e=16711935&((e=252645135&((e=858993459&((e=e>>>t&1431655765)|e>>>1))|e>>>2))|e>>>4))|e>>>16))<<16>>16},interleave3:function(e,t,i){return e=1227133513&((e=3272356035&((e=251719695&((e=4278190335&((e&=1023)|e<<16))|e<<8))|e<<4))|e<<2),(e|=(t=1227133513&((t=3272356035&((t=251719695&((t=4278190335&((t&=1023)|t<<16))|t<<8))|t<<4))|t<<2))<<1)|(i=1227133513&((i=3272356035&((i=251719695&((i=4278190335&((i&=1023)|i<<16))|i<<8))|i<<4))|i<<2))<<2},deinterleave3:function(e,t){return(e=1023&((e=4278190335&((e=251719695&((e=3272356035&((e=e>>>t&1227133513)|e>>>2))|e>>>4))|e>>>8))|e>>>16))<<22>>22},nextCombination:function(e){var t=e|e-1;return t+1|(~t&-~t)-1>>>W(e)+1}});function K(e){return(K="function"==typeof Symbol&&"symbol"==typeof Symbol.iterator?function(e){return typeof e}:function(e){return e&&"function"==typeof Symbol&&e.constructor===Symbol&&e!==Symbol.prototype?"symbol":typeof e})(e)}function Z(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}function Q(e,t){for(var i=0;i<t.length;i++){var n=t[i];n.enumerable=n.enumerable||!1,n.configurable=!0,"value"in n&&(n.writable=!0),Object.defineProperty(e,n.key,n)}}function J(e,t,i){return t&&Q(e.prototype,t),i&&Q(e,i),e}function $(e,t,i){return t in e?Object.defineProperty(e,t,{value:i,enumerable:!0,configurable:!0,writable:!0}):e[t]=i,e}function ee(e,t){if("function"!=typeof t&&null!==t)throw new TypeError("Super expression must either be null or a function");e.prototype=Object.create(t&&t.prototype,{constructor:{value:e,writable:!0,configurable:!0}}),t&&ie(e,t)}function te(e){return(te=Object.setPrototypeOf?Object.getPrototypeOf:function(e){return e.__proto__||Object.getPrototypeOf(e)})(e)}function ie(e,t){return(ie=Object.setPrototypeOf||function(e,t){return e.__proto__=t,e})(e,t)}function ne(e){if(void 0===e)throw new ReferenceError("this hasn't been initialised - super() hasn't been called");return e}function re(e,t){return!t||"object"!=typeof t&&"function"!=typeof t?ne(e):t}function ae(e,t){for(;!Object.prototype.hasOwnProperty.call(e,t)&&null!==(e=te(e)););return e}function oe(e,t,i){return(oe="undefined"!=typeof Reflect&&Reflect.get?Reflect.get:function(e,t,i){var n=ae(e,t);if(n){var r=Object.getOwnPropertyDescriptor(n,t);return r.get?r.get.call(i):r.value}})(e,t,i||e)}function se(e,t,i,n){return(se="undefined"!=typeof Reflect&&Reflect.set?Reflect.set:function(e,t,i,n){var r,a=ae(e,t);if(a){if((r=Object.getOwnPropertyDescriptor(a,t)).set)return r.set.call(n,i),!0;if(!r.writable)return!1}if(r=Object.getOwnPropertyDescriptor(n,t)){if(!r.writable)return!1;r.value=i,Object.defineProperty(n,t,r)}else $(n,t,i);return!0})(e,t,i,n)}function le(e,t,i,n,r){if(!se(e,t,i,n||e)&&r)throw new Error("failed to set property");return i}function ue(e,t){return function(e){if(Array.isArray(e))return e}(e)||function(e,t){if("undefined"==typeof Symbol||!(Symbol.iterator in Object(e)))return;var i=[],n=!0,r=!1,a=void 0;try{for(var o,s=e[Symbol.iterator]();!(n=(o=s.next()).done)&&(i.push(o.value),!t||i.length!==t);n=!0);}catch(e){r=!0,a=e}finally{try{n||null==s.return||s.return()}finally{if(r)throw a}}return i}(e,t)||he(e,t)||function(){throw new TypeError("Invalid attempt to destructure non-iterable instance.\nIn order to be iterable, non-array objects must have a [Symbol.iterator]() method.")}()}function ce(e){return function(e){if(Array.isArray(e))return pe(e)}(e)||function(e){if("undefined"!=typeof Symbol&&Symbol.iterator in Object(e))return Array.from(e)}(e)||he(e)||function(){throw new TypeError("Invalid attempt to spread non-iterable instance.\nIn order to be iterable, non-array objects must have a [Symbol.iterator]() method.")}()}function he(e,t){if(e){if("string"==typeof e)return pe(e,t);var i=Object.prototype.toString.call(e).slice(8,-1);return"Object"===i&&e.constructor&&(i=e.constructor.name),"Map"===i||"Set"===i?Array.from(i):"Arguments"===i||/^(?:Ui|I)nt(?:8|16|32)(?:Clamped)?Array$/.test(i)?pe(e,t):void 0}}function pe(e,t){(null==t||t>e.length)&&(t=e.length);for(var i=0,n=new Array(t);i<t;i++)n[i]=e[i];return n}function _e(e){var t=0;if("undefined"==typeof Symbol||null==e[Symbol.iterator]){if(Array.isArray(e)||(e=he(e)))return function(){return t>=e.length?{done:!0}:{done:!1,value:e[t++]}};throw new TypeError("Invalid attempt to iterate non-iterable instance.\nIn order to be iterable, non-array objects must have a [Symbol.iterator]() method.")}return(t=e[Symbol.iterator]()).next.bind(t)}function fe(e,t,i,n){i&&Object.defineProperty(e,t,{enumerable:i.enumerable,configurable:i.configurable,writable:i.writable,value:i.initializer?i.initializer.call(n):void 0})}function de(e,t,i,n,r){var a={};return Object.keys(n).forEach((function(e){a[e]=n[e]})),a.enumerable=!!a.enumerable,a.configurable=!!a.configurable,("value"in a||a.initializer)&&(a.writable=!0),a=i.slice().reverse().reduce((function(i,n){return n(e,t,i)||i}),a),r&&void 0!==a.initializer&&(a.value=a.initializer?a.initializer.call(r):void 0,a.initializer=void 0),void 0===a.initializer&&(Object.defineProperty(e,t,a),a=null),a}var me=function(){function e(t){Z(this,e),this.i=0,this.array=t}return J(e,[{key:"remove",value:function(e){var t=this.array.indexOf(e);t>=0&&this.removeAt(t)}},{key:"removeAt",value:function(e){this.array.splice(e,1),e<=this.i&&--this.i}},{key:"fastRemove",value:function(e){var t=this.array.indexOf(e);t>=0&&this.fastRemoveAt(t)}},{key:"fastRemoveAt",value:function(e){var t=this.array;t[e]=t[t.length-1],--t.length,e<=this.i&&--this.i}},{key:"push",value:function(e){this.array.push(e)}},{key:"length",get:function(){return this.array.length},set:function(e){this.array.length=e,this.i>=e&&(this.i=e-1)}}]),e}();function ve(e,t){e.splice(t,1)}function ye(e,t){var i=e.indexOf(t);return i>=0&&(ve(e,i),!0)}function ge(e,t){return e.indexOf(t)>=0}var xe=Object.freeze({__proto__:null,removeAt:ve,fastRemoveAt:function(e,t){var i=e.length;t<0||t>=i||(e[t]=e[i-1],e.length=i-1)},remove:ye,fastRemove:function(e,t){var i=e.indexOf(t);i>=0&&(e[i]=e[e.length-1],--e.length)},removeIf:function(e,t){var i=e.findIndex(t);if(i>=0){var n=e[i];return ve(e,i),n}},verifyType:function(e,t){if(e&&e.length>0)for(var i,n=_e(e);!(i=n()).done;){if(!(i.value instanceof t))return cc.logID(1300),!1}return!0},removeArray:function(e,t){for(var i=0,n=t.length;i<n;i++)ye(e,t[i])},appendObjectsAt:function(e,t,i){return e.splice.apply(e,[i,0].concat(ce(t))),e},contains:ge,copy:function(e){for(var t=e.length,i=new Array(t),n=0;n<t;n+=1)i[n]=e[n];return i},MutableForwardIterator:me}),be=function(){function e(t){Z(this,e),this.id=void 0,this.prefix=void 0,this.id=0|998*Math.random(),this.prefix=t?t+".":""}return J(e,[{key:"getNewId",value:function(){return this.prefix+ ++this.id}}]),e}();be.global=new be("global");var Te=new be("TmpCId.");function Se(e){return"number"==typeof e||e instanceof Number}function Ee(e){return"string"==typeof e||e instanceof String}var we,Ce=(we={value:void 0,enumerable:!1,writable:!1,configurable:!0},function(e,t,i,n,r){we.value=i,we.writable=n,we.enumerable=r,Object.defineProperty(e,t,we),we.value=void 0}),Ae=function(){var e={get:void 0,set:void 0,enumerable:!1};return function(t,i,n,r){var a=arguments.length>4&&void 0!==arguments[4]&&arguments[4],o=arguments.length>5&&void 0!==arguments[5]&&arguments[5];"boolean"==typeof r&&(a=r,r=void 0),e.get=n,e.set=r,e.enumerable=a,e.configurable=o,Object.defineProperty(t,i,e),e.get=void 0,e.set=void 0}}(),Oe=function(){var e={get:void 0,enumerable:!1,configurable:!1};return function(t,i,n,r,a){e.get=n,e.enumerable=r,e.configurable=a,Object.defineProperty(t,i,e),e.get=void 0}}(),ke=function(){var e={set:void 0,enumerable:!1,configurable:!1};return function(t,i,n,r,a){e.set=n,e.enumerable=r,e.configurable=a,Object.defineProperty(t,i,e),e.set=void 0}}();function Re(e){var t=Object.create(null);if(e){t["."]=!0,t["/"]=!0,delete t["."],delete t["/"]}return t}function Fe(e){if("function"==typeof e){var t=e.prototype;if(t&&t.hasOwnProperty("__classname__")&&t.__classname__)return t.__classname__;var i="";if(e.name&&(i=e.name),e.toString){var n,r=e.toString();(n="["===r.charAt(0)?r.match(/\[\w+\s*(\w+)\]/):r.match(/function\s*(\w+)/))&&2===n.length&&(i=n[1])}return"Object"!==i?i:""}return e&&e.constructor?Fe(e.constructor):""}function Me(e,t,i,n){var r=/([^.]+)$/,a=r.exec(t)[0],o=r.exec(i)[0];function s(){return this[o]}n?Ae(e,a,s,(function(e){this[o]=e})):Oe(e,a,s)}function Ie(e,t,i,n){for(var r in i){Me(e,t+"."+r,i[r],n)}}var Pe=/(%d)|(%s)/,Le=/%s/;function De(e){for(var t=arguments.length,i=new Array(t>1?t-1:0),n=1;n<t;n++)i[n-1]=arguments[n];if(0===arguments.length)return"";if(0===i.length)return""+e;var r="string"==typeof e&&Pe.test(e);if(r)for(var a,o=_e(i);!(a=o()).done;){var s=a.value,l="number"==typeof s?Pe:Le;l.test(e)?e=e.replace(l,s):e+=" "+s}else for(var u,c=_e(i);!(u=c()).done;){var h=u.value;e+=" "+h}return e}function Ne(){for(var e=arguments.length-1,t=new Array(e),i=0;i<e;++i)t[i]=arguments[i+1];return t}function ze(e,t){for(;e;){var i=Object.getOwnPropertyDescriptor(e,t);if(i)return i;e=Object.getPrototypeOf(e)}return null}function Be(e,t,i){var n=ze(t,e);n&&Object.defineProperty(i,e,n)}function Ge(e){e=e||{};for(var t=arguments.length,i=new Array(t>1?t-1:0),n=1;n<t;n++)i[n-1]=arguments[n];for(var r=0,a=i;r<a.length;r++){var o=a[r];if(o){if("object"!==K(o)){cc.errorID(5402,o);continue}for(var s in o)s in e||Be(s,o,e)}}return e}function Ue(e){e=e||{};for(var t=arguments.length,i=new Array(t>1?t-1:0),n=1;n<t;n++)i[n-1]=arguments[n];for(var r=0,a=i;r<a.length;r++){var o=a[r];if(o){if("object"!==K(o)){cc.errorID(5403,o);continue}for(var s in o)Be(s,o,e)}}return e}function Xe(e,t){for(var i in t)t.hasOwnProperty(i)&&(e[i]=t[i]);return e.prototype=Object.create(t.prototype,{constructor:{value:e,writable:!0,configurable:!0}}),e}function Ve(e){var t=e.prototype,i=t&&Object.getPrototypeOf(t);return i&&i.constructor}function He(e,t){if(e&&t){if("function"!=typeof e)return!1;if("function"!=typeof t)return!1;if(e===t)return!0;for(;;){if(!(e=Ve(e)))return!1;if(e===t)return!0}}return!1}function We(e){for(var t=0,i=Object.keys(e);t<i.length;t++){delete e[i[t]]}}var je={},qe={};function Ye(e,t){var i="__cid__",n=je;if(t.prototype.hasOwnProperty(i)&&delete n[t.prototype[i]],Ce(t.prototype,i,e),e){var r=n[e];if(r&&r!==t){var a="A Class already exists with the same "+i+' : "'+e+'".';cc.error(a)}else n[e]=t}}function Ke(e,t){if(function(e,t){var i="__classname__",n=qe;if(t.prototype.hasOwnProperty(i)&&delete n[t.prototype[i]],Ce(t.prototype,i,e),e){var r=n[e];if(r&&r!==t){var a="A Class already exists with the same "+i+' : "'+e+'".';cc.error(a)}else n[e]=t}}(e,t),!t.prototype.hasOwnProperty("__cid__")){var i=e||Te.getNewId();i&&Ye(i,t)}}function Ze(){for(var e=arguments.length,t=new Array(e),i=0;i<e;i++)t[i]=arguments[i];for(var n=0,r=t;n<r.length;n++){var a=r[n],o=a.prototype,s=o.__cid__;s&&delete je[s];var l=o.__classname__;l&&delete qe[l]}}function Qe(e){return je[e]}function Je(e){return qe[e]}function $e(e,t){if(t=void 0===t||t,"function"==typeof e&&e.prototype.hasOwnProperty("__cid__"))return e.prototype.__cid__;if(e&&e.constructor){var i=e.constructor.prototype;if(i&&i.hasOwnProperty("__cid__"))return e.__cid__}return""}var et=function(){function e(t,i){Z(this,e),this.count=void 0,this._pool=void 0,this._cleanup=void 0;var n=void 0===i?t:i,r=void 0===i?null:t;this.count=0,this._pool=new Array(n),this._cleanup=r}return J(e,[{key:"get",value:function(){return this._get()}}]),J(e,[{key:"_get",value:function(){if(this.count>0){--this.count;var e=this._pool[this.count];return this._pool[this.count]=null,e}return null}},{key:"put",value:function(e){var t=this._pool;if(this.count<t.length){if(this._cleanup&&!1===this._cleanup(e))return;t[this.count]=e,++this.count}}},{key:"resize",value:function(e){e>=0&&(this._pool.length=e,this.count>e&&(this.count=e))}}]),e}(),tt=xe,it={IDGenerator:be,Pool:et,array:xe,isNumber:Se,isString:Ee,getPropertyDescriptor:ze,addon:Ge,mixin:Ue,extend:Xe,getSuper:Ve,isChildClassOf:He,clear:We,value:Ce,getset:Ae,get:Oe,set:ke,unregisterClass:Ze,getClassName:Fe,setClassName:Ke,getClassByName:Je,_getClassId:$e,_setClassId:Ye,_getClassById:Qe,obsolete:Me,obsoletes:Ie,formatStr:De,shiftArguments:Ne,createMap:Re};cc.js=it;for(var nt=Object.freeze({__proto__:null,array:tt,js:it,IDGenerator:be,Pool:et,isNumber:Se,isString:Ee,value:Ce,getset:Ae,get:Oe,set:ke,createMap:Re,getClassName:Fe,obsolete:Me,obsoletes:Ie,formatStr:De,shiftArguments:Ne,getPropertyDescriptor:ze,addon:Ge,mixin:Ue,extend:Xe,getSuper:Ve,isChildClassOf:He,clear:We,_idToClass:je,_nameToClass:qe,_setClassId:Ye,setClassName:Ke,unregisterClass:Ze,_getClassById:Qe,getClassByName:Je,_getClassId:$e}),rt=/^(?:cc|dragonBones|sp|ccsg)\..+/,at=new Array(123),ot=0;ot<123;++ot)at[ot]=64;for(var st=0;st<64;++st)at["ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789+/=".charCodeAt(st)]=st;var lt=at;function ut(e,t,i){function n(e,t,i,n){var r=Object.getOwnPropertyDescriptor(e,t);if(r)r.get&&(e[i]=r.get),r.set&&n&&(e[n]=r.set);else{var a=e[i];Ae(e,t,a,e[n])}}for(var r,a=e.prototype,o=0;o<t.length;o++){var s=(r=t[o])[0].toUpperCase()+r.slice(1);n(a,r,"get"+s,"set"+s)}for(r in i){var l=i[r];n(a,r,l[0],l[1])}}function ct(e){return e-=1,e|=e>>1,e|=e>>2,e|=e>>4,e|=e>>8,(e|=e>>16)+1}function ht(e,t,i,n){var r=e[t];r?Array.isArray(r)?n?(r.push(r[0]),r[0]=i):r.push(i):e[t]=n?[i,r]:[r,i]:e[t]=i}function pt(e,t){if("function"==typeof e.contains)return e.contains(t);if("function"==typeof e.compareDocumentPosition)return!!(16&e.compareDocumentPosition(t));var i=t.parentNode;if(i)do{if(i===e)return!0;i=i.parentNode}while(null!==i);return!1}function _t(e){return"object"===("undefined"==typeof window?"undefined":K(window))&&"function"==typeof Node?e instanceof Node:e&&"object"===K(e)&&"number"==typeof e.nodeType&&"string"==typeof e.nodeName}function ft(e,t,i){e&&setTimeout((function(){e(t,i)}),0)}function dt(e){return Function("target","try {\n  target."+e+"();\n}\ncatch (e) {\n  cc._throw(e);\n}")}function mt(e){if(!e||e.constructor!==Object)return!1;for(var t in e)return!1;return!0}function vt(e){return e&&"function"==typeof e.clone&&(e.constructor&&e.constructor.prototype.hasOwnProperty("clone")||e.hasOwnProperty("clone"))}cc.misc={BUILTIN_CLASSID_RE:rt,BASE64_VALUES:lt,propertyDefine:ut,nextPOT:ct,pushToMap:ht,contains:pt,isDomNode:_t,callInNextTick:ft,tryCatchFunctor_EDITOR:dt,isPlainEmptyObj_DEV:mt,cloneable_DEV:vt};var yt=Object.freeze({__proto__:null,BUILTIN_CLASSID_RE:rt,BASE64_VALUES:lt,propertyDefine:ut,nextPOT:ct,pushToMap:ht,contains:pt,isDomNode:_t,callInNextTick:ft,tryCatchFunctor_EDITOR:dt,isPlainEmptyObj_DEV:mt,cloneable_DEV:vt});function gt(e){if("__bitmask__"in e)return e;Ce(e,"__bitmask__",null,!0);for(var t=-1,i=Object.keys(e),n=0;n<i.length;n++){var r=i[n],a=e[r];if(-1===a)a=++t,e[r]=a;else if("number"==typeof a)t=a;else if("string"==typeof a&&Number.isInteger(parseFloat(r)))continue;var o=""+a;r!==o&&Ce(e,o,r)}return e}function xt(e){if("__enums__"in e)return e;Ce(e,"__enums__",null,!0);for(var t=-1,i=Object.keys(e),n=0;n<i.length;n++){var r=i[n],a=e[r];if(-1===a)a=++t,e[r]=a;else if("number"==typeof a)t=a;else if("string"==typeof a&&Number.isInteger(parseFloat(r)))continue;var o=""+a;r!==o&&Ce(e,o,r)}return e}function bt(e){"__enums__"in e||Ce(e,"__enums__",null,!0)}gt.isBitMask=function(e){return e&&e.hasOwnProperty("__bitmask__")},gt.getList=function(e){if(e.__bitmask__)return e.__bitmask__;var t=e.__bitmask__=[];for(var i in e){var n=e[i];Number.isInteger(n)&&t.push({name:i,value:n})}return t.sort((function(e,t){return e.value-t.value})),t},cc.BitMask=gt,xt.isEnum=function(e){return e&&e.hasOwnProperty("__enums__")},xt.getList=function(e){if(e.__enums__)return e.__enums__;var t=e.__enums__=[];for(var i in e){var n=e[i];Number.isInteger(n)&&t.push({name:i,value:n})}return t.sort((function(e,t){return e.value-t.value})),t},cc.Enum=xt;var Tt=function(){function e(){Z(this,e)}return J(e,[{key:"clone",value:function(){return b(100,Fe(this)+".clone"),this}},{key:"equals",value:function(e){return!1}},{key:"set",value:function(e){b(100,Fe(this)+".set")}},{key:"toString",value:function(){return""+{}}}]),e}();Ke("cc.ValueType",Tt),cc.ValueType=Tt;function St(e,t,i){var n;n=function(){},i&&Xe(n,i.constructor);var r=new n;return Ce(e,"__attrs__",r),r}function Et(e){for(var t,i=cc.Class.getInheritanceChain(e),n=i.length-1;n>=0;n--){var r=i[n];r.hasOwnProperty("__attrs__")&&r.__attrs__||St(r,0,(t=i[n+1])&&t.__attrs__)}return St(e,0,(t=i[0])&&t.__attrs__),e.__attrs__}function wt(e,t,i){var n,r;if("function"==typeof e)r=(n=Ct(e)).constructor.prototype;else{var a=e;if(!(n=a.__attrs__))n=St(a,0,Ct(e=a.constructor));r=n}if(void 0===i){var o=t+"$_$",s={};for(var l in n)l.startsWith(o)&&(s[l.slice(o.length)]=n[l]);return s}if("object"===K(i))for(var u in i)95!==u.charCodeAt(0)&&(r[t+"$_$"+u]=i[u])}function Ct(e){return e.hasOwnProperty("__attrs__")&&e.__attrs__||Et(e)}function At(e){return Ct(e).constructor.prototype}function Ot(e,t,i,n){At(e)[t+"$_$"+i]=n}var kt=function(){function e(t,i){Z(this,e),this.name=void 0,this.default=void 0,this.name=t,this.default=i}return J(e,[{key:"toString",value:function(){return this.name}}]),e}(),Rt=new kt("Integer",0);cc.Integer=Rt,cc.CCInteger=Rt;var Ft=new kt("Float",0);cc.Float=Ft,cc.CCFloat=Ft;var Mt=new kt("Boolean",!1);cc.Boolean=Mt,cc.CCBoolean=Mt;var It=new kt("String","");function Pt(e,t){return function(i,n){var r='"'+Fe(i)+"."+n+'"',a=wt(i,n);if(!a.saveUrlAsAsset){var o=a.type;if(o===Rt||o===Ft?o="Number":o!==It&&o!==Mt||(o=o.toString()),o!==e)return void g(3604,r)}if(a.hasOwnProperty("default")){var s=a.default;if(void 0!==s)if(!(Array.isArray(s)||mt(s))){var l=K(s),u=e.toLowerCase();if(l===u){if(!a.saveUrlAsAsset)if("object"===u){if(!s||s instanceof a.ctor)return;g(3605,r,Fe(a.ctor))}else"Number"!==e&&g(3606,t,r,e)}else{if("function"===l)return;e===It.default&&null==s?He(a.ctor,cc.RawAsset)||g(3607,r):g(3611,t,r,l)}delete a.type}}}}cc.String=It,cc.CCString=It;var Lt=Object.freeze({__proto__:null,DELIMETER:"$_$",createAttrsSingle:St,createAttrs:Et,attr:wt,getClassAttrs:Ct,getClassAttrsProto:At,setClassAttr:Ot,PrimitiveType:kt,CCInteger:Rt,CCFloat:Ft,CCBoolean:Mt,CCString:It,getTypeChecker:Pt,getObjTypeChecker:function(e){return function(t,i){Pt("Object","type")(t,i);var n=Ct(t)[i+"$_$default"],r=cc.Class.getDefault(n);if(!Array.isArray(r)&&He(e,cc.ValueType)){var a=Fe(e),o=De('No need to specify the "type" of "%s.%s" because %s is a child class of ValueType.',Fe(t),i,a);n?u(o):g(3612,o,a,Fe(t),i,a)}}}}),Dt={url:{canUsedInGet:!0},default:{},serializable:{},editorOnly:{},formerlySerializedAs:{}};function Nt(e,t,i,n){if(!e.get&&!e.set&&e.hasOwnProperty("default")){var r="_N$"+t;e.get=function(){return this[r]},e.set=function(e){var t=this[r];this[r]=e,i.call(this,t)};var a={};for(var o in n[r]=a,Dt){var s=Dt[o];e.hasOwnProperty(o)&&(a[o]=e[o],s.canUsedInGet||delete e[o])}}}function zt(e,t,i,n){Array.isArray(n)&&n.length>0&&(n=n[0]),e.type=n}function Bt(e,t,i,n){if(Array.isArray(t)){if(!(t.length>0))return b(5508,i,n);if(cc.RawAsset.isRawAssetType(t[0]))return e.url=t[0],void delete e.type;e.type=t=t[0]}}function Gt(e,t,i){if(!(e&&e.constructor===Object)){if(Array.isArray(e)&&e.length>0){e[0];return{default:[],type:e,_short:!0}}if("function"==typeof e){var n=e;return cc.RawAsset.isRawAssetType(n)?{default:"",url:n,_short:!0}:{default:He(n,cc.ValueType)?new n:null,type:n,_short:!0}}return e instanceof kt?{default:e.default,_short:!0}:{default:e,_short:!0}}return null}function Ut(e,t,i,n,r){return"function"==typeof e||null===e}var Xt=[];function Vt(){return Xt[Xt.length-1]}cc._RF={push:function(e,t,i,n){void 0===i&&(i=t,t=""),Xt.push({uuid:t,script:i,module:e,exports:e.exports,beh:null,importMeta:n})},pop:function(){var e=Xt.pop(),t=e.module,i=t.exports;if(i===e.exports){for(var n in i)return;t.exports=i=e.cls}},peek:Vt};var Ht=["name","extends","mixins","ctor","__ctor__","properties","statics","editor","__ES6__"];function Wt(e,t){e.indexOf(t)<0&&e.push(t)}var jt={datas:null,push:function(e){if(this.datas)this.datas.push(e);else{this.datas=[e];var t=this;setTimeout((function(){t.init()}),0)}},init:function(){var e=this.datas;if(e){for(var t=0;t<e.length;++t){var i=e[t],n=i.cls,r=i.props;"function"==typeof r&&(r=r());var a=Fe(n);r?ii(n,a,r,n.$super,i.mixins):b(3633,a)}this.datas=null}}};var qt=[];function Yt(e,t,i,n,r){Ot(e,i,"default",n.default),function(e,t){Wt(e.__props__,t)}(e,i);var a=oi(e,n,t,i);if(a){for(var o=qt,s=0;s<a.length;s++){var l=a[s];wt(e,i,l),!1===l.serializable&&Wt(e.__values__,i),l._onAfterProp&&o.push(l._onAfterProp)}for(var u=0;u<o.length;u++)o[u](e,i);qt.length=0,a.length=0}}function Kt(e,t,i,n,r){var a=n.get,o=n.set,s=e.prototype,l=!Object.getOwnPropertyDescriptor(s,i);if(a){for(var u=oi(e,n,t,i),c=0;c<u.length;c++)wt(e,i,u[c]);u.length=0,Ot(e,i,"serializable",!1),r||Oe(s,i,a,l,l)}o&&(r||ke(s,i,o,l,l))}function Zt(e){return"function"==typeof e?e():e}function Qt(e,t,i){for(var n in t)e.hasOwnProperty(n)||i&&!i(n)||Object.defineProperty(e,n,ze(t,n))}function Jt(e,t,i,n){var r,a,o=n.__ctor__,s=n.ctor,l=n.__ES6__;l?(r=[s],a=s):(r=o?[o]:function(e,t,i){for(var n=[],r=[e].concat(t),a=0;a<r.length;a++){var o=r[a];if(o)for(var s=(u=o,ni._isCCClass(u)?u.__ctors__||[]:[u]),l=0;l<s.length;l++)Wt(n,s[l])}var u;var c=i.ctor;c&&n.push(c);return n}(t,i,n),a=ei(r,t,e,n),Ce(a,"extend",(function(e){return e.extends=this,ni(e)}),!0)),Ce(a,"__ctors__",r.length>0?r:null,!0);var u=a.prototype;if(t&&(l||(Xe(a,t),u=a.prototype),a.$super=t),i){for(var c=function(e){var t=i[e];Qt(u,t.prototype),Qt(a,t,(function(e){return t.hasOwnProperty(e)&&!0})),ni._isCCClass(t)&&Qt(Ct(a).constructor.prototype,Ct(t).constructor.prototype)},h=i.length-1;h>=0;h--)c(h);u.constructor=a}return l||(u.__initProps__=$t),Ke(e,a),a}function $t(e){var t=Ct(e),i=e.__props__;null===i&&(jt.init(),i=e.__props__);var n=function(e,t){for(var i=[],n=[],r=[],a=[],o=0;o<t.length;++o){var s=t[o],l=s+"$_$default";if(l in e){var u=e[l];"object"===K(u)&&u||"function"==typeof u?(i.push(s),n.push(u)):(r.push(s),a.push(u))}}return function(){for(var e=0;e<r.length;++e)this[r[e]]=a[e];for(var t=0;t<i.length;t++){var o=i[t],s=void 0,l=n[t];s="object"===K(l)?l instanceof cc.ValueType?l.clone():Array.isArray(l)?[]:{}:l(),this[o]=s}}}(t,i);e.prototype.__initProps__=n,n.call(this)}var ei=function(e,t,i,n){var r,a=t&&function(e,t,i){var n=!1;for(var r in t)if(!(Ht.indexOf(r)>=0)){var a=t[r];if("function"==typeof a){var o=ze(e.prototype,r);if(o){var s=o.value;if("function"==typeof s){ti.test(a)&&(n=!0,t[r]=function(e,t){return function(){var i=this._super;this._super=e;var n=t.apply(this,arguments);return this._super=i,n}}(s,a));continue}}}}return n}(t,n),o=e.length;return r=o>0?a?2===o?function(){this._super=null,this.__initProps__(r),e[0].apply(this,arguments),e[1].apply(this,arguments)}:function(){this._super=null,this.__initProps__(r);for(var t=0;t<e.length;++t)e[t].apply(this,arguments)}:3===o?function(){this.__initProps__(r),e[0].apply(this,arguments),e[1].apply(this,arguments),e[2].apply(this,arguments)}:function(){this.__initProps__(r);for(var e=r.__ctors__,t=0;t<e.length;++t)e[t].apply(this,arguments)}:function(){a&&(this._super=null),this.__initProps__(r)}};var ti=/xyz/.test(function(){}.toString())?/\b\._super\b/:/.*/;function ii(e,t,i,n,r,a){if(e.__props__=[],n&&n.__props__&&(e.__props__=n.__props__.slice()),r)for(var o=0;o<r.length;++o){var s=r[o];s.__props__&&(e.__props__=e.__props__.concat(s.__props__.filter((function(t){return e.__props__.indexOf(t)<0}))))}if(i)for(var l in function(e,t,i,n){for(var r in e){var a=e[r],o=Gt(a);if(o&&(a=e[r]=o),a){var s=a.notify;s&&Nt(a,r,s,e),"type"in a&&Bt(a,a.type,t,r),"url"in a&&zt(a,0,0,a.url),"type"in a&&a.type}}}(i,t),i){var u=i[l];"default"in u?Yt(e,t,l,u):Kt(e,t,l,u,a)}var c=Ct(e);e.__values__=e.__props__.filter((function(e){return!1!==c[e+"$_$serializable"]}))}function ni(e){var t=(e=e||{}).name,i=e.extends,n=e.mixins,r=function(e,t,i,n){var r=cc.Component,a=Vt();if(a&&He(t,r)){if(He(a.cls,r))return b(3615),null;e=e||a.script}var o=Jt(e,t,i,n),s=He(t,cc.RenderPipeline),l=He(t,cc.RenderFlow),u=He(t,cc.RenderStage);if(s||l||u||!1){var c="";s?c="render_pipeline":l?c="render_flow":u&&(c="render_stage"),c&&Ye(e,o)}if(a)if(He(t,r)){var h=a.uuid;h&&Ye(h,o),a.cls=o}else He(a.cls,r)||(a.cls=o);return o}(t,i,n,e);t||(t=cc.js.getClassName(r)),r._sealed=!0,i&&(i._sealed=!1);var a=e.properties;"function"==typeof a||i&&null===i.__props__||n&&n.some((function(e){return null===e.__props__}))?(jt.push({cls:r,props:a,mixins:n}),r.__props__=r.__values__=null):ii(r,t,a,i,e.mixins,e.__ES6__);var o,s=e.statics;if(s)for(o in s)r[o]=s[o];for(var l in e)if(!(Ht.indexOf(l)>=0)){var u=e[l];Ut(u)&&Ce(r.prototype,l,u,!0,!0)}var c=e.editor;return c&&He(i,cc.Component)&&cc.Component._registerEditorProps(r,c),r}ni._isCCClass=function(e){return e&&e.hasOwnProperty&&e.hasOwnProperty("__ctors__")},ni.fastDefine=function(e,t,i){Ke(e,t);for(var n=t.__props__=t.__values__=Object.keys(i),r=At(t),a=0;a<n.length;a++){var o=n[a];r[o+"$_$visible"]=!1,r[o+"$_$default"]=i[o]}},ni.Attr=Lt,ni.attr=wt,ni.getInheritanceChain=function(e){for(var t=[];e=Ve(e);)e!==Object&&t.push(e);return t};var ri={Integer:"Number",Float:"Number",Boolean:"Boolean",String:"String"},ai=[];function oi(e,t,i,n,r){var a=null,o="";function s(){return o=n+"$_$",a=At(e)}ai.length=0;var l=ai;"type"in t&&void 0===t.type&&g(3660,n,i);var u=t.type;if(u)if(ri[u])l.push({type:u,_onAfterProp:void 0});else if("Object"===u);else if("object"===K(u))xt.isEnum(u)?l.push({type:"Enum",enumList:xt.getList(u)}):gt.isBitMask(u)&&l.push({type:"BitMask",bitmaskList:gt.getList(u)});else if("function"==typeof u){l.push({type:"Object",ctor:u,_onAfterProp:void 0})}var c=function(e,i){if(e in t){var n=t[e];K(n)===i&&((a||s())[o+e]=n)}};t.editorOnly&&((a||s())[o+"editorOnly"]=!0),t.url&&((a||s())[o+"saveUrlAsAsset"]=!0),!1===t.serializable&&((a||s())[o+"serializable"]=!1),c("formerlySerializedAs","string");var h=t.range;return h&&Array.isArray(h)&&h.length>=2&&((a||s())[o+"min"]=h[0],(a||s())[o+"max"]=h[1],h.length>2&&((a||s())[o+"step"]=h[2])),c("min","number"),c("max","number"),c("step","number"),l}ni.isArray=function(e){return e=Zt(e),Array.isArray(e)},ni.getDefault=Zt,ni.escapeForJS=function(e){return JSON.stringify(e).replace(/\u2028/g,"\\u2028").replace(/\u2029/g,"\\u2029")},ni.IDENTIFIER_RE=/^[A-Za-z_$][0-9A-Za-z_$]*$/,ni.getNewValueTypeCode=!1,cc.Class=ni;var si=Math.PI/180,li=180/Math.PI,ui=1e-6;function ci(e,t){return Math.abs(e-t)<=ui*Math.max(1,Math.abs(e),Math.abs(t))}function hi(e,t,i){return i=i||ui,Math.abs(e-t)<=i}function pi(e,t,i){if(t>i){var n=t;t=i,i=n}return e<t?t:e>i?i:e}function _i(e){return e<0?0:e>1?1:e}function fi(e,t,i){return e+(t-e)*i}function di(e){return e*si}function mi(e){return e*li}var vi=Math.random;function yi(e,t){return Math.random()*(t-e)+e}function gi(e,t){return Math.floor(yi(e,t))}function xi(e){return(e=(9301*e+49297)%233280)/233280}function bi(e,t,i){return xi(e)*(i-t)+t}function Ti(e,t,i){return Math.floor(bi(e,t,i))}function Si(e){return--e,e|=e>>1,e|=e>>2,e|=e>>4,e|=e>>8,e|=e>>16,++e}function Ei(e,t){return e-Math.floor(e/t)*t}function wi(e,t){return e=Ei(e,2*t),e=t-Math.abs(e-t)}function Ci(e,t,i){return(i-e)/(t-e)}function Ai(e){return Math.abs(e.x)>Math.abs(e.y)?Math.abs(e.x)>Math.abs(e.z)?e.x:e.z:Math.abs(e.y)>Math.abs(e.z)?e.y:e.z}function Oi(e,t){return Math.abs(e)>Math.abs(t)?e:t}var ki=function(e){function t(e,i){var n;return Z(this,t),n=re(this,te(t).call(this)),e&&"object"===K(e)?(n.x=e.x,n.y=e.y):(n.x=e||0,n.y=i||0),n}return ee(t,Tt),J(t,null,[{key:"clone",value:function(e){return new t(e.x,e.y)}},{key:"copy",value:function(e,t){return e.x=t.x,e.y=t.y,e}},{key:"set",value:function(e,t,i){return e.x=t,e.y=i,e}},{key:"add",value:function(e,t,i){return e.x=t.x+i.x,e.y=t.y+i.y,e}},{key:"subtract",value:function(e,t,i){return e.x=t.x-i.x,e.y=t.y-i.y,e}},{key:"multiply",value:function(e,t,i){return e.x=t.x*i.x,e.y=t.y*i.y,e}},{key:"divide",value:function(e,t,i){return e.x=t.x/i.x,e.y=t.y/i.y,e}},{key:"ceil",value:function(e,t){return e.x=Math.ceil(t.x),e.y=Math.ceil(t.y),e}},{key:"floor",value:function(e,t){return e.x=Math.floor(t.x),e.y=Math.floor(t.y),e}},{key:"min",value:function(e,t,i){return e.x=Math.min(t.x,i.x),e.y=Math.min(t.y,i.y),e}},{key:"max",value:function(e,t,i){return e.x=Math.max(t.x,i.x),e.y=Math.max(t.y,i.y),e}},{key:"round",value:function(e,t){return e.x=Math.round(t.x),e.y=Math.round(t.y),e}},{key:"multiplyScalar",value:function(e,t,i){return e.x=t.x*i,e.y=t.y*i,e}},{key:"scaleAndAdd",value:function(e,t,i,n){return e.x=t.x+i.x*n,e.y=t.y+i.y*n,e}},{key:"distance",value:function(e,t){var i=t.x-e.x,n=t.y-e.y;return Math.sqrt(i*i+n*n)}},{key:"squaredDistance",value:function(e,t){var i=t.x-e.x,n=t.y-e.y;return i*i+n*n}},{key:"len",value:function(e){var t=e.x,i=e.y;return Math.sqrt(t*t+i*i)}},{key:"lengthSqr",value:function(e){var t=e.x,i=e.y;return t*t+i*i}},{key:"negate",value:function(e,t){return e.x=-t.x,e.y=-t.y,e}},{key:"inverse",value:function(e,t){return e.x=1/t.x,e.y=1/t.y,e}},{key:"inverseSafe",value:function(e,t){var i=t.x,n=t.y;return Math.abs(i)<ui?e.x=0:e.x=1/i,Math.abs(n)<ui?e.y=0:e.y=1/n,e}},{key:"normalize",value:function(e,t){var i=t.x,n=t.y,r=i*i+n*n;return r>0&&(r=1/Math.sqrt(r),e.x=i*r,e.y=n*r),e}},{key:"dot",value:function(e,t){return e.x*t.x+e.y*t.y}},{key:"cross",value:function(e,t,i){return e.x=e.y=0,e.z=t.x*i.y-t.y*i.x,e}},{key:"lerp",value:function(e,t,i,n){var r=t.x,a=t.y;return e.x=r+n*(i.x-r),e.y=a+n*(i.y-a),e}},{key:"random",value:function(e,t){t=t||1;var i=2*vi()*Math.PI;return e.x=Math.cos(i)*t,e.y=Math.sin(i)*t,e}},{key:"transformMat3",value:function(e,t,i){var n=t.x,r=t.y;return e.x=i.m00*n+i.m03*r+i.m06,e.y=i.m01*n+i.m04*r+i.m07,e}},{key:"transformMat4",value:function(e,t,i){var n=t.x,r=t.y;return e.x=i.m00*n+i.m04*r+i.m12,e.y=i.m01*n+i.m05*r+i.m13,e}},{key:"str",value:function(e){return"Vec2(".concat(e.x,", ").concat(e.y,")")}},{key:"toArray",value:function(e,t){var i=arguments.length>2&&void 0!==arguments[2]?arguments[2]:0;return e[i+0]=t.x,e[i+1]=t.y,e}},{key:"fromArray",value:function(e,t){var i=arguments.length>2&&void 0!==arguments[2]?arguments[2]:0;return e.x=t[i+0],e.y=t[i+1],e}},{key:"strictEquals",value:function(e,t){return e.x===t.x&&e.y===t.y}},{key:"equals",value:function(e,t){var i=arguments.length>2&&void 0!==arguments[2]?arguments[2]:ui;return Math.abs(e.x-t.x)<=i*Math.max(1,Math.abs(e.x),Math.abs(t.x))&&Math.abs(e.y-t.y)<=i*Math.max(1,Math.abs(e.y),Math.abs(t.y))}},{key:"angle",value:function(e,i){t.normalize(Ri,e),t.normalize(Fi,i);var n=t.dot(Ri,Fi);return n>1?0:n<-1?Math.PI:Math.acos(n)}}]),J(t,[{key:"clone",value:function(){return new t(this.x,this.y)}},{key:"set",value:function(e,t){return e&&"object"===K(e)?(this.x=e.x,this.y=e.y):(this.x=e||0,this.y=t||0),this}},{key:"equals",value:function(e){var t=arguments.length>1&&void 0!==arguments[1]?arguments[1]:ui;return Math.abs(this.x-e.x)<=t*Math.max(1,Math.abs(this.x),Math.abs(e.x))&&Math.abs(this.y-e.y)<=t*Math.max(1,Math.abs(this.y),Math.abs(e.y))}},{key:"equals2f",value:function(e,t){var i=arguments.length>2&&void 0!==arguments[2]?arguments[2]:ui;return Math.abs(this.x-e)<=i*Math.max(1,Math.abs(this.x),Math.abs(e))&&Math.abs(this.y-t)<=i*Math.max(1,Math.abs(this.y),Math.abs(t))}},{key:"strictEquals",value:function(e){return e&&this.x===e.x&&this.y===e.y}},{key:"strictEquals2f",value:function(e,t){return this.x===e&&this.y===t}},{key:"toString",value:function(){return"(".concat(this.x.toFixed(2),", ").concat(this.y.toFixed(2),")")}},{key:"lerp",value:function(e,t){var i=this.x,n=this.y;return this.x=i+t*(e.x-i),this.y=n+t*(e.y-n),this}},{key:"clampf",value:function(e,t){return this.x=pi(this.x,e.x,t.x),this.y=pi(this.y,e.y,t.y),this}},{key:"add",value:function(e){return this.x=this.x+e.x,this.y=this.y+e.y,this}},{key:"add2f",value:function(e,t){return this.x=this.x+e,this.y=this.y+t,this}},{key:"subtract",value:function(e){return this.x=this.x-e.x,this.y=this.y-e.y,this}},{key:"subtract2f",value:function(e,t){return this.x=this.x-e,this.y=this.y-t,this}},{key:"multiplyScalar",value:function(e){return"object"===K(e)&&console.warn("should use Vec2.multiply for vector * vector operation"),this.x=this.x*e,this.y=this.y*e,this}},{key:"multiply",value:function(e){return"object"!==K(e)&&console.warn("should use Vec2.scale for vector * scalar operation"),this.x=this.x*e.x,this.y=this.y*e.y,this}},{key:"multiply2f",value:function(e,t){return this.x=this.x*e,this.y=this.y*t,this}},{key:"divide",value:function(e){return this.x=this.x/e.x,this.y=this.y/e.y,this}},{key:"divide2f",value:function(e,t){return this.x=this.x/e,this.y=this.y/t,this}},{key:"negative",value:function(){return this.x=-this.x,this.y=-this.y,this}},{key:"dot",value:function(e){return this.x*e.x+this.y*e.y}},{key:"cross",value:function(e){return this.x*e.y-this.y*e.x}},{key:"length",value:function(){return Math.sqrt(this.x*this.x+this.y*this.y)}},{key:"lengthSqr",value:function(){return this.x*this.x+this.y*this.y}},{key:"normalize",value:function(){var e=this.x,t=this.y,i=e*e+t*t;return i>0&&(i=1/Math.sqrt(i),this.x=this.x*i,this.y=this.y*i),this}},{key:"angle",value:function(e){var t=this.lengthSqr(),i=e.lengthSqr();if(0===t||0===i)return console.warn("Can't get angle between zero vector"),0;var n=this.dot(e)/Math.sqrt(t*i);return n=pi(n,-1,1),Math.acos(n)}},{key:"signAngle",value:function(e){var t=this.angle(e);return this.cross(e)<0?-t:t}},{key:"rotate",value:function(e){var t=this.x,i=this.y,n=Math.sin(e),r=Math.cos(e);return this.x=r*t-n*i,this.y=n*t+r*i,this}},{key:"project",value:function(e){var t=this.dot(e)/e.dot(e);return this.x=e.x*t,this.y=e.y*t,this}},{key:"transformMat4",value:function(e){var t=this.x,i=this.y;return this.x=e.m00*t+e.m04*i+e.m12,this.y=e.m01*t+e.m05*i+e.m13,this}}]),t}();ki.ZERO=Object.freeze(new ki(0,0)),ki.ONE=Object.freeze(new ki(1,1)),ki.NEG_ONE=Object.freeze(new ki(-1,-1)),ki.UNIT_X=Object.freeze(new ki(1,0)),ki.UNIT_Y=Object.freeze(new ki(0,1));var Ri=new ki,Fi=new ki;function Mi(e,t){return new ki(e,t)}ni.fastDefine("cc.Vec2",ki,{x:0,y:0}),cc.Vec2=ki,cc.v2=Mi;var Ii=function(e){function t(e,i,n){var r;return Z(this,t),r=re(this,te(t).call(this)),e&&"object"===K(e)?(r.x=e.x,r.y=e.y,r.z=e.z):(r.x=e||0,r.y=i||0,r.z=n||0),r}return ee(t,Tt),J(t,null,[{key:"zero",value:function(e){return e.x=0,e.y=0,e.z=0,e}},{key:"clone",value:function(e){return new t(e.x,e.y,e.z)}},{key:"copy",value:function(e,t){return e.x=t.x,e.y=t.y,e.z=t.z,e}},{key:"set",value:function(e,t,i,n){return e.x=t,e.y=i,e.z=n,e}},{key:"add",value:function(e,t,i){return e.x=t.x+i.x,e.y=t.y+i.y,e.z=t.z+i.z,e}},{key:"subtract",value:function(e,t,i){return e.x=t.x-i.x,e.y=t.y-i.y,e.z=t.z-i.z,e}},{key:"multiply",value:function(e,t,i){return e.x=t.x*i.x,e.y=t.y*i.y,e.z=t.z*i.z,e}},{key:"divide",value:function(e,t,i){return e.x=t.x/i.x,e.y=t.y/i.y,e.z=t.z/i.z,e}},{key:"ceil",value:function(e,t){return e.x=Math.ceil(t.x),e.y=Math.ceil(t.y),e.z=Math.ceil(t.z),e}},{key:"floor",value:function(e,t){return e.x=Math.floor(t.x),e.y=Math.floor(t.y),e.z=Math.floor(t.z),e}},{key:"min",value:function(e,t,i){return e.x=Math.min(t.x,i.x),e.y=Math.min(t.y,i.y),e.z=Math.min(t.z,i.z),e}},{key:"max",value:function(e,t,i){return e.x=Math.max(t.x,i.x),e.y=Math.max(t.y,i.y),e.z=Math.max(t.z,i.z),e}},{key:"round",value:function(e,t){return e.x=Math.round(t.x),e.y=Math.round(t.y),e.z=Math.round(t.z),e}},{key:"multiplyScalar",value:function(e,t,i){return e.x=t.x*i,e.y=t.y*i,e.z=t.z*i,e}},{key:"scaleAndAdd",value:function(e,t,i,n){return e.x=t.x+i.x*n,e.y=t.y+i.y*n,e.z=t.z+i.z*n,e}},{key:"distance",value:function(e,t){var i=t.x-e.x,n=t.y-e.y,r=t.z-e.z;return Math.sqrt(i*i+n*n+r*r)}},{key:"squaredDistance",value:function(e,t){var i=t.x-e.x,n=t.y-e.y,r=t.z-e.z;return i*i+n*n+r*r}},{key:"len",value:function(e){var t=e.x,i=e.y,n=e.z;return Math.sqrt(t*t+i*i+n*n)}},{key:"lengthSqr",value:function(e){var t=e.x,i=e.y,n=e.z;return t*t+i*i+n*n}},{key:"negate",value:function(e,t){return e.x=-t.x,e.y=-t.y,e.z=-t.z,e}},{key:"invert",value:function(e,t){return e.x=1/t.x,e.y=1/t.y,e.z=1/t.z,e}},{key:"invertSafe",value:function(e,t){var i=t.x,n=t.y,r=t.z;return Math.abs(i)<ui?e.x=0:e.x=1/i,Math.abs(n)<ui?e.y=0:e.y=1/n,Math.abs(r)<ui?e.z=0:e.z=1/r,e}},{key:"normalize",value:function(e,t){var i=t.x,n=t.y,r=t.z,a=i*i+n*n+r*r;return a>0&&(a=1/Math.sqrt(a),e.x=i*a,e.y=n*a,e.z=r*a),e}},{key:"dot",value:function(e,t){return e.x*t.x+e.y*t.y+e.z*t.z}},{key:"cross",value:function(e,t,i){var n=t.x,r=t.y,a=t.z,o=i.x,s=i.y,l=i.z;return e.x=r*l-a*s,e.y=a*o-n*l,e.z=n*s-r*o,e}},{key:"lerp",value:function(e,t,i,n){return e.x=t.x+n*(i.x-t.x),e.y=t.y+n*(i.y-t.y),e.z=t.z+n*(i.z-t.z),e}},{key:"random",value:function(e,t){t=t||1;var i=2*vi()*Math.PI,n=2*vi()-1,r=Math.sqrt(1-n*n);return e.x=r*Math.cos(i)*t,e.y=r*Math.sin(i)*t,e.z=n*t,e}},{key:"transformMat4",value:function(e,t,i){var n=t.x,r=t.y,a=t.z,o=i.m03*n+i.m07*r+i.m11*a+i.m15;return o=o?Math.abs(1/o):1,e.x=(i.m00*n+i.m04*r+i.m08*a+i.m12)*o,e.y=(i.m01*n+i.m05*r+i.m09*a+i.m13)*o,e.z=(i.m02*n+i.m06*r+i.m10*a+i.m14)*o,e}},{key:"transformMat4Normal",value:function(e,t,i){var n=t.x,r=t.y,a=t.z,o=i.m03*n+i.m07*r+i.m11*a;return o=o?Math.abs(1/o):1,e.x=(i.m00*n+i.m04*r+i.m08*a)*o,e.y=(i.m01*n+i.m05*r+i.m09*a)*o,e.z=(i.m02*n+i.m06*r+i.m10*a)*o,e}},{key:"transformMat3",value:function(e,t,i){var n=t.x,r=t.y,a=t.z;return e.x=n*i.m00+r*i.m03+a*i.m06,e.y=n*i.m01+r*i.m04+a*i.m07,e.z=n*i.m02+r*i.m05+a*i.m08,e}},{key:"transformAffine",value:function(e,t,i){var n=t.x,r=t.y,a=t.z;return e.x=i.m00*n+i.m04*r+i.m08*a+i.m12,e.y=i.m01*n+i.m05*r+i.m09*a+i.m13,e.x=i.m02*n+i.m06*r+i.m10*a+i.m14,e}},{key:"transformQuat",value:function(e,t,i){var n=i.w*t.x+i.y*t.z-i.z*t.y,r=i.w*t.y+i.z*t.x-i.x*t.z,a=i.w*t.z+i.x*t.y-i.y*t.x,o=-i.x*t.x-i.y*t.y-i.z*t.z;return e.x=n*i.w+o*-i.x+r*-i.z-a*-i.y,e.y=r*i.w+o*-i.y+a*-i.x-n*-i.z,e.z=a*i.w+o*-i.z+n*-i.y-r*-i.x,e}},{key:"transformRTS",value:function(e,t,i,n,r){var a=t.x*r.x,o=t.y*r.y,s=t.z*r.z,l=i.w*a+i.y*s-i.z*o,u=i.w*o+i.z*a-i.x*s,c=i.w*s+i.x*o-i.y*a,h=-i.x*a-i.y*o-i.z*s;return e.x=l*i.w+h*-i.x+u*-i.z-c*-i.y+n.x,e.y=u*i.w+h*-i.y+c*-i.x-l*-i.z+n.y,e.z=c*i.w+h*-i.z+l*-i.y-u*-i.x+n.z,e}},{key:"transformInverseRTS",value:function(e,t,i,n,r){var a=t.x-n.x,o=t.y-n.y,s=t.z-n.z,l=i.w*a-i.y*s+i.z*o,u=i.w*o-i.z*a+i.x*s,c=i.w*s-i.x*o+i.y*a,h=i.x*a+i.y*o+i.z*s;return e.x=(l*i.w+h*i.x+u*i.z-c*i.y)/r.x,e.y=(u*i.w+h*i.y+c*i.x-l*i.z)/r.y,e.z=(c*i.w+h*i.z+l*i.y-u*i.x)/r.z,e}},{key:"rotateX",value:function(e,t,i,n){var r=t.x-i.x,a=t.y-i.y,o=t.z-i.z,s=Math.cos(n),l=Math.sin(n),u=r,c=a*s-o*l,h=a*l+o*s;return e.x=u+i.x,e.y=c+i.y,e.z=h+i.z,e}},{key:"rotateY",value:function(e,t,i,n){var r=t.x-i.x,a=t.y-i.y,o=t.z-i.z,s=Math.cos(n),l=Math.sin(n),u=o*l+r*s,c=a,h=o*s-r*l;return e.x=u+i.x,e.y=c+i.y,e.z=h+i.z,e}},{key:"rotateZ",value:function(e,t,i,n){var r=t.x-i.x,a=t.y-i.y,o=t.z-i.z,s=Math.cos(n),l=Math.sin(n),u=r*s-a*l,c=r*l+a*s,h=o;return e.x=u+i.x,e.y=c+i.y,e.z=h+i.z,e}},{key:"toArray",value:function(e,t){var i=arguments.length>2&&void 0!==arguments[2]?arguments[2]:0;return e[i+0]=t.x,e[i+1]=t.y,e[i+2]=t.z,e}},{key:"fromArray",value:function(e,t){var i=arguments.length>2&&void 0!==arguments[2]?arguments[2]:0;return e.x=t[i+0],e.y=t[i+1],e.z=t[i+2],e}},{key:"strictEquals",value:function(e,t){return e.x===t.x&&e.y===t.y&&e.z===t.z}},{key:"equals",value:function(e,t){var i=arguments.length>2&&void 0!==arguments[2]?arguments[2]:ui,n=e.x,r=e.y,a=e.z,o=t.x,s=t.y,l=t.z;return Math.abs(n-o)<=i*Math.max(1,Math.abs(n),Math.abs(o))&&Math.abs(r-s)<=i*Math.max(1,Math.abs(r),Math.abs(s))&&Math.abs(a-l)<=i*Math.max(1,Math.abs(a),Math.abs(l))}},{key:"angle",value:function(e,i){t.normalize(Pi,e),t.normalize(Li,i);var n=t.dot(Pi,Li);return n>1?0:n<-1?Math.PI:Math.acos(n)}},{key:"projectOnPlane",value:function(e,i,n){return t.subtract(e,i,t.project(e,i,n))}},{key:"project",value:function(e,i,n){var r=t.lengthSqr(n);return r<1e-6?t.set(e,0,0,0):t.multiplyScalar(e,n,t.dot(i,n)/r)}}]),J(t,[{key:"clone",value:function(){return new t(this.x,this.y,this.z)}},{key:"set",value:function(e,t,i){return e&&"object"===K(e)?(this.x=e.x,this.y=e.y,this.z=e.z):(this.x=e||0,this.y=t||0,this.z=i||0),this}},{key:"equals",value:function(e){var t=arguments.length>1&&void 0!==arguments[1]?arguments[1]:ui;return Math.abs(this.x-e.x)<=t*Math.max(1,Math.abs(this.x),Math.abs(e.x))&&Math.abs(this.y-e.y)<=t*Math.max(1,Math.abs(this.y),Math.abs(e.y))&&Math.abs(this.z-e.z)<=t*Math.max(1,Math.abs(this.z),Math.abs(e.z))}},{key:"equals3f",value:function(e,t,i){var n=arguments.length>3&&void 0!==arguments[3]?arguments[3]:ui;return Math.abs(this.x-e)<=n*Math.max(1,Math.abs(this.x),Math.abs(e))&&Math.abs(this.y-t)<=n*Math.max(1,Math.abs(this.y),Math.abs(t))&&Math.abs(this.z-i)<=n*Math.max(1,Math.abs(this.z),Math.abs(i))}},{key:"strictEquals",value:function(e){return this.x===e.x&&this.y===e.y&&this.z===e.z}},{key:"strictEquals3f",value:function(e,t,i){return this.x===e&&this.y===t&&this.z===i}},{key:"toString",value:function(){return"(".concat(this.x.toFixed(2),", ").concat(this.y.toFixed(2),", ").concat(this.z.toFixed(2),")")}},{key:"lerp",value:function(e,t){return this.x=this.x+t*(e.x-this.x),this.y=this.y+t*(e.y-this.y),this.z=this.z+t*(e.z-this.z),this}},{key:"add",value:function(e){return this.x=this.x+e.x,this.y=this.y+e.y,this.z=this.z+e.z,this}},{key:"add3f",value:function(e,t,i){return this.x=this.x+e,this.y=this.y+t,this.z=this.z+i,this}},{key:"subtract",value:function(e){return this.x=this.x-e.x,this.y=this.y-e.y,this.z=this.z-e.z,this}},{key:"subtract3f",value:function(e,t,i){return this.x=this.x-e,this.y=this.y-t,this.z=this.z-i,this}},{key:"multiplyScalar",value:function(e){return"object"===K(e)&&console.warn("should use Vec3.multiply for vector * vector operation"),this.x=this.x*e,this.y=this.y*e,this.z=this.z*e,this}},{key:"multiply",value:function(e){return"object"!==K(e)&&console.warn("should use Vec3.scale for vector * scalar operation"),this.x=this.x*e.x,this.y=this.y*e.y,this.z=this.z*e.z,this}},{key:"multiply3f",value:function(e,t,i){return this.x=this.x*e,this.y=this.y*t,this.z=this.z*i,this}},{key:"divide",value:function(e){return this.x=this.x/e.x,this.y=this.y/e.y,this.z=this.z/e.z,this}},{key:"divide3f",value:function(e,t,i){return this.x=this.x/e,this.y=this.y/t,this.z=this.z/i,this}},{key:"negative",value:function(){return this.x=-this.x,this.y=-this.y,this.z=-this.z,this}},{key:"clampf",value:function(e,t){return this.x=pi(this.x,e.x,t.x),this.y=pi(this.y,e.y,t.y),this.z=pi(this.z,e.z,t.z),this}},{key:"dot",value:function(e){return this.x*e.x+this.y*e.y+this.z*e.z}},{key:"cross",value:function(e){var t=this.x,i=this.y,n=this.z,r=e.x,a=e.y,o=e.z;return this.x=i*o-n*a,this.y=n*r-t*o,this.z=t*a-i*r,this}},{key:"length",value:function(){return Math.sqrt(this.x*this.x+this.y*this.y+this.z*this.z)}},{key:"lengthSqr",value:function(){return this.x*this.x+this.y*this.y+this.z*this.z}},{key:"normalize",value:function(){var e=this.x,t=this.y,i=this.z,n=e*e+t*t+i*i;return n>0&&(n=1/Math.sqrt(n),this.x=e*n,this.y=t*n,this.z=i*n),this}},{key:"transformMat4",value:function(e){var t=this.x,i=this.y,n=this.z,r=e.m03*t+e.m07*i+e.m11*n+e.m15;return r=r?1/r:1,this.x=(e.m00*t+e.m04*i+e.m08*n+e.m12)*r,this.y=(e.m01*t+e.m05*i+e.m09*n+e.m13)*r,this.z=(e.m02*t+e.m06*i+e.m10*n+e.m14)*r,this}}]),t}();Ii.UNIT_X=Object.freeze(new Ii(1,0,0)),Ii.UNIT_Y=Object.freeze(new Ii(0,1,0)),Ii.UNIT_Z=Object.freeze(new Ii(0,0,1)),Ii.RIGHT=Object.freeze(new Ii(1,0,0)),Ii.UP=Object.freeze(new Ii(0,1,0)),Ii.FORWARD=Object.freeze(new Ii(0,0,-1)),Ii.ZERO=Object.freeze(new Ii(0,0,0)),Ii.ONE=Object.freeze(new Ii(1,1,1)),Ii.NEG_ONE=Object.freeze(new Ii(-1,-1,-1));var Pi=new Ii,Li=new Ii;function Di(e,t,i){return new Ii(e,t,i)}ni.fastDefine("cc.Vec3",Ii,{x:0,y:0,z:0}),cc.Vec3=Ii,cc.v3=Di;var Ni=function(e){function t(e,i,n,r){var a;return Z(this,t),a=re(this,te(t).call(this)),e&&"object"===K(e)?(a.x=e.x,a.y=e.y,a.z=e.z,a.w=e.w):(a.x=e||0,a.y=i||0,a.z=n||0,a.w=r||0),a}return ee(t,Tt),J(t,null,[{key:"clone",value:function(e){return new t(e.x,e.y,e.z,e.w)}},{key:"copy",value:function(e,t){return e.x=t.x,e.y=t.y,e.z=t.z,e.w=t.w,e}},{key:"set",value:function(e,t,i,n,r){return e.x=t,e.y=i,e.z=n,e.w=r,e}},{key:"add",value:function(e,t,i){return e.x=t.x+i.x,e.y=t.y+i.y,e.z=t.z+i.z,e.w=t.w+i.w,e}},{key:"subtract",value:function(e,t,i){return e.x=t.x-i.x,e.y=t.y-i.y,e.z=t.z-i.z,e.w=t.w-i.w,e}},{key:"multiply",value:function(e,t,i){return e.x=t.x*i.x,e.y=t.y*i.y,e.z=t.z*i.z,e.w=t.w*i.w,e}},{key:"divide",value:function(e,t,i){return e.x=t.x/i.x,e.y=t.y/i.y,e.z=t.z/i.z,e.w=t.w/i.w,e}},{key:"ceil",value:function(e,t){return e.x=Math.ceil(t.x),e.y=Math.ceil(t.y),e.z=Math.ceil(t.z),e.w=Math.ceil(t.w),e}},{key:"floor",value:function(e,t){return e.x=Math.floor(t.x),e.y=Math.floor(t.y),e.z=Math.floor(t.z),e.w=Math.floor(t.w),e}},{key:"min",value:function(e,t,i){return e.x=Math.min(t.x,i.x),e.y=Math.min(t.y,i.y),e.z=Math.min(t.z,i.z),e.w=Math.min(t.w,i.w),e}},{key:"max",value:function(e,t,i){return e.x=Math.max(t.x,i.x),e.y=Math.max(t.y,i.y),e.z=Math.max(t.z,i.z),e.w=Math.max(t.w,i.w),e}},{key:"round",value:function(e,t){return e.x=Math.round(t.x),e.y=Math.round(t.y),e.z=Math.round(t.z),e.w=Math.round(t.w),e}},{key:"multiplyScalar",value:function(e,t,i){return e.x=t.x*i,e.y=t.y*i,e.z=t.z*i,e.w=t.w*i,e}},{key:"scaleAndAdd",value:function(e,t,i,n){return e.x=t.x+i.x*n,e.y=t.y+i.y*n,e.z=t.z+i.z*n,e.w=t.w+i.w*n,e}},{key:"distance",value:function(e,t){var i=t.x-e.x,n=t.y-e.y,r=t.z-e.z,a=t.w-e.w;return Math.sqrt(i*i+n*n+r*r+a*a)}},{key:"squaredDistance",value:function(e,t){var i=t.x-e.x,n=t.y-e.y,r=t.z-e.z,a=t.w-e.w;return i*i+n*n+r*r+a*a}},{key:"len",value:function(e){var t=e.x,i=e.y,n=e.z,r=e.w;return Math.sqrt(t*t+i*i+n*n+r*r)}},{key:"lengthSqr",value:function(e){var t=e.x,i=e.y,n=e.z,r=e.w;return t*t+i*i+n*n+r*r}},{key:"negate",value:function(e,t){return e.x=-t.x,e.y=-t.y,e.z=-t.z,e.w=-t.w,e}},{key:"inverse",value:function(e,t){return e.x=1/t.x,e.y=1/t.y,e.z=1/t.z,e.w=1/t.w,e}},{key:"inverseSafe",value:function(e,t){var i=t.x,n=t.y,r=t.z,a=t.w;return Math.abs(i)<ui?e.x=0:e.x=1/i,Math.abs(n)<ui?e.y=0:e.y=1/n,Math.abs(r)<ui?e.z=0:e.z=1/r,Math.abs(a)<ui?e.w=0:e.w=1/a,e}},{key:"normalize",value:function(e,t){var i=t.x,n=t.y,r=t.z,a=t.w,o=i*i+n*n+r*r+a*a;return o>0&&(o=1/Math.sqrt(o),e.x=i*o,e.y=n*o,e.z=r*o,e.w=a*o),e}},{key:"dot",value:function(e,t){return e.x*t.x+e.y*t.y+e.z*t.z+e.w*t.w}},{key:"lerp",value:function(e,t,i,n){return e.x=t.x+n*(i.x-t.x),e.y=t.y+n*(i.y-t.y),e.z=t.z+n*(i.z-t.z),e.w=t.w+n*(i.w-t.w),e}},{key:"random",value:function(e,t){t=t||1;var i=2*vi()*Math.PI,n=2*vi()-1,r=Math.sqrt(1-n*n);return e.x=r*Math.cos(i)*t,e.y=r*Math.sin(i)*t,e.z=n*t,e.w=0,e}},{key:"transformMat4",value:function(e,t,i){var n=t.x,r=t.y,a=t.z,o=t.w;return e.x=i.m00*n+i.m04*r+i.m08*a+i.m12*o,e.y=i.m01*n+i.m05*r+i.m09*a+i.m13*o,e.z=i.m02*n+i.m06*r+i.m10*a+i.m14*o,e.w=i.m03*n+i.m07*r+i.m11*a+i.m15*o,e}},{key:"transformAffine",value:function(e,t,i){var n=t.x,r=t.y,a=t.z,o=t.w;return e.x=i.m00*n+i.m01*r+i.m02*a+i.m03*o,e.y=i.m04*n+i.m05*r+i.m06*a+i.m07*o,e.x=i.m08*n+i.m09*r+i.m10*a+i.m11*o,e.w=t.w,e}},{key:"transformQuat",value:function(e,t,i){var n=t.x,r=t.y,a=t.z,o=i.x,s=i.y,l=i.z,u=i.w,c=u*n+s*a-l*r,h=u*r+l*n-o*a,p=u*a+o*r-s*n,_=-o*n-s*r-l*a;return e.x=c*u+_*-o+h*-l-p*-s,e.y=h*u+_*-s+p*-o-c*-l,e.z=p*u+_*-l+c*-s-h*-o,e.w=t.w,e}},{key:"toArray",value:function(e,t){var i=arguments.length>2&&void 0!==arguments[2]?arguments[2]:0;return e[i+0]=t.x,e[i+1]=t.y,e[i+2]=t.z,e[i+3]=t.w,e}},{key:"fromArray",value:function(e,t){var i=arguments.length>2&&void 0!==arguments[2]?arguments[2]:0;return e.x=t[i+0],e.y=t[i+1],e.z=t[i+2],e.w=t[i+3],e}},{key:"strictEquals",value:function(e,t){return e.x===t.x&&e.y===t.y&&e.z===t.z&&e.w===t.w}},{key:"equals",value:function(e,t){var i=arguments.length>2&&void 0!==arguments[2]?arguments[2]:ui;return Math.abs(e.x-t.x)<=i*Math.max(1,Math.abs(e.x),Math.abs(t.x))&&Math.abs(e.y-t.y)<=i*Math.max(1,Math.abs(e.y),Math.abs(t.y))&&Math.abs(e.z-t.z)<=i*Math.max(1,Math.abs(e.z),Math.abs(t.z))&&Math.abs(e.w-t.w)<=i*Math.max(1,Math.abs(e.w),Math.abs(t.w))}}]),J(t,[{key:"clone",value:function(){return new t(this.x,this.y,this.z,this.w)}},{key:"set",value:function(e,t,i,n){return e&&"object"===K(e)?(this.x=e.x,this.y=e.y,this.z=e.z,this.w=e.w):(this.x=e||0,this.y=t||0,this.z=i||0,this.w=n||0),this}},{key:"equals",value:function(e){var t=arguments.length>1&&void 0!==arguments[1]?arguments[1]:ui;return Math.abs(this.x-e.x)<=t*Math.max(1,Math.abs(this.x),Math.abs(e.x))&&Math.abs(this.y-e.y)<=t*Math.max(1,Math.abs(this.y),Math.abs(e.y))&&Math.abs(this.z-e.z)<=t*Math.max(1,Math.abs(this.z),Math.abs(e.z))&&Math.abs(this.w-e.w)<=t*Math.max(1,Math.abs(this.w),Math.abs(e.w))}},{key:"equals4f",value:function(e,t,i,n){var r=arguments.length>4&&void 0!==arguments[4]?arguments[4]:ui;return Math.abs(this.x-e)<=r*Math.max(1,Math.abs(this.x),Math.abs(e))&&Math.abs(this.y-t)<=r*Math.max(1,Math.abs(this.y),Math.abs(t))&&Math.abs(this.z-i)<=r*Math.max(1,Math.abs(this.z),Math.abs(i))&&Math.abs(this.w-n)<=r*Math.max(1,Math.abs(this.w),Math.abs(n))}},{key:"strictEquals",value:function(e){return this.x===e.x&&this.y===e.y&&this.z===e.z&&this.w===e.w}},{key:"strictEquals4f",value:function(e,t,i,n){return this.x===e&&this.y===t&&this.z===i&&this.w===n}},{key:"lerp",value:function(e,t){var i=this.x,n=this.y,r=this.z,a=this.w;return this.x=i+t*(e.x-i),this.y=n+t*(e.y-n),this.z=r+t*(e.z-r),this.w=a+t*(e.w-a),this}},{key:"toString",value:function(){return"(".concat(this.x.toFixed(2),", ").concat(this.y.toFixed(2),", ").concat(this.z.toFixed(2),", ").concat(this.w.toFixed(2),")")}},{key:"clampf",value:function(e,t){return this.x=pi(this.x,e.x,t.x),this.y=pi(this.y,e.y,t.y),this.z=pi(this.z,e.z,t.z),this.w=pi(this.w,e.w,t.w),this}},{key:"add",value:function(e){return this.x=this.x+e.x,this.y=this.y+e.y,this.z=this.z+e.z,this.w=this.w+e.w,this}},{key:"add4f",value:function(e,t,i,n){return this.x=this.x+e,this.y=this.y+t,this.z=this.z+i,this.w=this.w+n,this}},{key:"subtract",value:function(e){return this.x=this.x-e.x,this.y=this.y-e.y,this.z=this.z-e.z,this.w=this.w-e.w,this}},{key:"subtract4f",value:function(e,t,i,n){return this.x=this.x-e,this.y=this.y-t,this.z=this.z-i,this.w=this.w-n,this}},{key:"multiplyScalar",value:function(e){return"object"===K(e)&&console.warn("should use Vec4.multiply for vector * vector operation"),this.x=this.x*e,this.y=this.y*e,this.z=this.z*e,this.w=this.w*e,this}},{key:"multiply",value:function(e){return"object"!==K(e)&&console.warn("should use Vec4.scale for vector * scalar operation"),this.x=this.x*e.x,this.y=this.y*e.y,this.z=this.z*e.z,this.w=this.w*e.w,this}},{key:"multiply4f",value:function(e,t,i,n){return this.x=this.x*e,this.y=this.y*t,this.z=this.z*i,this.w=this.w*n,this}},{key:"divide",value:function(e){return this.x=this.x/e.x,this.y=this.y/e.y,this.z=this.z/e.z,this.w=this.w/e.w,this}},{key:"divide4f",value:function(e,t,i,n){return this.x=this.x/e,this.y=this.y/t,this.z=this.z/i,this.w=this.w/n,this}},{key:"negative",value:function(){return this.x=-this.x,this.y=-this.y,this.z=-this.z,this.w=-this.w,this}},{key:"dot",value:function(e){return this.x*e.x+this.y*e.y+this.z*e.z+this.w*e.w}},{key:"cross",value:function(e){var t=this.x,i=this.y,n=this.z,r=e.x,a=e.y,o=e.z;return this.x=i*o-n*a,this.y=n*r-t*o,this.z=t*a-i*r,this}},{key:"length",value:function(){var e=this.x,t=this.y,i=this.z,n=this.w;return Math.sqrt(e*e+t*t+i*i+n*n)}},{key:"lengthSqr",value:function(){var e=this.x,t=this.y,i=this.z,n=this.w;return e*e+t*t+i*i+n*n}},{key:"normalize",value:function(){var e=this.x,t=this.y,i=this.z,n=this.w,r=e*e+t*t+i*i+n*n;return r>0&&(r=1/Math.sqrt(r),this.x=e*r,this.y=t*r,this.z=i*r,this.w=n*r),this}},{key:"transformMat4",value:function(e){var t=this.x,i=this.y,n=this.z,r=this.w;return this.x=e.m00*t+e.m04*i+e.m08*n+e.m12*r,this.y=e.m01*t+e.m05*i+e.m09*n+e.m13*r,this.z=e.m02*t+e.m06*i+e.m10*n+e.m14*r,this.w=e.m03*t+e.m07*i+e.m11*n+e.m15*r,this}}]),t}();function zi(e,t,i,n){return new Ni(e,t,i,n)}Ni.ZERO=Object.freeze(new Ni(0,0,0,0)),Ni.ONE=Object.freeze(new Ni(1,1,1,1)),Ni.NEG_ONE=Object.freeze(new Ni(-1,-1,-1,-1)),ni.fastDefine("cc.Vec4",Ni,{x:0,y:0,z:0,w:0}),cc.Vec4=Ni,cc.v4=zi;var Bi=function(e){function t(){var e,i=arguments.length>0&&void 0!==arguments[0]?arguments[0]:1,n=arguments.length>1&&void 0!==arguments[1]?arguments[1]:0,r=arguments.length>2&&void 0!==arguments[2]?arguments[2]:0,a=arguments.length>3&&void 0!==arguments[3]?arguments[3]:0,o=arguments.length>4&&void 0!==arguments[4]?arguments[4]:1,s=arguments.length>5&&void 0!==arguments[5]?arguments[5]:0,l=arguments.length>6&&void 0!==arguments[6]?arguments[6]:0,u=arguments.length>7&&void 0!==arguments[7]?arguments[7]:0,c=arguments.length>8&&void 0!==arguments[8]?arguments[8]:1;return Z(this,t),e=re(this,te(t).call(this)),"object"===K(i)?(e.m00=i.m00,e.m01=i.m01,e.m02=i.m02,e.m03=i.m03,e.m04=i.m04,e.m05=i.m05,e.m06=i.m06,e.m07=i.m07,e.m08=i.m08):(e.m00=i,e.m01=n,e.m02=r,e.m03=a,e.m04=o,e.m05=s,e.m06=l,e.m07=u,e.m08=c),e}return ee(t,Tt),J(t,null,[{key:"clone",value:function(e){return new t(e.m00,e.m01,e.m02,e.m03,e.m04,e.m05,e.m06,e.m07,e.m08)}},{key:"copy",value:function(e,t){return e.m00=t.m00,e.m01=t.m01,e.m02=t.m02,e.m03=t.m03,e.m04=t.m04,e.m05=t.m05,e.m06=t.m06,e.m07=t.m07,e.m08=t.m08,e}},{key:"set",value:function(e,t,i,n,r,a,o,s,l,u){return e.m00=t,e.m01=i,e.m02=n,e.m03=r,e.m04=a,e.m05=o,e.m06=s,e.m07=l,e.m08=u,e}},{key:"identity",value:function(e){return e.m00=1,e.m01=0,e.m02=0,e.m03=0,e.m04=1,e.m05=0,e.m06=0,e.m07=0,e.m08=1,e}},{key:"transpose",value:function(e,t){if(e===t){var i=t.m01,n=t.m02,r=t.m05;e.m01=t.m03,e.m02=t.m06,e.m03=i,e.m05=t.m07,e.m06=n,e.m07=r}else e.m00=t.m00,e.m01=t.m03,e.m02=t.m06,e.m03=t.m01,e.m04=t.m04,e.m05=t.m07,e.m06=t.m02,e.m07=t.m05,e.m08=t.m08;return e}},{key:"invert",value:function(e,t){var i=t.m00,n=t.m01,r=t.m02,a=t.m03,o=t.m04,s=t.m05,l=t.m06,u=t.m07,c=t.m08,h=c*o-s*u,p=-c*a+s*l,_=u*a-o*l,f=i*h+n*p+r*_;return 0===f?(e.m00=0,e.m01=0,e.m02=0,e.m03=0,e.m04=0,e.m05=0,e.m06=0,e.m07=0,e.m08=0,e):(f=1/f,e.m00=h*f,e.m01=(-c*n+r*u)*f,e.m02=(s*n-r*o)*f,e.m03=p*f,e.m04=(c*i-r*l)*f,e.m05=(-s*i+r*a)*f,e.m06=_*f,e.m07=(-u*i+n*l)*f,e.m08=(o*i-n*a)*f,e)}},{key:"determinant",value:function(e){var t=e.m00,i=e.m01,n=e.m02,r=e.m03,a=e.m04,o=e.m05,s=e.m06,l=e.m07,u=e.m08;return t*(u*a-o*l)+i*(-u*r+o*s)+n*(l*r-a*s)}},{key:"multiply",value:function(e,t,i){var n=t.m00,r=t.m01,a=t.m02,o=t.m03,s=t.m04,l=t.m05,u=t.m06,c=t.m07,h=t.m08,p=i.m00,_=i.m01,f=i.m02,d=i.m03,m=i.m04,v=i.m05,y=i.m06,g=i.m07,x=i.m08;return e.m00=p*n+_*o+f*u,e.m01=p*r+_*s+f*c,e.m02=p*a+_*l+f*h,e.m03=d*n+m*o+v*u,e.m04=d*r+m*s+v*c,e.m05=d*a+m*l+v*h,e.m06=y*n+g*o+x*u,e.m07=y*r+g*s+x*c,e.m08=y*a+g*l+x*h,e}},{key:"multiplyMat4",value:function(e,t,i){var n=t.m00,r=t.m01,a=t.m02,o=t.m03,s=t.m04,l=t.m05,u=t.m06,c=t.m07,h=t.m08,p=i.m00,_=i.m01,f=i.m02,d=i.m04,m=i.m05,v=i.m06,y=i.m08,g=i.m09,x=i.m10;return e.m00=p*n+_*o+f*u,e.m01=p*r+_*s+f*c,e.m02=p*a+_*l+f*h,e.m03=d*n+m*o+v*u,e.m04=d*r+m*s+v*c,e.m05=d*a+m*l+v*h,e.m06=y*n+g*o+x*u,e.m07=y*r+g*s+x*c,e.m08=y*a+g*l+x*h,e}},{key:"transfrom",value:function(e,i,n){t.transform(e,i,n)}},{key:"transform",value:function(e,t,i){var n=t.m00,r=t.m01,a=t.m02,o=t.m03,s=t.m04,l=t.m05,u=t.m06,c=t.m07,h=t.m08,p=i.x,_=i.y;return e.m00=n,e.m01=r,e.m02=a,e.m03=o,e.m04=s,e.m05=l,e.m06=p*n+_*o+u,e.m07=p*r+_*s+c,e.m08=p*a+_*l+h,e}},{key:"scale",value:function(e,t,i){var n=i.x,r=i.y;return e.m00=n*t.m00,e.m01=n*t.m01,e.m02=n*t.m02,e.m03=r*t.m03,e.m04=r*t.m04,e.m05=r*t.m05,e.m06=t.m06,e.m07=t.m07,e.m08=t.m08,e}},{key:"rotate",value:function(e,t,i){var n=t.m00,r=t.m01,a=t.m02,o=t.m03,s=t.m04,l=t.m05,u=t.m06,c=t.m07,h=t.m08,p=Math.sin(i),_=Math.cos(i);return e.m00=_*n+p*o,e.m01=_*r+p*s,e.m02=_*a+p*l,e.m03=_*o-p*n,e.m04=_*s-p*r,e.m05=_*l-p*a,e.m06=u,e.m07=c,e.m08=h,e}},{key:"fromMat4",value:function(e,t){return e.m00=t.m00,e.m01=t.m01,e.m02=t.m02,e.m03=t.m04,e.m04=t.m05,e.m05=t.m06,e.m06=t.m08,e.m07=t.m09,e.m08=t.m10,e}},{key:"fromViewUp",value:function(e,i,n){return Ii.lengthSqr(i)<1e-12?(t.identity(e),e):(n=n||Ii.UNIT_Y,Ii.normalize(Gi,Ii.cross(Gi,n,i)),Ii.lengthSqr(Gi)<1e-12?(t.identity(e),e):(Ii.cross(Ui,i,Gi),t.set(e,Gi.x,Gi.y,Gi.z,Ui.x,Ui.y,Ui.z,i.x,i.y,i.z),e))}},{key:"fromTranslation",value:function(e,t){return e.m00=1,e.m01=0,e.m02=0,e.m03=0,e.m04=1,e.m05=0,e.m06=t.x,e.m07=t.y,e.m08=1,e}},{key:"fromScaling",value:function(e,t){return e.m00=t.x,e.m01=0,e.m02=0,e.m03=0,e.m04=t.y,e.m05=0,e.m06=0,e.m07=0,e.m08=1,e}},{key:"fromRotation",value:function(e,t){var i=Math.sin(t),n=Math.cos(t);return e.m00=n,e.m01=i,e.m02=0,e.m03=-i,e.m04=n,e.m05=0,e.m06=0,e.m07=0,e.m08=1,e}},{key:"fromQuat",value:function(e,t){var i=t.x,n=t.y,r=t.z,a=t.w,o=i+i,s=n+n,l=r+r,u=i*o,c=n*o,h=n*s,p=r*o,_=r*s,f=r*l,d=a*o,m=a*s,v=a*l;return e.m00=1-h-f,e.m03=c-v,e.m06=p+m,e.m01=c+v,e.m04=1-u-f,e.m07=_-d,e.m02=p-m,e.m05=_+d,e.m08=1-u-h,e}},{key:"inverseTransposeMat4",value:function(e,t){var i=t.m00,n=t.m01,r=t.m02,a=t.m03,o=t.m04,s=t.m05,l=t.m06,u=t.m07,c=t.m08,h=t.m09,p=t.m10,_=t.m11,f=t.m12,d=t.m13,m=t.m14,v=t.m15,y=i*s-n*o,g=i*l-r*o,x=i*u-a*o,b=n*l-r*s,T=n*u-a*s,S=r*u-a*l,E=c*d-h*f,w=c*m-p*f,C=c*v-_*f,A=h*m-p*d,O=h*v-_*d,k=p*v-_*m,R=y*k-g*O+x*A+b*C-T*w+S*E;return R?(R=1/R,e.m00=(s*k-l*O+u*A)*R,e.m01=(l*C-o*k-u*w)*R,e.m02=(o*O-s*C+u*E)*R,e.m03=(r*O-n*k-a*A)*R,e.m04=(i*k-r*C+a*w)*R,e.m05=(n*C-i*O-a*E)*R,e.m06=(d*S-m*T+v*b)*R,e.m07=(m*x-f*S-v*g)*R,e.m08=(f*T-d*x+v*y)*R,e):null}},{key:"toArray",value:function(e,t){var i=arguments.length>2&&void 0!==arguments[2]?arguments[2]:0;return e[i+0]=t.m00,e[i+1]=t.m01,e[i+2]=t.m02,e[i+3]=t.m03,e[i+4]=t.m04,e[i+5]=t.m05,e[i+6]=t.m06,e[i+7]=t.m07,e[i+8]=t.m08,e}},{key:"fromArray",value:function(e,t){var i=arguments.length>2&&void 0!==arguments[2]?arguments[2]:0;return e.m00=t[i+0],e.m01=t[i+1],e.m02=t[i+2],e.m03=t[i+3],e.m04=t[i+4],e.m05=t[i+5],e.m06=t[i+6],e.m07=t[i+7],e.m08=t[i+8],e}},{key:"add",value:function(e,t,i){return e.m00=t.m00+i.m00,e.m01=t.m01+i.m01,e.m02=t.m02+i.m02,e.m03=t.m03+i.m03,e.m04=t.m04+i.m04,e.m05=t.m05+i.m05,e.m06=t.m06+i.m06,e.m07=t.m07+i.m07,e.m08=t.m08+i.m08,e}},{key:"subtract",value:function(e,t,i){return e.m00=t.m00-i.m00,e.m01=t.m01-i.m01,e.m02=t.m02-i.m02,e.m03=t.m03-i.m03,e.m04=t.m04-i.m04,e.m05=t.m05-i.m05,e.m06=t.m06-i.m06,e.m07=t.m07-i.m07,e.m08=t.m08-i.m08,e}},{key:"multiplyScalar",value:function(e,t,i){return e.m00=t.m00*i,e.m01=t.m01*i,e.m02=t.m02*i,e.m03=t.m03*i,e.m04=t.m04*i,e.m05=t.m05*i,e.m06=t.m06*i,e.m07=t.m07*i,e.m08=t.m08*i,e}},{key:"multiplyScalarAndAdd",value:function(e,t,i,n){return e.m00=i.m00*n+t.m00,e.m01=i.m01*n+t.m01,e.m02=i.m02*n+t.m02,e.m03=i.m03*n+t.m03,e.m04=i.m04*n+t.m04,e.m05=i.m05*n+t.m05,e.m06=i.m06*n+t.m06,e.m07=i.m07*n+t.m07,e.m08=i.m08*n+t.m08,e}},{key:"strictEquals",value:function(e,t){return e.m00===t.m00&&e.m01===t.m01&&e.m02===t.m02&&e.m03===t.m03&&e.m04===t.m04&&e.m05===t.m05&&e.m06===t.m06&&e.m07===t.m07&&e.m08===t.m08}},{key:"equals",value:function(e,t){var i=arguments.length>2&&void 0!==arguments[2]?arguments[2]:ui;return Math.abs(e.m00-t.m00)<=i*Math.max(1,Math.abs(e.m00),Math.abs(t.m00))&&Math.abs(e.m01-t.m01)<=i*Math.max(1,Math.abs(e.m01),Math.abs(t.m01))&&Math.abs(e.m02-t.m02)<=i*Math.max(1,Math.abs(e.m02),Math.abs(t.m02))&&Math.abs(e.m03-t.m03)<=i*Math.max(1,Math.abs(e.m03),Math.abs(t.m03))&&Math.abs(e.m04-t.m04)<=i*Math.max(1,Math.abs(e.m04),Math.abs(t.m04))&&Math.abs(e.m05-t.m05)<=i*Math.max(1,Math.abs(e.m05),Math.abs(t.m05))&&Math.abs(e.m06-t.m06)<=i*Math.max(1,Math.abs(e.m06),Math.abs(t.m06))&&Math.abs(e.m07-t.m07)<=i*Math.max(1,Math.abs(e.m07),Math.abs(t.m07))&&Math.abs(e.m08-t.m08)<=i*Math.max(1,Math.abs(e.m08),Math.abs(t.m08))}}]),J(t,[{key:"clone",value:function(){var e=this;return new t(e.m00,e.m01,e.m02,e.m03,e.m04,e.m05,e.m06,e.m07,e.m08)}},{key:"set",value:function(){var e=arguments.length>0&&void 0!==arguments[0]?arguments[0]:1,t=arguments.length>1&&void 0!==arguments[1]?arguments[1]:0,i=arguments.length>2&&void 0!==arguments[2]?arguments[2]:0,n=arguments.length>3&&void 0!==arguments[3]?arguments[3]:0,r=arguments.length>4&&void 0!==arguments[4]?arguments[4]:1,a=arguments.length>5&&void 0!==arguments[5]?arguments[5]:0,o=arguments.length>6&&void 0!==arguments[6]?arguments[6]:0,s=arguments.length>7&&void 0!==arguments[7]?arguments[7]:0,l=arguments.length>8&&void 0!==arguments[8]?arguments[8]:1;return"object"===K(e)?(this.m00=e.m00,this.m01=e.m01,this.m02=e.m02,this.m03=e.m03,this.m04=e.m04,this.m05=e.m05,this.m06=e.m06,this.m07=e.m07,this.m08=e.m08):(this.m00=e,this.m01=t,this.m02=i,this.m03=n,this.m04=r,this.m05=a,this.m06=o,this.m07=s,this.m08=l),this}},{key:"equals",value:function(e){var t=arguments.length>1&&void 0!==arguments[1]?arguments[1]:ui;return Math.abs(this.m00-e.m00)<=t*Math.max(1,Math.abs(this.m00),Math.abs(e.m00))&&Math.abs(this.m01-e.m01)<=t*Math.max(1,Math.abs(this.m01),Math.abs(e.m01))&&Math.abs(this.m02-e.m02)<=t*Math.max(1,Math.abs(this.m02),Math.abs(e.m02))&&Math.abs(this.m03-e.m03)<=t*Math.max(1,Math.abs(this.m03),Math.abs(e.m03))&&Math.abs(this.m04-e.m04)<=t*Math.max(1,Math.abs(this.m04),Math.abs(e.m04))&&Math.abs(this.m05-e.m05)<=t*Math.max(1,Math.abs(this.m05),Math.abs(e.m05))&&Math.abs(this.m06-e.m06)<=t*Math.max(1,Math.abs(this.m06),Math.abs(e.m06))&&Math.abs(this.m07-e.m07)<=t*Math.max(1,Math.abs(this.m07),Math.abs(e.m07))&&Math.abs(this.m08-e.m08)<=t*Math.max(1,Math.abs(this.m08),Math.abs(e.m08))}},{key:"strictEquals",value:function(e){return this.m00===e.m00&&this.m01===e.m01&&this.m02===e.m02&&this.m03===e.m03&&this.m04===e.m04&&this.m05===e.m05&&this.m06===e.m06&&this.m07===e.m07&&this.m08===e.m08}},{key:"toString",value:function(){var e=this;return"[\n"+e.m00+", "+e.m01+", "+e.m02+",\n"+e.m03+",\n"+e.m04+", "+e.m05+",\n"+e.m06+", "+e.m07+",\n"+e.m08+"\n]"}},{key:"identity",value:function(){return this.m00=1,this.m01=0,this.m02=0,this.m03=0,this.m04=1,this.m05=0,this.m06=0,this.m07=0,this.m08=1,this}},{key:"transpose",value:function(){var e=this.m01,t=this.m02,i=this.m05;return this.m01=this.m03,this.m02=this.m06,this.m03=e,this.m05=this.m07,this.m06=t,this.m07=i,this}},{key:"invert",value:function(){var e=this.m00,t=this.m01,i=this.m02,n=this.m03,r=this.m04,a=this.m05,o=this.m06,s=this.m07,l=this.m08,u=l*r-a*s,c=-l*n+a*o,h=s*n-r*o,p=e*u+t*c+i*h;return 0===p?(this.set(0,0,0,0,0,0,0,0,0),this):(p=1/p,this.m00=u*p,this.m01=(-l*t+i*s)*p,this.m02=(a*t-i*r)*p,this.m03=c*p,this.m04=(l*e-i*o)*p,this.m05=(-a*e+i*n)*p,this.m06=h*p,this.m07=(-s*e+t*o)*p,this.m08=(r*e-t*n)*p,this)}},{key:"determinant",value:function(){var e=this.m00,t=this.m01,i=this.m02,n=this.m03,r=this.m04,a=this.m05,o=this.m06,s=this.m07,l=this.m08;return e*(l*r-a*s)+t*(-l*n+a*o)+i*(s*n-r*o)}},{key:"add",value:function(e){return this.m00=this.m00+e.m00,this.m01=this.m01+e.m01,this.m02=this.m02+e.m02,this.m03=this.m03+e.m03,this.m04=this.m04+e.m04,this.m05=this.m05+e.m05,this.m06=this.m06+e.m06,this.m07=this.m07+e.m07,this.m08=this.m08+e.m08,this}},{key:"subtract",value:function(e){return this.m00=this.m00-e.m00,this.m01=this.m01-e.m01,this.m02=this.m02-e.m02,this.m03=this.m03-e.m03,this.m04=this.m04-e.m04,this.m05=this.m05-e.m05,this.m06=this.m06-e.m06,this.m07=this.m07-e.m07,this.m08=this.m08-e.m08,this}},{key:"multiply",value:function(e){var t=this.m00,i=this.m01,n=this.m02,r=this.m03,a=this.m04,o=this.m05,s=this.m06,l=this.m07,u=this.m08,c=e.m00,h=e.m01,p=e.m02,_=e.m03,f=e.m04,d=e.m05,m=e.m06,v=e.m07,y=e.m08;return this.m00=c*t+h*r+p*s,this.m01=c*i+h*a+p*l,this.m02=c*n+h*o+p*u,this.m03=_*t+f*r+d*s,this.m04=_*i+f*a+d*l,this.m05=_*n+f*o+d*u,this.m06=m*t+v*r+y*s,this.m07=m*i+v*a+y*l,this.m08=m*n+v*o+y*u,this}},{key:"multiplyScalar",value:function(e){return this.m00=this.m00*e,this.m01=this.m01*e,this.m02=this.m02*e,this.m03=this.m03*e,this.m04=this.m04*e,this.m05=this.m05*e,this.m06=this.m06*e,this.m07=this.m07*e,this.m08=this.m08*e,this}},{key:"scale",value:function(e){var t=e.x,i=e.y;return this.m00=t*this.m00,this.m01=t*this.m01,this.m02=t*this.m02,this.m03=i*this.m03,this.m04=i*this.m04,this.m05=i*this.m05,this.m06=this.m06,this.m07=this.m07,this.m08=this.m08,this}},{key:"rotate",value:function(e){var t=this.m00,i=this.m01,n=this.m02,r=this.m03,a=this.m04,o=this.m05,s=this.m06,l=this.m07,u=this.m08,c=Math.sin(e),h=Math.cos(e);return this.m00=h*t+c*r,this.m01=h*i+c*a,this.m02=h*n+c*o,this.m03=h*r-c*t,this.m04=h*a-c*i,this.m05=h*o-c*n,this.m06=s,this.m07=l,this.m08=u,this}},{key:"fromQuat",value:function(e){var t=e.x,i=e.y,n=e.z,r=e.w,a=t+t,o=i+i,s=n+n,l=t*a,u=i*a,c=i*o,h=n*a,p=n*o,_=n*s,f=r*a,d=r*o,m=r*s;return this.m00=1-c-_,this.m03=u-m,this.m06=h+d,this.m01=u+m,this.m04=1-l-_,this.m07=p-f,this.m02=h-d,this.m05=p+f,this.m08=1-l-c,this}}]),t}();Bi.IDENTITY=Object.freeze(new Bi);var Gi=new Ii,Ui=new Ii;ni.fastDefine("cc.Mat3",Bi,{m00:1,m01:0,m02:0,m03:0,m04:1,m05:0,m06:0,m07:0,m08:1}),cc.Mat3=Bi;var Xi=function(e){function t(e,i,n,r){var a;return Z(this,t),a=re(this,te(t).call(this)),e&&"object"===K(e)?(a.x=e.x,a.y=e.y,a.z=e.z,a.w=e.w):(a.x=e||0,a.y=i||0,a.z=n||0,a.w=null!=r?r:1),a}return ee(t,Tt),J(t,null,[{key:"clone",value:function(e){return new t(e.x,e.y,e.z,e.w)}},{key:"copy",value:function(e,t){return e.x=t.x,e.y=t.y,e.z=t.z,e.w=t.w,e}},{key:"set",value:function(e,t,i,n,r){return e.x=t,e.y=i,e.z=n,e.w=r,e}},{key:"identity",value:function(e){return e.x=0,e.y=0,e.z=0,e.w=1,e}},{key:"rotationTo",value:function(e,i,n){var r=Ii.dot(i,n);return r<-.999999?(Ii.cross(Wi,Ii.UNIT_X,i),Wi.length()<1e-6&&Ii.cross(Wi,Ii.UNIT_Y,i),Ii.normalize(Wi,Wi),t.fromAxisAngle(e,Wi,Math.PI),e):r>.999999?(e.x=0,e.y=0,e.z=0,e.w=1,e):(Ii.cross(Wi,i,n),e.x=Wi.x,e.y=Wi.y,e.z=Wi.z,e.w=1+r,t.normalize(e,e))}},{key:"getAxisAngle",value:function(e,t){var i=2*Math.acos(t.w),n=Math.sin(i/2);return 0!==n?(e.x=t.x/n,e.y=t.y/n,e.z=t.z/n):(e.x=1,e.y=0,e.z=0),i}},{key:"multiply",value:function(e,t,i){var n=t.x*i.w+t.w*i.x+t.y*i.z-t.z*i.y,r=t.y*i.w+t.w*i.y+t.z*i.x-t.x*i.z,a=t.z*i.w+t.w*i.z+t.x*i.y-t.y*i.x,o=t.w*i.w-t.x*i.x-t.y*i.y-t.z*i.z;return e.x=n,e.y=r,e.z=a,e.w=o,e}},{key:"multiplyScalar",value:function(e,t,i){return e.x=t.x*i,e.y=t.y*i,e.z=t.z*i,e.w=t.w*i,e}},{key:"scaleAndAdd",value:function(e,t,i,n){return e.x=t.x+i.x*n,e.y=t.y+i.y*n,e.z=t.z+i.z*n,e.w=t.w+i.w*n,e}},{key:"rotateX",value:function(e,t,i){i*=.5;var n=Math.sin(i),r=Math.cos(i),a=t.x,o=t.y,s=t.z,l=t.w;return e.x=a*r+l*n,e.y=o*r+s*n,e.z=s*r-o*n,e.w=l*r-a*n,e}},{key:"rotateY",value:function(e,t,i){i*=.5;var n=Math.sin(i),r=Math.cos(i),a=t.x,o=t.y,s=t.z,l=t.w;return e.x=a*r-s*n,e.y=o*r+l*n,e.z=s*r+a*n,e.w=l*r-o*n,e}},{key:"rotateZ",value:function(e,t,i){i*=.5;var n=Math.sin(i),r=Math.cos(i),a=t.x,o=t.y,s=t.z,l=t.w;return e.x=a*r+o*n,e.y=o*r-a*n,e.z=s*r+l*n,e.w=l*r-s*n,e}},{key:"rotateAround",value:function(e,i,n,r){return t.invert(Vi,i),Ii.transformQuat(Wi,n,Vi),t.fromAxisAngle(Vi,Wi,r),t.multiply(e,i,Vi),e}},{key:"rotateAroundLocal",value:function(e,i,n,r){return t.fromAxisAngle(Vi,n,r),t.multiply(e,i,Vi),e}},{key:"calculateW",value:function(e,t){return e.x=t.x,e.y=t.y,e.z=t.z,e.w=Math.sqrt(Math.abs(1-t.x*t.x-t.y*t.y-t.z*t.z)),e}},{key:"dot",value:function(e,t){return e.x*t.x+e.y*t.y+e.z*t.z+e.w*t.w}},{key:"lerp",value:function(e,t,i,n){return e.x=t.x+n*(i.x-t.x),e.y=t.y+n*(i.y-t.y),e.z=t.z+n*(i.z-t.z),e.w=t.w+n*(i.w-t.w),e}},{key:"slerp",value:function(e,t,i,n){var r=0,a=0,o=i.x,s=i.y,l=i.z,u=i.w,c=t.x*i.x+t.y*i.y+t.z*i.z+t.w*i.w;if(c<0&&(c=-c,o=-o,s=-s,l=-l,u=-u),1-c>1e-6){var h=Math.acos(c),p=Math.sin(h);r=Math.sin((1-n)*h)/p,a=Math.sin(n*h)/p}else r=1-n,a=n;return e.x=r*t.x+a*o,e.y=r*t.y+a*s,e.z=r*t.z+a*l,e.w=r*t.w+a*u,e}},{key:"sqlerp",value:function(e,i,n,r,a,o){return t.slerp(Vi,i,a,o),t.slerp(Hi,n,r,o),t.slerp(e,Vi,Hi,2*o*(1-o)),e}},{key:"invert",value:function(e,t){var i=t.x*t.x+t.y*t.y+t.z*t.z+t.w*t.w,n=i?1/i:0;return e.x=-t.x*n,e.y=-t.y*n,e.z=-t.z*n,e.w=t.w*n,e}},{key:"conjugate",value:function(e,t){return e.x=-t.x,e.y=-t.y,e.z=-t.z,e.w=t.w,e}},{key:"len",value:function(e){return Math.sqrt(e.x*e.x+e.y*e.y+e.z*e.z+e.w*e.w)}},{key:"lengthSqr",value:function(e){return e.x*e.x+e.y*e.y+e.z*e.z+e.w*e.w}},{key:"normalize",value:function(e,t){var i=t.x*t.x+t.y*t.y+t.z*t.z+t.w*t.w;return i>0&&(i=1/Math.sqrt(i),e.x=t.x*i,e.y=t.y*i,e.z=t.z*i,e.w=t.w*i),e}},{key:"fromAxes",value:function(e,i,n,r){return Bi.set(ji,i.x,i.y,i.z,n.x,n.y,n.z,r.x,r.y,r.z),t.normalize(e,t.fromMat3(e,ji))}},{key:"fromViewUp",value:function(e,i,n){return Bi.fromViewUp(ji,i,n),t.normalize(e,t.fromMat3(e,ji))}},{key:"fromAxisAngle",value:function(e,t,i){i*=.5;var n=Math.sin(i);return e.x=n*t.x,e.y=n*t.y,e.z=n*t.z,e.w=Math.cos(i),e}},{key:"fromMat3",value:function(e,t){var i=t.m00,n=t.m03,r=t.m06,a=t.m01,o=t.m04,s=t.m07,l=t.m02,u=t.m05,c=t.m08,h=i+o+c;if(h>0){var p=.5/Math.sqrt(h+1);e.w=.25/p,e.x=(u-s)*p,e.y=(r-l)*p,e.z=(a-n)*p}else if(i>o&&i>c){var _=2*Math.sqrt(1+i-o-c);e.w=(u-s)/_,e.x=.25*_,e.y=(n+a)/_,e.z=(r+l)/_}else if(o>c){var f=2*Math.sqrt(1+o-i-c);e.w=(r-l)/f,e.x=(n+a)/f,e.y=.25*f,e.z=(s+u)/f}else{var d=2*Math.sqrt(1+c-i-o);e.w=(a-n)/d,e.x=(r+l)/d,e.y=(s+u)/d,e.z=.25*d}return e}},{key:"fromEuler",value:function(e,t,i,n){t*=qi,i*=qi,n*=qi;var r=Math.sin(t),a=Math.cos(t),o=Math.sin(i),s=Math.cos(i),l=Math.sin(n),u=Math.cos(n);return e.x=r*s*u+a*o*l,e.y=a*o*u+r*s*l,e.z=a*s*l-r*o*u,e.w=a*s*u-r*o*l,e}},{key:"toAxisX",value:function(e,t){var i=2*t.y,n=2*t.z;return e.x=1-i*t.y-n*t.z,e.y=i*t.x+n*t.w,e.z=n*t.x+i*t.w,e}},{key:"toAxisY",value:function(e,t){var i=2*t.x,n=2*t.y,r=2*t.z;return e.x=n*t.x-r*t.w,e.y=1-i*t.x-r*t.z,e.z=r*t.y+i*t.w,e}},{key:"toAxisZ",value:function(e,t){var i=2*t.x,n=2*t.y,r=2*t.z;return e.x=r*t.x-n*t.w,e.y=r*t.y-i*t.w,e.z=1-i*t.x-n*t.y,e}},{key:"toEuler",value:function(e,t,i){var n=t.x,r=t.y,a=t.z,o=t.w,s=0,l=0,u=0,c=n*r+a*o;if(c>.499999)s=0,l=mi(2*Math.atan2(n,o)),u=90;else if(c<-.499999)s=0,l=-mi(2*Math.atan2(n,o)),u=-90;else{var h=n*n,p=r*r,_=a*a;s=mi(Math.atan2(2*n*o-2*r*a,1-2*h-2*_)),l=mi(Math.atan2(2*r*o-2*n*a,1-2*p-2*_)),u=mi(Math.asin(2*c)),i&&(s=-180*Math.sign(s+1e-6)+s,l=-180*Math.sign(l+1e-6)+l,u=180*Math.sign(u+1e-6)-u)}return e.x=s,e.y=l,e.z=u,e}},{key:"toArray",value:function(e,t){var i=arguments.length>2&&void 0!==arguments[2]?arguments[2]:0;return e[i+0]=t.x,e[i+1]=t.y,e[i+2]=t.z,e[i+3]=t.w,e}},{key:"fromArray",value:function(e,t){var i=arguments.length>2&&void 0!==arguments[2]?arguments[2]:0;return e.x=t[i+0],e.y=t[i+1],e.z=t[i+2],e.w=t[i+3],e}},{key:"strictEquals",value:function(e,t){return e.x===t.x&&e.y===t.y&&e.z===t.z&&e.w===t.w}},{key:"equals",value:function(e,t){var i=arguments.length>2&&void 0!==arguments[2]?arguments[2]:ui;return Math.abs(e.x-t.x)<=i*Math.max(1,Math.abs(e.x),Math.abs(t.x))&&Math.abs(e.y-t.y)<=i*Math.max(1,Math.abs(e.y),Math.abs(t.y))&&Math.abs(e.z-t.z)<=i*Math.max(1,Math.abs(e.z),Math.abs(t.z))&&Math.abs(e.w-t.w)<=i*Math.max(1,Math.abs(e.w),Math.abs(t.w))}}]),J(t,[{key:"clone",value:function(){return new t(this.x,this.y,this.z,this.w)}},{key:"set",value:function(e,t,i,n){return e&&"object"===K(e)?(this.x=e.x,this.y=e.y,this.z=e.z,this.w=e.w):(this.x=e||0,this.y=t||0,this.z=i||0,this.w=n||1),this}},{key:"equals",value:function(e){var t=arguments.length>1&&void 0!==arguments[1]?arguments[1]:ui;return Math.abs(this.x-e.x)<=t*Math.max(1,Math.abs(this.x),Math.abs(e.x))&&Math.abs(this.y-e.y)<=t*Math.max(1,Math.abs(this.y),Math.abs(e.y))&&Math.abs(this.z-e.z)<=t*Math.max(1,Math.abs(this.z),Math.abs(e.z))&&Math.abs(this.w-e.w)<=t*Math.max(1,Math.abs(this.w),Math.abs(e.w))}},{key:"strictEquals",value:function(e){return e&&this.x===e.x&&this.y===e.y&&this.z===e.z&&this.w===e.w}},{key:"getEulerAngles",value:function(e){return t.toEuler(e,this)}},{key:"lerp",value:function(e,t){return this.x=this.x+t*(e.x-this.x),this.y=this.y+t*(e.y-this.y),this.z=this.z+t*(e.z-this.z),this.w=this.w+t*(e.w-this.w),this}},{key:"slerp",value:function(e,i){return t.slerp(this,this,e,i)}},{key:"length",value:function(){return Math.sqrt(this.x*this.x+this.y*this.y+this.z*this.z+this.w*this.w)}},{key:"lengthSqr",value:function(){return this.x*this.x+this.y*this.y+this.z*this.z+this.w*this.w}}]),t}();Xi.IDENTITY=Object.freeze(new Xi);var Vi=new Xi,Hi=new Xi,Wi=new Ii,ji=new Bi,qi=.5*Math.PI/180;function Yi(){var e=arguments.length>0&&void 0!==arguments[0]?arguments[0]:0,t=arguments.length>1&&void 0!==arguments[1]?arguments[1]:0,i=arguments.length>2&&void 0!==arguments[2]?arguments[2]:0,n=arguments.length>3&&void 0!==arguments[3]?arguments[3]:1;return new Xi(e,t,i,n)}ni.fastDefine("cc.Quat",Xi,{x:0,y:0,z:0,w:1}),cc.Quat=Xi,cc.quat=Yi;var Ki=function(e){function t(){var e,i=arguments.length>0&&void 0!==arguments[0]?arguments[0]:1,n=arguments.length>1&&void 0!==arguments[1]?arguments[1]:0,r=arguments.length>2&&void 0!==arguments[2]?arguments[2]:0,a=arguments.length>3&&void 0!==arguments[3]?arguments[3]:0,o=arguments.length>4&&void 0!==arguments[4]?arguments[4]:0,s=arguments.length>5&&void 0!==arguments[5]?arguments[5]:1,l=arguments.length>6&&void 0!==arguments[6]?arguments[6]:0,u=arguments.length>7&&void 0!==arguments[7]?arguments[7]:0,c=arguments.length>8&&void 0!==arguments[8]?arguments[8]:0,h=arguments.length>9&&void 0!==arguments[9]?arguments[9]:0,p=arguments.length>10&&void 0!==arguments[10]?arguments[10]:1,_=arguments.length>11&&void 0!==arguments[11]?arguments[11]:0,f=arguments.length>12&&void 0!==arguments[12]?arguments[12]:0,d=arguments.length>13&&void 0!==arguments[13]?arguments[13]:0,m=arguments.length>14&&void 0!==arguments[14]?arguments[14]:0,v=arguments.length>15&&void 0!==arguments[15]?arguments[15]:1;return Z(this,t),(e=re(this,te(t).call(this))).m00=void 0,e.m01=void 0,e.m02=void 0,e.m03=void 0,e.m04=void 0,e.m05=void 0,e.m06=void 0,e.m07=void 0,e.m08=void 0,e.m09=void 0,e.m10=void 0,e.m11=void 0,e.m12=void 0,e.m13=void 0,e.m14=void 0,e.m15=void 0,"object"===K(i)?(e.m00=i.m00,e.m01=i.m01,e.m02=i.m02,e.m03=i.m03,e.m04=i.m04,e.m05=i.m05,e.m06=i.m06,e.m07=i.m07,e.m08=i.m08,e.m09=i.m09,e.m10=i.m10,e.m11=i.m11,e.m12=i.m12,e.m13=i.m13,e.m14=i.m14,e.m15=i.m15):(e.m00=i,e.m01=n,e.m02=r,e.m03=a,e.m04=o,e.m05=s,e.m06=l,e.m07=u,e.m08=c,e.m09=h,e.m10=p,e.m11=_,e.m12=f,e.m13=d,e.m14=m,e.m15=v),e}return ee(t,Tt),J(t,null,[{key:"clone",value:function(e){return new t(e.m00,e.m01,e.m02,e.m03,e.m04,e.m05,e.m06,e.m07,e.m08,e.m09,e.m10,e.m11,e.m12,e.m13,e.m14,e.m15)}},{key:"copy",value:function(e,t){return e.m00=t.m00,e.m01=t.m01,e.m02=t.m02,e.m03=t.m03,e.m04=t.m04,e.m05=t.m05,e.m06=t.m06,e.m07=t.m07,e.m08=t.m08,e.m09=t.m09,e.m10=t.m10,e.m11=t.m11,e.m12=t.m12,e.m13=t.m13,e.m14=t.m14,e.m15=t.m15,e}},{key:"set",value:function(e,t,i,n,r,a,o,s,l,u,c,h,p,_,f,d,m){return e.m00=t,e.m01=i,e.m02=n,e.m03=r,e.m04=a,e.m05=o,e.m06=s,e.m07=l,e.m08=u,e.m09=c,e.m10=h,e.m11=p,e.m12=_,e.m13=f,e.m14=d,e.m15=m,e}},{key:"identity",value:function(e){return e.m00=1,e.m01=0,e.m02=0,e.m03=0,e.m04=0,e.m05=1,e.m06=0,e.m07=0,e.m08=0,e.m09=0,e.m10=1,e.m11=0,e.m12=0,e.m13=0,e.m14=0,e.m15=1,e}},{key:"transpose",value:function(e,t){if(e===t){var i=t.m01,n=t.m02,r=t.m03,a=t.m06,o=t.m07,s=t.m11;e.m01=t.m04,e.m02=t.m08,e.m03=t.m12,e.m04=i,e.m06=t.m09,e.m07=t.m13,e.m08=n,e.m09=a,e.m11=t.m14,e.m12=r,e.m13=o,e.m14=s}else e.m00=t.m00,e.m01=t.m04,e.m02=t.m08,e.m03=t.m12,e.m04=t.m01,e.m05=t.m05,e.m06=t.m09,e.m07=t.m13,e.m08=t.m02,e.m09=t.m06,e.m10=t.m10,e.m11=t.m14,e.m12=t.m03,e.m13=t.m07,e.m14=t.m11,e.m15=t.m15;return e}},{key:"invert",value:function(e,t){var i=t.m00,n=t.m01,r=t.m02,a=t.m03,o=t.m04,s=t.m05,l=t.m06,u=t.m07,c=t.m08,h=t.m09,p=t.m10,_=t.m11,f=t.m12,d=t.m13,m=t.m14,v=t.m15,y=i*s-n*o,g=i*l-r*o,x=i*u-a*o,b=n*l-r*s,T=n*u-a*s,S=r*u-a*l,E=c*d-h*f,w=c*m-p*f,C=c*v-_*f,A=h*m-p*d,O=h*v-_*d,k=p*v-_*m,R=y*k-g*O+x*A+b*C-T*w+S*E;return 0===R?(e.m00=0,e.m01=0,e.m02=0,e.m03=0,e.m04=0,e.m05=0,e.m06=0,e.m07=0,e.m08=0,e.m09=0,e.m10=0,e.m11=0,e.m12=0,e.m13=0,e.m14=0,e.m15=0,e):(R=1/R,e.m00=(s*k-l*O+u*A)*R,e.m01=(r*O-n*k-a*A)*R,e.m02=(d*S-m*T+v*b)*R,e.m03=(p*T-h*S-_*b)*R,e.m04=(l*C-o*k-u*w)*R,e.m05=(i*k-r*C+a*w)*R,e.m06=(m*x-f*S-v*g)*R,e.m07=(c*S-p*x+_*g)*R,e.m08=(o*O-s*C+u*E)*R,e.m09=(n*C-i*O-a*E)*R,e.m10=(f*T-d*x+v*y)*R,e.m11=(h*x-c*T-_*y)*R,e.m12=(s*w-o*A-l*E)*R,e.m13=(i*A-n*w+r*E)*R,e.m14=(d*g-f*b-m*y)*R,e.m15=(c*b-h*g+p*y)*R,e)}},{key:"determinant",value:function(e){var t=e.m00,i=e.m01,n=e.m02,r=e.m03,a=e.m04,o=e.m05,s=e.m06,l=e.m07,u=e.m08,c=e.m09,h=e.m10,p=e.m11,_=e.m12,f=e.m13,d=e.m14,m=e.m15;return(t*o-i*a)*(h*m-p*d)-(t*s-n*a)*(c*m-p*f)+(t*l-r*a)*(c*d-h*f)+(i*s-n*o)*(u*m-p*_)-(i*l-r*o)*(u*d-h*_)+(n*l-r*s)*(u*f-c*_)}},{key:"multiply",value:function(e,t,i){var n=t.m00,r=t.m01,a=t.m02,o=t.m03,s=t.m04,l=t.m05,u=t.m06,c=t.m07,h=t.m08,p=t.m09,_=t.m10,f=t.m11,d=t.m12,m=t.m13,v=t.m14,y=t.m15,g=i.m00,x=i.m01,b=i.m02,T=i.m03;return e.m00=g*n+x*s+b*h+T*d,e.m01=g*r+x*l+b*p+T*m,e.m02=g*a+x*u+b*_+T*v,e.m03=g*o+x*c+b*f+T*y,g=i.m04,x=i.m05,b=i.m06,T=i.m07,e.m04=g*n+x*s+b*h+T*d,e.m05=g*r+x*l+b*p+T*m,e.m06=g*a+x*u+b*_+T*v,e.m07=g*o+x*c+b*f+T*y,g=i.m08,x=i.m09,b=i.m10,T=i.m11,e.m08=g*n+x*s+b*h+T*d,e.m09=g*r+x*l+b*p+T*m,e.m10=g*a+x*u+b*_+T*v,e.m11=g*o+x*c+b*f+T*y,g=i.m12,x=i.m13,b=i.m14,T=i.m15,e.m12=g*n+x*s+b*h+T*d,e.m13=g*r+x*l+b*p+T*m,e.m14=g*a+x*u+b*_+T*v,e.m15=g*o+x*c+b*f+T*y,e}},{key:"transform",value:function(e,t,i){var n=i.x,r=i.y,a=i.z;if(t===e)e.m12=t.m00*n+t.m04*r+t.m08*a+t.m12,e.m13=t.m01*n+t.m05*r+t.m09*a+t.m13,e.m14=t.m02*n+t.m06*r+t.m10*a+t.m14,e.m15=t.m03*n+t.m07*r+t.m11*a+t.m15;else{var o=t.m00,s=t.m01,l=t.m02,u=t.m03,c=t.m04,h=t.m05,p=t.m06,_=t.m07,f=t.m08,d=t.m09,m=t.m10,v=t.m11;t.m12,t.m13,t.m14,t.m15;e.m00=o,e.m01=s,e.m02=l,e.m03=u,e.m04=c,e.m05=h,e.m06=p,e.m07=_,e.m08=f,e.m09=d,e.m10=m,e.m11=v,e.m12=o*n+c*r+f*a+t.m12,e.m13=s*n+h*r+d*a+t.m13,e.m14=l*n+p*r+m*a+t.m14,e.m15=u*n+_*r+v*a+t.m15}return e}},{key:"translate",value:function(e,t,i){return console.warn("function changed"),t===e?(e.m12+=i.x,e.m13+=i.y,e.m14+=i.z):(e.m00=t.m00,e.m01=t.m01,e.m02=t.m02,e.m03=t.m03,e.m04=t.m04,e.m05=t.m05,e.m06=t.m06,e.m07=t.m07,e.m08=t.m08,e.m09=t.m09,e.m10=t.m10,e.m11=t.m11,e.m12+=i.x,e.m13+=i.y,e.m14+=i.z,e.m15=t.m15),e}},{key:"scale",value:function(e,t,i){var n=i.x,r=i.y,a=i.z;return e.m00=t.m00*n,e.m01=t.m01*n,e.m02=t.m02*n,e.m03=t.m03*n,e.m04=t.m04*r,e.m05=t.m05*r,e.m06=t.m06*r,e.m07=t.m07*r,e.m08=t.m08*a,e.m09=t.m09*a,e.m10=t.m10*a,e.m11=t.m11*a,e.m12=t.m12,e.m13=t.m13,e.m14=t.m14,e.m15=t.m15,e}},{key:"rotate",value:function(e,t,i,n){var r=n.x,a=n.y,o=n.z,s=Math.sqrt(r*r+a*a+o*o);if(Math.abs(s)<ui)return null;r*=s=1/s,a*=s,o*=s;var l=Math.sin(i),u=Math.cos(i),c=1-u,h=t.m00,p=t.m01,_=t.m02,f=t.m03,d=t.m04,m=t.m05,v=t.m06,y=t.m07,g=t.m08,x=t.m09,b=t.m10,T=t.m11,S=r*r*c+u,E=a*r*c+o*l,w=o*r*c-a*l,C=r*a*c-o*l,A=a*a*c+u,O=o*a*c+r*l,k=r*o*c+a*l,R=a*o*c-r*l,F=o*o*c+u;return e.m00=h*S+d*E+g*w,e.m01=p*S+m*E+x*w,e.m02=_*S+v*E+b*w,e.m03=f*S+y*E+T*w,e.m04=h*C+d*A+g*O,e.m05=p*C+m*A+x*O,e.m06=_*C+v*A+b*O,e.m07=f*C+y*A+T*O,e.m08=h*k+d*R+g*F,e.m09=p*k+m*R+x*F,e.m10=_*k+v*R+b*F,e.m11=f*k+y*R+T*F,t!==e&&(e.m12=t.m12,e.m13=t.m13,e.m14=t.m14,e.m15=t.m15),e}},{key:"rotateX",value:function(e,t,i){var n=Math.sin(i),r=Math.cos(i),a=t.m04,o=t.m05,s=t.m06,l=t.m07,u=t.m08,c=t.m09,h=t.m10,p=t.m11;return t!==e&&(e.m00=t.m00,e.m01=t.m01,e.m02=t.m02,e.m03=t.m03,e.m12=t.m12,e.m13=t.m13,e.m14=t.m14,e.m15=t.m15),e.m04=a*r+u*n,e.m05=o*r+c*n,e.m06=s*r+h*n,e.m07=l*r+p*n,e.m08=u*r-a*n,e.m09=c*r-o*n,e.m10=h*r-s*n,e.m11=p*r-l*n,e}},{key:"rotateY",value:function(e,t,i){var n=Math.sin(i),r=Math.cos(i),a=t.m00,o=t.m01,s=t.m02,l=t.m03,u=t.m08,c=t.m09,h=t.m10,p=t.m11;return t!==e&&(e.m04=t.m04,e.m05=t.m05,e.m06=t.m06,e.m07=t.m07,e.m12=t.m12,e.m13=t.m13,e.m14=t.m14,e.m15=t.m15),e.m00=a*r-u*n,e.m01=o*r-c*n,e.m02=s*r-h*n,e.m03=l*r-p*n,e.m08=a*n+u*r,e.m09=o*n+c*r,e.m10=s*n+h*r,e.m11=l*n+p*r,e}},{key:"rotateZ",value:function(e,t,i){var n=Math.sin(i),r=Math.cos(i),a=t.m00,o=t.m01,s=t.m02,l=t.m03,u=t.m04,c=t.m05,h=t.m06,p=t.m07;return t!==e&&(e.m08=t.m08,e.m09=t.m09,e.m10=t.m10,e.m11=t.m11,e.m12=t.m12,e.m13=t.m13,e.m14=t.m14,e.m15=t.m15),e.m00=a*r+u*n,e.m01=o*r+c*n,e.m02=s*r+h*n,e.m03=l*r+p*n,e.m04=u*r-a*n,e.m05=c*r-o*n,e.m06=h*r-s*n,e.m07=p*r-l*n,e}},{key:"fromTranslation",value:function(e,t){return e.m00=1,e.m01=0,e.m02=0,e.m03=0,e.m04=0,e.m05=1,e.m06=0,e.m07=0,e.m08=0,e.m09=0,e.m10=1,e.m11=0,e.m12=t.x,e.m13=t.y,e.m14=t.z,e.m15=1,e}},{key:"fromScaling",value:function(e,t){return e.m00=t.x,e.m01=0,e.m02=0,e.m03=0,e.m04=0,e.m05=t.y,e.m06=0,e.m07=0,e.m08=0,e.m09=0,e.m10=t.z,e.m11=0,e.m12=0,e.m13=0,e.m14=0,e.m15=1,e}},{key:"fromRotation",value:function(e,t,i){var n=i.x,r=i.y,a=i.z,o=Math.sqrt(n*n+r*r+a*a);if(Math.abs(o)<ui)return null;n*=o=1/o,r*=o,a*=o;var s=Math.sin(t),l=Math.cos(t),u=1-l;return e.m00=n*n*u+l,e.m01=r*n*u+a*s,e.m02=a*n*u-r*s,e.m03=0,e.m04=n*r*u-a*s,e.m05=r*r*u+l,e.m06=a*r*u+n*s,e.m07=0,e.m08=n*a*u+r*s,e.m09=r*a*u-n*s,e.m10=a*a*u+l,e.m11=0,e.m12=0,e.m13=0,e.m14=0,e.m15=1,e}},{key:"fromXRotation",value:function(e,t){var i=Math.sin(t),n=Math.cos(t);return e.m00=1,e.m01=0,e.m02=0,e.m03=0,e.m04=0,e.m05=n,e.m06=i,e.m07=0,e.m08=0,e.m09=-i,e.m10=n,e.m11=0,e.m12=0,e.m13=0,e.m14=0,e.m15=1,e}},{key:"fromYRotation",value:function(e,t){var i=Math.sin(t),n=Math.cos(t);return e.m00=n,e.m01=0,e.m02=-i,e.m03=0,e.m04=0,e.m05=1,e.m06=0,e.m07=0,e.m08=i,e.m09=0,e.m10=n,e.m11=0,e.m12=0,e.m13=0,e.m14=0,e.m15=1,e}},{key:"fromZRotation",value:function(e,t){var i=Math.sin(t),n=Math.cos(t);return e.m00=n,e.m01=i,e.m02=0,e.m03=0,e.m04=-i,e.m05=n,e.m06=0,e.m07=0,e.m08=0,e.m09=0,e.m10=1,e.m11=0,e.m12=0,e.m13=0,e.m14=0,e.m15=1,e}},{key:"fromRT",value:function(e,t,i){var n=t.x,r=t.y,a=t.z,o=t.w,s=n+n,l=r+r,u=a+a,c=n*s,h=n*l,p=n*u,_=r*l,f=r*u,d=a*u,m=o*s,v=o*l,y=o*u;return e.m00=1-(_+d),e.m01=h+y,e.m02=p-v,e.m03=0,e.m04=h-y,e.m05=1-(c+d),e.m06=f+m,e.m07=0,e.m08=p+v,e.m09=f-m,e.m10=1-(c+_),e.m11=0,e.m12=i.x,e.m13=i.y,e.m14=i.z,e.m15=1,e}},{key:"getTranslation",value:function(e,t){return e.x=t.m12,e.y=t.m13,e.z=t.m14,e}},{key:"getScaling",value:function(e,t){var i=Qi.m00=t.m00,n=Qi.m01=t.m01,r=Qi.m02=t.m02,a=Qi.m03=t.m04,o=Qi.m04=t.m05,s=Qi.m05=t.m06,l=Qi.m06=t.m08,u=Qi.m07=t.m09,c=Qi.m08=t.m10;return e.x=Math.sqrt(i*i+n*n+r*r),e.y=Math.sqrt(a*a+o*o+s*s),e.z=Math.sqrt(l*l+u*u+c*c),Bi.determinant(Qi)<0&&(e.x*=-1),e}},{key:"getRotation",value:function(e,t){var i=t.m00+t.m05+t.m10,n=0;return i>0?(n=2*Math.sqrt(i+1),e.w=.25*n,e.x=(t.m06-t.m09)/n,e.y=(t.m08-t.m02)/n,e.z=(t.m01-t.m04)/n):t.m00>t.m05&&t.m00>t.m10?(n=2*Math.sqrt(1+t.m00-t.m05-t.m10),e.w=(t.m06-t.m09)/n,e.x=.25*n,e.y=(t.m01+t.m04)/n,e.z=(t.m08+t.m02)/n):t.m05>t.m10?(n=2*Math.sqrt(1+t.m05-t.m00-t.m10),e.w=(t.m08-t.m02)/n,e.x=(t.m01+t.m04)/n,e.y=.25*n,e.z=(t.m06+t.m09)/n):(n=2*Math.sqrt(1+t.m10-t.m00-t.m05),e.w=(t.m01-t.m04)/n,e.x=(t.m08+t.m02)/n,e.y=(t.m06+t.m09)/n,e.z=.25*n),e}},{key:"toRTS",value:function(e,t,i,n){n.x=Ii.set(Zi,e.m00,e.m01,e.m02).length(),Qi.m00=e.m00/n.x,Qi.m01=e.m01/n.x,Qi.m02=e.m02/n.x,n.y=Ii.set(Zi,e.m04,e.m05,e.m06).length(),Qi.m03=e.m04/n.y,Qi.m04=e.m05/n.y,Qi.m05=e.m06/n.y,n.z=Ii.set(Zi,e.m08,e.m09,e.m10).length(),Qi.m06=e.m08/n.z,Qi.m07=e.m09/n.z,Qi.m08=e.m10/n.z,Bi.determinant(Qi)<0&&(n.x*=-1,Qi.m00*=-1,Qi.m01*=-1,Qi.m02*=-1),Xi.fromMat3(t,Qi),Ii.set(i,e.m12,e.m13,e.m14)}},{key:"fromRTS",value:function(e,t,i,n){var r=t.x,a=t.y,o=t.z,s=t.w,l=r+r,u=a+a,c=o+o,h=r*l,p=r*u,_=r*c,f=a*u,d=a*c,m=o*c,v=s*l,y=s*u,g=s*c,x=n.x,b=n.y,T=n.z;return e.m00=(1-(f+m))*x,e.m01=(p+g)*x,e.m02=(_-y)*x,e.m03=0,e.m04=(p-g)*b,e.m05=(1-(h+m))*b,e.m06=(d+v)*b,e.m07=0,e.m08=(_+y)*T,e.m09=(d-v)*T,e.m10=(1-(h+f))*T,e.m11=0,e.m12=i.x,e.m13=i.y,e.m14=i.z,e.m15=1,e}},{key:"fromRTSOrigin",value:function(e,t,i,n,r){var a=t.x,o=t.y,s=t.z,l=t.w,u=a+a,c=o+o,h=s+s,p=a*u,_=a*c,f=a*h,d=o*c,m=o*h,v=s*h,y=l*u,g=l*c,x=l*h,b=n.x,T=n.y,S=n.z,E=r.x,w=r.y,C=r.z;return e.m00=(1-(d+v))*b,e.m01=(_+x)*b,e.m02=(f-g)*b,e.m03=0,e.m04=(_-x)*T,e.m05=(1-(p+v))*T,e.m06=(m+y)*T,e.m07=0,e.m08=(f+g)*S,e.m09=(m-y)*S,e.m10=(1-(p+d))*S,e.m11=0,e.m12=i.x+E-(e.m00*E+e.m04*w+e.m08*C),e.m13=i.y+w-(e.m01*E+e.m05*w+e.m09*C),e.m14=i.z+C-(e.m02*E+e.m06*w+e.m10*C),e.m15=1,e}},{key:"fromQuat",value:function(e,t){var i=t.x,n=t.y,r=t.z,a=t.w,o=i+i,s=n+n,l=r+r,u=i*o,c=n*o,h=n*s,p=r*o,_=r*s,f=r*l,d=a*o,m=a*s,v=a*l;return e.m00=1-h-f,e.m01=c+v,e.m02=p-m,e.m03=0,e.m04=c-v,e.m05=1-u-f,e.m06=_+d,e.m07=0,e.m08=p+m,e.m09=_-d,e.m10=1-u-h,e.m11=0,e.m12=0,e.m13=0,e.m14=0,e.m15=1,e}},{key:"frustum",value:function(e,t,i,n,r,a,o){var s=1/(i-t),l=1/(r-n),u=1/(a-o);return e.m00=2*a*s,e.m01=0,e.m02=0,e.m03=0,e.m04=0,e.m05=2*a*l,e.m06=0,e.m07=0,e.m08=(i+t)*s,e.m09=(r+n)*l,e.m10=(o+a)*u,e.m11=-1,e.m12=0,e.m13=0,e.m14=o*a*2*u,e.m15=0,e}},{key:"perspective",value:function(e,t,i,n,r){var a=!(arguments.length>5&&void 0!==arguments[5])||arguments[5],o=1/Math.tan(t/2),s=1/(n-r);return e.m00=a?o/i:o,e.m01=0,e.m02=0,e.m03=0,e.m04=0,e.m05=a?o:o*i,e.m06=0,e.m07=0,e.m08=0,e.m09=0,e.m10=(r+n)*s,e.m11=-1,e.m12=0,e.m13=0,e.m14=2*r*n*s,e.m15=0,e}},{key:"ortho",value:function(e,t,i,n,r,a,o){var s=1/(t-i),l=1/(n-r),u=1/(a-o);return e.m00=-2*s,e.m01=0,e.m02=0,e.m03=0,e.m04=0,e.m05=-2*l,e.m06=0,e.m07=0,e.m08=0,e.m09=0,e.m10=2*u,e.m11=0,e.m12=(t+i)*s,e.m13=(r+n)*l,e.m14=(o+a)*u,e.m15=1,e}},{key:"lookAt",value:function(e,t,i,n){var r=t.x,a=t.y,o=t.z,s=n.x,l=n.y,u=n.z,c=r-i.x,h=a-i.y,p=o-i.z,_=1/Math.sqrt(c*c+h*h+p*p),f=l*(p*=_)-u*(h*=_),d=u*(c*=_)-s*p,m=s*h-l*c,v=h*(m*=_=1/Math.sqrt(f*f+d*d+m*m))-p*(d*=_),y=p*(f*=_)-c*m,g=c*d-h*f;return e.m00=f,e.m01=v,e.m02=c,e.m03=0,e.m04=d,e.m05=y,e.m06=h,e.m07=0,e.m08=m,e.m09=g,e.m10=p,e.m11=0,e.m12=-(f*r+d*a+m*o),e.m13=-(v*r+y*a+g*o),e.m14=-(c*r+h*a+p*o),e.m15=1,e}},{key:"inverseTranspose",value:function(e,t){var i=t.m00,n=t.m01,r=t.m02,a=t.m03,o=t.m04,s=t.m05,l=t.m06,u=t.m07,c=t.m08,h=t.m09,p=t.m10,_=t.m11,f=t.m12,d=t.m13,m=t.m14,v=t.m15,y=i*s-n*o,g=i*l-r*o,x=i*u-a*o,b=n*l-r*s,T=n*u-a*s,S=r*u-a*l,E=c*d-h*f,w=c*m-p*f,C=c*v-_*f,A=h*m-p*d,O=h*v-_*d,k=p*v-_*m,R=y*k-g*O+x*A+b*C-T*w+S*E;return R?(R=1/R,e.m00=(s*k-l*O+u*A)*R,e.m01=(l*C-o*k-u*w)*R,e.m02=(o*O-s*C+u*E)*R,e.m03=0,e.m04=(r*O-n*k-a*A)*R,e.m05=(i*k-r*C+a*w)*R,e.m06=(n*C-i*O-a*E)*R,e.m07=0,e.m08=(d*S-m*T+v*b)*R,e.m09=(m*x-f*S-v*g)*R,e.m10=(f*T-d*x+v*y)*R,e.m11=0,e.m12=0,e.m13=0,e.m14=0,e.m15=1,e):null}},{key:"toArray",value:function(e,t){var i=arguments.length>2&&void 0!==arguments[2]?arguments[2]:0;return e[i+0]=t.m00,e[i+1]=t.m01,e[i+2]=t.m02,e[i+3]=t.m03,e[i+4]=t.m04,e[i+5]=t.m05,e[i+6]=t.m06,e[i+7]=t.m07,e[i+8]=t.m08,e[i+9]=t.m09,e[i+10]=t.m10,e[i+11]=t.m11,e[i+12]=t.m12,e[i+13]=t.m13,e[i+14]=t.m14,e[i+15]=t.m15,e}},{key:"fromArray",value:function(e,t){var i=arguments.length>2&&void 0!==arguments[2]?arguments[2]:0;return e.m00=t[i+0],e.m01=t[i+1],e.m02=t[i+2],e.m03=t[i+3],e.m04=t[i+4],e.m05=t[i+5],e.m06=t[i+6],e.m07=t[i+7],e.m08=t[i+8],e.m09=t[i+9],e.m10=t[i+10],e.m11=t[i+11],e.m12=t[i+12],e.m13=t[i+13],e.m14=t[i+14],e.m15=t[i+15],e}},{key:"add",value:function(e,t,i){return e.m00=t.m00+i.m00,e.m01=t.m01+i.m01,e.m02=t.m02+i.m02,e.m03=t.m03+i.m03,e.m04=t.m04+i.m04,e.m05=t.m05+i.m05,e.m06=t.m06+i.m06,e.m07=t.m07+i.m07,e.m08=t.m08+i.m08,e.m09=t.m09+i.m09,e.m10=t.m10+i.m10,e.m11=t.m11+i.m11,e.m12=t.m12+i.m12,e.m13=t.m13+i.m13,e.m14=t.m14+i.m14,e.m15=t.m15+i.m15,e}},{key:"subtract",value:function(e,t,i){return e.m00=t.m00-i.m00,e.m01=t.m01-i.m01,e.m02=t.m02-i.m02,e.m03=t.m03-i.m03,e.m04=t.m04-i.m04,e.m05=t.m05-i.m05,e.m06=t.m06-i.m06,e.m07=t.m07-i.m07,e.m08=t.m08-i.m08,e.m09=t.m09-i.m09,e.m10=t.m10-i.m10,e.m11=t.m11-i.m11,e.m12=t.m12-i.m12,e.m13=t.m13-i.m13,e.m14=t.m14-i.m14,e.m15=t.m15-i.m15,e}},{key:"multiplyScalar",value:function(e,t,i){return e.m00=t.m00*i,e.m01=t.m01*i,e.m02=t.m02*i,e.m03=t.m03*i,e.m04=t.m04*i,e.m05=t.m05*i,e.m06=t.m06*i,e.m07=t.m07*i,e.m08=t.m08*i,e.m09=t.m09*i,e.m10=t.m10*i,e.m11=t.m11*i,e.m12=t.m12*i,e.m13=t.m13*i,e.m14=t.m14*i,e.m15=t.m15*i,e}},{key:"multiplyScalarAndAdd",value:function(e,t,i,n){return e.m00=t.m00+i.m00*n,e.m01=t.m01+i.m01*n,e.m02=t.m02+i.m02*n,e.m03=t.m03+i.m03*n,e.m04=t.m04+i.m04*n,e.m05=t.m05+i.m05*n,e.m06=t.m06+i.m06*n,e.m07=t.m07+i.m07*n,e.m08=t.m08+i.m08*n,e.m09=t.m09+i.m09*n,e.m10=t.m10+i.m10*n,e.m11=t.m11+i.m11*n,e.m12=t.m12+i.m12*n,e.m13=t.m13+i.m13*n,e.m14=t.m14+i.m14*n,e.m15=t.m15+i.m15*n,e}},{key:"strictEquals",value:function(e,t){return e.m00===t.m00&&e.m01===t.m01&&e.m02===t.m02&&e.m03===t.m03&&e.m04===t.m04&&e.m05===t.m05&&e.m06===t.m06&&e.m07===t.m07&&e.m08===t.m08&&e.m09===t.m09&&e.m10===t.m10&&e.m11===t.m11&&e.m12===t.m12&&e.m13===t.m13&&e.m14===t.m14&&e.m15===t.m15}},{key:"equals",value:function(e,t){var i=arguments.length>2&&void 0!==arguments[2]?arguments[2]:ui;return Math.abs(e.m00-t.m00)<=i*Math.max(1,Math.abs(e.m00),Math.abs(t.m00))&&Math.abs(e.m01-t.m01)<=i*Math.max(1,Math.abs(e.m01),Math.abs(t.m01))&&Math.abs(e.m02-t.m02)<=i*Math.max(1,Math.abs(e.m02),Math.abs(t.m02))&&Math.abs(e.m03-t.m03)<=i*Math.max(1,Math.abs(e.m03),Math.abs(t.m03))&&Math.abs(e.m04-t.m04)<=i*Math.max(1,Math.abs(e.m04),Math.abs(t.m04))&&Math.abs(e.m05-t.m05)<=i*Math.max(1,Math.abs(e.m05),Math.abs(t.m05))&&Math.abs(e.m06-t.m06)<=i*Math.max(1,Math.abs(e.m06),Math.abs(t.m06))&&Math.abs(e.m07-t.m07)<=i*Math.max(1,Math.abs(e.m07),Math.abs(t.m07))&&Math.abs(e.m08-t.m08)<=i*Math.max(1,Math.abs(e.m08),Math.abs(t.m08))&&Math.abs(e.m09-t.m09)<=i*Math.max(1,Math.abs(e.m09),Math.abs(t.m09))&&Math.abs(e.m10-t.m10)<=i*Math.max(1,Math.abs(e.m10),Math.abs(t.m10))&&Math.abs(e.m11-t.m11)<=i*Math.max(1,Math.abs(e.m11),Math.abs(t.m11))&&Math.abs(e.m12-t.m12)<=i*Math.max(1,Math.abs(e.m12),Math.abs(t.m12))&&Math.abs(e.m13-t.m13)<=i*Math.max(1,Math.abs(e.m13),Math.abs(t.m13))&&Math.abs(e.m14-t.m14)<=i*Math.max(1,Math.abs(e.m14),Math.abs(t.m14))&&Math.abs(e.m15-t.m15)<=i*Math.max(1,Math.abs(e.m15),Math.abs(t.m15))}}]),J(t,[{key:"clone",value:function(){var e=this;return new t(e.m00,e.m01,e.m02,e.m03,e.m04,e.m05,e.m06,e.m07,e.m08,e.m09,e.m10,e.m11,e.m12,e.m13,e.m14,e.m15)}},{key:"set",value:function(){var e=arguments.length>0&&void 0!==arguments[0]?arguments[0]:1,t=arguments.length>1&&void 0!==arguments[1]?arguments[1]:0,i=arguments.length>2&&void 0!==arguments[2]?arguments[2]:0,n=arguments.length>3&&void 0!==arguments[3]?arguments[3]:0,r=arguments.length>4&&void 0!==arguments[4]?arguments[4]:0,a=arguments.length>5&&void 0!==arguments[5]?arguments[5]:1,o=arguments.length>6&&void 0!==arguments[6]?arguments[6]:0,s=arguments.length>7&&void 0!==arguments[7]?arguments[7]:0,l=arguments.length>8&&void 0!==arguments[8]?arguments[8]:0,u=arguments.length>9&&void 0!==arguments[9]?arguments[9]:0,c=arguments.length>10&&void 0!==arguments[10]?arguments[10]:1,h=arguments.length>11&&void 0!==arguments[11]?arguments[11]:0,p=arguments.length>12&&void 0!==arguments[12]?arguments[12]:0,_=arguments.length>13&&void 0!==arguments[13]?arguments[13]:0,f=arguments.length>14&&void 0!==arguments[14]?arguments[14]:0,d=arguments.length>15&&void 0!==arguments[15]?arguments[15]:1;return"object"===K(e)?(this.m01=e.m01,this.m02=e.m02,this.m03=e.m03,this.m04=e.m04,this.m05=e.m05,this.m06=e.m06,this.m07=e.m07,this.m08=e.m08,this.m09=e.m09,this.m10=e.m10,this.m11=e.m11,this.m12=e.m12,this.m13=e.m13,this.m14=e.m14,this.m15=e.m15,this.m00=e.m00):(this.m01=t,this.m02=i,this.m03=n,this.m04=r,this.m05=a,this.m06=o,this.m07=s,this.m08=l,this.m09=u,this.m10=c,this.m11=h,this.m12=p,this.m13=_,this.m14=f,this.m15=d,this.m00=e),this}},{key:"equals",value:function(e){var t=arguments.length>1&&void 0!==arguments[1]?arguments[1]:ui;return Math.abs(this.m00-e.m00)<=t*Math.max(1,Math.abs(this.m00),Math.abs(e.m00))&&Math.abs(this.m01-e.m01)<=t*Math.max(1,Math.abs(this.m01),Math.abs(e.m01))&&Math.abs(this.m02-e.m02)<=t*Math.max(1,Math.abs(this.m02),Math.abs(e.m02))&&Math.abs(this.m03-e.m03)<=t*Math.max(1,Math.abs(this.m03),Math.abs(e.m03))&&Math.abs(this.m04-e.m04)<=t*Math.max(1,Math.abs(this.m04),Math.abs(e.m04))&&Math.abs(this.m05-e.m05)<=t*Math.max(1,Math.abs(this.m05),Math.abs(e.m05))&&Math.abs(this.m06-e.m06)<=t*Math.max(1,Math.abs(this.m06),Math.abs(e.m06))&&Math.abs(this.m07-e.m07)<=t*Math.max(1,Math.abs(this.m07),Math.abs(e.m07))&&Math.abs(this.m08-e.m08)<=t*Math.max(1,Math.abs(this.m08),Math.abs(e.m08))&&Math.abs(this.m09-e.m09)<=t*Math.max(1,Math.abs(this.m09),Math.abs(e.m09))&&Math.abs(this.m10-e.m10)<=t*Math.max(1,Math.abs(this.m10),Math.abs(e.m10))&&Math.abs(this.m11-e.m11)<=t*Math.max(1,Math.abs(this.m11),Math.abs(e.m11))&&Math.abs(this.m12-e.m12)<=t*Math.max(1,Math.abs(this.m12),Math.abs(e.m12))&&Math.abs(this.m13-e.m13)<=t*Math.max(1,Math.abs(this.m13),Math.abs(e.m13))&&Math.abs(this.m14-e.m14)<=t*Math.max(1,Math.abs(this.m14),Math.abs(e.m14))&&Math.abs(this.m15-e.m15)<=t*Math.max(1,Math.abs(this.m15),Math.abs(e.m15))}},{key:"strictEquals",value:function(e){return this.m00===e.m00&&this.m01===e.m01&&this.m02===e.m02&&this.m03===e.m03&&this.m04===e.m04&&this.m05===e.m05&&this.m06===e.m06&&this.m07===e.m07&&this.m08===e.m08&&this.m09===e.m09&&this.m10===e.m10&&this.m11===e.m11&&this.m12===e.m12&&this.m13===e.m13&&this.m14===e.m14&&this.m15===e.m15}},{key:"toString",value:function(){return"[\n"+this.m00+", "+this.m01+", "+this.m02+", "+this.m03+",\n"+this.m04+", "+this.m05+", "+this.m06+", "+this.m07+",\n"+this.m08+", "+this.m09+", "+this.m10+", "+this.m11+",\n"+this.m12+", "+this.m13+", "+this.m14+", "+this.m15+"\n]"}},{key:"identity",value:function(){return this.m00=1,this.m01=0,this.m02=0,this.m03=0,this.m04=0,this.m05=1,this.m06=0,this.m07=0,this.m08=0,this.m09=0,this.m10=1,this.m11=0,this.m12=0,this.m13=0,this.m14=0,this.m15=1,this}},{key:"transpose",value:function(){var e=this.m01,t=this.m02,i=this.m03,n=this.m06,r=this.m07,a=this.m11;return this.m01=this.m04,this.m02=this.m08,this.m03=this.m12,this.m04=e,this.m06=this.m09,this.m07=this.m13,this.m08=t,this.m09=n,this.m11=this.m14,this.m12=i,this.m13=r,this.m14=a,this}},{key:"invert",value:function(){var e=this.m00,t=this.m01,i=this.m02,n=this.m03,r=this.m04,a=this.m05,o=this.m06,s=this.m07,l=this.m08,u=this.m09,c=this.m10,h=this.m11,p=this.m12,_=this.m13,f=this.m14,d=this.m15,m=e*a-t*r,v=e*o-i*r,y=e*s-n*r,g=t*o-i*a,x=t*s-n*a,b=i*s-n*o,T=l*_-u*p,S=l*f-c*p,E=l*d-h*p,w=u*f-c*_,C=u*d-h*_,A=c*d-h*f,O=m*A-v*C+y*w+g*E-x*S+b*T;return 0===O?(this.set(0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0),this):(O=1/O,this.m00=(a*A-o*C+s*w)*O,this.m01=(i*C-t*A-n*w)*O,this.m02=(_*b-f*x+d*g)*O,this.m03=(c*x-u*b-h*g)*O,this.m04=(o*E-r*A-s*S)*O,this.m05=(e*A-i*E+n*S)*O,this.m06=(f*y-p*b-d*v)*O,this.m07=(l*b-c*y+h*v)*O,this.m08=(r*C-a*E+s*T)*O,this.m09=(t*E-e*C-n*T)*O,this.m10=(p*x-_*y+d*m)*O,this.m11=(u*y-l*x-h*m)*O,this.m12=(a*S-r*w-o*T)*O,this.m13=(e*w-t*S+i*T)*O,this.m14=(_*v-p*g-f*m)*O,this.m15=(l*g-u*v+c*m)*O,this)}},{key:"determinant",value:function(){var e=this.m00,t=this.m01,i=this.m02,n=this.m03,r=this.m04,a=this.m05,o=this.m06,s=this.m07,l=this.m08,u=this.m09,c=this.m10,h=this.m11,p=this.m12,_=this.m13,f=this.m14,d=this.m15;return(e*a-t*r)*(c*d-h*f)-(e*o-i*r)*(u*d-h*_)+(e*s-n*r)*(u*f-c*_)+(t*o-i*a)*(l*d-h*p)-(t*s-n*a)*(l*f-c*p)+(i*s-n*o)*(l*_-u*p)}},{key:"add",value:function(e){return this.m00=this.m00+e.m00,this.m01=this.m01+e.m01,this.m02=this.m02+e.m02,this.m03=this.m03+e.m03,this.m04=this.m04+e.m04,this.m05=this.m05+e.m05,this.m06=this.m06+e.m06,this.m07=this.m07+e.m07,this.m08=this.m08+e.m08,this.m09=this.m09+e.m09,this.m10=this.m10+e.m10,this.m11=this.m11+e.m11,this.m12=this.m12+e.m12,this.m13=this.m13+e.m13,this.m14=this.m14+e.m14,this.m15=this.m15+e.m15,this}},{key:"subtract",value:function(e){return this.m00=this.m00-e.m00,this.m01=this.m01-e.m01,this.m02=this.m02-e.m02,this.m03=this.m03-e.m03,this.m04=this.m04-e.m04,this.m05=this.m05-e.m05,this.m06=this.m06-e.m06,this.m07=this.m07-e.m07,this.m08=this.m08-e.m08,this.m09=this.m09-e.m09,this.m10=this.m10-e.m10,this.m11=this.m11-e.m11,this.m12=this.m12-e.m12,this.m13=this.m13-e.m13,this.m14=this.m14-e.m14,this.m15=this.m15-e.m15,this}},{key:"multiply",value:function(e){var t=this.m00,i=this.m01,n=this.m02,r=this.m03,a=this.m04,o=this.m05,s=this.m06,l=this.m07,u=this.m08,c=this.m09,h=this.m10,p=this.m11,_=this.m12,f=this.m13,d=this.m14,m=this.m15,v=e.m00,y=e.m01,g=e.m02,x=e.m03;return this.m00=v*t+y*a+g*u+x*_,this.m01=v*i+y*o+g*c+x*f,this.m02=v*n+y*s+g*h+x*d,this.m03=v*r+y*l+g*p+x*m,v=e.m04,y=e.m05,g=e.m06,x=e.m07,this.m04=v*t+y*a+g*u+x*_,this.m05=v*i+y*o+g*c+x*f,this.m06=v*n+y*s+g*h+x*d,this.m07=v*r+y*l+g*p+x*m,v=e.m08,y=e.m09,g=e.m10,x=e.m11,this.m08=v*t+y*a+g*u+x*_,this.m09=v*i+y*o+g*c+x*f,this.m10=v*n+y*s+g*h+x*d,this.m11=v*r+y*l+g*p+x*m,v=e.m12,y=e.m13,g=e.m14,x=e.m15,this.m12=v*t+y*a+g*u+x*_,this.m13=v*i+y*o+g*c+x*f,this.m14=v*n+y*s+g*h+x*d,this.m15=v*r+y*l+g*p+x*m,this}},{key:"multiplyScalar",value:function(e){return this.m00=this.m00*e,this.m01=this.m01*e,this.m02=this.m02*e,this.m03=this.m03*e,this.m04=this.m04*e,this.m05=this.m05*e,this.m06=this.m06*e,this.m07=this.m07*e,this.m08=this.m08*e,this.m09=this.m09*e,this.m10=this.m10*e,this.m11=this.m11*e,this.m12=this.m12*e,this.m13=this.m13*e,this.m14=this.m14*e,this.m15=this.m15*e,this}},{key:"translate",value:function(e){return console.warn("function changed"),this.m12+=e.x,this.m13+=e.y,this.m14+=e.z,this}},{key:"scale",value:function(e){var t=e.x,i=e.y,n=e.z;return this.m00=this.m00*t,this.m01=this.m01*t,this.m02=this.m02*t,this.m03=this.m03*t,this.m04=this.m04*i,this.m05=this.m05*i,this.m06=this.m06*i,this.m07=this.m07*i,this.m08=this.m08*n,this.m09=this.m09*n,this.m10=this.m10*n,this.m11=this.m11*n,this.m12=this.m12,this.m13=this.m13,this.m14=this.m14,this.m15=this.m15,this}},{key:"rotate",value:function(e,t){var i=t.x,n=t.y,r=t.z,a=Math.sqrt(i*i+n*n+r*r);if(Math.abs(a)<ui)return null;i*=a=1/a,n*=a,r*=a;var o=Math.sin(e),s=Math.cos(e),l=1-s,u=this.m00,c=this.m01,h=this.m02,p=this.m03,_=this.m04,f=this.m05,d=this.m06,m=this.m07,v=this.m08,y=this.m09,g=this.m10,x=this.m11,b=i*i*l+s,T=n*i*l+r*o,S=r*i*l-n*o,E=i*n*l-r*o,w=n*n*l+s,C=r*n*l+i*o,A=i*r*l+n*o,O=n*r*l-i*o,k=r*r*l+s;return this.m00=u*b+_*T+v*S,this.m01=c*b+f*T+y*S,this.m02=h*b+d*T+g*S,this.m03=p*b+m*T+x*S,this.m04=u*E+_*w+v*C,this.m05=c*E+f*w+y*C,this.m06=h*E+d*w+g*C,this.m07=p*E+m*w+x*C,this.m08=u*A+_*O+v*k,this.m09=c*A+f*O+y*k,this.m10=h*A+d*O+g*k,this.m11=p*A+m*O+x*k,this}},{key:"getTranslation",value:function(e){return e.x=this.m12,e.y=this.m13,e.z=this.m14,e}},{key:"getScale",value:function(e){var t=Qi.m00=this.m00,i=Qi.m01=this.m01,n=Qi.m02=this.m02,r=Qi.m03=this.m04,a=Qi.m04=this.m05,o=Qi.m05=this.m06,s=Qi.m06=this.m08,l=Qi.m07=this.m09,u=Qi.m08=this.m10;return e.x=Math.sqrt(t*t+i*i+n*n),e.y=Math.sqrt(r*r+a*a+o*o),e.z=Math.sqrt(s*s+l*l+u*u),Bi.determinant(Qi)<0&&(e.x*=-1),e}},{key:"getRotation",value:function(e){var t=this.m00+this.m05+this.m10,i=0;return t>0?(i=2*Math.sqrt(t+1),e.w=.25*i,e.x=(this.m06-this.m09)/i,e.y=(this.m08-this.m02)/i,e.z=(this.m01-this.m04)/i):this.m00>this.m05&&this.m00>this.m10?(i=2*Math.sqrt(1+this.m00-this.m05-this.m10),e.w=(this.m06-this.m09)/i,e.x=.25*i,e.y=(this.m01+this.m04)/i,e.z=(this.m08+this.m02)/i):this.m05>this.m10?(i=2*Math.sqrt(1+this.m05-this.m00-this.m10),e.w=(this.m08-this.m02)/i,e.x=(this.m01+this.m04)/i,e.y=.25*i,e.z=(this.m06+this.m09)/i):(i=2*Math.sqrt(1+this.m10-this.m00-this.m05),e.w=(this.m01-this.m04)/i,e.x=(this.m08+this.m02)/i,e.y=(this.m06+this.m09)/i,e.z=.25*i),e}},{key:"fromRTS",value:function(e,t,i){var n=e.x,r=e.y,a=e.z,o=e.w,s=n+n,l=r+r,u=a+a,c=n*s,h=n*l,p=n*u,_=r*l,f=r*u,d=a*u,m=o*s,v=o*l,y=o*u,g=i.x,x=i.y,b=i.z;return this.m00=(1-(_+d))*g,this.m01=(h+y)*g,this.m02=(p-v)*g,this.m03=0,this.m04=(h-y)*x,this.m05=(1-(c+d))*x,this.m06=(f+m)*x,this.m07=0,this.m08=(p+v)*b,this.m09=(f-m)*b,this.m10=(1-(c+_))*b,this.m11=0,this.m12=t.x,this.m13=t.y,this.m14=t.z,this.m15=1,this}},{key:"fromQuat",value:function(e){var t=e.x,i=e.y,n=e.z,r=e.w,a=t+t,o=i+i,s=n+n,l=t*a,u=i*a,c=i*o,h=n*a,p=n*o,_=n*s,f=r*a,d=r*o,m=r*s;return this.m00=1-c-_,this.m01=u+m,this.m02=h-d,this.m03=0,this.m04=u-m,this.m05=1-l-_,this.m06=p+f,this.m07=0,this.m08=h+d,this.m09=p-f,this.m10=1-l-c,this.m11=0,this.m12=0,this.m13=0,this.m14=0,this.m15=1,this}}]),t}();Ki.IDENTITY=Object.freeze(new Ki);var Zi=new Ii,Qi=new Bi;function Ji(e,t,i,n,r,a,o,s,l,u,c,h,p,_,f,d){return new Ki(e,t,i,n,r,a,o,s,l,u,c,h,p,_,f,d)}ni.fastDefine("cc.Mat4",Ki,{m00:1,m01:0,m02:0,m03:0,m04:0,m05:1,m06:0,m07:0,m08:0,m09:0,m10:1,m11:0,m12:0,m13:0,m14:0,m15:1}),cc.Mat4=Ki,cc.mat4=Ji;var $i=function(){function e(){var t=arguments.length>0&&void 0!==arguments[0]?arguments[0]:1,i=arguments.length>1&&void 0!==arguments[1]?arguments[1]:0,n=arguments.length>2&&void 0!==arguments[2]?arguments[2]:0,r=arguments.length>3&&void 0!==arguments[3]?arguments[3]:1,a=arguments.length>4&&void 0!==arguments[4]?arguments[4]:0,o=arguments.length>5&&void 0!==arguments[5]?arguments[5]:0;Z(this,e),this.a=t,this.b=i,this.c=n,this.d=r,this.tx=a,this.ty=o}return J(e,null,[{key:"identity",value:function(){return new e}},{key:"clone",value:function(t){return new e(t.a,t.b,t.c,t.d,t.tx,t.ty)}},{key:"concat",value:function(e,t,i){var n=t.a,r=t.b,a=t.c,o=t.d,s=t.tx,l=t.ty;e.a=n*i.a+r*i.c,e.b=n*i.b+r*i.d,e.c=a*i.a+o*i.c,e.d=a*i.b+o*i.d,e.tx=s*i.a+l*i.c+i.tx,e.ty=s*i.b+l*i.d+i.ty}},{key:"invert",value:function(e,t){var i=1/(t.a*t.d-t.b*t.c);e.a=i*t.d,e.b=-i*t.b,e.c=-i*t.c,e.d=i*t.a,e.tx=i*(t.c*t.ty-t.d*t.tx),e.ty=i*(t.b*t.tx-t.a*t.ty)}},{key:"fromMat4",value:function(e,t){e.a=t.m00,e.b=t.m01,e.c=t.m04,e.d=t.m05,e.tx=t.m12,e.ty=t.m13}},{key:"transformVec2",value:function(e,t,i,n){var r,a;void 0===n?(n=i,r=t.x,a=t.y):(r=t,a=i),e.x=n.a*r+n.c*a+n.tx,e.y=n.b*r+n.d*a+n.ty}},{key:"transformSize",value:function(e,t,i){e.width=i.a*t.width+i.c*t.height,e.height=i.b*t.width+i.d*t.height}},{key:"transformRect",value:function(e,t,i){var n=t.x+t.width,r=t.y+t.height,a=i.a*t.x+i.c*t.y+i.tx,o=i.b*t.x+i.d*t.y+i.ty,s=i.a*n+i.c*t.y+i.tx,l=i.b*n+i.d*t.y+i.ty,u=i.a*t.x+i.c*r+i.tx,c=i.b*t.x+i.d*r+i.ty,h=i.a*n+i.c*r+i.tx,p=i.b*n+i.d*r+i.ty,_=Math.min(a,s,u,h),f=Math.max(a,s,u,h),d=Math.min(o,l,c,p),m=Math.max(o,l,c,p);e.x=_,e.y=d,e.width=f-_,e.height=m-d}},{key:"transformObb",value:function(e,t,i,n,r,a){var o=a.a*r.x+a.c*r.y+a.tx,s=a.b*r.x+a.d*r.y+a.ty,l=a.a*r.width,u=a.b*r.width,c=a.c*r.height,h=a.d*r.height;t.x=o,t.y=s,i.x=l+o,i.y=u+s,e.x=c+o,e.y=h+s,n.x=l+c+o,n.y=u+h+s}}]),e}();cc.AffineTransform=$i;var en=function(e){function t(e,i){var n;return Z(this,t),n=re(this,te(t).call(this)),e&&"object"===K(e)?(n.height=e.height,n.width=e.width):(n.width=e||0,n.height=i||0),n}return ee(t,Tt),J(t,[{key:"x",set:function(e){this.width=e},get:function(){return this.width}},{key:"y",set:function(e){this.height=e},get:function(){return this.height}}],[{key:"lerp",value:function(e,t,i,n){return e.width=t.width+(i.width-t.width)*n,e.height=t.height+(i.height-t.height)*n,e}}]),J(t,[{key:"clone",value:function(){return new t(this.width,this.height)}},{key:"set",value:function(e,t){return e&&"object"===K(e)?(this.height=e.height,this.width=e.width):(this.width=e||0,this.height=t||0),this}},{key:"equals",value:function(e){return this.width===e.width&&this.height===e.height}},{key:"lerp",value:function(e,t){return this.width=this.width+(e.width-this.width)*t,this.height=this.height+(e.height-this.height)*t,this}},{key:"toString",value:function(){return"(".concat(this.width.toFixed(2),", ").concat(this.height.toFixed(2),")")}}]),t}();function tn(){var e=arguments.length>0&&void 0!==arguments[0]?arguments[0]:0,t=arguments.length>1&&void 0!==arguments[1]?arguments[1]:0;return new en(e,t)}en.ZERO=Object.freeze(new en(0,0)),en.ONE=Object.freeze(new en(1,1)),ni.fastDefine("cc.Size",en,{width:0,height:0}),cc.size=tn,cc.Size=en;var nn=function(e){function t(e,i,n,r){var a;return Z(this,t),a=re(this,te(t).call(this)),e&&"object"===K(e)?(a.y=e.y,a.width=e.width,a.height=e.height,a.x=e.x):(a.x=e||0,a.y=i||0,a.width=n||0,a.height=r||0),a}return ee(t,Tt),J(t,[{key:"xMin",get:function(){return this.x},set:function(e){this.width+=this.x-e,this.x=e}},{key:"yMin",get:function(){return this.y},set:function(e){this.height+=this.y-e,this.y=e}},{key:"xMax",get:function(){return this.x+this.width},set:function(e){this.width=e-this.x}},{key:"yMax",get:function(){return this.y+this.height},set:function(e){this.height=e-this.y}},{key:"center",get:function(){return new ki(this.x+.5*this.width,this.y+.5*this.height)},set:function(e){this.x=e.x-.5*this.width,this.y=e.y-.5*this.height}},{key:"origin",get:function(){return new cc.Vec2(this.x,this.y)},set:function(e){this.x=e.x,this.y=e.y}},{key:"size",get:function(){return new en(this.width,this.height)},set:function(e){this.width=e.width,this.height=e.height}},{key:"z",set:function(e){this.width=e},get:function(){return this.width}},{key:"w",set:function(e){this.height=e},get:function(){return this.height}}],[{key:"fromMinMax",value:function(e,t,i){var n=Math.min(t.x,i.x),r=Math.min(t.y,i.y),a=Math.max(t.x,i.x),o=Math.max(t.y,i.y);return e.x=n,e.y=r,e.width=a-n,e.height=o-r,e}},{key:"lerp",value:function(e,t,i,n){var r=t.x,a=t.y,o=t.width,s=t.height;return e.x=r+(i.x-r)*n,e.y=a+(i.y-a)*n,e.width=o+(i.width-o)*n,e.height=s+(i.height-s)*n,e}},{key:"intersection",value:function(e,t,i){var n=t.x,r=t.y,a=t.x+t.width,o=t.y+t.height,s=i.x,l=i.y,u=i.x+i.width,c=i.y+i.height;return e.x=Math.max(n,s),e.y=Math.max(r,l),e.width=Math.min(a,u)-e.x,e.height=Math.min(o,c)-e.y,e}},{key:"union",value:function(e,t,i){var n=t.x,r=t.y,a=t.width,o=t.height,s=i.x,l=i.y,u=i.width,c=i.height;return e.x=Math.min(n,s),e.y=Math.min(r,l),e.width=Math.max(n+a,s+u)-e.x,e.height=Math.max(r+o,l+c)-e.y,e}}]),J(t,[{key:"clone",value:function(){return new t(this.x,this.y,this.width,this.height)}},{key:"set",value:function(e,t,i,n){return e&&"object"===K(e)?(this.y=e.y,this.width=e.width,this.height=e.height,this.x=e.x):(this.x=e||0,this.y=t||0,this.width=i||0,this.height=n||0),this}},{key:"equals",value:function(e){return this.x===e.x&&this.y===e.y&&this.width===e.width&&this.height===e.height}},{key:"lerp",value:function(e,t){var i=this.x,n=this.y,r=this.width,a=this.height;return this.x=i+(e.x-i)*t,this.y=n+(e.y-n)*t,this.width=r+(e.width-r)*t,this.height=a+(e.height-a)*t,this}},{key:"toString",value:function(){return"(".concat(this.x.toFixed(2),", ").concat(this.y.toFixed(2),", ").concat(this.width.toFixed(2),", ").concat(this.height.toFixed(2),")")}},{key:"intersects",value:function(e){var t=this.x+this.width,i=this.y+this.height,n=e.x+e.width,r=e.y+e.height;return!(t<e.x||n<this.x||i<e.y||r<this.y)}},{key:"contains",value:function(e){return this.x<=e.x&&this.x+this.width>=e.x&&this.y<=e.y&&this.y+this.height>=e.y}},{key:"containsRect",value:function(e){return this.x<=e.x&&this.x+this.width>=e.x+e.width&&this.y<=e.y&&this.y+this.height>=e.y+e.height}},{key:"transformMat4",value:function(e){var t=this.x,i=this.y,n=t+this.width,r=i+this.height,a=e.m00*t+e.m04*i+e.m12,o=e.m01*t+e.m05*i+e.m13,s=e.m00*n+e.m04*i+e.m12,l=e.m01*n+e.m05*i+e.m13,u=e.m00*t+e.m04*r+e.m12,c=e.m01*t+e.m05*r+e.m13,h=e.m00*n+e.m04*r+e.m12,p=e.m01*n+e.m05*r+e.m13,_=Math.min(a,s,u,h),f=Math.max(a,s,u,h),d=Math.min(o,l,c,p),m=Math.max(o,l,c,p);return this.x=_,this.y=d,this.width=f-_,this.height=m-d,this}}]),t}();function rn(){var e=arguments.length>0&&void 0!==arguments[0]?arguments[0]:0,t=arguments.length>1&&void 0!==arguments[1]?arguments[1]:0,i=arguments.length>2&&void 0!==arguments[2]?arguments[2]:0,n=arguments.length>3&&void 0!==arguments[3]?arguments[3]:0;return new nn(e,t,i,n)}ni.fastDefine("cc.Rect",nn,{x:0,y:0,width:0,height:0}),cc.Rect=nn,cc.rect=rn;var an=function(e){function t(e,i,n,r){var a;return Z(this,t),(a=re(this,te(t).call(this)))._val=0,"string"==typeof e?a.fromHEX(e):void 0!==i?a.set(e,i,n,r):a.set(e),a}return ee(t,Tt),J(t,[{key:"r",get:function(){return 255&this._val},set:function(e){e=~~pi(e,0,255),this._val=(4294967040&this._val|e)>>>0}},{key:"g",get:function(){return(65280&this._val)>>8},set:function(e){e=~~pi(e,0,255),this._val=(4294902015&this._val|e<<8)>>>0}},{key:"b",get:function(){return(16711680&this._val)>>16},set:function(e){e=~~pi(e,0,255),this._val=(4278255615&this._val|e<<16)>>>0}},{key:"a",get:function(){return(4278190080&this._val)>>>24},set:function(e){e=~~pi(e,0,255),this._val=(16777215&this._val|e<<24>>>0)>>>0}},{key:"x",get:function(){return this.r*(1/255)},set:function(e){this.r=255*e}},{key:"y",get:function(){return this.g*(1/255)},set:function(e){this.g=255*e}},{key:"z",get:function(){return this.b*(1/255)},set:function(e){this.b=255*e}},{key:"w",get:function(){return this.a*(1/255)},set:function(e){this.a=255*e}}],[{key:"clone",value:function(e){var i=new t;return e._val?i._val=e._val:i._val=(e.a<<24>>>0)+(e.b<<16)+(e.g<<8)+e.r,i}},{key:"copy",value:function(e,t){return e.r=t.r,e.g=t.g,e.b=t.b,e.a=t.a,e}},{key:"set",value:function(e,t,i,n,r){return e.r=t,e.g=i,e.b=n,e.a=r,e}},{key:"fromHEX",value:function(e,t){return t=0===t.indexOf("#")?t.substring(1):t,e.r=parseInt(t.substr(0,2),16)||0,e.g=parseInt(t.substr(2,2),16)||0,e.b=parseInt(t.substr(4,2),16)||0,e.a=parseInt(t.substr(6,2),16)||255,e._val=(e.a<<24>>>0)+(e.b<<16)+(e.g<<8)+e.r,e}},{key:"add",value:function(e,t,i){return e.r=t.r+i.r,e.g=t.g+i.g,e.b=t.b+i.b,e.a=t.a+i.a,e}},{key:"subtract",value:function(e,t,i){return e.r=t.r-i.r,e.g=t.g-i.g,e.b=t.b-i.b,e.a=t.a-i.a,e}},{key:"multiply",value:function(e,t,i){return e.r=t.r*i.r,e.g=t.g*i.g,e.b=t.b*i.b,e.a=t.a*i.a,e}},{key:"divide",value:function(e,t,i){return e.r=t.r/i.r,e.g=t.g/i.g,e.b=t.b/i.b,e.a=t.a/i.a,e}},{key:"scale",value:function(e,t,i){return e.r=t.r*i,e.g=t.g*i,e.b=t.b*i,e.a=t.a*i,e}},{key:"lerp",value:function(e,t,i,n){var r=t.r,a=t.g,o=t.b,s=t.a;return r+=(i.r-r)*n,a+=(i.g-a)*n,o+=(i.b-o)*n,s+=(i.a-s)*n,e._val=Math.floor((s<<24>>>0)+(o<<16)+(a<<8)+r),e}},{key:"toArray",value:function(e,i){var n=arguments.length>2&&void 0!==arguments[2]?arguments[2]:0,r=i instanceof t||i.a>1?1/255:1;return e[n+0]=i.r*r,e[n+1]=i.g*r,e[n+2]=i.b*r,e[n+3]=i.a*r,e}},{key:"fromArray",value:function(e,t){var i=arguments.length>2&&void 0!==arguments[2]?arguments[2]:0;return t.r=255*e[i+0],t.g=255*e[i+1],t.b=255*e[i+2],t.a=255*e[i+3],t}},{key:"strictEquals",value:function(e,t){return e.r===t.r&&e.g===t.g&&e.b===t.b&&e.a===t.a}},{key:"equals",value:function(e,t){var i=arguments.length>2&&void 0!==arguments[2]?arguments[2]:ui;return Math.abs(e.r-t.r)<=i*Math.max(1,Math.abs(e.r),Math.abs(t.r))&&Math.abs(e.g-t.g)<=i*Math.max(1,Math.abs(e.g),Math.abs(t.g))&&Math.abs(e.b-t.b)<=i*Math.max(1,Math.abs(e.b),Math.abs(t.b))&&Math.abs(e.a-t.a)<=i*Math.max(1,Math.abs(e.a),Math.abs(t.a))}},{key:"hex",value:function(e){return(255*e.r<<24|255*e.g<<16|255*e.b<<8|255*e.a)>>>0}}]),J(t,[{key:"clone",value:function(){var e=new t;return e._val=this._val,e}},{key:"equals",value:function(e){return e&&this._val===e._val}},{key:"lerp",value:function(e,t){var i=this.r,n=this.g,r=this.b,a=this.a;return i+=(e.r-i)*t,n+=(e.g-n)*t,r+=(e.b-r)*t,a+=(e.a-a)*t,this._val=Math.floor((a<<24>>>0)+(r<<16)+(n<<8)+i),this}},{key:"toString",value:function(){return"rgba("+this.r.toFixed()+", "+this.g.toFixed()+", "+this.b.toFixed()+", "+this.a.toFixed()+")"}},{key:"toCSS",value:function(e){return"rgba"===e?"rgba("+(0|this.r)+","+(0|this.g)+","+(0|this.b)+","+(this.a*(1/255)).toFixed(2)+")":"rgb"===e?"rgb("+(0|this.r)+","+(0|this.g)+","+(0|this.b)+")":"#"+this.toHEX(e)}},{key:"fromHEX",value:function(e){e=0===e.indexOf("#")?e.substring(1):e;var t=parseInt(e.substr(0,2),16)||0,i=parseInt(e.substr(2,2),16)||0,n=parseInt(e.substr(4,2),16)||0,r=parseInt(e.substr(6,2),16)||255;return this._val=(r<<24>>>0)+(n<<16)+(i<<8)+t,this}},{key:"toHEX",value:function(e){var t=[(0|this.r).toString(16),(0|this.g).toString(16),(0|this.b).toString(16)],i=-1;if("#rrggbb"===e)for(i=0;i<t.length;++i)1===t[i].length&&(t[i]="0"+t[i]);else if("#rrggbbaa"===e)for(t.push((0|this.a).toString(16)),i=0;i<t.length;++i)1===t[i].length&&(t[i]="0"+t[i]);return t.join("")}},{key:"toRGBValue",value:function(){return 16777215&this._val}},{key:"fromHSV",value:function(e,t,i){var n=0,r=0,a=0;if(0===t)n=r=a=i;else if(0===i)n=r=a=0;else{1===e&&(e=0),e*=6,t=t,i=i;var o=Math.floor(e),s=e-o,l=i*(1-t),u=i*(1-t*s),c=i*(1-t*(1-s));switch(o){case 0:n=i,r=c,a=l;break;case 1:n=u,r=i,a=l;break;case 2:n=l,r=i,a=c;break;case 3:n=l,r=u,a=i;break;case 4:n=c,r=l,a=i;break;case 5:n=i,r=l,a=u}}return n*=255,r*=255,a*=255,this._val=(this.a<<24>>>0)+(a<<16)+(r<<8)+n,this}},{key:"toHSV",value:function(){var e=this.r*(1/255),t=this.g*(1/255),i=this.b*(1/255),n={h:0,s:0,v:0},r=Math.max(e,t,i),a=Math.min(e,t,i),o=0;return n.v=r,n.s=r?(r-a)/r:0,n.s?(o=r-a,n.h=e===r?(t-i)/o:t===r?2+(i-e)/o:4+(e-t)/o,n.h/=6,n.h<0&&(n.h+=1)):n.h=0,n}},{key:"set",value:function(e,t,i,n){return"object"===K(e)?null!=e._val?this._val=e._val:(t=e.g||0,i=e.b||0,n="number"==typeof e.a?e.a:255,e=e.r||0,this._val=(n<<24>>>0)+(i<<16)+(t<<8)+e):(e=e||0,t=t||0,i=i||0,n="number"==typeof n?n:255,this._val=(n<<24>>>0)+(i<<16)+(t<<8)+e),this}},{key:"multiply",value:function(e){var t=(255&this._val)*e.r>>8,i=(65280&this._val)*e.g>>8,n=(16711680&this._val)*e.b>>8,r=((4278190080&this._val)>>>8)*e.a;return this._val=4278190080&r|16711680&n|65280&i|255&t,this}},{key:"_set_r_unsafe",value:function(e){return this._val=(4294967040&this._val|e)>>>0,this}},{key:"_set_g_unsafe",value:function(e){return this._val=(4294902015&this._val|e<<8)>>>0,this}},{key:"_set_b_unsafe",value:function(e){return this._val=(4278255615&this._val|e<<16)>>>0,this}},{key:"_set_a_unsafe",value:function(e){return this._val=(16777215&this._val|e<<24>>>0)>>>0,this}}]),t}();function on(e,t,i,n){return new an(e,t,i,n)}an.WHITE=Object.freeze(new an(255,255,255,255)),an.GRAY=Object.freeze(new an(127,127,127,255)),an.BLACK=Object.freeze(new an(0,0,0,255)),an.TRANSPARENT=Object.freeze(new an(0,0,0,0)),an.RED=Object.freeze(new an(255,0,0,255)),an.GREEN=Object.freeze(new an(0,255,0,255)),an.BLUE=Object.freeze(new an(0,0,255,255)),an.CYAN=Object.freeze(new an(0,255,255,255)),an.MAGENTA=Object.freeze(new an(255,0,255,255)),an.YELLOW=Object.freeze(new an(255,255,0,255)),ni.fastDefine("cc.Color",an,{r:0,g:0,b:0,a:255}),cc.Color=an,cc.color=on;var sn,ln,un,cn=10;var hn=0,pn=new Map;sn=function(e,t,i,n,r,a){var o=pn.get(a);o&&o.logTimes>o.count&&(r("'%s' is deprecated, please use '%s' instead.","".concat(e,".").concat(t),"".concat(i,".").concat(n)),o.count++)},exports.replaceProperty=function(e,t,i){null!=e&&i.forEach((function(i){var n=hn++;pn.set(n,{id:n,count:0,logTimes:void 0!==i.logTimes?i.logTimes:cn});var r=null!=i.target?i.target:e,a=null!=i.newName?i.newName:i.name,o=null!=i.targetName?i.targetName:t,s=r==e;if(null!=i.customFunction)e[i.name]=function(){var e;return sn(t,i.name,o,a,c,n),(e=i.customFunction).call.apply(e,[this].concat(Array.prototype.slice.call(arguments)))};else if(null!=i.customSetter||null!=i.customGetter){var l=null!=i.customSetter,u=null!=i.customGetter;l&&u?Object.defineProperty(e,i.name,{get:function(){return sn(t,i.name,o,a,c,n),i.customGetter.call(this)},set:function(e){sn(t,i.name,o,a,c,n),i.customSetter.call(this,e)}}):l?Object.defineProperty(e,i.name,{set:function(e){sn(t,i.name,o,a,c,n),i.customSetter.call(this,e)}}):u&&Object.defineProperty(e,i.name,{get:function(){return sn(t,i.name,o,a,c,n),i.customGetter.call(this)}})}else Object.defineProperty(e,i.name,{get:function(){return sn(t,i.name,o,a,c,n),s?this[a]:r[a]},set:function(e){sn(t,i.name,o,a,c,n),s?this[a]=e:r[a]=e}})}))},un=function(e,t,i,n,r){var a=pn.get(n),o=void 0===r?"":"("+r+")";a&&a.logTimes>a.count&&(i("'%s' has been removed. "+o,"".concat(e,".").concat(t)),a.count++)},exports.removeProperty=function(e,t,i){null!=e&&i.forEach((function(i){var n=hn++;pn.set(n,{id:n,count:0,logTimes:void 0!==i.logTimes?i.logTimes:cn}),Object.defineProperty(e,i.name,{get:function(){return un(t,i.name,h,n,i.suggest)},set:function(){un(t,i.name,h,n,i.suggest)}})}))},ln=function(e,t,i,n,r){var a=pn.get(n),o=void 0===r?"":"("+r+")";a&&a.logTimes>a.count&&(i("'%s' is deprecated. "+o,"".concat(e,".").concat(t)),a.count++)},exports.markAsWarning=function(e,t,i){if(null!=e){var n=function(e,t,i,n,r,a){if(e.get){var o=e.get();e.get=function(){return ln(t,i,n,r,a),o.call(this)}}if(e.set){var s=Object.create(e.set);e.set=function(e){ln(t,i,n,r,a),s.call(this,e)}}};i.forEach((function(i){var r=i.name,a=Object.getOwnPropertyDescriptor(e,r);if(a){var o=hn++;if(pn.set(o,{id:o,count:0,logTimes:void 0!==i.logTimes?i.logTimes:cn}),null!=a.value)if("function"==typeof a.value){var s=a.value;e[r]=function(){return ln(t,r,c,o,i.suggest),s.call.apply(s,[this].concat(Array.prototype.slice.call(arguments)))}}else n(a,t,r,c,o,i.suggest);else n(a,t,r,c,o,i.suggest)}}))}},exports.replaceProperty(ki,"Vec2",[{name:"sub",newName:"subtract",target:ki,targetName:"Vec2"},{name:"mul",newName:"multiply",target:ki,targetName:"Vec2"},{name:"div",newName:"divide",target:ki,targetName:"Vec2"},{name:"dist",newName:"distance",target:ki,targetName:"Vec2"},{name:"sqrDist",newName:"squaredDistance",target:ki,targetName:"Vec2"},{name:"mag",newName:"len",target:ki,targetName:"Vec2"},{name:"sqrMag",newName:"lengthSqr",target:ki,targetName:"Vec2"},{name:"scale",newName:"multiplyScalar",target:ki,targetName:"Vec2"},{name:"exactEquals",newName:"strictEquals",target:ki,targetName:"Vec2"}]),exports.replaceProperty(ki.prototype,"Vec2",[{name:"mag",newName:"length",target:ki.prototype,targetName:"Vec2"},{name:"magSqr",newName:"lengthSqr",target:ki.prototype,targetName:"Vec2"},{name:"scale",newName:"multiplyScalar",target:ki.prototype,targetName:"Vec2"},{name:"exactEquals",newName:"strictEquals",target:ki.prototype,targetName:"Vec2"}]),exports.removeProperty(ki.prototype,"vmath",[{name:"divide"}]),exports.replaceProperty(Ii,"Vec3",[{name:"sub",newName:"subtract",target:Ii,targetName:"Vec3"},{name:"mul",newName:"multiply",target:Ii,targetName:"Vec3"},{name:"div",newName:"divide",target:Ii,targetName:"Vec3"},{name:"dist",newName:"distance",target:Ii,targetName:"Vec3"},{name:"sqrDist",newName:"squaredDistance",target:Ii,targetName:"Vec3"},{name:"mag",newName:"len",target:Ii,targetName:"Vec3"},{name:"sqrMag",newName:"lengthSqr",target:Ii,targetName:"Vec3"},{name:"scale",newName:"multiplyScalar",target:Ii,targetName:"Vec3"},{name:"exactEquals",newName:"strictEquals",target:Ii,targetName:"Vec3"}]),exports.replaceProperty(Ii.prototype,"Vec3",[{name:"mag",newName:"length",target:Ii.prototype,targetName:"Vec3"},{name:"magSqr",newName:"lengthSqr",target:Ii.prototype,targetName:"Vec3"},{name:"scale",newName:"multiplyScalar",target:Ii.prototype,targetName:"Vec3"},{name:"exactEquals",newName:"strictEquals",target:Ii.prototype,targetName:"Vec3"}]),exports.removeProperty(Ii.prototype,"vmath",[{name:"divide"}]),exports.replaceProperty(Ni,"Vec4",[{name:"sub",newName:"subtract",target:Ni,targetName:"Vec4"},{name:"mul",newName:"multiply",target:Ni,targetName:"Vec4"},{name:"div",newName:"divide",target:Ni,targetName:"Vec4"},{name:"dist",newName:"distance",target:Ni,targetName:"Vec4"},{name:"sqrDist",newName:"squaredDistance",target:Ni,targetName:"Vec4"},{name:"mag",newName:"len",target:Ni,targetName:"Vec4"},{name:"sqrMag",newName:"lengthSqr",target:Ni,targetName:"Vec4"},{name:"scale",newName:"multiplyScalar",target:Ni,targetName:"Vec4"},{name:"exactEquals",newName:"strictEquals",target:Ni,targetName:"Vec4"}]),exports.replaceProperty(Ni.prototype,"Vec4",[{name:"mag",newName:"length",target:Ni.prototype,targetName:"Vec4"},{name:"magSqr",newName:"lengthSqr",target:Ni.prototype,targetName:"Vec4"},{name:"scale",newName:"multiplyScalar",target:Ni.prototype,targetName:"Vec4"},{name:"exactEquals",newName:"strictEquals",target:Ni.prototype,targetName:"Vec4"}]),exports.removeProperty(Ni.prototype,"vmath",[{name:"divide"}]),exports.replaceProperty(Xi,"Quat",[{name:"mag",newName:"len",target:Xi,targetName:"Quat"},{name:"mul",newName:"multiply",target:Xi,targetName:"Quat"},{name:"sqrMag",newName:"lengthSqr",target:Xi,targetName:"Quat"},{name:"scale",newName:"multiplyScalar",target:Xi,targetName:"Quat"},{name:"exactEquals",newName:"strictEquals",target:Xi,targetName:"Quat"}]),exports.replaceProperty(Xi.prototype,"Quat",[{name:"scale",newName:"multiplyScalar",target:Xi.prototype,targetName:"Quat"},{name:"exactEquals",newName:"strictEquals",target:Xi.prototype,targetName:"Quat"}]),exports.replaceProperty(an,"Color",[{name:"sub",newName:"subtract",target:an,targetName:"Color"},{name:"mul",newName:"multiply",target:an,targetName:"Color"},{name:"div",newName:"divide",target:an,targetName:"Color"},{name:"exactEquals",newName:"strictEquals",target:an,targetName:"Color"},{name:"fromHex",newName:"fromHEX",customFunction:function(){for(var e=arguments.length,t=new Array(e),i=0;i<e;i++)t[i]=arguments[i];var n=t[1].toString(16);return cc.Color.fromHEX(t[0],n)}}]),exports.replaceProperty(Bi,"Mat3",[{name:"sub",newName:"subtract",target:Bi,targetName:"Mat3"},{name:"mul",newName:"multiply",target:Bi,targetName:"Mat3"},{name:"exactEquals",newName:"strictEquals",target:Bi,targetName:"Mat3"}]),exports.replaceProperty(Bi.prototype,"Mat3",[{name:"sub",newName:"subtract",target:Bi.prototype,targetName:"Mat3"},{name:"mul",newName:"multiply",target:Bi.prototype,targetName:"Mat3"},{name:"mulScalar",newName:"multiplyScalar",target:Bi.prototype,targetName:"Mat3"},{name:"exactEquals",newName:"strictEquals",target:Bi.prototype,targetName:"Mat3"}]),exports.replaceProperty(Ki,"Mat4",[{name:"sub",newName:"subtract",target:Ki,targetName:"Mat4"},{name:"mul",newName:"multiply",target:Ki,targetName:"Mat4"},{name:"exactEquals",newName:"strictEquals",target:Ki,targetName:"Mat4"}]),exports.replaceProperty(Ki.prototype,"Mat4",[{name:"sub",newName:"subtract",target:Ki.prototype,targetName:"Mat4"},{name:"mul",newName:"multiply",target:Ki.prototype,targetName:"Mat4"},{name:"mulScalar",newName:"multiplyScalar",target:Ki.prototype,targetName:"Mat4"},{name:"exactEquals",newName:"strictEquals",target:Ki.prototype,targetName:"Mat4"}]);var _n=Object.freeze({__proto__:null,bits:Y,Vec2:ki,v2:Mi,Vec3:Ii,v3:Di,Vec4:Ni,v4:zi,Quat:Xi,quat:Yi,Mat3:Bi,Mat4:Ki,mat4:Ji,AffineTransform:$i,Size:en,size:tn,Rect:nn,rect:rn,Color:an,color:on,EPSILON:ui,equals:ci,approx:hi,clamp:pi,clamp01:_i,lerp:fi,toRadian:di,toDegree:mi,random:vi,randomRange:yi,randomRangeInt:gi,pseudoRandom:xi,pseudoRandomRange:bi,pseudoRandomRangeInt:Ti,nextPow2:Si,repeat:Ei,pingPong:wi,inverseLerp:Ci,absMaxComponent:Ai,absMax:Oi}),fn=new Ii,dn=new Ii,mn=new Ii,vn=new Ii,yn=new Ii,gn=new Ii,xn=new Array(3),bn=new Array(3);function Tn(e,t){return Ii.dot(t.n,e)-t.d}function Sn(e,t,i){return Ii.copy(e,t),Ii.subtract(yn,i.center,i.halfExtents),Ii.add(gn,i.center,i.halfExtents),e.x=e.x<yn.x?yn.x:e.x,e.y=e.y<yn.x?yn.y:e.y,e.z=e.z<yn.x?yn.z:e.z,e.x=e.x>gn.x?gn.x:e.x,e.y=e.y>gn.x?gn.y:e.y,e.z=e.z>gn.x?gn.z:e.z,e}function En(e,t,i){Ii.set(fn,i.orientation.m00,i.orientation.m01,i.orientation.m02),Ii.set(dn,i.orientation.m03,i.orientation.m04,i.orientation.m05),Ii.set(mn,i.orientation.m06,i.orientation.m07,i.orientation.m08),xn[0]=fn,xn[1]=dn,xn[2]=mn,bn[0]=i.halfExtents.x,bn[1]=i.halfExtents.y,bn[2]=i.halfExtents.z,Ii.subtract(vn,t,i.center),Ii.set(e,i.center.x,i.center.y,i.center.z);for(var n=0;n<3;n++){var r=Ii.dot(vn,xn[n]);r>bn[n]&&(r=bn[n]),r<-bn[n]&&(r=-bn[n]),e.x+=r*xn[n].x,e.y+=r*xn[n].y,e.z+=r*xn[n].z}return e}var wn=Object.freeze({__proto__:null,point_plane:Tn,pt_point_plane:function(e,t,i){var n=Tn(t,i);return Ii.subtract(e,t,Ii.multiplyScalar(e,i.n,n))},pt_point_aabb:Sn,pt_point_obb:En,pt_point_line:function(e,t,i,n){Ii.subtract(fn,i,n);var r=fn,a=Ii.lengthSqr(r);if(0==a)Ii.copy(e,i);else{Ii.subtract(fn,t,i);var o=Ii.dot(fn,r)/a;o<0?Ii.copy(e,i):o>1?Ii.copy(e,n):Ii.scaleAndAdd(e,i,r,o)}}}),Cn=function(){function e(){var t=arguments.length>0&&void 0!==arguments[0]?arguments[0]:0,i=arguments.length>1&&void 0!==arguments[1]?arguments[1]:0,n=arguments.length>2&&void 0!==arguments[2]?arguments[2]:0,r=arguments.length>3&&void 0!==arguments[3]?arguments[3]:0,a=arguments.length>4&&void 0!==arguments[4]?arguments[4]:0,o=arguments.length>5&&void 0!==arguments[5]?arguments[5]:-1;Z(this,e),this.o=void 0,this.d=void 0,this._type=void 0,this._type=V.SHAPE_RAY,this.o=new Ii(t,i,n),this.d=new Ii(r,a,o)}return J(e,[{key:"type",get:function(){return this._type}}],[{key:"create",value:function(){var t=arguments.length>0&&void 0!==arguments[0]?arguments[0]:0,i=arguments.length>1&&void 0!==arguments[1]?arguments[1]:0,n=arguments.length>2&&void 0!==arguments[2]?arguments[2]:0,r=arguments.length>3&&void 0!==arguments[3]?arguments[3]:0,a=arguments.length>4&&void 0!==arguments[4]?arguments[4]:0,o=arguments.length>5&&void 0!==arguments[5]?arguments[5]:1;return new e(t,i,n,r,a,o)}},{key:"clone",value:function(t){return new e(t.o.x,t.o.y,t.o.z,t.d.x,t.d.y,t.d.z)}},{key:"copy",value:function(e,t){return Ii.copy(e.o,t.o),Ii.copy(e.d,t.d),e}},{key:"fromPoints",value:function(e,t,i){return Ii.copy(e.o,t),Ii.normalize(e.d,Ii.subtract(e.d,i,t)),e}},{key:"set",value:function(e,t,i,n,r,a,o){return e.o.x=t,e.o.y=i,e.o.z=n,e.d.x=r,e.d.y=a,e.d.z=o,e}}]),J(e,[{key:"computeHit",value:function(e,t){Ii.normalize(e,this.d),Ii.scaleAndAdd(e,this.o,e,t)}}]),e}(),An=new Ii;function On(e){return Math.max(Math.max(e.x,e.y),e.z)}var kn,Rn,Fn=function(){function e(){var t=arguments.length>0&&void 0!==arguments[0]?arguments[0]:0,i=arguments.length>1&&void 0!==arguments[1]?arguments[1]:0,n=arguments.length>2&&void 0!==arguments[2]?arguments[2]:0,r=arguments.length>3&&void 0!==arguments[3]?arguments[3]:1;Z(this,e),this.center=void 0,this.radius=void 0,this._type=void 0,this._type=V.SHAPE_SPHERE,this.center=new Ii(t,i,n),this.radius=r}return J(e,[{key:"type",get:function(){return this._type}}],[{key:"create",value:function(t,i,n,r){return new e(t,i,n,r)}},{key:"clone",value:function(t){return new e(t.center.x,t.center.y,t.center.z,t.radius)}},{key:"copy",value:function(e,t){return Ii.copy(e.center,t.center),e.radius=t.radius,e}},{key:"fromPoints",value:function(e,t,i){return Ii.multiplyScalar(e.center,Ii.add(An,t,i),.5),e.radius=.5*Ii.subtract(An,i,t).length(),e}},{key:"set",value:function(e,t,i,n,r){return e.center.x=t,e.center.y=i,e.center.z=n,e.radius=r,e}}]),J(e,[{key:"clone",value:function(){return e.clone(this)}},{key:"copy",value:function(t){return e.copy(this,t)}},{key:"getBoundary",value:function(e,t){Ii.set(e,this.center.x-this.radius,this.center.y-this.radius,this.center.z-this.radius),Ii.set(t,this.center.x+this.radius,this.center.y+this.radius,this.center.z+this.radius)}},{key:"transform",value:function(e,t,i,n,r){Ii.transformMat4(r.center,this.center,e),r.radius=this.radius*On(n)}},{key:"translateAndRotate",value:function(e,t,i){Ii.transformMat4(i.center,this.center,e)}},{key:"setScale",value:function(e,t){t.radius=this.radius*On(e)}}]),e}(),Mn=function(){function e(){var t=arguments.length>0&&void 0!==arguments[0]?arguments[0]:0,i=arguments.length>1&&void 0!==arguments[1]?arguments[1]:0,n=arguments.length>2&&void 0!==arguments[2]?arguments[2]:0,r=arguments.length>3&&void 0!==arguments[3]?arguments[3]:1,a=arguments.length>4&&void 0!==arguments[4]?arguments[4]:0,o=arguments.length>5&&void 0!==arguments[5]?arguments[5]:0,s=arguments.length>6&&void 0!==arguments[6]?arguments[6]:0,l=arguments.length>7&&void 0!==arguments[7]?arguments[7]:1,u=arguments.length>8&&void 0!==arguments[8]?arguments[8]:0;Z(this,e),this.a=void 0,this.b=void 0,this.c=void 0,this._type=void 0,this._type=V.SHAPE_TRIANGLE,this.a=new Ii(t,i,n),this.b=new Ii(r,a,o),this.c=new Ii(s,l,u)}return J(e,[{key:"type",get:function(){return this._type}}],[{key:"create",value:function(){var t=arguments.length>0&&void 0!==arguments[0]?arguments[0]:1,i=arguments.length>1&&void 0!==arguments[1]?arguments[1]:0,n=arguments.length>2&&void 0!==arguments[2]?arguments[2]:0,r=arguments.length>3&&void 0!==arguments[3]?arguments[3]:0,a=arguments.length>4&&void 0!==arguments[4]?arguments[4]:0,o=arguments.length>5&&void 0!==arguments[5]?arguments[5]:0,s=arguments.length>6&&void 0!==arguments[6]?arguments[6]:0,l=arguments.length>7&&void 0!==arguments[7]?arguments[7]:0,u=arguments.length>8&&void 0!==arguments[8]?arguments[8]:1;return new e(t,i,n,r,a,o,s,l,u)}},{key:"clone",value:function(t){return new e(t.a.x,t.a.y,t.a.z,t.b.x,t.b.y,t.b.z,t.c.x,t.c.y,t.c.z)}},{key:"copy",value:function(e,t){return Ii.copy(e.a,t.a),Ii.copy(e.b,t.b),Ii.copy(e.c,t.c),e}},{key:"fromPoints",value:function(e,t,i,n){return Ii.copy(e.a,t),Ii.copy(e.b,i),Ii.copy(e.c,n),e}},{key:"set",value:function(e,t,i,n,r,a,o,s,l,u){return e.a.x=t,e.a.y=i,e.a.z=n,e.b.x=r,e.b.y=a,e.b.z=o,e.c.x=s,e.c.y=l,e.c.z=u,e}}]),e}();(kn=exports.GFXObjectType||(exports.GFXObjectType={}))[kn.UNKNOWN=0]="UNKNOWN",kn[kn.BUFFER=1]="BUFFER",kn[kn.TEXTURE=2]="TEXTURE",kn[kn.TEXTURE_VIEW=3]="TEXTURE_VIEW",kn[kn.RENDER_PASS=4]="RENDER_PASS",kn[kn.FRAMEBUFFER=5]="FRAMEBUFFER",kn[kn.SAMPLER=6]="SAMPLER",kn[kn.SHADER=7]="SHADER",kn[kn.PIPELINE_LAYOUT=8]="PIPELINE_LAYOUT",kn[kn.PIPELINE_STATE=9]="PIPELINE_STATE",kn[kn.BINDING_LAYOUT=10]="BINDING_LAYOUT",kn[kn.INPUT_ASSEMBLER=11]="INPUT_ASSEMBLER",kn[kn.COMMAND_ALLOCATOR=12]="COMMAND_ALLOCATOR",kn[kn.COMMAND_BUFFER=13]="COMMAND_BUFFER",kn[kn.QUEUE=14]="QUEUE",kn[kn.WINDOW=15]="WINDOW",(Rn=exports.GFXStatus||(exports.GFXStatus={}))[Rn.UNREADY=0]="UNREADY",Rn[Rn.FAILED=1]="FAILED",Rn[Rn.SUCCESS=2]="SUCCESS";var In,Pn,Ln,Dn,Nn,zn,Bn,Gn,Un,Xn,Vn,Hn,Wn,jn,qn,Yn,Kn,Zn,Qn,Jn,$n,er,tr,ir,nr,rr,ar,or,sr,lr,ur,cr,hr,pr,_r=function(){function e(t){Z(this,e),this._gfxType=exports.GFXObjectType.UNKNOWN,this._status=exports.GFXStatus.UNREADY,this._gfxType=t}return J(e,[{key:"gfxType",get:function(){return this._gfxType}},{key:"status",get:function(){return this._status}}]),e}();(In=exports.GFXAttributeName||(exports.GFXAttributeName={})).ATTR_POSITION="a_position",In.ATTR_NORMAL="a_normal",In.ATTR_TANGENT="a_tangent",In.ATTR_BITANGENT="a_bitangent",In.ATTR_WEIGHTS="a_weights",In.ATTR_JOINTS="a_joints",In.ATTR_COLOR="a_color",In.ATTR_COLOR1="a_color1",In.ATTR_COLOR2="a_color2",In.ATTR_TEX_COORD="a_texCoord",In.ATTR_TEX_COORD1="a_texCoord1",In.ATTR_TEX_COORD2="a_texCoord2",In.ATTR_TEX_COORD3="a_texCoord3",In.ATTR_TEX_COORD4="a_texCoord4",In.ATTR_TEX_COORD5="a_texCoord5",In.ATTR_TEX_COORD6="a_texCoord6",In.ATTR_TEX_COORD7="a_texCoord7",In.ATTR_TEX_COORD8="a_texCoord8",In.ATTR_BATCH_ID="a_batch_id",In.ATTR_BATCH_UV="a_batch_uv",(Pn=exports.GFXType||(exports.GFXType={}))[Pn.UNKNOWN=0]="UNKNOWN",Pn[Pn.BOOL=1]="BOOL",Pn[Pn.BOOL2=2]="BOOL2",Pn[Pn.BOOL3=3]="BOOL3",Pn[Pn.BOOL4=4]="BOOL4",Pn[Pn.INT=5]="INT",Pn[Pn.INT2=6]="INT2",Pn[Pn.INT3=7]="INT3",Pn[Pn.INT4=8]="INT4",Pn[Pn.UINT=9]="UINT",Pn[Pn.UINT2=10]="UINT2",Pn[Pn.UINT3=11]="UINT3",Pn[Pn.UINT4=12]="UINT4",Pn[Pn.FLOAT=13]="FLOAT",Pn[Pn.FLOAT2=14]="FLOAT2",Pn[Pn.FLOAT3=15]="FLOAT3",Pn[Pn.FLOAT4=16]="FLOAT4",Pn[Pn.MAT2=17]="MAT2",Pn[Pn.MAT2X3=18]="MAT2X3",Pn[Pn.MAT2X4=19]="MAT2X4",Pn[Pn.MAT3X2=20]="MAT3X2",Pn[Pn.MAT3=21]="MAT3",Pn[Pn.MAT3X4=22]="MAT3X4",Pn[Pn.MAT4X2=23]="MAT4X2",Pn[Pn.MAT4X3=24]="MAT4X3",Pn[Pn.MAT4=25]="MAT4",Pn[Pn.SAMPLER1D=26]="SAMPLER1D",Pn[Pn.SAMPLER1D_ARRAY=27]="SAMPLER1D_ARRAY",Pn[Pn.SAMPLER2D=28]="SAMPLER2D",Pn[Pn.SAMPLER2D_ARRAY=29]="SAMPLER2D_ARRAY",Pn[Pn.SAMPLER3D=30]="SAMPLER3D",Pn[Pn.SAMPLER_CUBE=31]="SAMPLER_CUBE",Pn[Pn.COUNT=32]="COUNT",(Ln=exports.GFXFormat||(exports.GFXFormat={}))[Ln.UNKNOWN=0]="UNKNOWN",Ln[Ln.A8=1]="A8",Ln[Ln.L8=2]="L8",Ln[Ln.LA8=3]="LA8",Ln[Ln.R8=4]="R8",Ln[Ln.R8SN=5]="R8SN",Ln[Ln.R8UI=6]="R8UI",Ln[Ln.R8I=7]="R8I",Ln[Ln.R16F=8]="R16F",Ln[Ln.R16UI=9]="R16UI",Ln[Ln.R16I=10]="R16I",Ln[Ln.R32F=11]="R32F",Ln[Ln.R32UI=12]="R32UI",Ln[Ln.R32I=13]="R32I",Ln[Ln.RG8=14]="RG8",Ln[Ln.RG8SN=15]="RG8SN",Ln[Ln.RG8UI=16]="RG8UI",Ln[Ln.RG8I=17]="RG8I",Ln[Ln.RG16F=18]="RG16F",Ln[Ln.RG16UI=19]="RG16UI",Ln[Ln.RG16I=20]="RG16I",Ln[Ln.RG32F=21]="RG32F",Ln[Ln.RG32UI=22]="RG32UI",Ln[Ln.RG32I=23]="RG32I",Ln[Ln.RGB8=24]="RGB8",Ln[Ln.SRGB8=25]="SRGB8",Ln[Ln.RGB8SN=26]="RGB8SN",Ln[Ln.RGB8UI=27]="RGB8UI",Ln[Ln.RGB8I=28]="RGB8I",Ln[Ln.RGB16F=29]="RGB16F",Ln[Ln.RGB16UI=30]="RGB16UI",Ln[Ln.RGB16I=31]="RGB16I",Ln[Ln.RGB32F=32]="RGB32F",Ln[Ln.RGB32UI=33]="RGB32UI",Ln[Ln.RGB32I=34]="RGB32I",Ln[Ln.RGBA8=35]="RGBA8",Ln[Ln.SRGB8_A8=36]="SRGB8_A8",Ln[Ln.RGBA8SN=37]="RGBA8SN",Ln[Ln.RGBA8UI=38]="RGBA8UI",Ln[Ln.RGBA8I=39]="RGBA8I",Ln[Ln.RGBA16F=40]="RGBA16F",Ln[Ln.RGBA16UI=41]="RGBA16UI",Ln[Ln.RGBA16I=42]="RGBA16I",Ln[Ln.RGBA32F=43]="RGBA32F",Ln[Ln.RGBA32UI=44]="RGBA32UI",Ln[Ln.RGBA32I=45]="RGBA32I",Ln[Ln.R5G6B5=46]="R5G6B5",Ln[Ln.R11G11B10F=47]="R11G11B10F",Ln[Ln.RGB5A1=48]="RGB5A1",Ln[Ln.RGBA4=49]="RGBA4",Ln[Ln.RGB10A2=50]="RGB10A2",Ln[Ln.RGB10A2UI=51]="RGB10A2UI",Ln[Ln.RGB9E5=52]="RGB9E5",Ln[Ln.D16=53]="D16",Ln[Ln.D16S8=54]="D16S8",Ln[Ln.D24=55]="D24",Ln[Ln.D24S8=56]="D24S8",Ln[Ln.D32F=57]="D32F",Ln[Ln.D32F_S8=58]="D32F_S8",Ln[Ln.BC1=59]="BC1",Ln[Ln.BC1_ALPHA=60]="BC1_ALPHA",Ln[Ln.BC1_SRGB=61]="BC1_SRGB",Ln[Ln.BC1_SRGB_ALPHA=62]="BC1_SRGB_ALPHA",Ln[Ln.BC2=63]="BC2",Ln[Ln.BC2_SRGB=64]="BC2_SRGB",Ln[Ln.BC3=65]="BC3",Ln[Ln.BC3_SRGB=66]="BC3_SRGB",Ln[Ln.BC4=67]="BC4",Ln[Ln.BC4_SNORM=68]="BC4_SNORM",Ln[Ln.BC5=69]="BC5",Ln[Ln.BC5_SNORM=70]="BC5_SNORM",Ln[Ln.BC6H_UF16=71]="BC6H_UF16",Ln[Ln.BC6H_SF16=72]="BC6H_SF16",Ln[Ln.BC7=73]="BC7",Ln[Ln.BC7_SRGB=74]="BC7_SRGB",Ln[Ln.ETC_RGB8=75]="ETC_RGB8",Ln[Ln.ETC2_RGB8=76]="ETC2_RGB8",Ln[Ln.ETC2_SRGB8=77]="ETC2_SRGB8",Ln[Ln.ETC2_RGB8_A1=78]="ETC2_RGB8_A1",Ln[Ln.ETC2_SRGB8_A1=79]="ETC2_SRGB8_A1",Ln[Ln.ETC2_RGBA8=80]="ETC2_RGBA8",Ln[Ln.ETC2_SRGB8_A8=81]="ETC2_SRGB8_A8",Ln[Ln.EAC_R11=82]="EAC_R11",Ln[Ln.EAC_R11SN=83]="EAC_R11SN",Ln[Ln.EAC_RG11=84]="EAC_RG11",Ln[Ln.EAC_RG11SN=85]="EAC_RG11SN",Ln[Ln.PVRTC_RGB2=86]="PVRTC_RGB2",Ln[Ln.PVRTC_RGBA2=87]="PVRTC_RGBA2",Ln[Ln.PVRTC_RGB4=88]="PVRTC_RGB4",Ln[Ln.PVRTC_RGBA4=89]="PVRTC_RGBA4",Ln[Ln.PVRTC2_2BPP=90]="PVRTC2_2BPP",Ln[Ln.PVRTC2_4BPP=91]="PVRTC2_4BPP",(Dn=exports.GFXBufferUsageBit||(exports.GFXBufferUsageBit={}))[Dn.NONE=0]="NONE",Dn[Dn.TRANSFER_SRC=1]="TRANSFER_SRC",Dn[Dn.TRANSFER_DST=2]="TRANSFER_DST",Dn[Dn.INDEX=4]="INDEX",Dn[Dn.VERTEX=8]="VERTEX",Dn[Dn.UNIFORM=16]="UNIFORM",Dn[Dn.STORAGE=32]="STORAGE",Dn[Dn.INDIRECT=64]="INDIRECT",(Nn=exports.GFXMemoryUsageBit||(exports.GFXMemoryUsageBit={}))[Nn.NONE=0]="NONE",Nn[Nn.DEVICE=1]="DEVICE",Nn[Nn.HOST=2]="HOST",(zn=exports.GFXBufferFlagBit||(exports.GFXBufferFlagBit={}))[zn.NONE=0]="NONE",zn[zn.BAKUP_BUFFER=4]="BAKUP_BUFFER",(Bn=exports.GFXBufferAccessBit||(exports.GFXBufferAccessBit={}))[Bn.NONE=0]="NONE",Bn[Bn.READ=1]="READ",Bn[Bn.WRITE=2]="WRITE",(Gn=exports.GFXPrimitiveMode||(exports.GFXPrimitiveMode={}))[Gn.POINT_LIST=0]="POINT_LIST",Gn[Gn.LINE_LIST=1]="LINE_LIST",Gn[Gn.LINE_STRIP=2]="LINE_STRIP",Gn[Gn.LINE_LOOP=3]="LINE_LOOP",Gn[Gn.LINE_LIST_ADJACENCY=4]="LINE_LIST_ADJACENCY",Gn[Gn.LINE_STRIP_ADJACENCY=5]="LINE_STRIP_ADJACENCY",Gn[Gn.ISO_LINE_LIST=6]="ISO_LINE_LIST",Gn[Gn.TRIANGLE_LIST=7]="TRIANGLE_LIST",Gn[Gn.TRIANGLE_STRIP=8]="TRIANGLE_STRIP",Gn[Gn.TRIANGLE_FAN=9]="TRIANGLE_FAN",Gn[Gn.TRIANGLE_LIST_ADJACENCY=10]="TRIANGLE_LIST_ADJACENCY",Gn[Gn.TRIANGLE_STRIP_ADJACENCY=11]="TRIANGLE_STRIP_ADJACENCY",Gn[Gn.TRIANGLE_PATCH_ADJACENCY=12]="TRIANGLE_PATCH_ADJACENCY",Gn[Gn.QUAD_PATCH_LIST=13]="QUAD_PATCH_LIST",(Un=exports.GFXPolygonMode||(exports.GFXPolygonMode={}))[Un.FILL=0]="FILL",Un[Un.POINT=1]="POINT",Un[Un.LINE=2]="LINE",(Xn=exports.GFXShadeModel||(exports.GFXShadeModel={}))[Xn.GOURAND=0]="GOURAND",Xn[Xn.FLAT=1]="FLAT",(Vn=exports.GFXCullMode||(exports.GFXCullMode={}))[Vn.NONE=0]="NONE",Vn[Vn.FRONT=1]="FRONT",Vn[Vn.BACK=2]="BACK",(Hn=exports.GFXComparisonFunc||(exports.GFXComparisonFunc={}))[Hn.NEVER=0]="NEVER",Hn[Hn.LESS=1]="LESS",Hn[Hn.EQUAL=2]="EQUAL",Hn[Hn.LESS_EQUAL=3]="LESS_EQUAL",Hn[Hn.GREATER=4]="GREATER",Hn[Hn.NOT_EQUAL=5]="NOT_EQUAL",Hn[Hn.GREATER_EQUAL=6]="GREATER_EQUAL",Hn[Hn.ALWAYS=7]="ALWAYS",(Wn=exports.GFXStencilOp||(exports.GFXStencilOp={}))[Wn.ZERO=0]="ZERO",Wn[Wn.KEEP=1]="KEEP",Wn[Wn.REPLACE=2]="REPLACE",Wn[Wn.INCR=3]="INCR",Wn[Wn.DECR=4]="DECR",Wn[Wn.INVERT=5]="INVERT",Wn[Wn.INCR_WRAP=6]="INCR_WRAP",Wn[Wn.DECR_WRAP=7]="DECR_WRAP",(jn=exports.GFXBlendOp||(exports.GFXBlendOp={}))[jn.ADD=0]="ADD",jn[jn.SUB=1]="SUB",jn[jn.REV_SUB=2]="REV_SUB",jn[jn.MIN=3]="MIN",jn[jn.MAX=4]="MAX",(qn=exports.GFXBlendFactor||(exports.GFXBlendFactor={}))[qn.ZERO=0]="ZERO",qn[qn.ONE=1]="ONE",qn[qn.SRC_ALPHA=2]="SRC_ALPHA",qn[qn.DST_ALPHA=3]="DST_ALPHA",qn[qn.ONE_MINUS_SRC_ALPHA=4]="ONE_MINUS_SRC_ALPHA",qn[qn.ONE_MINUS_DST_ALPHA=5]="ONE_MINUS_DST_ALPHA",qn[qn.SRC_COLOR=6]="SRC_COLOR",qn[qn.DST_COLOR=7]="DST_COLOR",qn[qn.ONE_MINUS_SRC_COLOR=8]="ONE_MINUS_SRC_COLOR",qn[qn.ONE_MINUS_DST_COLOR=9]="ONE_MINUS_DST_COLOR",qn[qn.SRC_ALPHA_SATURATE=10]="SRC_ALPHA_SATURATE",qn[qn.CONSTANT_COLOR=11]="CONSTANT_COLOR",qn[qn.ONE_MINUS_CONSTANT_COLOR=12]="ONE_MINUS_CONSTANT_COLOR",qn[qn.CONSTANT_ALPHA=13]="CONSTANT_ALPHA",qn[qn.ONE_MINUS_CONSTANT_ALPHA=14]="ONE_MINUS_CONSTANT_ALPHA",(Yn=exports.GFXColorMask||(exports.GFXColorMask={}))[Yn.NONE=0]="NONE",Yn[Yn.R=1]="R",Yn[Yn.G=2]="G",Yn[Yn.B=4]="B",Yn[Yn.A=8]="A",Yn[Yn.ALL=15]="ALL",(Kn=exports.GFXFilter||(exports.GFXFilter={}))[Kn.NONE=0]="NONE",Kn[Kn.POINT=1]="POINT",Kn[Kn.LINEAR=2]="LINEAR",Kn[Kn.ANISOTROPIC=3]="ANISOTROPIC",(Zn=exports.GFXAddress||(exports.GFXAddress={}))[Zn.WRAP=0]="WRAP",Zn[Zn.MIRROR=1]="MIRROR",Zn[Zn.CLAMP=2]="CLAMP",Zn[Zn.BORDER=3]="BORDER",(Qn=exports.GFXTextureType||(exports.GFXTextureType={}))[Qn.TEX1D=0]="TEX1D",Qn[Qn.TEX2D=1]="TEX2D",Qn[Qn.TEX3D=2]="TEX3D",(Jn=exports.GFXTextureUsageBit||(exports.GFXTextureUsageBit={}))[Jn.NONE=0]="NONE",Jn[Jn.TRANSFER_SRC=1]="TRANSFER_SRC",Jn[Jn.TRANSFER_DST=2]="TRANSFER_DST",Jn[Jn.SAMPLED=4]="SAMPLED",Jn[Jn.STORAGE=8]="STORAGE",Jn[Jn.COLOR_ATTACHMENT=16]="COLOR_ATTACHMENT",Jn[Jn.DEPTH_STENCIL_ATTACHMENT=32]="DEPTH_STENCIL_ATTACHMENT",Jn[Jn.TRANSIENT_ATTACHMENT=64]="TRANSIENT_ATTACHMENT",Jn[Jn.INPUT_ATTACHMENT=128]="INPUT_ATTACHMENT",($n=exports.GFXSampleCount||(exports.GFXSampleCount={}))[$n.X1=0]="X1",$n[$n.X2=1]="X2",$n[$n.X4=2]="X4",$n[$n.X8=3]="X8",$n[$n.X16=4]="X16",$n[$n.X32=5]="X32",$n[$n.X64=6]="X64",(er=exports.GFXTextureFlagBit||(exports.GFXTextureFlagBit={}))[er.NONE=0]="NONE",er[er.GEN_MIPMAP=1]="GEN_MIPMAP",er[er.CUBEMAP=2]="CUBEMAP",er[er.BAKUP_BUFFER=4]="BAKUP_BUFFER",(tr=exports.GFXTextureViewType||(exports.GFXTextureViewType={}))[tr.TV1D=0]="TV1D",tr[tr.TV2D=1]="TV2D",tr[tr.TV3D=2]="TV3D",tr[tr.CUBE=3]="CUBE",tr[tr.TV1D_ARRAY=4]="TV1D_ARRAY",tr[tr.TV2D_ARRAY=5]="TV2D_ARRAY",(ir=exports.GFXShaderType||(exports.GFXShaderType={}))[ir.VERTEX=0]="VERTEX",ir[ir.HULL=1]="HULL",ir[ir.DOMAIN=2]="DOMAIN",ir[ir.GEOMETRY=3]="GEOMETRY",ir[ir.FRAGMENT=4]="FRAGMENT",ir[ir.COMPUTE=5]="COMPUTE",ir[ir.COUNT=6]="COUNT",(nr=exports.GFXBindingType||(exports.GFXBindingType={}))[nr.UNKNOWN=0]="UNKNOWN",nr[nr.UNIFORM_BUFFER=1]="UNIFORM_BUFFER",nr[nr.SAMPLER=2]="SAMPLER",nr[nr.STORAGE_BUFFER=3]="STORAGE_BUFFER",(rr=exports.GFXCommandBufferType||(exports.GFXCommandBufferType={}))[rr.PRIMARY=0]="PRIMARY",rr[rr.SECONDARY=1]="SECONDARY",(ar=exports.GFXLoadOp||(exports.GFXLoadOp={}))[ar.LOAD=0]="LOAD",ar[ar.CLEAR=1]="CLEAR",ar[ar.DISCARD=2]="DISCARD",(or=exports.GFXStoreOp||(exports.GFXStoreOp={}))[or.STORE=0]="STORE",or[or.DISCARD=1]="DISCARD",(sr=exports.GFXTextureLayout||(exports.GFXTextureLayout={}))[sr.UNDEFINED=0]="UNDEFINED",sr[sr.GENERAL=1]="GENERAL",sr[sr.COLOR_ATTACHMENT_OPTIMAL=2]="COLOR_ATTACHMENT_OPTIMAL",sr[sr.DEPTH_STENCIL_ATTACHMENT_OPTIMAL=3]="DEPTH_STENCIL_ATTACHMENT_OPTIMAL",sr[sr.DEPTH_STENCIL_READONLY_OPTIMAL=4]="DEPTH_STENCIL_READONLY_OPTIMAL",sr[sr.SHADER_READONLY_OPTIMAL=5]="SHADER_READONLY_OPTIMAL",sr[sr.TRANSFER_SRC_OPTIMAL=6]="TRANSFER_SRC_OPTIMAL",sr[sr.TRANSFER_DST_OPTIMAL=7]="TRANSFER_DST_OPTIMAL",sr[sr.PREINITIALIZED=8]="PREINITIALIZED",sr[sr.PRESENT_SRC=9]="PRESENT_SRC",(lr=exports.GFXPipelineBindPoint||(exports.GFXPipelineBindPoint={}))[lr.GRAPHICS=0]="GRAPHICS",lr[lr.COMPUTE=1]="COMPUTE",lr[lr.RAY_TRACING=2]="RAY_TRACING",(ur=exports.GFXDynamicState||(exports.GFXDynamicState={}))[ur.VIEWPORT=0]="VIEWPORT",ur[ur.SCISSOR=1]="SCISSOR",ur[ur.LINE_WIDTH=2]="LINE_WIDTH",ur[ur.DEPTH_BIAS=3]="DEPTH_BIAS",ur[ur.BLEND_CONSTANTS=4]="BLEND_CONSTANTS",ur[ur.DEPTH_BOUNDS=5]="DEPTH_BOUNDS",ur[ur.STENCIL_WRITE_MASK=6]="STENCIL_WRITE_MASK",ur[ur.STENCIL_COMPARE_MASK=7]="STENCIL_COMPARE_MASK",(cr=exports.GFXStencilFace||(exports.GFXStencilFace={}))[cr.FRONT=0]="FRONT",cr[cr.BACK=1]="BACK",cr[cr.ALL=2]="ALL",(hr=exports.GFXQueueType||(exports.GFXQueueType={}))[hr.GRAPHICS=0]="GRAPHICS",hr[hr.COMPUTE=1]="COMPUTE",hr[hr.TRANSFER=2]="TRANSFER",(pr=exports.GFXClearFlag||(exports.GFXClearFlag={}))[pr.NONE=0]="NONE",pr[pr.COLOR=1]="COLOR",pr[pr.DEPTH=2]="DEPTH",pr[pr.STENCIL=4]="STENCIL",pr[pr.DEPTH_STENCIL=6]="DEPTH_STENCIL",pr[pr.ALL=7]="ALL";var fr,dr=function e(){Z(this,e),this.baseMipLevel=0,this.levelCount=1,this.baseArrayLayer=0,this.layerCount=1},mr=function e(){Z(this,e),this.srcSubres=new dr,this.srcOffset={x:0,y:0,z:0},this.dstSubres=new dr,this.dstOffset={x:0,y:0,z:0},this.extent={width:0,height:0,depth:0}},vr=function e(){Z(this,e),this.buffOffset=0,this.buffStride=0,this.buffTexHeight=0,this.texOffset={x:0,y:0,z:0},this.texExtent={width:0,height:0,depth:0},this.texSubres=new dr};(fr=exports.GFXFormatType||(exports.GFXFormatType={}))[fr.NONE=0]="NONE",fr[fr.UNORM=1]="UNORM",fr[fr.SNORM=2]="SNORM",fr[fr.UINT=3]="UINT",fr[fr.INT=4]="INT",fr[fr.UFLOAT=5]="UFLOAT",fr[fr.FLOAT=6]="FLOAT";var yr=[{name:"UNKNOWN",size:0,count:0,type:exports.GFXFormatType.NONE,hasAlpha:!1,hasDepth:!1,hasStencil:!1,isCompressed:!1},{name:"A8",size:1,count:1,type:exports.GFXFormatType.UNORM,hasAlpha:!0,hasDepth:!1,hasStencil:!1,isCompressed:!1},{name:"L8",size:1,count:1,type:exports.GFXFormatType.UNORM,hasAlpha:!1,hasDepth:!1,hasStencil:!1,isCompressed:!1},{name:"LA8",size:1,count:2,type:exports.GFXFormatType.UNORM,hasAlpha:!0,hasDepth:!1,hasStencil:!1,isCompressed:!1},{name:"R8",size:1,count:1,type:exports.GFXFormatType.UNORM,hasAlpha:!1,hasDepth:!1,hasStencil:!1,isCompressed:!1},{name:"R8SN",size:1,count:1,type:exports.GFXFormatType.SNORM,hasAlpha:!1,hasDepth:!1,hasStencil:!1,isCompressed:!1},{name:"R8UI",size:1,count:1,type:exports.GFXFormatType.UINT,hasAlpha:!1,hasDepth:!1,hasStencil:!1,isCompressed:!1},{name:"R8I",size:1,count:1,type:exports.GFXFormatType.INT,hasAlpha:!1,hasDepth:!1,hasStencil:!1,isCompressed:!1},{name:"R16F",size:2,count:1,type:exports.GFXFormatType.FLOAT,hasAlpha:!1,hasDepth:!1,hasStencil:!1,isCompressed:!1},{name:"R16UI",size:2,count:1,type:exports.GFXFormatType.UINT,hasAlpha:!1,hasDepth:!1,hasStencil:!1,isCompressed:!1},{name:"R16I",size:2,count:1,type:exports.GFXFormatType.INT,hasAlpha:!1,hasDepth:!1,hasStencil:!1,isCompressed:!1},{name:"R32F",size:4,count:1,type:exports.GFXFormatType.FLOAT,hasAlpha:!1,hasDepth:!1,hasStencil:!1,isCompressed:!1},{name:"R32UI",size:4,count:1,type:exports.GFXFormatType.UINT,hasAlpha:!1,hasDepth:!1,hasStencil:!1,isCompressed:!1},{name:"R32I",size:4,count:1,type:exports.GFXFormatType.INT,hasAlpha:!1,hasDepth:!1,hasStencil:!1,isCompressed:!1},{name:"RG8",size:2,count:2,type:exports.GFXFormatType.UNORM,hasAlpha:!1,hasDepth:!1,hasStencil:!1,isCompressed:!1},{name:"RG8SN",size:2,count:2,type:exports.GFXFormatType.SNORM,hasAlpha:!1,hasDepth:!1,hasStencil:!1,isCompressed:!1},{name:"RG8UI",size:2,count:2,type:exports.GFXFormatType.UINT,hasAlpha:!1,hasDepth:!1,hasStencil:!1,isCompressed:!1},{name:"RG8I",size:2,count:2,type:exports.GFXFormatType.INT,hasAlpha:!1,hasDepth:!1,hasStencil:!1,isCompressed:!1},{name:"RG16F",size:4,count:2,type:exports.GFXFormatType.FLOAT,hasAlpha:!1,hasDepth:!1,hasStencil:!1,isCompressed:!1},{name:"RG16UI",size:4,count:2,type:exports.GFXFormatType.UINT,hasAlpha:!1,hasDepth:!1,hasStencil:!1,isCompressed:!1},{name:"RG16I",size:4,count:2,type:exports.GFXFormatType.INT,hasAlpha:!1,hasDepth:!1,hasStencil:!1,isCompressed:!1},{name:"RG32F",size:8,count:2,type:exports.GFXFormatType.FLOAT,hasAlpha:!1,hasDepth:!1,hasStencil:!1,isCompressed:!1},{name:"RG32UI",size:8,count:2,type:exports.GFXFormatType.UINT,hasAlpha:!1,hasDepth:!1,hasStencil:!1,isCompressed:!1},{name:"RG32I",size:8,count:2,type:exports.GFXFormatType.INT,hasAlpha:!1,hasDepth:!1,hasStencil:!1,isCompressed:!1},{name:"RGB8",size:3,count:3,type:exports.GFXFormatType.UNORM,hasAlpha:!1,hasDepth:!1,hasStencil:!1,isCompressed:!1},{name:"SRGB8",size:3,count:3,type:exports.GFXFormatType.UNORM,hasAlpha:!1,hasDepth:!1,hasStencil:!1,isCompressed:!1},{name:"RGB8SN",size:3,count:3,type:exports.GFXFormatType.SNORM,hasAlpha:!1,hasDepth:!1,hasStencil:!1,isCompressed:!1},{name:"RGB8UI",size:3,count:3,type:exports.GFXFormatType.UINT,hasAlpha:!1,hasDepth:!1,hasStencil:!1,isCompressed:!1},{name:"RGB8I",size:3,count:3,type:exports.GFXFormatType.INT,hasAlpha:!1,hasDepth:!1,hasStencil:!1,isCompressed:!1},{name:"RGB16F",size:6,count:3,type:exports.GFXFormatType.FLOAT,hasAlpha:!1,hasDepth:!1,hasStencil:!1,isCompressed:!1},{name:"RGB16UI",size:6,count:3,type:exports.GFXFormatType.UINT,hasAlpha:!1,hasDepth:!1,hasStencil:!1,isCompressed:!1},{name:"RGB16I",size:6,count:3,type:exports.GFXFormatType.INT,hasAlpha:!1,hasDepth:!1,hasStencil:!1,isCompressed:!1},{name:"RGB32F",size:12,count:3,type:exports.GFXFormatType.FLOAT,hasAlpha:!1,hasDepth:!1,hasStencil:!1,isCompressed:!1},{name:"RGB32UI",size:12,count:3,type:exports.GFXFormatType.UINT,hasAlpha:!1,hasDepth:!1,hasStencil:!1,isCompressed:!1},{name:"RGB32I",size:12,count:3,type:exports.GFXFormatType.INT,hasAlpha:!1,hasDepth:!1,hasStencil:!1,isCompressed:!1},{name:"RGBA8",size:4,count:4,type:exports.GFXFormatType.UNORM,hasAlpha:!0,hasDepth:!1,hasStencil:!1,isCompressed:!1},{name:"SRGB8_A8",size:4,count:4,type:exports.GFXFormatType.UNORM,hasAlpha:!0,hasDepth:!1,hasStencil:!1,isCompressed:!1},{name:"RGBA8SN",size:4,count:4,type:exports.GFXFormatType.SNORM,hasAlpha:!0,hasDepth:!1,hasStencil:!1,isCompressed:!1},{name:"RGBA8UI",size:4,count:4,type:exports.GFXFormatType.UINT,hasAlpha:!0,hasDepth:!1,hasStencil:!1,isCompressed:!1},{name:"RGBA8I",size:4,count:4,type:exports.GFXFormatType.INT,hasAlpha:!0,hasDepth:!1,hasStencil:!1,isCompressed:!1},{name:"RGBA16F",size:8,count:4,type:exports.GFXFormatType.FLOAT,hasAlpha:!0,hasDepth:!1,hasStencil:!1,isCompressed:!1},{name:"RGBA16UI",size:8,count:4,type:exports.GFXFormatType.UINT,hasAlpha:!0,hasDepth:!1,hasStencil:!1,isCompressed:!1},{name:"RGBA16I",size:8,count:4,type:exports.GFXFormatType.INT,hasAlpha:!0,hasDepth:!1,hasStencil:!1,isCompressed:!1},{name:"RGBA32F",size:16,count:4,type:exports.GFXFormatType.FLOAT,hasAlpha:!0,hasDepth:!1,hasStencil:!1,isCompressed:!1},{name:"RGBA32UI",size:16,count:4,type:exports.GFXFormatType.UINT,hasAlpha:!0,hasDepth:!1,hasStencil:!1,isCompressed:!1},{name:"RGBA32I",size:16,count:4,type:exports.GFXFormatType.INT,hasAlpha:!0,hasDepth:!1,hasStencil:!1,isCompressed:!1},{name:"R5G6B5",size:2,count:3,type:exports.GFXFormatType.UNORM,hasAlpha:!1,hasDepth:!1,hasStencil:!1,isCompressed:!1},{name:"R11G11B10F",size:4,count:3,type:exports.GFXFormatType.FLOAT,hasAlpha:!1,hasDepth:!1,hasStencil:!1,isCompressed:!1},{name:"RGB5A1",size:2,count:4,type:exports.GFXFormatType.UNORM,hasAlpha:!0,hasDepth:!1,hasStencil:!1,isCompressed:!1},{name:"RGBA4",size:2,count:4,type:exports.GFXFormatType.UNORM,hasAlpha:!0,hasDepth:!1,hasStencil:!1,isCompressed:!1},{name:"RGB10A2",size:2,count:4,type:exports.GFXFormatType.UNORM,hasAlpha:!0,hasDepth:!1,hasStencil:!1,isCompressed:!1},{name:"RGB10A2UI",size:2,count:4,type:exports.GFXFormatType.UINT,hasAlpha:!0,hasDepth:!1,hasStencil:!1,isCompressed:!1},{name:"RGB9E5",size:2,count:4,type:exports.GFXFormatType.FLOAT,hasAlpha:!0,hasDepth:!1,hasStencil:!1,isCompressed:!1},{name:"D16",size:2,count:1,type:exports.GFXFormatType.UINT,hasAlpha:!1,hasDepth:!0,hasStencil:!1,isCompressed:!1},{name:"D16S8",size:3,count:2,type:exports.GFXFormatType.UINT,hasAlpha:!1,hasDepth:!0,hasStencil:!0,isCompressed:!1},{name:"D24",size:3,count:1,type:exports.GFXFormatType.UINT,hasAlpha:!1,hasDepth:!0,hasStencil:!1,isCompressed:!1},{name:"D24S8",size:4,count:2,type:exports.GFXFormatType.UINT,hasAlpha:!1,hasDepth:!0,hasStencil:!0,isCompressed:!1},{name:"D32F",size:4,count:1,type:exports.GFXFormatType.FLOAT,hasAlpha:!1,hasDepth:!0,hasStencil:!1,isCompressed:!1},{name:"D32FS8",size:5,count:2,type:exports.GFXFormatType.FLOAT,hasAlpha:!1,hasDepth:!0,hasStencil:!0,isCompressed:!1},{name:"BC1",size:1,count:3,type:exports.GFXFormatType.UNORM,hasAlpha:!1,hasDepth:!1,hasStencil:!1,isCompressed:!0},{name:"BC1_ALPHA",size:1,count:4,type:exports.GFXFormatType.UNORM,hasAlpha:!0,hasDepth:!1,hasStencil:!1,isCompressed:!0},{name:"BC1_SRGB",size:1,count:3,type:exports.GFXFormatType.UNORM,hasAlpha:!1,hasDepth:!1,hasStencil:!1,isCompressed:!0},{name:"BC1_SRGB_ALPHA",size:1,count:4,type:exports.GFXFormatType.UNORM,hasAlpha:!0,hasDepth:!1,hasStencil:!1,isCompressed:!0},{name:"BC2",size:1,count:4,type:exports.GFXFormatType.UNORM,hasAlpha:!0,hasDepth:!1,hasStencil:!1,isCompressed:!0},{name:"BC2_SRGB",size:1,count:4,type:exports.GFXFormatType.UNORM,hasAlpha:!0,hasDepth:!1,hasStencil:!1,isCompressed:!0},{name:"BC3",size:1,count:4,type:exports.GFXFormatType.UNORM,hasAlpha:!0,hasDepth:!1,hasStencil:!1,isCompressed:!0},{name:"BC3_SRGB",size:1,count:4,type:exports.GFXFormatType.UNORM,hasAlpha:!0,hasDepth:!1,hasStencil:!1,isCompressed:!0},{name:"BC4",size:1,count:1,type:exports.GFXFormatType.UNORM,hasAlpha:!1,hasDepth:!1,hasStencil:!1,isCompressed:!0},{name:"BC4_SNORM",size:1,count:1,type:exports.GFXFormatType.SNORM,hasAlpha:!1,hasDepth:!1,hasStencil:!1,isCompressed:!0},{name:"BC5",size:1,count:2,type:exports.GFXFormatType.UNORM,hasAlpha:!1,hasDepth:!1,hasStencil:!1,isCompressed:!0},{name:"BC5_SNORM",size:1,count:2,type:exports.GFXFormatType.SNORM,hasAlpha:!1,hasDepth:!1,hasStencil:!1,isCompressed:!0},{name:"BC6H_UF16",size:1,count:3,type:exports.GFXFormatType.UFLOAT,hasAlpha:!1,hasDepth:!1,hasStencil:!1,isCompressed:!0},{name:"BC6H_SF16",size:1,count:3,type:exports.GFXFormatType.FLOAT,hasAlpha:!1,hasDepth:!1,hasStencil:!1,isCompressed:!0},{name:"BC7",size:1,count:4,type:exports.GFXFormatType.UNORM,hasAlpha:!0,hasDepth:!1,hasStencil:!1,isCompressed:!0},{name:"BC7_SRGB",size:1,count:4,type:exports.GFXFormatType.UNORM,hasAlpha:!0,hasDepth:!1,hasStencil:!1,isCompressed:!0},{name:"ETC_RGB8",size:1,count:3,type:exports.GFXFormatType.UNORM,hasAlpha:!1,hasDepth:!1,hasStencil:!1,isCompressed:!0},{name:"ETC2_RGB8",size:1,count:3,type:exports.GFXFormatType.UNORM,hasAlpha:!1,hasDepth:!1,hasStencil:!1,isCompressed:!0},{name:"ETC2_SRGB8",size:1,count:3,type:exports.GFXFormatType.UNORM,hasAlpha:!1,hasDepth:!1,hasStencil:!1,isCompressed:!0},{name:"ETC2_RGB8_A1",size:1,count:4,type:exports.GFXFormatType.UNORM,hasAlpha:!0,hasDepth:!1,hasStencil:!1,isCompressed:!0},{name:"ETC2_SRGB8_A1",size:1,count:4,type:exports.GFXFormatType.UNORM,hasAlpha:!0,hasDepth:!1,hasStencil:!1,isCompressed:!0},{name:"ETC2_RGBA8",size:2,count:4,type:exports.GFXFormatType.UNORM,hasAlpha:!0,hasDepth:!1,hasStencil:!1,isCompressed:!0},{name:"ETC2_SRGB8_A8",size:2,count:4,type:exports.GFXFormatType.UNORM,hasAlpha:!0,hasDepth:!1,hasStencil:!1,isCompressed:!0},{name:"EAC_R11",size:1,count:1,type:exports.GFXFormatType.UNORM,hasAlpha:!1,hasDepth:!1,hasStencil:!1,isCompressed:!0},{name:"EAC_R11SN",size:1,count:1,type:exports.GFXFormatType.SNORM,hasAlpha:!1,hasDepth:!1,hasStencil:!1,isCompressed:!0},{name:"EAC_RG11",size:2,count:2,type:exports.GFXFormatType.UNORM,hasAlpha:!1,hasDepth:!1,hasStencil:!1,isCompressed:!0},{name:"EAC_RG11SN",size:2,count:2,type:exports.GFXFormatType.SNORM,hasAlpha:!1,hasDepth:!1,hasStencil:!1,isCompressed:!0},{name:"PVRTC_RGB2",size:2,count:3,type:exports.GFXFormatType.UNORM,hasAlpha:!1,hasDepth:!1,hasStencil:!1,isCompressed:!0},{name:"PVRTC_RGBA2",size:2,count:4,type:exports.GFXFormatType.UNORM,hasAlpha:!0,hasDepth:!1,hasStencil:!1,isCompressed:!0},{name:"PVRTC_RGB4",size:2,count:3,type:exports.GFXFormatType.UNORM,hasAlpha:!1,hasDepth:!1,hasStencil:!1,isCompressed:!0},{name:"PVRTC_RGBA4",size:2,count:4,type:exports.GFXFormatType.UNORM,hasAlpha:!0,hasDepth:!1,hasStencil:!1,isCompressed:!0},{name:"PVRTC2_2BPP",size:2,count:4,type:exports.GFXFormatType.UNORM,hasAlpha:!0,hasDepth:!1,hasStencil:!1,isCompressed:!0},{name:"PVRTC2_4BPP",size:2,count:4,type:exports.GFXFormatType.UNORM,hasAlpha:!0,hasDepth:!1,hasStencil:!1,isCompressed:!0}];function gr(e,t,i,n){if(!yr[e].isCompressed)return t*i*n*yr[e].size;switch(e){case exports.GFXFormat.BC1:case exports.GFXFormat.BC1_ALPHA:case exports.GFXFormat.BC1_SRGB:case exports.GFXFormat.BC1_SRGB_ALPHA:return Math.ceil(t/4)*Math.ceil(i/4)*8*n;case exports.GFXFormat.BC2:case exports.GFXFormat.BC2_SRGB:case exports.GFXFormat.BC3:case exports.GFXFormat.BC3_SRGB:case exports.GFXFormat.BC4:case exports.GFXFormat.BC4_SNORM:case exports.GFXFormat.BC6H_SF16:case exports.GFXFormat.BC6H_UF16:case exports.GFXFormat.BC7:case exports.GFXFormat.BC7_SRGB:return Math.ceil(t/4)*Math.ceil(i/4)*16*n;case exports.GFXFormat.BC5:case exports.GFXFormat.BC5_SNORM:return Math.ceil(t/4)*Math.ceil(i/4)*32*n;case exports.GFXFormat.ETC_RGB8:case exports.GFXFormat.ETC2_RGB8:case exports.GFXFormat.ETC2_SRGB8:case exports.GFXFormat.ETC2_RGB8_A1:case exports.GFXFormat.ETC2_SRGB8_A1:case exports.GFXFormat.EAC_R11:case exports.GFXFormat.EAC_R11SN:return Math.ceil(t/4)*Math.ceil(i/4)*8*n;case exports.GFXFormat.ETC2_RGBA8:case exports.GFXFormat.EAC_RG11:case exports.GFXFormat.EAC_RG11SN:return Math.ceil(t/4)*Math.ceil(i/4)*16*n;case exports.GFXFormat.PVRTC_RGB2:case exports.GFXFormat.PVRTC_RGBA2:case exports.GFXFormat.PVRTC2_2BPP:return Math.ceil(Math.max(t,16)*Math.max(i,8)/4)*n;case exports.GFXFormat.PVRTC_RGB4:case exports.GFXFormat.PVRTC_RGBA4:case exports.GFXFormat.PVRTC2_4BPP:return Math.ceil(Math.max(t,16)*Math.max(i,8)/2)*n;default:return 0}}function xr(e,t,i,n,r){for(var a=0,o=0;o<r;++o)a+=gr(e,t,i,n),t=Math.max(t>>1,1),i=Math.max(i>>1,1);return a}var br=[0,4,8,12,16,4,8,12,16,4,8,12,16,4,8,12,16,16,24,32,24,36,48,32,48,64,4,4,4,4,4,4];function Tr(e){return br[e]||0}function Sr(e){var t=e.size/e.count;switch(e.type){case exports.GFXFormatType.UNORM:case exports.GFXFormatType.UINT:switch(t){case 1:return Uint8Array;case 2:return Uint16Array;case 4:return Uint32Array}break;case exports.GFXFormatType.SNORM:case exports.GFXFormatType.INT:switch(t){case 1:return Int8Array;case 2:return Int16Array;case 4:return Int32Array}break;case exports.GFXFormatType.FLOAT:return Float32Array}return Float32Array}var Er,wr,Cr=Object.freeze({__proto__:null,GFX_MAX_VERTEX_ATTRIBUTES:16,GFX_MAX_TEXTURE_UNITS:16,GFX_MAX_ATTACHMENTS:4,GFX_MAX_BUFFER_BINDINGS:24,get GFXObjectType(){return exports.GFXObjectType},get GFXStatus(){return exports.GFXStatus},GFXObject:_r,get GFXAttributeName(){return exports.GFXAttributeName},get GFXType(){return exports.GFXType},get GFXFormat(){return exports.GFXFormat},get GFXBufferUsageBit(){return exports.GFXBufferUsageBit},get GFXMemoryUsageBit(){return exports.GFXMemoryUsageBit},get GFXBufferFlagBit(){return exports.GFXBufferFlagBit},get GFXBufferAccessBit(){return exports.GFXBufferAccessBit},get GFXPrimitiveMode(){return exports.GFXPrimitiveMode},get GFXPolygonMode(){return exports.GFXPolygonMode},get GFXShadeModel(){return exports.GFXShadeModel},get GFXCullMode(){return exports.GFXCullMode},get GFXComparisonFunc(){return exports.GFXComparisonFunc},get GFXStencilOp(){return exports.GFXStencilOp},get GFXBlendOp(){return exports.GFXBlendOp},get GFXBlendFactor(){return exports.GFXBlendFactor},get GFXColorMask(){return exports.GFXColorMask},get GFXFilter(){return exports.GFXFilter},get GFXAddress(){return exports.GFXAddress},get GFXTextureType(){return exports.GFXTextureType},get GFXTextureUsageBit(){return exports.GFXTextureUsageBit},get GFXSampleCount(){return exports.GFXSampleCount},get GFXTextureFlagBit(){return exports.GFXTextureFlagBit},get GFXTextureViewType(){return exports.GFXTextureViewType},get GFXShaderType(){return exports.GFXShaderType},get GFXBindingType(){return exports.GFXBindingType},get GFXCommandBufferType(){return exports.GFXCommandBufferType},get GFXLoadOp(){return exports.GFXLoadOp},get GFXStoreOp(){return exports.GFXStoreOp},get GFXTextureLayout(){return exports.GFXTextureLayout},get GFXPipelineBindPoint(){return exports.GFXPipelineBindPoint},get GFXDynamicState(){return exports.GFXDynamicState},get GFXStencilFace(){return exports.GFXStencilFace},get GFXQueueType(){return exports.GFXQueueType},get GFXClearFlag(){return exports.GFXClearFlag},GFXTextureSubres:dr,GFXTextureCopy:mr,GFXBufferTextureCopy:vr,get GFXFormatType(){return exports.GFXFormatType},GFXFormatInfos:yr,GFXFormatSize:gr,GFXFormatSurfaceSize:xr,GFXGetTypeSize:Tr,getTypedArrayConstructor:Sr}),Ar=function(e){function t(e){var i;return Z(this,t),(i=re(this,te(t).call(this,exports.GFXObjectType.BUFFER)))._device=void 0,i._usage=exports.GFXBufferUsageBit.NONE,i._memUsage=exports.GFXMemoryUsageBit.NONE,i._size=0,i._stride=1,i._count=0,i._flags=exports.GFXBufferFlagBit.NONE,i._bufferView=null,i._indirectBuffer=null,i._device=e,i}return ee(t,_r),J(t,[{key:"usage",get:function(){return this._usage}},{key:"memUsage",get:function(){return this._memUsage}},{key:"size",get:function(){return this._size}},{key:"stride",get:function(){return this._stride}},{key:"count",get:function(){return this._count}},{key:"flags",get:function(){return this._flags}},{key:"bufferView",get:function(){return this._bufferView}}]),t}(),Or=function(e){function t(e){var i;return Z(this,t),(i=re(this,te(t).call(this,exports.GFXObjectType.COMMAND_BUFFER)))._device=void 0,i._allocator=null,i._type=exports.GFXCommandBufferType.PRIMARY,i._numDrawCalls=0,i._numInstances=0,i._numTris=0,i._device=e,i}return ee(t,_r),J(t,[{key:"type",get:function(){return this._type}},{key:"numDrawCalls",get:function(){return this._numDrawCalls}},{key:"numInstances",get:function(){return this._numInstances}},{key:"numTris",get:function(){return this._numTris}}]),t}();bt(exports.GFXFormat),(Er=exports.GFXAPI||(exports.GFXAPI={}))[Er.UNKNOWN=0]="UNKNOWN",Er[Er.WEBGL=1]="WEBGL",Er[Er.WEBGL2=2]="WEBGL2",(wr=exports.GFXFeature||(exports.GFXFeature={}))[wr.COLOR_FLOAT=0]="COLOR_FLOAT",wr[wr.COLOR_HALF_FLOAT=1]="COLOR_HALF_FLOAT",wr[wr.TEXTURE_FLOAT=2]="TEXTURE_FLOAT",wr[wr.TEXTURE_HALF_FLOAT=3]="TEXTURE_HALF_FLOAT",wr[wr.TEXTURE_FLOAT_LINEAR=4]="TEXTURE_FLOAT_LINEAR",wr[wr.TEXTURE_HALF_FLOAT_LINEAR=5]="TEXTURE_HALF_FLOAT_LINEAR",wr[wr.FORMAT_R11G11B10F=6]="FORMAT_R11G11B10F",wr[wr.FORMAT_D24S8=7]="FORMAT_D24S8",wr[wr.FORMAT_ETC1=8]="FORMAT_ETC1",wr[wr.FORMAT_ETC2=9]="FORMAT_ETC2",wr[wr.FORMAT_DXT=10]="FORMAT_DXT",wr[wr.FORMAT_PVRTC=11]="FORMAT_PVRTC",wr[wr.FORMAT_ASTC=12]="FORMAT_ASTC",wr[wr.MSAA=13]="MSAA",wr[wr.ELEMENT_INDEX_UINT=14]="ELEMENT_INDEX_UINT",wr[wr.INSTANCED_ARRAYS=15]="INSTANCED_ARRAYS",wr[wr.COUNT=16]="COUNT";var kr=function(){function e(){Z(this,e),this._canvas=null,this._canvas2D=null,this._gfxAPI=exports.GFXAPI.UNKNOWN,this._deviceName="",this._renderer="",this._vendor="",this._version="",this._features=new Array(exports.GFXFeature.COUNT),this._queue=null,this._devicePixelRatio=1,this._width=0,this._height=0,this._nativeWidth=0,this._nativeHeight=0,this._mainWindow=null,this._cmdAllocator=null,this._maxVertexAttributes=0,this._maxVertexUniformVectors=0,this._maxFragmentUniformVectors=0,this._maxTextureUnits=0,this._maxVertexTextureUnits=0,this._maxUniformBufferBindings=24,this._maxUniformBlockSize=0,this._maxTextureSize=0,this._maxCubeMapTextureSize=0,this._depthBits=0,this._stencilBits=0,this._colorFmt=exports.GFXFormat.UNKNOWN,this._depthStencilFmt=exports.GFXFormat.UNKNOWN,this._reverseCW=!1,this._shaderIdGen=0,this._macros=new Map,this._numDrawCalls=0,this._numInstances=0,this._numTris=0,this._memoryStatus={bufferSize:0,textureSize:0}}return J(e,[{key:"hasFeature",value:function(e){return this._features[e]}},{key:"genShaderId",value:function(){return this._shaderIdGen++}},{key:"defineMacro",value:function(e,t){var i=void 0!==t?t:"";this._macros.set(e,i)}},{key:"canvas",get:function(){return this._canvas}},{key:"canvas2D",get:function(){return this._canvas2D}},{key:"gfxAPI",get:function(){return this._gfxAPI}},{key:"queue",get:function(){return this._queue}},{key:"devicePixelRatio",get:function(){return this._devicePixelRatio}},{key:"width",get:function(){return this._width}},{key:"height",get:function(){return this._height}},{key:"nativeWidth",get:function(){return this._nativeWidth}},{key:"nativeHeight",get:function(){return this._nativeHeight}},{key:"mainWindow",get:function(){return this._mainWindow}},{key:"commandAllocator",get:function(){return this._cmdAllocator}},{key:"renderer",get:function(){return this._renderer}},{key:"vendor",get:function(){return this._vendor}},{key:"maxVertexAttributes",get:function(){return this._maxVertexAttributes}},{key:"maxVertexUniformVectors",get:function(){return this._maxVertexUniformVectors}},{key:"maxFragmentUniformVectors",get:function(){return this._maxFragmentUniformVectors}},{key:"maxTextureUnits",get:function(){return this._maxTextureUnits}},{key:"maxVertexTextureUnits",get:function(){return this._maxVertexTextureUnits}},{key:"maxUniformBufferBindings",get:function(){return this._maxUniformBufferBindings}},{key:"maxUniformBlockSize",get:function(){return this._maxUniformBlockSize}},{key:"maxTextureSize",get:function(){return this._maxTextureSize}},{key:"maxCubeMapTextureSize",get:function(){return this._maxCubeMapTextureSize}},{key:"depthBits",get:function(){return this._depthBits}},{key:"stencilBits",get:function(){return this._stencilBits}},{key:"colorFormat",get:function(){return this._colorFmt}},{key:"depthStencilFormat",get:function(){return this._depthStencilFmt}},{key:"macros",get:function(){return this._macros}},{key:"numDrawCalls",get:function(){return this._numDrawCalls}},{key:"numInstances",get:function(){return this._numInstances}},{key:"numTris",get:function(){return this._numTris}},{key:"memoryStatus",get:function(){return this._memoryStatus}},{key:"reverseCW",get:function(){return this._reverseCW},set:function(e){this._reverseCW=e}}]),e}(),Rr=function(e){function t(e){var i;return Z(this,t),(i=re(this,te(t).call(this,exports.GFXObjectType.FRAMEBUFFER)))._device=void 0,i._renderPass=null,i._colorViews=[],i._depthStencilView=null,i._isOffscreen=!0,i._device=e,i}return ee(t,_r),J(t,[{key:"renderPass",get:function(){return this._renderPass}},{key:"colorViews",get:function(){return this._colorViews}},{key:"depthStencilView",get:function(){return this._depthStencilView}},{key:"isOffscreen",get:function(){return this._isOffscreen}}]),t}(),Fr=function(e){function t(e){var i;return Z(this,t),(i=re(this,te(t).call(this,exports.GFXObjectType.INPUT_ASSEMBLER)))._device=void 0,i._attributes=[],i._vertexBuffers=[],i._indexBuffer=null,i._vertexCount=0,i._firstVertex=0,i._indexCount=0,i._firstIndex=0,i._vertexOffset=0,i._instanceCount=0,i._firstInstance=0,i._isIndirect=!1,i._indirectBuffer=null,i._device=e,i}return ee(t,_r),J(t,[{key:"vertexBuffers",get:function(){return this._vertexBuffers}},{key:"indexBuffer",get:function(){return this._indexBuffer}},{key:"attributes",get:function(){return this._attributes}},{key:"vertexCount",get:function(){return this._vertexCount},set:function(e){this._vertexCount=e}},{key:"firstVertex",get:function(){return this._firstVertex},set:function(e){this._firstVertex=e}},{key:"indexCount",get:function(){return this._indexCount},set:function(e){this._indexCount=e}},{key:"firstIndex",get:function(){return this._firstIndex},set:function(e){this._firstIndex=e}},{key:"vertexOffset",get:function(){return this._vertexOffset},set:function(e){this._vertexOffset=e}},{key:"instanceCount",get:function(){return this._instanceCount},set:function(e){this._instanceCount=e}},{key:"firstInstance",get:function(){return this._firstInstance},set:function(e){this._firstInstance=e}},{key:"isIndirect",get:function(){return this._isIndirect}},{key:"indirectBuffer",get:function(){return this._indirectBuffer}}]),J(t,[{key:"getVertexBuffer",value:function(){var e=arguments.length>0&&void 0!==arguments[0]?arguments[0]:0;return e<this._vertexBuffers.length?this._vertexBuffers[e]:null}}]),t}(),Mr=function(e){function t(e){var i;return Z(this,t),(i=re(this,te(t).call(this,exports.GFXObjectType.PIPELINE_LAYOUT)))._device=void 0,i._pushConstantsRanges=[],i._layouts=[],i._device=e,i}return ee(t,_r),J(t,[{key:"layouts",get:function(){return this._layouts}}]),t}(),Ir=function(){function e(){Z(this,e),this.isDiscard=!1,this.polygonMode=exports.GFXPolygonMode.FILL,this.shadeModel=exports.GFXShadeModel.GOURAND,this.cullMode=exports.GFXCullMode.BACK,this.isFrontFaceCCW=!0,this.depthBias=0,this.depthBiasClamp=0,this.depthBiasSlop=0,this.isDepthClip=!0,this.isMultisample=!1,this.lineWidth=1}return J(e,[{key:"compare",value:function(e){return this.isDiscard===e.isDiscard&&this.polygonMode===e.polygonMode&&this.shadeModel===e.shadeModel&&this.cullMode===e.cullMode&&this.isFrontFaceCCW===e.isFrontFaceCCW&&this.depthBias===e.depthBias&&this.depthBiasClamp===e.depthBiasClamp&&this.depthBiasSlop===e.depthBiasSlop&&this.isDepthClip===e.isDepthClip&&this.lineWidth===e.lineWidth&&this.isMultisample===e.isMultisample}}]),e}(),Pr=function(){function e(){Z(this,e),this.depthTest=!0,this.depthWrite=!0,this.depthFunc=exports.GFXComparisonFunc.LESS,this.stencilTestFront=!1,this.stencilFuncFront=exports.GFXComparisonFunc.ALWAYS,this.stencilReadMaskFront=65535,this.stencilWriteMaskFront=65535,this.stencilFailOpFront=exports.GFXStencilOp.KEEP,this.stencilZFailOpFront=exports.GFXStencilOp.KEEP,this.stencilPassOpFront=exports.GFXStencilOp.KEEP,this.stencilRefFront=1,this.stencilTestBack=!1,this.stencilFuncBack=exports.GFXComparisonFunc.ALWAYS,this.stencilReadMaskBack=65535,this.stencilWriteMaskBack=65535,this.stencilFailOpBack=exports.GFXStencilOp.KEEP,this.stencilZFailOpBack=exports.GFXStencilOp.KEEP,this.stencilPassOpBack=exports.GFXStencilOp.KEEP,this.stencilRefBack=1}return J(e,[{key:"compare",value:function(e){return this.depthTest===e.depthTest&&this.depthWrite===e.depthWrite&&this.depthFunc===e.depthFunc&&this.stencilTestFront===e.stencilTestFront&&this.stencilFuncFront===e.stencilFuncFront&&this.stencilReadMaskFront===e.stencilReadMaskFront&&this.stencilWriteMaskFront===e.stencilWriteMaskFront&&this.stencilFailOpFront===e.stencilFailOpFront&&this.stencilZFailOpFront===e.stencilZFailOpFront&&this.stencilPassOpFront===e.stencilPassOpFront&&this.stencilRefFront===e.stencilRefFront&&this.stencilTestBack===e.stencilTestBack&&this.stencilFuncBack===e.stencilFuncBack&&this.stencilReadMaskBack===e.stencilReadMaskBack&&this.stencilWriteMaskBack===e.stencilWriteMaskBack&&this.stencilFailOpBack===e.stencilFailOpBack&&this.stencilZFailOpBack===e.stencilZFailOpBack&&this.stencilPassOpBack===e.stencilPassOpBack&&this.stencilRefBack===e.stencilRefBack}}]),e}(),Lr=function(){function e(){Z(this,e),this.blend=!1,this.blendSrc=exports.GFXBlendFactor.ONE,this.blendDst=exports.GFXBlendFactor.ZERO,this.blendEq=exports.GFXBlendOp.ADD,this.blendSrcAlpha=exports.GFXBlendFactor.ONE,this.blendDstAlpha=exports.GFXBlendFactor.ZERO,this.blendAlphaEq=exports.GFXBlendOp.ADD,this.blendColorMask=exports.GFXColorMask.ALL}return J(e,[{key:"compare",value:function(e){return this.blend===e.blend&&this.blendSrc===e.blendSrc&&this.blendDst===e.blendDst&&this.blendEq===e.blendEq&&this.blendSrcAlpha===e.blendSrcAlpha&&this.blendDstAlpha===e.blendDstAlpha&&this.blendAlphaEq===e.blendAlphaEq&&this.blendColorMask===e.blendColorMask}}]),e}(),Dr=function e(){Z(this,e),this.isA2C=!1,this.isIndepend=!1,this.blendColor=[0,0,0,0],this.targets=[new Lr]},Nr=function e(){Z(this,e),this.attributes=[]},zr=function(e){function t(e){var i;return Z(this,t),(i=re(this,te(t).call(this,exports.GFXObjectType.PIPELINE_STATE)))._device=void 0,i._shader=null,i._primitive=exports.GFXPrimitiveMode.TRIANGLE_LIST,i._is=null,i._rs=null,i._dss=null,i._bs=null,i._dynamicStates=[],i._layout=null,i._renderPass=null,i._hash=0,i._device=e,i}return ee(t,_r),J(t,[{key:"shader",get:function(){return this._shader}},{key:"primitive",get:function(){return this._primitive}},{key:"rasterizerState",get:function(){return this._rs}},{key:"depthStencilState",get:function(){return this._dss}},{key:"blendState",get:function(){return this._bs}},{key:"inputState",get:function(){return this._is}},{key:"dynamicStates",get:function(){return this._dynamicStates}},{key:"pipelineLayout",get:function(){return this._layout}},{key:"renderPass",get:function(){return this._renderPass}},{key:"hash",get:function(){return this._hash}}]),t}(),Br=function(e){function t(e){var i;return Z(this,t),(i=re(this,te(t).call(this,exports.GFXObjectType.QUEUE)))._device=void 0,i._type=exports.GFXQueueType.GRAPHICS,i._device=e,i}return ee(t,_r),J(t,[{key:"type",get:function(){return this._type}}]),t}(),Gr=function(e){function t(e){var i;return Z(this,t),(i=re(this,te(t).call(this,exports.GFXObjectType.RENDER_PASS)))._device=void 0,i._colorInfos=[],i._depthStencilInfo=null,i._device=e,i}return ee(t,_r),t}(),Ur=function(){function e(){Z(this,e),this.name="",this.minFilter=exports.GFXFilter.LINEAR,this.magFilter=exports.GFXFilter.LINEAR,this.mipFilter=exports.GFXFilter.NONE,this.addressU=exports.GFXAddress.WRAP,this.addressV=exports.GFXAddress.WRAP,this.addressW=exports.GFXAddress.WRAP,this.maxAnisotropy=16,this.cmpFunc=exports.GFXComparisonFunc.NEVER,this.borderColor={r:0,g:0,b:0,a:0},this.minLOD=0,this.maxLOD=0,this.mipLODBias=0}return J(e,[{key:"compare",value:function(e){return this.minFilter===e.minFilter&&this.magFilter===e.magFilter&&this.mipFilter===e.mipFilter&&this.addressU===e.addressU&&this.addressV===e.addressV&&this.addressW===e.addressW&&this.maxAnisotropy===e.maxAnisotropy&&this.cmpFunc===e.cmpFunc&&this.borderColor.r===e.borderColor.r&&this.borderColor.g===e.borderColor.g&&this.borderColor.b===e.borderColor.b&&this.borderColor.a===e.borderColor.a&&this.minLOD===e.minLOD&&this.maxLOD===e.maxLOD&&this.mipLODBias===e.mipLODBias}}]),e}(),Xr=function(e){function t(e){var i;return Z(this,t),(i=re(this,te(t).call(this,exports.GFXObjectType.SAMPLER)))._device=void 0,i._state=new Ur,i._device=e,i._state=new Ur,i}return ee(t,_r),J(t,[{key:"state",get:function(){return this._state}}]),t}(),Vr=function(e){function t(e){var i;return Z(this,t),(i=re(this,te(t).call(this,exports.GFXObjectType.SHADER)))._device=void 0,i._id=void 0,i._name="",i._stages=[],i._blocks=[],i._samplers=[],i._device=e,i._id=e.genShaderId(),i}return ee(t,_r),J(t,[{key:"id",get:function(){return this._id}},{key:"name",get:function(){return this._name}}]),t}();function Hr(e){return e>0&&0==(e&e-1)}var Wr,jr=function(e){function t(e){var i;return Z(this,t),(i=re(this,te(t).call(this,exports.GFXObjectType.TEXTURE)))._device=void 0,i._type=exports.GFXTextureType.TEX2D,i._usage=exports.GFXTextureUsageBit.NONE,i._format=exports.GFXFormat.UNKNOWN,i._width=0,i._height=0,i._depth=1,i._arrayLayer=1,i._mipLevel=1,i._samples=exports.GFXSampleCount.X1,i._flags=exports.GFXTextureFlagBit.NONE,i._isPowerOf2=!1,i._size=0,i._buffer=null,i._device=e,i}return ee(t,_r),J(t,[{key:"type",get:function(){return this._type}},{key:"usage",get:function(){return this._usage}},{key:"format",get:function(){return this._format}},{key:"width",get:function(){return this._width}},{key:"height",get:function(){return this._height}},{key:"depth",get:function(){return this._depth}},{key:"arrayLayer",get:function(){return this._arrayLayer}},{key:"mipLevel",get:function(){return this._mipLevel}},{key:"samples",get:function(){return this._samples}},{key:"flags",get:function(){return this._flags}},{key:"size",get:function(){return this._size}},{key:"buffer",get:function(){return this._buffer}}]),t}(),qr=function(e){function t(e){var i;return Z(this,t),(i=re(this,te(t).call(this,exports.GFXObjectType.TEXTURE_VIEW)))._device=void 0,i._texture=null,i._type=exports.GFXTextureViewType.TV2D,i._format=exports.GFXFormat.UNKNOWN,i._baseLevel=0,i._levelCount=1,i._baseLayer=0,i._layerCount=1,i._device=e,i}return ee(t,_r),J(t,[{key:"texture",get:function(){return this._texture}},{key:"type",get:function(){return this._type}},{key:"format",get:function(){return this._format}},{key:"baseLevel",get:function(){return this._baseLevel}},{key:"levelCount",get:function(){return this._levelCount}},{key:"baseLayer",get:function(){return this._baseLayer}},{key:"layerCount",get:function(){return this._layerCount}}]),t}(),Yr=function(e){function t(e){var i;return Z(this,t),(i=re(this,te(t).call(this,exports.GFXObjectType.BINDING_LAYOUT)))._device=void 0,i._bindingUnits=[],i._isDirty=!1,i._device=e,i}return ee(t,_r),J(t,[{key:"bindBuffer",value:function(e,t){for(var i,n=_e(this._bindingUnits);!(i=n()).done;){var r=i.value;if(r.binding===e)return void(r.type===exports.GFXBindingType.UNIFORM_BUFFER?r.buffer!==t&&(r.buffer=t,this._isDirty=!0):console.error("Setting binding is not GFXBindingType.UNIFORM_BUFFER."))}}},{key:"bindSampler",value:function(e,t){for(var i,n=_e(this._bindingUnits);!(i=n()).done;){var r=i.value;if(r.binding===e)return void(r.type===exports.GFXBindingType.SAMPLER?r.sampler!==t&&(r.sampler=t,this._isDirty=!0):console.error("Setting binding is not GFXBindingType.SAMPLER."))}}},{key:"bindTextureView",value:function(e,t){for(var i,n=_e(this._bindingUnits);!(i=n()).done;){var r=i.value;if(r.binding===e)return void(r.type===exports.GFXBindingType.SAMPLER?r.texView!==t&&(r.texView=t,this._isDirty=!0):console.error("Setting binding is not GFXBindingType.SAMPLER."))}}},{key:"getBindingUnit",value:function(e){for(var t,i=_e(this._bindingUnits);!(t=i()).done;){var n=t.value;if(n.binding===e)return n}return null}}]),t}(),Kr=function(e){function t(e){var i;return Z(this,t),(i=re(this,te(t).call(this,exports.GFXObjectType.COMMAND_ALLOCATOR)))._device=void 0,i._device=e,i}return ee(t,_r),t}(),Zr=function(e){function t(e){var i;return Z(this,t),(i=re(this,te(t).call(this,exports.GFXObjectType.WINDOW)))._device=void 0,i._title="",i._left=0,i._top=0,i._width=0,i._height=0,i._nativeWidth=0,i._nativeHeight=0,i._colorFmt=exports.GFXFormat.UNKNOWN,i._depthStencilFmt=exports.GFXFormat.UNKNOWN,i._isOffscreen=!1,i._renderPass=null,i._colorTex=null,i._colorTexView=null,i._depthStencilTex=null,i._depthStencilTexView=null,i._framebuffer=null,i._device=e,i}return ee(t,_r),J(t,[{key:"width",get:function(){return this._width}},{key:"height",get:function(){return this._height}},{key:"colorFormat",get:function(){return this._colorFmt}},{key:"detphStencilFormat",get:function(){return this._depthStencilFmt}},{key:"isOffscreen",get:function(){return this._isOffscreen}},{key:"renderPass",get:function(){return this._renderPass}},{key:"colorTexView",get:function(){return this._colorTexView}},{key:"depthStencilTexView",get:function(){return this._depthStencilTexView}},{key:"framebuffer",get:function(){return this._framebuffer}}]),t}();cc.GFXDevice=kr,cc.GFXBuffer=Ar,cc.GFXTexture=jr,cc.GFXTextureView=qr,cc.GFXSampler=Xr,cc.GFXShader=Vr,cc.GFXInputAssembler=Fr,cc.GFXRenderPass=Gr,cc.GFXFramebuffer=Rr,cc.GFXPipelineLayout=Mr,cc.GFXPipelineState=zr,cc.GFXCommandBuffer=Or,cc.GFXQueue=Br,Object.assign(cc,Cr),function(e){e[e.ALL=0]="ALL",e[e.CLOSEST=1]="CLOSEST",e[e.ANY=2]="ANY"}(Wr||(Wr={}));var Qr,Jr,$r,ea,ta,ia,na=(Qr=new Ii(0,0,0),function(e,t){var i=Ii.dot(e.d,t.n);if(Math.abs(i)<Number.EPSILON)return 0;Ii.multiplyScalar(Qr,t.n,t.d);var n=Ii.dot(Ii.subtract(Qr,Qr,e.o),t.n)/i;return n<0?0:n}),ra=(Jr=new Ii(0,0,0),$r=new Ii(0,0,0),ea=new Ii(0,0,0),ta=new Ii(0,0,0),ia=new Ii(0,0,0),function(e,t,i){Ii.subtract(Jr,t.b,t.a),Ii.subtract($r,t.c,t.a),Ii.cross(ea,e.d,$r);var n=Ii.dot(Jr,ea);if(n<Number.EPSILON&&(!i||n>-Number.EPSILON))return 0;var r=1/n;Ii.subtract(ta,e.o,t.a);var a=Ii.dot(ta,ea)*r;if(a<0||a>1)return 0;Ii.cross(ia,ta,Jr);var o=Ii.dot(e.d,ia)*r;if(o<0||a+o>1)return 0;var s=Ii.dot($r,ia)*r;return s<0?0:s}),aa=function(){var e=new Ii(0,0,0);return function(t,i){var n=i.radius,r=i.center,a=t.o,o=t.d,s=n*n;Ii.subtract(e,r,a);var l=e.lengthSqr(),u=Ii.dot(e,o),c=s-(l-u*u);if(c<0)return 0;var h=Math.sqrt(c),p=l<s?u+h:u-h;return p<0?0:p}}(),oa=function(){var e=new Ii,t=new Ii;return function(i,n){return Ii.subtract(e,n.center,n.halfExtents),Ii.add(t,n.center,n.halfExtents),sa(i,e,t)}}();function sa(e,t,i){var n=e.o,r=e.d,a=1/r.x,o=1/r.y,s=1/r.z,l=(t.x-n.x)*a,u=(i.x-n.x)*a,c=(t.y-n.y)*o,h=(i.y-n.y)*o,p=(t.z-n.z)*s,_=(i.z-n.z)*s,f=Math.max(Math.max(Math.min(l,u),Math.min(c,h)),Math.min(p,_)),d=Math.min(Math.min(Math.max(l,u),Math.max(c,h)),Math.max(p,_));return d<0||f>d?0:f>0?f:d}var la,ua,ca=function(){var e=new Ii,t=new Ii,i=new Ii,n=new Ii,r=new Ii,a=new Ii,o=new Ii,s=new Array(3),l=new Array(3),u=new Array(3),c=new Array(6);return function(h,p){s[0]=p.halfExtents.x,s[1]=p.halfExtents.y,s[2]=p.halfExtents.z,e=p.center,t=h.o,i=h.d,Ii.set(n,p.orientation.m00,p.orientation.m01,p.orientation.m02),Ii.set(r,p.orientation.m03,p.orientation.m04,p.orientation.m05),Ii.set(a,p.orientation.m06,p.orientation.m07,p.orientation.m08),Ii.subtract(o,e,t),l[0]=Ii.dot(n,i),l[1]=Ii.dot(r,i),l[2]=Ii.dot(a,i),u[0]=Ii.dot(n,o),u[1]=Ii.dot(r,o),u[2]=Ii.dot(a,o);for(var _=0;_<3;++_){if(0===l[_]){if(-u[_]-s[_]>0||-u[_]+s[_]<0)return 0;l[_]=1e-7}c[2*_+0]=(u[_]+s[_])/l[_],c[2*_+1]=(u[_]-s[_])/l[_]}var f=Math.max(Math.max(Math.min(c[0],c[1]),Math.min(c[2],c[3])),Math.min(c[4],c[5])),d=Math.min(Math.min(Math.max(c[0],c[1]),Math.max(c[2],c[3])),Math.max(c[4],c[5]));return d<0||f>d?0:f>0?f:d}}(),ha=function(){var e=new Ii,t=new Ii,i=new Ii,n=new Ii,r=new Ii,a=new Ii,o=new Ii,s=new Fn;return function(l,u){var c=u.radius*u.radius,h=Ii.normalize(e,l.d),p=u.ellipseCenter0,_=u.ellipseCenter1,f=Ii.subtract(t,_,p);if(f.equals(Ii.ZERO))return s.radius=u.radius,s.center.set(u.ellipseCenter0),Ka.ray_sphere(l,s);var d=l.o,m=Ii.subtract(i,d,p),v=Ii.cross(n,h,f),y=v.lengthSqr();if(0===y){s.radius=u.radius;var g=Ii.subtract(r,_,d);return m.lengthSqr()<g.lengthSqr()?s.center.set(u.ellipseCenter0):s.center.set(u.ellipseCenter1),Ka.ray_sphere(l,s)}var x=Ii.cross(r,m,f),b=f.lengthSqr(),T=2*Ii.dot(v,x),S=T*T-4*y*(x.lengthSqr()-c*b);if(S<0)return 0;var E=(-T-Math.sqrt(S))/(2*y);if(E<0){s.radius=u.radius;var w=Ii.subtract(a,_,d);return m.lengthSqr()<w.lengthSqr()?s.center.set(u.ellipseCenter0):s.center.set(u.ellipseCenter1),Ka.ray_sphere(l,s)}var C=Ii.scaleAndAdd(a,l.o,h,E),A=Ii.subtract(o,C,p),O=Ii.dot(A,f)/b;return O>=0&&O<=1?E:O<0?(s.radius=u.radius,s.center.set(u.ellipseCenter0),Ka.ray_sphere(l,s)):O>1?(s.radius=u.radius,s.center.set(u.ellipseCenter1),Ka.ray_sphere(l,s)):0}}(),pa=function(){var e=Mn.create(),t={distance:1/0,doubleSided:!1,mode:Wr.ANY},i=0,n=function(e,t,n,r,a,o){e==Wr.CLOSEST?(i>t||0==i)&&(i=t,o&&(0==o.length?o.push({distance:t,vertexIndex0:n/3,vertexIndex1:r/3,vertexIndex2:a/3}):(o[0].distance=t,o[0].vertexIndex0=n/3,o[0].vertexIndex1=r/3,o[0].vertexIndex2=a/3))):(i=t,o&&o.push({distance:t,vertexIndex0:n/3,vertexIndex1:r/3,vertexIndex2:a/3}))};return function(r,a,o){if(i=0,0==a.geometricInfo.positions.length)return i;var s=void 0===o?t:o;if(sa(r,a.geometricInfo.boundingBox.min,a.geometricInfo.boundingBox.max)){var l=a.primitiveMode,u=a.geometricInfo;!function(t,i,r,a,o){if(r===exports.GFXPrimitiveMode.TRIANGLE_LIST)for(var s=i.length,l=0;l<s;l+=3){var u=3*i[l],c=3*i[l+1],h=3*i[l+2];Ii.set(e.a,t[u],t[u+1],t[u+2]),Ii.set(e.b,t[c],t[c+1],t[c+2]),Ii.set(e.c,t[h],t[h+1],t[h+2]);var p=Ka.ray_triangle(a,e,o.doubleSided);if(!(0==p||p>o.distance)&&(n(o.mode,p,u,c,h,o.result),o.mode==Wr.ANY))return p}else if(r===exports.GFXPrimitiveMode.TRIANGLE_STRIP)for(var _=i.length-2,f=0,d=0;d<_;d+=1){var m=3*i[d-f],v=3*i[d+f+1],y=3*i[d+2];Ii.set(e.a,t[m],t[m+1],t[m+2]),Ii.set(e.b,t[v],t[v+1],t[v+2]),Ii.set(e.c,t[y],t[y+1],t[y+2]),f=~f;var g=Ka.ray_triangle(a,e,o.doubleSided);if(!(0==g||g>o.distance)&&(n(o.mode,g,m,v,y,o.result),o.mode==Wr.ANY))return g}else if(r===exports.GFXPrimitiveMode.TRIANGLE_FAN){var x=i.length-1,b=3*i[0];Ii.set(e.a,t[b],t[b+1],t[b+2]);for(var T=1;T<x;T+=1){var S=3*i[T],E=3*i[T+1];Ii.set(e.b,t[S],t[S+1],t[S+2]),Ii.set(e.c,t[E],t[E+1],t[E+2]);var w=Ka.ray_triangle(a,e,o.doubleSided);if(!(0==w||w>o.distance)&&(n(o.mode,w,b,S,E,o.result),o.mode==Wr.ANY))return w}}}(u.positions,u.indices,l,r,s)}return i}}(),_a=(la=0,ua={distance:1/0,doubleSided:!1,mode:Wr.ANY},function(e,t,i){la=0;var n=void 0===i?ua:i,r=t.renderingSubMeshes.length,a=t.struct.minPosition,o=t.struct.maxPosition;if(a&&o&&!sa(e,a,o))return la;for(var s=0;s<r;s++){var l=t.renderingSubMeshes[s],u=pa(e,l,n);if(u)if(n.mode==Wr.CLOSEST)(0==la||la>u)&&(la=u,n.subIndices&&(n.subIndices[0]=s));else if(la=u,n.subIndices&&n.subIndices.push(s),n.mode==Wr.ANY)return u}return la&&n.mode==Wr.CLOSEST&&(n.result&&(n.result[0].distance=la,n.result.length=1),n.subIndices&&(n.subIndices.length=1)),la}),fa=function(){var e=0,t={distance:1/0,doubleSided:!1,mode:Wr.ANY},i=new Cn,n=new Ki;return function(r,a,o){e=0;var s=void 0===o?t:o,l=a.subModelNum,u=a.worldBounds;if(u&&!oa(r,u))return e;Cn.copy(i,r),a.node&&(Ki.invert(n,a.node.getWorldMatrix(n)),Ii.transformMat4(i.o,r.o,n),Ii.transformMat4Normal(i.d,r.d,n));for(var c=0;c<l;c++){var h=a.getSubModel(c).subMeshData,p=pa(i,h,s);if(p)if(s.mode==Wr.CLOSEST)(0==e||e>p)&&(e=p,s.subIndices&&(s.subIndices[0]=c));else if(e=p,s.subIndices&&s.subIndices.push(c),s.mode==Wr.ANY)return p}return e&&s.mode==Wr.CLOSEST&&(s.result&&(s.result[0].distance=e,s.result.length=1),s.subIndices&&(s.subIndices.length=1)),e}}(),da=function(){var e=new Ii(0,0,0);return function(t,i){Ii.subtract(e,t.e,t.s);var n=(i.d-Ii.dot(t.s,i.n))/Ii.dot(e,i.n);return n<0||n>1?0:n}}(),ma=function(){var e=new Ii(0,0,0),t=new Ii(0,0,0),i=new Ii(0,0,0),n=new Ii(0,0,0),r=new Ii(0,0,0),a=new Ii(0,0,0);return function(o,s,l){Ii.subtract(e,s.b,s.a),Ii.subtract(t,s.c,s.a),Ii.subtract(i,o.s,o.e),Ii.cross(r,e,t);var u=Ii.dot(i,r);if(u<=0)return 0;Ii.subtract(n,o.s,s.a);var c=Ii.dot(n,r);if(c<0||c>u)return 0;Ii.cross(a,i,n);var h=Ii.dot(t,a);if(h<0||h>u)return 0;var p=-Ii.dot(e,a);if(p<0||h+p>u)return 0;if(l){var _=1/u,f=1-(h*=_)-(p*=_);Ii.set(l,s.a.x*f+s.b.x*h+s.c.x*p,s.a.y*f+s.b.y*h+s.c.y*p,s.a.z*f+s.b.z*h+s.c.z*p)}return 1}}(),va=new Cn;function ya(e,t){va.o.set(e.s),Ii.subtract(va.d,e.e,e.s),va.d.normalize();var i=oa(va,t);return i<=e.length()?i:0}function ga(e,t){va.o.set(e.s),Ii.subtract(va.d,e.e,e.s),va.d.normalize();var i=ca(va,t);return i<=e.length()?i:0}function xa(e,t){va.o.set(e.s),Ii.subtract(va.d,e.e,e.s),va.d.normalize();var i=aa(va,t);return i<=e.length()?i:0}var ba,Ta,Sa,Ea,wa=(ba=new Ii,Ta=new Ii,Sa=new Ii,Ea=new Ii,function(e,t){return Ii.subtract(ba,e.center,e.halfExtents),Ii.add(Ta,e.center,e.halfExtents),Ii.subtract(Sa,t.center,t.halfExtents),Ii.add(Ea,t.center,t.halfExtents),ba.x<=Ea.x&&Ta.x>=Sa.x&&ba.y<=Ea.y&&Ta.y>=Sa.y&&ba.z<=Ea.z&&Ta.z>=Sa.z});function Ca(e,t,i,n,r,a){Ii.set(a[0],e.x+i.x*t.x+n.x*t.y+r.x*t.z,e.y+i.y*t.x+n.y*t.y+r.y*t.z,e.z+i.z*t.x+n.z*t.y+r.z*t.z),Ii.set(a[1],e.x-i.x*t.x+n.x*t.y+r.x*t.z,e.y-i.y*t.x+n.y*t.y+r.y*t.z,e.z-i.z*t.x+n.z*t.y+r.z*t.z),Ii.set(a[2],e.x+i.x*t.x-n.x*t.y+r.x*t.z,e.y+i.y*t.x-n.y*t.y+r.y*t.z,e.z+i.z*t.x-n.z*t.y+r.z*t.z),Ii.set(a[3],e.x+i.x*t.x+n.x*t.y-r.x*t.z,e.y+i.y*t.x+n.y*t.y-r.y*t.z,e.z+i.z*t.x+n.z*t.y-r.z*t.z),Ii.set(a[4],e.x-i.x*t.x-n.x*t.y-r.x*t.z,e.y-i.y*t.x-n.y*t.y-r.y*t.z,e.z-i.z*t.x-n.z*t.y-r.z*t.z),Ii.set(a[5],e.x+i.x*t.x-n.x*t.y-r.x*t.z,e.y+i.y*t.x-n.y*t.y-r.y*t.z,e.z+i.z*t.x-n.z*t.y-r.z*t.z),Ii.set(a[6],e.x-i.x*t.x+n.x*t.y-r.x*t.z,e.y-i.y*t.x+n.y*t.y-r.y*t.z,e.z-i.z*t.x+n.z*t.y-r.z*t.z),Ii.set(a[7],e.x-i.x*t.x-n.x*t.y+r.x*t.z,e.y-i.y*t.x-n.y*t.y+r.y*t.z,e.z-i.z*t.x-n.z*t.y+r.z*t.z)}function Aa(e,t){for(var i=Ii.dot(t,e[0]),n=i,r=1;r<8;++r){var a=Ii.dot(t,e[r]);i=a<i?a:i,n=a>n?a:n}return[i,n]}var Oa,ka,Ra,Fa=function(){for(var e=new Array(15),t=0;t<15;t++)e[t]=new Ii(0,0,0);for(var i=new Array(8),n=new Array(8),r=0;r<8;r++)i[r]=new Ii(0,0,0),n[r]=new Ii(0,0,0);var a=new Ii,o=new Ii;return function(t,r){Ii.set(e[0],1,0,0),Ii.set(e[1],0,1,0),Ii.set(e[2],0,0,1),Ii.set(e[3],r.orientation.m00,r.orientation.m01,r.orientation.m02),Ii.set(e[4],r.orientation.m03,r.orientation.m04,r.orientation.m05),Ii.set(e[5],r.orientation.m06,r.orientation.m07,r.orientation.m08);for(var s=0;s<3;++s)Ii.cross(e[6+3*s+0],e[s],e[0]),Ii.cross(e[6+3*s+1],e[s],e[1]),Ii.cross(e[6+3*s+1],e[s],e[2]);Ii.subtract(a,t.center,t.halfExtents),Ii.add(o,t.center,t.halfExtents),function(e,t,i){Ii.set(i[0],e.x,t.y,t.z),Ii.set(i[1],e.x,t.y,e.z),Ii.set(i[2],e.x,e.y,t.z),Ii.set(i[3],e.x,e.y,e.z),Ii.set(i[4],t.x,t.y,t.z),Ii.set(i[5],t.x,t.y,e.z),Ii.set(i[6],t.x,e.y,t.z),Ii.set(i[7],t.x,e.y,e.z)}(a,o,i),Ca(r.center,r.halfExtents,e[3],e[4],e[5],n);for(var l=0;l<15;++l){var u=Aa(i,e[l]),c=Aa(n,e[l]);if(c[0]>u[1]||u[0]>c[1])return 0}return 1}}(),Ma=function(e,t){var i=e.halfExtents.x*Math.abs(t.n.x)+e.halfExtents.y*Math.abs(t.n.y)+e.halfExtents.z*Math.abs(t.n.z),n=Ii.dot(t.n,e.center);return n+i<t.d?-1:n-i>t.d?0:1},Ia=function(e,t){for(var i=0;i<t.planes.length;i++)if(-1===Ma(e,t.planes[i]))return 0;return 1},Pa=function(){for(var e=new Array(8),t=0,i=0,n=0;n<e.length;n++)e[n]=new Ii(0,0,0);return function(n,r){for(var a=0,o=!1,s=0;s<r.planes.length;s++){if(-1===(a=Ma(n,r.planes[s])))return 0;1===a&&(o=!0)}if(!o)return 1;for(var l=0;l<r.vertices.length;l++)Ii.subtract(e[l],r.vertices[l],n.center);t=0,i=0;for(var u=0;u<r.vertices.length;u++)e[u].x>n.halfExtents.x?t++:e[u].x<-n.halfExtents.x&&i++;if(t===r.vertices.length||i===r.vertices.length)return 0;t=0,i=0;for(var c=0;c<r.vertices.length;c++)e[c].y>n.halfExtents.y?t++:e[c].y<-n.halfExtents.y&&i++;if(t===r.vertices.length||i===r.vertices.length)return 0;t=0,i=0;for(var h=0;h<r.vertices.length;h++)e[h].z>n.halfExtents.z?t++:e[h].z<-n.halfExtents.z&&i++;return t===r.vertices.length||i===r.vertices.length?0:1}}(),La=(Oa=new Ii(0,0,0),ka=new Bi,function(e,t){return Ii.subtract(Oa,t,e.center),Ii.transformMat3(Oa,Oa,Bi.transpose(ka,e.orientation)),i=Oa,n=e.halfExtents,Math.abs(i.x)<n.x&&Math.abs(i.y)<n.y&&Math.abs(i.z)<n.z;var i,n}),Da=(Ra=function(e,t,i,n){return Math.abs(e.x*t+e.y*i+e.z*n)},function(e,t){var i=e.halfExtents.x*Ra(t.n,e.orientation.m00,e.orientation.m01,e.orientation.m02)+e.halfExtents.y*Ra(t.n,e.orientation.m03,e.orientation.m04,e.orientation.m05)+e.halfExtents.z*Ra(t.n,e.orientation.m06,e.orientation.m07,e.orientation.m08),n=Ii.dot(t.n,e.center);return n+i<t.d?-1:n-i>t.d?0:1}),Na=function(e,t){for(var i=0;i<t.planes.length;i++)if(-1===Da(e,t.planes[i]))return 0;return 1},za=function(){for(var e=new Array(8),t=0,i=0,n=0,r=0;r<e.length;r++)e[r]=new Ii(0,0,0);var a=function(e,t,i,n){return e.x*t+e.y*i+e.z*n};return function(r,o){for(var s=0,l=!1,u=0;u<o.planes.length;u++){if(-1===(s=Da(r,o.planes[u])))return 0;1===s&&(l=!0)}if(!l)return 1;for(var c=0;c<o.vertices.length;c++)Ii.subtract(e[c],o.vertices[c],r.center);i=0,n=0;for(var h=0;h<o.vertices.length;h++)(t=a(e[h],r.orientation.m00,r.orientation.m01,r.orientation.m02))>r.halfExtents.x?i++:t<-r.halfExtents.x&&n++;if(i===o.vertices.length||n===o.vertices.length)return 0;i=0,n=0;for(var p=0;p<o.vertices.length;p++)(t=a(e[p],r.orientation.m03,r.orientation.m04,r.orientation.m05))>r.halfExtents.y?i++:t<-r.halfExtents.y&&n++;if(i===o.vertices.length||n===o.vertices.length)return 0;i=0,n=0;for(var _=0;_<o.vertices.length;_++)(t=a(e[_],r.orientation.m06,r.orientation.m07,r.orientation.m08))>r.halfExtents.z?i++:t<-r.halfExtents.z&&n++;return i===o.vertices.length||n===o.vertices.length?0:1}}(),Ba=function(){for(var e=new Array(15),t=0;t<15;t++)e[t]=new Ii(0,0,0);for(var i=new Array(8),n=new Array(8),r=0;r<8;r++)i[r]=new Ii(0,0,0),n[r]=new Ii(0,0,0);return function(t,r){Ii.set(e[0],t.orientation.m00,t.orientation.m01,t.orientation.m02),Ii.set(e[1],t.orientation.m03,t.orientation.m04,t.orientation.m05),Ii.set(e[2],t.orientation.m06,t.orientation.m07,t.orientation.m08),Ii.set(e[3],r.orientation.m00,r.orientation.m01,r.orientation.m02),Ii.set(e[4],r.orientation.m03,r.orientation.m04,r.orientation.m05),Ii.set(e[5],r.orientation.m06,r.orientation.m07,r.orientation.m08);for(var a=0;a<3;++a)Ii.cross(e[6+3*a+0],e[a],e[0]),Ii.cross(e[6+3*a+1],e[a],e[1]),Ii.cross(e[6+3*a+1],e[a],e[2]);Ca(t.center,t.halfExtents,e[0],e[1],e[2],i),Ca(r.center,r.halfExtents,e[3],e[4],e[5],n);for(var o=0;o<15;++o){var s=Aa(i,e[o]),l=Aa(n,e[o]);if(l[0]>s[1]||s[0]>l[1])return 0}return 1}}(),Ga=function(){for(var e=new Fn,t=new Ii,i=new Ii,n=new Ii,r=new Array(8),a=0;a<8;a++)r[a]=new Ii;for(var o=new Array(8),s=0;s<8;s++)o[s]=new Ii;return function(a,s){if(0===Ii.squaredDistance(s.ellipseCenter0,s.ellipseCenter1))return e.radius=s.radius,e.center.set(s.ellipseCenter0),Ka.sphere_obb(e,a);t.x=a.orientation.m00,t.y=a.orientation.m01,t.z=a.orientation.m02,i.x=a.orientation.m03,i.y=a.orientation.m04,i.z=a.orientation.m05,n.x=a.orientation.m06,n.y=a.orientation.m07,n.z=a.orientation.m08,Ca(a.center,a.halfExtents,t,i,n,r);var l=o,u=Ii.copy(l[0],t),c=Ii.copy(l[1],i),h=Ii.copy(l[2],n);Ii.subtract(l[3],s.center,a.center).normalize();var p=Ii.subtract(l[4],s.ellipseCenter0,s.ellipseCenter1);p.normalize(),Ii.cross(l[5],u,p),Ii.cross(l[6],c,p),Ii.cross(l[7],h,p);for(var _=0;_<8;++_){var f=Aa(r,l[_]),d=Ii.dot(l[_],s.ellipseCenter0),m=Ii.dot(l[_],s.ellipseCenter1),v=Math.max(d,m),y=Math.min(d,m)-s.radius,g=v+s.radius;if(y>f[1]||f[0]>g)return 0}return 1}}(),Ua=function(e,t){var i=Ii.dot(t.n,e.center),n=e.radius*t.n.length();return i+n<t.d?-1:i-n>t.d?0:1},Xa=function(e,t){for(var i=0;i<t.planes.length;i++)if(-1===Ua(e,t.planes[i]))return 0;return 1},Va=function(){var e=new Ii(0,0,0),t=[1,-1,1,-1,1,-1];return function(i,n){for(var r=0;r<6;r++){var a=n.planes[r],o=i.radius,s=i.center,l=a.n,u=a.d,c=Ii.dot(l,s);if(c+o<u)return 0;if(!(c-o>u)){Ii.add(e,s,Ii.multiplyScalar(e,l,o));for(var h=0;h<6;h++)if(h!==r&&h!==r+t[r]){var p=n.planes[h];if(Ii.dot(p.n,e)<p.d)return 0}}}return 1}}(),Ha=function(e,t){var i=e.radius+t.radius;return Ii.squaredDistance(e.center,t.center)<i*i},Wa=function(){var e=new Ii;return function(t,i){return Sn(e,t.center,i),Ii.squaredDistance(t.center,e)<t.radius*t.radius}}(),ja=function(){var e=new Ii;return function(t,i){return En(e,t.center,i),Ii.squaredDistance(t.center,e)<t.radius*t.radius}}(),qa=function(){var e=new Ii,t=new Ii;return function(i,n){var r=i.radius+n.radius,a=r*r,o=Ii.squaredDistance(n.ellipseCenter0,n.ellipseCenter1);if(0===o)return Ii.squaredDistance(i.center,n.center)<a;Ii.subtract(e,i.center,n.ellipseCenter0),Ii.subtract(t,n.ellipseCenter1,n.ellipseCenter0);var s=Ii.dot(e,t)/o;return s<0?Ii.squaredDistance(i.center,n.ellipseCenter0)<a:s>1?Ii.squaredDistance(i.center,n.ellipseCenter1)<a:(Ii.scaleAndAdd(e,n.ellipseCenter0,t,s),Ii.squaredDistance(i.center,e)<a)}}(),Ya=function(){var e=new Ii,t=new Ii,i=new Ii,n=new Ii,r=new Ii,a=new Ii;return function(o,s){var l,u,c,h,p=Ii.subtract(e,o.ellipseCenter1,o.ellipseCenter0),_=Ii.subtract(t,s.ellipseCenter1,s.ellipseCenter0),f=Ii.subtract(i,o.ellipseCenter0,s.ellipseCenter0),d=Ii.dot(p,p),m=Ii.dot(p,_),v=Ii.dot(_,_),y=Ii.dot(p,f),g=Ii.dot(_,f),x=d*v-m*m,b=x,T=x;x<ui?(u=0,b=1,h=g,T=v):(h=d*g-m*y,(u=m*g-v*y)<0?(u=0,h=g,T=v):u>b&&(u=b,h=g+m,T=v)),h<0?(h=0,-y<0?u=0:-y>d?u=b:(u=-y,b=d)):h>T&&(h=T,-y+m<0?u=0:-y+m>d?u=b:(u=-y+m,b=d)),l=Math.abs(u)<ui?0:u/b,c=Math.abs(h)<ui?0:h/T;var S=n;S.set(f),S.add(Ii.multiplyScalar(r,p,l)),S.subtract(Ii.multiplyScalar(a,_,c));var E=o.radius+s.radius;return S.lengthSqr()<E*E}}(),Ka={ray_sphere:aa,ray_aabb:oa,ray_obb:ca,ray_plane:na,ray_triangle:ra,ray_capsule:ha,ray_subMesh:pa,ray_mesh:_a,ray_model:fa,line_sphere:xa,line_aabb:ya,line_obb:ga,line_plane:da,line_triangle:ma,sphere_sphere:Ha,sphere_aabb:Wa,sphere_obb:ja,sphere_plane:Ua,sphere_frustum:Xa,sphere_frustum_accurate:Va,sphere_capsule:qa,aabb_aabb:wa,aabb_obb:Fa,aabb_plane:Ma,aabb_frustum:Ia,aabb_frustum_accurate:Pa,obb_obb:Ba,obb_plane:Da,obb_frustum:Na,obb_frustum_accurate:za,obb_point:La,obb_capsule:Ga,capsule_capsule:Ya,resolve:function(e,t){var i=arguments.length>2&&void 0!==arguments[2]?arguments[2]:null,n=e._type,r=t._type,a=this[n|r];return n<r?a(e,t,i):a(t,e,i)}};Ka[V.SHAPE_RAY|V.SHAPE_SPHERE]=aa,Ka[V.SHAPE_RAY|V.SHAPE_AABB]=oa,Ka[V.SHAPE_RAY|V.SHAPE_OBB]=ca,Ka[V.SHAPE_RAY|V.SHAPE_PLANE]=na,Ka[V.SHAPE_RAY|V.SHAPE_TRIANGLE]=ra,Ka[V.SHAPE_RAY|V.SHAPE_CAPSULE]=ha,Ka[V.SHAPE_LINE|V.SHAPE_SPHERE]=xa,Ka[V.SHAPE_LINE|V.SHAPE_AABB]=ya,Ka[V.SHAPE_LINE|V.SHAPE_OBB]=ga,Ka[V.SHAPE_LINE|V.SHAPE_PLANE]=da,Ka[V.SHAPE_LINE|V.SHAPE_TRIANGLE]=ma,Ka[V.SHAPE_SPHERE]=Ha,Ka[V.SHAPE_SPHERE|V.SHAPE_AABB]=Wa,Ka[V.SHAPE_SPHERE|V.SHAPE_OBB]=ja,Ka[V.SHAPE_SPHERE|V.SHAPE_PLANE]=Ua,Ka[V.SHAPE_SPHERE|V.SHAPE_FRUSTUM]=Xa,Ka[V.SHAPE_SPHERE|V.SHAPE_FRUSTUM_ACCURATE]=Va,Ka[V.SHAPE_SPHERE|V.SHAPE_CAPSULE]=qa,Ka[V.SHAPE_AABB]=wa,Ka[V.SHAPE_AABB|V.SHAPE_OBB]=Fa,Ka[V.SHAPE_AABB|V.SHAPE_PLANE]=Ma,Ka[V.SHAPE_AABB|V.SHAPE_FRUSTUM]=Ia,Ka[V.SHAPE_AABB|V.SHAPE_FRUSTUM_ACCURATE]=Pa,Ka[V.SHAPE_OBB]=Ba,Ka[V.SHAPE_OBB|V.SHAPE_PLANE]=Da,Ka[V.SHAPE_OBB|V.SHAPE_FRUSTUM]=Na,Ka[V.SHAPE_OBB|V.SHAPE_FRUSTUM_ACCURATE]=za,Ka[V.SHAPE_OBB|V.SHAPE_CAPSULE]=Ga,Ka[V.SHAPE_CAPSULE]=Ya;var Za=function(){function e(){var t=arguments.length>0&&void 0!==arguments[0]?arguments[0]:0,i=arguments.length>1&&void 0!==arguments[1]?arguments[1]:0,n=arguments.length>2&&void 0!==arguments[2]?arguments[2]:0,r=arguments.length>3&&void 0!==arguments[3]?arguments[3]:0,a=arguments.length>4&&void 0!==arguments[4]?arguments[4]:0,o=arguments.length>5&&void 0!==arguments[5]?arguments[5]:-1;Z(this,e),this.s=void 0,this.e=void 0,this._type=void 0,this._type=V.SHAPE_LINE,this.s=new Ii(t,i,n),this.e=new Ii(r,a,o)}return J(e,[{key:"type",get:function(){return this._type}}],[{key:"create",value:function(t,i,n,r,a,o){return new e(t,i,n,r,a,o)}},{key:"clone",value:function(t){return new e(t.s.x,t.s.y,t.s.z,t.e.x,t.e.y,t.e.z)}},{key:"copy",value:function(e,t){return Ii.copy(e.s,t.s),Ii.copy(e.e,t.e),e}},{key:"fromPoints",value:function(e,t,i){return Ii.copy(e.s,t),Ii.copy(e.e,i),e}},{key:"set",value:function(e,t,i,n,r,a,o){return e.s.x=t,e.s.y=i,e.s.z=n,e.e.x=r,e.e.y=a,e.e.z=o,e}},{key:"len",value:function(e){return Ii.distance(e.s,e.e)}}]),J(e,[{key:"length",value:function(){return Ii.distance(this.s,this.e)}}]),e}(),Qa=new Ii(0,0,0),Ja=new Ii(0,0,0),$a=cc.mat4(),eo=cc.v4(),to=function(){function e(){var t=arguments.length>0&&void 0!==arguments[0]?arguments[0]:0,i=arguments.length>1&&void 0!==arguments[1]?arguments[1]:1,n=arguments.length>2&&void 0!==arguments[2]?arguments[2]:0,r=arguments.length>3&&void 0!==arguments[3]?arguments[3]:0;Z(this,e),this.n=void 0,this.d=void 0,this._type=void 0,this._type=V.SHAPE_PLANE,this.n=new Ii(t,i,n),this.d=r}return J(e,[{key:"type",get:function(){return this._type}}],[{key:"create",value:function(t,i,n,r){return new e(t,i,n,r)}},{key:"clone",value:function(t){return new e(t.n.x,t.n.y,t.n.z,t.d)}},{key:"copy",value:function(e,t){return Ii.copy(e.n,t.n),e.d=t.d,e}},{key:"fromPoints",value:function(e,t,i,n){return Ii.subtract(Qa,i,t),Ii.subtract(Ja,n,t),Ii.normalize(e.n,Ii.cross(e.n,Qa,Ja)),e.d=Ii.dot(e.n,t),e}},{key:"set",value:function(e,t,i,n,r){return e.n.x=t,e.n.y=i,e.n.z=n,e.d=r,e}},{key:"fromNormalAndPoint",value:function(e,t,i){return Ii.copy(e.n,t),e.d=Ii.dot(t,i),e}},{key:"normalize",value:function(e,t){var i=t.n.length();return Ii.normalize(e.n,t.n),i>0&&(e.d=t.d/i),e}}]),J(e,[{key:"transform",value:function(e){Ki.invert($a,e),Ki.transpose($a,$a),Ni.set(eo,this.n.x,this.n.y,this.n.z,this.d),Ni.transformMat4(eo,eo,$a),Ii.set(this.n,eo.x,eo.y,eo.z),this.d=eo.w}}]),e}(),io=new Ii,no=new Ii,ro=new Ii,ao=new Ii,oo=new Bi,so=function(e,t,i){oo.m00=Math.abs(i.m00),oo.m01=Math.abs(i.m01),oo.m02=Math.abs(i.m02),oo.m03=Math.abs(i.m04),oo.m04=Math.abs(i.m05),oo.m05=Math.abs(i.m06),oo.m06=Math.abs(i.m08),oo.m07=Math.abs(i.m09),oo.m08=Math.abs(i.m10),Ii.transformMat3(e,t,oo)},lo=function(){function e(){var t=arguments.length>0&&void 0!==arguments[0]?arguments[0]:0,i=arguments.length>1&&void 0!==arguments[1]?arguments[1]:0,n=arguments.length>2&&void 0!==arguments[2]?arguments[2]:0,r=arguments.length>3&&void 0!==arguments[3]?arguments[3]:1,a=arguments.length>4&&void 0!==arguments[4]?arguments[4]:1,o=arguments.length>5&&void 0!==arguments[5]?arguments[5]:1;Z(this,e),this.center=void 0,this.halfExtents=void 0,this._type=void 0,this._type=V.SHAPE_AABB,this.center=new Ii(t,i,n),this.halfExtents=new Ii(r,a,o)}return J(e,[{key:"type",get:function(){return this._type}}],[{key:"create",value:function(t,i,n,r,a,o){return new e(t,i,n,r,a,o)}},{key:"clone",value:function(t){return new e(t.center.x,t.center.y,t.center.z,t.halfExtents.x,t.halfExtents.y,t.halfExtents.z)}},{key:"copy",value:function(e,t){return Ii.copy(e.center,t.center),Ii.copy(e.halfExtents,t.halfExtents),e}},{key:"fromPoints",value:function(e,t,i){return Ii.add(io,i,t),Ii.subtract(no,i,t),Ii.multiplyScalar(e.center,io,.5),Ii.multiplyScalar(e.halfExtents,no,.5),e}},{key:"set",value:function(e,t,i,n,r,a,o){return Ii.set(e.center,t,i,n),Ii.set(e.halfExtents,r,a,o),e}},{key:"merge",value:function(t,i,n){return Ii.subtract(io,i.center,i.halfExtents),Ii.subtract(no,n.center,n.halfExtents),Ii.add(ro,i.center,i.halfExtents),Ii.add(ao,n.center,n.halfExtents),Ii.max(ao,ro,ao),Ii.min(ro,io,no),e.fromPoints(t,ro,ao)}},{key:"transform",value:function(e,t,i){return Ii.transformMat4(e.center,t.center,i),so(e.halfExtents,t.halfExtents,i),e}}]),J(e,[{key:"getBoundary",value:function(e,t){Ii.subtract(e,this.center,this.halfExtents),Ii.add(t,this.center,this.halfExtents)}},{key:"transform",value:function(e,t,i,n,r){Ii.transformMat4(r.center,this.center,e),so(r.halfExtents,this.halfExtents,e)}},{key:"clone",value:function(){return e.clone(this)}},{key:"copy",value:function(t){return e.copy(this,t)}}]),e}(),uo=new Ii,co=new Ii,ho=new Bi,po=function(){function e(){var t=arguments.length>0&&void 0!==arguments[0]?arguments[0]:0,i=arguments.length>1&&void 0!==arguments[1]?arguments[1]:0,n=arguments.length>2&&void 0!==arguments[2]?arguments[2]:0,r=arguments.length>3&&void 0!==arguments[3]?arguments[3]:1,a=arguments.length>4&&void 0!==arguments[4]?arguments[4]:1,o=arguments.length>5&&void 0!==arguments[5]?arguments[5]:1,s=arguments.length>6&&void 0!==arguments[6]?arguments[6]:1,l=arguments.length>7&&void 0!==arguments[7]?arguments[7]:0,u=arguments.length>8&&void 0!==arguments[8]?arguments[8]:0,c=arguments.length>9&&void 0!==arguments[9]?arguments[9]:0,h=arguments.length>10&&void 0!==arguments[10]?arguments[10]:1,p=arguments.length>11&&void 0!==arguments[11]?arguments[11]:0,_=arguments.length>12&&void 0!==arguments[12]?arguments[12]:0,f=arguments.length>13&&void 0!==arguments[13]?arguments[13]:0,d=arguments.length>14&&void 0!==arguments[14]?arguments[14]:1;Z(this,e),this.center=void 0,this.halfExtents=void 0,this.orientation=void 0,this._type=void 0,this._type=V.SHAPE_OBB,this.center=new Ii(t,i,n),this.halfExtents=new Ii(r,a,o),this.orientation=new Bi(s,l,u,c,h,p,_,f,d)}return J(e,[{key:"type",get:function(){return this._type}}],[{key:"create",value:function(t,i,n,r,a,o,s,l,u,c,h,p,_,f,d){return new e(t,i,n,r,a,o,s,l,u,c,h,p,_,f,d)}},{key:"clone",value:function(t){return new e(t.center.x,t.center.y,t.center.z,t.halfExtents.x,t.halfExtents.y,t.halfExtents.z,t.orientation.m00,t.orientation.m01,t.orientation.m02,t.orientation.m03,t.orientation.m04,t.orientation.m05,t.orientation.m06,t.orientation.m07,t.orientation.m08)}},{key:"copy",value:function(e,t){return Ii.copy(e.center,t.center),Ii.copy(e.halfExtents,t.halfExtents),Bi.copy(e.orientation,t.orientation),e}},{key:"fromPoints",value:function(e,t,i){return Ii.multiplyScalar(e.center,Ii.add(uo,t,i),.5),Ii.multiplyScalar(e.halfExtents,Ii.subtract(co,i,t),.5),Bi.identity(e.orientation),e}},{key:"set",value:function(e,t,i,n,r,a,o,s,l,u,c,h,p,_,f,d){return Ii.set(e.center,t,i,n),Ii.set(e.halfExtents,r,a,o),Bi.set(e.orientation,s,l,u,c,h,p,_,f,d),e}}]),J(e,[{key:"getBoundary",value:function(e,t){!function(e,t,i){ho.m00=Math.abs(i.m00),ho.m01=Math.abs(i.m01),ho.m02=Math.abs(i.m02),ho.m03=Math.abs(i.m03),ho.m04=Math.abs(i.m04),ho.m05=Math.abs(i.m05),ho.m06=Math.abs(i.m06),ho.m07=Math.abs(i.m07),ho.m08=Math.abs(i.m08),Ii.transformMat3(e,t,ho)}(uo,this.halfExtents,this.orientation),Ii.subtract(e,this.center,uo),Ii.add(t,this.center,uo)}},{key:"transform",value:function(e,t,i,n,r){Ii.transformMat4(r.center,this.center,e),Bi.fromQuat(r.orientation,i),Ii.multiply(r.halfExtents,this.halfExtents,n)}},{key:"translateAndRotate",value:function(e,t,i){Ii.transformMat4(i.center,this.center,e),Bi.fromQuat(i.orientation,t)}},{key:"setScale",value:function(e,t){Ii.multiply(t.halfExtents,this.halfExtents,e)}}]),e}(),_o=function(){function e(){var t=arguments.length>0&&void 0!==arguments[0]?arguments[0]:.5,i=arguments.length>1&&void 0!==arguments[1]?arguments[1]:.5,n=arguments.length>2&&void 0!==arguments[2]?arguments[2]:1;Z(this,e),this._type=void 0,this.radius=void 0,this.halfHeight=void 0,this.axis=void 0,this.center=void 0,this.rotation=void 0,this.ellipseCenter0=void 0,this.ellipseCenter1=void 0,this._type=V.SHAPE_CAPSULE,this.radius=t,this.halfHeight=i,this.axis=n,this.center=new Ii,this.rotation=new Xi,this.ellipseCenter0=new Ii(0,i,0),this.ellipseCenter1=new Ii(0,-i,0),this.updateCache()}return J(e,[{key:"type",get:function(){return this._type}}]),J(e,[{key:"transform",value:function(e,t,i,n,r){var a=n,o=Ai(a);r.radius=this.radius*Math.abs(o);var s=(this.halfHeight+this.radius)*Math.abs(a.y)-r.radius;s<0&&(s=0),r.halfHeight=s,Ii.transformMat4(r.center,this.center,e),Xi.multiply(r.rotation,this.rotation,i),r.updateCache()}},{key:"updateCache",value:function(){this.updateLocalCenter(),Ii.transformQuat(this.ellipseCenter0,this.ellipseCenter0,this.rotation),Ii.transformQuat(this.ellipseCenter1,this.ellipseCenter1,this.rotation),this.ellipseCenter0.add(this.center),this.ellipseCenter1.add(this.center)}},{key:"updateLocalCenter",value:function(){var e=this.halfHeight;switch(this.axis){case 0:this.ellipseCenter0.set(e,0,0),this.ellipseCenter1.set(-e,0,0);break;case 1:this.ellipseCenter0.set(0,e,0),this.ellipseCenter1.set(0,-e,0);break;case 2:this.ellipseCenter0.set(0,0,e),this.ellipseCenter1.set(0,0,-e)}}}]),e}(),fo=new Array(8);fo[0]=new Ii(1,1,1),fo[1]=new Ii(-1,1,1),fo[2]=new Ii(-1,-1,1),fo[3]=new Ii(1,-1,1),fo[4]=new Ii(1,1,-1),fo[5]=new Ii(-1,1,-1),fo[6]=new Ii(-1,-1,-1),fo[7]=new Ii(1,-1,-1);var mo=function(){function e(){Z(this,e),this._type=void 0,this.planes=void 0,this.vertices=void 0,this._type=V.SHAPE_FRUSTUM,this.planes=new Array(6);for(var t=0;t<6;++t)this.planes[t]=to.create(0,0,0,0);this.vertices=new Array(8);for(var i=0;i<8;++i)this.vertices[i]=new Ii}return J(e,[{key:"accurate",set:function(e){this._type=e?V.SHAPE_FRUSTUM_ACCURATE:V.SHAPE_FRUSTUM}},{key:"type",get:function(){return this._type}}],[{key:"create",value:function(){return new e}},{key:"clone",value:function(t){return e.copy(new e,t)}},{key:"copy",value:function(e,t){e._type=t._type;for(var i=0;i<6;++i)to.copy(e.planes[i],t.planes[i]);for(var n=0;n<8;++n)Ii.copy(e.vertices[n],t.vertices[n]);return e}}]),J(e,[{key:"update",value:function(e,t){if(Ii.set(this.planes[0].n,e.m03+e.m00,e.m07+e.m04,e.m11+e.m08),this.planes[0].d=-(e.m15+e.m12),Ii.set(this.planes[1].n,e.m03-e.m00,e.m07-e.m04,e.m11-e.m08),this.planes[1].d=-(e.m15-e.m12),Ii.set(this.planes[2].n,e.m03+e.m01,e.m07+e.m05,e.m11+e.m09),this.planes[2].d=-(e.m15+e.m13),Ii.set(this.planes[3].n,e.m03-e.m01,e.m07-e.m05,e.m11-e.m09),this.planes[3].d=-(e.m15-e.m13),Ii.set(this.planes[4].n,e.m03+e.m02,e.m07+e.m06,e.m11+e.m10),this.planes[4].d=-(e.m15+e.m14),Ii.set(this.planes[5].n,e.m03-e.m02,e.m07-e.m06,e.m11-e.m10),this.planes[5].d=-(e.m15-e.m14),this._type===V.SHAPE_FRUSTUM_ACCURATE){for(var i=0;i<6;i++){var n=this.planes[i],r=1/n.n.length();Ii.multiplyScalar(n.n,n.n,r),n.d*=r}for(var a=0;a<8;a++)Ii.transformMat4(this.vertices[a],fo[a],t)}}},{key:"transform",value:function(e){if(this._type===V.SHAPE_FRUSTUM_ACCURATE){for(var t=0;t<8;t++)Ii.transformMat4(this.vertices[t],this.vertices[t],e);to.fromPoints(this.planes[0],this.vertices[1],this.vertices[5],this.vertices[6]),to.fromPoints(this.planes[1],this.vertices[3],this.vertices[7],this.vertices[4]),to.fromPoints(this.planes[2],this.vertices[6],this.vertices[7],this.vertices[3]),to.fromPoints(this.planes[3],this.vertices[0],this.vertices[4],this.vertices[5]),to.fromPoints(this.planes[4],this.vertices[2],this.vertices[3],this.vertices[0]),to.fromPoints(this.planes[0],this.vertices[7],this.vertices[6],this.vertices[5])}}}]),e}();mo.createOrtho=function(){var e=new Ii;return function(t,i,n,r,a,o){var s=i/2,l=n/2;Ii.set(e,s,l,r),Ii.transformMat4(t.vertices[0],e,o),Ii.set(e,-s,l,r),Ii.transformMat4(t.vertices[1],e,o),Ii.set(e,-s,-l,r),Ii.transformMat4(t.vertices[2],e,o),Ii.set(e,s,-l,r),Ii.transformMat4(t.vertices[3],e,o),Ii.set(e,s,l,a),Ii.transformMat4(t.vertices[4],e,o),Ii.set(e,-s,l,a),Ii.transformMat4(t.vertices[5],e,o),Ii.set(e,-s,-l,a),Ii.transformMat4(t.vertices[6],e,o),Ii.set(e,s,-l,a),Ii.transformMat4(t.vertices[7],e,o),to.fromPoints(t.planes[0],t.vertices[1],t.vertices[6],t.vertices[5]),to.fromPoints(t.planes[1],t.vertices[3],t.vertices[4],t.vertices[7]),to.fromPoints(t.planes[2],t.vertices[6],t.vertices[3],t.vertices[7]),to.fromPoints(t.planes[3],t.vertices[0],t.vertices[5],t.vertices[4]),to.fromPoints(t.planes[4],t.vertices[2],t.vertices[0],t.vertices[3]),to.fromPoints(t.planes[0],t.vertices[7],t.vertices[5],t.vertices[6])}}();var vo=xt({Default:0,Once:1,Loop:2,PingPong:3,ClampForever:4}),yo=function e(){Z(this,e),this.time=0,this.value=0,this.inTangent=0,this.outTangent=0};ni.fastDefine("cc.Keyframe",yo,{time:0,value:0,inTangent:0,outTangent:0});var go=function(){function e(){Z(this,e),this.index=void 0,this.time=void 0,this.endTime=void 0,this.coefficient=void 0,this.index=-1,this.time=0,this.endTime=0,this.coefficient=new Float32Array(4)}return J(e,[{key:"evaluate",value:function(e){return function(e,t){return e*(e*(e*t[0]+t[1])+t[2])+t[3]}(e-this.time,this.coefficient)}}]),e}();var xo=function(){function e(){var t=arguments.length>0&&void 0!==arguments[0]?arguments[0]:null;Z(this,e),this.keyFrames=void 0,this.preWrapMode=vo.Loop,this.postWrapMode=vo.Loop,this.cachedKey=void 0,this.keyFrames=t||[].concat(e.defaultKF),this.cachedKey=new go}return J(e,[{key:"addKey",value:function(e){null==this.keyFrames&&(this.keyFrames=[]),this.keyFrames.push(e)}},{key:"evaluate_slow",value:function(e){var t=e,i=e<0?this.preWrapMode:this.postWrapMode,n=this.keyFrames[0].time,r=this.keyFrames[this.keyFrames.length-1].time;switch(i){case vo.Loop:t=Ei(e-n,r-n)+n;break;case vo.PingPong:t=wi(e-n,r-n)+n;break;case vo.ClampForever:t=pi(e,n,r)}var a=0;if(t>this.keyFrames[0].time)if(t>=this.keyFrames[this.keyFrames.length-1].time)a=this.keyFrames.length-2;else for(var o=0;o<this.keyFrames.length-1;o++)if(t>=this.keyFrames[0].time&&t<=this.keyFrames[o+1].time){a=o;break}var s=this.keyFrames[a],l=this.keyFrames[a+1],u=Ci(s.time,l.time,t),c=l.time-s.time,h=s.outTangent*c,p=l.inTangent*c,_=u*u,f=_*u,d=f-2*_+u,m=f-_,v=-2*f+3*_;return(2*f-3*_+1)*s.value+d*h+m*p+v*l.value}},{key:"evaluate",value:function(e){var t=e,i=e<0?this.preWrapMode:this.postWrapMode,n=this.keyFrames[0].time,r=this.keyFrames[this.keyFrames.length-1].time;switch(i){case vo.Loop:t=Ei(e-n,r-n)+n;break;case vo.PingPong:t=wi(e-n,r-n)+n;break;case vo.ClampForever:t=pi(e,n,r)}if(t>=this.cachedKey.time&&t<this.cachedKey.endTime)return this.cachedKey.evaluate(t);var a=this.findIndex(this.cachedKey,t),o=a+1;return o===this.keyFrames.length&&(o-=1),this.calcOptimizedKey(this.cachedKey,a,o),this.cachedKey.evaluate(t)}},{key:"calcOptimizedKey",value:function(e,t,i){var n=this.keyFrames[t],r=this.keyFrames[i];e.index=t,e.time=n.time,e.endTime=r.time;var a=r.time-n.time,o=r.value-n.value,s=1/(a*a),l=n.outTangent*a,u=r.inTangent*a;e.coefficient[0]=(l+u-o-o)*s/a,e.coefficient[1]=(o+o+o-l-l-u)*s,e.coefficient[2]=n.outTangent,e.coefficient[3]=n.value}},{key:"findIndex",value:function(e,t){var i=e.index;if(-1!==i)if(t>this.keyFrames[i].time)for(var n=0;n<3;n++){var r=i+n;if(r+1<this.keyFrames.length&&this.keyFrames[r+1].time>t)return r}else for(var a=0;a<3;a++){var o=i-a;if(o>=0&&this.keyFrames[o-1].time<=t)return o-1}for(var s=0,l=this.keyFrames.length,u=Math.floor((s+l)/2);l-s>1;)this.keyFrames[u].time>=t?l=u:s=u+1,u=Math.floor((s+l)/2);return s}}]),e}();xo.defaultKF=[{time:0,value:1,inTangent:0,outTangent:0},{time:1,value:1,inTangent:0,outTangent:0}],ni.fastDefine("cc.AnimationCurve",xo,{preWrapMode:vo.Default,postWrapMode:vo.Default,keyFrames:[]}),exports.replaceProperty(Za.prototype,"line",[{name:"mag",newName:"len"},{name:"magnitude",newName:"len"}]),exports.removeProperty(Ka,"intersect",[{name:"line_quad"}]);var bo=Object.freeze({__proto__:null,distance:wn,enums:V,intersect:Ka,line:Za,plane:to,ray:Cn,triangle:Mn,sphere:Fn,aabb:lo,obb:po,capsule:_o,frustum:mo,Keyframe:yo,AnimationCurve:xo,get ERaycastMode(){return Wr}}),To=function(){function e(t,i){Z(this,e),this._fn=void 0,this._idx=void 0,this._frees=void 0,this._fn=t,this._idx=i-1,this._frees=new Array(i);for(var n=0;n<i;++n)this._frees[n]=t()}return J(e,[{key:"alloc",value:function(){this._idx<0&&this._expand(Math.round(1.2*this._frees.length)+1);var e=this._frees[this._idx];return this._frees.splice(this._idx),--this._idx,e}},{key:"free",value:function(e){++this._idx,this._frees[this._idx]=e}},{key:"clear",value:function(e){for(var t=0;t<=this._idx;t++)e&&e(this._frees[t]);this._frees.splice(0),this._idx=-1}},{key:"_expand",value:function(e){var t=this._frees;this._frees=new Array(e);for(var i=e-t.length,n=0;n<i;++n)this._frees[n]=this._fn();for(var r=i,a=0;r<e;++r,++a)this._frees[r]=t[a];this._idx+=i}}]),e}(),So=function(){function e(t,i){Z(this,e),this._fn=void 0,this._count=0,this._data=void 0,this._fn=t,this._data=new Array(i);for(var n=0;n<i;++n)this._data[n]=t()}return J(e,[{key:"reset",value:function(){this._count=0}},{key:"resize",value:function(e){if(e>this._data.length)for(var t=this._data.length;t<e;++t)this._data[t]=this._fn()}},{key:"add",value:function(){return this._count>=this._data.length&&this.resize(2*this._data.length),this._data[this._count++]}},{key:"removeAt",value:function(e){if(!(e>=this._count)){var t=this._count-1,i=this._data[e];this._data[e]=this._data[t],this._data[t]=i,this._count-=1}}},{key:"length",get:function(){return this._count}},{key:"data",get:function(){return this._data}}]),e}(),Eo=function(){function e(t,i){Z(this,e),this.array=void 0,this.length=0,this._compareFn=void 0,this.array=new Array(t),this.length=0,this._compareFn=void 0!==i?i:function(e,t){return e-t}}return J(e,[{key:"push",value:function(e){this.array[this.length++]=e}},{key:"pop",value:function(){return this.array[--this.length]}},{key:"get",value:function(e){return this.array[e]}},{key:"clear",value:function(){this.length=0}},{key:"sort",value:function(){this.array.length=this.length,this.array.sort(this._compareFn)}},{key:"concat",value:function(e){for(var t=0;t<e.length;++t)this.array[this.length++]=e[t]}},{key:"fastRemove",value:function(e){if(!(e>=this.length||e<0)){var t=--this.length;this.array[e]=this.array[t]}}},{key:"indexOf",value:function(e){return this.array.indexOf(e)}}]),e}(),wo=Object.freeze({__proto__:null,Pool:To,RecyclePool:So,CachedArray:Eo}),Co=/([a-zA-Z0-9ÄÖÜäöüßéèçàùêâîôûа-яА-ЯЁё]+|\S)/,Ao=/^[!,.:;'}\]%\?>、‘“》？。，！]/,Oo=/([a-zA-Z0-9ÄÖÜäöüßéèçàùêâîôûаíìÍÌïÁÀáàÉÈÒÓòóŐőÙÚŰúűñÑæÆœŒÃÂãÔõěščřžýáíéóúůťďňĚŠČŘŽÁÍÉÓÚŤżźśóńłęćąŻŹŚÓŃŁĘĆĄ-яА-ЯЁё]+|\S)$/,ko=/[a-zA-Z0-9ÄÖÜäöüßéèçàùêâîôûаíìÍÌïÁÀáàÉÈÒÓòóŐőÙÚŰúűñÑæÆœŒÃÂãÔõěščřžýáíéóúůťďňĚŠČŘŽÁÍÉÓÚŤżźśóńłęćąŻŹŚÓŃŁĘĆĄ-яА-ЯЁё]+$/,Ro=/^[a-zA-Z0-9ÄÖÜäöüßéèçàùêâîôûаíìÍÌïÁÀáàÉÈÒÓòóŐőÙÚŰúűñÑæÆœŒÃÂãÔõěščřžýáíéóúůťďňĚŠČŘŽÁÍÉÓÚŤżźśóńłęćąŻŹŚÓŃŁĘĆĄ-яА-ЯЁё]/;function Fo(e){return/^[\u4E00-\u9FFF\u3400-\u4DFF]+$/.test(e)||/[\u3000-\u303F]|[\u3040-\u309F]|[\u30A0-\u30FF]|[\uFF00-\uFFEF]|[\u4E00-\u9FAF]|[\u2605-\u2606]|[\u2190-\u2195]|\u203B/g.test(e)||/^[\u1100-\u11FF]|[\u3130-\u318F]|[\uA960-\uA97F]|[\uAC00-\uD7AF]|[\uD7B0-\uD7FF]+$/.test(e)}function Mo(e){var t=e.charCodeAt(0);return t>=9&&t<=13||32===t||133===t||160===t||5760===t||t>=8192&&t<=8202||8232===t||8233===t||8239===t||8287===t||12288===t}function Io(e,t){var i=e.measureText(t);return i&&i.width||0}function Po(e,t,i,n){var r=[];if(0===e.length||i<0)return r.push(""),r;for(var a=e;t>i&&a.length>1;){for(var o=a.length*(i/t)|0,s=a.substr(o),l=t-n(s),u=s,c=0,h=0;l>i&&h++<10;)o*=i/l,o|=0,l=t-n(s=a.substr(o));for(h=0;l<=i&&h++<10;){if(s){var p=Co.exec(s);c=p?p[0].length:1,u=s}o+=c,l=t-n(s=a.substr(o))}0===(o-=c)&&(o=1,u=u.substr(1));var _=a.substr(0,o),f=void 0;Ao.test(u||s)&&(0===(o-=(f=Oo.exec(_))?f[0].length:0)&&(o=1),u=a.substr(o),_=a.substr(0,o)),Ro.test(u)&&(f=ko.exec(_))&&_!==f[0]&&(o-=f[0].length,u=a.substr(o),_=a.substr(0,o)),(0===r.length||(_=_.trim()).length>0)&&r.push(_),t=n(a=u||s)}return(0===r.length||(a=a.trim()).length>0)&&r.push(a),r}var Lo=/^(click)(\s)*=|(param)(\s)*=/,Do=/(\s)*src(\s)*=|(\s)*height(\s)*=|(\s)*width(\s)*=|(\s)*click(\s)*=|(\s)*param(\s)*=/,No=function(){function e(){Z(this,e),this._specialSymbolArray=[],this._stack=[],this._resultObjectArray=[],this._specialSymbolArray.push([/&lt;/g,"<"]),this._specialSymbolArray.push([/&gt;/g,">"]),this._specialSymbolArray.push([/&amp;/g,"&"]),this._specialSymbolArray.push([/&quot;/g,'"']),this._specialSymbolArray.push([/&apos;/g,"'"])}return J(e,[{key:"parse",value:function(e){this._resultObjectArray.length=0,this._stack.length=0;for(var t=0,i=e.length;t<i;){var n=e.indexOf("<",t);if(n<0)this._stack.pop(),this._processResult(e.substring(t)),t=i;else{this._processResult(e.substring(t,n));var r=e.indexOf(">",t);-1===r?r=n:"/"===e.charAt(n+1)?this._stack.pop():this._addToStack(e.substring(n+1,r)),t=r+1}}return this._resultObjectArray}},{key:"_attributeToObject",value:function(e){var t={},i=(e=e.trim()).match(/^(color|size)(\s)*=/),n="",r=0,a="";if(i){if(n=i[0],""===(e=e.substring(n.length).trim()))return t;switch(r=e.indexOf(" "),n[0]){case"c":t.color=r>-1?e.substring(0,r).trim():e;break;case"s":t.size=parseInt(e)}return r>-1&&(a=e.substring(r+1).trim(),t.event=this._processEventHandler(a)),t}if((i=e.match(/^(br(\s)*\/)/))&&i[0].length>0&&(n=i[0].trim()).startsWith("br")&&"/"===n[n.length-1])return t.isNewLine=!0,this._resultObjectArray.push({text:"",style:{newline:!0}}),t;var o="";if((i=e.match(/^(img(\s)*src(\s)*=[^>]+\/)/))&&i[0].length>0&&(n=i[0].trim()).startsWith("img")&&"/"===n[n.length-1]){var s;i=e.match(Do);for(var l=!1;i;)n=(e=e.substring(e.indexOf(i[0]))).substr(0,i[0].length),s=(r=(o=e.substring(n.length).trim()).indexOf(" "))>-1?o.substr(0,r):o,n=(n=n.replace(/[^a-zA-Z]/g,"").trim()).toLocaleLowerCase(),e=o.substring(r).trim(),"src"===n?(t.isImage=!0,s.endsWith("/")&&(s=s.substring(0,s.length-1)),(0===s.indexOf("'")||0===s.indexOf('"'))&&(l=!0,s=s.substring(1,s.length-1)),t.src=s):"height"===n?t.imageHeight=parseInt(s):"width"===n?t.imageWidth=parseInt(s):"click"===n&&(t.event=this._processEventHandler(n+"="+s)),t.event&&"param"===n&&(t.event[n]=s.replace(/^\"|\"$/g,"")),i=e.match(Do);return l&&t.isImage&&this._resultObjectArray.push({text:"",style:t}),{}}if(i=e.match(/^(outline(\s)*[^>]*)/)){var u={color:"#ffffff",width:1};if(e=i[0].substring("outline".length).trim()){var c,h=/(\s)*color(\s)*=|(\s)*width(\s)*=|(\s)*click(\s)*=|(\s)*param(\s)*=/;for(i=e.match(h);i;)n=(e=e.substring(e.indexOf(i[0]))).substr(0,i[0].length),c=(r=(o=e.substring(n.length).trim()).indexOf(" "))>-1?o.substr(0,r):o,n=(n=n.replace(/[^a-zA-Z]/g,"").trim()).toLocaleLowerCase(),e=o.substring(r).trim(),"click"===n?t.event=this._processEventHandler(n+"="+c):"color"===n?u.color=c:"width"===n&&(u.width=parseInt(c)),t.event&&"param"===n&&(t.event[n]=c.replace(/^\"|\"$/g,"")),i=e.match(h)}t.outline=u}if((i=e.match(/^(on|u|b|i)(\s)*/))&&i[0].length>0){switch(n=i[0],e=e.substring(n.length).trim(),n[0]){case"u":t.underline=!0;break;case"i":t.italic=!0;break;case"b":t.bold=!0}if(""===e)return t;t.event=this._processEventHandler(e)}return t}},{key:"_processEventHandler",value:function(e){for(var t=0,i=new Map,n=e.match(Lo),r=!1;n;){var a=n[0],o="";if(r=!1,'"'===(e=e.substring(a.length).trim()).charAt(0))(t=e.indexOf('"',1))>-1&&(o=e.substring(1,t).trim(),r=!0),t++;else if("'"===e.charAt(0))(t=e.indexOf("'",1))>-1&&(o=e.substring(1,t).trim(),r=!0),t++;else{var s=e.match(/(\S)+/);t=(o=s?s[0]:"").length}r&&(i[a=a.substring(0,a.length-1).trim()]=o),n=(e=e.substring(t).trim()).match(Lo)}return i}},{key:"_addToStack",value:function(e){var t=this._attributeToObject(e);if(0===this._stack.length)this._stack.push(t);else{if(t.isNewLine||t.isImage)return;var i=this._stack[this._stack.length-1];for(var n in i)t[n]||(t[n]=i[n]);this._stack.push(t)}}},{key:"_processResult",value:function(e){0!==e.length&&(e=this._escapeSpecialSymbol(e),this._stack.length>0?this._resultObjectArray.push({text:e,style:this._stack[this._stack.length-1]}):this._resultObjectArray.push({text:e}))}},{key:"_escapeSpecialSymbol",value:function(e){for(var t,i=_e(this._specialSymbolArray);!(t=i()).done;){var n=t.value,r=n[0],a=n[1];e=e.replace(r,a)}return e}}]),e}();function zo(e){return e}function Bo(e,t){return e[t]||(e[t]={})}function Go(e){return function(t){return"function"==typeof t?e(t):function(i){return e(i,t)}}}function Uo(e,t,i){return function(e){return function(i){return t(i,e)}}}var Xo=Uo.bind(null,!1);function Vo(e){return Uo.bind(null,!1)}var Ho=Vo(),Wo=Vo();function jo(e,t){return Bo(e,"__ccclassCache__")}function qo(e,t,i,n,r,a){var o;n&&(o=(o=Gt(n))||n);var s=Ue(t[i]||{},o||{});if(r&&(r.get||r.set))r.get&&(s.get=r.get),r.set&&(s.set=r.set);else{var l;if(r)r.initializer&&(l=function(e){var t;try{t=e()}catch(t){return e}return"object"!==K(t)||null===t?t:e}(r.initializer));else{var u=a.default||(a.default=function(e){var t;try{t=new e}catch(e){return{}}return t}(e));u.hasOwnProperty(i)&&(l=u[i])}s.default=l}t[i]=s}var Yo=Go((function(e,t){var i=Ve(e);i===Object&&(i=null);var n={name:t,extends:i,ctor:e,__ES6__:!0},r=e.__ccclassCache__;if(r){var a=r.proto;a&&Ue(n,a),e.__ccclassCache__=void 0}return cc.Class(n)}));function Ko(e,t,i){var n=null;function r(e,t,i){var r=jo(e.constructor);if(r){var a=Bo(r,"proto"),o=Bo(a,"properties");qo(e.constructor,o,t,n,i,r)}}return void 0===e?Ko({type:void 0}):void 0===t?(n=e,r):void r(e,t,i)}function Zo(e,t,i){return e((function(e,n){var r=jo(e);if(r){var a=void 0!==i?i:n,o=Bo(r,"proto");Bo(o,"editor")[t]=a}}),t)}function Qo(e){return e(zo)}var Jo=Qo(Go),$o=Zo(Xo,"requireComponent"),es=Qo(Ho),ts=Zo(Wo,"executionOrder"),is=Qo(Go),ns=Qo(Go),rs=Qo(Ho),as=Qo(Ho),os=Qo(Ho),ss=hs(Rt),ls=hs(Ft),us=hs(Mt),cs=hs(It);function hs(e){return Ko({type:e})}var ps,_s,fs,ds,ms,vs,ys,gs=Object.freeze({__proto__:null,ccclass:Yo,property:Ko,executeInEditMode:Jo,requireComponent:$o,menu:es,executionOrder:ts,disallowMultiple:is,playOnFocus:ns,inspector:rs,icon:as,help:os,integer:ss,float:ls,boolean:us,string:cs,type:hs}),xs=Yo("cc.PrefabInfo")((fs=de((_s=function e(){Z(this,e),fe(this,"root",fs,this),fe(this,"asset",ds,this),fe(this,"fileId",ms,this),fe(this,"sync",vs,this),fe(this,"_synced",ys,this)}).prototype,"root",[Ko],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return null}}),ds=de(_s.prototype,"asset",[Ko],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return null}}),ms=de(_s.prototype,"fileId",[Ko],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return""}}),vs=de(_s.prototype,"sync",[Ko],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return!1}}),ys=de(_s.prototype,"_synced",[Ko],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return{default:!1,serializable:!1}}}),ps=_s))||ps;cc._PrefabInfo=xs;var bs,Ts="undefined"==typeof window?global:window;!function(e){e[e.NONE=0]="NONE",e[e.LAN=1]="LAN",e[e.WWAN=2]="WWAN"}(bs||(bs={}));var Ss,Es,ws,Cs={NetworkType:bs,LANGUAGE_ENGLISH:"en",LANGUAGE_CHINESE:"zh",LANGUAGE_FRENCH:"fr",LANGUAGE_ITALIAN:"it",LANGUAGE_GERMAN:"de",LANGUAGE_SPANISH:"es",LANGUAGE_DUTCH:"du",LANGUAGE_RUSSIAN:"ru",LANGUAGE_KOREAN:"ko",LANGUAGE_JAPANESE:"ja",LANGUAGE_HUNGARIAN:"hu",LANGUAGE_PORTUGUESE:"pt",LANGUAGE_ARABIC:"ar",LANGUAGE_NORWEGIAN:"no",LANGUAGE_POLISH:"pl",LANGUAGE_TURKISH:"tr",LANGUAGE_UKRAINIAN:"uk",LANGUAGE_ROMANIAN:"ro",LANGUAGE_BULGARIAN:"bg",LANGUAGE_UNKNOWN:"unknown",OS_IOS:"iOS",OS_ANDROID:"Android",OS_WINDOWS:"Windows",OS_LINUX:"Linux",OS_OSX:"OS X",OS_UNKNOWN:"Unknown",UNKNOWN:-1,WIN32:0,LINUX:1,MACOS:2,ANDROID:3,IPHONE:4,IPAD:5,BLACKBERRY:6,NACL:7,EMSCRIPTEN:8,TIZEN:9,WINRT:10,WP8:11,MOBILE_BROWSER:100,DESKTOP_BROWSER:101,EDITOR_PAGE:102,EDITOR_CORE:103,WECHAT_GAME:104,QQ_PLAY:105,BROWSER_TYPE_WECHAT:"wechat",BROWSER_TYPE_COCOSPLAY:"cocosplay",BROWSER_TYPE_ANDROID:"androidbrowser",BROWSER_TYPE_IE:"ie",BROWSER_TYPE_QQ:"qqbrowser",BROWSER_TYPE_MOBILE_QQ:"mqqbrowser",BROWSER_TYPE_UC:"ucbrowser",BROWSER_TYPE_UCBS:"ucbs",BROWSER_TYPE_360:"360browser",BROWSER_TYPE_BAIDU_APP:"baiduboxapp",BROWSER_TYPE_BAIDU:"baidubrowser",BROWSER_TYPE_MAXTHON:"maxthon",BROWSER_TYPE_OPERA:"opera",BROWSER_TYPE_OUPENG:"oupeng",BROWSER_TYPE_MIUI:"miuibrowser",BROWSER_TYPE_FIREFOX:"firefox",BROWSER_TYPE_SAFARI:"safari",BROWSER_TYPE_CHROME:"chrome",BROWSER_TYPE_LIEBAO:"liebao",BROWSER_TYPE_QZONE:"qzone",BROWSER_TYPE_SOUGOU:"sogou",BROWSER_TYPE_UNKNOWN:"unknown",isNative:!1,isBrowser:"object"===("undefined"==typeof window?"undefined":K(window))&&"object"===("undefined"==typeof document?"undefined":K(document))&&!1,isMobile:!1,isLittleEndian:(Ss=new ArrayBuffer(2),new DataView(Ss).setInt16(0,256,!0),256===new Int16Array(Ss)[0]),platform:-1,language:"unknown",os:"Unknown",osVersion:"",osMainVersion:0,browserType:"unknown",browserVersion:"",windowPixelResolution:null,capabilities:null,localStorage:null,__audioSupport:null,getNetworkType:function(){return bs.LAN},getBatteryLevel:function(){return 1},garbageCollect:function(){},isObjectValid:function(e){return null!=e},dump:function(){var e="";e+="isMobile : "+this.isMobile+"\r\n",e+="language : "+this.language+"\r\n",e+="browserType : "+this.browserType+"\r\n",e+="browserVersion : "+this.browserVersion+"\r\n",e+="capabilities : "+JSON.stringify(this.capabilities)+"\r\n",e+="os : "+this.os+"\r\n",e+="osVersion : "+this.osVersion+"\r\n",e+="platform : "+this.platform+"\r\n",e+="Using "+(cc.game.renderType===cc.game.RENDER_TYPE_WEBGL?"WEBGL":"CANVAS")+" renderer.\r\n",cc.log(e)},openURL:function(e){window.open(e)},now:function(){return Date.now?Date.now():+new Date},dumpRoot:function(){},restartVM:function(){},cleanScript:function(e){}};if(Ts.__globalAdapter&&Ts.__globalAdapter.adaptSys)Ts.__globalAdapter.adaptSys(Cs);else{var As=window,Os=As.navigator,ks=document,Rs=ks.documentElement,Fs=Os.userAgent.toLowerCase();Cs.isMobile=/mobile|android|iphone|ipad/.test(Fs),Cs.platform=Cs.isMobile?Cs.MOBILE_BROWSER:Cs.DESKTOP_BROWSER;var Ms=Os.language;Ms=(Ms=Ms||Os.browserLanguage)?Ms.split("-")[0]:Cs.LANGUAGE_ENGLISH,Cs.language=Ms;var Is=!1,Ps=!1,Ls="",Ds=0,Ns=/android\s*(\d+(?:\.\d+)*)/i.exec(Fs)||/android\s*(\d+(?:\.\d+)*)/i.exec(Os.platform);Ns&&(Is=!0,Ls=Ns[1]||"",Ds=parseInt(Ls)||0),(Ns=/(iPad|iPhone|iPod).*OS ((\d+_?){2,3})/i.exec(Fs))?(Ps=!0,Ls=Ns[2]||"",Ds=parseInt(Ls)||0):(/(iPhone|iPad|iPod)/.exec(Os.platform)||"MacIntel"===Os.platform&&Os.maxTouchPoints&&Os.maxTouchPoints>1)&&(Ps=!0,Ls="",Ds=0);var zs=Cs.OS_UNKNOWN;-1!==Os.appVersion.indexOf("Win")?zs=Cs.OS_WINDOWS:Ps?zs=Cs.OS_IOS:-1!==Os.appVersion.indexOf("Mac")?zs=Cs.OS_OSX:-1!==Os.appVersion.indexOf("X11")&&-1===Os.appVersion.indexOf("Linux")?zs=Cs.OS_UNIX:Is?zs=Cs.OS_ANDROID:-1===Os.appVersion.indexOf("Linux")&&-1===Fs.indexOf("ubuntu")||(zs=Cs.OS_LINUX),Cs.os=zs,Cs.osVersion=Ls,Cs.osMainVersion=Ds,Cs.browserType=Cs.BROWSER_TYPE_UNKNOWN,function(){var e=/mqqbrowser|micromessenger|qq|sogou|qzone|liebao|maxthon|ucbs|360 aphone|360browser|baiduboxapp|baidubrowser|maxthon|mxbrowser|miuibrowser/i.exec(Fs);e||(e=/qqbrowser|ucbrowser/i.exec(Fs)),e||(e=/chrome|safari|firefox|trident|opera|opr\/|oupeng/i.exec(Fs));var t=e?e[0].toLowerCase():Cs.BROWSER_TYPE_UNKNOWN;"micromessenger"===t?t=Cs.BROWSER_TYPE_WECHAT:"safari"===t&&Is||"qq"===t&&Fs.match(/android.*applewebkit/i)?t=Cs.BROWSER_TYPE_ANDROID:"trident"===t?t=Cs.BROWSER_TYPE_IE:"360 aphone"===t?t=Cs.BROWSER_TYPE_360:"mxbrowser"===t?t=Cs.BROWSER_TYPE_MAXTHON:"opr/"===t&&(t=Cs.BROWSER_TYPE_OPERA),Cs.browserType=t}(),Cs.browserVersion="",function(){var e=Fs.match(/(mqqbrowser|micromessenger|qq|sogou|qzone|liebao|maxthon|uc|ucbs|360 aphone|360|baiduboxapp|baidu|maxthon|mxbrowser|miui)(mobile)?(browser)?\/?([\d.]+)/i);e||(e=Fs.match(/(qqbrowser|chrome|safari|firefox|trident|opera|opr\/|oupeng)(mobile)?(browser)?\/?([\d.]+)/i)),Cs.browserVersion=e?e[4]:""}();var Bs=window.innerWidth||document.documentElement.clientWidth,Gs=window.innerHeight||document.documentElement.clientHeight,Us=window.devicePixelRatio||1;Cs.windowPixelResolution={width:Us*Bs,height:Us*Gs};var Xs=document.createElement("canvas");try{var Vs=Cs.localStorage=As.localStorage;Vs.setItem("storage",""),Vs.removeItem("storage"),Vs=null}catch(bn){var Hs=function(){cc.warnID(5200)};Cs.localStorage={getItem:Hs,setItem:Hs,removeItem:Hs,clear:Hs}}var Ws=Xs.toDataURL("image/webp").startsWith("data:image/webp"),js=!!Xs.getContext("2d");!0;var qs,Ys=Cs.capabilities={canvas:js,opengl:!0,webp:Ws};(void 0!==Rs.ontouchstart||void 0!==ks.ontouchstart||Os.msPointerEnabled)&&(Ys.touches=!0),void 0!==Rs.onmouseup&&(Ys.mouse=!0),void 0!==Rs.onkeyup&&(Ys.keyboard=!0),(As.DeviceMotionEvent||As.DeviceOrientationEvent)&&(Ys.accelerometer=!0),qs={ONLY_ONE:!1,WEB_AUDIO:!1,DELAY_CREATE_CTX:!1},Cs.os===Cs.OS_IOS&&(qs.USE_LOADER_EVENT="loadedmetadata"),Cs.browserType===Cs.BROWSER_TYPE_FIREFOX&&(qs.DELAY_CREATE_CTX=!0,qs.USE_LOADER_EVENT="canplay"),Cs.os===Cs.OS_ANDROID&&Cs.browserType===Cs.BROWSER_TYPE_UC&&(qs.ONE_SOURCE=!0);try{qs.WEB_AUDIO&&(qs._context=null,Object.defineProperty(qs,"context",{get:function(){return this._context?this._context:this._context=new(window.AudioContext||window.webkitAudioContext||window.mozAudioContext)}}))}catch(h){qs.WEB_AUDIO=!1,cc.logID(5201)}var Ks=[];(Es=document.createElement("audio")).canPlayType&&(Es.canPlayType('audio/ogg; codecs="vorbis"')&&Ks.push(".ogg"),Es.canPlayType("audio/mpeg")&&Ks.push(".mp3"),Es.canPlayType('audio/wav; codecs="1"')&&Ks.push(".wav"),Es.canPlayType("audio/mp4")&&Ks.push(".mp4"),Es.canPlayType("audio/x-m4a")&&Ks.push(".m4a")),qs.format=Ks,Cs.__audioSupport=qs}cc.sys=Cs;var Zs=($(ws={},exports.GFXFormatType.UNORM,"Uint"),$(ws,exports.GFXFormatType.SNORM,"Int"),$(ws,exports.GFXFormatType.UINT,"Uint"),$(ws,exports.GFXFormatType.INT,"Int"),$(ws,exports.GFXFormatType.UFLOAT,"Float"),$(ws,exports.GFXFormatType.FLOAT,"Float"),$(ws,"default","Uint"),ws);function Qs(e){return(Zs[e.type]||Zs.default)+e.size/e.count*8}function Js(e,t){var i=arguments.length>2&&void 0!==arguments[2]?arguments[2]:exports.GFXFormat.R32F,n=arguments.length>3&&void 0!==arguments[3]?arguments[3]:0,r=arguments.length>4&&void 0!==arguments[4]?arguments[4]:0,a=yr[i];r||(r=a.size);for(var o="set"+Qs(a),s=a.size/a.count,l=Math.floor(t.length/a.count),u=Cs.isLittleEndian,c=0;c<l;++c)for(var h=n+r*c,p=0;p<a.count;++p){var _=h+s*p;e[o](_,t[a.count*c+p],u)}}function $s(e){var t=arguments.length>1&&void 0!==arguments[1]?arguments[1]:exports.GFXFormat.R32F,i=arguments.length>2&&void 0!==arguments[2]?arguments[2]:0,n=arguments.length>3&&void 0!==arguments[3]?arguments[3]:e.byteLength-i,r=arguments.length>4&&void 0!==arguments[4]?arguments[4]:0,a=arguments.length>5&&void 0!==arguments[5]?arguments[5]:[],o=yr[t];r||(r=o.size);for(var s="get"+Qs(o),l=o.size/o.count,u=Math.floor(n/r),c=Cs.isLittleEndian,h=0;h<u;++h)for(var p=i+r*h,_=0;_<o.count;++_){var f=p+l*_;a[o.count*h+_]=e[s](f,c)}return a}function el(e,t){var i=arguments.length>2&&void 0!==arguments[2]?arguments[2]:exports.GFXFormat.R32F,n=arguments.length>3&&void 0!==arguments[3]?arguments[3]:0,r=arguments.length>4&&void 0!==arguments[4]?arguments[4]:e.byteLength-n,a=arguments.length>5&&void 0!==arguments[5]?arguments[5]:0,o=arguments.length>6?arguments[6]:void 0;o||(o=new DataView(e.buffer.slice(e.byteOffset,e.byteOffset+e.byteLength)));var s=yr[i];a||(a=s.size);for(var l="set"+Qs(s),u="get"+Qs(s),c=s.size/s.count,h=Math.floor(r/a),p=Cs.isLittleEndian,_=0;_<h;++_)for(var f=n+a*_,d=0;d<s.count;++d){var m=f+c*d,v=e[u](m,p);o[l](m,t(v,d,e),p)}return o}var tl=function(){function e(){Z(this,e),this._arrayBufferOrPaddings=[],this._length=0}return J(e,[{key:"setNextAlignment",value:function(e){if(0!==e){var t=this._length%e;if(0!==t){var i=e-t;this._arrayBufferOrPaddings.push(i),this._length+=i}}}},{key:"addBuffer",value:function(e){var t=this._length;return this._arrayBufferOrPaddings.push(e),this._length+=e.byteLength,t}},{key:"getLength",value:function(){return this._length}},{key:"getCombined",value:function(){var e=new Uint8Array(this._length),t=0;return this._arrayBufferOrPaddings.forEach((function(i){"number"==typeof i?t+=i:(e.set(new Uint8Array(i),t),t+=i.byteLength)})),e.buffer}}]),e}(),il=String.prototype.charCodeAt;function nl(e){return this[e]}function rl(e,t){for(var i=e.length,n=t^i,r=0,a="string"==typeof e?il:nl;i>=4;){var o=255&a.call(e,r)|(255&a.call(e,++r))<<8|(255&a.call(e,++r))<<16|(255&a.call(e,++r))<<24;o=1540483477*(65535&o)+((1540483477*(o>>>16)&65535)<<16),n=1540483477*(65535&n)+((1540483477*(n>>>16)&65535)<<16)^(o=1540483477*(65535&(o^=o>>>24))+((1540483477*(o>>>16)&65535)<<16)),i-=4,++r}switch(i){case 3:n^=(255&a.call(e,r+2))<<16;case 2:n^=(255&a.call(e,r+1))<<8;case 1:n=1540483477*(65535&(n^=255&a.call(e,r)))+((1540483477*(n>>>16)&65535)<<16)}return n=1540483477*(65535&(n^=n>>>13))+((1540483477*(n>>>16)&65535)<<16),(n^=n>>>15)>>>0}var al=function(){function e(t,i){Z(this,e),this.type=void 0,this.bubbles=void 0,this.target=null,this.currentTarget=null,this.eventPhase=0,this.propagationStopped=!1,this.propagationImmediateStopped=!1,this.type=t,this.bubbles=!!i}return J(e,[{key:"unuse",value:function(){this.type=e.NO_TYPE,this.target=null,this.currentTarget=null,this.eventPhase=e.NONE,this.propagationStopped=!1,this.propagationImmediateStopped=!1}},{key:"reuse",value:function(e,t){this.type=e,this.bubbles=t||!1}},{key:"isStopped",value:function(){return this.propagationStopped||this.propagationImmediateStopped}},{key:"getCurrentTarget",value:function(){return this.currentTarget}},{key:"getType",value:function(){return this.type}}]),e}();al.NO_TYPE="no_type",al.TOUCH="touch",al.MOUSE="mouse",al.KEYBOARD="keyboard",al.ACCELERATION="acceleration",al.NONE=0,al.CAPTURING_PHASE=1,al.AT_TARGET=2,al.BUBBLING_PHASE=3,cc.Event=al;var ol=[];var sl=function(){function e(){var t=arguments.length>0&&void 0!==arguments[0]?arguments[0]:"";Z(this,e),this._objFlags=void 0,this._name=void 0,this._name=t,this._objFlags=0}return J(e,null,[{key:"_deferredDestroy",value:function(){for(var e=ol.length,t=0;t<e;++t){var i=ol[t];1&i._objFlags||i._destroyImmediate()}e===ol.length?ol.length=0:ol.splice(0,e)}}]),J(e,[{key:"destroy",value:function(){return 1&this._objFlags?(g(5e3),!1):!(4&this._objFlags)&&(this._objFlags|=4,ol.push(this),!0)}},{key:"_destruct",value:function(){var e=this.constructor,t=e.__destruct__;t||(t=function(e,t){var i,n=e instanceof cc._BaseNode||e instanceof cc.Component,r=n?"_id":null,a={};for(i in e)if(e.hasOwnProperty(i)){if(i===r)continue;switch(K(e[i])){case"string":a[i]="";break;case"object":case"function":a[i]=null}}if(ni._isCCClass(t))for(var o=cc.Class.Attr.getClassAttrs(t),s=t.__props__,l=0;l<s.length;l++){var u=(i=s[l])+cc.Class.Attr.DELIMETER+"default";if(u in o){if(n&&"_id"===i)continue;switch(K(o[u])){case"string":a[i]="";break;case"object":case"function":a[i]=null;break;case"undefined":a[i]=void 0}}}return function(e){for(var t in a)e[t]=a[t]}}(this,e),Ce(e,"__destruct__",t,!0)),t(this)}},{key:"_destroyImmediate",value:function(){1&this._objFlags?b(5e3):(this._onPreDestroy&&this._onPreDestroy(),this._destruct(),this._objFlags|=1)}},{key:"name",get:function(){return this._name},set:function(e){this._name=e}},{key:"isValid",get:function(){return!(1&this._objFlags)}}]),e}(),ll=sl.prototype;function ul(e,t){return"object"===K(e)?!(!e||e._objFlags&(t?5:1)):void 0!==e}ll._deserialize=null,ll._onPreDestroy=null,ni.fastDefine("cc.Object",sl,{_name:"",_objFlags:0}),Ce(sl,"Flags",{Destroyed:1,DontSave:8,EditorOnly:16,Dirty:32,DontDestroy:64,PersistentMask:-4192741,Destroying:128,Deactivating:256,LockedInEditor:512,HideInHierarchy:1024,IsPreloadStarted:8192,IsOnLoadStarted:32768,IsOnLoadCalled:16384,IsOnEnableCalled:2048,IsStartCalled:65536,IsEditorOnEnableCalled:4096,IsPositionLocked:1<<21,IsRotationLocked:1<<17,IsScaleLocked:1<<18,IsAnchorLocked:1<<19,IsSizeLocked:1<<20}),cc.isValid=ul,cc.Object=sl;var cl=tt.fastRemoveAt;function hl(){}var pl=function(){function e(){Z(this,e),this.callback=hl,this.target=void 0,this.once=!1}return J(e,[{key:"set",value:function(e,t,i){this.callback=e||hl,this.target=t,this.once=!!i}},{key:"reset",value:function(){this.target=void 0,this.callback=hl,this.once=!1}},{key:"check",value:function(){return!(this.target instanceof sl&&!ul(this.target,!0))}}]),e}(),_l=new To((function(){return new pl}),32),fl=function(){function e(){Z(this,e),this.callbackInfos=[],this.isInvoking=!1,this.containCanceled=!1}return J(e,[{key:"removeByCallback",value:function(e){for(var t=0;t<this.callbackInfos.length;++t){var i=this.callbackInfos[t];i&&i.callback===e&&(i.reset(),_l.free(i),cl(this.callbackInfos,t),--t)}}},{key:"removeByTarget",value:function(e){for(var t=0;t<this.callbackInfos.length;++t){var i=this.callbackInfos[t];i&&i.target===e&&(i.reset(),_l.free(i),cl(this.callbackInfos,t),--t)}}},{key:"cancel",value:function(e){var t=this.callbackInfos[e];t&&(t.reset(),this.isInvoking?this.callbackInfos[e]=null:cl(this.callbackInfos,e),_l.free(t)),this.containCanceled=!0}},{key:"cancelAll",value:function(){for(var e=0;e<this.callbackInfos.length;e++){var t=this.callbackInfos[e];t&&(t.reset(),_l.free(t),this.callbackInfos[e]=null)}this.containCanceled=!0}},{key:"purgeCanceled",value:function(){for(var e=this.callbackInfos.length-1;e>=0;--e){this.callbackInfos[e]||cl(this.callbackInfos,e)}this.containCanceled=!1}},{key:"clear",value:function(){this.cancelAll(),this.callbackInfos.length=0,this.isInvoking=!1,this.containCanceled=!1}}]),e}(),dl=new To((function(){return new fl}),16),ml=function(){function e(){Z(this,e),this._callbackTable=Re(!0)}return J(e,[{key:"on",value:function(e,t,i,n){if(!this.hasEventListener(e,t,i)){var r=this._callbackTable[e];r||(r=this._callbackTable[e]=dl.alloc());var a=_l.alloc();a.set(t,i,n),r.callbackInfos.push(a)}return t}},{key:"hasEventListener",value:function(e,t,i){var n=this._callbackTable[e];if(!n)return!1;var r=n.callbackInfos;if(!t){if(n.isInvoking){for(var a=0;a<r.length;++a)if(r[a])return!0;return!1}return r.length>0}for(var o=0;o<r.length;++o){var s=r[o];if(s&&s.check()&&s.callback===t&&s.target===i)return!0}return!1}},{key:"removeAll",value:function(e){if("string"==typeof e){var t=this._callbackTable[e];t&&(t.isInvoking?t.cancelAll():(t.clear(),dl.free(t),delete this._callbackTable[e]))}else if(e)for(var i in this._callbackTable){var n=this._callbackTable[i];if(n.isInvoking)for(var r=n.callbackInfos,a=0;a<r.length;++a){var o=r[a];o&&o.target===e&&n.cancel(a)}else n.removeByTarget(e)}}},{key:"off",value:function(e,t,i){var n=this._callbackTable[e];if(n){var r=n.callbackInfos;if(t)for(var a=0;a<r.length;++a){var o=r[a];if(o&&o.callback===t&&o.target===i){n.cancel(a);break}}else this.removeAll(e)}}},{key:"emit",value:function(e,t,i,n,r,a){var o=this._callbackTable[e];if(o){var s=!o.isInvoking;o.isInvoking=!0;for(var l=o.callbackInfos,u=0,c=l.length;u<c;++u){var h=l[u];if(h){var p=h.callback,_=h.target;h.once&&this.off(e,p,_),h.check()?_?p.call(_,t,i,n,r,a):p(t,i,n,r,a):this.off(e,p,_)}}s&&(o.isInvoking=!1,o.containCanceled&&o.purgeCanceled())}}},{key:"clear",value:function(){for(var e in this._callbackTable){var t=this._callbackTable[e];t&&(t.clear(),dl.free(t),delete this._callbackTable[e])}}}]),e}();function vl(e){for(var t=function(e){function t(){var e,i;Z(this,t);for(var n=arguments.length,r=new Array(n),a=0;a<n;a++)r[a]=arguments[a];return(i=re(this,(e=te(t)).call.apply(e,[this].concat(r))))._callbackTable=Re(!0),i}return ee(t,e),J(t,[{key:"once",value:function(e,t,i){return this.on(e,t,i,!0)}},{key:"targetOff",value:function(e){this.removeAll(e)}}]),t}(e),i=ml.prototype,n=Object.getOwnPropertyNames(i).concat(Object.getOwnPropertySymbols(i)),r=0;r<n.length;++r){var a=n[r];if(!(a in t.prototype)){var o=Object.getOwnPropertyDescriptor(i,a);o&&Object.defineProperty(t.prototype,a,o)}}return t}var yl,gl=vl((function e(){Z(this,e)}));cc.EventTarget=gl;var xl,bl,Tl,Sl,El,wl,Cl,Al=Yo("cc.RawAsset")(yl=function(e){function t(){var e,i;Z(this,t);for(var n=arguments.length,r=new Array(n),a=0;a<n;a++)r[a]=arguments[a];return(i=re(this,(e=te(t)).call.apply(e,[this].concat(r))))._uuid=void 0,Object.defineProperty(ne(i),"_uuid",{value:"",writable:!0}),i}return ee(t,sl),J(t,null,[{key:"isRawAssetType",value:function(e){return He(e,cc.RawAsset)&&!He(e,cc.Asset)}}]),t}())||yl;cc.RawAsset=Al;var Ol,kl,Rl,Fl,Ml,Il,Pl,Ll,Dl,Nl,zl=(xl=Yo("cc.Asset"),bl=Ko({visible:!1}),xl((Cl=wl=function(e){function t(){var e,i;Z(this,t);for(var n=arguments.length,r=new Array(n),a=0;a<n;a++)r[a]=arguments[a];return(i=re(this,(e=te(t)).call.apply(e,[this].concat(r)))).loaded=!0,fe(i,"_native",El,ne(i)),i._file=null,i}return ee(t,vl(Al)),J(t,[{key:"toString",value:function(){return this.nativeUrl}},{key:"serialize",value:function(){}},{key:"_setRawAsset",value:function(e){var t=!(arguments.length>1&&void 0!==arguments[1])||arguments[1];this._native=!1!==t?e||"":"/"+e}},{key:"nativeUrl",get:function(){if(this._native){var e=this._native;if(47===e.charCodeAt(0))return e.slice(1);if(cc.AssetLibrary){var t=cc.AssetLibrary.getLibUrlNoExt(this._uuid,!0);return 46===e.charCodeAt(0)?t+e:t+"/"+e}cc.errorID(6400)}return""}},{key:"_nativeAsset",get:function(){return this._file},set:function(e){this._file=e}}],[{key:"deserialize",value:function(e){return cc.deserialize(e)}}]),t}(),wl.preventDeferredLoadDependents=!1,wl.preventPreloadNativeObject=!1,El=de((Sl=Cl).prototype,"_native",[Ko],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return""}}),de(Sl.prototype,"nativeUrl",[bl],Object.getOwnPropertyDescriptor(Sl.prototype,"nativeUrl"),Sl.prototype),de(Sl.prototype,"_nativeAsset",[Ko],Object.getOwnPropertyDescriptor(Sl.prototype,"_nativeAsset"),Sl.prototype),Tl=Sl))||Tl);zl.prototype.createNode=null,cc.Asset=zl,function(e){e[e.RGB565=exports.GFXFormat.R5G6B5]="RGB565",e[e.RGB5A1=exports.GFXFormat.RGB5A1]="RGB5A1",e[e.RGBA4444=exports.GFXFormat.RGBA4]="RGBA4444",e[e.RGB888=exports.GFXFormat.RGB8]="RGB888",e[e.RGB32F=exports.GFXFormat.RGB32F]="RGB32F",e[e.RGBA8888=exports.GFXFormat.RGBA8]="RGBA8888",e[e.RGBA32F=exports.GFXFormat.RGBA32F]="RGBA32F",e[e.A8=exports.GFXFormat.A8]="A8",e[e.I8=exports.GFXFormat.L8]="I8",e[e.AI8=exports.GFXFormat.LA8]="AI8",e[e.RGB_PVRTC_2BPPV1=exports.GFXFormat.PVRTC_RGB2]="RGB_PVRTC_2BPPV1",e[e.RGBA_PVRTC_2BPPV1=exports.GFXFormat.PVRTC_RGBA2]="RGBA_PVRTC_2BPPV1",e[e.RGB_PVRTC_4BPPV1=exports.GFXFormat.PVRTC_RGB4]="RGB_PVRTC_4BPPV1",e[e.RGBA_PVRTC_4BPPV1=exports.GFXFormat.PVRTC_RGBA4]="RGBA_PVRTC_4BPPV1",e[e.RGB_ETC1=exports.GFXFormat.ETC_RGB8]="RGB_ETC1",e[e.RGB_ETC2=exports.GFXFormat.ETC2_RGB8]="RGB_ETC2",e[e.RGBA_ETC2=exports.GFXFormat.ETC2_RGBA8]="RGBA_ETC2"}(Ol||(Ol={})),function(e){e[e.REPEAT=exports.GFXAddress.WRAP]="REPEAT",e[e.CLAMP_TO_EDGE=exports.GFXAddress.CLAMP]="CLAMP_TO_EDGE",e[e.MIRRORED_REPEAT=exports.GFXAddress.MIRROR]="MIRRORED_REPEAT",e[e.CLAMP_TO_BORDER=exports.GFXAddress.BORDER]="CLAMP_TO_BORDER"}(kl||(kl={})),function(e){e[e.NONE=exports.GFXFilter.NONE]="NONE",e[e.LINEAR=exports.GFXFilter.LINEAR]="LINEAR",e[e.NEAREST=exports.GFXFilter.POINT]="NEAREST"}(Rl||(Rl={})),function(e){e[e.NONE=exports.GFXFormat.UNKNOWN]="NONE",e[e.DEPTH_16=exports.GFXFormat.D16]="DEPTH_16",e[e.DEPTH_24=exports.GFXFormat.D24]="DEPTH_24",e[e.DEPTH_32=exports.GFXFormat.D32F]="DEPTH_32",e[e.DEPTH_16_STENCIL_8=exports.GFXFormat.D16S8]="DEPTH_16_STENCIL_8",e[e.DEPTH_24_STENCIL_8=exports.GFXFormat.D24S8]="DEPTH_24_STENCIL_8",e[e.DEPTH_32_STENCIL_8=exports.GFXFormat.D32F_S8]="DEPTH_32_STENCIL_8"}(Fl||(Fl={}));var Bl,Gl=(Ml=Yo("cc.ImageAsset"),Il=Ko({override:!0}),Ml((Nl=Dl=function(e){function t(e){var i;return Z(this,t),(i=re(this,te(t).call(this)))._nativeData=void 0,i._tex=void 0,i._url=void 0,i._exportedExts=void 0,i._format=Ol.RGBA8888,i._width=0,i._height=0,i._url="",i.loaded=!1,i._nativeData={_data:null,width:0,height:0,format:0,_compressed:!1},void 0!==e&&i.reset(e),i}return ee(t,zl),J(t,[{key:"_nativeAsset",get:function(){return this._nativeData},set:function(e){e instanceof HTMLElement||(e.format=this._format),this.reset(e)}},{key:"data",get:function(){var e=this._nativeData&&this._nativeData._data;return ArrayBuffer.isView(e)?e:this._nativeData}},{key:"width",get:function(){return this._nativeData.width||this._width}},{key:"height",get:function(){return this._nativeData.height||this._height}},{key:"format",get:function(){return this._format}},{key:"isCompressed",get:function(){return this._format>=Ol.RGB_ETC1&&this._format<=Ol.RGBA_PVRTC_4BPPV1}},{key:"url",get:function(){return this._url}},{key:"_texture",set:function(e){this._tex=e},get:function(){if(!this._tex){var e=new cc.Texture2D;e.name=this._url,e.image=this,this._tex=e}return this._tex}}]),J(t,[{key:"reset",value:function(e){e instanceof HTMLElement?(this._nativeData=e,this._onDataComplete()):(this._nativeData=e,this._format=e.format,this._onDataComplete())}},{key:"destroy",value:function(){return this.data&&this.data instanceof HTMLImageElement&&(this.data.src="",this._setRawAsset(""),cc.loader.removeItem(this.data.id)),oe(te(t.prototype),"destroy",this).call(this)}},{key:"_serialize",value:function(){var e=this._exportedExts;if(!e&&this._native&&(e=[this._native]),!e)return"";for(var i,n=[],r=_e(e);!(i=r()).done;){var a=i.value,o=a.split("@"),s=t.extnames.indexOf(o[0]),l=s<0?a:"".concat(s);o[1]&&(l+="@"+o[1]),n.push(l)}return{fmt:n.join("_"),w:this.width,h:this.height}}},{key:"_deserialize",value:function(e,i){var n="";"string"==typeof e?n=e:(this._width=e.w,this._height=e.h,n=e.fmt);for(var r,a=cc.director.root?cc.director.root.device:null,o=n.split("_"),s=Number.MAX_VALUE,l=this._format,u="",c=cc.macro.SUPPORT_TEXTURE_FORMATS,h=_e(o);!(r=h()).done;){var p=r.value.split("@"),_=parseInt(p[0],void 0),f=t.extnames[_]||p.join(),d=c.indexOf(f);if(-1!==d&&d<s){var m=p[1]?parseInt(p[1]):this._format;if(!(".pvr"!==f||a&&a.hasFeature(exports.GFXFeature.FORMAT_PVRTC)))continue;if(!(m!==Ol.RGB_ETC1||a&&a.hasFeature(exports.GFXFeature.FORMAT_ETC1)))continue;if(!(m!==Ol.RGB_ETC2&&m!==Ol.RGBA_ETC2||a&&a.hasFeature(exports.GFXFeature.FORMAT_ETC2)))continue;if(".webp"===f&&!cc.sys.capabilities.webp)continue;s=d,u=f,l=m}}u&&(this._setRawAsset(u),this._format=l);var v=i.customEnv,y=v&&v.uuid;y&&(this._uuid=y,this._url=this.nativeUrl)}},{key:"_onDataComplete",value:function(){this.loaded=!0,this.emit("load")}}]),t}(),Dl.extnames=[".png",".jpg",".jpeg",".bmp",".webp",".pvr",".pkm"],de((Ll=Nl).prototype,"_nativeAsset",[Il],Object.getOwnPropertyDescriptor(Ll.prototype,"_nativeAsset"),Ll.prototype),Pl=Ll))||Pl);cc.ImageAsset=Gl,function(e){e[e.minFilter=0]="minFilter",e[e.magFilter=1]="magFilter",e[e.mipFilter=2]="mipFilter",e[e.addressU=3]="addressU",e[e.addressV=4]="addressV",e[e.addressW=5]="addressW",e[e.maxAnisotropy=6]="maxAnisotropy",e[e.cmpFunc=7]="cmpFunc",e[e.minLOD=8]="minLOD",e[e.maxLOD=9]="maxLOD",e[e.mipLODBias=10]="mipLODBias",e[e.total=11]="total"}(Bl||(Bl={}));var Ul=[exports.GFXFilter.LINEAR,exports.GFXFilter.LINEAR,exports.GFXFilter.NONE,exports.GFXAddress.WRAP,exports.GFXAddress.WRAP,exports.GFXAddress.WRAP,8,exports.GFXComparisonFunc.NEVER,0,0,0],Xl=Wl(Ul),Vl={r:0,g:0,b:0,a:0},Hl={};function Wl(e){for(var t=0,i=0,n=0;n<Ul.length;n++)switch(t=e[n]||Ul[n],n){case Bl.minFilter:i|=t;break;case Bl.magFilter:i|=t<<2;break;case Bl.mipFilter:i|=t<<4;break;case Bl.addressU:i|=t<<6;break;case Bl.addressV:i|=t<<8;break;case Bl.addressW:i|=t<<10;break;case Bl.maxAnisotropy:i|=t<<12;break;case Bl.cmpFunc:i|=t<<16;break;case Bl.minLOD:i|=t<<20;break;case Bl.maxLOD:i|=t<<24;break;case Bl.mipLODBias:i|=t<<28}return i}var jl,ql,Yl,Kl,Zl,Ql,Jl,$l,eu,tu,iu,nu,ru,au,ou=new(function(){function e(){Z(this,e),this._cache={}}return J(e,[{key:"getSampler",value:function(e,t){0===t&&(t=Xl);var i=this._cache[t];return i||(Hl.minFilter=3&t,Hl.magFilter=t>>2&3,Hl.mipFilter=t>>4&3,Hl.addressU=t>>6&3,Hl.addressV=t>>8&3,Hl.addressW=t>>10&3,Hl.maxAnisotropy=t>>12&15,Hl.cmpFunc=t>>16&15,Hl.minLOD=t>>20&15,Hl.maxLOD=t>>24&15,Hl.mipLODBias=t>>28&15,Hl.borderColor=Vl,this._cache[t]=e.createSampler(Hl))}}]),e}());cc.samplerLib=ou;var su=new be("Tex"),lu=Yo("cc.TextureBase")((au=ru=function(e){function t(){var e,i=arguments.length>0&&void 0!==arguments[0]&&arguments[0];return Z(this,t),fe(e=re(this,te(t).call(this)),"_format",Yl,ne(e)),fe(e,"_premultiplyAlpha",Kl,ne(e)),fe(e,"_flipY",Zl,ne(e)),fe(e,"_minFilter",Ql,ne(e)),fe(e,"_magFilter",Jl,ne(e)),fe(e,"_mipFilter",$l,ne(e)),fe(e,"_wrapS",eu,ne(e)),fe(e,"_wrapT",tu,ne(e)),fe(e,"_wrapR",iu,ne(e)),fe(e,"_anisotropy",nu,ne(e)),e._width=0,e._height=0,e._id=void 0,e._samplerInfo=[],e._samplerHash=0,e._gfxSampler=null,e._gfxDevice=null,e._flipY=i,e._id=su.getNewId(),e.loaded=!1,e._gfxDevice=e._getGFXDevice(),e}return ee(t,zl),J(t,[{key:"isCompressed",get:function(){return this._format>=Ol.RGB_ETC1&&this._format<=Ol.RGBA_PVRTC_4BPPV1}},{key:"width",get:function(){return this._width}},{key:"height",get:function(){return this._height}}]),J(t,[{key:"getId",value:function(){return this._id}},{key:"getPixelFormat",value:function(){return this._format}},{key:"hasPremultipliedAlpha",value:function(){return this._premultiplyAlpha||!1}},{key:"getAnisotropy",value:function(){return this._anisotropy}},{key:"setWrapMode",value:function(e,t,i){this._wrapS=e,this._samplerInfo[Bl.addressU]=e,this._wrapT=t,this._samplerInfo[Bl.addressV]=t,void 0!==i&&(this._wrapR=i,this._samplerInfo[Bl.addressW]=i),this._samplerHash=Wl(this._samplerInfo),this._gfxDevice&&(this._gfxSampler=ou.getSampler(this._gfxDevice,this._samplerHash))}},{key:"setFilters",value:function(e,t){this._minFilter=e,this._samplerInfo[Bl.minFilter]=e,this._magFilter=t,this._samplerInfo[Bl.magFilter]=t,this._samplerHash=Wl(this._samplerInfo),this._gfxDevice&&(this._gfxSampler=ou.getSampler(this._gfxDevice,this._samplerHash))}},{key:"setMipFilter",value:function(e){this._mipFilter=e,this._samplerInfo[Bl.mipFilter]=e,this._samplerInfo[Bl.maxLOD]=e===Rl.NONE?0:15,this._samplerHash=Wl(this._samplerInfo),this._gfxDevice&&(this._gfxSampler=ou.getSampler(this._gfxDevice,this._samplerHash))}},{key:"setFlipY",value:function(e){this._flipY=e}},{key:"setPremultiplyAlpha",value:function(e){this._premultiplyAlpha=e}},{key:"setAnisotropy",value:function(e){this._anisotropy=e,this._samplerInfo[Bl.maxAnisotropy]=e,this._samplerHash=Wl(this._samplerInfo),this._gfxDevice&&(this._gfxSampler=ou.getSampler(this._gfxDevice,this._samplerHash))}},{key:"destroy",value:function(){return oe(te(t.prototype),"destroy",this).call(this)}},{key:"getGFXTextureView",value:function(){return null}},{key:"getSamplerHash",value:function(){return this._samplerHash}},{key:"getGFXSampler",value:function(){return this._gfxSampler||(this._gfxDevice?this._gfxSampler=ou.getSampler(this._gfxDevice,this._samplerHash):cc.errorID(9302)),this._gfxSampler}},{key:"_serialize",value:function(e){return this._minFilter+","+this._magFilter+","+this._wrapS+","+this._wrapT+","+(this._premultiplyAlpha?1:0)+","+this._mipFilter+","+this._anisotropy+","+(this._flipY?1:0)}},{key:"_deserialize",value:function(e,t){var i=e.split(",");i.unshift(""),i.length>=6&&(this.setFilters(parseInt(i[1]),parseInt(i[2])),this.setWrapMode(parseInt(i[3]),parseInt(i[4])),this._premultiplyAlpha=49===i[5].charCodeAt(0)),i.length>=8&&(this.setMipFilter(parseInt(i[6])),this.setAnisotropy(parseInt(i[7]))),i.length>=9&&(this._flipY=49===i[8].charCodeAt(0))}},{key:"_getGFXDevice",value:function(){return cc.director.root&&cc.director.root.device}},{key:"_getGFXFormat",value:function(){return this._format}},{key:"_setGFXFormat",value:function(e){this._format=void 0===e?Ol.RGBA8888:e}}]),t}(),ru.PixelFormat=Ol,ru.WrapMode=kl,ru.Filter=Rl,Yl=de((ql=au).prototype,"_format",[Ko],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return Ol.RGBA8888}}),Kl=de(ql.prototype,"_premultiplyAlpha",[Ko],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return!1}}),Zl=de(ql.prototype,"_flipY",[Ko],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return!1}}),Ql=de(ql.prototype,"_minFilter",[Ko],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return Rl.LINEAR}}),Jl=de(ql.prototype,"_magFilter",[Ko],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return Rl.LINEAR}}),$l=de(ql.prototype,"_mipFilter",[Ko],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return Rl.NONE}}),eu=de(ql.prototype,"_wrapS",[Ko],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return kl.REPEAT}}),tu=de(ql.prototype,"_wrapT",[Ko],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return kl.REPEAT}}),iu=de(ql.prototype,"_wrapR",[Ko],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return kl.REPEAT}}),nu=de(ql.prototype,"_anisotropy",[Ko],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return 8}}),jl=ql))||jl;lu||(lu={}),cc.TextureBase=lu;var uu,cu={SUPPORT_TEXTURE_FORMATS:[".pkm",".pvr",".webp",".jpg",".jpeg",".bmp",".png"],KEY:{none:0,back:6,menu:18,backspace:8,tab:9,enter:13,shift:16,ctrl:17,alt:18,pause:19,capslock:20,escape:27,space:32,pageup:33,pagedown:34,end:35,home:36,left:37,up:38,right:39,down:40,select:41,insert:45,Delete:46,0:48,1:49,2:50,3:51,4:52,5:53,6:54,7:55,8:56,9:57,a:65,b:66,c:67,d:68,e:69,f:70,g:71,h:72,i:73,j:74,k:75,l:76,m:77,n:78,o:79,p:80,q:81,r:82,s:83,t:84,u:85,v:86,w:87,x:88,y:89,z:90,num0:96,num1:97,num2:98,num3:99,num4:100,num5:101,num6:102,num7:103,num8:104,num9:105,"*":106,"+":107,"-":109,numdel:110,"/":111,f1:112,f2:113,f3:114,f4:115,f5:116,f6:117,f7:118,f8:119,f9:120,f10:121,f11:122,f12:123,numlock:144,scrolllock:145,";":186,semicolon:186,equal:187,"=":187,",":188,comma:188,dash:189,".":190,period:190,forwardslash:191,grave:192,"[":219,openbracket:219,backslash:220,"]":221,closebracket:221,quote:222,dpadLeft:1e3,dpadRight:1001,dpadUp:1003,dpadDown:1004,dpadCenter:1005},RAD:Math.PI/180,DEG:180/Math.PI,REPEAT_FOREVER:Number.MAX_VALUE-1,FLT_EPSILON:1.192092896e-7,ORIENTATION_PORTRAIT:1,ORIENTATION_LANDSCAPE:2,ORIENTATION_AUTO:3,FIX_ARTIFACTS_BY_STRECHING_TEXEL_TMX:!0,ENABLE_TILEDMAP_CULLING:!0,DIRECTOR_STATS_POSITION:new ki(0,0),TOUCH_TIMEOUT:5e3,DOWNLOAD_MAX_CONCURRENT:64,ENABLE_TRANSPARENT_CANVAS:!1,ENABLE_WEBGL_ANTIALIAS:!1,CLEANUP_IMAGE_CACHE:!1,ENABLE_MULTI_TOUCH:!0};cc.macro=cu;var hu=[{buffOffset:0,buffStride:0,buffTexHeight:0,texOffset:{x:0,y:0,z:0},texExtent:{width:1,height:1,depth:1},texSubres:{baseMipLevel:1,levelCount:1,baseArrayLayer:0,layerCount:1}}];function pu(e){return e&&0==(e&e-1)}var _u,fu,du,mu,vu,yu=Yo("cc.SimpleTexture")(uu=function(e){function t(){var e,i;Z(this,t);for(var n=arguments.length,r=new Array(n),a=0;a<n;a++)r[a]=arguments[a];return(i=re(this,(e=te(t)).call.apply(e,[this].concat(r))))._gfxTexture=null,i._gfxTextureView=null,i._mipmapLevel=1,i}return ee(t,lu),J(t,[{key:"getGFXTexture",value:function(){return this._gfxTexture}},{key:"getGFXTextureView",value:function(){return this._gfxTextureView}},{key:"destroy",value:function(){return this._tryDestroyTexture(),oe(te(t.prototype),"destroy",this).call(this)}},{key:"updateImage",value:function(){this.updateMipmaps(0)}},{key:"updateMipmaps",value:function(){}},{key:"uploadData",value:function(e){var t=arguments.length>1&&void 0!==arguments[1]?arguments[1]:0,i=arguments.length>2&&void 0!==arguments[2]?arguments[2]:0;if(this._gfxTexture&&!(this._gfxTexture.mipLevel<=t)){var n=this._getGFXDevice();if(n){var r=hu[0];r.texExtent.width=this._gfxTexture.width>>t,r.texExtent.height=this._gfxTexture.height>>t,r.texSubres.baseMipLevel=t,r.texSubres.baseArrayLayer=i,ArrayBuffer.isView(e)?n.copyBuffersToTexture([e],this._gfxTexture,hu):n.copyTexImagesToTexture([e],this._gfxTexture,hu)}}}},{key:"_assignImage",value:function(e,t,i){var n=this,r=function(){var r=e.data;r&&(n.uploadData(r,t,i),n._checkTextureLoaded(),cu.CLEANUP_IMAGE_CACHE&&cc.loader.release(e))};if(e.loaded)r();else{if(e.once("load",(function(){r()})),!this.isCompressed){var a=cc.builtinResMgr.get("black-texture").image;this.uploadData(a.data,t,i)}cc.textureUtil.postLoadImage(e)}}},{key:"_checkTextureLoaded",value:function(){this._textureReady()}},{key:"_textureReady",value:function(){this.loaded=!0,this.emit("load")}},{key:"_setMipmapLevel",value:function(e){this._mipmapLevel=e<1?1:e}},{key:"_getGfxTextureCreateInfo",value:function(e){return null}},{key:"_getGfxTextureViewCreateInfo",value:function(e){return null}},{key:"_tryReset",value:function(){this._tryDestroyTexture();var e=this._getGFXDevice();e&&this._createTexture(e)}},{key:"_createTexture",value:function(e){var t=exports.GFXTextureFlagBit.NONE;this._mipFilter!==Rl.NONE&&function(e,t,i){return!(e.gfxAPI===exports.GFXAPI.WEBGL)||pu(t)&&pu(i)}(e,this._width,this._height)&&(this._mipmapLevel=function(e,t){for(var i=Math.max(e,t),n=0;i;)i>>=1,n++;return n}(this._width,this._height),t=exports.GFXTextureFlagBit.GEN_MIPMAP);var i=this._getGfxTextureCreateInfo({usage:exports.GFXTextureUsageBit.SAMPLED|exports.GFXTextureUsageBit.TRANSFER_DST,format:this._getGFXFormat(),mipLevel:this._mipmapLevel,flags:t});if(i){var n=e.createTexture(i),r=this._getGfxTextureViewCreateInfo({texture:n,format:this._getGFXFormat()});if(r){var a=e.createTextureView(r);a?(this._gfxTexture=n,this._gfxTextureView=a):n.destroy()}else n.destroy()}}},{key:"_tryDestroyTexture",value:function(){this._gfxTexture&&(this._gfxTexture.destroy(),this._gfxTexture=null),this._gfxTextureView&&(this._gfxTextureView.destroy(),this._gfxTextureView=null)}},{key:"mipmapLevel",get:function(){return this._mipmapLevel}}]),t}())||uu;cc.SimpleTexture=yu;var gu=(_u=Yo("cc.Texture2D"),fu=Ko([Gl]),_u((vu=de((mu=function(e){function t(){var e;return Z(this,t),fe(e=re(this,te(t).call(this,!0)),"_mipmaps",vu,ne(e)),e}return ee(t,yu),J(t,[{key:"mipmaps",get:function(){return this._mipmaps},set:function(e){var t=this;if(this._mipmaps=e,this._setMipmapLevel(this._mipmaps.length),this._mipmaps.length>0){var i=this._mipmaps[0];this.reset({width:i.width,height:i.height,format:i.format,mipmapLevel:this._mipmaps.length}),this._mipmaps.forEach((function(e,i){t._assignImage(e,i)}))}else this.reset({width:0,height:0,mipmapLevel:this._mipmaps.length})}},{key:"image",get:function(){return 0===this._mipmaps.length?null:this._mipmaps[0]},set:function(e){this.mipmaps=e?[e]:[]}}]),J(t,[{key:"initialize",value:function(){this.mipmaps=this._mipmaps}},{key:"onLoaded",value:function(){this.initialize()}},{key:"reset",value:function(e){this._width=e.width,this._height=e.height,this._setGFXFormat(e.format),this._setMipmapLevel(e.mipmapLevel||1),this._tryReset()}},{key:"create",value:function(e,t){var i=arguments.length>2&&void 0!==arguments[2]?arguments[2]:Ol.RGBA8888,n=arguments.length>3&&void 0!==arguments[3]?arguments[3]:1;this.reset({width:e,height:t,format:i,mipmapLevel:n})}},{key:"toString",value:function(){return 0!==this._mipmaps.length?this._mipmaps[0].url:""}},{key:"updateMipmaps",value:function(){var e=arguments.length>0&&void 0!==arguments[0]?arguments[0]:0,t=arguments.length>1?arguments[1]:void 0;if(!(e>=this._mipmaps.length))for(var i=Math.min(void 0===t?this._mipmaps.length:t,this._mipmaps.length-e),n=0;n<i;++n){var r=e+n;this._assignImage(this._mipmaps[r],r)}}},{key:"getHtmlElementObj",value:function(){return this._mipmaps[0]&&this._mipmaps[0].data instanceof HTMLElement?this._mipmaps[0].data:null}},{key:"destroy",value:function(){return this._mipmaps=[],oe(te(t.prototype),"destroy",this).call(this)}},{key:"description",value:function(){var e=this._mipmaps[0]?this._mipmaps[0].url:"";return"<cc.Texture2D | Name = ".concat(e," | Dimension = ").concat(this.width," x ").concat(this.height,">")}},{key:"releaseTexture",value:function(){this.destroy()}},{key:"_serialize",value:function(e){return{base:oe(te(t.prototype),"_serialize",this).call(this,e),mipmaps:this._mipmaps.map((function(t){return t&&t._uuid?e?EditorExtends.UuidUtils.compressUuid(t._uuid,!0):t._uuid:null}))}}},{key:"_deserialize",value:function(e,i){var n=e;oe(te(t.prototype),"_deserialize",this).call(this,n.base,i),this._mipmaps=new Array(n.mipmaps.length);for(var r=0;r<n.mipmaps.length;++r)if(this._mipmaps[r]=new Gl,n.mipmaps[r]){var a=n.mipmaps[r];i.result.push(this._mipmaps,"".concat(r),a),this._mipmaps[r]._texture=this}}},{key:"_getGfxTextureCreateInfo",value:function(e){return Object.assign({type:exports.GFXTextureType.TEX2D,width:this._width,height:this._height},e)}},{key:"_getGfxTextureViewCreateInfo",value:function(e){return Object.assign({type:exports.GFXTextureViewType.TV2D},e)}},{key:"_checkTextureLoaded",value:function(){for(var e=!0,i=0;i<this._mipmaps.length;++i){if(!this._mipmaps[i].loaded){e=!1;break}}e&&oe(te(t.prototype),"_textureReady",this).call(this)}}]),t}()).prototype,"_mipmaps",[fu],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return[]}}),du=mu))||du);cc.Texture2D=gu;var xu={NONE:0,IGNORE_RAYCAST:1<<20,GIZMOS:1<<21,EDITOR:1<<22,UI_3D:1<<23,SCENE_GIZMO:1<<24,UI_2D:1<<25,PROFILER:1<<28,DEFAULT:1<<30,ALL:4294967295},bu=function(){function e(){Z(this,e)}return J(e,null,[{key:"makeMaskInclude",value:function(e){for(var t,i=0,n=_e(e);!(t=n()).done;){i|=t.value}return i}},{key:"makeMaskExclude",value:function(t){return~e.makeMaskInclude(t)}},{key:"addLayer",value:function(t,i){void 0!==i?i>19||i<0?console.warn("maximum layers reached."):(e.Enum[t]=1<<i,e.Enum[i]=t,e.BitMask[t]=1<<i,e.BitMask[i]=t):console.warn("bitNum can't be undefined")}},{key:"deleteLayer",value:function(t){t>19||t<0?console.warn("do not change buildin layers."):(delete e.Enum[e.Enum[t]],delete e.Enum[t],delete e.BitMask[e.BitMask[t]],delete e.BitMask[t])}}]),e}();bu.Enum=xt(xu),bu.BitMask=gt(Object.assign({},xu)),cc.Layers=bu;var Tu,Su;!function(e){e[e.DEFAULT=100]="DEFAULT"}(Tu||(Tu={})),cc.RenderPassStage=Tu,function(e){e[e.MIN=0]="MIN",e[e.MAX=255]="MAX",e[e.DEFAULT=128]="DEFAULT"}(Su||(Su={}));var Eu;!function(e){e[e.UBO_GLOBAL=23]="UBO_GLOBAL",e[e.UBO_SHADOW=22]="UBO_SHADOW",e[e.UBO_LOCAL=21]="UBO_LOCAL",e[e.UBO_FORWARD_LIGHTS=20]="UBO_FORWARD_LIGHTS",e[e.UBO_SKINNING_ANIMATION=19]="UBO_SKINNING_ANIMATION",e[e.UBO_SKINNING_TEXTURE=18]="UBO_SKINNING_TEXTURE",e[e.UBO_UI=17]="UBO_UI",e[e.UBO_MORPH=16]="UBO_MORPH",e[e.UBO_BUILTIN_BINDING_END=15]="UBO_BUILTIN_BINDING_END",e[e.SAMPLER_JOINTS=25]="SAMPLER_JOINTS",e[e.SAMPLER_ENVIRONMENT=26]="SAMPLER_ENVIRONMENT",e[e.SAMPLER_MORPH_POSITION=27]="SAMPLER_MORPH_POSITION",e[e.SAMPLER_MORPH_NORMAL=28]="SAMPLER_MORPH_NORMAL",e[e.SAMPLER_MORPH_TANGENT=29]="SAMPLER_MORPH_TANGENT",e[e.SAMPLER_LIGHTING_MAP=30]="SAMPLER_LIGHTING_MAP",e[e.CUSTUM_UBO_BINDING_END_POINT=e.UBO_BUILTIN_BINDING_END]="CUSTUM_UBO_BINDING_END_POINT",e[e.CUSTOM_SAMPLER_BINDING_START_POINT=31]="CUSTOM_SAMPLER_BINDING_START_POINT"}(Eu||(Eu={}));var wu=function(e){return e>=Eu.CUSTUM_UBO_BINDING_END_POINT&&e<Eu.CUSTOM_SAMPLER_BINDING_START_POINT},Cu=function e(){Z(this,e),this.view=new Float32Array(e.COUNT)};Cu.SIZE=4*(Cu.COUNT=(Cu.AMBIENT_GROUND_OFFSET=(Cu.AMBIENT_SKY_OFFSET=(Cu.MAIN_LIT_COLOR_OFFSET=(Cu.MAIN_LIT_DIR_OFFSET=(Cu.EXPOSURE_OFFSET=(Cu.CAMERA_POS_OFFSET=(Cu.MAT_VIEW_PROJ_INV_OFFSET=(Cu.MAT_VIEW_PROJ_OFFSET=(Cu.MAT_PROJ_INV_OFFSET=(Cu.MAT_PROJ_OFFSET=(Cu.MAT_VIEW_INV_OFFSET=(Cu.MAT_VIEW_OFFSET=(Cu.NATIVE_SIZE_OFFSET=(Cu.SCREEN_SCALE_OFFSET=(Cu.SCREEN_SIZE_OFFSET=(Cu.TIME_OFFSET=0)+4)+4)+4)+4)+16)+16)+16)+16)+16)+16)+4)+4)+4)+4)+4)+4),Cu.BLOCK={binding:Eu.UBO_GLOBAL,name:"CCGlobal",members:[{name:"cc_time",type:exports.GFXType.FLOAT4,count:1},{name:"cc_screenSize",type:exports.GFXType.FLOAT4,count:1},{name:"cc_screenScale",type:exports.GFXType.FLOAT4,count:1},{name:"cc_nativeSize",type:exports.GFXType.FLOAT4,count:1},{name:"cc_matView",type:exports.GFXType.MAT4,count:1},{name:"cc_matViewInv",type:exports.GFXType.MAT4,count:1},{name:"cc_matProj",type:exports.GFXType.MAT4,count:1},{name:"cc_matProjInv",type:exports.GFXType.MAT4,count:1},{name:"cc_matViewProj",type:exports.GFXType.MAT4,count:1},{name:"cc_matViewProjInv",type:exports.GFXType.MAT4,count:1},{name:"cc_cameraPos",type:exports.GFXType.FLOAT4,count:1},{name:"cc_exposure",type:exports.GFXType.FLOAT4,count:1},{name:"cc_mainLitDir",type:exports.GFXType.FLOAT4,count:1},{name:"cc_mainLitColor",type:exports.GFXType.FLOAT4,count:1},{name:"cc_ambientSky",type:exports.GFXType.FLOAT4,count:1},{name:"cc_ambientGround",type:exports.GFXType.FLOAT4,count:1}]};var Au=function e(){Z(this,e),this.view=new Float32Array(e.COUNT)};Au.SIZE=4*(Au.COUNT=(Au.SHADOW_COLOR_OFFSET=(Au.MAT_LIGHT_PLANE_PROJ_OFFSET=0)+16)+4),Au.BLOCK={binding:Eu.UBO_SHADOW,name:"CCShadow",members:[{name:"cc_matLightPlaneProj",type:exports.GFXType.MAT4,count:1},{name:"cc_shadowColor",type:exports.GFXType.FLOAT4,count:1}]};var Ou={binding:Eu.SAMPLER_ENVIRONMENT,name:"cc_environment",type:exports.GFXType.SAMPLER_CUBE,count:1},ku=new Map,Ru=function e(){Z(this,e),this.view=new Float32Array(e.COUNT)};Ru.SIZE=4*(Ru.COUNT=(Ru.LIGHTINGMAP_UVPARAM=(Ru.MAT_WORLD_IT_OFFSET=(Ru.MAT_WORLD_OFFSET=0)+16)+16)+4),Ru.BLOCK={binding:Eu.UBO_LOCAL,name:"CCLocal",members:[{name:"cc_matWorld",type:exports.GFXType.MAT4,count:1},{name:"cc_matWorldIT",type:exports.GFXType.MAT4,count:1},{name:"cc_lightingMapUVParam",type:exports.GFXType.FLOAT4,count:1}]},ku.set(Ru.BLOCK.name,{type:exports.GFXBindingType.UNIFORM_BUFFER,blockInfo:Ru.BLOCK});var Fu=function e(){Z(this,e),this.view=new Float32Array(e.COUNT)};Fu.BATCHING_COUNT=10,Fu.MAT_WORLDS_OFFSET=0,Fu.SIZE=4*(Fu.COUNT=16*Fu.BATCHING_COUNT),Fu.BLOCK={binding:Eu.UBO_LOCAL,name:"CCLocalBatched",members:[{name:"cc_matWorlds",type:exports.GFXType.MAT4,count:Fu.BATCHING_COUNT}]},ku.set(Fu.BLOCK.name,{type:exports.GFXBindingType.UNIFORM_BUFFER,blockInfo:Fu.BLOCK});var Mu=function e(){Z(this,e),this.view=new Float32Array(e.COUNT)};Mu.MAX_SPHERE_LIGHTS=2,Mu.MAX_SPOT_LIGHTS=2,Mu.SIZE=4*(Mu.COUNT=(Mu.SPOT_LIGHT_COLOR_OFFSET=(Mu.SPOT_LIGHT_DIR_OFFSET=(Mu.SPOT_LIGHT_SIZE_RANGE_ANGLE_OFFSET=(Mu.SPOT_LIGHT_POS_OFFSET=(Mu.SPHERE_LIGHT_COLOR_OFFSET=(Mu.SPHERE_LIGHT_SIZE_RANGE_OFFSET=(Mu.SPHERE_LIGHT_POS_OFFSET=0)+4*Mu.MAX_SPHERE_LIGHTS)+4*Mu.MAX_SPHERE_LIGHTS)+4*Mu.MAX_SPOT_LIGHTS)+4*Mu.MAX_SPOT_LIGHTS)+4*Mu.MAX_SPOT_LIGHTS)+4*Mu.MAX_SPOT_LIGHTS)+4*Mu.MAX_SPOT_LIGHTS),Mu.BLOCK={binding:Eu.UBO_FORWARD_LIGHTS,name:"CCForwardLight",members:[{name:"cc_sphereLitPos",type:exports.GFXType.FLOAT4,count:Mu.MAX_SPHERE_LIGHTS},{name:"cc_sphereLitSizeRange",type:exports.GFXType.FLOAT4,count:Mu.MAX_SPHERE_LIGHTS},{name:"cc_sphereLitColor",type:exports.GFXType.FLOAT4,count:Mu.MAX_SPHERE_LIGHTS},{name:"cc_spotLitPos",type:exports.GFXType.FLOAT4,count:Mu.MAX_SPOT_LIGHTS},{name:"cc_spotLitSizeRangeAngle",type:exports.GFXType.FLOAT4,count:Mu.MAX_SPOT_LIGHTS},{name:"cc_spotLitDir",type:exports.GFXType.FLOAT4,count:Mu.MAX_SPOT_LIGHTS},{name:"cc_spotLitColor",type:exports.GFXType.FLOAT4,count:Mu.MAX_SPOT_LIGHTS}]},ku.set(Mu.BLOCK.name,{type:exports.GFXBindingType.UNIFORM_BUFFER,blockInfo:Mu.BLOCK});var Iu=function e(){Z(this,e)};Iu.SIZE=4*(Iu.COUNT=(Iu.JOINTS_TEXTURE_INFO_OFFSET=0)+4),Iu.BLOCK={binding:Eu.UBO_SKINNING_TEXTURE,name:"CCSkinningTexture",members:[{name:"cc_jointTextureInfo",type:exports.GFXType.FLOAT4,count:1}]},ku.set(Iu.BLOCK.name,{type:exports.GFXBindingType.UNIFORM_BUFFER,blockInfo:Iu.BLOCK});var Pu=function e(){Z(this,e)};Pu.SIZE=4*(Pu.COUNT=(Pu.JOINTS_ANIM_INFO_OFFSET=0)+4),Pu.BLOCK={binding:Eu.UBO_SKINNING_ANIMATION,name:"CCSkinningAnimation",members:[{name:"cc_jointAnimInfo",type:exports.GFXType.FLOAT4,count:1}]},ku.set(Pu.BLOCK.name,{type:exports.GFXBindingType.UNIFORM_BUFFER,blockInfo:Pu.BLOCK});var Lu=function e(){Z(this,e)};Lu.SIZE=4*(Lu.COUNT=(Lu.JOINTS_OFFSET=0)+360),Lu.BLOCK={binding:Eu.UBO_SKINNING_TEXTURE,name:"CCSkinning",members:[{name:"cc_joints",type:exports.GFXType.FLOAT4,count:90}]},ku.set(Lu.BLOCK.name,{type:exports.GFXBindingType.UNIFORM_BUFFER,blockInfo:Lu.BLOCK});var Du={binding:Eu.SAMPLER_JOINTS,name:"cc_jointTexture",type:exports.GFXType.SAMPLER2D,count:1};ku.set(Du.name,{type:exports.GFXBindingType.SAMPLER,samplerInfo:Du});var Nu=function e(){Z(this,e)};Nu.MAX_MORPH_TARGET_COUNT=60,Nu.OFFSET_OF_WEIGHTS=0,Nu.OFFSET_OF_DISPLACEMENT_TEXTURE_HEIGHT=(Nu.OFFSET_OF_DISPLACEMENT_TEXTURE_WIDTH=4*Nu.MAX_MORPH_TARGET_COUNT)+4,Nu.COUNT_BASE_4_BYTES=4*Math.ceil(Nu.MAX_MORPH_TARGET_COUNT/4)+4,Nu.SIZE=4*Nu.COUNT_BASE_4_BYTES,Nu.BLOCK={binding:Eu.UBO_MORPH,name:"CCMorph",members:[{name:"cc_displacementWeights",type:exports.GFXType.FLOAT4,count:Nu.MAX_MORPH_TARGET_COUNT/4},{name:"cc_displacementTextureInfo",type:exports.GFXType.FLOAT4,count:1}]},ku.set(Nu.BLOCK.name,{type:exports.GFXBindingType.UNIFORM_BUFFER,blockInfo:Nu.BLOCK});var zu={binding:Eu.SAMPLER_MORPH_POSITION,name:"cc_PositionDisplacements",type:exports.GFXType.SAMPLER2D,count:1};ku.set(zu.name,{type:exports.GFXBindingType.SAMPLER,samplerInfo:zu});var Bu={binding:Eu.SAMPLER_MORPH_NORMAL,name:"cc_NormalDisplacements",type:exports.GFXType.SAMPLER2D,count:1};ku.set(Bu.name,{type:exports.GFXBindingType.SAMPLER,samplerInfo:Bu});var Gu={binding:Eu.SAMPLER_LIGHTING_MAP,name:"cc_lightingMap",type:exports.GFXType.SAMPLER2D,count:1};ku.set(Gu.name,{type:exports.GFXBindingType.SAMPLER,samplerInfo:Gu});var Uu={binding:Eu.SAMPLER_MORPH_TANGENT,name:"cc_TangentDisplacements",type:exports.GFXType.SAMPLER2D,count:1};ku.set(Uu.name,{type:exports.GFXBindingType.SAMPLER,samplerInfo:Uu});var Xu=bu.makeMaskExclude([bu.BitMask.UI_2D,bu.BitMask.GIZMOS,bu.BitMask.EDITOR,bu.BitMask.SCENE_GIZMO,bu.BitMask.PROFILER]),Vu=bu.makeMaskExclude([bu.BitMask.UI_2D,bu.BitMask.PROFILER]),Hu=bu.Enum.ALL,Wu=Object.freeze({__proto__:null,PIPELINE_FLOW_FORWARD:"ForwardFlow",PIPELINE_FLOW_SMAA:"SMAAFlow",PIPELINE_FLOW_TONEMAP:"ToneMapFlow",get RenderPassStage(){return Tu},get RenderPriority(){return Su},get UniformBinding(){return Eu},isBuiltinBinding:wu,UBOGlobal:Cu,UBOShadow:Au,UNIFORM_ENVIRONMENT:Ou,localBindingsDesc:ku,UBOLocal:Ru,INST_MAT_WORLD:"a_matWorld0",UBOLocalBatched:Fu,UBOForwardLight:Mu,JOINT_UNIFORM_CAPACITY:30,UBOSkinningTexture:Iu,UBOSkinningAnimation:Pu,INST_JOINT_ANIM_INFO:"a_jointAnimInfo",UBOSkinning:Lu,UniformJointTexture:Du,UBOMorph:Nu,UniformPositionMorphTexture:zu,UniformNormalMorphTexture:Bu,UniformLightingMapSampler:Gu,UniformTangentMorphTexture:Uu,CAMERA_DEFAULT_MASK:Xu,CAMERA_EDITOR_MASK:Vu,MODEL_ALWAYS_MASK:Hu});var ju,qu,Yu,Ku,Zu,Qu=function(){function e(t,i){if(Z(this,e),this._mesh=void 0,this._subMeshRenderings=[],this._mesh=t,this._mesh.struct.morph){var n=this._mesh.struct.primitives.length;this._subMeshRenderings=new Array(n).fill(null);for(var r=0;r<n;++r){var a=this._mesh.struct.morph.subMeshMorphs[r];a&&(a.targets.length>Nu.MAX_MORPH_TARGET_COUNT?g(10002,Nu.MAX_MORPH_TARGET_COUNT,a.targets.length):this._subMeshRenderings[r]=new Ju(this._mesh,r,this._mesh.struct.morph,i))}}}return J(e,[{key:"createInstance",value:function(){for(var e=this,t=this._mesh.struct.primitives.length,i=new Array(t),n=0;n<t;++n){var r,a;i[n]=null!==(r=null===(a=this._subMeshRenderings[n])||void 0===a?void 0:a.createInstance())&&void 0!==r?r:null}return{setWeights:function(e,t){var n;null===(n=i[e])||void 0===n||n.setWeights(t)},requiredPatches:function(t){var n=e._mesh.struct.morph.subMeshMorphs[t],r=i[t];if(null!==r){var a=[{name:"CC_USE_MORPH",value:!0},{name:"CC_MORPH_TARGET_COUNT",value:n.targets.length}];return n.attributes.includes(exports.GFXAttributeName.ATTR_POSITION)&&a.push({name:"CC_MORPH_TARGET_HAS_POSITION",value:!0}),n.attributes.includes(exports.GFXAttributeName.ATTR_NORMAL)&&a.push({name:"CC_MORPH_TARGET_HAS_NORMAL",value:!0}),n.attributes.includes(exports.GFXAttributeName.ATTR_TANGENT)&&a.push({name:"CC_MORPH_TARGET_HAS_TANGENT",value:!0}),a.push.apply(a,ce(r.requiredPatches())),a}},adaptPipelineState:function(e,t){var n;null===(n=i[e])||void 0===n||n.adaptPipelineState(t)},destroy:function(){for(var e,t=_e(i);!(e=t()).done;){var n=e.value;null==n||n.destroy()}}}}}]),e}(),Ju=function(){function e(t,i,n,r){Z(this,e),this._gfxDevice=void 0,this._subMeshMorph=void 0,this._textureInfo=void 0,this._attributes=void 0,this._gfxDevice=r;var a=t.data.buffer,o=n.subMeshMorphs[i];this._subMeshMorph=o,function(e,t,i){e.renderingSubMeshes[t].enableVertexIdChannel(i)}(t,i,r);var s=t.struct.vertexBundles[t.struct.primitives[i].vertexBundelIndices[0]].view.count,l=o.targets.length,u=function(e){return j(Math.ceil(Math.sqrt(e)))}(l+s*l),c=u,h=u;this._textureInfo={width:c,height:h},this._attributes=o.attributes.map((function(e,t){var i=o.targets.length,n={displacements:new Array,targetOffsets:new Array(i).fill(0)};o.targets.forEach((function(e,i){var r,o=e.displacements[t];n.targetOffsets[i]=n.displacements.length,(r=n.displacements).push.apply(r,ce(new Float32Array(a,o.offset,o.count)))}));for(var s=gu.PixelFormat.RGB32F,l=new Float32Array(3*c*h),u=i,p=3*u,_=0;_<i;++_)l[3*_]=u+n.targetOffsets[_]/3;for(var f=0;f<n.displacements.length;++f)l[p+f]=n.displacements[f];var d=new Gl({width:c,height:h,_data:l,_compressed:!1,format:s}),m=new gu;m.setFilters(gu.Filter.NEAREST,gu.Filter.NEAREST),m.setMipFilter(gu.Filter.NONE),m.setWrapMode(gu.WrapMode.CLAMP_TO_EDGE,gu.WrapMode.CLAMP_TO_EDGE,gu.WrapMode.CLAMP_TO_EDGE),m.image=d;var v=ou.getSampler(r,m.getSamplerHash());return{name:e,texture:m,sampler:v}}))}return J(e,[{key:"destroy",value:function(){for(var e,t=_e(this._attributes);!(e=t()).done;){var i=e.value;i.texture.destroy(),i.sampler.destroy()}}},{key:"createInstance",value:function(){var e=this,t=new $u(this._gfxDevice,this._subMeshMorph.targets.length);return t.setMorphTextureInfo(this._textureInfo.width,this._textureInfo.height),t.commit(),{setWeights:function(e){t.setWeights(e),t.commit()},requiredPatches:function(){return[{name:"CC_MORPH_TARGET_USE_TEXTURE",value:!0}]},adaptPipelineState:function(i){for(var n,r=i.pipelineLayout.layouts[0],a=_e(e._attributes);!(n=a()).done;){var o=n.value,s=void 0;switch(o.name){case exports.GFXAttributeName.ATTR_POSITION:s=zu.binding;break;case exports.GFXAttributeName.ATTR_NORMAL:s=Bu.binding;break;case exports.GFXAttributeName.ATTR_TANGENT:s=Uu.binding;break;default:c("Unexpected attribute!")}void 0!==s&&(r.bindSampler(s,o.sampler),r.bindTextureView(s,o.texture.getGFXTextureView()))}r.bindBuffer(Nu.BLOCK.binding,t.buffer),r.update()},destroy:function(){}}}}]),e}(),$u=function(){function e(t,i){Z(this,e),this._targetCount=void 0,this._localBuffer=void 0,this._remoteBuffer=void 0,this._targetCount=i,this._localBuffer=new DataView(new ArrayBuffer(Nu.SIZE)),this._remoteBuffer=t.createBuffer({usage:exports.GFXBufferUsageBit.UNIFORM|exports.GFXBufferUsageBit.TRANSFER_DST,memUsage:exports.GFXMemoryUsageBit.HOST|exports.GFXMemoryUsageBit.DEVICE,size:Nu.SIZE,stride:Nu.SIZE})}return J(e,[{key:"destroy",value:function(){this._remoteBuffer.destroy()}},{key:"setWeights",value:function(e){e.length,this._targetCount;for(var t=0;t<e.length;++t)this._localBuffer.setFloat32(Nu.OFFSET_OF_WEIGHTS+4*t,e[t],cc.sys.isLittleEndian)}},{key:"setMorphTextureInfo",value:function(e,t){this._localBuffer.setFloat32(Nu.OFFSET_OF_DISPLACEMENT_TEXTURE_WIDTH,e,cc.sys.isLittleEndian),this._localBuffer.setFloat32(Nu.OFFSET_OF_DISPLACEMENT_TEXTURE_HEIGHT,t,cc.sys.isLittleEndian)}},{key:"commit",value:function(){this._remoteBuffer.update(this._localBuffer.buffer,this._localBuffer.byteOffset,this._localBuffer.byteLength)}},{key:"buffer",get:function(){return this._remoteBuffer}}]),e}();function ec(e){switch(e){case 1:return Uint8Array;case 2:return Uint16Array;case 4:return Uint32Array}return Uint8Array}var tc=function(){function e(t,i,n){Z(this,e),this.vertexBuffers=void 0,this.attributes=void 0,this.primitiveMode=void 0,this.indexBuffer=void 0,this.indirectBuffer=void 0,this.mesh=void 0,this.subMeshIdx=void 0,this._flatBuffers=void 0,this._jointMappedBuffers=void 0,this._jointMappedBufferIndices=void 0,this._vertexIdChannel=void 0,this._geometricInfo=void 0,this.vertexBuffers=t,this.attributes=i,this.primitiveMode=n}return J(e,[{key:"geometricInfo",get:function(){if(this._geometricInfo)return this._geometricInfo;if(void 0===this.mesh)return{positions:new Float32Array,indices:new Uint8Array,boundingBox:{min:Ii.ZERO,max:Ii.ZERO}};if(void 0===this.subMeshIdx)return{positions:new Float32Array,indices:new Uint8Array,boundingBox:{min:Ii.ZERO,max:Ii.ZERO}};var e=this.mesh,t=this.subMeshIdx,i=e.readAttribute(t,exports.GFXAttributeName.ATTR_POSITION),n=e.readIndices(t),r=new Ii,a=new Ii,o=this.attributes.find((function(e){return e.name===cc.GFXAttributeName.ATTR_POSITION}));if(o){var s=yr[o.format].count;2===s?(r.set(i[0],i[1],0),a.set(i[0],i[1],0)):(r.set(i[0],i[1],i[2]),a.set(i[0],i[1],i[2]));for(var l=0;l<i.length;l+=s)2===s?(r.x=i[l]>r.x?i[l]:r.x,r.y=i[l+1]>r.y?i[l+1]:r.y,a.x=i[l]<a.x?i[l]:a.x,a.y=i[l+1]<a.y?i[l+1]:a.y):(r.x=i[l]>r.x?i[l]:r.x,r.y=i[l+1]>r.y?i[l+1]:r.y,r.z=i[l+2]>r.z?i[l+2]:r.z,a.x=i[l]<a.x?i[l]:a.x,a.y=i[l+1]<a.y?i[l+1]:a.y,a.z=i[l+2]<a.z?i[l+2]:a.z)}return this._geometricInfo={positions:i,indices:n,boundingBox:{max:r,min:a}},this._geometricInfo}},{key:"flatBuffers",get:function(){if(this._flatBuffers)return this._flatBuffers;var e=this._flatBuffers=[];if(!this.mesh||void 0===this.subMeshIdx)return e;var t=this.mesh,i=0,n=t.struct.primitives[this.subMeshIdx];n.indexView&&(i=n.indexView.count);for(var r,a=_e(n.vertexBundelIndices);!(r=a()).done;){var o=r.value,s=t.struct.vertexBundles[o],l=n.indexView?n.indexView.count:s.view.count,u=s.view.stride,c=u*l,h=new Uint8Array(t.data.buffer,s.view.offset,s.view.length);if(n.indexView){for(var p=new Uint8Array(c),_=t.readIndices(this.subMeshIdx),f=0;f<i;++f)for(var d=f*u,m=_[f]*u,v=0;v<u;++v)p[d+v]=h[m+v];this._flatBuffers.push({stride:u,count:l,buffer:p})}else this._flatBuffers.push({stride:u,count:l,buffer:h})}return this._flatBuffers}},{key:"jointMappedBuffers",get:function(){var e=this;if(this._jointMappedBuffers)return this._jointMappedBuffers;var t=this._jointMappedBuffers=[],i=this._jointMappedBufferIndices=[];if(!this.mesh||void 0===this.subMeshIdx)return this._jointMappedBuffers=this.vertexBuffers;var n,r,a=this.mesh.struct,o=a.primitives[this.subMeshIdx];if(!a.jointMaps||void 0===o.jointMapIndex||!a.jointMaps[o.jointMapIndex])return this._jointMappedBuffers=this.vertexBuffers;for(var s=cc.director.root.device,l=0;l<o.vertexBundelIndices.length;l++){var u=a.vertexBundles[o.vertexBundelIndices[l]];r=0,n=exports.GFXFormat.UNKNOWN;for(var c=0;c<u.attributes.length;c++){var h=u.attributes[c];if(h.name===exports.GFXAttributeName.ATTR_JOINTS){n=h.format;break}r+=yr[h.format].size}n?function(){var c=new Uint8Array(e.mesh.data.buffer,u.view.offset,u.view.length),h=new DataView(c.slice().buffer),p=a.jointMaps[o.jointMapIndex];el(h,(function(e){return p.indexOf(e)}),n,r,u.view.length,u.view.stride,h);var _=s.createBuffer({usage:exports.GFXBufferUsageBit.VERTEX|exports.GFXBufferUsageBit.TRANSFER_DST,memUsage:exports.GFXMemoryUsageBit.HOST|exports.GFXMemoryUsageBit.DEVICE,size:u.view.length,stride:u.view.stride});_.update(h.buffer),t.push(_),i.push(l)}():t.push(this.vertexBuffers[o.vertexBundelIndices[l]])}return this._vertexIdChannel&&t.push(this._allocVertexIdBuffer(s)),t}}]),J(e,[{key:"destroy",value:function(){for(var e=0;e<this.vertexBuffers.length;e++)this.vertexBuffers[e].destroy();if(this.vertexBuffers.length=0,this.indexBuffer&&(this.indexBuffer.destroy(),this.indexBuffer=void 0),this._jointMappedBuffers&&this._jointMappedBufferIndices){for(var t=0;t<this._jointMappedBufferIndices.length;t++)this._jointMappedBuffers[this._jointMappedBufferIndices[t]].destroy();this._jointMappedBuffers=void 0,this._jointMappedBufferIndices=void 0}this.indirectBuffer&&(this.indirectBuffer.destroy(),this.indirectBuffer=void 0)}},{key:"enableVertexIdChannel",value:function(e){if(!this._vertexIdChannel){var t=this.vertexBuffers.length,i=this.attributes.length,n=this._allocVertexIdBuffer(e);this.vertexBuffers.push(n),this.attributes.push({name:"a_vertexId",format:exports.GFXFormat.R32F,stream:t,isNormalized:!1}),this._vertexIdChannel={stream:t,index:i}}}},{key:"_allocVertexIdBuffer",value:function(e){for(var t=0===this.vertexBuffers.length||0===this.vertexBuffers[0].stride?0:this.vertexBuffers[0].size/this.vertexBuffers[0].stride,i=new Float32Array(t),n=0;n<t;++n)i[n]=n;var r=e.createBuffer({usage:exports.GFXBufferUsageBit.VERTEX|exports.GFXBufferUsageBit.TRANSFER_DST,memUsage:exports.GFXMemoryUsageBit.HOST|exports.GFXMemoryUsageBit.DEVICE,size:i.byteLength,stride:i.BYTES_PER_ELEMENT});return r.update(i),r}}]),e}(),ic=new Ii,nc=new Ii,rc=Yo("cc.Mesh")((Yu=de((qu=function(e){function t(){var e;return Z(this,t),fe(e=re(this,te(t).call(this)),"_struct",Yu,ne(e)),fe(e,"_dataLength",Ku,ne(e)),fe(e,"_hash",Zu,ne(e)),e._data=null,e._initialized=!1,e._renderingSubMeshes=null,e._boneSpaceBounds=new Map,e._jointBufferIndices=null,e.morphRendering=null,e.loaded=!1,e}return ee(t,zl),J(t,[{key:"_nativeAsset",get:function(){return this._data.buffer},set:function(e){this._data&&this._data.byteLength===e.byteLength?(this._data.set(new Uint8Array(e)),cc.loader._cache[this.nativeUrl]&&(cc.loader._cache[this.nativeUrl].content=this._data.buffer)):this._data=new Uint8Array(e),this.loaded=!0,this.emit("load")}},{key:"subMeshCount",get:function(){var e=this.renderingSubMeshes;return e?e.length:0}},{key:"minPosition",get:function(){return this.struct.minPosition}},{key:"maxPosition",get:function(){return this.struct.maxPosition}},{key:"struct",get:function(){return this._struct}},{key:"data",get:function(){return this._data}},{key:"hash",get:function(){return!this._hash&&this._data&&(this._hash=rl(this._data,666)),this._hash}},{key:"jointBufferIndices",get:function(){return this._jointBufferIndices?this._jointBufferIndices:this._jointBufferIndices=this._struct.primitives.map((function(e){return e.jointMapIndex||0}))}}]),J(t,[{key:"initialize",value:function(){var e=this;if(!this._initialized){var t,i;this._initialized=!0,this._data||(this._data=new Uint8Array(this._dataLength),(t=this).loaded?i&&i():t.nativeUrl?cc.loader.load({url:t.nativeUrl},(function(e,n){n&&(t.loaded||(t._nativeAsset=n)),i&&i(e)})):i&&i());for(var n=this._data.buffer,r=cc.director.root.device,a=this._createVertexBuffers(r,n),o=[],s=function(t){var i=e._struct.primitives[t];if(0===i.vertexBundelIndices.length)return"continue";var s=void 0,l=null;if(i.indexView){var u=i.indexView,c=u.stride,h=u.length;if(4===c&&!r.hasFeature(exports.GFXFeature.ELEMENT_INDEX_UINT)){var p=e._struct.vertexBundles[i.vertexBundelIndices[0]].view.count;if(p>=65536)return g(10001,p,65536),"continue";c>>=1,h>>=1}s=r.createBuffer({usage:exports.GFXBufferUsageBit.INDEX|exports.GFXBufferUsageBit.TRANSFER_DST,memUsage:exports.GFXMemoryUsageBit.HOST|exports.GFXMemoryUsageBit.DEVICE,size:h,stride:c}),l=new(ec(u.stride))(n,u.offset,u.count),u.stride!==c&&(l=ec(c).from(l)),e.loaded?s.update(l):e.once("load",(function(){s.update(l)}))}var _=i.vertexBundelIndices.map((function(e){return a[e]})),f=[];if(i.vertexBundelIndices.length>0){var d=i.vertexBundelIndices[0];f=e._struct.vertexBundles[d].attributes}var m=new tc(_,f,i.primitiveMode);m.mesh=e,m.subMeshIdx=t,m.indexBuffer=s,o.push(m)},l=0;l<this._struct.primitives.length;l++)s(l);this._renderingSubMeshes=o,this._struct.morph&&(this.morphRendering=function(e,t){return new Qu(e,t)}(this,r))}}},{key:"destroy",value:function(){return this.destroyRenderingMesh(),oe(te(t.prototype),"destroy",this).call(this)}},{key:"destroyRenderingMesh",value:function(){if(this._renderingSubMeshes){for(var e=0;e<this._renderingSubMeshes.length;e++)this._renderingSubMeshes[e].destroy();this._renderingSubMeshes=null,this._data=null,this._initialized=!1}}},{key:"assign",value:function(e,t){this.reset({struct:e,data:t})}},{key:"reset",value:function(e){this.destroyRenderingMesh(),this._struct=e.struct,this._data=e.data,this._hash=0,this.loaded=!0,this.emit("load")}},{key:"getBoneSpaceBounds",value:function(e){if(this._boneSpaceBounds.has(e.hash))return this._boneSpaceBounds.get(e.hash);var t=[];this._boneSpaceBounds.set(e.hash,t);for(var i=[],n=e.bindposes,r=0;r<n.length;r++)t.push(new lo(1/0,1/0,1/0,-1/0,-1/0,-1/0)),i.push(!1);for(var a=this._struct.primitives,o=0;o<a.length;o++){var s=this.readAttribute(o,exports.GFXAttributeName.ATTR_JOINTS),l=this.readAttribute(o,exports.GFXAttributeName.ATTR_WEIGHTS),u=this.readAttribute(o,exports.GFXAttributeName.ATTR_POSITION);if(s&&l&&u)for(var c=Math.min(s.length/4,l.length/4,u.length/3),h=0;h<c;h++){Ii.set(ic,u[3*h+0],u[3*h+1],u[3*h+2]);for(var p=0;p<4;++p){var _=4*h+p,f=s[_];if(!(0===l[_]||f>=n.length)){Ii.transformMat4(nc,ic,n[f]),i[f]=!0;var d=t[f];Ii.min(d.center,d.center,nc),Ii.max(d.halfExtents,d.halfExtents,nc)}}}}for(var m=0;m<n.length;m++){var v=t[m];i[m]?lo.fromPoints(v,v.center,v.halfExtents):t[m]=null}return t}},{key:"merge",value:function(e,t,i){if(i&&(!this.loaded||!e.loaded||!this.validateMergingMesh(e)))return!1;var n=new Ii,r=t&&new Xi,a=t&&new lo;if(r&&t.getRotation(r),!this._initialized&&e._data){var o=JSON.parse(JSON.stringify(e._struct)),s=e._data.slice();if(t){o.maxPosition&&o.minPosition&&(Ii.add(a.center,o.maxPosition,o.minPosition),Ii.multiplyScalar(a.center,a.center,.5),Ii.subtract(a.halfExtents,o.maxPosition,o.minPosition),Ii.multiplyScalar(a.halfExtents,a.halfExtents,.5),lo.transform(a,a,t),Ii.add(o.maxPosition,a.center,a.halfExtents),Ii.subtract(o.minPosition,a.center,a.halfExtents));for(var l=0;l<o.vertexBundles.length;l++)for(var u=o.vertexBundles[l],c=0;c<u.attributes.length;c++)if(u.attributes[c].name===exports.GFXAttributeName.ATTR_POSITION||u.attributes[c].name===exports.GFXAttributeName.ATTR_NORMAL){var h=u.attributes[c].format,p=new DataView(s.buffer,u.view.offset+ac(u.attributes,c)),_=mc(p,h),f=vc(p,h);if(!_||!f)continue;for(var d=u.view.count,m=u.view.stride,v=dc(h),y=0;y<d;y++){var g=y*m,x=g+v,b=x+v;switch(n.set(_(g),_(x),_(b)),u.attributes[c].name){case exports.GFXAttributeName.ATTR_POSITION:n.transformMat4(t);break;case exports.GFXAttributeName.ATTR_NORMAL:Ii.transformQuat(n,n,r)}f(g,n.x),f(x,n.y),f(b,n.z)}}}return this.reset({struct:o,data:s}),this.initialize(),!0}for(var T,S,E,w,C,A=new tl,O=0,k=0,R=0,F=0,M=0,I=0,P=0,L=0,D=!1,N=new Array(this._struct.vertexBundles.length),z=0;z<this._struct.vertexBundles.length;++z){var B=this._struct.vertexBundles[z],G=e._struct.vertexBundles[z];R=B.view.offset,F=G.view.offset,k=B.view.stride,O=B.view.count+G.view.count,T=new ArrayBuffer(O*k),S=new Uint8Array(T),R+=(E=this._data.subarray(R,R+B.view.length)).length,F+=(w=e._data.subarray(F,F+G.view.length)).length,S.set(E),M=0;for(var U,X=_e(B.attributes);!(U=X()).done;){var V=U.value;P=0,D=!1;for(var H,W=_e(G.attributes);!(H=W()).done;){var j=H.value;if(V.name===j.name&&V.format===j.format){D=!0;break}P+=yr[j.format].size}if(D){L=yr[V.format].size,I=B.view.length+M;for(var q=0;q<G.view.count;++q){if(C=w.subarray(P,P+L),S.set(C,I),(V.name===exports.GFXAttributeName.ATTR_POSITION||V.name===exports.GFXAttributeName.ATTR_NORMAL)&&t){var Y=new Float32Array(S.buffer,I,3);switch(n.set(Y[0],Y[1],Y[2]),V.name){case exports.GFXAttributeName.ATTR_POSITION:n.transformMat4(t);break;case exports.GFXAttributeName.ATTR_NORMAL:Ii.transformQuat(n,n,r)}Y[0]=n.x,Y[1]=n.y,Y[2]=n.z}I+=B.view.stride,P+=G.view.stride}}M+=yr[V.format].size}N[z]={attributes:B.attributes,view:{offset:A.getLength(),length:T.byteLength,count:O,stride:k}},A.addBuffer(T)}for(var K,Z,Q,J=0,$=2,ee=0,te=new Array(this._struct.primitives.length),ie=0;ie<this._struct.primitives.length;++ie){var ne=this._struct.primitives[ie],re=e._struct.primitives[ie];te[ie]={primitiveMode:ne.primitiveMode,vertexBundelIndices:ne.vertexBundelIndices};for(var ae,oe=_e(ne.vertexBundelIndices);!(ae=oe()).done;){var se=ae.value;ee=Math.max(ee,this._struct.vertexBundles[se].view.count)}if(ne.indexView&&re.indexView){J=ne.indexView.count,J+=re.indexView.count,R=ne.indexView.offset,F=re.indexView.offset,$=J<256?1:J<65536?2:4;var le=new ArrayBuffer(J*$);if(K=2===$?new Uint16Array(le):1===$?new Uint8Array(le):new Uint32Array(le),Z=2===ne.indexView.stride?new Uint16Array(this._data.buffer,R,ne.indexView.count):1===ne.indexView.stride?new Uint8Array(this._data.buffer,R,ne.indexView.count):new Uint32Array(this._data.buffer,R,ne.indexView.count),$===ne.indexView.stride)K.set(Z);else for(var ue=0;ue<ne.indexView.count;++ue)K[ue]=Z[ue];R+=ne.indexView.length,Q=2===re.indexView.stride?new Uint16Array(e._data.buffer,F,re.indexView.count):1===re.indexView.stride?new Uint8Array(e._data.buffer,F,re.indexView.count):new Uint32Array(e._data.buffer,F,re.indexView.count);for(var ce=0;ce<re.indexView.count;++ce)K[ne.indexView.count+ce]=ee+Q[ce];F+=re.indexView.length,te[ie].indexView={offset:A.getLength(),length:le.byteLength,count:J,stride:$},A.setNextAlignment($),A.addBuffer(le)}}var he={vertexBundles:N,primitives:te,minPosition:this._struct.minPosition,maxPosition:this._struct.maxPosition};return he.minPosition&&e._struct.minPosition&&he.maxPosition&&e._struct.maxPosition&&(t?(Ii.add(a.center,e._struct.maxPosition,e._struct.minPosition),Ii.multiplyScalar(a.center,a.center,.5),Ii.subtract(a.halfExtents,e._struct.maxPosition,e._struct.minPosition),Ii.multiplyScalar(a.halfExtents,a.halfExtents,.5),lo.transform(a,a,t),Ii.add(n,a.center,a.halfExtents),Ii.max(he.maxPosition,he.maxPosition,n),Ii.subtract(n,a.center,a.halfExtents),Ii.min(he.minPosition,he.minPosition,n)):(Ii.min(he.minPosition,he.minPosition,e._struct.minPosition),Ii.max(he.maxPosition,he.maxPosition,e._struct.maxPosition))),this.reset({struct:he,data:new Uint8Array(A.getCombined())}),this.initialize(),!0}},{key:"validateMergingMesh",value:function(e){if(!this._data&&e._data)return!0;if(this._struct.vertexBundles.length!==e._struct.vertexBundles.length)return!1;for(var t=0;t<this._struct.vertexBundles.length;++t){var i=this._struct.vertexBundles[t],n=e._struct.vertexBundles[t];if(i.attributes.length!==n.attributes.length)return!1;for(var r=0;r<i.attributes.length;++r)if(i.attributes[r].format!==n.attributes[r].format)return!1}if(this._struct.primitives.length!==e._struct.primitives.length)return!1;for(var a=0;a<this._struct.primitives.length;++a){var o=this._struct.primitives[a],s=e._struct.primitives[a];if(o.vertexBundelIndices.length!==s.vertexBundelIndices.length)return!1;for(var l=0;l<o.vertexBundelIndices.length;++l)if(o.vertexBundelIndices[l]!==s.vertexBundelIndices[l])return!1;if(o.primitiveMode!==s.primitiveMode)return!1;if(o.indexView){if(void 0===s.indexView)return!1}else if(s.indexView)return!1}return!0}},{key:"readAttribute",value:function(e,t){var i=this,n=null;return this._accessAttribute(e,t,(function(e,t){var r=e.attributes[t].format,a=new DataView(i._data.buffer,e.view.offset+ac(e.attributes,t)),o=yr[r],s=Sr(yr[r]),l=mc(a,r);if(s&&l){for(var u=e.view.count,c=o.count,h=new s(u*c),p=e.view.stride,_=0;_<u;++_)for(var f=0;f<c;++f)h[c*_+f]=l(p*_+h.BYTES_PER_ELEMENT*f);n=h}})),n}},{key:"copyAttribute",value:function(e,t,i,n,r){var a=this,o=!1;return this._accessAttribute(e,t,(function(e,t){var s=e.attributes[t].format,l=new DataView(a._data.buffer,e.view.offset+ac(e.attributes,t)),u=new DataView(i,r),c=yr[s],h=mc(l,s),p=vc(u,s);if(h&&p){for(var _=e.view.count,f=c.count,d=e.view.stride,m=dc(s),v=n,y=m,g=0;g<_;++g)for(var x=0;x<f;++x){p(v*g+y*x,h(d*g+m*x))}o=!0}})),o}},{key:"readIndices",value:function(e){if(!this._data||e>=this._struct.primitives.length)return null;var t=this._struct.primitives[e];if(!t.indexView)return null;var i=t.indexView.stride;return new(1===i?Uint8Array:2===i?Uint16Array:Uint32Array)(this._data.buffer,t.indexView.offset,t.indexView.count)}},{key:"copyIndices",value:function(e,t){if(!this._data||e>=this._struct.primitives.length)return!1;var i=this._struct.primitives[e];if(!i.indexView)return!1;for(var n=i.indexView.count,r=1===i.indexView.stride?exports.GFXFormat.R8UI:2===i.indexView.stride?exports.GFXFormat.R16UI:exports.GFXFormat.R32UI,a=mc(new DataView(this._data.buffer),r),o=0;o<n;++o)t[o]=a(i.indexView.offset+yr[r].size*o);return!0}},{key:"_accessAttribute",value:function(e,t,i){if(this._data&&!(e>=this._struct.primitives.length))for(var n,r=_e(this._struct.primitives[e].vertexBundelIndices);!(n=r()).done;){var a=n.value,o=this._struct.vertexBundles[a],s=o.attributes.findIndex((function(e){return e.name===t}));if(!(s<0)){i(o,s);break}}}},{key:"_createVertexBuffers",value:function(e,t){var i=this;return this._struct.vertexBundles.map((function(n){var r=e.createBuffer({usage:exports.GFXBufferUsageBit.VERTEX|exports.GFXBufferUsageBit.TRANSFER_DST,memUsage:exports.GFXMemoryUsageBit.HOST|exports.GFXMemoryUsageBit.DEVICE,size:n.view.length,stride:n.view.stride}),a=new Uint8Array(t,n.view.offset,n.view.length);return i.loaded?r.update(a):i.once("load",(function(){r.update(a)})),r}))}},{key:"renderingSubMeshes",get:function(){return this.initialize(),this._renderingSubMeshes}}]),t}()).prototype,"_struct",[Ko],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return{vertexBundles:[],primitives:[]}}}),Ku=de(qu.prototype,"_dataLength",[Ko],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return 0}}),Zu=de(qu.prototype,"_hash",[Ko],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return 0}}),ju=qu))||ju;function ac(e,t){for(var i=0,n=0;n<t;++n){var r=e[n];i+=yr[r.format].size}return i}cc.Mesh=rc;var oc,sc,lc,uc,hc,pc,_c,fc=Cs.isLittleEndian;function dc(e){var t=yr[e];return t.size/t.count}function mc(e,t){var i=yr[t],n=i.size/i.count;switch(i.type){case exports.GFXFormatType.UNORM:switch(n){case 1:return function(t){return e.getUint8(t)};case 2:return function(t){return e.getUint16(t,fc)};case 4:return function(t){return e.getUint32(t,fc)}}break;case exports.GFXFormatType.SNORM:case exports.GFXFormatType.INT:switch(n){case 1:return function(t){return e.getInt8(t)};case 2:return function(t){return e.getInt16(t,fc)};case 4:return function(t){return e.getInt32(t,fc)}}break;case exports.GFXFormatType.UINT:switch(n){case 1:return function(t){return e.getUint8(t)};case 2:return function(t){return e.getUint16(t,fc)};case 4:return function(t){return e.getUint32(t,fc)}}break;case exports.GFXFormatType.FLOAT:return function(t){return e.getFloat32(t,fc)}}return null}function vc(e,t){var i=yr[t],n=i.size/i.count;switch(i.type){case exports.GFXFormatType.UNORM:switch(n){case 1:return function(t,i){return e.setUint8(t,i)};case 2:return function(t,i){return e.setUint16(t,i,fc)};case 4:return function(t,i){return e.setUint32(t,i,fc)}}break;case exports.GFXFormatType.SNORM:case exports.GFXFormatType.INT:switch(n){case 1:return function(t,i){return e.setInt8(t,i)};case 2:return function(t,i){return e.setInt16(t,i,fc)};case 4:return function(t,i){return e.setInt32(t,i,fc)}}break;case exports.GFXFormatType.UINT:switch(n){case 1:return function(t,i){return e.setUint8(t,i)};case 2:return function(t,i){return e.setUint16(t,i,fc)};case 4:return function(t,i){return e.setUint32(t,i,fc)}}break;case exports.GFXFormatType.FLOAT:return function(t,i){return e.setFloat32(t,i,fc)}}return null}bt(Fl);var yc,gc=(oc=Yo("cc.RenderTexture"),sc=Ko({type:Fl}),oc((_c=pc=function(e){function t(){var e,i;Z(this,t);for(var n=arguments.length,r=new Array(n),a=0;a<n;a++)r[a]=arguments[a];return(i=re(this,(e=te(t)).call.apply(e,[this].concat(r))))._window=null,fe(i,"_depthStencilFormat",hc,ne(i)),i}return ee(t,lu),J(t,[{key:"getGFXWindow",value:function(){return this._window}},{key:"getGFXTextureView",value:function(){return this._window?this._window.colorTexView:null}},{key:"getGFXStencilTexture",value:function(){return this._window?this._window.depthStencilTexView:null}},{key:"reset",value:function(e){e&&(this._width=e.width,this._height=e.height,e.colorFormat&&(this._format=e.colorFormat),e.depthStencilFormat&&(this._depthStencilFormat=e.depthStencilFormat),this._tryResetWindow(),this.emit("resize",this))}},{key:"destroy",value:function(){return this._window&&(cc.director.root.destroyWindow(this._window),this._window=null),oe(te(t.prototype),"destroy",this).call(this)}},{key:"onLoaded",value:function(){this._tryResetWindow()}},{key:"_serialize",value:function(e){return{base:oe(te(t.prototype),"_serialize",this).call(this),name:this._name,width:this._width,height:this._height,colorFormat:this._format,depthStencilFormat:this._depthStencilFormat}}},{key:"_deserialize",value:function(e,i){oe(te(t.prototype),"_deserialize",this).call(this,e.base,i);var n=e;this.name=n.name||"",this._width=n.width,this._height=n.height,this._format=n.colorFormat,this._depthStencilFormat=n.depthStencilFormat}},{key:"_tryResetWindow",value:function(){var e=this._getGFXDevice();e&&(this._window&&this._window.destroy(),this._createWindow(e))}},{key:"_createWindow",value:function(e){var t={title:this.name,isOffscreen:!0,width:this._width,height:this._height,colorFmt:this._format,depthStencilFmt:this._depthStencilFormat};if(this._window)return this._window.initialize(t),this._window;this._window=cc.director.root.createWindow(t),this.loaded=!0,this.emit("load")}},{key:"width",get:function(){return this._width},set:function(e){this._width=e,this.reset()}},{key:"height",get:function(){return this._height},set:function(e){this._height=e,this.reset()}},{key:"depthStencilFormat",get:function(){return this._depthStencilFormat},set:function(e){this._depthStencilFormat=e,this.reset()}}]),t}(),pc.DepthStencilFormat=Fl,hc=de((uc=_c).prototype,"_depthStencilFormat",[Ko],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return Fl.NONE}}),de(uc.prototype,"width",[Ko],Object.getOwnPropertyDescriptor(uc.prototype,"width"),uc.prototype),de(uc.prototype,"height",[Ko],Object.getOwnPropertyDescriptor(uc.prototype,"height"),uc.prototype),de(uc.prototype,"depthStencilFormat",[sc],Object.getOwnPropertyDescriptor(uc.prototype,"depthStencilFormat"),uc.prototype),lc=uc))||lc);cc.RenderTexture=gc;var xc,bc,Tc,Sc,Ec,wc,Cc=[{u:0,v:0},{u:0,v:0},{u:0,v:0},{u:0,v:0}],Ac=Yo("cc.SpriteFrame")(yc=function(e){function t(){var e;return Z(this,t),(e=re(this,te(t).call(this))).vertices=null,e.uv=[],e.uvHash=0,e.uvSliced=[],e._rect=new nn,e._offset=new ki,e._originalSize=new en,e._rotated=!1,e._capInsets=[0,0,0,0],e._atlasUuid="",e._texture=void 0,e._flipUv=!1,e}return ee(t,zl),J(t,[{key:"insetTop",get:function(){return this._capInsets[1]},set:function(e){this._capInsets[1]!==e&&(this._capInsets[1]=e,this._texture&&this._calculateSlicedUV())}},{key:"insetBottom",get:function(){return this._capInsets[3]},set:function(e){this._capInsets[3]!==e&&(this._capInsets[3]=e,this._texture&&this._calculateSlicedUV())}},{key:"insetLeft",get:function(){return this._capInsets[0]},set:function(e){this._capInsets[0]!==e&&(this._capInsets[0]=e,this._texture&&this._calculateSlicedUV())}},{key:"insetRight",get:function(){return this._capInsets[2]},set:function(e){this._capInsets[2]!==e&&(this._capInsets[2]=e,this._texture&&this._calculateSlicedUV())}},{key:"rect",get:function(){return this._rect},set:function(e){this._rect.equals(e)||(this._rect.set(e),this._texture&&this._calculateUV())}},{key:"originalSize",get:function(){return this._originalSize},set:function(e){this._originalSize.equals(e)||(this._originalSize.set(e),this._texture&&this._calculateUV())}},{key:"offset",get:function(){return this._offset},set:function(e){this._offset.set(e)}},{key:"rotated",get:function(){return this._rotated},set:function(e){this._rotated!==e&&(this._rotated=e,this._texture&&this._calculateUV())}},{key:"texture",get:function(){return this._texture},set:function(e){e?this.reset({texture:e},!0):console.warn("Error Texture in ".concat(this.name))}},{key:"atlasUuid",get:function(){return this._atlasUuid},set:function(e){this._atlasUuid=e}},{key:"width",get:function(){return this._texture.width}},{key:"height",get:function(){return this._texture.height}},{key:"_textureSource",set:function(e){e&&(this._refreshTexture(e),this._calculateUV())}}],[{key:"createWithImage",value:function(e){var i=e instanceof Gl?e:new Gl(e),n=new gu;n.image=i;var r=new t;return r.texture=n,r}}]),J(t,[{key:"textureLoaded",value:function(){return this.texture&&this.texture.loaded}},{key:"isRotated",value:function(){return this._rotated}},{key:"setRotated",value:function(e){this.rotated=e}},{key:"getRect",value:function(e){return e?(e.set(this._rect),e):this._rect.clone()}},{key:"setRect",value:function(e){this.rect=e}},{key:"getOriginalSize",value:function(e){return e?(e.set(this._originalSize),e):this._originalSize.clone()}},{key:"setOriginalSize",value:function(e){this.originalSize=e}},{key:"getOffset",value:function(e){return e?(e.set(this._offset),e):this._offset.clone()}},{key:"setOffset",value:function(e){this.offset=e}},{key:"getGFXTextureView",value:function(){return this._texture.getGFXTextureView()}},{key:"getGFXSampler",value:function(){return this._texture.getGFXSampler()}},{key:"reset",value:function(e){var t=arguments.length>1&&void 0!==arguments[1]&&arguments[1],i=!1;t&&(this._originalSize.set(0,0),this._rect.set(0,0,0,0),this._offset.set(0,0),this._capInsets=[0,0,0,0],this._rotated=!1,i=!0),e&&(e.texture&&(this.loaded=!1,this._rect.x=this._rect.y=0,this._rect.width=e.texture.width,this._rect.height=e.texture.height,this._refreshTexture(e.texture),this.checkRect(this._texture)),e.originalSize&&this._originalSize.set(e.originalSize),e.rect&&this._rect.set(e.rect),e.offset&&this._offset.set(e.offset),void 0!==e.borderTop&&(this._capInsets[1]=e.borderTop),void 0!==e.borderBottom&&(this._capInsets[3]=e.borderBottom),void 0!==e.borderLeft&&(this._capInsets[0]=e.borderLeft),void 0!==e.borderRight&&(this._capInsets[2]=e.borderRight),void 0!==e.isRotate&&(this._rotated=!!e.isRotate),void 0!==e.isFlipUv&&(this._flipUv=!!e.isFlipUv),this._texture instanceof gc&&(this._flipUv=!0),i=!0),i&&this.texture&&this._calculateUV()}},{key:"checkRect",value:function(e){var t=this._rect,i=t.x,n=t.y;return this._rotated?(i+=t.height,n+=t.width):(i+=t.width,n+=t.height),i>e.width?(cc.errorID(3300,this.name+"/"+e.name,i,e.width),!1):!(n>e.height)||(cc.errorID(3301,this.name+"/"+e.name,n,e.height),!1)}},{key:"onLoaded",value:function(){this.loaded=!0,this.emit("load")}},{key:"destroy",value:function(){return oe(te(t.prototype),"destroy",this).call(this)}},{key:"_calculateSlicedUV",value:function(){var e=this._rect,t=this.texture,i=t.width,n=t.height,r=this._capInsets[0],a=this._capInsets[2],o=e.width-r-a,s=this._capInsets[1],l=this._capInsets[3],u=e.height-s-l,c=this.uvSliced;if(c.length=0,this._rotated){Cc[0].u=(e.x+.5)/i,Cc[1].u=(e.x+l)/i,Cc[2].u=(e.x+l+u)/i,Cc[3].u=(e.x+e.height-.5)/i,Cc[3].v=(e.y+.5)/n,Cc[2].v=(e.y+r)/n,Cc[1].v=(e.y+r+o)/n,Cc[0].v=(e.y+e.width-.5)/n;for(var h=0;h<4;++h)for(var p=Cc[h],_=0;_<4;++_){var f=Cc[3-_];c.push({u:p.u,v:f.v})}}else{Cc[0].u=(e.x+.5)/i,Cc[1].u=(e.x+r)/i,Cc[2].u=(e.x+r+o)/i,Cc[3].u=(e.x+e.width-.5)/i,Cc[3].v=(e.y+.5)/n,Cc[2].v=(e.y+s)/n,Cc[1].v=(e.y+s+u)/n,Cc[0].v=(e.y+e.height-.5)/n;for(var d=0;d<4;++d)for(var m=Cc[d],v=0;v<4;++v){var y=Cc[v];c.push({u:y.u,v:m.v})}}}},{key:"_calculateUV",value:function(){var e=this._rect,t=this.uv,i=this.texture,n=i.width,r=i.height;if(this._rotated){var a=0===n?0:(e.x+.5)/n,o=0===n?0:(e.x+e.height-.5)/n,s=0===r?0:(e.y+.5)/r,l=0===r?0:(e.y+e.width-.5)/r;this._flipUv,t[0]=a,t[1]=s,t[2]=a,t[3]=l,t[4]=o,t[5]=s,t[6]=o,t[7]=l}else{var u=0===n?0:(e.x+.5)/n,c=0===n?0:(e.x+e.width-.5)/n,h=0===r?0:(e.y+e.height-.5)/r,p=0===r?0:(e.y+.5)/r;this._flipUv?(t[0]=u,t[1]=p,t[2]=c,t[3]=p,t[4]=u,t[5]=h,t[6]=c,t[7]=h):(t[0]=u,t[1]=h,t[2]=c,t[3]=h,t[4]=u,t[5]=p,t[6]=c,t[7]=p)}for(var _="",f=0;f<t.length;f++)_+=t[f];this.uvHash=rl(_,666);var d=this.vertices;if(d){d.nu.length=0,d.nv.length=0;for(var m=0;m<d.u.length;m++)d.nu[m]=d.u[m]/n,d.nv[m]=d.v[m]/r}this._calculateSlicedUV()}},{key:"_serialize",value:function(e){var t,i,n=this._rect,r=this._offset,a=this._originalSize,o=this._uuid;return this._texture&&(t=this._texture._uuid),o&&e&&(o=EditorExtends.UuidUtils.compressUuid(o,!0)),t&&e&&(t=EditorExtends.UuidUtils.compressUuid(t,!0)),this.vertices&&(i={triangles:this.vertices.triangles,x:this.vertices.x,y:this.vertices.y,u:this.vertices.u,v:this.vertices.v}),{name:this._name,atlas:e?void 0:this._atlasUuid,rect:n,offset:r,originalSize:a,rotated:this._rotated,capInsets:this._capInsets,vertices:i,texture:t}}},{key:"_deserialize",value:function(e,t){var i=e,n=i.rect;n&&(this._rect=new nn(n.x,n.y,n.width,n.height));var r=i.offset;i.offset&&(this._offset=new ki(r.x,r.y));var a=i.originalSize;i.originalSize&&(this._originalSize=new en(a.width,a.height)),this._rotated=!!i.rotated,this._name=i.name;var o=i.capInsets;o&&(this._capInsets[0]=o[0],this._capInsets[1]=o[1],this._capInsets[2]=o[2],this._capInsets[3]=o[3]),i.texture&&t.result.push(this,"_textureSource",i.texture),this.vertices=i.vertices,this.vertices&&(this.vertices.nu=[],this.vertices.nv=[])}},{key:"_textureLoaded",value:function(){var e=this._texture,t={},i=!1;0!==this._rect.width&&0!==this._rect.height&&this.checkRect(e)||(t.rect=new nn(0,0,e.width,e.height),i=!0),(0===this._originalSize.width||0===this._originalSize.height||i)&&(t.originalSize=new en(e.width,e.height),i=!0),i&&(this.reset(t),this.onLoaded())}},{key:"_refreshTexture",value:function(e){this._texture=e,e.loaded?this._textureLoaded():e.once("load",this._textureLoaded,this)}}]),t}())||yc;cc.SpriteFrame=Ac,function(e){e[e.right=0]="right",e[e.left=1]="left",e[e.top=2]="top",e[e.bottom=3]="bottom",e[e.front=4]="front",e[e.back=5]="back"}(wc||(wc={}));var Oc=Yo("cc.TextureCube")((Ec=Sc=function(e){function t(){var e;return Z(this,t),fe(e=re(this,te(t).call(this)),"_mipmaps",Tc,ne(e)),e}return ee(t,yu),J(t,[{key:"mipmaps",get:function(){return this._mipmaps},set:function(e){var t=this;if(this._mipmaps=e,this._setMipmapLevel(this._mipmaps.length),this._mipmaps.length>0){var i=this._mipmaps[0].front;this.reset({width:i.width,height:i.height,format:i.format,mipmapLevel:this._mipmaps.length}),this._mipmaps.forEach((function(e,i){kc(e,(function(e,n){t._assignImage(e,i,n)}))}))}else this.reset({width:0,height:0,mipmapLevel:this._mipmaps.length})}},{key:"image",get:function(){return 0===this._mipmaps.length?null:this._mipmaps[0]},set:function(e){this.mipmaps=e?[e]:[]}}],[{key:"fromTexture2DArray",value:function(e,i){for(var n=[],r=e.length/6,a=0;a<r;a++){var o=6*a;n.push({front:e[o+wc.front].image,back:e[o+wc.back].image,left:e[o+wc.left].image,right:e[o+wc.right].image,top:e[o+wc.top].image,bottom:e[o+wc.bottom].image})}return(i=i||new t).mipmaps=n,i}}]),J(t,[{key:"onLoaded",value:function(){this.mipmaps=this._mipmaps,this.loaded=!0,this.emit("load")}},{key:"reset",value:function(e){this._width=e.width,this._height=e.height,this._setGFXFormat(e.format),this._setMipmapLevel(e.mipmapLevel||1),this._tryReset()}},{key:"updateMipmaps",value:function(){var e=this,t=arguments.length>0&&void 0!==arguments[0]?arguments[0]:0,i=arguments.length>1?arguments[1]:void 0;if(!(t>=this._mipmaps.length))for(var n=Math.min(void 0===i?this._mipmaps.length:i,this._mipmaps.length-t),r=function(i){var n=t+i;kc(e._mipmaps[n],(function(t,i){e._assignImage(t,n,i)}))},a=0;a<n;++a)r(a)}},{key:"destroy",value:function(){return this._mipmaps=[],oe(te(t.prototype),"destroy",this).call(this)}},{key:"releaseTexture",value:function(){this.mipmaps=[]}},{key:"_serialize",value:function(e){return{base:oe(te(t.prototype),"_serialize",this).call(this),mipmaps:this._mipmaps.map((function(t){return e?{front:EditorExtends.UuidUtils.compressUuid(t.front._uuid,!0),back:EditorExtends.UuidUtils.compressUuid(t.back._uuid,!0),left:EditorExtends.UuidUtils.compressUuid(t.left._uuid,!0),right:EditorExtends.UuidUtils.compressUuid(t.right._uuid,!0),top:EditorExtends.UuidUtils.compressUuid(t.top._uuid,!0),bottom:EditorExtends.UuidUtils.compressUuid(t.bottom._uuid,!0)}:{front:t.front._uuid,back:t.back._uuid,left:t.left._uuid,right:t.right._uuid,top:t.top._uuid,bottom:t.bottom._uuid}}))}}},{key:"_deserialize",value:function(e,i){var n=e;oe(te(t.prototype),"_deserialize",this).call(this,n.base,i),this._mipmaps=new Array(n.mipmaps.length);for(var r=0;r<n.mipmaps.length;++r){this._mipmaps[r]={front:new Gl,back:new Gl,left:new Gl,right:new Gl,top:new Gl,bottom:new Gl};var a=n.mipmaps[r];i.result.push(this._mipmaps[r],"front",a.front),i.result.push(this._mipmaps[r],"back",a.back),i.result.push(this._mipmaps[r],"left",a.left),i.result.push(this._mipmaps[r],"right",a.right),i.result.push(this._mipmaps[r],"top",a.top),i.result.push(this._mipmaps[r],"bottom",a.bottom)}}},{key:"_getGfxTextureCreateInfo",value:function(e){var t=Object.assign({type:exports.GFXTextureType.TEX2D,width:this._width,height:this._height,arrayLayer:6},e);return t.flags=(t.flags||0)|exports.GFXTextureFlagBit.CUBEMAP,t}},{key:"_getGfxTextureViewCreateInfo",value:function(e){return Object.assign({type:exports.GFXTextureViewType.CUBE,layerCount:6},e)}}]),t}(),Sc.FaceIndex=wc,Tc=de((bc=Ec).prototype,"_mipmaps",[Ko],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return[]}}),xc=bc))||xc;function kc(e,t){t(e.front,wc.front),t(e.back,wc.back),t(e.left,wc.left),t(e.right,wc.right),t(e.top,wc.top),t(e.bottom,wc.bottom)}cc.TextureCube=Oc;var Rc,Fc,Mc=[{name:"builtin-billboard",_uuid:"711ebe11-f673-4cd9-9a83-63c60ba54c5b",techniques:[{name:"add",passes:[{rasterizerState:{cullMode:0},blendState:{targets:[{blend:!0,blendSrc:2,blendDst:1,blendSrcAlpha:2,blendDstAlpha:1}]},program:"builtin-billboard|vert:vs_main|tinted-fs:add",depthStencilState:{depthTest:!0,depthWrite:!1},properties:{mainTexture:{value:"grey",type:28},mainTiling_Offset:{value:[1,1,0,0],type:16},tintColor:{value:[.5,.5,.5,.5],type:16}}}]}],shaders:[{name:"builtin-billboard|vert:vs_main|tinted-fs:add",hash:3052980566,glsl3:{vert:"\nprecision mediump float;\nuniform Constants {\n  vec4 mainTiling_Offset;\n  vec4 frameTile_velLenScale;\n  vec4 scale;\n};\nuniform CCGlobal {\n  highp   vec4 cc_time;\n  mediump vec4 cc_screenSize;\n  mediump vec4 cc_screenScale;\n  mediump vec4 cc_nativeSize;\n  highp   mat4 cc_matView;\n  highp   mat4 cc_matViewInv;\n  highp   mat4 cc_matProj;\n  highp   mat4 cc_matProjInv;\n  highp   mat4 cc_matViewProj;\n  highp   mat4 cc_matViewProjInv;\n  highp   vec4 cc_cameraPos;\n  mediump vec4 cc_exposure;\n  mediump vec4 cc_mainLitDir;\n  mediump vec4 cc_mainLitColor;\n  mediump vec4 cc_ambientSky;\n  mediump vec4 cc_ambientGround;\n};\nuniform CCLocal {\n  highp mat4 cc_matWorld;\n  highp mat4 cc_matWorldIT;\n  highp vec4 cc_lightingMapUVParam;\n};\nvec4 quaternionFromAxis (vec3 xAxis,vec3 yAxis,vec3 zAxis){\n  mat3 m = mat3(xAxis,yAxis,zAxis);\n  float trace = m[0][0] + m[1][1] + m[2][2];\n  vec4 quat;\n  if (trace > 0.) {\n    float s = 0.5 / sqrt(trace + 1.0);\n    quat.w = 0.25 / s;\n    quat.x = (m[2][1] - m[1][2]) * s;\n    quat.y = (m[0][2] - m[2][0]) * s;\n    quat.z = (m[1][0] - m[0][1]) * s;\n  } else if ((m[0][0] > m[1][1]) && (m[0][0] > m[2][2])) {\n    float s = 2.0 * sqrt(1.0 + m[0][0] - m[1][1] - m[2][2]);\n    quat.w = (m[2][1] - m[1][2]) / s;\n    quat.x = 0.25 * s;\n    quat.y = (m[0][1] + m[1][0]) / s;\n    quat.z = (m[0][2] + m[2][0]) / s;\n  } else if (m[1][1] > m[2][2]) {\n    float s = 2.0 * sqrt(1.0 + m[1][1] - m[0][0] - m[2][2]);\n    quat.w = (m[0][2] - m[2][0]) / s;\n    quat.x = (m[0][1] + m[1][0]) / s;\n    quat.y = 0.25 * s;\n    quat.z = (m[1][2] + m[2][1]) / s;\n  } else {\n    float s = 2.0 * sqrt(1.0 + m[2][2] - m[0][0] - m[1][1]);\n    quat.w = (m[1][0] - m[0][1]) / s;\n    quat.x = (m[0][2] + m[2][0]) / s;\n    quat.y = (m[1][2] + m[2][1]) / s;\n    quat.z = 0.25 * s;\n  }\n  float len = quat.x * quat.x + quat.y * quat.y + quat.z * quat.z + quat.w * quat.w;\n  if (len > 0.) {\n    len = 1. / sqrt(len);\n    quat.x = quat.x * len;\n    quat.y = quat.y * len;\n    quat.z = quat.z * len;\n    quat.w = quat.w * len;\n  }\n  return quat;\n}\nvec4 quaternionFromEuler (vec3 angle){\n  float x = angle.x / 2.;\n  float y = angle.y / 2.;\n  float z = angle.z / 2.;\n  float sx = sin(x);\n  float cx = cos(x);\n  float sy = sin(y);\n  float cy = cos(y);\n  float sz = sin(z);\n  float cz = cos(z);\n  vec4 quat = vec4(0);\n  quat.x = sx * cy * cz + cx * sy * sz;\n  quat.y = cx * sy * cz + sx * cy * sz;\n  quat.z = cx * cy * sz - sx * sy * cz;\n  quat.w = cx * cy * cz - sx * sy * sz;\n  return quat;\n}\nvec4 quatMultiply (vec4 a, vec4 b){\n  vec4 quat;\n  quat.x = a.x * b.w + a.w * b.x + a.y * b.z - a.z * b.y;\n  quat.y = a.y * b.w + a.w * b.y + a.z * b.x - a.x * b.z;\n  quat.z = a.z * b.w + a.w * b.z + a.x * b.y - a.y * b.x;\n  quat.w = a.w * b.w - a.x * b.x - a.y * b.y - a.z * b.z;\n  return quat;\n}\nvoid rotateVecFromQuat (inout vec3 v, vec4 q){\n  float ix = q.w * v.x + q.y * v.z - q.z * v.y;\n  float iy = q.w * v.y + q.z * v.x - q.x * v.z;\n  float iz = q.w * v.z + q.x * v.y - q.y * v.x;\n  float iw = -q.x * v.x - q.y * v.y - q.z * v.z;\n  v.x = ix * q.w + iw * -q.x + iy * -q.z - iz * -q.y;\n  v.y = iy * q.w + iw * -q.y + iz * -q.x - ix * -q.z;\n  v.z = iz * q.w + iw * -q.z + ix * -q.y - iy * -q.x;\n}\nvec3 rotateInLocalSpace (vec3 pos, vec3 xAxis, vec3 yAxis, vec3 zAxis, vec4 q){\n  vec4 viewQuat = quaternionFromAxis(xAxis, yAxis, zAxis);\n  vec4 rotQuat = quatMultiply(viewQuat, q);\n  rotateVecFromQuat(pos, rotQuat);\n  return pos;\n}\nvoid rotateCorner (inout vec2 corner, float angle){\n  float xOS = cos(angle) * corner.x - sin(angle) * corner.y;\n  float yOS = sin(angle) * corner.x + cos(angle) * corner.y;\n  corner.x = xOS;\n  corner.y = yOS;\n}\nout vec2 uv;\nout vec4 color;\nvoid computeVertPos (inout vec4 pos, vec2 vertOffset, vec4 q, vec3 s\n  , mat4 viewInv\n) {\n  vec3 viewSpaceVert = vec3(vertOffset.x * s.x, vertOffset.y * s.y, 0.);\n  vec3 camX = normalize(vec3(viewInv[0][0], viewInv[1][0], viewInv[2][0]));\n  vec3 camY = normalize(vec3(viewInv[0][1], viewInv[1][1], viewInv[2][1]));\n  vec3 camZ = normalize(vec3(viewInv[0][2], viewInv[1][2], viewInv[2][2]));\n  pos.xyz += rotateInLocalSpace(viewSpaceVert, camX, camY, camZ, q);\n}\nin vec3 a_position;\nin vec2 a_texCoord;\nin vec4 a_color;\nuniform builtin {\n  vec4 cc_size_rotation;\n};\nvec4 vs_main() {\n  vec4 pos = vec4(a_position, 1);\n  pos = cc_matWorld * pos;\n  vec2 vertOffset = a_texCoord.xy - 0.5;\n  computeVertPos(pos, vertOffset, quaternionFromEuler(vec3(0., 0., cc_size_rotation.z)), vec3(cc_size_rotation.xy, 0.), cc_matViewInv);\n  pos = cc_matViewProj * pos;\n  uv = a_texCoord.xy;\n  color = a_color;\n  return pos;\n}\nvoid main() { gl_Position = vs_main(); }",frag:"\nprecision mediump float;\nuniform CCGlobal {\n  highp   vec4 cc_time;\n  mediump vec4 cc_screenSize;\n  mediump vec4 cc_screenScale;\n  mediump vec4 cc_nativeSize;\n  highp   mat4 cc_matView;\n  highp   mat4 cc_matViewInv;\n  highp   mat4 cc_matProj;\n  highp   mat4 cc_matProjInv;\n  highp   mat4 cc_matViewProj;\n  highp   mat4 cc_matViewProjInv;\n  highp   vec4 cc_cameraPos;\n  mediump vec4 cc_exposure;\n  mediump vec4 cc_mainLitDir;\n  mediump vec4 cc_mainLitColor;\n  mediump vec4 cc_ambientSky;\n  mediump vec4 cc_ambientGround;\n};\nvec3 SRGBToLinear (vec3 gamma) {\n  return gamma * gamma;\n}\nvec4 CCFragOutput (vec4 color) {\n  #if CC_USE_HDR\n    color.rgb = mix(color.rgb, SRGBToLinear(color.rgb) * cc_exposure.w, vec3(cc_exposure.z));\n  #endif\n  return color;\n}\nin vec2 uv;\nin vec4 color;\nuniform sampler2D mainTexture;\nuniform FragConstants {\n  vec4 tintColor;\n};\nvec4 add () {\n  vec4 col = 2.0 * color * tintColor * texture(mainTexture, uv);\n  return CCFragOutput(col);\n}\nout vec4 cc_FragColor;\nvoid main() { cc_FragColor = add(); }"},glsl1:{vert:"\nprecision mediump float;\nuniform highp mat4 cc_matView;\nuniform highp mat4 cc_matViewInv;\nuniform highp mat4 cc_matViewProj;\nuniform highp mat4 cc_matWorld;\nvec4 quaternionFromAxis (vec3 xAxis,vec3 yAxis,vec3 zAxis){\n  mat3 m = mat3(xAxis,yAxis,zAxis);\n  float trace = m[0][0] + m[1][1] + m[2][2];\n  vec4 quat;\n  if (trace > 0.) {\n    float s = 0.5 / sqrt(trace + 1.0);\n    quat.w = 0.25 / s;\n    quat.x = (m[2][1] - m[1][2]) * s;\n    quat.y = (m[0][2] - m[2][0]) * s;\n    quat.z = (m[1][0] - m[0][1]) * s;\n  } else if ((m[0][0] > m[1][1]) && (m[0][0] > m[2][2])) {\n    float s = 2.0 * sqrt(1.0 + m[0][0] - m[1][1] - m[2][2]);\n    quat.w = (m[2][1] - m[1][2]) / s;\n    quat.x = 0.25 * s;\n    quat.y = (m[0][1] + m[1][0]) / s;\n    quat.z = (m[0][2] + m[2][0]) / s;\n  } else if (m[1][1] > m[2][2]) {\n    float s = 2.0 * sqrt(1.0 + m[1][1] - m[0][0] - m[2][2]);\n    quat.w = (m[0][2] - m[2][0]) / s;\n    quat.x = (m[0][1] + m[1][0]) / s;\n    quat.y = 0.25 * s;\n    quat.z = (m[1][2] + m[2][1]) / s;\n  } else {\n    float s = 2.0 * sqrt(1.0 + m[2][2] - m[0][0] - m[1][1]);\n    quat.w = (m[1][0] - m[0][1]) / s;\n    quat.x = (m[0][2] + m[2][0]) / s;\n    quat.y = (m[1][2] + m[2][1]) / s;\n    quat.z = 0.25 * s;\n  }\n  float len = quat.x * quat.x + quat.y * quat.y + quat.z * quat.z + quat.w * quat.w;\n  if (len > 0.) {\n    len = 1. / sqrt(len);\n    quat.x = quat.x * len;\n    quat.y = quat.y * len;\n    quat.z = quat.z * len;\n    quat.w = quat.w * len;\n  }\n  return quat;\n}\nvec4 quaternionFromEuler (vec3 angle){\n  float x = angle.x / 2.;\n  float y = angle.y / 2.;\n  float z = angle.z / 2.;\n  float sx = sin(x);\n  float cx = cos(x);\n  float sy = sin(y);\n  float cy = cos(y);\n  float sz = sin(z);\n  float cz = cos(z);\n  vec4 quat = vec4(0);\n  quat.x = sx * cy * cz + cx * sy * sz;\n  quat.y = cx * sy * cz + sx * cy * sz;\n  quat.z = cx * cy * sz - sx * sy * cz;\n  quat.w = cx * cy * cz - sx * sy * sz;\n  return quat;\n}\nvec4 quatMultiply (vec4 a, vec4 b){\n  vec4 quat;\n  quat.x = a.x * b.w + a.w * b.x + a.y * b.z - a.z * b.y;\n  quat.y = a.y * b.w + a.w * b.y + a.z * b.x - a.x * b.z;\n  quat.z = a.z * b.w + a.w * b.z + a.x * b.y - a.y * b.x;\n  quat.w = a.w * b.w - a.x * b.x - a.y * b.y - a.z * b.z;\n  return quat;\n}\nvoid rotateVecFromQuat (inout vec3 v, vec4 q){\n  float ix = q.w * v.x + q.y * v.z - q.z * v.y;\n  float iy = q.w * v.y + q.z * v.x - q.x * v.z;\n  float iz = q.w * v.z + q.x * v.y - q.y * v.x;\n  float iw = -q.x * v.x - q.y * v.y - q.z * v.z;\n  v.x = ix * q.w + iw * -q.x + iy * -q.z - iz * -q.y;\n  v.y = iy * q.w + iw * -q.y + iz * -q.x - ix * -q.z;\n  v.z = iz * q.w + iw * -q.z + ix * -q.y - iy * -q.x;\n}\nvec3 rotateInLocalSpace (vec3 pos, vec3 xAxis, vec3 yAxis, vec3 zAxis, vec4 q){\n  vec4 viewQuat = quaternionFromAxis(xAxis, yAxis, zAxis);\n  vec4 rotQuat = quatMultiply(viewQuat, q);\n  rotateVecFromQuat(pos, rotQuat);\n  return pos;\n}\nvoid rotateCorner (inout vec2 corner, float angle){\n  float xOS = cos(angle) * corner.x - sin(angle) * corner.y;\n  float yOS = sin(angle) * corner.x + cos(angle) * corner.y;\n  corner.x = xOS;\n  corner.y = yOS;\n}\nvarying vec2 uv;\nvarying vec4 color;\nvoid computeVertPos (inout vec4 pos, vec2 vertOffset, vec4 q, vec3 s\n  , mat4 viewInv\n) {\n  vec3 viewSpaceVert = vec3(vertOffset.x * s.x, vertOffset.y * s.y, 0.);\n  vec3 camX = normalize(vec3(viewInv[0][0], viewInv[1][0], viewInv[2][0]));\n  vec3 camY = normalize(vec3(viewInv[0][1], viewInv[1][1], viewInv[2][1]));\n  vec3 camZ = normalize(vec3(viewInv[0][2], viewInv[1][2], viewInv[2][2]));\n  pos.xyz += rotateInLocalSpace(viewSpaceVert, camX, camY, camZ, q);\n}\nattribute vec3 a_position;\nattribute vec2 a_texCoord;\nattribute vec4 a_color;\nuniform vec4 cc_size_rotation;\nvec4 vs_main() {\n  vec4 pos = vec4(a_position, 1);\n  pos = cc_matWorld * pos;\n  vec2 vertOffset = a_texCoord.xy - 0.5;\n  computeVertPos(pos, vertOffset, quaternionFromEuler(vec3(0., 0., cc_size_rotation.z)), vec3(cc_size_rotation.xy, 0.), cc_matViewInv);\n  pos = cc_matViewProj * pos;\n  uv = a_texCoord.xy;\n  color = a_color;\n  return pos;\n}\nvoid main() { gl_Position = vs_main(); }",frag:"\nprecision mediump float;\nuniform mediump vec4 cc_exposure;\nvec3 SRGBToLinear (vec3 gamma) {\n  return gamma * gamma;\n}\nvec4 CCFragOutput (vec4 color) {\n  #if CC_USE_HDR\n    color.rgb = mix(color.rgb, SRGBToLinear(color.rgb) * cc_exposure.w, vec3(cc_exposure.z));\n  #endif\n  return color;\n}\nvarying vec2 uv;\nvarying vec4 color;\nuniform sampler2D mainTexture;\nuniform vec4 tintColor;\nvec4 add () {\n  vec4 col = 2.0 * color * tintColor * texture2D(mainTexture, uv);\n  return CCFragOutput(col);\n}\nvoid main() { gl_FragColor = add(); }"},builtins:{globals:{blocks:[{name:"CCGlobal",defines:[]}],samplers:[]},locals:{blocks:[{name:"CCLocal",defines:[]}],samplers:[]}},defines:[{name:"CC_USE_HDR",type:"boolean"}],blocks:[{name:"Constants",defines:[],binding:0,members:[{name:"mainTiling_Offset",type:16,count:1},{name:"frameTile_velLenScale",type:16,count:1},{name:"scale",type:16,count:1}]},{name:"builtin",defines:[],binding:1,members:[{name:"cc_size_rotation",type:16,count:1}]},{name:"FragConstants",defines:[],binding:2,members:[{name:"tintColor",type:16,count:1}]}],samplers:[{name:"mainTexture",type:28,count:1,defines:[],binding:31}],attributes:[{name:"a_position",type:15,count:1,defines:[],format:32,location:0},{name:"a_texCoord",type:14,count:1,defines:[],format:21,location:1},{name:"a_color",type:16,count:1,defines:[],format:43,location:2}]}]},{name:"builtin-particle-gpu",_uuid:"971bdb23-3ff6-43eb-b422-1c30165a3663",techniques:[{name:"add",passes:[{rasterizerState:{cullMode:0},blendState:{targets:[{blend:!0,blendSrc:2,blendDst:1,blendSrcAlpha:2,blendDstAlpha:1}]},program:"builtin-particle-gpu|particle-vs-gpu:gpvs_main|tinted-fs:add",depthStencilState:{depthTest:!0,depthWrite:!1},properties:{mainTexture:{value:"grey",type:28},mainTiling_Offset:{value:[1,1,0,0],type:16},tintColor:{value:[.5,.5,.5,.5],type:16}}}]}],shaders:[{name:"builtin-particle-gpu|particle-vs-gpu:gpvs_main|tinted-fs:add",hash:4003605751,glsl3:{vert:"\nprecision mediump float;\nvec4 quaternionFromAxis (vec3 xAxis,vec3 yAxis,vec3 zAxis){\n  mat3 m = mat3(xAxis,yAxis,zAxis);\n  float trace = m[0][0] + m[1][1] + m[2][2];\n  vec4 quat;\n  if (trace > 0.) {\n    float s = 0.5 / sqrt(trace + 1.0);\n    quat.w = 0.25 / s;\n    quat.x = (m[2][1] - m[1][2]) * s;\n    quat.y = (m[0][2] - m[2][0]) * s;\n    quat.z = (m[1][0] - m[0][1]) * s;\n  } else if ((m[0][0] > m[1][1]) && (m[0][0] > m[2][2])) {\n    float s = 2.0 * sqrt(1.0 + m[0][0] - m[1][1] - m[2][2]);\n    quat.w = (m[2][1] - m[1][2]) / s;\n    quat.x = 0.25 * s;\n    quat.y = (m[0][1] + m[1][0]) / s;\n    quat.z = (m[0][2] + m[2][0]) / s;\n  } else if (m[1][1] > m[2][2]) {\n    float s = 2.0 * sqrt(1.0 + m[1][1] - m[0][0] - m[2][2]);\n    quat.w = (m[0][2] - m[2][0]) / s;\n    quat.x = (m[0][1] + m[1][0]) / s;\n    quat.y = 0.25 * s;\n    quat.z = (m[1][2] + m[2][1]) / s;\n  } else {\n    float s = 2.0 * sqrt(1.0 + m[2][2] - m[0][0] - m[1][1]);\n    quat.w = (m[1][0] - m[0][1]) / s;\n    quat.x = (m[0][2] + m[2][0]) / s;\n    quat.y = (m[1][2] + m[2][1]) / s;\n    quat.z = 0.25 * s;\n  }\n  float len = quat.x * quat.x + quat.y * quat.y + quat.z * quat.z + quat.w * quat.w;\n  if (len > 0.) {\n    len = 1. / sqrt(len);\n    quat.x = quat.x * len;\n    quat.y = quat.y * len;\n    quat.z = quat.z * len;\n    quat.w = quat.w * len;\n  }\n  return quat;\n}\nvec4 quaternionFromEuler (vec3 angle){\n  float x = angle.x / 2.;\n  float y = angle.y / 2.;\n  float z = angle.z / 2.;\n  float sx = sin(x);\n  float cx = cos(x);\n  float sy = sin(y);\n  float cy = cos(y);\n  float sz = sin(z);\n  float cz = cos(z);\n  vec4 quat = vec4(0);\n  quat.x = sx * cy * cz + cx * sy * sz;\n  quat.y = cx * sy * cz + sx * cy * sz;\n  quat.z = cx * cy * sz - sx * sy * cz;\n  quat.w = cx * cy * cz - sx * sy * sz;\n  return quat;\n}\nmat4 matrixFromRT (vec4 q, vec3 p){\n  float x2 = q.x + q.x;\n  float y2 = q.y + q.y;\n  float z2 = q.z + q.z;\n  float xx = q.x * x2;\n  float xy = q.x * y2;\n  float xz = q.x * z2;\n  float yy = q.y * y2;\n  float yz = q.y * z2;\n  float zz = q.z * z2;\n  float wx = q.w * x2;\n  float wy = q.w * y2;\n  float wz = q.w * z2;\n  return mat4(\n    1. - (yy + zz), xy + wz, xz - wy, 0,\n    xy - wz, 1. - (xx + zz), yz + wx, 0,\n    xz + wy, yz - wx, 1. - (xx + yy), 0,\n    p.x, p.y, p.z, 1\n  );\n}\nmat4 matFromRTS (vec4 q, vec3 t, vec3 s){\n  float x = q.x, y = q.y, z = q.z, w = q.w;\n  float x2 = x + x;\n  float y2 = y + y;\n  float z2 = z + z;\n  float xx = x * x2;\n  float xy = x * y2;\n  float xz = x * z2;\n  float yy = y * y2;\n  float yz = y * z2;\n  float zz = z * z2;\n  float wx = w * x2;\n  float wy = w * y2;\n  float wz = w * z2;\n  float sx = s.x;\n  float sy = s.y;\n  float sz = s.z;\n  return mat4((1. - (yy + zz)) * sx, (xy + wz) * sx, (xz - wy) * sx, 0,\n    (xy - wz) * sy, (1. - (xx + zz)) * sy, (yz + wx) * sy, 0,\n    (xz + wy) * sz, (yz - wx) * sz, (1. - (xx + yy)) * sz, 0,\n    t.x, t.y, t.z, 1);\n}\nvec4 quatMultiply (vec4 a, vec4 b){\n  vec4 quat;\n  quat.x = a.x * b.w + a.w * b.x + a.y * b.z - a.z * b.y;\n  quat.y = a.y * b.w + a.w * b.y + a.z * b.x - a.x * b.z;\n  quat.z = a.z * b.w + a.w * b.z + a.x * b.y - a.y * b.x;\n  quat.w = a.w * b.w - a.x * b.x - a.y * b.y - a.z * b.z;\n  return quat;\n}\nvoid rotateVecFromQuat (inout vec3 v, vec4 q){\n  float ix = q.w * v.x + q.y * v.z - q.z * v.y;\n  float iy = q.w * v.y + q.z * v.x - q.x * v.z;\n  float iz = q.w * v.z + q.x * v.y - q.y * v.x;\n  float iw = -q.x * v.x - q.y * v.y - q.z * v.z;\n  v.x = ix * q.w + iw * -q.x + iy * -q.z - iz * -q.y;\n  v.y = iy * q.w + iw * -q.y + iz * -q.x - ix * -q.z;\n  v.z = iz * q.w + iw * -q.z + ix * -q.y - iy * -q.x;\n}\nvec3 rotateInLocalSpace (vec3 pos, vec3 xAxis, vec3 yAxis, vec3 zAxis, vec4 q){\n  vec4 viewQuat = quaternionFromAxis(xAxis, yAxis, zAxis);\n  vec4 rotQuat = quatMultiply(viewQuat, q);\n  rotateVecFromQuat(pos, rotQuat);\n  return pos;\n}\nvoid rotateCorner (inout vec2 corner, float angle){\n  float xOS = cos(angle) * corner.x - sin(angle) * corner.y;\n  float yOS = sin(angle) * corner.x + cos(angle) * corner.y;\n  corner.x = xOS;\n  corner.y = yOS;\n}\nuniform Constants {\n  vec4 mainTiling_Offset;\n  vec4 frameTile_velLenScale;\n  vec4 scale;\n};\nuniform CCGlobal {\n  highp   vec4 cc_time;\n  mediump vec4 cc_screenSize;\n  mediump vec4 cc_screenScale;\n  mediump vec4 cc_nativeSize;\n  highp   mat4 cc_matView;\n  highp   mat4 cc_matViewInv;\n  highp   mat4 cc_matProj;\n  highp   mat4 cc_matProjInv;\n  highp   mat4 cc_matViewProj;\n  highp   mat4 cc_matViewProjInv;\n  highp   vec4 cc_cameraPos;\n  mediump vec4 cc_exposure;\n  mediump vec4 cc_mainLitDir;\n  mediump vec4 cc_mainLitColor;\n  mediump vec4 cc_ambientSky;\n  mediump vec4 cc_ambientGround;\n};\nuniform CCLocal {\n  highp mat4 cc_matWorld;\n  highp mat4 cc_matWorldIT;\n  highp vec4 cc_lightingMapUVParam;\n};\nout vec2 uv;\nout vec4 color;\nvoid computeVertPos (inout vec4 pos, vec2 vertOffset, vec4 q, vec3 s\n#if CC_RENDER_MODE == 0 || CC_RENDER_MODE == 3\n  , mat4 viewInv\n#endif\n#if CC_RENDER_MODE == 1\n  , vec3 eye\n  , vec4 velocity\n  , float velocityScale\n  , float lengthScale\n  , float xIndex\n#endif\n) {\n#if CC_RENDER_MODE == 0\n  vec3 viewSpaceVert = vec3(vertOffset.x * s.x, vertOffset.y * s.y, 0.);\n  vec3 camX = normalize(vec3(viewInv[0][0], viewInv[1][0], viewInv[2][0]));\n  vec3 camY = normalize(vec3(viewInv[0][1], viewInv[1][1], viewInv[2][1]));\n  vec3 camZ = normalize(vec3(viewInv[0][2], viewInv[1][2], viewInv[2][2]));\n  pos.xyz += rotateInLocalSpace(viewSpaceVert, camX, camY, camZ, q);\n#elif CC_RENDER_MODE == 1\n  vec3 camRight = normalize(cross(pos.xyz - eye, velocity.xyz)) * s.x;\n  vec3 camUp = velocity.xyz * velocityScale + normalize(velocity.xyz) * lengthScale * s.y;\n  pos.xyz += (camRight * abs(vertOffset.x) * sign(vertOffset.y)) - camUp * xIndex;\n#elif CC_RENDER_MODE == 2\n  vec3 viewSpaceVert = vec3(vertOffset.x * s.x, vertOffset.y * s.y, 0.);\n  vec3 camX = vec3(1, 0, 0);\n  vec3 camY = vec3(0, 0, -1);\n  pos.xyz += rotateInLocalSpace(viewSpaceVert, camX, camY, cross(camX, camY), q);\n#elif CC_RENDER_MODE == 3\n  vec2 viewSpaceVert = vec2(vertOffset.x * s.x, vertOffset.y * s.y);\n  rotateCorner(viewSpaceVert, q.z);\n  vec3 camX = normalize(vec3(cc_matView[0][0], cc_matView[1][0], cc_matView[2][0]));\n  vec3 camY = vec3(0, 1, 0);\n  vec3 offset = camX * viewSpaceVert.x + camY * viewSpaceVert.y;\n  pos.xyz += offset;\n#else\n  pos.x += vertOffset.x;\n  pos.y += vertOffset.y;\n#endif\n}\nvec2 computeUV (float frameIndex, vec2 vertIndex, vec2 frameTile){\n  vec2 aniUV = vec2(0, floor(frameIndex * frameTile.y));\n  aniUV.x = floor(frameIndex * frameTile.x * frameTile.y - aniUV.y * frameTile.x);\n#if CC_RENDER_MODE != 4\n  vertIndex.y = 1. - vertIndex.y;\n#endif\n  return (aniUV.xy + vertIndex) / vec2(frameTile.x, frameTile.y);\n}\nuniform SampleConstants {\n  vec4 u_sampleInfo;\n};\nuniform TickConstants {\n  vec4 u_worldRot;\n  vec4 u_timeDelta;\n};\nin vec4 a_position_starttime;\nin vec4 a_size_uv;\nin vec4 a_rotation_uv;\nin vec4 a_color;\nin vec4 a_dir_life;\nin float a_rndSeed;\n#if CC_RENDER_MODE == 4\n  in vec3 a_texCoord;\n  in vec3 a_texCoord3;\n  in vec3 a_normal;\n  in vec4 a_color1;\n#endif\nvec3 unpackCurveData (sampler2D tex, vec2 coord) {\n    vec4 a = texture(tex, coord);\n    vec4 b = texture(tex, coord + u_sampleInfo.y);\n    float c = fract(coord.x * u_sampleInfo.x);\n    return mix(a.xyz, b.xyz, c);\n}\nvec3 unpackCurveData (sampler2D tex, vec2 coord, out float w) {\n    vec4 a = texture(tex, coord);\n    vec4 b = texture(tex, coord + u_sampleInfo.y);\n    float c = fract(coord.x * u_sampleInfo.x);\n    w = mix(a.w, b.w, c);\n    return mix(a.xyz, b.xyz, c);\n}\nfloat pseudoRandom (float seed) {\n  seed = mod(seed, 233280.);\n  float q = (seed * 9301. + 49297.) / 233280.;\n  return fract(q);\n}\n#if COLOR_OVER_TIME_MODULE_ENABLE\n  uniform sampler2D color_over_time_tex0;\n  uniform ColorConstant {\n    int u_color_mode;\n  };\n#endif\n#if ROTATION_OVER_TIME_MODULE_ENABLE\n  uniform sampler2D rotation_over_time_tex0;\n  uniform RotationConstant {\n    int u_rotation_mode;\n  };\n#endif\n#if SIZE_OVER_TIME_MODULE_ENABLE\n  uniform sampler2D size_over_time_tex0;\n  uniform SizeConstant {\n    int u_size_mode;\n  };\n#endif\n#if FORCE_OVER_TIME_MODULE_ENABLE\n  uniform sampler2D force_over_time_tex0;\n  uniform ForceConstant {\n    int u_force_mode;\n    int u_force_space;\n  };\n#endif\n#if VELOCITY_OVER_TIME_MODULE_ENABLE\n  uniform sampler2D velocity_over_time_tex0;\n  uniform VelocityConstant {\n    int u_velocity_mode;\n    int u_velocity_space;\n  };\n#endif\n#if TEXTURE_ANIMATION_MODULE_ENABLE\n  uniform sampler2D texture_animation_tex0;\n  uniform AnimationConstant {\n    vec4 u_anim_info;\n  };\n#endif\nfloat repeat (float t, float length) {\n  return t - floor(t / length) * length;\n}\nvec4 rotateQuat (vec4 p, vec4 q) {\n  vec3 iv = cross(q.xyz, p.xyz) + q.w * p.xyz;\n  vec3 res = p.xyz + 2.0 * cross(q.xyz, iv);\n  return vec4(res.xyz, p.w);\n}\nvec4 gpvs_main () {\n  float activeTime = u_timeDelta.x - a_position_starttime.w;\n  float normalizedTime = clamp(activeTime / a_dir_life.w, 0.0, 1.0);\n  vec2 timeCoord0 = vec2(normalizedTime, 0.);\n  vec2 timeCoord1 = vec2(normalizedTime, 1.);\n  #if CC_RENDER_MODE == 4\n    vec2 vertIdx = vec2(a_texCoord.x, a_texCoord.y);\n  #else\n    vec2 vertIdx = vec2(a_size_uv.w, a_rotation_uv.w);\n  #endif\n  vec4 velocity = vec4(a_dir_life.xyz, 0.);\n  vec4 pos = vec4(a_position_starttime.xyz, 1.);\n  vec3 size = a_size_uv.xyz;\n  #if SIZE_OVER_TIME_MODULE_ENABLE\n    if (u_size_mode == 1) {\n      size *= unpackCurveData(size_over_time_tex0, timeCoord0);\n    } else {\n      vec3 size_0 = unpackCurveData(size_over_time_tex0, timeCoord0);\n      vec3 size_1 = unpackCurveData(size_over_time_tex0, timeCoord1);\n      float factor_s = pseudoRandom(a_rndSeed + 39825.);\n      size *= mix(size_0, size_1, factor_s);\n    }\n  #endif\n  vec3 compScale = scale.xyz * size;\n  #if FORCE_OVER_TIME_MODULE_ENABLE\n    vec3 forceAnim = vec3(0.);\n    if (u_force_mode == 1) {\n      forceAnim = unpackCurveData(force_over_time_tex0, timeCoord0);\n    } else {\n      vec3 force_0 = unpackCurveData(force_over_time_tex0, timeCoord0);\n      vec3 force_1 = unpackCurveData(force_over_time_tex0, timeCoord1);\n      float factor_f =  pseudoRandom(a_rndSeed + 212165.);\n      forceAnim = mix(force_0, force_1, factor_f);\n    }\n    vec4 forceTrack = vec4(forceAnim, 0.);\n    if (u_force_space == 0) {\n      forceTrack = rotateQuat(forceTrack, u_worldRot);\n    }\n    velocity.xyz += forceTrack.xyz;\n  #endif\n  #if VELOCITY_OVER_TIME_MODULE_ENABLE\n    float speedModifier0 = 1.;\n    float speedModifier1 = 1.;\n    vec3 velocityAnim = vec3(0.);\n    if (u_velocity_mode == 1) {\n      velocityAnim = unpackCurveData(velocity_over_time_tex0, timeCoord0, speedModifier0);\n    } else {\n      vec3 vectory_0 = unpackCurveData(velocity_over_time_tex0, timeCoord0, speedModifier0);\n      vec3 vectory_1 = unpackCurveData(velocity_over_time_tex0, timeCoord1, speedModifier1);\n      float factor_v = pseudoRandom(a_rndSeed + 197866.);\n      velocityAnim = mix(vectory_0, vectory_1, factor_v);\n      speedModifier0 = mix(speedModifier0, speedModifier1, factor_v);\n    }\n    vec4 velocityTrack = vec4(velocityAnim, 0.);\n    if (u_velocity_space == 0) {\n      velocityTrack = rotateQuat(velocityTrack, u_worldRot);\n    }\n    velocity.xyz += velocityTrack.xyz;\n    velocity.xyz *= speedModifier0;\n  #endif\n  pos.xyz += velocity.xyz * normalizedTime * a_dir_life.w;\n  #if !CC_USE_WORLD_SPACE\n    pos = cc_matWorld * pos;\n    #if CC_RENDER_MODE == 1\n      velocity = rotateQuat(velocity, u_worldRot);\n    #endif\n  #endif\n  vec3 rotation = a_rotation_uv.xyz;\n  #if ROTATION_OVER_TIME_MODULE_ENABLE\n    if (u_rotation_mode == 1) {\n      rotation += unpackCurveData(rotation_over_time_tex0, timeCoord0) * normalizedTime * a_dir_life.w;\n    } else {\n      vec3 rotation_0 = unpackCurveData(rotation_over_time_tex0, timeCoord0);\n      vec3 rotation_1 = unpackCurveData(rotation_over_time_tex0, timeCoord1);\n      float factor_r = pseudoRandom(a_rndSeed + 125292.);\n      rotation += mix(rotation_0, rotation_1, factor_r) * normalizedTime * a_dir_life.w;\n    }\n  #endif\n  #if COLOR_OVER_TIME_MODULE_ENABLE\n    if (u_color_mode == 1) {\n      color = a_color * texture(color_over_time_tex0, timeCoord0);\n    } else {\n      vec4 color_0 = texture(color_over_time_tex0, timeCoord0);\n      vec4 color_1 = texture(color_over_time_tex0, timeCoord1);\n      float factor_c = pseudoRandom(a_rndSeed + 91041.);\n      color = a_color * mix(color_0, color_1, factor_c);\n    }\n  #else\n    color = a_color;\n  #endif\n  #if CC_RENDER_MODE != 4\n    vec2 cornerOffset = vec2((vertIdx - 0.5));\n    #if CC_RENDER_MODE == 0\n      vec3 rotEuler = rotation.xyz;\n    #elif CC_RENDER_MODE == 1\n      vec3 rotEuler = vec3(0.);\n    #else\n      vec3 rotEuler = vec3(0., 0., rotation.z);\n    #endif\n    computeVertPos(pos, cornerOffset, quaternionFromEuler(rotEuler), compScale\n      #if CC_RENDER_MODE == 0 || CC_RENDER_MODE == 3\n        , cc_matViewInv\n      #endif\n      #if CC_RENDER_MODE == 1\n        , cc_cameraPos.xyz\n        , velocity\n        , frameTile_velLenScale.z\n        , frameTile_velLenScale.w\n        , a_size_uv.w\n      #endif\n    );\n  #else\n    mat4 xformNoScale = matrixFromRT(quaternionFromEuler(rotation), pos.xyz);\n    mat4 xform = matFromRTS(quaternionFromEuler(rotation), pos.xyz, compScale);\n    pos = xform * vec4(a_texCoord3, 1);\n    vec4 normal = xformNoScale * vec4(a_normal, 0);\n    color *= a_color1;\n  #endif\n  pos = cc_matViewProj * pos;\n  float frameIndex = 0.;\n  #if TEXTURE_ANIMATION_MODULE_ENABLE\n    float startFrame = 0.;\n    vec3 frameInfo = vec3(0.);\n    if (int(u_anim_info.x) == 1) {\n      frameInfo = unpackCurveData(texture_animation_tex0, timeCoord0);\n    } else {\n      vec3 frameInfo0 = unpackCurveData(texture_animation_tex0, timeCoord0);\n      vec3 frameInfo1 = unpackCurveData(texture_animation_tex0, timeCoord1);\n      float factor_t = pseudoRandom(a_rndSeed + 90794.);\n      frameInfo = mix(frameInfo0, frameInfo1, factor_t);\n    }\n    startFrame = frameInfo.x / u_anim_info.y;\n    frameIndex = repeat(u_anim_info.z * (frameInfo.y + startFrame), 1.);\n  #endif\n  uv = computeUV(frameIndex, vertIdx, frameTile_velLenScale.xy) * mainTiling_Offset.xy + mainTiling_Offset.zw;\n  return pos;\n}\nvoid main() { gl_Position = gpvs_main(); }",frag:"\nprecision mediump float;\nuniform CCGlobal {\n  highp   vec4 cc_time;\n  mediump vec4 cc_screenSize;\n  mediump vec4 cc_screenScale;\n  mediump vec4 cc_nativeSize;\n  highp   mat4 cc_matView;\n  highp   mat4 cc_matViewInv;\n  highp   mat4 cc_matProj;\n  highp   mat4 cc_matProjInv;\n  highp   mat4 cc_matViewProj;\n  highp   mat4 cc_matViewProjInv;\n  highp   vec4 cc_cameraPos;\n  mediump vec4 cc_exposure;\n  mediump vec4 cc_mainLitDir;\n  mediump vec4 cc_mainLitColor;\n  mediump vec4 cc_ambientSky;\n  mediump vec4 cc_ambientGround;\n};\nvec3 SRGBToLinear (vec3 gamma) {\n  return gamma * gamma;\n}\nvec4 CCFragOutput (vec4 color) {\n  #if CC_USE_HDR\n    color.rgb = mix(color.rgb, SRGBToLinear(color.rgb) * cc_exposure.w, vec3(cc_exposure.z));\n  #endif\n  return color;\n}\nin vec2 uv;\nin vec4 color;\nuniform sampler2D mainTexture;\nuniform FragConstants {\n  vec4 tintColor;\n};\nvec4 add () {\n  vec4 col = 2.0 * color * tintColor * texture(mainTexture, uv);\n  return CCFragOutput(col);\n}\nout vec4 cc_FragColor;\nvoid main() { cc_FragColor = add(); }"},glsl1:{vert:"\nprecision mediump float;\nvec4 quaternionFromAxis (vec3 xAxis,vec3 yAxis,vec3 zAxis){\n  mat3 m = mat3(xAxis,yAxis,zAxis);\n  float trace = m[0][0] + m[1][1] + m[2][2];\n  vec4 quat;\n  if (trace > 0.) {\n    float s = 0.5 / sqrt(trace + 1.0);\n    quat.w = 0.25 / s;\n    quat.x = (m[2][1] - m[1][2]) * s;\n    quat.y = (m[0][2] - m[2][0]) * s;\n    quat.z = (m[1][0] - m[0][1]) * s;\n  } else if ((m[0][0] > m[1][1]) && (m[0][0] > m[2][2])) {\n    float s = 2.0 * sqrt(1.0 + m[0][0] - m[1][1] - m[2][2]);\n    quat.w = (m[2][1] - m[1][2]) / s;\n    quat.x = 0.25 * s;\n    quat.y = (m[0][1] + m[1][0]) / s;\n    quat.z = (m[0][2] + m[2][0]) / s;\n  } else if (m[1][1] > m[2][2]) {\n    float s = 2.0 * sqrt(1.0 + m[1][1] - m[0][0] - m[2][2]);\n    quat.w = (m[0][2] - m[2][0]) / s;\n    quat.x = (m[0][1] + m[1][0]) / s;\n    quat.y = 0.25 * s;\n    quat.z = (m[1][2] + m[2][1]) / s;\n  } else {\n    float s = 2.0 * sqrt(1.0 + m[2][2] - m[0][0] - m[1][1]);\n    quat.w = (m[1][0] - m[0][1]) / s;\n    quat.x = (m[0][2] + m[2][0]) / s;\n    quat.y = (m[1][2] + m[2][1]) / s;\n    quat.z = 0.25 * s;\n  }\n  float len = quat.x * quat.x + quat.y * quat.y + quat.z * quat.z + quat.w * quat.w;\n  if (len > 0.) {\n    len = 1. / sqrt(len);\n    quat.x = quat.x * len;\n    quat.y = quat.y * len;\n    quat.z = quat.z * len;\n    quat.w = quat.w * len;\n  }\n  return quat;\n}\nvec4 quaternionFromEuler (vec3 angle){\n  float x = angle.x / 2.;\n  float y = angle.y / 2.;\n  float z = angle.z / 2.;\n  float sx = sin(x);\n  float cx = cos(x);\n  float sy = sin(y);\n  float cy = cos(y);\n  float sz = sin(z);\n  float cz = cos(z);\n  vec4 quat = vec4(0);\n  quat.x = sx * cy * cz + cx * sy * sz;\n  quat.y = cx * sy * cz + sx * cy * sz;\n  quat.z = cx * cy * sz - sx * sy * cz;\n  quat.w = cx * cy * cz - sx * sy * sz;\n  return quat;\n}\nmat4 matrixFromRT (vec4 q, vec3 p){\n  float x2 = q.x + q.x;\n  float y2 = q.y + q.y;\n  float z2 = q.z + q.z;\n  float xx = q.x * x2;\n  float xy = q.x * y2;\n  float xz = q.x * z2;\n  float yy = q.y * y2;\n  float yz = q.y * z2;\n  float zz = q.z * z2;\n  float wx = q.w * x2;\n  float wy = q.w * y2;\n  float wz = q.w * z2;\n  return mat4(\n    1. - (yy + zz), xy + wz, xz - wy, 0,\n    xy - wz, 1. - (xx + zz), yz + wx, 0,\n    xz + wy, yz - wx, 1. - (xx + yy), 0,\n    p.x, p.y, p.z, 1\n  );\n}\nmat4 matFromRTS (vec4 q, vec3 t, vec3 s){\n  float x = q.x, y = q.y, z = q.z, w = q.w;\n  float x2 = x + x;\n  float y2 = y + y;\n  float z2 = z + z;\n  float xx = x * x2;\n  float xy = x * y2;\n  float xz = x * z2;\n  float yy = y * y2;\n  float yz = y * z2;\n  float zz = z * z2;\n  float wx = w * x2;\n  float wy = w * y2;\n  float wz = w * z2;\n  float sx = s.x;\n  float sy = s.y;\n  float sz = s.z;\n  return mat4((1. - (yy + zz)) * sx, (xy + wz) * sx, (xz - wy) * sx, 0,\n    (xy - wz) * sy, (1. - (xx + zz)) * sy, (yz + wx) * sy, 0,\n    (xz + wy) * sz, (yz - wx) * sz, (1. - (xx + yy)) * sz, 0,\n    t.x, t.y, t.z, 1);\n}\nvec4 quatMultiply (vec4 a, vec4 b){\n  vec4 quat;\n  quat.x = a.x * b.w + a.w * b.x + a.y * b.z - a.z * b.y;\n  quat.y = a.y * b.w + a.w * b.y + a.z * b.x - a.x * b.z;\n  quat.z = a.z * b.w + a.w * b.z + a.x * b.y - a.y * b.x;\n  quat.w = a.w * b.w - a.x * b.x - a.y * b.y - a.z * b.z;\n  return quat;\n}\nvoid rotateVecFromQuat (inout vec3 v, vec4 q){\n  float ix = q.w * v.x + q.y * v.z - q.z * v.y;\n  float iy = q.w * v.y + q.z * v.x - q.x * v.z;\n  float iz = q.w * v.z + q.x * v.y - q.y * v.x;\n  float iw = -q.x * v.x - q.y * v.y - q.z * v.z;\n  v.x = ix * q.w + iw * -q.x + iy * -q.z - iz * -q.y;\n  v.y = iy * q.w + iw * -q.y + iz * -q.x - ix * -q.z;\n  v.z = iz * q.w + iw * -q.z + ix * -q.y - iy * -q.x;\n}\nvec3 rotateInLocalSpace (vec3 pos, vec3 xAxis, vec3 yAxis, vec3 zAxis, vec4 q){\n  vec4 viewQuat = quaternionFromAxis(xAxis, yAxis, zAxis);\n  vec4 rotQuat = quatMultiply(viewQuat, q);\n  rotateVecFromQuat(pos, rotQuat);\n  return pos;\n}\nvoid rotateCorner (inout vec2 corner, float angle){\n  float xOS = cos(angle) * corner.x - sin(angle) * corner.y;\n  float yOS = sin(angle) * corner.x + cos(angle) * corner.y;\n  corner.x = xOS;\n  corner.y = yOS;\n}\nuniform vec4 mainTiling_Offset;\nuniform vec4 frameTile_velLenScale;\nuniform vec4 scale;\nuniform highp mat4 cc_matView;\nuniform highp mat4 cc_matViewInv;\nuniform highp mat4 cc_matViewProj;\nuniform highp vec4 cc_cameraPos;\nuniform highp mat4 cc_matWorld;\nvarying vec2 uv;\nvarying vec4 color;\nvoid computeVertPos (inout vec4 pos, vec2 vertOffset, vec4 q, vec3 s\n#if CC_RENDER_MODE == 0 || CC_RENDER_MODE == 3\n  , mat4 viewInv\n#endif\n#if CC_RENDER_MODE == 1\n  , vec3 eye\n  , vec4 velocity\n  , float velocityScale\n  , float lengthScale\n  , float xIndex\n#endif\n) {\n#if CC_RENDER_MODE == 0\n  vec3 viewSpaceVert = vec3(vertOffset.x * s.x, vertOffset.y * s.y, 0.);\n  vec3 camX = normalize(vec3(viewInv[0][0], viewInv[1][0], viewInv[2][0]));\n  vec3 camY = normalize(vec3(viewInv[0][1], viewInv[1][1], viewInv[2][1]));\n  vec3 camZ = normalize(vec3(viewInv[0][2], viewInv[1][2], viewInv[2][2]));\n  pos.xyz += rotateInLocalSpace(viewSpaceVert, camX, camY, camZ, q);\n#elif CC_RENDER_MODE == 1\n  vec3 camRight = normalize(cross(pos.xyz - eye, velocity.xyz)) * s.x;\n  vec3 camUp = velocity.xyz * velocityScale + normalize(velocity.xyz) * lengthScale * s.y;\n  pos.xyz += (camRight * abs(vertOffset.x) * sign(vertOffset.y)) - camUp * xIndex;\n#elif CC_RENDER_MODE == 2\n  vec3 viewSpaceVert = vec3(vertOffset.x * s.x, vertOffset.y * s.y, 0.);\n  vec3 camX = vec3(1, 0, 0);\n  vec3 camY = vec3(0, 0, -1);\n  pos.xyz += rotateInLocalSpace(viewSpaceVert, camX, camY, cross(camX, camY), q);\n#elif CC_RENDER_MODE == 3\n  vec2 viewSpaceVert = vec2(vertOffset.x * s.x, vertOffset.y * s.y);\n  rotateCorner(viewSpaceVert, q.z);\n  vec3 camX = normalize(vec3(cc_matView[0][0], cc_matView[1][0], cc_matView[2][0]));\n  vec3 camY = vec3(0, 1, 0);\n  vec3 offset = camX * viewSpaceVert.x + camY * viewSpaceVert.y;\n  pos.xyz += offset;\n#else\n  pos.x += vertOffset.x;\n  pos.y += vertOffset.y;\n#endif\n}\nvec2 computeUV (float frameIndex, vec2 vertIndex, vec2 frameTile){\n  vec2 aniUV = vec2(0, floor(frameIndex * frameTile.y));\n  aniUV.x = floor(frameIndex * frameTile.x * frameTile.y - aniUV.y * frameTile.x);\n#if CC_RENDER_MODE != 4\n  vertIndex.y = 1. - vertIndex.y;\n#endif\n  return (aniUV.xy + vertIndex) / vec2(frameTile.x, frameTile.y);\n}\nuniform vec4 u_sampleInfo;\nuniform vec4 u_worldRot;\nuniform vec4 u_timeDelta;\nattribute vec4 a_position_starttime;\nattribute vec4 a_size_uv;\nattribute vec4 a_rotation_uv;\nattribute vec4 a_color;\nattribute vec4 a_dir_life;\nattribute float a_rndSeed;\n#if CC_RENDER_MODE == 4\n  attribute vec3 a_texCoord;\n  attribute vec3 a_texCoord3;\n  attribute vec3 a_normal;\n  attribute vec4 a_color1;\n#endif\nvec3 unpackCurveData (sampler2D tex, vec2 coord) {\n    vec4 a = texture2D(tex, coord);\n    vec4 b = texture2D(tex, coord + u_sampleInfo.y);\n    float c = fract(coord.x * u_sampleInfo.x);\n    return mix(a.xyz, b.xyz, c);\n}\nvec3 unpackCurveData (sampler2D tex, vec2 coord, out float w) {\n    vec4 a = texture2D(tex, coord);\n    vec4 b = texture2D(tex, coord + u_sampleInfo.y);\n    float c = fract(coord.x * u_sampleInfo.x);\n    w = mix(a.w, b.w, c);\n    return mix(a.xyz, b.xyz, c);\n}\nfloat pseudoRandom (float seed) {\n  seed = mod(seed, 233280.);\n  float q = (seed * 9301. + 49297.) / 233280.;\n  return fract(q);\n}\n#if COLOR_OVER_TIME_MODULE_ENABLE\n  uniform sampler2D color_over_time_tex0;\n  uniform int u_color_mode;\n#endif\n#if ROTATION_OVER_TIME_MODULE_ENABLE\n  uniform sampler2D rotation_over_time_tex0;\n  uniform int u_rotation_mode;\n#endif\n#if SIZE_OVER_TIME_MODULE_ENABLE\n  uniform sampler2D size_over_time_tex0;\n  uniform int u_size_mode;\n#endif\n#if FORCE_OVER_TIME_MODULE_ENABLE\n  uniform sampler2D force_over_time_tex0;\n  uniform int u_force_mode;\nuniform int u_force_space;\n#endif\n#if VELOCITY_OVER_TIME_MODULE_ENABLE\n  uniform sampler2D velocity_over_time_tex0;\n  uniform int u_velocity_mode;\nuniform int u_velocity_space;\n#endif\n#if TEXTURE_ANIMATION_MODULE_ENABLE\n  uniform sampler2D texture_animation_tex0;\n  uniform vec4 u_anim_info;\n#endif\nfloat repeat (float t, float length) {\n  return t - floor(t / length) * length;\n}\nvec4 rotateQuat (vec4 p, vec4 q) {\n  vec3 iv = cross(q.xyz, p.xyz) + q.w * p.xyz;\n  vec3 res = p.xyz + 2.0 * cross(q.xyz, iv);\n  return vec4(res.xyz, p.w);\n}\nvec4 gpvs_main () {\n  float activeTime = u_timeDelta.x - a_position_starttime.w;\n  float normalizedTime = clamp(activeTime / a_dir_life.w, 0.0, 1.0);\n  vec2 timeCoord0 = vec2(normalizedTime, 0.);\n  vec2 timeCoord1 = vec2(normalizedTime, 1.);\n  #if CC_RENDER_MODE == 4\n    vec2 vertIdx = vec2(a_texCoord.x, a_texCoord.y);\n  #else\n    vec2 vertIdx = vec2(a_size_uv.w, a_rotation_uv.w);\n  #endif\n  vec4 velocity = vec4(a_dir_life.xyz, 0.);\n  vec4 pos = vec4(a_position_starttime.xyz, 1.);\n  vec3 size = a_size_uv.xyz;\n  #if SIZE_OVER_TIME_MODULE_ENABLE\n    if (u_size_mode == 1) {\n      size *= unpackCurveData(size_over_time_tex0, timeCoord0);\n    } else {\n      vec3 size_0 = unpackCurveData(size_over_time_tex0, timeCoord0);\n      vec3 size_1 = unpackCurveData(size_over_time_tex0, timeCoord1);\n      float factor_s = pseudoRandom(a_rndSeed + 39825.);\n      size *= mix(size_0, size_1, factor_s);\n    }\n  #endif\n  vec3 compScale = scale.xyz * size;\n  #if FORCE_OVER_TIME_MODULE_ENABLE\n    vec3 forceAnim = vec3(0.);\n    if (u_force_mode == 1) {\n      forceAnim = unpackCurveData(force_over_time_tex0, timeCoord0);\n    } else {\n      vec3 force_0 = unpackCurveData(force_over_time_tex0, timeCoord0);\n      vec3 force_1 = unpackCurveData(force_over_time_tex0, timeCoord1);\n      float factor_f =  pseudoRandom(a_rndSeed + 212165.);\n      forceAnim = mix(force_0, force_1, factor_f);\n    }\n    vec4 forceTrack = vec4(forceAnim, 0.);\n    if (u_force_space == 0) {\n      forceTrack = rotateQuat(forceTrack, u_worldRot);\n    }\n    velocity.xyz += forceTrack.xyz;\n  #endif\n  #if VELOCITY_OVER_TIME_MODULE_ENABLE\n    float speedModifier0 = 1.;\n    float speedModifier1 = 1.;\n    vec3 velocityAnim = vec3(0.);\n    if (u_velocity_mode == 1) {\n      velocityAnim = unpackCurveData(velocity_over_time_tex0, timeCoord0, speedModifier0);\n    } else {\n      vec3 vectory_0 = unpackCurveData(velocity_over_time_tex0, timeCoord0, speedModifier0);\n      vec3 vectory_1 = unpackCurveData(velocity_over_time_tex0, timeCoord1, speedModifier1);\n      float factor_v = pseudoRandom(a_rndSeed + 197866.);\n      velocityAnim = mix(vectory_0, vectory_1, factor_v);\n      speedModifier0 = mix(speedModifier0, speedModifier1, factor_v);\n    }\n    vec4 velocityTrack = vec4(velocityAnim, 0.);\n    if (u_velocity_space == 0) {\n      velocityTrack = rotateQuat(velocityTrack, u_worldRot);\n    }\n    velocity.xyz += velocityTrack.xyz;\n    velocity.xyz *= speedModifier0;\n  #endif\n  pos.xyz += velocity.xyz * normalizedTime * a_dir_life.w;\n  #if !CC_USE_WORLD_SPACE\n    pos = cc_matWorld * pos;\n    #if CC_RENDER_MODE == 1\n      velocity = rotateQuat(velocity, u_worldRot);\n    #endif\n  #endif\n  vec3 rotation = a_rotation_uv.xyz;\n  #if ROTATION_OVER_TIME_MODULE_ENABLE\n    if (u_rotation_mode == 1) {\n      rotation += unpackCurveData(rotation_over_time_tex0, timeCoord0) * normalizedTime * a_dir_life.w;\n    } else {\n      vec3 rotation_0 = unpackCurveData(rotation_over_time_tex0, timeCoord0);\n      vec3 rotation_1 = unpackCurveData(rotation_over_time_tex0, timeCoord1);\n      float factor_r = pseudoRandom(a_rndSeed + 125292.);\n      rotation += mix(rotation_0, rotation_1, factor_r) * normalizedTime * a_dir_life.w;\n    }\n  #endif\n  #if COLOR_OVER_TIME_MODULE_ENABLE\n    if (u_color_mode == 1) {\n      color = a_color * texture2D(color_over_time_tex0, timeCoord0);\n    } else {\n      vec4 color_0 = texture2D(color_over_time_tex0, timeCoord0);\n      vec4 color_1 = texture2D(color_over_time_tex0, timeCoord1);\n      float factor_c = pseudoRandom(a_rndSeed + 91041.);\n      color = a_color * mix(color_0, color_1, factor_c);\n    }\n  #else\n    color = a_color;\n  #endif\n  #if CC_RENDER_MODE != 4\n    vec2 cornerOffset = vec2((vertIdx - 0.5));\n    #if CC_RENDER_MODE == 0\n      vec3 rotEuler = rotation.xyz;\n    #elif CC_RENDER_MODE == 1\n      vec3 rotEuler = vec3(0.);\n    #else\n      vec3 rotEuler = vec3(0., 0., rotation.z);\n    #endif\n    computeVertPos(pos, cornerOffset, quaternionFromEuler(rotEuler), compScale\n      #if CC_RENDER_MODE == 0 || CC_RENDER_MODE == 3\n        , cc_matViewInv\n      #endif\n      #if CC_RENDER_MODE == 1\n        , cc_cameraPos.xyz\n        , velocity\n        , frameTile_velLenScale.z\n        , frameTile_velLenScale.w\n        , a_size_uv.w\n      #endif\n    );\n  #else\n    mat4 xformNoScale = matrixFromRT(quaternionFromEuler(rotation), pos.xyz);\n    mat4 xform = matFromRTS(quaternionFromEuler(rotation), pos.xyz, compScale);\n    pos = xform * vec4(a_texCoord3, 1);\n    vec4 normal = xformNoScale * vec4(a_normal, 0);\n    color *= a_color1;\n  #endif\n  pos = cc_matViewProj * pos;\n  float frameIndex = 0.;\n  #if TEXTURE_ANIMATION_MODULE_ENABLE\n    float startFrame = 0.;\n    vec3 frameInfo = vec3(0.);\n    if (int(u_anim_info.x) == 1) {\n      frameInfo = unpackCurveData(texture_animation_tex0, timeCoord0);\n    } else {\n      vec3 frameInfo0 = unpackCurveData(texture_animation_tex0, timeCoord0);\n      vec3 frameInfo1 = unpackCurveData(texture_animation_tex0, timeCoord1);\n      float factor_t = pseudoRandom(a_rndSeed + 90794.);\n      frameInfo = mix(frameInfo0, frameInfo1, factor_t);\n    }\n    startFrame = frameInfo.x / u_anim_info.y;\n    frameIndex = repeat(u_anim_info.z * (frameInfo.y + startFrame), 1.);\n  #endif\n  uv = computeUV(frameIndex, vertIdx, frameTile_velLenScale.xy) * mainTiling_Offset.xy + mainTiling_Offset.zw;\n  return pos;\n}\nvoid main() { gl_Position = gpvs_main(); }",frag:"\nprecision mediump float;\nuniform mediump vec4 cc_exposure;\nvec3 SRGBToLinear (vec3 gamma) {\n  return gamma * gamma;\n}\nvec4 CCFragOutput (vec4 color) {\n  #if CC_USE_HDR\n    color.rgb = mix(color.rgb, SRGBToLinear(color.rgb) * cc_exposure.w, vec3(cc_exposure.z));\n  #endif\n  return color;\n}\nvarying vec2 uv;\nvarying vec4 color;\nuniform sampler2D mainTexture;\nuniform vec4 tintColor;\nvec4 add () {\n  vec4 col = 2.0 * color * tintColor * texture2D(mainTexture, uv);\n  return CCFragOutput(col);\n}\nvoid main() { gl_FragColor = add(); }"},builtins:{globals:{blocks:[{name:"CCGlobal",defines:[]}],samplers:[]},locals:{blocks:[{name:"CCLocal",defines:[]}],samplers:[]}},defines:[{name:"CC_RENDER_MODE",type:"number",range:[0,4]},{name:"COLOR_OVER_TIME_MODULE_ENABLE",type:"boolean"},{name:"ROTATION_OVER_TIME_MODULE_ENABLE",type:"boolean"},{name:"SIZE_OVER_TIME_MODULE_ENABLE",type:"boolean"},{name:"FORCE_OVER_TIME_MODULE_ENABLE",type:"boolean"},{name:"VELOCITY_OVER_TIME_MODULE_ENABLE",type:"boolean"},{name:"TEXTURE_ANIMATION_MODULE_ENABLE",type:"boolean"},{name:"CC_USE_WORLD_SPACE",type:"boolean"},{name:"CC_USE_HDR",type:"boolean"}],blocks:[{name:"Constants",defines:[],binding:0,members:[{name:"mainTiling_Offset",type:16,count:1},{name:"frameTile_velLenScale",type:16,count:1},{name:"scale",type:16,count:1}]},{name:"SampleConstants",defines:[],binding:1,members:[{name:"u_sampleInfo",type:16,count:1}]},{name:"TickConstants",defines:[],binding:2,members:[{name:"u_worldRot",type:16,count:1},{name:"u_timeDelta",type:16,count:1}]},{name:"ColorConstant",defines:["COLOR_OVER_TIME_MODULE_ENABLE"],binding:3,members:[{name:"u_color_mode",type:5,count:1}]},{name:"RotationConstant",defines:["ROTATION_OVER_TIME_MODULE_ENABLE"],binding:4,members:[{name:"u_rotation_mode",type:5,count:1}]},{name:"SizeConstant",defines:["SIZE_OVER_TIME_MODULE_ENABLE"],binding:5,members:[{name:"u_size_mode",type:5,count:1}]},{name:"ForceConstant",defines:["FORCE_OVER_TIME_MODULE_ENABLE"],binding:6,members:[{name:"u_force_mode",type:5,count:1},{name:"u_force_space",type:5,count:1}]},{name:"VelocityConstant",defines:["VELOCITY_OVER_TIME_MODULE_ENABLE"],binding:7,members:[{name:"u_velocity_mode",type:5,count:1},{name:"u_velocity_space",type:5,count:1}]},{name:"AnimationConstant",defines:["TEXTURE_ANIMATION_MODULE_ENABLE"],binding:8,members:[{name:"u_anim_info",type:16,count:1}]},{name:"FragConstants",defines:[],binding:9,members:[{name:"tintColor",type:16,count:1}]}],samplers:[{name:"color_over_time_tex0",type:28,count:1,defines:["COLOR_OVER_TIME_MODULE_ENABLE"],binding:31},{name:"rotation_over_time_tex0",type:28,count:1,defines:["ROTATION_OVER_TIME_MODULE_ENABLE"],binding:32},{name:"size_over_time_tex0",type:28,count:1,defines:["SIZE_OVER_TIME_MODULE_ENABLE"],binding:33},{name:"force_over_time_tex0",type:28,count:1,defines:["FORCE_OVER_TIME_MODULE_ENABLE"],binding:34},{name:"velocity_over_time_tex0",type:28,count:1,defines:["VELOCITY_OVER_TIME_MODULE_ENABLE"],binding:35},{name:"texture_animation_tex0",type:28,count:1,defines:["TEXTURE_ANIMATION_MODULE_ENABLE"],binding:36},{name:"mainTexture",type:28,count:1,defines:[],binding:37}],attributes:[{name:"a_position_starttime",type:16,count:1,defines:[],format:43,location:0},{name:"a_size_uv",type:16,count:1,defines:[],format:43,location:1},{name:"a_rotation_uv",type:16,count:1,defines:[],format:43,location:2},{name:"a_color",type:16,count:1,defines:[],format:43,location:3},{name:"a_dir_life",type:16,count:1,defines:[],format:43,location:4},{name:"a_rndSeed",type:13,count:1,defines:[],format:11,location:5},{name:"a_texCoord",type:15,count:1,defines:["CC_RENDER_MODE"],format:32,location:6},{name:"a_texCoord3",type:15,count:1,defines:["CC_RENDER_MODE"],format:32,location:7},{name:"a_normal",type:15,count:1,defines:["CC_RENDER_MODE"],format:32,location:8},{name:"a_color1",type:16,count:1,defines:["CC_RENDER_MODE"],format:43,location:9}]}]},{name:"builtin-particle-trail",_uuid:"17debcc3-0a6b-4b8a-b00b-dc58b885581e",techniques:[{name:"add",passes:[{rasterizerState:{cullMode:0},blendState:{targets:[{blend:!0,blendSrc:2,blendDst:1,blendSrcAlpha:2,blendDstAlpha:1}]},program:"builtin-particle-trail|particle-trail:vs_main|tinted-fs:add",depthStencilState:{depthTest:!0,depthWrite:!1},properties:{mainTexture:{value:"grey",type:28},mainTiling_Offset:{value:[1,1,0,0],type:16},frameTile_velLenScale:{value:[1,1,0,0],type:16},tintColor:{value:[.5,.5,.5,.5],type:16}}}]}],shaders:[{name:"builtin-particle-trail|particle-trail:vs_main|tinted-fs:add",hash:535523547,glsl3:{vert:"\nprecision mediump float;\nuniform Constants {\n  vec4 mainTiling_Offset;\n  vec4 frameTile_velLenScale;\n  vec4 scale;\n};\nuniform CCGlobal {\n  highp   vec4 cc_time;\n  mediump vec4 cc_screenSize;\n  mediump vec4 cc_screenScale;\n  mediump vec4 cc_nativeSize;\n  highp   mat4 cc_matView;\n  highp   mat4 cc_matViewInv;\n  highp   mat4 cc_matProj;\n  highp   mat4 cc_matProjInv;\n  highp   mat4 cc_matViewProj;\n  highp   mat4 cc_matViewProjInv;\n  highp   vec4 cc_cameraPos;\n  mediump vec4 cc_exposure;\n  mediump vec4 cc_mainLitDir;\n  mediump vec4 cc_mainLitColor;\n  mediump vec4 cc_ambientSky;\n  mediump vec4 cc_ambientGround;\n};\nuniform CCLocal {\n  highp mat4 cc_matWorld;\n  highp mat4 cc_matWorldIT;\n  highp vec4 cc_lightingMapUVParam;\n};\nout vec2 uv;\nout vec4 color;\nin vec3 a_position;\nin vec4 a_texCoord;\nin vec3 a_texCoord1;\nin vec3 a_texCoord2;\nin vec4 a_color;\n#if CC_DRAW_WIRE_FRAME\n  out vec3 vBarycentric;\n#endif\nvec4 vs_main() {\n  highp vec4 pos = vec4(a_position, 1);\n  vec4 velocity = vec4(a_texCoord1.xyz, 0);\n  #if !CC_USE_WORLD_SPACE\n    pos = cc_matWorld * pos;\n    velocity = cc_matWorld * velocity;\n  #endif\n  float vertOffset = (a_texCoord.x - 0.5) * a_texCoord.y;\n  vec3 camUp = normalize(cross(pos.xyz - cc_cameraPos.xyz, velocity.xyz));\n  pos.xyz += camUp * vertOffset;\n  pos = cc_matViewProj * pos;\n  uv = a_texCoord.zw * mainTiling_Offset.xy + mainTiling_Offset.zw;;\n  color = a_color;\n  #if CC_DRAW_WIRE_FRAME\n    vBarycentric = a_texCoord2;\n  #endif\n  return pos;\n}\nvoid main() { gl_Position = vs_main(); }",frag:"\n  precision mediump float;\nuniform CCGlobal {\n  highp   vec4 cc_time;\n  mediump vec4 cc_screenSize;\n  mediump vec4 cc_screenScale;\n  mediump vec4 cc_nativeSize;\n  highp   mat4 cc_matView;\n  highp   mat4 cc_matViewInv;\n  highp   mat4 cc_matProj;\n  highp   mat4 cc_matProjInv;\n  highp   mat4 cc_matViewProj;\n  highp   mat4 cc_matViewProjInv;\n  highp   vec4 cc_cameraPos;\n  mediump vec4 cc_exposure;\n  mediump vec4 cc_mainLitDir;\n  mediump vec4 cc_mainLitColor;\n  mediump vec4 cc_ambientSky;\n  mediump vec4 cc_ambientGround;\n};\nvec3 SRGBToLinear (vec3 gamma) {\n  return gamma * gamma;\n}\nvec4 CCFragOutput (vec4 color) {\n  #if CC_USE_HDR\n    color.rgb = mix(color.rgb, SRGBToLinear(color.rgb) * cc_exposure.w, vec3(cc_exposure.z));\n  #endif\n  return color;\n}\n  in vec2 uv;\n  in vec4 color;\n  #if CC_DRAW_WIRE_FRAME\n    in vec3 vBarycentric;\n  #endif\n  uniform sampler2D mainTexture;\n  uniform FragConstants {\n    vec4 tintColor;\n  };\n  vec4 add () {\n    vec4 col = 2.0 * color * tintColor * texture(mainTexture, uv);\n#if CC_DRAW_WIRE_FRAME\n    if (any(lessThan(vBarycentric, vec3(0.02)))) {\n        col = vec4(0., 1., 1., 1.);\n    }\n#endif\n    return CCFragOutput(col);\n  }\nout vec4 cc_FragColor;\nvoid main() { cc_FragColor = add(); }"},glsl1:{vert:"\nprecision mediump float;\nuniform vec4 mainTiling_Offset;\nuniform highp mat4 cc_matViewProj;\nuniform highp vec4 cc_cameraPos;\nuniform highp mat4 cc_matWorld;\nvarying vec2 uv;\nvarying vec4 color;\nattribute vec3 a_position;\nattribute vec4 a_texCoord;\nattribute vec3 a_texCoord1;\nattribute vec3 a_texCoord2;\nattribute vec4 a_color;\n#if CC_DRAW_WIRE_FRAME\n  varying vec3 vBarycentric;\n#endif\nvec4 vs_main() {\n  highp vec4 pos = vec4(a_position, 1);\n  vec4 velocity = vec4(a_texCoord1.xyz, 0);\n  #if !CC_USE_WORLD_SPACE\n    pos = cc_matWorld * pos;\n    velocity = cc_matWorld * velocity;\n  #endif\n  float vertOffset = (a_texCoord.x - 0.5) * a_texCoord.y;\n  vec3 camUp = normalize(cross(pos.xyz - cc_cameraPos.xyz, velocity.xyz));\n  pos.xyz += camUp * vertOffset;\n  pos = cc_matViewProj * pos;\n  uv = a_texCoord.zw * mainTiling_Offset.xy + mainTiling_Offset.zw;;\n  color = a_color;\n  #if CC_DRAW_WIRE_FRAME\n    vBarycentric = a_texCoord2;\n  #endif\n  return pos;\n}\nvoid main() { gl_Position = vs_main(); }",frag:"\n  precision mediump float;\nuniform mediump vec4 cc_exposure;\nvec3 SRGBToLinear (vec3 gamma) {\n  return gamma * gamma;\n}\nvec4 CCFragOutput (vec4 color) {\n  #if CC_USE_HDR\n    color.rgb = mix(color.rgb, SRGBToLinear(color.rgb) * cc_exposure.w, vec3(cc_exposure.z));\n  #endif\n  return color;\n}\n  varying vec2 uv;\n  varying vec4 color;\n  #if CC_DRAW_WIRE_FRAME\n    varying vec3 vBarycentric;\n  #endif\n  uniform sampler2D mainTexture;\n  uniform vec4 tintColor;\n  vec4 add () {\n    vec4 col = 2.0 * color * tintColor * texture2D(mainTexture, uv);\n#if CC_DRAW_WIRE_FRAME\n    if (any(lessThan(vBarycentric, vec3(0.02)))) {\n        col = vec4(0., 1., 1., 1.);\n    }\n#endif\n    return CCFragOutput(col);\n  }\nvoid main() { gl_FragColor = add(); }"},builtins:{globals:{blocks:[{name:"CCGlobal",defines:[]}],samplers:[]},locals:{blocks:[{name:"CCLocal",defines:[]}],samplers:[]}},defines:[{name:"CC_RENDER_MODE",type:"number",range:[0,4]},{name:"CC_DRAW_WIRE_FRAME",type:"boolean"},{name:"CC_USE_WORLD_SPACE",type:"boolean"},{name:"CC_USE_HDR",type:"boolean"}],blocks:[{name:"Constants",defines:[],binding:0,members:[{name:"mainTiling_Offset",type:16,count:1},{name:"frameTile_velLenScale",type:16,count:1},{name:"scale",type:16,count:1}]},{name:"FragConstants",defines:[],binding:1,members:[{name:"tintColor",type:16,count:1}]}],samplers:[{name:"mainTexture",type:28,count:1,defines:[],binding:31}],attributes:[{name:"a_position",type:15,count:1,defines:[],format:32,location:0},{name:"a_texCoord",type:16,count:1,defines:[],format:43,location:1},{name:"a_texCoord1",type:15,count:1,defines:[],format:32,location:2},{name:"a_texCoord2",type:15,count:1,defines:[],format:32,location:3},{name:"a_color",type:16,count:1,defines:[],format:43,location:4}]}]},{name:"builtin-particle",_uuid:"d1346436-ac96-4271-b863-1f4fdead95b0",techniques:[{name:"add",passes:[{rasterizerState:{cullMode:0},blendState:{targets:[{blend:!0,blendSrc:2,blendDst:1,blendSrcAlpha:2,blendDstAlpha:1}]},program:"builtin-particle|particle-vs-legacy:lpvs_main|tinted-fs:add",depthStencilState:{depthTest:!0,depthWrite:!1},properties:{mainTexture:{value:"grey",type:28},mainTiling_Offset:{value:[1,1,0,0],type:16},tintColor:{value:[.5,.5,.5,.5],type:16}}}]}],shaders:[{name:"builtin-particle|particle-vs-legacy:lpvs_main|tinted-fs:add",hash:2171161221,glsl3:{vert:"\nprecision highp float;\nvec4 quaternionFromAxis (vec3 xAxis,vec3 yAxis,vec3 zAxis){\n  mat3 m = mat3(xAxis,yAxis,zAxis);\n  float trace = m[0][0] + m[1][1] + m[2][2];\n  vec4 quat;\n  if (trace > 0.) {\n    float s = 0.5 / sqrt(trace + 1.0);\n    quat.w = 0.25 / s;\n    quat.x = (m[2][1] - m[1][2]) * s;\n    quat.y = (m[0][2] - m[2][0]) * s;\n    quat.z = (m[1][0] - m[0][1]) * s;\n  } else if ((m[0][0] > m[1][1]) && (m[0][0] > m[2][2])) {\n    float s = 2.0 * sqrt(1.0 + m[0][0] - m[1][1] - m[2][2]);\n    quat.w = (m[2][1] - m[1][2]) / s;\n    quat.x = 0.25 * s;\n    quat.y = (m[0][1] + m[1][0]) / s;\n    quat.z = (m[0][2] + m[2][0]) / s;\n  } else if (m[1][1] > m[2][2]) {\n    float s = 2.0 * sqrt(1.0 + m[1][1] - m[0][0] - m[2][2]);\n    quat.w = (m[0][2] - m[2][0]) / s;\n    quat.x = (m[0][1] + m[1][0]) / s;\n    quat.y = 0.25 * s;\n    quat.z = (m[1][2] + m[2][1]) / s;\n  } else {\n    float s = 2.0 * sqrt(1.0 + m[2][2] - m[0][0] - m[1][1]);\n    quat.w = (m[1][0] - m[0][1]) / s;\n    quat.x = (m[0][2] + m[2][0]) / s;\n    quat.y = (m[1][2] + m[2][1]) / s;\n    quat.z = 0.25 * s;\n  }\n  float len = quat.x * quat.x + quat.y * quat.y + quat.z * quat.z + quat.w * quat.w;\n  if (len > 0.) {\n    len = 1. / sqrt(len);\n    quat.x = quat.x * len;\n    quat.y = quat.y * len;\n    quat.z = quat.z * len;\n    quat.w = quat.w * len;\n  }\n  return quat;\n}\nvec4 quaternionFromEuler (vec3 angle){\n  float x = angle.x / 2.;\n  float y = angle.y / 2.;\n  float z = angle.z / 2.;\n  float sx = sin(x);\n  float cx = cos(x);\n  float sy = sin(y);\n  float cy = cos(y);\n  float sz = sin(z);\n  float cz = cos(z);\n  vec4 quat = vec4(0);\n  quat.x = sx * cy * cz + cx * sy * sz;\n  quat.y = cx * sy * cz + sx * cy * sz;\n  quat.z = cx * cy * sz - sx * sy * cz;\n  quat.w = cx * cy * cz - sx * sy * sz;\n  return quat;\n}\nmat4 matrixFromRT (vec4 q, vec3 p){\n  float x2 = q.x + q.x;\n  float y2 = q.y + q.y;\n  float z2 = q.z + q.z;\n  float xx = q.x * x2;\n  float xy = q.x * y2;\n  float xz = q.x * z2;\n  float yy = q.y * y2;\n  float yz = q.y * z2;\n  float zz = q.z * z2;\n  float wx = q.w * x2;\n  float wy = q.w * y2;\n  float wz = q.w * z2;\n  return mat4(\n    1. - (yy + zz), xy + wz, xz - wy, 0,\n    xy - wz, 1. - (xx + zz), yz + wx, 0,\n    xz + wy, yz - wx, 1. - (xx + yy), 0,\n    p.x, p.y, p.z, 1\n  );\n}\nmat4 matFromRTS (vec4 q, vec3 t, vec3 s){\n  float x = q.x, y = q.y, z = q.z, w = q.w;\n  float x2 = x + x;\n  float y2 = y + y;\n  float z2 = z + z;\n  float xx = x * x2;\n  float xy = x * y2;\n  float xz = x * z2;\n  float yy = y * y2;\n  float yz = y * z2;\n  float zz = z * z2;\n  float wx = w * x2;\n  float wy = w * y2;\n  float wz = w * z2;\n  float sx = s.x;\n  float sy = s.y;\n  float sz = s.z;\n  return mat4((1. - (yy + zz)) * sx, (xy + wz) * sx, (xz - wy) * sx, 0,\n    (xy - wz) * sy, (1. - (xx + zz)) * sy, (yz + wx) * sy, 0,\n    (xz + wy) * sz, (yz - wx) * sz, (1. - (xx + yy)) * sz, 0,\n    t.x, t.y, t.z, 1);\n}\nvec4 quatMultiply (vec4 a, vec4 b){\n  vec4 quat;\n  quat.x = a.x * b.w + a.w * b.x + a.y * b.z - a.z * b.y;\n  quat.y = a.y * b.w + a.w * b.y + a.z * b.x - a.x * b.z;\n  quat.z = a.z * b.w + a.w * b.z + a.x * b.y - a.y * b.x;\n  quat.w = a.w * b.w - a.x * b.x - a.y * b.y - a.z * b.z;\n  return quat;\n}\nvoid rotateVecFromQuat (inout vec3 v, vec4 q){\n  float ix = q.w * v.x + q.y * v.z - q.z * v.y;\n  float iy = q.w * v.y + q.z * v.x - q.x * v.z;\n  float iz = q.w * v.z + q.x * v.y - q.y * v.x;\n  float iw = -q.x * v.x - q.y * v.y - q.z * v.z;\n  v.x = ix * q.w + iw * -q.x + iy * -q.z - iz * -q.y;\n  v.y = iy * q.w + iw * -q.y + iz * -q.x - ix * -q.z;\n  v.z = iz * q.w + iw * -q.z + ix * -q.y - iy * -q.x;\n}\nvec3 rotateInLocalSpace (vec3 pos, vec3 xAxis, vec3 yAxis, vec3 zAxis, vec4 q){\n  vec4 viewQuat = quaternionFromAxis(xAxis, yAxis, zAxis);\n  vec4 rotQuat = quatMultiply(viewQuat, q);\n  rotateVecFromQuat(pos, rotQuat);\n  return pos;\n}\nvoid rotateCorner (inout vec2 corner, float angle){\n  float xOS = cos(angle) * corner.x - sin(angle) * corner.y;\n  float yOS = sin(angle) * corner.x + cos(angle) * corner.y;\n  corner.x = xOS;\n  corner.y = yOS;\n}\nuniform Constants {\n  vec4 mainTiling_Offset;\n  vec4 frameTile_velLenScale;\n  vec4 scale;\n};\nuniform CCGlobal {\n  highp   vec4 cc_time;\n  mediump vec4 cc_screenSize;\n  mediump vec4 cc_screenScale;\n  mediump vec4 cc_nativeSize;\n  highp   mat4 cc_matView;\n  highp   mat4 cc_matViewInv;\n  highp   mat4 cc_matProj;\n  highp   mat4 cc_matProjInv;\n  highp   mat4 cc_matViewProj;\n  highp   mat4 cc_matViewProjInv;\n  highp   vec4 cc_cameraPos;\n  mediump vec4 cc_exposure;\n  mediump vec4 cc_mainLitDir;\n  mediump vec4 cc_mainLitColor;\n  mediump vec4 cc_ambientSky;\n  mediump vec4 cc_ambientGround;\n};\nuniform CCLocal {\n  highp mat4 cc_matWorld;\n  highp mat4 cc_matWorldIT;\n  highp vec4 cc_lightingMapUVParam;\n};\nout vec2 uv;\nout vec4 color;\nvoid computeVertPos (inout vec4 pos, vec2 vertOffset, vec4 q, vec3 s\n#if CC_RENDER_MODE == 0 || CC_RENDER_MODE == 3\n  , mat4 viewInv\n#endif\n#if CC_RENDER_MODE == 1\n  , vec3 eye\n  , vec4 velocity\n  , float velocityScale\n  , float lengthScale\n  , float xIndex\n#endif\n) {\n#if CC_RENDER_MODE == 0\n  vec3 viewSpaceVert = vec3(vertOffset.x * s.x, vertOffset.y * s.y, 0.);\n  vec3 camX = normalize(vec3(viewInv[0][0], viewInv[1][0], viewInv[2][0]));\n  vec3 camY = normalize(vec3(viewInv[0][1], viewInv[1][1], viewInv[2][1]));\n  vec3 camZ = normalize(vec3(viewInv[0][2], viewInv[1][2], viewInv[2][2]));\n  pos.xyz += rotateInLocalSpace(viewSpaceVert, camX, camY, camZ, q);\n#elif CC_RENDER_MODE == 1\n  vec3 camRight = normalize(cross(pos.xyz - eye, velocity.xyz)) * s.x;\n  vec3 camUp = velocity.xyz * velocityScale + normalize(velocity.xyz) * lengthScale * s.y;\n  pos.xyz += (camRight * abs(vertOffset.x) * sign(vertOffset.y)) - camUp * xIndex;\n#elif CC_RENDER_MODE == 2\n  vec3 viewSpaceVert = vec3(vertOffset.x * s.x, vertOffset.y * s.y, 0.);\n  vec3 camX = vec3(1, 0, 0);\n  vec3 camY = vec3(0, 0, -1);\n  pos.xyz += rotateInLocalSpace(viewSpaceVert, camX, camY, cross(camX, camY), q);\n#elif CC_RENDER_MODE == 3\n  vec2 viewSpaceVert = vec2(vertOffset.x * s.x, vertOffset.y * s.y);\n  rotateCorner(viewSpaceVert, q.z);\n  vec3 camX = normalize(vec3(cc_matView[0][0], cc_matView[1][0], cc_matView[2][0]));\n  vec3 camY = vec3(0, 1, 0);\n  vec3 offset = camX * viewSpaceVert.x + camY * viewSpaceVert.y;\n  pos.xyz += offset;\n#else\n  pos.x += vertOffset.x;\n  pos.y += vertOffset.y;\n#endif\n}\nvec2 computeUV (float frameIndex, vec2 vertIndex, vec2 frameTile){\n  vec2 aniUV = vec2(0, floor(frameIndex * frameTile.y));\n  aniUV.x = floor(frameIndex * frameTile.x * frameTile.y - aniUV.y * frameTile.x);\n#if CC_RENDER_MODE != 4\n  vertIndex.y = 1. - vertIndex.y;\n#endif\n  return (aniUV.xy + vertIndex) / vec2(frameTile.x, frameTile.y);\n}\nin vec3 a_position;\nin vec3 a_texCoord;\nin vec3 a_texCoord1;\nin vec3 a_texCoord2;\nin vec4 a_color;\n#if CC_RENDER_MODE == 1\n  in vec3 a_color1;\n#endif\n#if CC_RENDER_MODE == 4\n  in vec3 a_texCoord3;\n  in vec3 a_normal;\n  in vec4 a_color1;\n#endif\nvec4 lpvs_main () {\n  vec3 compScale = scale.xyz * a_texCoord1;\n  vec4 pos = vec4(a_position, 1);\n  #if CC_RENDER_MODE == 1\n    vec4 velocity = vec4(a_color1.xyz, 0);\n  #endif\n  #if !CC_USE_WORLD_SPACE\n    pos = cc_matWorld * pos;\n    #if CC_RENDER_MODE == 1\n      velocity = cc_matWorld * velocity;\n    #endif\n  #endif\n  #if CC_RENDER_MODE != 4\n    vec2 cornerOffset = vec2((a_texCoord.xy - 0.5));\n    #if CC_RENDER_MODE == 0\n      vec3 rotEuler = a_texCoord2;\n    #elif CC_RENDER_MODE == 1\n      vec3 rotEuler = vec3(0.);\n    #else\n      vec3 rotEuler = vec3(0., 0., a_texCoord2.z);\n    #endif\n    computeVertPos(pos, cornerOffset, quaternionFromEuler(rotEuler), compScale\n    #if CC_RENDER_MODE == 0 || CC_RENDER_MODE == 3\n      , cc_matViewInv\n    #endif\n    #if CC_RENDER_MODE == 1\n      , cc_cameraPos.xyz\n      , velocity\n      , frameTile_velLenScale.z\n      , frameTile_velLenScale.w\n      , a_texCoord.x\n    #endif\n    );\n    color = a_color;\n  #else\n    mat4 xformNoScale = matrixFromRT(quaternionFromEuler(a_texCoord2), pos.xyz);\n    mat4 xform = matFromRTS(quaternionFromEuler(a_texCoord2), pos.xyz, compScale);\n    pos = xform * vec4(a_texCoord3, 1);\n    vec4 normal = xformNoScale * vec4(a_normal, 0);\n    color = a_color * a_color1;\n  #endif\n  uv = computeUV(a_texCoord.z, a_texCoord.xy, frameTile_velLenScale.xy) * mainTiling_Offset.xy + mainTiling_Offset.zw;\n  pos = cc_matViewProj * pos;\n  return pos;\n}\nvoid main() { gl_Position = lpvs_main(); }",frag:"\nprecision mediump float;\nuniform CCGlobal {\n  highp   vec4 cc_time;\n  mediump vec4 cc_screenSize;\n  mediump vec4 cc_screenScale;\n  mediump vec4 cc_nativeSize;\n  highp   mat4 cc_matView;\n  highp   mat4 cc_matViewInv;\n  highp   mat4 cc_matProj;\n  highp   mat4 cc_matProjInv;\n  highp   mat4 cc_matViewProj;\n  highp   mat4 cc_matViewProjInv;\n  highp   vec4 cc_cameraPos;\n  mediump vec4 cc_exposure;\n  mediump vec4 cc_mainLitDir;\n  mediump vec4 cc_mainLitColor;\n  mediump vec4 cc_ambientSky;\n  mediump vec4 cc_ambientGround;\n};\nvec3 SRGBToLinear (vec3 gamma) {\n  return gamma * gamma;\n}\nvec4 CCFragOutput (vec4 color) {\n  #if CC_USE_HDR\n    color.rgb = mix(color.rgb, SRGBToLinear(color.rgb) * cc_exposure.w, vec3(cc_exposure.z));\n  #endif\n  return color;\n}\nin vec2 uv;\nin vec4 color;\nuniform sampler2D mainTexture;\nuniform FragConstants {\n  vec4 tintColor;\n};\nvec4 add () {\n  vec4 col = 2.0 * color * tintColor * texture(mainTexture, uv);\n  return CCFragOutput(col);\n}\nout vec4 cc_FragColor;\nvoid main() { cc_FragColor = add(); }"},glsl1:{vert:"\nprecision highp float;\nvec4 quaternionFromAxis (vec3 xAxis,vec3 yAxis,vec3 zAxis){\n  mat3 m = mat3(xAxis,yAxis,zAxis);\n  float trace = m[0][0] + m[1][1] + m[2][2];\n  vec4 quat;\n  if (trace > 0.) {\n    float s = 0.5 / sqrt(trace + 1.0);\n    quat.w = 0.25 / s;\n    quat.x = (m[2][1] - m[1][2]) * s;\n    quat.y = (m[0][2] - m[2][0]) * s;\n    quat.z = (m[1][0] - m[0][1]) * s;\n  } else if ((m[0][0] > m[1][1]) && (m[0][0] > m[2][2])) {\n    float s = 2.0 * sqrt(1.0 + m[0][0] - m[1][1] - m[2][2]);\n    quat.w = (m[2][1] - m[1][2]) / s;\n    quat.x = 0.25 * s;\n    quat.y = (m[0][1] + m[1][0]) / s;\n    quat.z = (m[0][2] + m[2][0]) / s;\n  } else if (m[1][1] > m[2][2]) {\n    float s = 2.0 * sqrt(1.0 + m[1][1] - m[0][0] - m[2][2]);\n    quat.w = (m[0][2] - m[2][0]) / s;\n    quat.x = (m[0][1] + m[1][0]) / s;\n    quat.y = 0.25 * s;\n    quat.z = (m[1][2] + m[2][1]) / s;\n  } else {\n    float s = 2.0 * sqrt(1.0 + m[2][2] - m[0][0] - m[1][1]);\n    quat.w = (m[1][0] - m[0][1]) / s;\n    quat.x = (m[0][2] + m[2][0]) / s;\n    quat.y = (m[1][2] + m[2][1]) / s;\n    quat.z = 0.25 * s;\n  }\n  float len = quat.x * quat.x + quat.y * quat.y + quat.z * quat.z + quat.w * quat.w;\n  if (len > 0.) {\n    len = 1. / sqrt(len);\n    quat.x = quat.x * len;\n    quat.y = quat.y * len;\n    quat.z = quat.z * len;\n    quat.w = quat.w * len;\n  }\n  return quat;\n}\nvec4 quaternionFromEuler (vec3 angle){\n  float x = angle.x / 2.;\n  float y = angle.y / 2.;\n  float z = angle.z / 2.;\n  float sx = sin(x);\n  float cx = cos(x);\n  float sy = sin(y);\n  float cy = cos(y);\n  float sz = sin(z);\n  float cz = cos(z);\n  vec4 quat = vec4(0);\n  quat.x = sx * cy * cz + cx * sy * sz;\n  quat.y = cx * sy * cz + sx * cy * sz;\n  quat.z = cx * cy * sz - sx * sy * cz;\n  quat.w = cx * cy * cz - sx * sy * sz;\n  return quat;\n}\nmat4 matrixFromRT (vec4 q, vec3 p){\n  float x2 = q.x + q.x;\n  float y2 = q.y + q.y;\n  float z2 = q.z + q.z;\n  float xx = q.x * x2;\n  float xy = q.x * y2;\n  float xz = q.x * z2;\n  float yy = q.y * y2;\n  float yz = q.y * z2;\n  float zz = q.z * z2;\n  float wx = q.w * x2;\n  float wy = q.w * y2;\n  float wz = q.w * z2;\n  return mat4(\n    1. - (yy + zz), xy + wz, xz - wy, 0,\n    xy - wz, 1. - (xx + zz), yz + wx, 0,\n    xz + wy, yz - wx, 1. - (xx + yy), 0,\n    p.x, p.y, p.z, 1\n  );\n}\nmat4 matFromRTS (vec4 q, vec3 t, vec3 s){\n  float x = q.x, y = q.y, z = q.z, w = q.w;\n  float x2 = x + x;\n  float y2 = y + y;\n  float z2 = z + z;\n  float xx = x * x2;\n  float xy = x * y2;\n  float xz = x * z2;\n  float yy = y * y2;\n  float yz = y * z2;\n  float zz = z * z2;\n  float wx = w * x2;\n  float wy = w * y2;\n  float wz = w * z2;\n  float sx = s.x;\n  float sy = s.y;\n  float sz = s.z;\n  return mat4((1. - (yy + zz)) * sx, (xy + wz) * sx, (xz - wy) * sx, 0,\n    (xy - wz) * sy, (1. - (xx + zz)) * sy, (yz + wx) * sy, 0,\n    (xz + wy) * sz, (yz - wx) * sz, (1. - (xx + yy)) * sz, 0,\n    t.x, t.y, t.z, 1);\n}\nvec4 quatMultiply (vec4 a, vec4 b){\n  vec4 quat;\n  quat.x = a.x * b.w + a.w * b.x + a.y * b.z - a.z * b.y;\n  quat.y = a.y * b.w + a.w * b.y + a.z * b.x - a.x * b.z;\n  quat.z = a.z * b.w + a.w * b.z + a.x * b.y - a.y * b.x;\n  quat.w = a.w * b.w - a.x * b.x - a.y * b.y - a.z * b.z;\n  return quat;\n}\nvoid rotateVecFromQuat (inout vec3 v, vec4 q){\n  float ix = q.w * v.x + q.y * v.z - q.z * v.y;\n  float iy = q.w * v.y + q.z * v.x - q.x * v.z;\n  float iz = q.w * v.z + q.x * v.y - q.y * v.x;\n  float iw = -q.x * v.x - q.y * v.y - q.z * v.z;\n  v.x = ix * q.w + iw * -q.x + iy * -q.z - iz * -q.y;\n  v.y = iy * q.w + iw * -q.y + iz * -q.x - ix * -q.z;\n  v.z = iz * q.w + iw * -q.z + ix * -q.y - iy * -q.x;\n}\nvec3 rotateInLocalSpace (vec3 pos, vec3 xAxis, vec3 yAxis, vec3 zAxis, vec4 q){\n  vec4 viewQuat = quaternionFromAxis(xAxis, yAxis, zAxis);\n  vec4 rotQuat = quatMultiply(viewQuat, q);\n  rotateVecFromQuat(pos, rotQuat);\n  return pos;\n}\nvoid rotateCorner (inout vec2 corner, float angle){\n  float xOS = cos(angle) * corner.x - sin(angle) * corner.y;\n  float yOS = sin(angle) * corner.x + cos(angle) * corner.y;\n  corner.x = xOS;\n  corner.y = yOS;\n}\nuniform vec4 mainTiling_Offset;\nuniform vec4 frameTile_velLenScale;\nuniform vec4 scale;\nuniform highp mat4 cc_matView;\nuniform highp mat4 cc_matViewInv;\nuniform highp mat4 cc_matViewProj;\nuniform highp vec4 cc_cameraPos;\nuniform highp mat4 cc_matWorld;\nvarying vec2 uv;\nvarying vec4 color;\nvoid computeVertPos (inout vec4 pos, vec2 vertOffset, vec4 q, vec3 s\n#if CC_RENDER_MODE == 0 || CC_RENDER_MODE == 3\n  , mat4 viewInv\n#endif\n#if CC_RENDER_MODE == 1\n  , vec3 eye\n  , vec4 velocity\n  , float velocityScale\n  , float lengthScale\n  , float xIndex\n#endif\n) {\n#if CC_RENDER_MODE == 0\n  vec3 viewSpaceVert = vec3(vertOffset.x * s.x, vertOffset.y * s.y, 0.);\n  vec3 camX = normalize(vec3(viewInv[0][0], viewInv[1][0], viewInv[2][0]));\n  vec3 camY = normalize(vec3(viewInv[0][1], viewInv[1][1], viewInv[2][1]));\n  vec3 camZ = normalize(vec3(viewInv[0][2], viewInv[1][2], viewInv[2][2]));\n  pos.xyz += rotateInLocalSpace(viewSpaceVert, camX, camY, camZ, q);\n#elif CC_RENDER_MODE == 1\n  vec3 camRight = normalize(cross(pos.xyz - eye, velocity.xyz)) * s.x;\n  vec3 camUp = velocity.xyz * velocityScale + normalize(velocity.xyz) * lengthScale * s.y;\n  pos.xyz += (camRight * abs(vertOffset.x) * sign(vertOffset.y)) - camUp * xIndex;\n#elif CC_RENDER_MODE == 2\n  vec3 viewSpaceVert = vec3(vertOffset.x * s.x, vertOffset.y * s.y, 0.);\n  vec3 camX = vec3(1, 0, 0);\n  vec3 camY = vec3(0, 0, -1);\n  pos.xyz += rotateInLocalSpace(viewSpaceVert, camX, camY, cross(camX, camY), q);\n#elif CC_RENDER_MODE == 3\n  vec2 viewSpaceVert = vec2(vertOffset.x * s.x, vertOffset.y * s.y);\n  rotateCorner(viewSpaceVert, q.z);\n  vec3 camX = normalize(vec3(cc_matView[0][0], cc_matView[1][0], cc_matView[2][0]));\n  vec3 camY = vec3(0, 1, 0);\n  vec3 offset = camX * viewSpaceVert.x + camY * viewSpaceVert.y;\n  pos.xyz += offset;\n#else\n  pos.x += vertOffset.x;\n  pos.y += vertOffset.y;\n#endif\n}\nvec2 computeUV (float frameIndex, vec2 vertIndex, vec2 frameTile){\n  vec2 aniUV = vec2(0, floor(frameIndex * frameTile.y));\n  aniUV.x = floor(frameIndex * frameTile.x * frameTile.y - aniUV.y * frameTile.x);\n#if CC_RENDER_MODE != 4\n  vertIndex.y = 1. - vertIndex.y;\n#endif\n  return (aniUV.xy + vertIndex) / vec2(frameTile.x, frameTile.y);\n}\nattribute vec3 a_position;\nattribute vec3 a_texCoord;\nattribute vec3 a_texCoord1;\nattribute vec3 a_texCoord2;\nattribute vec4 a_color;\n#if CC_RENDER_MODE == 1\n  attribute vec3 a_color1;\n#endif\n#if CC_RENDER_MODE == 4\n  attribute vec3 a_texCoord3;\n  attribute vec3 a_normal;\n  attribute vec4 a_color1;\n#endif\nvec4 lpvs_main () {\n  vec3 compScale = scale.xyz * a_texCoord1;\n  vec4 pos = vec4(a_position, 1);\n  #if CC_RENDER_MODE == 1\n    vec4 velocity = vec4(a_color1.xyz, 0);\n  #endif\n  #if !CC_USE_WORLD_SPACE\n    pos = cc_matWorld * pos;\n    #if CC_RENDER_MODE == 1\n      velocity = cc_matWorld * velocity;\n    #endif\n  #endif\n  #if CC_RENDER_MODE != 4\n    vec2 cornerOffset = vec2((a_texCoord.xy - 0.5));\n    #if CC_RENDER_MODE == 0\n      vec3 rotEuler = a_texCoord2;\n    #elif CC_RENDER_MODE == 1\n      vec3 rotEuler = vec3(0.);\n    #else\n      vec3 rotEuler = vec3(0., 0., a_texCoord2.z);\n    #endif\n    computeVertPos(pos, cornerOffset, quaternionFromEuler(rotEuler), compScale\n    #if CC_RENDER_MODE == 0 || CC_RENDER_MODE == 3\n      , cc_matViewInv\n    #endif\n    #if CC_RENDER_MODE == 1\n      , cc_cameraPos.xyz\n      , velocity\n      , frameTile_velLenScale.z\n      , frameTile_velLenScale.w\n      , a_texCoord.x\n    #endif\n    );\n    color = a_color;\n  #else\n    mat4 xformNoScale = matrixFromRT(quaternionFromEuler(a_texCoord2), pos.xyz);\n    mat4 xform = matFromRTS(quaternionFromEuler(a_texCoord2), pos.xyz, compScale);\n    pos = xform * vec4(a_texCoord3, 1);\n    vec4 normal = xformNoScale * vec4(a_normal, 0);\n    color = a_color * a_color1;\n  #endif\n  uv = computeUV(a_texCoord.z, a_texCoord.xy, frameTile_velLenScale.xy) * mainTiling_Offset.xy + mainTiling_Offset.zw;\n  pos = cc_matViewProj * pos;\n  return pos;\n}\nvoid main() { gl_Position = lpvs_main(); }",frag:"\nprecision mediump float;\nuniform mediump vec4 cc_exposure;\nvec3 SRGBToLinear (vec3 gamma) {\n  return gamma * gamma;\n}\nvec4 CCFragOutput (vec4 color) {\n  #if CC_USE_HDR\n    color.rgb = mix(color.rgb, SRGBToLinear(color.rgb) * cc_exposure.w, vec3(cc_exposure.z));\n  #endif\n  return color;\n}\nvarying vec2 uv;\nvarying vec4 color;\nuniform sampler2D mainTexture;\nuniform vec4 tintColor;\nvec4 add () {\n  vec4 col = 2.0 * color * tintColor * texture2D(mainTexture, uv);\n  return CCFragOutput(col);\n}\nvoid main() { gl_FragColor = add(); }"},builtins:{globals:{blocks:[{name:"CCGlobal",defines:[]}],samplers:[]},locals:{blocks:[{name:"CCLocal",defines:[]}],samplers:[]}},defines:[{name:"CC_RENDER_MODE",type:"number",range:[0,4]},{name:"CC_USE_WORLD_SPACE",type:"boolean"},{name:"CC_USE_HDR",type:"boolean"}],blocks:[{name:"Constants",defines:[],binding:0,members:[{name:"mainTiling_Offset",type:16,count:1},{name:"frameTile_velLenScale",type:16,count:1},{name:"scale",type:16,count:1}]},{name:"FragConstants",defines:[],binding:1,members:[{name:"tintColor",type:16,count:1}]}],samplers:[{name:"mainTexture",type:28,count:1,defines:[],binding:31}],attributes:[{name:"a_position",type:15,count:1,defines:[],format:32,location:0},{name:"a_texCoord",type:15,count:1,defines:[],format:32,location:1},{name:"a_texCoord1",type:15,count:1,defines:[],format:32,location:2},{name:"a_texCoord2",type:15,count:1,defines:[],format:32,location:3},{name:"a_color",type:16,count:1,defines:[],format:43,location:4},{name:"a_color1",type:15,count:1,defines:["CC_RENDER_MODE"],format:32,location:5},{name:"a_texCoord3",type:15,count:1,defines:["CC_RENDER_MODE"],format:32,location:6},{name:"a_normal",type:15,count:1,defines:["CC_RENDER_MODE"],format:32,location:7}]}]},{name:"builtin-sprite",_uuid:"60f7195c-ec2a-45eb-ba94-8955f60e81d0",techniques:[{passes:[{blendState:{targets:[{blend:!0,blendSrc:2,blendDst:4,blendDstAlpha:4}]},rasterizerState:{cullMode:0},program:"builtin-sprite|sprite-vs:vert|sprite-fs:frag",priority:244,depthStencilState:{depthTest:!1,depthWrite:!1},properties:{mainTexture:{value:"white",type:28}}}]}],shaders:[{name:"builtin-sprite|sprite-vs:vert|sprite-fs:frag",hash:447598955,glsl3:{vert:"\nprecision highp float;\nuniform CCGlobal {\n  highp   vec4 cc_time;\n  mediump vec4 cc_screenSize;\n  mediump vec4 cc_screenScale;\n  mediump vec4 cc_nativeSize;\n  highp   mat4 cc_matView;\n  highp   mat4 cc_matViewInv;\n  highp   mat4 cc_matProj;\n  highp   mat4 cc_matProjInv;\n  highp   mat4 cc_matViewProj;\n  highp   mat4 cc_matViewProjInv;\n  highp   vec4 cc_cameraPos;\n  mediump vec4 cc_exposure;\n  mediump vec4 cc_mainLitDir;\n  mediump vec4 cc_mainLitColor;\n  mediump vec4 cc_ambientSky;\n  mediump vec4 cc_ambientGround;\n};\n#if USE_LOCAL\nuniform CCLocal {\n  highp mat4 cc_matWorld;\n  highp mat4 cc_matWorldIT;\n  highp vec4 cc_lightingMapUVParam;\n};\n#endif\nin vec3 a_position;\nin vec4 a_color;\nout vec4 color;\nin vec2 a_texCoord;\nout vec2 uv0;\nvec4 vert () {\n  vec4 pos = vec4(a_position, 1);\n  #if USE_LOCAL\n    pos = cc_matViewProj * cc_matWorld * pos;\n  #else\n    pos = cc_matViewProj * pos;\n  #endif\n  uv0 = a_texCoord;\n  color = a_color;\n  return pos;\n}\nvoid main() { gl_Position = vert(); }",frag:"\nprecision highp float;\nin vec4 color;\n#if USE_TEXTURE\n  in vec2 uv0;\n  uniform sampler2D mainTexture;\n#endif\nvec4 frag () {\n  vec4 o = vec4(1, 1, 1, 1);\n  #if USE_TEXTURE\n    o *= texture(mainTexture, uv0);\n    #if IS_GRAY\n      float gray  = 0.2126 * o.r + 0.7152 * o.g + 0.0722 * o.b;\n      o.r = o.g = o.b = gray;\n    #endif\n  #endif\n  o *= color;\n  return o;\n}\nout vec4 cc_FragColor;\nvoid main() { cc_FragColor = frag(); }"},glsl1:{vert:"\nprecision highp float;\nuniform highp mat4 cc_matViewProj;\n#if USE_LOCAL\nuniform highp mat4 cc_matWorld;\n#endif\nattribute vec3 a_position;\nattribute vec4 a_color;\nvarying vec4 color;\nattribute vec2 a_texCoord;\nvarying vec2 uv0;\nvec4 vert () {\n  vec4 pos = vec4(a_position, 1);\n  #if USE_LOCAL\n    pos = cc_matViewProj * cc_matWorld * pos;\n  #else\n    pos = cc_matViewProj * pos;\n  #endif\n  uv0 = a_texCoord;\n  color = a_color;\n  return pos;\n}\nvoid main() { gl_Position = vert(); }",frag:"\nprecision highp float;\nvarying vec4 color;\n#if USE_TEXTURE\n  varying vec2 uv0;\n  uniform sampler2D mainTexture;\n#endif\nvec4 frag () {\n  vec4 o = vec4(1, 1, 1, 1);\n  #if USE_TEXTURE\n    o *= texture2D(mainTexture, uv0);\n    #if IS_GRAY\n      float gray  = 0.2126 * o.r + 0.7152 * o.g + 0.0722 * o.b;\n      o.r = o.g = o.b = gray;\n    #endif\n  #endif\n  o *= color;\n  return o;\n}\nvoid main() { gl_FragColor = frag(); }"},builtins:{globals:{blocks:[{name:"CCGlobal",defines:[]}],samplers:[]},locals:{blocks:[{name:"CCLocal",defines:["USE_LOCAL"]}],samplers:[]}},defines:[{name:"USE_LOCAL",type:"boolean"},{name:"USE_TEXTURE",type:"boolean"},{name:"IS_GRAY",type:"boolean"}],blocks:[],samplers:[{name:"mainTexture",type:28,count:1,defines:["USE_TEXTURE"],binding:31}],attributes:[{name:"a_position",type:15,count:1,defines:[],format:32,location:0},{name:"a_color",type:16,count:1,defines:[],format:43,location:1},{name:"a_texCoord",type:14,count:1,defines:[],format:21,location:2}]}]},{name:"builtin-standard",_uuid:"1baf0fc9-befa-459c-8bdd-af1a450a0319",techniques:[{name:"opaque",passes:[{program:"builtin-standard|standard-vs:vert|standard-fs:frag",properties:{tilingOffset:{value:[1,1,0,0],type:16},mainColor:{value:[1,1,1,1],type:16,handleInfo:["albedo",0,16]},albedoScale:{value:[1,1,1],type:15,handleInfo:["albedoScaleAndCutoff",0,15]},alphaThreshold:{value:[.5],type:13,handleInfo:["albedoScaleAndCutoff",3,13]},occlusion:{value:[1],type:13,handleInfo:["pbrParams",0,13]},roughness:{value:[.8],type:13,handleInfo:["pbrParams",1,13]},metallic:{value:[.6],type:13,handleInfo:["pbrParams",2,13]},normalStrenth:{value:[1],type:13,handleInfo:["pbrParams",3,13]},emissive:{value:[0,0,0,1],type:16},emissiveScale:{value:[1,1,1],type:15,handleInfo:["emissiveScaleParam",0,15]},mainTexture:{value:"grey",type:28,handleInfo:["albedoMap",0,28]},normalMap:{value:"normal",type:28},pbrMap:{value:"grey",type:28},metallicRoughnessMap:{value:"grey",type:28},occlusionMap:{value:"white",type:28},emissiveMap:{value:"grey",type:28},albedo:{type:16,value:[1,1,1,1]},albedoScaleAndCutoff:{type:16,value:[1,1,1,.5]},pbrParams:{type:16,value:[1,.8,.6,1]},emissiveScaleParam:{type:16,value:[1,1,1,0]},albedoMap:{type:28,value:"grey"}}}]}],shaders:[{name:"builtin-standard|standard-vs:vert|standard-fs:frag",hash:120153765,glsl3:{vert:"\nprecision highp float;\nstruct StandardVertInput {\n  highp vec4 position;\n  vec3 normal;\n  vec4 tangent;\n};\nin vec3 a_position;\nin vec3 a_normal;\nin vec4 a_tangent;\n#if CC_USE_MORPH\n    in float a_vertexId;\n    int getVertexId() {\n        return int(a_vertexId);\n    }\nuniform CCMorph {\n    vec4 cc_displacementWeights[15];\n    vec4 cc_displacementTextureInfo;\n};\n    vec4 fetchFlatPixel(sampler2D tex, int pixelIndex) {\n        float pixelIndexF = float(pixelIndex);\n        vec2 textureResolution = vec2(float(cc_displacementTextureInfo.x), float(cc_displacementTextureInfo.y));\n        float pixelX = mod(pixelIndexF, textureResolution.x);\n        float pixelY = floor(pixelIndexF / textureResolution.x);\n        vec2 uv = (vec2(pixelX, pixelY) + .5) / textureResolution;\n        return texture(tex, uv);\n    }\nfloat getDisplacementWeight(int index) {\n    float m = mod(float(index), 4.0);\n    if (m < 1.0) {\n        return cc_displacementWeights[index / 4].x;\n    } else if (m < 2.0) {\n        return cc_displacementWeights[index / 4].y;\n    } else if (m < 3.0) {\n        return cc_displacementWeights[index / 4].z;\n    } else {\n        return cc_displacementWeights[index / 4].w;\n    }\n}\nvec3 getVec3DisplacementFromTexture(sampler2D tex, int vertexIndex) {\n#if CC_MORPH_PRECOMPUTED\n    return fetchFlatPixel(tex, vertexIndex).rgb;\n#else\n    vec3 result = vec3(0, 0, 0);\n    for (int iTarget = 0; iTarget < CC_MORPH_TARGET_COUNT; ++iTarget) {\n        int dataPixelStart = int(fetchFlatPixel(tex, iTarget).r);\n        result += (fetchFlatPixel(tex, dataPixelStart + vertexIndex).rgb * getDisplacementWeight(iTarget));\n    }\n    return result;\n#endif\n}\n#if CC_MORPH_TARGET_HAS_POSITION\n    uniform sampler2D cc_PositionDisplacements;\n    vec3 getPositionDisplacement(int vertexId) {\n        return getVec3DisplacementFromTexture(cc_PositionDisplacements, vertexId);\n    }\n#endif\n#if CC_MORPH_TARGET_HAS_NORMAL\n    uniform sampler2D cc_NormalDisplacements;\n    vec3 getNormalDisplacement(int vertexId) {\n        return getVec3DisplacementFromTexture(cc_NormalDisplacements, vertexId);\n    }\n#endif\n#if CC_MORPH_TARGET_HAS_TANGENT\n    uniform sampler2D cc_TangentDisplacements;\n    vec3 getTangentDisplacement(int vertexId) {\n        return getVec3DisplacementFromTexture(cc_TangentDisplacements, vertexId);\n    }\n#endif\nvoid applyMorph (inout StandardVertInput attr) {\n    int vertexId = getVertexId();\n#if CC_MORPH_TARGET_HAS_POSITION\n    attr.position.xyz = attr.position.xyz + getPositionDisplacement(vertexId);\n#endif\n#if CC_MORPH_TARGET_HAS_NORMAL\n    attr.normal.xyz = attr.normal.xyz + getNormalDisplacement(vertexId);\n#endif\n#if CC_MORPH_TARGET_HAS_TANGENT\n    attr.tangent.xyz = attr.tangent.xyz + getTangentDisplacement(vertexId);\n#endif\n}\nvoid applyMorph (inout vec4 position) {\n#if CC_MORPH_TARGET_HAS_POSITION\n    position.xyz = position.xyz + getPositionDisplacement(getVertexId());\n#endif\n}\n#endif\n#if CC_USE_SKINNING\nin vec4 a_weights;\nin vec4 a_joints;\nhighp float decode32 (highp vec4 rgba) {\n  rgba = rgba * 255.0;\n  highp float Sign = 1.0 - step(127.99, rgba[3]) * 2.0;\n  highp float Exponent = 2.0 * mod(rgba[3], 127.99) + step(128.0, rgba[2]) - 127.0;\n  highp float Mantissa = mod(rgba[2], 128.0) * 65536.0 + rgba[1] * 256.0 + rgba[0] + 8388608.0;\n  return Sign * exp2(Exponent - 23.0) * Mantissa;\n}\n#if CC_USE_BAKED_ANIMATION\n  #if USE_INSTANCING\n    in highp vec4 a_jointAnimInfo;\n  #endif\n  uniform CCSkinningTexture {\n    highp vec4 cc_jointTextureInfo;\n  };\n  uniform CCSkinningAnimation {\n    highp vec4 cc_jointAnimInfo;\n  };\n  uniform sampler2D cc_jointTexture;\n  #else\n  uniform CCSkinning {\n    highp vec4 cc_joints[30 * 3];\n  };\n#endif\n#if CC_USE_BAKED_ANIMATION\n  #if CC_SUPPORT_FLOAT_TEXTURE\n    mat4 getJointMatrix (float i) {\n    #if USE_INSTANCING\n      highp float j = 3.0 * (a_jointAnimInfo.x * a_jointAnimInfo.y + i) + a_jointAnimInfo.z;\n    #else\n      highp float j = 3.0 * (cc_jointAnimInfo.x * cc_jointTextureInfo.y + i) + cc_jointTextureInfo.z;\n    #endif\n    highp float invSize = cc_jointTextureInfo.w;\n    highp float y = floor(j * invSize);\n    highp float x = j - y * cc_jointTextureInfo.x;\n    y = (y + 0.5) * invSize;\n      vec4 v1 = texture(cc_jointTexture, vec2((x + 0.5) * invSize, y));\n      vec4 v2 = texture(cc_jointTexture, vec2((x + 1.5) * invSize, y));\n      vec4 v3 = texture(cc_jointTexture, vec2((x + 2.5) * invSize, y));\n      return mat4(vec4(v1.xyz, 0.0), vec4(v2.xyz, 0.0), vec4(v3.xyz, 0.0), vec4(v1.w, v2.w, v3.w, 1.0));\n    }\n  #else\n    mat4 getJointMatrix (float i) {\n    #if USE_INSTANCING\n      highp float j = 12.0 * (a_jointAnimInfo.x * a_jointAnimInfo.y + i) + a_jointAnimInfo.z;\n    #else\n      highp float j = 12.0 * (cc_jointAnimInfo.x * cc_jointTextureInfo.y + i) + cc_jointTextureInfo.z;\n    #endif\n    highp float invSize = cc_jointTextureInfo.w;\n    highp float y = floor(j * invSize);\n    highp float x = j - y * cc_jointTextureInfo.x;\n    y = (y + 0.5) * invSize;\n      vec4 v1 = vec4(\n        decode32(texture(cc_jointTexture, vec2((x + 0.5) * invSize, y))),\n        decode32(texture(cc_jointTexture, vec2((x + 1.5) * invSize, y))),\n        decode32(texture(cc_jointTexture, vec2((x + 2.5) * invSize, y))),\n        decode32(texture(cc_jointTexture, vec2((x + 3.5) * invSize, y)))\n      );\n      vec4 v2 = vec4(\n        decode32(texture(cc_jointTexture, vec2((x + 4.5) * invSize, y))),\n        decode32(texture(cc_jointTexture, vec2((x + 5.5) * invSize, y))),\n        decode32(texture(cc_jointTexture, vec2((x + 6.5) * invSize, y))),\n        decode32(texture(cc_jointTexture, vec2((x + 7.5) * invSize, y)))\n      );\n      vec4 v3 = vec4(\n        decode32(texture(cc_jointTexture, vec2((x + 8.5) * invSize, y))),\n        decode32(texture(cc_jointTexture, vec2((x + 9.5) * invSize, y))),\n        decode32(texture(cc_jointTexture, vec2((x + 10.5) * invSize, y))),\n        decode32(texture(cc_jointTexture, vec2((x + 11.5) * invSize, y)))\n      );\n      return mat4(vec4(v1.xyz, 0.0), vec4(v2.xyz, 0.0), vec4(v3.xyz, 0.0), vec4(v1.w, v2.w, v3.w, 1.0));\n    }\n  #endif\n#else\n  mat4 getJointMatrix (float i) {\n    int idx = int(i);\n    vec4 v1 = cc_joints[idx * 3];\n    vec4 v2 = cc_joints[idx * 3 + 1];\n    vec4 v3 = cc_joints[idx * 3 + 2];\n    return mat4(vec4(v1.xyz, 0.0), vec4(v2.xyz, 0.0), vec4(v3.xyz, 0.0), vec4(v1.w, v2.w, v3.w, 1.0));\n  }\n#endif\nmat4 skinMatrix () {\n  return getJointMatrix(a_joints.x) * a_weights.x\n       + getJointMatrix(a_joints.y) * a_weights.y\n       + getJointMatrix(a_joints.z) * a_weights.z\n       + getJointMatrix(a_joints.w) * a_weights.w;\n}\nvoid CCSkin (inout vec4 position) {\n  mat4 m = skinMatrix();\n  position = m * position;\n}\nvoid CCSkin (inout StandardVertInput attr) {\n  mat4 m = skinMatrix();\n  attr.position = m * attr.position;\n  attr.normal = (m * vec4(attr.normal, 0.0)).xyz;\n  attr.tangent.xyz = (m * vec4(attr.tangent.xyz, 0.0)).xyz;\n}\n#endif\nuniform CCGlobal {\n  highp   vec4 cc_time;\n  mediump vec4 cc_screenSize;\n  mediump vec4 cc_screenScale;\n  mediump vec4 cc_nativeSize;\n  highp   mat4 cc_matView;\n  highp   mat4 cc_matViewInv;\n  highp   mat4 cc_matProj;\n  highp   mat4 cc_matProjInv;\n  highp   mat4 cc_matViewProj;\n  highp   mat4 cc_matViewProjInv;\n  highp   vec4 cc_cameraPos;\n  mediump vec4 cc_exposure;\n  mediump vec4 cc_mainLitDir;\n  mediump vec4 cc_mainLitColor;\n  mediump vec4 cc_ambientSky;\n  mediump vec4 cc_ambientGround;\n};\n#if USE_INSTANCING\n  in vec4 a_matWorld0;\n  in vec4 a_matWorld1;\n  in vec4 a_matWorld2;\n#elif USE_BATCHING\n  in float a_dyn_batch_id;\n  uniform CCLocalBatched {\n    highp mat4 cc_matWorlds[10];\n  };\n#else\nuniform CCLocal {\n  highp mat4 cc_matWorld;\n  highp mat4 cc_matWorldIT;\n  highp vec4 cc_lightingMapUVParam;\n};\n#endif\nuniform Constants {\n  vec4 tilingOffset;\n  vec4 albedo;\n  vec4 albedoScaleAndCutoff;\n  vec4 pbrParams;\n  vec4 emissive;\n  vec4 emissiveScaleParam;\n};\n#if USE_VERTEX_COLOR\n  in vec3 a_color;\n  out vec3 v_color;\n#endif\nout vec3 v_position;\nout vec3 v_normal;\n#if USE_NORMAL_MAP\n  out vec3 v_tangent;\n  out vec3 v_bitangent;\n#endif\nin vec2 a_texCoord;\nout vec2 v_uv;\nin vec2 a_texCoord1;\nout vec2 v_uv1;\n#if USE_LIGHTMAP && !USE_BATCHING && !USE_INSTANCING\n  out vec2 v_luv;\n#endif\nvec4 vert () {\n  StandardVertInput In;\n  In.position = vec4(a_position, 1.0);\n  In.normal = a_normal;\n  In.tangent = a_tangent;\n  #if CC_USE_MORPH\n    applyMorph(In);\n  #endif\n  #if CC_USE_SKINNING\n    CCSkin(In);\n  #endif\n  mat4 matWorld, matWorldIT;\n  #if USE_INSTANCING\n    matWorld = mat4(\n      vec4(a_matWorld0.xyz, 0.0),\n      vec4(a_matWorld1.xyz, 0.0),\n      vec4(a_matWorld2.xyz, 0.0),\n      vec4(a_matWorld0.w, a_matWorld1.w, a_matWorld2.w, 1.0)\n    );\n    matWorldIT = matWorld;\n  #elif USE_BATCHING\n    matWorld = cc_matWorlds[int(a_dyn_batch_id)];\n    matWorldIT = matWorld;\n  #else\n    matWorld = cc_matWorld;\n    matWorldIT = cc_matWorldIT;\n  #endif\n  vec4 pos = matWorld * In.position;\n  v_position = pos.xyz;\n  v_normal = normalize((matWorldIT * vec4(In.normal, 0.0)).xyz);\n  #if USE_NORMAL_MAP\n    v_tangent = normalize((matWorld * vec4(In.tangent.xyz, 0.0)).xyz);\n    v_bitangent = cross(v_normal, v_tangent) * In.tangent.w;\n  #endif\n  v_uv = a_texCoord * tilingOffset.xy + tilingOffset.zw;\n  #if HAS_SECOND_UV\n    v_uv1 = a_texCoord1 * tilingOffset.xy + tilingOffset.zw;\n  #endif\n  #if USE_VERTEX_COLOR\n    v_color = a_color;\n  #endif\n  #if USE_LIGHTMAP && HAS_SECOND_UV && !USE_BATCHING && !USE_INSTANCING\n    v_luv = cc_lightingMapUVParam.xy + a_texCoord1 * cc_lightingMapUVParam.zw;\n  #endif\n  return cc_matProj * (cc_matView * matWorld) * In.position;\n}\nvoid main() { gl_Position = vert(); }",frag:"\nprecision highp float;\nuniform CCGlobal {\n  highp   vec4 cc_time;\n  mediump vec4 cc_screenSize;\n  mediump vec4 cc_screenScale;\n  mediump vec4 cc_nativeSize;\n  highp   mat4 cc_matView;\n  highp   mat4 cc_matViewInv;\n  highp   mat4 cc_matProj;\n  highp   mat4 cc_matProjInv;\n  highp   mat4 cc_matViewProj;\n  highp   mat4 cc_matViewProjInv;\n  highp   vec4 cc_cameraPos;\n  mediump vec4 cc_exposure;\n  mediump vec4 cc_mainLitDir;\n  mediump vec4 cc_mainLitColor;\n  mediump vec4 cc_ambientSky;\n  mediump vec4 cc_ambientGround;\n};\n#if CC_USE_IBL\nuniform samplerCube cc_environment;\nvec3 unpackRGBE (vec4 rgbe) {\n  return rgbe.rgb * pow(2.0, rgbe.a * 255.0 - 128.0);\n}\nvec4 fragTextureLod (sampler2D tex, vec2 coord, float lod) {\n    return textureLod(tex, coord, lod);\n}\nvec4 fragTextureLod (samplerCube tex, vec3 coord, float lod) {\n    return textureLod(tex, coord, lod);\n}\n#endif\nvec3 SRGBToLinear (vec3 gamma) {\n  return gamma * gamma;\n}\nuniform CCForwardLight {\n  highp vec4 cc_sphereLitPos[2];\n  vec4 cc_sphereLitSizeRange[2];\n  vec4 cc_sphereLitColor[2];\n  highp vec4 cc_spotLitPos[2];\n  vec4 cc_spotLitSizeRangeAngle[2];\n  vec4 cc_spotLitDir[2];\n  vec4 cc_spotLitColor[2];\n};\nfloat SmoothDistAtt (float distSqr, float invSqrAttRadius) {\n  float factor = distSqr * invSqrAttRadius;\n  float smoothFactor = clamp(1.0 - factor * factor, 0.0, 1.0);\n  return smoothFactor * smoothFactor;\n}\nfloat GetDistAtt (float distSqr, float invSqrAttRadius) {\n  float attenuation = 1.0 / max(distSqr, 0.01*0.01);\n  attenuation *= SmoothDistAtt(distSqr , invSqrAttRadius);\n  return attenuation;\n}\nfloat GetAngleAtt (vec3 L, vec3 litDir, float litAngleScale, float litAngleOffset) {\n  float cd = dot(litDir, L);\n  float attenuation = clamp(cd * litAngleScale + litAngleOffset, 0.0, 1.0);\n  return (attenuation * attenuation);\n}\nfloat GGXMobile (float roughness, float NoH, vec3 H, vec3 N) {\n  vec3 NxH = cross(N, H);\n  float OneMinusNoHSqr = dot(NxH, NxH);\n  float a = roughness * roughness;\n  float n = NoH * a;\n  float p = a / (OneMinusNoHSqr + n * n);\n  return p * p;\n}\nfloat CalcSpecular (float roughness, float NoH, vec3 H, vec3 N) {\n  return (roughness*0.25 + 0.25) * GGXMobile(roughness, NoH, H, N);\n}\nvec3 BRDFApprox (vec3 specular, float roughness, float NoV) {\n  const vec4 c0 = vec4(-1.0, -0.0275, -0.572, 0.022);\n  const vec4 c1 = vec4(1.0, 0.0425, 1.04, -0.04);\n  vec4 r = roughness * c0 + c1;\n  float a004 = min( r.x * r.x, exp2( -9.28 * NoV ) ) * r.x + r.y;\n  vec2 AB = vec2( -1.04, 1.04 ) * a004 + r.zw;\n  AB.y *= clamp(50.0 * specular.g, 0.0, 1.0);\n  return specular * AB.x + AB.y;\n}\nvec3 CalcDynamicLighting (vec3 worldPos, vec3 N, vec3 V, vec3 diffuse, vec3 specular, float roughness) {\n  vec3 lighting = vec3(0.0);\n  vec3 diffuseContrib = diffuse / 3.14159265359;\n  for (int i = 0; i < 2; i++) {\n    vec3 PLU = cc_sphereLitPos[i].xyz - worldPos;\n    vec3 PL = normalize(PLU);\n    vec3 PH = normalize(PL + V);\n    float PNL = max(dot(N, PL), 0.001);\n    float PNH = max(dot(N, PH), 0.0);\n    float distSqr = dot(PLU, PLU);\n    float litRadius = cc_sphereLitSizeRange[i].x;\n    float litRadiusSqr = litRadius * litRadius;\n    float illum = 3.14159265359 * (litRadiusSqr / max(litRadiusSqr , distSqr));\n    float attRadiusSqrInv = 1.0 / max(cc_sphereLitSizeRange[i].y, 0.01);\n    attRadiusSqrInv *= attRadiusSqrInv;\n    float att = GetDistAtt(distSqr, attRadiusSqrInv);\n    vec3 lspec = specular * CalcSpecular(roughness, PNH, PH, N);\n    lighting += PNL * cc_sphereLitColor[i].rgb * cc_sphereLitColor[i].w * illum * att * (diffuseContrib + lspec);\n  }\n  for (int i = 0; i < 2; i++) {\n    vec3 SLU = cc_spotLitPos[i].xyz - worldPos;\n    vec3 SL = normalize(SLU);\n    vec3 SH = normalize(SL + V);\n    float SNL = max(dot(N, SL), 0.001);\n    float SNH = max(dot(N, SH), 0.0);\n    float distSqr = dot(SLU, SLU);\n    float litRadius = cc_spotLitSizeRangeAngle[i].x;\n    float litRadiusSqr = litRadius * litRadius;\n    float illum = 3.14159265359 * (litRadiusSqr / max(litRadiusSqr , distSqr));\n    float attRadiusSqrInv = 1.0 / max(cc_spotLitSizeRangeAngle[i].y, 0.01);\n    attRadiusSqrInv *= attRadiusSqrInv;\n    float cosInner = max(dot(-cc_spotLitDir[i].xyz, SL), 0.01);\n    float cosOuter = cc_spotLitSizeRangeAngle[i].z;\n    float litAngleScale = 1.0 / max(0.001, cosInner - cosOuter);\n    float litAngleOffset = -cosOuter * litAngleScale;\n    float att = GetDistAtt(distSqr, attRadiusSqrInv);\n    att *= GetAngleAtt(SL, -cc_spotLitDir[i].xyz, litAngleScale, litAngleOffset);\n    vec3 lspec = specular * CalcSpecular(roughness, SNH, SH, N);\n    lighting += SNL * cc_spotLitColor[i].rgb * cc_spotLitColor[i].w * illum * att * (diffuseContrib + lspec);\n  }\n  return lighting;\n}\nstruct StandardSurface {\n  vec4 albedo;\n  vec3 position;\n  vec3 normal;\n  vec3 emissive;\n  float roughness;\n  float metallic;\n  float occlusion;\n};\nvec4 CCStandardShading (StandardSurface s) {\n  vec3 diffuse = s.albedo.rgb * (1.0 - s.metallic);\n  vec3 specular = mix(vec3(0.04), s.albedo.rgb, s.metallic);\n  vec3 N = normalize(s.normal);\n  vec3 V = normalize(cc_cameraPos.xyz - s.position);\n  vec3 L = normalize(-cc_mainLitDir.xyz);\n  vec3 H = normalize(L+V);\n  float NV = max(abs(dot(N, V)), 0.001);\n  float NL = max(dot(N, L), 0.001);\n  float NH = max(dot(N, H), 0.0);\n  specular = BRDFApprox(specular, s.roughness, NV);\n  vec3 diffuseContrib = diffuse / 3.14159265359;\n  vec3 specularContrib = specular * CalcSpecular(s.roughness, NH, H, N);\n  vec3 finalColor = NL * cc_mainLitColor.rgb * cc_mainLitColor.w * (diffuseContrib + specularContrib);\n  finalColor += CalcDynamicLighting(s.position, N, V, diffuse, specular, s.roughness);\n  float fAmb = 0.5 - N.y * 0.5;\n  vec3 ambDiff = mix(cc_ambientSky.rgb, cc_ambientGround.rgb, fAmb) * cc_ambientSky.w;\n  finalColor += (ambDiff.rgb * diffuse);\n  #if CC_USE_IBL\n    vec3 R = normalize(reflect(-V, N));\n    vec4 envmap = fragTextureLod(cc_environment, R, s.roughness * cc_ambientGround.w);\n    #if CC_USE_IBL == 2\n      vec3 env = unpackRGBE(envmap);\n    #else\n      vec3 env = SRGBToLinear(envmap.rgb);\n    #endif\n    finalColor += env * cc_ambientSky.w * specular;\n  #endif\n  finalColor = finalColor * s.occlusion;\n  #if CC_USE_HDR\n    s.emissive *= cc_exposure.w;\n  #endif\n  finalColor += s.emissive;\n  return vec4(finalColor, s.albedo.a);\n}\nvec3 ACESToneMap (vec3 color) {\n  color = min(color, vec3(8.0));\n  const float A = 2.51;\n  const float B = 0.03;\n  const float C = 2.43;\n  const float D = 0.59;\n  const float E = 0.14;\n  return (color * (A * color + B)) / (color * (C * color + D) + E);\n}\nvec4 CCFragOutput (vec4 color) {\n  #if !CC_USE_HDR\n    color.rgb = sqrt(ACESToneMap(color.rgb));\n  #endif\n  return color;\n}\nuniform Constants {\n  vec4 tilingOffset;\n  vec4 albedo;\n  vec4 albedoScaleAndCutoff;\n  vec4 pbrParams;\n  vec4 emissive;\n  vec4 emissiveScaleParam;\n};\nin vec3 v_position;\nin vec2 v_uv;\nin vec2 v_uv1;\nin vec3 v_normal;\n#if USE_VERTEX_COLOR\n  in vec3 v_color;\n#endif\n#if USE_ALBEDO_MAP\n  uniform sampler2D albedoMap;\n#endif\n#if USE_NORMAL_MAP\n  in vec3 v_tangent;\n  in vec3 v_bitangent;\n  uniform sampler2D normalMap;\n#endif\n#if USE_PBR_MAP\n  uniform sampler2D pbrMap;\n#endif\n#if USE_METALLIC_ROUGHNESS_MAP\n  uniform sampler2D metallicRoughnessMap;\n#endif\n#if USE_OCCLUSION_MAP\n  uniform sampler2D occlusionMap;\n#endif\n#if USE_EMISSIVE_MAP\n  uniform sampler2D emissiveMap;\n#endif\n#if USE_LIGHTMAP\n  in vec2 v_luv;\n  uniform sampler2D cc_lightingMap;\n#endif\n#if USE_ALPHA_TEST\n#endif\nvoid surf (out StandardSurface s) {\n  vec4 baseColor = albedo;\n  #if USE_VERTEX_COLOR\n    baseColor.rgb *= v_color;\n  #endif\n  #if USE_ALBEDO_MAP\n    vec4 texColor = texture(albedoMap, ALBEDO_UV);\n    texColor.rgb = SRGBToLinear(texColor.rgb);\n    baseColor *= texColor;\n  #endif\n  s.albedo = baseColor;\n  s.albedo.rgb *= albedoScaleAndCutoff.xyz;\n  #if USE_ALPHA_TEST\n    if (s.albedo.ALPHA_TEST_CHANNEL < albedoScaleAndCutoff.w) discard;\n  #endif\n  s.normal = v_normal;\n  #if USE_NORMAL_MAP\n    vec3 nmmp = texture(normalMap, NORMAL_UV).xyz - vec3(0.5);\n    s.normal =\n      (nmmp.x * pbrParams.w) * normalize(v_tangent) +\n      (nmmp.y * pbrParams.w) * normalize(v_bitangent) +\n      nmmp.z * normalize(s.normal);\n  #endif\n  s.position = v_position;\n  vec4 pbr = pbrParams;\n  #if USE_PBR_MAP\n    vec4 res = texture(pbrMap, PBR_UV);\n    pbr.x *= res.OCCLUSION_CHANNEL;\n    pbr.y *= res.ROUGHNESS_CHANNEL;\n    pbr.z *= res.METALLIC_CHANNEL;\n  #endif\n  #if USE_METALLIC_ROUGHNESS_MAP\n    vec4 metallicRoughness = texture(metallicRoughnessMap, METALLIC_ROUGHNESS_UV);\n    pbr.z *= metallicRoughness.METALLIC_CHANNEL;\n    pbr.y *= metallicRoughness.ROUGHNESS_CHANNEL;\n  #endif\n  #if USE_OCCLUSION_MAP\n    pbr.x *= texture(occlusionMap, OCCLUSION_UV).OCCLUSION_CHANNEL;\n  #endif\n  s.occlusion = clamp(pbr.x, 0.0, 0.96);\n  s.roughness = clamp(pbr.y, 0.04, 1.0);\n  s.metallic = pbr.z;\n  s.emissive = emissive.rgb * emissiveScaleParam.xyz;\n  #if USE_EMISSIVE_MAP\n    s.emissive *= SRGBToLinear(texture(emissiveMap, EMISSIVE_UV).rgb);\n  #endif\n}\nvec4 frag () {\n  StandardSurface s; surf(s);\n  vec4 color = CCStandardShading(s);\n  #if USE_LIGHTMAP && !USE_BATCHING && !USE_INSTANCING\n    vec4 lighting = texture(cc_lightingMap, v_luv);\n    float fAmb = 0.5 - s.normal.y * 0.5;\n    vec3 ambDiff = mix(cc_ambientSky.rgb, cc_ambientGround.rgb, fAmb) * cc_ambientSky.w;\n    vec3 finalColor = (ambDiff.rgb * s.albedo.rgb);\n    finalColor += lighting.rgb *  s.albedo.rgb;\n    finalColor = finalColor * s.occlusion;\n    finalColor += s.emissive;\n    color.rgb = lighting.a * finalColor + (1.0 - lighting.a) * color.rgb;\n  #endif\n  return CCFragOutput(color);\n}\nout vec4 cc_FragColor;\nvoid main() { cc_FragColor = frag(); }"},glsl1:{vert:"\nprecision highp float;\nstruct StandardVertInput {\n  highp vec4 position;\n  vec3 normal;\n  vec4 tangent;\n};\nattribute vec3 a_position;\nattribute vec3 a_normal;\nattribute vec4 a_tangent;\n#if CC_USE_MORPH\n    attribute float a_vertexId;\n    int getVertexId() {\n        return int(a_vertexId);\n    }\nuniform vec4 cc_displacementWeights[15];\nuniform vec4 cc_displacementTextureInfo;\n    vec4 fetchFlatPixel(sampler2D tex, int pixelIndex) {\n        float pixelIndexF = float(pixelIndex);\n        vec2 textureResolution = vec2(float(cc_displacementTextureInfo.x), float(cc_displacementTextureInfo.y));\n        float pixelX = mod(pixelIndexF, textureResolution.x);\n        float pixelY = floor(pixelIndexF / textureResolution.x);\n        vec2 uv = (vec2(pixelX, pixelY) + .5) / textureResolution;\n        return texture2D(tex, uv);\n    }\nfloat getDisplacementWeight(int index) {\n    float m = mod(float(index), 4.0);\n    if (m < 1.0) {\n        return cc_displacementWeights[index / 4].x;\n    } else if (m < 2.0) {\n        return cc_displacementWeights[index / 4].y;\n    } else if (m < 3.0) {\n        return cc_displacementWeights[index / 4].z;\n    } else {\n        return cc_displacementWeights[index / 4].w;\n    }\n}\nvec3 getVec3DisplacementFromTexture(sampler2D tex, int vertexIndex) {\n#if CC_MORPH_PRECOMPUTED\n    return fetchFlatPixel(tex, vertexIndex).rgb;\n#else\n    vec3 result = vec3(0, 0, 0);\n    for (int iTarget = 0; iTarget < CC_MORPH_TARGET_COUNT; ++iTarget) {\n        int dataPixelStart = int(fetchFlatPixel(tex, iTarget).r);\n        result += (fetchFlatPixel(tex, dataPixelStart + vertexIndex).rgb * getDisplacementWeight(iTarget));\n    }\n    return result;\n#endif\n}\n#if CC_MORPH_TARGET_HAS_POSITION\n    uniform sampler2D cc_PositionDisplacements;\n    vec3 getPositionDisplacement(int vertexId) {\n        return getVec3DisplacementFromTexture(cc_PositionDisplacements, vertexId);\n    }\n#endif\n#if CC_MORPH_TARGET_HAS_NORMAL\n    uniform sampler2D cc_NormalDisplacements;\n    vec3 getNormalDisplacement(int vertexId) {\n        return getVec3DisplacementFromTexture(cc_NormalDisplacements, vertexId);\n    }\n#endif\n#if CC_MORPH_TARGET_HAS_TANGENT\n    uniform sampler2D cc_TangentDisplacements;\n    vec3 getTangentDisplacement(int vertexId) {\n        return getVec3DisplacementFromTexture(cc_TangentDisplacements, vertexId);\n    }\n#endif\nvoid applyMorph (inout StandardVertInput attr) {\n    int vertexId = getVertexId();\n#if CC_MORPH_TARGET_HAS_POSITION\n    attr.position.xyz = attr.position.xyz + getPositionDisplacement(vertexId);\n#endif\n#if CC_MORPH_TARGET_HAS_NORMAL\n    attr.normal.xyz = attr.normal.xyz + getNormalDisplacement(vertexId);\n#endif\n#if CC_MORPH_TARGET_HAS_TANGENT\n    attr.tangent.xyz = attr.tangent.xyz + getTangentDisplacement(vertexId);\n#endif\n}\nvoid applyMorph (inout vec4 position) {\n#if CC_MORPH_TARGET_HAS_POSITION\n    position.xyz = position.xyz + getPositionDisplacement(getVertexId());\n#endif\n}\n#endif\n#if CC_USE_SKINNING\nattribute vec4 a_weights;\nattribute vec4 a_joints;\nhighp float decode32 (highp vec4 rgba) {\n  rgba = rgba * 255.0;\n  highp float Sign = 1.0 - step(127.99, rgba[3]) * 2.0;\n  highp float Exponent = 2.0 * mod(rgba[3], 127.99) + step(128.0, rgba[2]) - 127.0;\n  highp float Mantissa = mod(rgba[2], 128.0) * 65536.0 + rgba[1] * 256.0 + rgba[0] + 8388608.0;\n  return Sign * exp2(Exponent - 23.0) * Mantissa;\n}\n#if CC_USE_BAKED_ANIMATION\n  #if USE_INSTANCING\n    attribute highp vec4 a_jointAnimInfo;\n  #endif\n  uniform highp vec4 cc_jointTextureInfo;\n  uniform highp vec4 cc_jointAnimInfo;\n  uniform sampler2D cc_jointTexture;\n  #else\n  uniform highp vec4 cc_joints[90];\n#endif\n#if CC_USE_BAKED_ANIMATION\n  #if CC_SUPPORT_FLOAT_TEXTURE\n    mat4 getJointMatrix (float i) {\n    #if USE_INSTANCING\n      highp float j = 3.0 * (a_jointAnimInfo.x * a_jointAnimInfo.y + i) + a_jointAnimInfo.z;\n    #else\n      highp float j = 3.0 * (cc_jointAnimInfo.x * cc_jointTextureInfo.y + i) + cc_jointTextureInfo.z;\n    #endif\n    highp float invSize = cc_jointTextureInfo.w;\n    highp float y = floor(j * invSize);\n    highp float x = j - y * cc_jointTextureInfo.x;\n    y = (y + 0.5) * invSize;\n      vec4 v1 = texture2D(cc_jointTexture, vec2((x + 0.5) * invSize, y));\n      vec4 v2 = texture2D(cc_jointTexture, vec2((x + 1.5) * invSize, y));\n      vec4 v3 = texture2D(cc_jointTexture, vec2((x + 2.5) * invSize, y));\n      return mat4(vec4(v1.xyz, 0.0), vec4(v2.xyz, 0.0), vec4(v3.xyz, 0.0), vec4(v1.w, v2.w, v3.w, 1.0));\n    }\n  #else\n    mat4 getJointMatrix (float i) {\n    #if USE_INSTANCING\n      highp float j = 12.0 * (a_jointAnimInfo.x * a_jointAnimInfo.y + i) + a_jointAnimInfo.z;\n    #else\n      highp float j = 12.0 * (cc_jointAnimInfo.x * cc_jointTextureInfo.y + i) + cc_jointTextureInfo.z;\n    #endif\n    highp float invSize = cc_jointTextureInfo.w;\n    highp float y = floor(j * invSize);\n    highp float x = j - y * cc_jointTextureInfo.x;\n    y = (y + 0.5) * invSize;\n      vec4 v1 = vec4(\n        decode32(texture2D(cc_jointTexture, vec2((x + 0.5) * invSize, y))),\n        decode32(texture2D(cc_jointTexture, vec2((x + 1.5) * invSize, y))),\n        decode32(texture2D(cc_jointTexture, vec2((x + 2.5) * invSize, y))),\n        decode32(texture2D(cc_jointTexture, vec2((x + 3.5) * invSize, y)))\n      );\n      vec4 v2 = vec4(\n        decode32(texture2D(cc_jointTexture, vec2((x + 4.5) * invSize, y))),\n        decode32(texture2D(cc_jointTexture, vec2((x + 5.5) * invSize, y))),\n        decode32(texture2D(cc_jointTexture, vec2((x + 6.5) * invSize, y))),\n        decode32(texture2D(cc_jointTexture, vec2((x + 7.5) * invSize, y)))\n      );\n      vec4 v3 = vec4(\n        decode32(texture2D(cc_jointTexture, vec2((x + 8.5) * invSize, y))),\n        decode32(texture2D(cc_jointTexture, vec2((x + 9.5) * invSize, y))),\n        decode32(texture2D(cc_jointTexture, vec2((x + 10.5) * invSize, y))),\n        decode32(texture2D(cc_jointTexture, vec2((x + 11.5) * invSize, y)))\n      );\n      return mat4(vec4(v1.xyz, 0.0), vec4(v2.xyz, 0.0), vec4(v3.xyz, 0.0), vec4(v1.w, v2.w, v3.w, 1.0));\n    }\n  #endif\n#else\n  mat4 getJointMatrix (float i) {\n    int idx = int(i);\n    vec4 v1 = cc_joints[idx * 3];\n    vec4 v2 = cc_joints[idx * 3 + 1];\n    vec4 v3 = cc_joints[idx * 3 + 2];\n    return mat4(vec4(v1.xyz, 0.0), vec4(v2.xyz, 0.0), vec4(v3.xyz, 0.0), vec4(v1.w, v2.w, v3.w, 1.0));\n  }\n#endif\nmat4 skinMatrix () {\n  return getJointMatrix(a_joints.x) * a_weights.x\n       + getJointMatrix(a_joints.y) * a_weights.y\n       + getJointMatrix(a_joints.z) * a_weights.z\n       + getJointMatrix(a_joints.w) * a_weights.w;\n}\nvoid CCSkin (inout vec4 position) {\n  mat4 m = skinMatrix();\n  position = m * position;\n}\nvoid CCSkin (inout StandardVertInput attr) {\n  mat4 m = skinMatrix();\n  attr.position = m * attr.position;\n  attr.normal = (m * vec4(attr.normal, 0.0)).xyz;\n  attr.tangent.xyz = (m * vec4(attr.tangent.xyz, 0.0)).xyz;\n}\n#endif\nuniform highp mat4 cc_matView;\nuniform highp mat4 cc_matProj;\n#if USE_INSTANCING\n  attribute vec4 a_matWorld0;\n  attribute vec4 a_matWorld1;\n  attribute vec4 a_matWorld2;\n#elif USE_BATCHING\n  attribute float a_dyn_batch_id;\n  uniform highp mat4 cc_matWorlds[10];\n#else\nuniform highp mat4 cc_matWorld;\nuniform highp mat4 cc_matWorldIT;\nuniform highp vec4 cc_lightingMapUVParam;\n#endif\nuniform vec4 tilingOffset;\n#if USE_VERTEX_COLOR\n  attribute vec3 a_color;\n  varying vec3 v_color;\n#endif\nvarying vec3 v_position;\nvarying vec3 v_normal;\n#if USE_NORMAL_MAP\n  varying vec3 v_tangent;\n  varying vec3 v_bitangent;\n#endif\nattribute vec2 a_texCoord;\nvarying vec2 v_uv;\nattribute vec2 a_texCoord1;\nvarying vec2 v_uv1;\n#if USE_LIGHTMAP && !USE_BATCHING && !USE_INSTANCING\n  varying vec2 v_luv;\n#endif\nvec4 vert () {\n  StandardVertInput In;\n  In.position = vec4(a_position, 1.0);\n  In.normal = a_normal;\n  In.tangent = a_tangent;\n  #if CC_USE_MORPH\n    applyMorph(In);\n  #endif\n  #if CC_USE_SKINNING\n    CCSkin(In);\n  #endif\n  mat4 matWorld, matWorldIT;\n  #if USE_INSTANCING\n    matWorld = mat4(\n      vec4(a_matWorld0.xyz, 0.0),\n      vec4(a_matWorld1.xyz, 0.0),\n      vec4(a_matWorld2.xyz, 0.0),\n      vec4(a_matWorld0.w, a_matWorld1.w, a_matWorld2.w, 1.0)\n    );\n    matWorldIT = matWorld;\n  #elif USE_BATCHING\n    matWorld = cc_matWorlds[int(a_dyn_batch_id)];\n    matWorldIT = matWorld;\n  #else\n    matWorld = cc_matWorld;\n    matWorldIT = cc_matWorldIT;\n  #endif\n  vec4 pos = matWorld * In.position;\n  v_position = pos.xyz;\n  v_normal = normalize((matWorldIT * vec4(In.normal, 0.0)).xyz);\n  #if USE_NORMAL_MAP\n    v_tangent = normalize((matWorld * vec4(In.tangent.xyz, 0.0)).xyz);\n    v_bitangent = cross(v_normal, v_tangent) * In.tangent.w;\n  #endif\n  v_uv = a_texCoord * tilingOffset.xy + tilingOffset.zw;\n  #if HAS_SECOND_UV\n    v_uv1 = a_texCoord1 * tilingOffset.xy + tilingOffset.zw;\n  #endif\n  #if USE_VERTEX_COLOR\n    v_color = a_color;\n  #endif\n  #if USE_LIGHTMAP && HAS_SECOND_UV && !USE_BATCHING && !USE_INSTANCING\n    v_luv = cc_lightingMapUVParam.xy + a_texCoord1 * cc_lightingMapUVParam.zw;\n  #endif\n  return cc_matProj * (cc_matView * matWorld) * In.position;\n}\nvoid main() { gl_Position = vert(); }",frag:"\n  #ifdef GL_EXT_shader_texture_lod\n    #extension GL_EXT_shader_texture_lod : enable\n  #endif\nprecision highp float;\nuniform highp vec4 cc_cameraPos;\nuniform mediump vec4 cc_exposure;\nuniform mediump vec4 cc_mainLitDir;\nuniform mediump vec4 cc_mainLitColor;\nuniform mediump vec4 cc_ambientSky;\nuniform mediump vec4 cc_ambientGround;\n#if CC_USE_IBL\nuniform samplerCube cc_environment;\nvec3 unpackRGBE (vec4 rgbe) {\n  return rgbe.rgb * pow(2.0, rgbe.a * 255.0 - 128.0);\n}\nvec4 fragTextureLod (sampler2D tex, vec2 coord, float lod) {\n    #ifdef GL_EXT_shader_texture_lod\n      return texture2DLodEXT(tex, coord, lod);\n    #else\n      return texture2D(tex, coord, lod);\n    #endif\n}\nvec4 fragTextureLod (samplerCube tex, vec3 coord, float lod) {\n    #ifdef GL_EXT_shader_texture_lod\n      return textureCubeLodEXT(tex, coord, lod);\n    #else\n      return textureCube(tex, coord, lod);\n    #endif\n}\n#endif\nvec3 SRGBToLinear (vec3 gamma) {\n  return gamma * gamma;\n}\nuniform highp vec4 cc_sphereLitPos[2];\nuniform vec4 cc_sphereLitSizeRange[2];\nuniform vec4 cc_sphereLitColor[2];\nuniform highp vec4 cc_spotLitPos[2];\nuniform vec4 cc_spotLitSizeRangeAngle[2];\nuniform vec4 cc_spotLitDir[2];\nuniform vec4 cc_spotLitColor[2];\nfloat SmoothDistAtt (float distSqr, float invSqrAttRadius) {\n  float factor = distSqr * invSqrAttRadius;\n  float smoothFactor = clamp(1.0 - factor * factor, 0.0, 1.0);\n  return smoothFactor * smoothFactor;\n}\nfloat GetDistAtt (float distSqr, float invSqrAttRadius) {\n  float attenuation = 1.0 / max(distSqr, 0.01*0.01);\n  attenuation *= SmoothDistAtt(distSqr , invSqrAttRadius);\n  return attenuation;\n}\nfloat GetAngleAtt (vec3 L, vec3 litDir, float litAngleScale, float litAngleOffset) {\n  float cd = dot(litDir, L);\n  float attenuation = clamp(cd * litAngleScale + litAngleOffset, 0.0, 1.0);\n  return (attenuation * attenuation);\n}\nfloat GGXMobile (float roughness, float NoH, vec3 H, vec3 N) {\n  vec3 NxH = cross(N, H);\n  float OneMinusNoHSqr = dot(NxH, NxH);\n  float a = roughness * roughness;\n  float n = NoH * a;\n  float p = a / (OneMinusNoHSqr + n * n);\n  return p * p;\n}\nfloat CalcSpecular (float roughness, float NoH, vec3 H, vec3 N) {\n  return (roughness*0.25 + 0.25) * GGXMobile(roughness, NoH, H, N);\n}\nvec3 BRDFApprox (vec3 specular, float roughness, float NoV) {\n  const vec4 c0 = vec4(-1.0, -0.0275, -0.572, 0.022);\n  const vec4 c1 = vec4(1.0, 0.0425, 1.04, -0.04);\n  vec4 r = roughness * c0 + c1;\n  float a004 = min( r.x * r.x, exp2( -9.28 * NoV ) ) * r.x + r.y;\n  vec2 AB = vec2( -1.04, 1.04 ) * a004 + r.zw;\n  AB.y *= clamp(50.0 * specular.g, 0.0, 1.0);\n  return specular * AB.x + AB.y;\n}\nvec3 CalcDynamicLighting (vec3 worldPos, vec3 N, vec3 V, vec3 diffuse, vec3 specular, float roughness) {\n  vec3 lighting = vec3(0.0);\n  vec3 diffuseContrib = diffuse / 3.14159265359;\n  for (int i = 0; i < 2; i++) {\n    vec3 PLU = cc_sphereLitPos[i].xyz - worldPos;\n    vec3 PL = normalize(PLU);\n    vec3 PH = normalize(PL + V);\n    float PNL = max(dot(N, PL), 0.001);\n    float PNH = max(dot(N, PH), 0.0);\n    float distSqr = dot(PLU, PLU);\n    float litRadius = cc_sphereLitSizeRange[i].x;\n    float litRadiusSqr = litRadius * litRadius;\n    float illum = 3.14159265359 * (litRadiusSqr / max(litRadiusSqr , distSqr));\n    float attRadiusSqrInv = 1.0 / max(cc_sphereLitSizeRange[i].y, 0.01);\n    attRadiusSqrInv *= attRadiusSqrInv;\n    float att = GetDistAtt(distSqr, attRadiusSqrInv);\n    vec3 lspec = specular * CalcSpecular(roughness, PNH, PH, N);\n    lighting += PNL * cc_sphereLitColor[i].rgb * cc_sphereLitColor[i].w * illum * att * (diffuseContrib + lspec);\n  }\n  for (int i = 0; i < 2; i++) {\n    vec3 SLU = cc_spotLitPos[i].xyz - worldPos;\n    vec3 SL = normalize(SLU);\n    vec3 SH = normalize(SL + V);\n    float SNL = max(dot(N, SL), 0.001);\n    float SNH = max(dot(N, SH), 0.0);\n    float distSqr = dot(SLU, SLU);\n    float litRadius = cc_spotLitSizeRangeAngle[i].x;\n    float litRadiusSqr = litRadius * litRadius;\n    float illum = 3.14159265359 * (litRadiusSqr / max(litRadiusSqr , distSqr));\n    float attRadiusSqrInv = 1.0 / max(cc_spotLitSizeRangeAngle[i].y, 0.01);\n    attRadiusSqrInv *= attRadiusSqrInv;\n    float cosInner = max(dot(-cc_spotLitDir[i].xyz, SL), 0.01);\n    float cosOuter = cc_spotLitSizeRangeAngle[i].z;\n    float litAngleScale = 1.0 / max(0.001, cosInner - cosOuter);\n    float litAngleOffset = -cosOuter * litAngleScale;\n    float att = GetDistAtt(distSqr, attRadiusSqrInv);\n    att *= GetAngleAtt(SL, -cc_spotLitDir[i].xyz, litAngleScale, litAngleOffset);\n    vec3 lspec = specular * CalcSpecular(roughness, SNH, SH, N);\n    lighting += SNL * cc_spotLitColor[i].rgb * cc_spotLitColor[i].w * illum * att * (diffuseContrib + lspec);\n  }\n  return lighting;\n}\nstruct StandardSurface {\n  vec4 albedo;\n  vec3 position;\n  vec3 normal;\n  vec3 emissive;\n  float roughness;\n  float metallic;\n  float occlusion;\n};\nvec4 CCStandardShading (StandardSurface s) {\n  vec3 diffuse = s.albedo.rgb * (1.0 - s.metallic);\n  vec3 specular = mix(vec3(0.04), s.albedo.rgb, s.metallic);\n  vec3 N = normalize(s.normal);\n  vec3 V = normalize(cc_cameraPos.xyz - s.position);\n  vec3 L = normalize(-cc_mainLitDir.xyz);\n  vec3 H = normalize(L+V);\n  float NV = max(abs(dot(N, V)), 0.001);\n  float NL = max(dot(N, L), 0.001);\n  float NH = max(dot(N, H), 0.0);\n  specular = BRDFApprox(specular, s.roughness, NV);\n  vec3 diffuseContrib = diffuse / 3.14159265359;\n  vec3 specularContrib = specular * CalcSpecular(s.roughness, NH, H, N);\n  vec3 finalColor = NL * cc_mainLitColor.rgb * cc_mainLitColor.w * (diffuseContrib + specularContrib);\n  finalColor += CalcDynamicLighting(s.position, N, V, diffuse, specular, s.roughness);\n  float fAmb = 0.5 - N.y * 0.5;\n  vec3 ambDiff = mix(cc_ambientSky.rgb, cc_ambientGround.rgb, fAmb) * cc_ambientSky.w;\n  finalColor += (ambDiff.rgb * diffuse);\n  #if CC_USE_IBL\n    vec3 R = normalize(reflect(-V, N));\n    vec4 envmap = fragTextureLod(cc_environment, R, s.roughness * cc_ambientGround.w);\n    #if CC_USE_IBL == 2\n      vec3 env = unpackRGBE(envmap);\n    #else\n      vec3 env = SRGBToLinear(envmap.rgb);\n    #endif\n    finalColor += env * cc_ambientSky.w * specular;\n  #endif\n  finalColor = finalColor * s.occlusion;\n  #if CC_USE_HDR\n    s.emissive *= cc_exposure.w;\n  #endif\n  finalColor += s.emissive;\n  return vec4(finalColor, s.albedo.a);\n}\nvec3 ACESToneMap (vec3 color) {\n  color = min(color, vec3(8.0));\n  const float A = 2.51;\n  const float B = 0.03;\n  const float C = 2.43;\n  const float D = 0.59;\n  const float E = 0.14;\n  return (color * (A * color + B)) / (color * (C * color + D) + E);\n}\nvec4 CCFragOutput (vec4 color) {\n  #if !CC_USE_HDR\n    color.rgb = sqrt(ACESToneMap(color.rgb));\n  #endif\n  return color;\n}\nuniform vec4 albedo;\nuniform vec4 albedoScaleAndCutoff;\nuniform vec4 pbrParams;\nuniform vec4 emissive;\nuniform vec4 emissiveScaleParam;\nvarying vec3 v_position;\nvarying vec2 v_uv;\nvarying vec2 v_uv1;\nvarying vec3 v_normal;\n#if USE_VERTEX_COLOR\n  varying vec3 v_color;\n#endif\n#if USE_ALBEDO_MAP\n  uniform sampler2D albedoMap;\n#endif\n#if USE_NORMAL_MAP\n  varying vec3 v_tangent;\n  varying vec3 v_bitangent;\n  uniform sampler2D normalMap;\n#endif\n#if USE_PBR_MAP\n  uniform sampler2D pbrMap;\n#endif\n#if USE_METALLIC_ROUGHNESS_MAP\n  uniform sampler2D metallicRoughnessMap;\n#endif\n#if USE_OCCLUSION_MAP\n  uniform sampler2D occlusionMap;\n#endif\n#if USE_EMISSIVE_MAP\n  uniform sampler2D emissiveMap;\n#endif\n#if USE_LIGHTMAP\n  varying vec2 v_luv;\n  uniform sampler2D cc_lightingMap;\n#endif\n#if USE_ALPHA_TEST\n#endif\nvoid surf (out StandardSurface s) {\n  vec4 baseColor = albedo;\n  #if USE_VERTEX_COLOR\n    baseColor.rgb *= v_color;\n  #endif\n  #if USE_ALBEDO_MAP\n    vec4 texColor = texture2D(albedoMap, ALBEDO_UV);\n    texColor.rgb = SRGBToLinear(texColor.rgb);\n    baseColor *= texColor;\n  #endif\n  s.albedo = baseColor;\n  s.albedo.rgb *= albedoScaleAndCutoff.xyz;\n  #if USE_ALPHA_TEST\n    if (s.albedo.ALPHA_TEST_CHANNEL < albedoScaleAndCutoff.w) discard;\n  #endif\n  s.normal = v_normal;\n  #if USE_NORMAL_MAP\n    vec3 nmmp = texture2D(normalMap, NORMAL_UV).xyz - vec3(0.5);\n    s.normal =\n      (nmmp.x * pbrParams.w) * normalize(v_tangent) +\n      (nmmp.y * pbrParams.w) * normalize(v_bitangent) +\n      nmmp.z * normalize(s.normal);\n  #endif\n  s.position = v_position;\n  vec4 pbr = pbrParams;\n  #if USE_PBR_MAP\n    vec4 res = texture2D(pbrMap, PBR_UV);\n    pbr.x *= res.OCCLUSION_CHANNEL;\n    pbr.y *= res.ROUGHNESS_CHANNEL;\n    pbr.z *= res.METALLIC_CHANNEL;\n  #endif\n  #if USE_METALLIC_ROUGHNESS_MAP\n    vec4 metallicRoughness = texture2D(metallicRoughnessMap, METALLIC_ROUGHNESS_UV);\n    pbr.z *= metallicRoughness.METALLIC_CHANNEL;\n    pbr.y *= metallicRoughness.ROUGHNESS_CHANNEL;\n  #endif\n  #if USE_OCCLUSION_MAP\n    pbr.x *= texture2D(occlusionMap, OCCLUSION_UV).OCCLUSION_CHANNEL;\n  #endif\n  s.occlusion = clamp(pbr.x, 0.0, 0.96);\n  s.roughness = clamp(pbr.y, 0.04, 1.0);\n  s.metallic = pbr.z;\n  s.emissive = emissive.rgb * emissiveScaleParam.xyz;\n  #if USE_EMISSIVE_MAP\n    s.emissive *= SRGBToLinear(texture2D(emissiveMap, EMISSIVE_UV).rgb);\n  #endif\n}\nvec4 frag () {\n  StandardSurface s; surf(s);\n  vec4 color = CCStandardShading(s);\n  #if USE_LIGHTMAP && !USE_BATCHING && !USE_INSTANCING\n    vec4 lighting = texture2D(cc_lightingMap, v_luv);\n    float fAmb = 0.5 - s.normal.y * 0.5;\n    vec3 ambDiff = mix(cc_ambientSky.rgb, cc_ambientGround.rgb, fAmb) * cc_ambientSky.w;\n    vec3 finalColor = (ambDiff.rgb * s.albedo.rgb);\n    finalColor += lighting.rgb *  s.albedo.rgb;\n    finalColor = finalColor * s.occlusion;\n    finalColor += s.emissive;\n    color.rgb = lighting.a * finalColor + (1.0 - lighting.a) * color.rgb;\n  #endif\n  return CCFragOutput(color);\n}\nvoid main() { gl_FragColor = frag(); }"},builtins:{globals:{blocks:[{name:"CCGlobal",defines:[]}],samplers:[{name:"cc_environment",defines:["CC_USE_IBL"]}]},locals:{blocks:[{name:"CCMorph",defines:["CC_USE_MORPH"]},{name:"CCSkinningTexture",defines:["CC_USE_SKINNING","CC_USE_BAKED_ANIMATION"]},{name:"CCSkinningAnimation",defines:["CC_USE_SKINNING","CC_USE_BAKED_ANIMATION"]},{name:"CCSkinning",defines:["CC_USE_SKINNING","!CC_USE_BAKED_ANIMATION"]},{name:"CCLocalBatched",defines:["!USE_INSTANCING","USE_BATCHING"]},{name:"CCLocal",defines:["!USE_INSTANCING","!USE_BATCHING"]},{name:"CCForwardLight",defines:[]}],samplers:[{name:"cc_PositionDisplacements",defines:["CC_USE_MORPH","CC_MORPH_TARGET_HAS_POSITION"]},{name:"cc_NormalDisplacements",defines:["CC_USE_MORPH","CC_MORPH_TARGET_HAS_NORMAL"]},{name:"cc_TangentDisplacements",defines:["CC_USE_MORPH","CC_MORPH_TARGET_HAS_TANGENT"]},{name:"cc_jointTexture",defines:["CC_USE_SKINNING","CC_USE_BAKED_ANIMATION"]},{name:"cc_lightingMap",defines:["USE_LIGHTMAP"]}]}},defines:[{name:"CC_USE_MORPH",type:"boolean"},{name:"CC_MORPH_TARGET_COUNT",type:"number",range:[2,8]},{name:"CC_MORPH_PRECOMPUTED",type:"boolean"},{name:"CC_MORPH_TARGET_HAS_POSITION",type:"boolean"},{name:"CC_MORPH_TARGET_HAS_NORMAL",type:"boolean"},{name:"CC_MORPH_TARGET_HAS_TANGENT",type:"boolean"},{name:"CC_USE_SKINNING",type:"boolean"},{name:"CC_USE_BAKED_ANIMATION",type:"boolean"},{name:"USE_INSTANCING",type:"boolean"},{name:"CC_SUPPORT_FLOAT_TEXTURE",type:"boolean"},{name:"USE_BATCHING",type:"boolean"},{name:"USE_VERTEX_COLOR",type:"boolean"},{name:"USE_NORMAL_MAP",type:"boolean"},{name:"USE_LIGHTMAP",type:"boolean"},{name:"HAS_SECOND_UV",type:"boolean"},{name:"CC_USE_IBL",type:"number",range:[0,2]},{name:"CC_USE_HDR",type:"boolean"},{name:"USE_ALBEDO_MAP",type:"boolean"},{name:"ALBEDO_UV",type:"string",options:["v_uv","v_uv1"]},{name:"NORMAL_UV",type:"string",options:["v_uv","v_uv1"]},{name:"USE_PBR_MAP",type:"boolean"},{name:"PBR_UV",type:"string",options:["v_uv","v_uv1"]},{name:"USE_METALLIC_ROUGHNESS_MAP",type:"boolean"},{name:"METALLIC_ROUGHNESS_UV",type:"string",options:["v_uv","v_uv1"]},{name:"USE_OCCLUSION_MAP",type:"boolean"},{name:"OCCLUSION_UV",type:"string",options:["v_uv","v_uv1"]},{name:"USE_EMISSIVE_MAP",type:"boolean"},{name:"EMISSIVE_UV",type:"string",options:["v_uv","v_uv1"]},{name:"OCCLUSION_CHANNEL",type:"string",options:["r","g","b"]},{name:"ROUGHNESS_CHANNEL",type:"string",options:["g","b","r"]},{name:"METALLIC_CHANNEL",type:"string",options:["b","r","g"]},{name:"USE_ALPHA_TEST",type:"boolean"},{name:"ALPHA_TEST_CHANNEL",type:"string",options:["a","r"]}],blocks:[{name:"Constants",defines:[],binding:0,members:[{name:"tilingOffset",type:16,count:1},{name:"albedo",type:16,count:1},{name:"albedoScaleAndCutoff",type:16,count:1},{name:"pbrParams",type:16,count:1},{name:"emissive",type:16,count:1},{name:"emissiveScaleParam",type:16,count:1}]}],samplers:[{name:"albedoMap",type:28,count:1,defines:["USE_ALBEDO_MAP"],binding:31},{name:"normalMap",type:28,count:1,defines:["USE_NORMAL_MAP"],binding:32},{name:"pbrMap",type:28,count:1,defines:["USE_PBR_MAP"],binding:33},{name:"metallicRoughnessMap",type:28,count:1,defines:["USE_METALLIC_ROUGHNESS_MAP"],binding:34},{name:"occlusionMap",type:28,count:1,defines:["USE_OCCLUSION_MAP"],binding:35},{name:"emissiveMap",type:28,count:1,defines:["USE_EMISSIVE_MAP"],binding:36}],attributes:[{name:"a_position",type:15,count:1,defines:[],format:32,location:0},{name:"a_normal",type:15,count:1,defines:[],format:32,location:1},{name:"a_tangent",type:16,count:1,defines:[],format:43,location:2},{name:"a_vertexId",type:13,count:1,defines:["CC_USE_MORPH"],format:11,location:3},{name:"a_weights",type:16,count:1,defines:["CC_USE_SKINNING"],format:43,location:4},{name:"a_joints",type:16,count:1,defines:["CC_USE_SKINNING"],format:43,location:5},{name:"a_jointAnimInfo",type:16,count:1,precision:"highp ",defines:["CC_USE_SKINNING","CC_USE_BAKED_ANIMATION","USE_INSTANCING"],format:43,isInstanced:!0,location:6},{name:"a_matWorld0",type:16,count:1,defines:["USE_INSTANCING"],format:43,isInstanced:!0,location:7},{name:"a_matWorld1",type:16,count:1,defines:["USE_INSTANCING"],format:43,isInstanced:!0,location:8},{name:"a_matWorld2",type:16,count:1,defines:["USE_INSTANCING"],format:43,isInstanced:!0,location:9},{name:"a_dyn_batch_id",type:13,count:1,defines:["!USE_INSTANCING","USE_BATCHING"],format:11,location:10},{name:"a_color",type:15,count:1,defines:["USE_VERTEX_COLOR"],format:32,location:11},{name:"a_texCoord",type:14,count:1,defines:[],format:21,location:12},{name:"a_texCoord1",type:14,count:1,defines:[],format:21,location:13}]}]},{name:"builtin-terrain",_uuid:"1d08ef62-a503-4ce2-8b9a-46c90873f7d3",techniques:[{name:"opaque",passes:[{program:"builtin-terrain|terrain-vs:vert|terrain-fs:frag",properties:{UVScale:{value:[1,1,1,1],type:16},lightMapUVParam:{value:[0,0,0,0],type:16},weightMap:{value:"black",type:28},detailMap0:{value:"grey",type:28},detailMap1:{value:"grey",type:28},detailMap2:{value:"grey",type:28},detailMap3:{value:"grey",type:28},lightMap:{value:"grey",type:28}}}]}],shaders:[{name:"builtin-terrain|terrain-vs:vert|terrain-fs:frag",hash:29493851,glsl3:{vert:"\n  precision mediump float;\nuniform CCGlobal {\n  highp   vec4 cc_time;\n  mediump vec4 cc_screenSize;\n  mediump vec4 cc_screenScale;\n  mediump vec4 cc_nativeSize;\n  highp   mat4 cc_matView;\n  highp   mat4 cc_matViewInv;\n  highp   mat4 cc_matProj;\n  highp   mat4 cc_matProjInv;\n  highp   mat4 cc_matViewProj;\n  highp   mat4 cc_matViewProjInv;\n  highp   vec4 cc_cameraPos;\n  mediump vec4 cc_exposure;\n  mediump vec4 cc_mainLitDir;\n  mediump vec4 cc_mainLitColor;\n  mediump vec4 cc_ambientSky;\n  mediump vec4 cc_ambientGround;\n};\nuniform CCLocal {\n  highp mat4 cc_matWorld;\n  highp mat4 cc_matWorldIT;\n  highp vec4 cc_lightingMapUVParam;\n};\n  in vec3 a_position;\n  in vec3 a_normal;\n  in vec2 a_texCoord;\n  out vec2 uvw;\n  out vec2 uv0;\n  out vec2 uv1;\n  out vec2 uv2;\n  out vec2 uv3;\n  out vec2 luv;\n  out vec3 diffuse;\n  uniform TexCoords {\n    vec4 UVScale;\n    vec4 lightMapUVParam;\n  };\n  vec4 vert () {\n    vec3 worldPos;\n    worldPos.x = cc_matWorld[3][0] + a_position.x;\n    worldPos.y = cc_matWorld[3][1] + a_position.y;\n    worldPos.z = cc_matWorld[3][2] + a_position.z;\n    vec4 pos = vec4(worldPos, 1);\n    pos = cc_matViewProj * pos;\n    uvw = a_texCoord;\n    uv0 = a_position.xz * UVScale.x;\n    uv1 = a_position.xz * UVScale.y;\n    uv2 = a_position.xz * UVScale.z;\n    uv3 = a_position.xz * UVScale.w;\n    float fAmb = dot(a_normal, vec3(0.0, -1.0, 0.0)) * 0.5 + 0.5;\n    vec3 ambDiff = mix(cc_ambientSky.rgb, cc_ambientGround.rgb, fAmb) * cc_ambientSky.w;\n#if LIGHT_MAP == 0\n    vec3 L = normalize(-cc_mainLitDir.xyz);\n    vec3 N = a_normal;\n    diffuse = ambDiff + vec3(dot(N, L)) * cc_mainLitColor.rgb;\n#else\n    diffuse = ambDiff;\n    luv = lightMapUVParam.xy + a_texCoord * lightMapUVParam.zw;\n#endif\n    return pos;\n  }\nvoid main() { gl_Position = vert(); }",frag:"\nprecision mediump float;\nuniform CCGlobal {\n  highp   vec4 cc_time;\n  mediump vec4 cc_screenSize;\n  mediump vec4 cc_screenScale;\n  mediump vec4 cc_nativeSize;\n  highp   mat4 cc_matView;\n  highp   mat4 cc_matViewInv;\n  highp   mat4 cc_matProj;\n  highp   mat4 cc_matProjInv;\n  highp   mat4 cc_matViewProj;\n  highp   mat4 cc_matViewProjInv;\n  highp   vec4 cc_cameraPos;\n  mediump vec4 cc_exposure;\n  mediump vec4 cc_mainLitDir;\n  mediump vec4 cc_mainLitColor;\n  mediump vec4 cc_ambientSky;\n  mediump vec4 cc_ambientGround;\n};\nvec3 SRGBToLinear (vec3 gamma) {\n  return gamma * gamma;\n}\nvec4 CCFragOutput (vec4 color) {\n  #if CC_USE_HDR\n    color.rgb = mix(color.rgb, SRGBToLinear(color.rgb) * cc_exposure.w, vec3(cc_exposure.z));\n  #endif\n  return color;\n}\n  in vec2 uvw;\n  in vec2 uv0;\n  in vec2 uv1;\n  in vec2 uv2;\n  in vec2 uv3;\n  in vec3 diffuse;\n  in vec2 luv;\n  uniform sampler2D weightMap;\n  uniform sampler2D detailMap0;\n  uniform sampler2D detailMap1;\n  uniform sampler2D detailMap2;\n  uniform sampler2D detailMap3;\n  uniform sampler2D lightMap;\nvec4 frag () {\n  vec4 color = vec4(0, 0, 0, 0);\n  #if LAYERS == 1\n    color = texture(detailMap0, uv0);\n  #elif LAYERS == 2\n    vec4 w = texture(weightMap, uvw);\n    color += texture(detailMap0, uv0) * w.r;\n    color += texture(detailMap1, uv1) * w.g;\n  #elif LAYERS == 3\n    vec4 w = texture(weightMap, uvw);\n    color += texture(detailMap0, uv0) * w.r;\n    color += texture(detailMap1, uv1) * w.g;\n    color += texture(detailMap2, uv2) * w.b;\n  #elif LAYERS == 4\n    vec4 w = texture(weightMap, uvw);\n    color += texture(detailMap0, uv0) * w.r;\n    color += texture(detailMap1, uv1) * w.g;\n    color += texture(detailMap2, uv2) * w.b;\n    color += texture(detailMap3, uv3) * w.a;\n  #else\n    color = texture(detailMap0, uv0);\n  #endif\n  vec3 lighting = diffuse;\n  #if LIGHT_MAP == 1\n    lighting += texture(lightMap, luv).rgb;\n  #endif\n  color.rgb *= lighting;\n  return CCFragOutput(color);\n}\nout vec4 cc_FragColor;\nvoid main() { cc_FragColor = frag(); }"},glsl1:{vert:"\n  precision mediump float;\nuniform highp mat4 cc_matViewProj;\nuniform mediump vec4 cc_mainLitDir;\nuniform mediump vec4 cc_mainLitColor;\nuniform mediump vec4 cc_ambientSky;\nuniform mediump vec4 cc_ambientGround;\nuniform highp mat4 cc_matWorld;\n  attribute vec3 a_position;\n  attribute vec3 a_normal;\n  attribute vec2 a_texCoord;\n  varying vec2 uvw;\n  varying vec2 uv0;\n  varying vec2 uv1;\n  varying vec2 uv2;\n  varying vec2 uv3;\n  varying vec2 luv;\n  varying vec3 diffuse;\n  uniform vec4 UVScale;\nuniform vec4 lightMapUVParam;\n  vec4 vert () {\n    vec3 worldPos;\n    worldPos.x = cc_matWorld[3][0] + a_position.x;\n    worldPos.y = cc_matWorld[3][1] + a_position.y;\n    worldPos.z = cc_matWorld[3][2] + a_position.z;\n    vec4 pos = vec4(worldPos, 1);\n    pos = cc_matViewProj * pos;\n    uvw = a_texCoord;\n    uv0 = a_position.xz * UVScale.x;\n    uv1 = a_position.xz * UVScale.y;\n    uv2 = a_position.xz * UVScale.z;\n    uv3 = a_position.xz * UVScale.w;\n    float fAmb = dot(a_normal, vec3(0.0, -1.0, 0.0)) * 0.5 + 0.5;\n    vec3 ambDiff = mix(cc_ambientSky.rgb, cc_ambientGround.rgb, fAmb) * cc_ambientSky.w;\n#if LIGHT_MAP == 0\n    vec3 L = normalize(-cc_mainLitDir.xyz);\n    vec3 N = a_normal;\n    diffuse = ambDiff + vec3(dot(N, L)) * cc_mainLitColor.rgb;\n#else\n    diffuse = ambDiff;\n    luv = lightMapUVParam.xy + a_texCoord * lightMapUVParam.zw;\n#endif\n    return pos;\n  }\nvoid main() { gl_Position = vert(); }",frag:"\nprecision mediump float;\nuniform mediump vec4 cc_exposure;\nvec3 SRGBToLinear (vec3 gamma) {\n  return gamma * gamma;\n}\nvec4 CCFragOutput (vec4 color) {\n  #if CC_USE_HDR\n    color.rgb = mix(color.rgb, SRGBToLinear(color.rgb) * cc_exposure.w, vec3(cc_exposure.z));\n  #endif\n  return color;\n}\n  varying vec2 uvw;\n  varying vec2 uv0;\n  varying vec2 uv1;\n  varying vec2 uv2;\n  varying vec2 uv3;\n  varying vec3 diffuse;\n  varying vec2 luv;\n  uniform sampler2D weightMap;\n  uniform sampler2D detailMap0;\n  uniform sampler2D detailMap1;\n  uniform sampler2D detailMap2;\n  uniform sampler2D detailMap3;\n  uniform sampler2D lightMap;\nvec4 frag () {\n  vec4 color = vec4(0, 0, 0, 0);\n  #if LAYERS == 1\n    color = texture2D(detailMap0, uv0);\n  #elif LAYERS == 2\n    vec4 w = texture2D(weightMap, uvw);\n    color += texture2D(detailMap0, uv0) * w.r;\n    color += texture2D(detailMap1, uv1) * w.g;\n  #elif LAYERS == 3\n    vec4 w = texture2D(weightMap, uvw);\n    color += texture2D(detailMap0, uv0) * w.r;\n    color += texture2D(detailMap1, uv1) * w.g;\n    color += texture2D(detailMap2, uv2) * w.b;\n  #elif LAYERS == 4\n    vec4 w = texture2D(weightMap, uvw);\n    color += texture2D(detailMap0, uv0) * w.r;\n    color += texture2D(detailMap1, uv1) * w.g;\n    color += texture2D(detailMap2, uv2) * w.b;\n    color += texture2D(detailMap3, uv3) * w.a;\n  #else\n    color = texture2D(detailMap0, uv0);\n  #endif\n  vec3 lighting = diffuse;\n  #if LIGHT_MAP == 1\n    lighting += texture2D(lightMap, luv).rgb;\n  #endif\n  color.rgb *= lighting;\n  return CCFragOutput(color);\n}\nvoid main() { gl_FragColor = frag(); }"},builtins:{globals:{blocks:[{name:"CCGlobal",defines:[]}],samplers:[]},locals:{blocks:[{name:"CCLocal",defines:[]}],samplers:[]}},defines:[{name:"LIGHT_MAP",type:"number",range:[0,3]},{name:"CC_USE_HDR",type:"boolean"},{name:"LAYERS",type:"number",range:[0,4]}],blocks:[{name:"TexCoords",defines:[],binding:0,members:[{name:"UVScale",type:16,count:1},{name:"lightMapUVParam",type:16,count:1}]}],samplers:[{name:"weightMap",type:28,count:1,defines:[],binding:31},{name:"detailMap0",type:28,count:1,defines:[],binding:32},{name:"detailMap1",type:28,count:1,defines:[],binding:33},{name:"detailMap2",type:28,count:1,defines:[],binding:34},{name:"detailMap3",type:28,count:1,defines:[],binding:35},{name:"lightMap",type:28,count:1,defines:[],binding:36}],attributes:[{name:"a_position",type:15,count:1,defines:[],format:32,location:0},{name:"a_normal",type:15,count:1,defines:[],format:32,location:1},{name:"a_texCoord",type:14,count:1,defines:[],format:21,location:2}]}]},{name:"builtin-unlit",_uuid:"a3cd009f-0ab0-420d-9278-b9fdab939bbc",techniques:[{name:"opaque",passes:[{program:"builtin-unlit|unlit-vs:vert|unlit-fs:frag",properties:{mainTexture:{value:"grey",type:28},tilingOffset:{value:[1,1,0,0],type:16},mainColor:{value:[1,1,1,1],type:16},colorScale:{value:[1,1,1],type:15,handleInfo:["colorScaleAndCutoff",0,15]},alphaThreshold:{value:[.5],type:13,handleInfo:["colorScaleAndCutoff",3,13]},color:{type:16,handleInfo:["mainColor",0,16]},colorScaleAndCutoff:{type:16,value:[1,1,1,.5]}}}]}],shaders:[{name:"builtin-unlit|unlit-vs:vert|unlit-fs:frag",hash:2493645459,glsl3:{vert:"\nprecision highp float;\nstruct StandardVertInput {\n  highp vec4 position;\n  vec3 normal;\n  vec4 tangent;\n};\nin vec3 a_position;\n#if CC_USE_MORPH\n    in float a_vertexId;\n    int getVertexId() {\n        return int(a_vertexId);\n    }\nuniform CCMorph {\n    vec4 cc_displacementWeights[15];\n    vec4 cc_displacementTextureInfo;\n};\n    vec4 fetchFlatPixel(sampler2D tex, int pixelIndex) {\n        float pixelIndexF = float(pixelIndex);\n        vec2 textureResolution = vec2(float(cc_displacementTextureInfo.x), float(cc_displacementTextureInfo.y));\n        float pixelX = mod(pixelIndexF, textureResolution.x);\n        float pixelY = floor(pixelIndexF / textureResolution.x);\n        vec2 uv = (vec2(pixelX, pixelY) + .5) / textureResolution;\n        return texture(tex, uv);\n    }\nfloat getDisplacementWeight(int index) {\n    float m = mod(float(index), 4.0);\n    if (m < 1.0) {\n        return cc_displacementWeights[index / 4].x;\n    } else if (m < 2.0) {\n        return cc_displacementWeights[index / 4].y;\n    } else if (m < 3.0) {\n        return cc_displacementWeights[index / 4].z;\n    } else {\n        return cc_displacementWeights[index / 4].w;\n    }\n}\nvec3 getVec3DisplacementFromTexture(sampler2D tex, int vertexIndex) {\n#if CC_MORPH_PRECOMPUTED\n    return fetchFlatPixel(tex, vertexIndex).rgb;\n#else\n    vec3 result = vec3(0, 0, 0);\n    for (int iTarget = 0; iTarget < CC_MORPH_TARGET_COUNT; ++iTarget) {\n        int dataPixelStart = int(fetchFlatPixel(tex, iTarget).r);\n        result += (fetchFlatPixel(tex, dataPixelStart + vertexIndex).rgb * getDisplacementWeight(iTarget));\n    }\n    return result;\n#endif\n}\n#if CC_MORPH_TARGET_HAS_POSITION\n    uniform sampler2D cc_PositionDisplacements;\n    vec3 getPositionDisplacement(int vertexId) {\n        return getVec3DisplacementFromTexture(cc_PositionDisplacements, vertexId);\n    }\n#endif\n#if CC_MORPH_TARGET_HAS_NORMAL\n    uniform sampler2D cc_NormalDisplacements;\n    vec3 getNormalDisplacement(int vertexId) {\n        return getVec3DisplacementFromTexture(cc_NormalDisplacements, vertexId);\n    }\n#endif\n#if CC_MORPH_TARGET_HAS_TANGENT\n    uniform sampler2D cc_TangentDisplacements;\n    vec3 getTangentDisplacement(int vertexId) {\n        return getVec3DisplacementFromTexture(cc_TangentDisplacements, vertexId);\n    }\n#endif\nvoid applyMorph (inout StandardVertInput attr) {\n    int vertexId = getVertexId();\n#if CC_MORPH_TARGET_HAS_POSITION\n    attr.position.xyz = attr.position.xyz + getPositionDisplacement(vertexId);\n#endif\n#if CC_MORPH_TARGET_HAS_NORMAL\n    attr.normal.xyz = attr.normal.xyz + getNormalDisplacement(vertexId);\n#endif\n#if CC_MORPH_TARGET_HAS_TANGENT\n    attr.tangent.xyz = attr.tangent.xyz + getTangentDisplacement(vertexId);\n#endif\n}\nvoid applyMorph (inout vec4 position) {\n#if CC_MORPH_TARGET_HAS_POSITION\n    position.xyz = position.xyz + getPositionDisplacement(getVertexId());\n#endif\n}\n#endif\n#if CC_USE_SKINNING\nin vec4 a_weights;\nin vec4 a_joints;\nhighp float decode32 (highp vec4 rgba) {\n  rgba = rgba * 255.0;\n  highp float Sign = 1.0 - step(127.99, rgba[3]) * 2.0;\n  highp float Exponent = 2.0 * mod(rgba[3], 127.99) + step(128.0, rgba[2]) - 127.0;\n  highp float Mantissa = mod(rgba[2], 128.0) * 65536.0 + rgba[1] * 256.0 + rgba[0] + 8388608.0;\n  return Sign * exp2(Exponent - 23.0) * Mantissa;\n}\n#if CC_USE_BAKED_ANIMATION\n  #if USE_INSTANCING\n    in highp vec4 a_jointAnimInfo;\n  #endif\n  uniform CCSkinningTexture {\n    highp vec4 cc_jointTextureInfo;\n  };\n  uniform CCSkinningAnimation {\n    highp vec4 cc_jointAnimInfo;\n  };\n  uniform sampler2D cc_jointTexture;\n  #else\n  uniform CCSkinning {\n    highp vec4 cc_joints[30 * 3];\n  };\n#endif\n#if CC_USE_BAKED_ANIMATION\n  #if CC_SUPPORT_FLOAT_TEXTURE\n    mat4 getJointMatrix (float i) {\n    #if USE_INSTANCING\n      highp float j = 3.0 * (a_jointAnimInfo.x * a_jointAnimInfo.y + i) + a_jointAnimInfo.z;\n    #else\n      highp float j = 3.0 * (cc_jointAnimInfo.x * cc_jointTextureInfo.y + i) + cc_jointTextureInfo.z;\n    #endif\n    highp float invSize = cc_jointTextureInfo.w;\n    highp float y = floor(j * invSize);\n    highp float x = j - y * cc_jointTextureInfo.x;\n    y = (y + 0.5) * invSize;\n      vec4 v1 = texture(cc_jointTexture, vec2((x + 0.5) * invSize, y));\n      vec4 v2 = texture(cc_jointTexture, vec2((x + 1.5) * invSize, y));\n      vec4 v3 = texture(cc_jointTexture, vec2((x + 2.5) * invSize, y));\n      return mat4(vec4(v1.xyz, 0.0), vec4(v2.xyz, 0.0), vec4(v3.xyz, 0.0), vec4(v1.w, v2.w, v3.w, 1.0));\n    }\n  #else\n    mat4 getJointMatrix (float i) {\n    #if USE_INSTANCING\n      highp float j = 12.0 * (a_jointAnimInfo.x * a_jointAnimInfo.y + i) + a_jointAnimInfo.z;\n    #else\n      highp float j = 12.0 * (cc_jointAnimInfo.x * cc_jointTextureInfo.y + i) + cc_jointTextureInfo.z;\n    #endif\n    highp float invSize = cc_jointTextureInfo.w;\n    highp float y = floor(j * invSize);\n    highp float x = j - y * cc_jointTextureInfo.x;\n    y = (y + 0.5) * invSize;\n      vec4 v1 = vec4(\n        decode32(texture(cc_jointTexture, vec2((x + 0.5) * invSize, y))),\n        decode32(texture(cc_jointTexture, vec2((x + 1.5) * invSize, y))),\n        decode32(texture(cc_jointTexture, vec2((x + 2.5) * invSize, y))),\n        decode32(texture(cc_jointTexture, vec2((x + 3.5) * invSize, y)))\n      );\n      vec4 v2 = vec4(\n        decode32(texture(cc_jointTexture, vec2((x + 4.5) * invSize, y))),\n        decode32(texture(cc_jointTexture, vec2((x + 5.5) * invSize, y))),\n        decode32(texture(cc_jointTexture, vec2((x + 6.5) * invSize, y))),\n        decode32(texture(cc_jointTexture, vec2((x + 7.5) * invSize, y)))\n      );\n      vec4 v3 = vec4(\n        decode32(texture(cc_jointTexture, vec2((x + 8.5) * invSize, y))),\n        decode32(texture(cc_jointTexture, vec2((x + 9.5) * invSize, y))),\n        decode32(texture(cc_jointTexture, vec2((x + 10.5) * invSize, y))),\n        decode32(texture(cc_jointTexture, vec2((x + 11.5) * invSize, y)))\n      );\n      return mat4(vec4(v1.xyz, 0.0), vec4(v2.xyz, 0.0), vec4(v3.xyz, 0.0), vec4(v1.w, v2.w, v3.w, 1.0));\n    }\n  #endif\n#else\n  mat4 getJointMatrix (float i) {\n    int idx = int(i);\n    vec4 v1 = cc_joints[idx * 3];\n    vec4 v2 = cc_joints[idx * 3 + 1];\n    vec4 v3 = cc_joints[idx * 3 + 2];\n    return mat4(vec4(v1.xyz, 0.0), vec4(v2.xyz, 0.0), vec4(v3.xyz, 0.0), vec4(v1.w, v2.w, v3.w, 1.0));\n  }\n#endif\nmat4 skinMatrix () {\n  return getJointMatrix(a_joints.x) * a_weights.x\n       + getJointMatrix(a_joints.y) * a_weights.y\n       + getJointMatrix(a_joints.z) * a_weights.z\n       + getJointMatrix(a_joints.w) * a_weights.w;\n}\nvoid CCSkin (inout vec4 position) {\n  mat4 m = skinMatrix();\n  position = m * position;\n}\nvoid CCSkin (inout StandardVertInput attr) {\n  mat4 m = skinMatrix();\n  attr.position = m * attr.position;\n  attr.normal = (m * vec4(attr.normal, 0.0)).xyz;\n  attr.tangent.xyz = (m * vec4(attr.tangent.xyz, 0.0)).xyz;\n}\n#endif\nuniform CCGlobal {\n  highp   vec4 cc_time;\n  mediump vec4 cc_screenSize;\n  mediump vec4 cc_screenScale;\n  mediump vec4 cc_nativeSize;\n  highp   mat4 cc_matView;\n  highp   mat4 cc_matViewInv;\n  highp   mat4 cc_matProj;\n  highp   mat4 cc_matProjInv;\n  highp   mat4 cc_matViewProj;\n  highp   mat4 cc_matViewProjInv;\n  highp   vec4 cc_cameraPos;\n  mediump vec4 cc_exposure;\n  mediump vec4 cc_mainLitDir;\n  mediump vec4 cc_mainLitColor;\n  mediump vec4 cc_ambientSky;\n  mediump vec4 cc_ambientGround;\n};\n#if USE_INSTANCING\n  in vec4 a_matWorld0;\n  in vec4 a_matWorld1;\n  in vec4 a_matWorld2;\n#elif USE_BATCHING\n  in float a_dyn_batch_id;\n  uniform CCLocalBatched {\n    highp mat4 cc_matWorlds[10];\n  };\n#else\nuniform CCLocal {\n  highp mat4 cc_matWorld;\n  highp mat4 cc_matWorldIT;\n  highp vec4 cc_lightingMapUVParam;\n};\n#endif\n#if USE_VERTEX_COLOR\n  in vec4 a_color;\n  out vec4 v_color;\n#endif\n#if USE_TEXTURE\n  in vec2 a_texCoord;\n  out vec2 v_uv;\n  uniform TexCoords {\n    vec4 tilingOffset;\n  };\n#endif\nvec4 vert () {\n  vec4 position;\n  position = vec4(a_position, 1.0);\n  #if CC_USE_MORPH\n    applyMorph(position);\n  #endif\n  #if CC_USE_SKINNING\n    CCSkin(position);\n  #endif\n  mat4 matWorld;\n  #if USE_INSTANCING\n    matWorld = mat4(\n      vec4(a_matWorld0.xyz, 0.0),\n      vec4(a_matWorld1.xyz, 0.0),\n      vec4(a_matWorld2.xyz, 0.0),\n      vec4(a_matWorld0.w, a_matWorld1.w, a_matWorld2.w, 1.0)\n    );\n  #elif USE_BATCHING\n    matWorld = cc_matWorlds[int(a_dyn_batch_id)];\n  #else\n    matWorld = cc_matWorld;\n  #endif\n  #if USE_TEXTURE\n    v_uv = a_texCoord;\n    #if FLIP_UV\n      v_uv.y = 1.0 - v_uv.y;\n    #endif\n    v_uv = v_uv * tilingOffset.xy + tilingOffset.zw;\n  #endif\n  #if USE_VERTEX_COLOR\n    v_color = a_color;\n  #endif\n  return cc_matProj * (cc_matView * matWorld) * position;\n}\nvoid main() { gl_Position = vert(); }",frag:"\nprecision mediump float;\nuniform CCGlobal {\n  highp   vec4 cc_time;\n  mediump vec4 cc_screenSize;\n  mediump vec4 cc_screenScale;\n  mediump vec4 cc_nativeSize;\n  highp   mat4 cc_matView;\n  highp   mat4 cc_matViewInv;\n  highp   mat4 cc_matProj;\n  highp   mat4 cc_matProjInv;\n  highp   mat4 cc_matViewProj;\n  highp   mat4 cc_matViewProjInv;\n  highp   vec4 cc_cameraPos;\n  mediump vec4 cc_exposure;\n  mediump vec4 cc_mainLitDir;\n  mediump vec4 cc_mainLitColor;\n  mediump vec4 cc_ambientSky;\n  mediump vec4 cc_ambientGround;\n};\nvec3 SRGBToLinear (vec3 gamma) {\n  return gamma * gamma;\n}\nvec4 CCFragOutput (vec4 color) {\n  #if CC_USE_HDR\n    color.rgb = mix(color.rgb, SRGBToLinear(color.rgb) * cc_exposure.w, vec3(cc_exposure.z));\n  #endif\n  return color;\n}\n#if USE_ALPHA_TEST\n#endif\n#if USE_TEXTURE\n  in vec2 v_uv;\n  uniform sampler2D mainTexture;\n#endif\nuniform Constant {\n  vec4 mainColor;\n  vec4 colorScaleAndCutoff;\n};\n#if USE_VERTEX_COLOR\n  in vec4 v_color;\n#endif\nvec4 frag () {\n  vec4 o = mainColor;\n  o.rgb *= colorScaleAndCutoff.xyz;\n  #if USE_VERTEX_COLOR\n    o *= v_color;\n  #endif\n  #if USE_TEXTURE\n    o *= texture(mainTexture, v_uv);\n  #endif\n  #if USE_ALPHA_TEST\n    if (o.ALPHA_TEST_CHANNEL < colorScaleAndCutoff.w) discard;\n  #endif\n  return CCFragOutput(o);\n}\nout vec4 cc_FragColor;\nvoid main() { cc_FragColor = frag(); }"},glsl1:{vert:"\nprecision highp float;\nstruct StandardVertInput {\n  highp vec4 position;\n  vec3 normal;\n  vec4 tangent;\n};\nattribute vec3 a_position;\n#if CC_USE_MORPH\n    attribute float a_vertexId;\n    int getVertexId() {\n        return int(a_vertexId);\n    }\nuniform vec4 cc_displacementWeights[15];\nuniform vec4 cc_displacementTextureInfo;\n    vec4 fetchFlatPixel(sampler2D tex, int pixelIndex) {\n        float pixelIndexF = float(pixelIndex);\n        vec2 textureResolution = vec2(float(cc_displacementTextureInfo.x), float(cc_displacementTextureInfo.y));\n        float pixelX = mod(pixelIndexF, textureResolution.x);\n        float pixelY = floor(pixelIndexF / textureResolution.x);\n        vec2 uv = (vec2(pixelX, pixelY) + .5) / textureResolution;\n        return texture2D(tex, uv);\n    }\nfloat getDisplacementWeight(int index) {\n    float m = mod(float(index), 4.0);\n    if (m < 1.0) {\n        return cc_displacementWeights[index / 4].x;\n    } else if (m < 2.0) {\n        return cc_displacementWeights[index / 4].y;\n    } else if (m < 3.0) {\n        return cc_displacementWeights[index / 4].z;\n    } else {\n        return cc_displacementWeights[index / 4].w;\n    }\n}\nvec3 getVec3DisplacementFromTexture(sampler2D tex, int vertexIndex) {\n#if CC_MORPH_PRECOMPUTED\n    return fetchFlatPixel(tex, vertexIndex).rgb;\n#else\n    vec3 result = vec3(0, 0, 0);\n    for (int iTarget = 0; iTarget < CC_MORPH_TARGET_COUNT; ++iTarget) {\n        int dataPixelStart = int(fetchFlatPixel(tex, iTarget).r);\n        result += (fetchFlatPixel(tex, dataPixelStart + vertexIndex).rgb * getDisplacementWeight(iTarget));\n    }\n    return result;\n#endif\n}\n#if CC_MORPH_TARGET_HAS_POSITION\n    uniform sampler2D cc_PositionDisplacements;\n    vec3 getPositionDisplacement(int vertexId) {\n        return getVec3DisplacementFromTexture(cc_PositionDisplacements, vertexId);\n    }\n#endif\n#if CC_MORPH_TARGET_HAS_NORMAL\n    uniform sampler2D cc_NormalDisplacements;\n    vec3 getNormalDisplacement(int vertexId) {\n        return getVec3DisplacementFromTexture(cc_NormalDisplacements, vertexId);\n    }\n#endif\n#if CC_MORPH_TARGET_HAS_TANGENT\n    uniform sampler2D cc_TangentDisplacements;\n    vec3 getTangentDisplacement(int vertexId) {\n        return getVec3DisplacementFromTexture(cc_TangentDisplacements, vertexId);\n    }\n#endif\nvoid applyMorph (inout StandardVertInput attr) {\n    int vertexId = getVertexId();\n#if CC_MORPH_TARGET_HAS_POSITION\n    attr.position.xyz = attr.position.xyz + getPositionDisplacement(vertexId);\n#endif\n#if CC_MORPH_TARGET_HAS_NORMAL\n    attr.normal.xyz = attr.normal.xyz + getNormalDisplacement(vertexId);\n#endif\n#if CC_MORPH_TARGET_HAS_TANGENT\n    attr.tangent.xyz = attr.tangent.xyz + getTangentDisplacement(vertexId);\n#endif\n}\nvoid applyMorph (inout vec4 position) {\n#if CC_MORPH_TARGET_HAS_POSITION\n    position.xyz = position.xyz + getPositionDisplacement(getVertexId());\n#endif\n}\n#endif\n#if CC_USE_SKINNING\nattribute vec4 a_weights;\nattribute vec4 a_joints;\nhighp float decode32 (highp vec4 rgba) {\n  rgba = rgba * 255.0;\n  highp float Sign = 1.0 - step(127.99, rgba[3]) * 2.0;\n  highp float Exponent = 2.0 * mod(rgba[3], 127.99) + step(128.0, rgba[2]) - 127.0;\n  highp float Mantissa = mod(rgba[2], 128.0) * 65536.0 + rgba[1] * 256.0 + rgba[0] + 8388608.0;\n  return Sign * exp2(Exponent - 23.0) * Mantissa;\n}\n#if CC_USE_BAKED_ANIMATION\n  #if USE_INSTANCING\n    attribute highp vec4 a_jointAnimInfo;\n  #endif\n  uniform highp vec4 cc_jointTextureInfo;\n  uniform highp vec4 cc_jointAnimInfo;\n  uniform sampler2D cc_jointTexture;\n  #else\n  uniform highp vec4 cc_joints[90];\n#endif\n#if CC_USE_BAKED_ANIMATION\n  #if CC_SUPPORT_FLOAT_TEXTURE\n    mat4 getJointMatrix (float i) {\n    #if USE_INSTANCING\n      highp float j = 3.0 * (a_jointAnimInfo.x * a_jointAnimInfo.y + i) + a_jointAnimInfo.z;\n    #else\n      highp float j = 3.0 * (cc_jointAnimInfo.x * cc_jointTextureInfo.y + i) + cc_jointTextureInfo.z;\n    #endif\n    highp float invSize = cc_jointTextureInfo.w;\n    highp float y = floor(j * invSize);\n    highp float x = j - y * cc_jointTextureInfo.x;\n    y = (y + 0.5) * invSize;\n      vec4 v1 = texture2D(cc_jointTexture, vec2((x + 0.5) * invSize, y));\n      vec4 v2 = texture2D(cc_jointTexture, vec2((x + 1.5) * invSize, y));\n      vec4 v3 = texture2D(cc_jointTexture, vec2((x + 2.5) * invSize, y));\n      return mat4(vec4(v1.xyz, 0.0), vec4(v2.xyz, 0.0), vec4(v3.xyz, 0.0), vec4(v1.w, v2.w, v3.w, 1.0));\n    }\n  #else\n    mat4 getJointMatrix (float i) {\n    #if USE_INSTANCING\n      highp float j = 12.0 * (a_jointAnimInfo.x * a_jointAnimInfo.y + i) + a_jointAnimInfo.z;\n    #else\n      highp float j = 12.0 * (cc_jointAnimInfo.x * cc_jointTextureInfo.y + i) + cc_jointTextureInfo.z;\n    #endif\n    highp float invSize = cc_jointTextureInfo.w;\n    highp float y = floor(j * invSize);\n    highp float x = j - y * cc_jointTextureInfo.x;\n    y = (y + 0.5) * invSize;\n      vec4 v1 = vec4(\n        decode32(texture2D(cc_jointTexture, vec2((x + 0.5) * invSize, y))),\n        decode32(texture2D(cc_jointTexture, vec2((x + 1.5) * invSize, y))),\n        decode32(texture2D(cc_jointTexture, vec2((x + 2.5) * invSize, y))),\n        decode32(texture2D(cc_jointTexture, vec2((x + 3.5) * invSize, y)))\n      );\n      vec4 v2 = vec4(\n        decode32(texture2D(cc_jointTexture, vec2((x + 4.5) * invSize, y))),\n        decode32(texture2D(cc_jointTexture, vec2((x + 5.5) * invSize, y))),\n        decode32(texture2D(cc_jointTexture, vec2((x + 6.5) * invSize, y))),\n        decode32(texture2D(cc_jointTexture, vec2((x + 7.5) * invSize, y)))\n      );\n      vec4 v3 = vec4(\n        decode32(texture2D(cc_jointTexture, vec2((x + 8.5) * invSize, y))),\n        decode32(texture2D(cc_jointTexture, vec2((x + 9.5) * invSize, y))),\n        decode32(texture2D(cc_jointTexture, vec2((x + 10.5) * invSize, y))),\n        decode32(texture2D(cc_jointTexture, vec2((x + 11.5) * invSize, y)))\n      );\n      return mat4(vec4(v1.xyz, 0.0), vec4(v2.xyz, 0.0), vec4(v3.xyz, 0.0), vec4(v1.w, v2.w, v3.w, 1.0));\n    }\n  #endif\n#else\n  mat4 getJointMatrix (float i) {\n    int idx = int(i);\n    vec4 v1 = cc_joints[idx * 3];\n    vec4 v2 = cc_joints[idx * 3 + 1];\n    vec4 v3 = cc_joints[idx * 3 + 2];\n    return mat4(vec4(v1.xyz, 0.0), vec4(v2.xyz, 0.0), vec4(v3.xyz, 0.0), vec4(v1.w, v2.w, v3.w, 1.0));\n  }\n#endif\nmat4 skinMatrix () {\n  return getJointMatrix(a_joints.x) * a_weights.x\n       + getJointMatrix(a_joints.y) * a_weights.y\n       + getJointMatrix(a_joints.z) * a_weights.z\n       + getJointMatrix(a_joints.w) * a_weights.w;\n}\nvoid CCSkin (inout vec4 position) {\n  mat4 m = skinMatrix();\n  position = m * position;\n}\nvoid CCSkin (inout StandardVertInput attr) {\n  mat4 m = skinMatrix();\n  attr.position = m * attr.position;\n  attr.normal = (m * vec4(attr.normal, 0.0)).xyz;\n  attr.tangent.xyz = (m * vec4(attr.tangent.xyz, 0.0)).xyz;\n}\n#endif\nuniform highp mat4 cc_matView;\nuniform highp mat4 cc_matProj;\n#if USE_INSTANCING\n  attribute vec4 a_matWorld0;\n  attribute vec4 a_matWorld1;\n  attribute vec4 a_matWorld2;\n#elif USE_BATCHING\n  attribute float a_dyn_batch_id;\n  uniform highp mat4 cc_matWorlds[10];\n#else\nuniform highp mat4 cc_matWorld;\n#endif\n#if USE_VERTEX_COLOR\n  attribute vec4 a_color;\n  varying vec4 v_color;\n#endif\n#if USE_TEXTURE\n  attribute vec2 a_texCoord;\n  varying vec2 v_uv;\n  uniform vec4 tilingOffset;\n#endif\nvec4 vert () {\n  vec4 position;\n  position = vec4(a_position, 1.0);\n  #if CC_USE_MORPH\n    applyMorph(position);\n  #endif\n  #if CC_USE_SKINNING\n    CCSkin(position);\n  #endif\n  mat4 matWorld;\n  #if USE_INSTANCING\n    matWorld = mat4(\n      vec4(a_matWorld0.xyz, 0.0),\n      vec4(a_matWorld1.xyz, 0.0),\n      vec4(a_matWorld2.xyz, 0.0),\n      vec4(a_matWorld0.w, a_matWorld1.w, a_matWorld2.w, 1.0)\n    );\n  #elif USE_BATCHING\n    matWorld = cc_matWorlds[int(a_dyn_batch_id)];\n  #else\n    matWorld = cc_matWorld;\n  #endif\n  #if USE_TEXTURE\n    v_uv = a_texCoord;\n    #if FLIP_UV\n      v_uv.y = 1.0 - v_uv.y;\n    #endif\n    v_uv = v_uv * tilingOffset.xy + tilingOffset.zw;\n  #endif\n  #if USE_VERTEX_COLOR\n    v_color = a_color;\n  #endif\n  return cc_matProj * (cc_matView * matWorld) * position;\n}\nvoid main() { gl_Position = vert(); }",frag:"\nprecision mediump float;\nuniform mediump vec4 cc_exposure;\nvec3 SRGBToLinear (vec3 gamma) {\n  return gamma * gamma;\n}\nvec4 CCFragOutput (vec4 color) {\n  #if CC_USE_HDR\n    color.rgb = mix(color.rgb, SRGBToLinear(color.rgb) * cc_exposure.w, vec3(cc_exposure.z));\n  #endif\n  return color;\n}\n#if USE_ALPHA_TEST\n#endif\n#if USE_TEXTURE\n  varying vec2 v_uv;\n  uniform sampler2D mainTexture;\n#endif\nuniform vec4 mainColor;\nuniform vec4 colorScaleAndCutoff;\n#if USE_VERTEX_COLOR\n  varying vec4 v_color;\n#endif\nvec4 frag () {\n  vec4 o = mainColor;\n  o.rgb *= colorScaleAndCutoff.xyz;\n  #if USE_VERTEX_COLOR\n    o *= v_color;\n  #endif\n  #if USE_TEXTURE\n    o *= texture2D(mainTexture, v_uv);\n  #endif\n  #if USE_ALPHA_TEST\n    if (o.ALPHA_TEST_CHANNEL < colorScaleAndCutoff.w) discard;\n  #endif\n  return CCFragOutput(o);\n}\nvoid main() { gl_FragColor = frag(); }"},builtins:{globals:{blocks:[{name:"CCGlobal",defines:[]}],samplers:[]},locals:{blocks:[{name:"CCMorph",defines:["CC_USE_MORPH"]},{name:"CCSkinningTexture",defines:["CC_USE_SKINNING","CC_USE_BAKED_ANIMATION"]},{name:"CCSkinningAnimation",defines:["CC_USE_SKINNING","CC_USE_BAKED_ANIMATION"]},{name:"CCSkinning",defines:["CC_USE_SKINNING","!CC_USE_BAKED_ANIMATION"]},{name:"CCLocalBatched",defines:["!USE_INSTANCING","USE_BATCHING"]},{name:"CCLocal",defines:["!USE_INSTANCING","!USE_BATCHING"]}],samplers:[{name:"cc_PositionDisplacements",defines:["CC_USE_MORPH","CC_MORPH_TARGET_HAS_POSITION"]},{name:"cc_NormalDisplacements",defines:["CC_USE_MORPH","CC_MORPH_TARGET_HAS_NORMAL"]},{name:"cc_TangentDisplacements",defines:["CC_USE_MORPH","CC_MORPH_TARGET_HAS_TANGENT"]},{name:"cc_jointTexture",defines:["CC_USE_SKINNING","CC_USE_BAKED_ANIMATION"]}]}},defines:[{name:"CC_USE_MORPH",type:"boolean"},{name:"CC_MORPH_TARGET_COUNT",type:"number",range:[2,8]},{name:"CC_MORPH_PRECOMPUTED",type:"boolean"},{name:"CC_MORPH_TARGET_HAS_POSITION",type:"boolean"},{name:"CC_MORPH_TARGET_HAS_NORMAL",type:"boolean"},{name:"CC_MORPH_TARGET_HAS_TANGENT",type:"boolean"},{name:"CC_USE_SKINNING",type:"boolean"},{name:"CC_USE_BAKED_ANIMATION",type:"boolean"},{name:"USE_INSTANCING",type:"boolean"},{name:"CC_SUPPORT_FLOAT_TEXTURE",type:"boolean"},{name:"USE_BATCHING",type:"boolean"},{name:"USE_VERTEX_COLOR",type:"boolean"},{name:"USE_TEXTURE",type:"boolean"},{name:"FLIP_UV",type:"boolean"},{name:"CC_USE_HDR",type:"boolean"},{name:"USE_ALPHA_TEST",type:"boolean"},{name:"ALPHA_TEST_CHANNEL",type:"string",options:["a","r","g","b"]}],blocks:[{name:"TexCoords",defines:["USE_TEXTURE"],binding:0,members:[{name:"tilingOffset",type:16,count:1}]},{name:"Constant",defines:[],binding:1,members:[{name:"mainColor",type:16,count:1},{name:"colorScaleAndCutoff",type:16,count:1}]}],samplers:[{name:"mainTexture",type:28,count:1,defines:["USE_TEXTURE"],binding:31}],attributes:[{name:"a_position",type:15,count:1,defines:[],format:32,location:0},{name:"a_vertexId",type:13,count:1,defines:["CC_USE_MORPH"],format:11,location:1},{name:"a_weights",type:16,count:1,defines:["CC_USE_SKINNING"],format:43,location:2},{name:"a_joints",type:16,count:1,defines:["CC_USE_SKINNING"],format:43,location:3},{name:"a_jointAnimInfo",type:16,count:1,precision:"highp ",defines:["CC_USE_SKINNING","CC_USE_BAKED_ANIMATION","USE_INSTANCING"],format:43,isInstanced:!0,location:4},{name:"a_matWorld0",type:16,count:1,defines:["USE_INSTANCING"],format:43,isInstanced:!0,location:5},{name:"a_matWorld1",type:16,count:1,defines:["USE_INSTANCING"],format:43,isInstanced:!0,location:6},{name:"a_matWorld2",type:16,count:1,defines:["USE_INSTANCING"],format:43,isInstanced:!0,location:7},{name:"a_dyn_batch_id",type:13,count:1,defines:["!USE_INSTANCING","USE_BATCHING"],format:11,location:8},{name:"a_color",type:16,count:1,defines:["USE_VERTEX_COLOR"],format:43,location:9},{name:"a_texCoord",type:14,count:1,defines:["USE_TEXTURE"],format:21,location:10}]}]},{name:"pipeline/planar-shadow",_uuid:"9361fd90-ba52-4f84-aa93-6e878fd576ca",techniques:[{passes:[{phase:"planarShadow",blendState:{targets:[{blend:!0,blendSrc:2,blendDst:4,blendDstAlpha:4}]},program:"pipeline/planar-shadow|planar-shadow-vs:vert|planar-shadow-fs:frag",depthStencilState:{depthTest:!0,depthWrite:!1,stencilTestFront:!0,stencilFuncFront:5,stencilPassOpFront:2,stencilRefBack:128,stencilRefFront:128,stencilReadMaskBack:128,stencilReadMaskFront:128,stencilWriteMaskBack:128,stencilWriteMaskFront:128}}]}],shaders:[{name:"pipeline/planar-shadow|planar-shadow-vs:vert|planar-shadow-fs:frag",hash:3225402078,glsl3:{vert:"\nprecision highp float;\nstruct StandardVertInput {\n  highp vec4 position;\n  vec3 normal;\n  vec4 tangent;\n};\nin vec3 a_position;\n#if CC_USE_MORPH\n    in float a_vertexId;\n    int getVertexId() {\n        return int(a_vertexId);\n    }\nuniform CCMorph {\n    vec4 cc_displacementWeights[15];\n    vec4 cc_displacementTextureInfo;\n};\n    vec4 fetchFlatPixel(sampler2D tex, int pixelIndex) {\n        float pixelIndexF = float(pixelIndex);\n        vec2 textureResolution = vec2(float(cc_displacementTextureInfo.x), float(cc_displacementTextureInfo.y));\n        float pixelX = mod(pixelIndexF, textureResolution.x);\n        float pixelY = floor(pixelIndexF / textureResolution.x);\n        vec2 uv = (vec2(pixelX, pixelY) + .5) / textureResolution;\n        return texture(tex, uv);\n    }\nfloat getDisplacementWeight(int index) {\n    float m = mod(float(index), 4.0);\n    if (m < 1.0) {\n        return cc_displacementWeights[index / 4].x;\n    } else if (m < 2.0) {\n        return cc_displacementWeights[index / 4].y;\n    } else if (m < 3.0) {\n        return cc_displacementWeights[index / 4].z;\n    } else {\n        return cc_displacementWeights[index / 4].w;\n    }\n}\nvec3 getVec3DisplacementFromTexture(sampler2D tex, int vertexIndex) {\n#if CC_MORPH_PRECOMPUTED\n    return fetchFlatPixel(tex, vertexIndex).rgb;\n#else\n    vec3 result = vec3(0, 0, 0);\n    for (int iTarget = 0; iTarget < CC_MORPH_TARGET_COUNT; ++iTarget) {\n        int dataPixelStart = int(fetchFlatPixel(tex, iTarget).r);\n        result += (fetchFlatPixel(tex, dataPixelStart + vertexIndex).rgb * getDisplacementWeight(iTarget));\n    }\n    return result;\n#endif\n}\n#if CC_MORPH_TARGET_HAS_POSITION\n    uniform sampler2D cc_PositionDisplacements;\n    vec3 getPositionDisplacement(int vertexId) {\n        return getVec3DisplacementFromTexture(cc_PositionDisplacements, vertexId);\n    }\n#endif\n#if CC_MORPH_TARGET_HAS_NORMAL\n    uniform sampler2D cc_NormalDisplacements;\n    vec3 getNormalDisplacement(int vertexId) {\n        return getVec3DisplacementFromTexture(cc_NormalDisplacements, vertexId);\n    }\n#endif\n#if CC_MORPH_TARGET_HAS_TANGENT\n    uniform sampler2D cc_TangentDisplacements;\n    vec3 getTangentDisplacement(int vertexId) {\n        return getVec3DisplacementFromTexture(cc_TangentDisplacements, vertexId);\n    }\n#endif\nvoid applyMorph (inout StandardVertInput attr) {\n    int vertexId = getVertexId();\n#if CC_MORPH_TARGET_HAS_POSITION\n    attr.position.xyz = attr.position.xyz + getPositionDisplacement(vertexId);\n#endif\n#if CC_MORPH_TARGET_HAS_NORMAL\n    attr.normal.xyz = attr.normal.xyz + getNormalDisplacement(vertexId);\n#endif\n#if CC_MORPH_TARGET_HAS_TANGENT\n    attr.tangent.xyz = attr.tangent.xyz + getTangentDisplacement(vertexId);\n#endif\n}\nvoid applyMorph (inout vec4 position) {\n#if CC_MORPH_TARGET_HAS_POSITION\n    position.xyz = position.xyz + getPositionDisplacement(getVertexId());\n#endif\n}\n#endif\n#if CC_USE_SKINNING\nin vec4 a_weights;\nin vec4 a_joints;\nhighp float decode32 (highp vec4 rgba) {\n  rgba = rgba * 255.0;\n  highp float Sign = 1.0 - step(127.99, rgba[3]) * 2.0;\n  highp float Exponent = 2.0 * mod(rgba[3], 127.99) + step(128.0, rgba[2]) - 127.0;\n  highp float Mantissa = mod(rgba[2], 128.0) * 65536.0 + rgba[1] * 256.0 + rgba[0] + 8388608.0;\n  return Sign * exp2(Exponent - 23.0) * Mantissa;\n}\n#if CC_USE_BAKED_ANIMATION\n  #if USE_INSTANCING\n    in highp vec4 a_jointAnimInfo;\n  #endif\n  uniform CCSkinningTexture {\n    highp vec4 cc_jointTextureInfo;\n  };\n  uniform CCSkinningAnimation {\n    highp vec4 cc_jointAnimInfo;\n  };\n  uniform sampler2D cc_jointTexture;\n  #else\n  uniform CCSkinning {\n    highp vec4 cc_joints[30 * 3];\n  };\n#endif\n#if CC_USE_BAKED_ANIMATION\n  #if CC_SUPPORT_FLOAT_TEXTURE\n    mat4 getJointMatrix (float i) {\n    #if USE_INSTANCING\n      highp float j = 3.0 * (a_jointAnimInfo.x * a_jointAnimInfo.y + i) + a_jointAnimInfo.z;\n    #else\n      highp float j = 3.0 * (cc_jointAnimInfo.x * cc_jointTextureInfo.y + i) + cc_jointTextureInfo.z;\n    #endif\n    highp float invSize = cc_jointTextureInfo.w;\n    highp float y = floor(j * invSize);\n    highp float x = j - y * cc_jointTextureInfo.x;\n    y = (y + 0.5) * invSize;\n      vec4 v1 = texture(cc_jointTexture, vec2((x + 0.5) * invSize, y));\n      vec4 v2 = texture(cc_jointTexture, vec2((x + 1.5) * invSize, y));\n      vec4 v3 = texture(cc_jointTexture, vec2((x + 2.5) * invSize, y));\n      return mat4(vec4(v1.xyz, 0.0), vec4(v2.xyz, 0.0), vec4(v3.xyz, 0.0), vec4(v1.w, v2.w, v3.w, 1.0));\n    }\n  #else\n    mat4 getJointMatrix (float i) {\n    #if USE_INSTANCING\n      highp float j = 12.0 * (a_jointAnimInfo.x * a_jointAnimInfo.y + i) + a_jointAnimInfo.z;\n    #else\n      highp float j = 12.0 * (cc_jointAnimInfo.x * cc_jointTextureInfo.y + i) + cc_jointTextureInfo.z;\n    #endif\n    highp float invSize = cc_jointTextureInfo.w;\n    highp float y = floor(j * invSize);\n    highp float x = j - y * cc_jointTextureInfo.x;\n    y = (y + 0.5) * invSize;\n      vec4 v1 = vec4(\n        decode32(texture(cc_jointTexture, vec2((x + 0.5) * invSize, y))),\n        decode32(texture(cc_jointTexture, vec2((x + 1.5) * invSize, y))),\n        decode32(texture(cc_jointTexture, vec2((x + 2.5) * invSize, y))),\n        decode32(texture(cc_jointTexture, vec2((x + 3.5) * invSize, y)))\n      );\n      vec4 v2 = vec4(\n        decode32(texture(cc_jointTexture, vec2((x + 4.5) * invSize, y))),\n        decode32(texture(cc_jointTexture, vec2((x + 5.5) * invSize, y))),\n        decode32(texture(cc_jointTexture, vec2((x + 6.5) * invSize, y))),\n        decode32(texture(cc_jointTexture, vec2((x + 7.5) * invSize, y)))\n      );\n      vec4 v3 = vec4(\n        decode32(texture(cc_jointTexture, vec2((x + 8.5) * invSize, y))),\n        decode32(texture(cc_jointTexture, vec2((x + 9.5) * invSize, y))),\n        decode32(texture(cc_jointTexture, vec2((x + 10.5) * invSize, y))),\n        decode32(texture(cc_jointTexture, vec2((x + 11.5) * invSize, y)))\n      );\n      return mat4(vec4(v1.xyz, 0.0), vec4(v2.xyz, 0.0), vec4(v3.xyz, 0.0), vec4(v1.w, v2.w, v3.w, 1.0));\n    }\n  #endif\n#else\n  mat4 getJointMatrix (float i) {\n    int idx = int(i);\n    vec4 v1 = cc_joints[idx * 3];\n    vec4 v2 = cc_joints[idx * 3 + 1];\n    vec4 v3 = cc_joints[idx * 3 + 2];\n    return mat4(vec4(v1.xyz, 0.0), vec4(v2.xyz, 0.0), vec4(v3.xyz, 0.0), vec4(v1.w, v2.w, v3.w, 1.0));\n  }\n#endif\nmat4 skinMatrix () {\n  return getJointMatrix(a_joints.x) * a_weights.x\n       + getJointMatrix(a_joints.y) * a_weights.y\n       + getJointMatrix(a_joints.z) * a_weights.z\n       + getJointMatrix(a_joints.w) * a_weights.w;\n}\nvoid CCSkin (inout vec4 position) {\n  mat4 m = skinMatrix();\n  position = m * position;\n}\nvoid CCSkin (inout StandardVertInput attr) {\n  mat4 m = skinMatrix();\n  attr.position = m * attr.position;\n  attr.normal = (m * vec4(attr.normal, 0.0)).xyz;\n  attr.tangent.xyz = (m * vec4(attr.tangent.xyz, 0.0)).xyz;\n}\n#endif\nuniform CCGlobal {\n  highp   vec4 cc_time;\n  mediump vec4 cc_screenSize;\n  mediump vec4 cc_screenScale;\n  mediump vec4 cc_nativeSize;\n  highp   mat4 cc_matView;\n  highp   mat4 cc_matViewInv;\n  highp   mat4 cc_matProj;\n  highp   mat4 cc_matProjInv;\n  highp   mat4 cc_matViewProj;\n  highp   mat4 cc_matViewProjInv;\n  highp   vec4 cc_cameraPos;\n  mediump vec4 cc_exposure;\n  mediump vec4 cc_mainLitDir;\n  mediump vec4 cc_mainLitColor;\n  mediump vec4 cc_ambientSky;\n  mediump vec4 cc_ambientGround;\n};\n#if USE_INSTANCING\n  in vec4 a_matWorld0;\n  in vec4 a_matWorld1;\n  in vec4 a_matWorld2;\n#elif USE_BATCHING\n  in float a_dyn_batch_id;\n  uniform CCLocalBatched {\n    highp mat4 cc_matWorlds[10];\n  };\n#else\nuniform CCLocal {\n  highp mat4 cc_matWorld;\n  highp mat4 cc_matWorldIT;\n  highp vec4 cc_lightingMapUVParam;\n};\n#endif\nuniform CCShadow {\n  highp mat4 cc_matLightPlaneProj;\n  lowp vec4 cc_shadowColor;\n};\nvec4 vert () {\n  vec4 position;\n  position = vec4(a_position, 1.0);\n  #if CC_USE_MORPH\n    applyMorph(position);\n  #endif\n  #if CC_USE_SKINNING\n    CCSkin(position);\n  #endif\n  mat4 matWorld;\n  #if USE_INSTANCING\n    matWorld = mat4(\n      vec4(a_matWorld0.xyz, 0.0),\n      vec4(a_matWorld1.xyz, 0.0),\n      vec4(a_matWorld2.xyz, 0.0),\n      vec4(a_matWorld0.w, a_matWorld1.w, a_matWorld2.w, 1.0)\n    );\n  #elif USE_BATCHING\n    matWorld = cc_matWorlds[int(a_dyn_batch_id)];\n  #else\n    matWorld = cc_matWorld;\n  #endif\n  position = cc_matProj * (cc_matView * cc_matLightPlaneProj * matWorld) * position;\n  position.z -= 0.0001;\n  return position;\n}\nvoid main() { gl_Position = vert(); }",frag:"\nprecision mediump float;\nuniform CCShadow {\n  highp mat4 cc_matLightPlaneProj;\n  lowp vec4 cc_shadowColor;\n};\nuniform CCGlobal {\n  highp   vec4 cc_time;\n  mediump vec4 cc_screenSize;\n  mediump vec4 cc_screenScale;\n  mediump vec4 cc_nativeSize;\n  highp   mat4 cc_matView;\n  highp   mat4 cc_matViewInv;\n  highp   mat4 cc_matProj;\n  highp   mat4 cc_matProjInv;\n  highp   mat4 cc_matViewProj;\n  highp   mat4 cc_matViewProjInv;\n  highp   vec4 cc_cameraPos;\n  mediump vec4 cc_exposure;\n  mediump vec4 cc_mainLitDir;\n  mediump vec4 cc_mainLitColor;\n  mediump vec4 cc_ambientSky;\n  mediump vec4 cc_ambientGround;\n};\nvec3 SRGBToLinear (vec3 gamma) {\n  return gamma * gamma;\n}\nvec4 CCFragOutput (vec4 color) {\n  #if CC_USE_HDR\n    color.rgb = mix(color.rgb, SRGBToLinear(color.rgb) * cc_exposure.w, vec3(cc_exposure.z));\n  #endif\n  return color;\n}\nvec4 frag () {\n  return CCFragOutput(cc_shadowColor);\n}\nout vec4 cc_FragColor;\nvoid main() { cc_FragColor = frag(); }"},glsl1:{vert:"\nprecision highp float;\nstruct StandardVertInput {\n  highp vec4 position;\n  vec3 normal;\n  vec4 tangent;\n};\nattribute vec3 a_position;\n#if CC_USE_MORPH\n    attribute float a_vertexId;\n    int getVertexId() {\n        return int(a_vertexId);\n    }\nuniform vec4 cc_displacementWeights[15];\nuniform vec4 cc_displacementTextureInfo;\n    vec4 fetchFlatPixel(sampler2D tex, int pixelIndex) {\n        float pixelIndexF = float(pixelIndex);\n        vec2 textureResolution = vec2(float(cc_displacementTextureInfo.x), float(cc_displacementTextureInfo.y));\n        float pixelX = mod(pixelIndexF, textureResolution.x);\n        float pixelY = floor(pixelIndexF / textureResolution.x);\n        vec2 uv = (vec2(pixelX, pixelY) + .5) / textureResolution;\n        return texture2D(tex, uv);\n    }\nfloat getDisplacementWeight(int index) {\n    float m = mod(float(index), 4.0);\n    if (m < 1.0) {\n        return cc_displacementWeights[index / 4].x;\n    } else if (m < 2.0) {\n        return cc_displacementWeights[index / 4].y;\n    } else if (m < 3.0) {\n        return cc_displacementWeights[index / 4].z;\n    } else {\n        return cc_displacementWeights[index / 4].w;\n    }\n}\nvec3 getVec3DisplacementFromTexture(sampler2D tex, int vertexIndex) {\n#if CC_MORPH_PRECOMPUTED\n    return fetchFlatPixel(tex, vertexIndex).rgb;\n#else\n    vec3 result = vec3(0, 0, 0);\n    for (int iTarget = 0; iTarget < CC_MORPH_TARGET_COUNT; ++iTarget) {\n        int dataPixelStart = int(fetchFlatPixel(tex, iTarget).r);\n        result += (fetchFlatPixel(tex, dataPixelStart + vertexIndex).rgb * getDisplacementWeight(iTarget));\n    }\n    return result;\n#endif\n}\n#if CC_MORPH_TARGET_HAS_POSITION\n    uniform sampler2D cc_PositionDisplacements;\n    vec3 getPositionDisplacement(int vertexId) {\n        return getVec3DisplacementFromTexture(cc_PositionDisplacements, vertexId);\n    }\n#endif\n#if CC_MORPH_TARGET_HAS_NORMAL\n    uniform sampler2D cc_NormalDisplacements;\n    vec3 getNormalDisplacement(int vertexId) {\n        return getVec3DisplacementFromTexture(cc_NormalDisplacements, vertexId);\n    }\n#endif\n#if CC_MORPH_TARGET_HAS_TANGENT\n    uniform sampler2D cc_TangentDisplacements;\n    vec3 getTangentDisplacement(int vertexId) {\n        return getVec3DisplacementFromTexture(cc_TangentDisplacements, vertexId);\n    }\n#endif\nvoid applyMorph (inout StandardVertInput attr) {\n    int vertexId = getVertexId();\n#if CC_MORPH_TARGET_HAS_POSITION\n    attr.position.xyz = attr.position.xyz + getPositionDisplacement(vertexId);\n#endif\n#if CC_MORPH_TARGET_HAS_NORMAL\n    attr.normal.xyz = attr.normal.xyz + getNormalDisplacement(vertexId);\n#endif\n#if CC_MORPH_TARGET_HAS_TANGENT\n    attr.tangent.xyz = attr.tangent.xyz + getTangentDisplacement(vertexId);\n#endif\n}\nvoid applyMorph (inout vec4 position) {\n#if CC_MORPH_TARGET_HAS_POSITION\n    position.xyz = position.xyz + getPositionDisplacement(getVertexId());\n#endif\n}\n#endif\n#if CC_USE_SKINNING\nattribute vec4 a_weights;\nattribute vec4 a_joints;\nhighp float decode32 (highp vec4 rgba) {\n  rgba = rgba * 255.0;\n  highp float Sign = 1.0 - step(127.99, rgba[3]) * 2.0;\n  highp float Exponent = 2.0 * mod(rgba[3], 127.99) + step(128.0, rgba[2]) - 127.0;\n  highp float Mantissa = mod(rgba[2], 128.0) * 65536.0 + rgba[1] * 256.0 + rgba[0] + 8388608.0;\n  return Sign * exp2(Exponent - 23.0) * Mantissa;\n}\n#if CC_USE_BAKED_ANIMATION\n  #if USE_INSTANCING\n    attribute highp vec4 a_jointAnimInfo;\n  #endif\n  uniform highp vec4 cc_jointTextureInfo;\n  uniform highp vec4 cc_jointAnimInfo;\n  uniform sampler2D cc_jointTexture;\n  #else\n  uniform highp vec4 cc_joints[90];\n#endif\n#if CC_USE_BAKED_ANIMATION\n  #if CC_SUPPORT_FLOAT_TEXTURE\n    mat4 getJointMatrix (float i) {\n    #if USE_INSTANCING\n      highp float j = 3.0 * (a_jointAnimInfo.x * a_jointAnimInfo.y + i) + a_jointAnimInfo.z;\n    #else\n      highp float j = 3.0 * (cc_jointAnimInfo.x * cc_jointTextureInfo.y + i) + cc_jointTextureInfo.z;\n    #endif\n    highp float invSize = cc_jointTextureInfo.w;\n    highp float y = floor(j * invSize);\n    highp float x = j - y * cc_jointTextureInfo.x;\n    y = (y + 0.5) * invSize;\n      vec4 v1 = texture2D(cc_jointTexture, vec2((x + 0.5) * invSize, y));\n      vec4 v2 = texture2D(cc_jointTexture, vec2((x + 1.5) * invSize, y));\n      vec4 v3 = texture2D(cc_jointTexture, vec2((x + 2.5) * invSize, y));\n      return mat4(vec4(v1.xyz, 0.0), vec4(v2.xyz, 0.0), vec4(v3.xyz, 0.0), vec4(v1.w, v2.w, v3.w, 1.0));\n    }\n  #else\n    mat4 getJointMatrix (float i) {\n    #if USE_INSTANCING\n      highp float j = 12.0 * (a_jointAnimInfo.x * a_jointAnimInfo.y + i) + a_jointAnimInfo.z;\n    #else\n      highp float j = 12.0 * (cc_jointAnimInfo.x * cc_jointTextureInfo.y + i) + cc_jointTextureInfo.z;\n    #endif\n    highp float invSize = cc_jointTextureInfo.w;\n    highp float y = floor(j * invSize);\n    highp float x = j - y * cc_jointTextureInfo.x;\n    y = (y + 0.5) * invSize;\n      vec4 v1 = vec4(\n        decode32(texture2D(cc_jointTexture, vec2((x + 0.5) * invSize, y))),\n        decode32(texture2D(cc_jointTexture, vec2((x + 1.5) * invSize, y))),\n        decode32(texture2D(cc_jointTexture, vec2((x + 2.5) * invSize, y))),\n        decode32(texture2D(cc_jointTexture, vec2((x + 3.5) * invSize, y)))\n      );\n      vec4 v2 = vec4(\n        decode32(texture2D(cc_jointTexture, vec2((x + 4.5) * invSize, y))),\n        decode32(texture2D(cc_jointTexture, vec2((x + 5.5) * invSize, y))),\n        decode32(texture2D(cc_jointTexture, vec2((x + 6.5) * invSize, y))),\n        decode32(texture2D(cc_jointTexture, vec2((x + 7.5) * invSize, y)))\n      );\n      vec4 v3 = vec4(\n        decode32(texture2D(cc_jointTexture, vec2((x + 8.5) * invSize, y))),\n        decode32(texture2D(cc_jointTexture, vec2((x + 9.5) * invSize, y))),\n        decode32(texture2D(cc_jointTexture, vec2((x + 10.5) * invSize, y))),\n        decode32(texture2D(cc_jointTexture, vec2((x + 11.5) * invSize, y)))\n      );\n      return mat4(vec4(v1.xyz, 0.0), vec4(v2.xyz, 0.0), vec4(v3.xyz, 0.0), vec4(v1.w, v2.w, v3.w, 1.0));\n    }\n  #endif\n#else\n  mat4 getJointMatrix (float i) {\n    int idx = int(i);\n    vec4 v1 = cc_joints[idx * 3];\n    vec4 v2 = cc_joints[idx * 3 + 1];\n    vec4 v3 = cc_joints[idx * 3 + 2];\n    return mat4(vec4(v1.xyz, 0.0), vec4(v2.xyz, 0.0), vec4(v3.xyz, 0.0), vec4(v1.w, v2.w, v3.w, 1.0));\n  }\n#endif\nmat4 skinMatrix () {\n  return getJointMatrix(a_joints.x) * a_weights.x\n       + getJointMatrix(a_joints.y) * a_weights.y\n       + getJointMatrix(a_joints.z) * a_weights.z\n       + getJointMatrix(a_joints.w) * a_weights.w;\n}\nvoid CCSkin (inout vec4 position) {\n  mat4 m = skinMatrix();\n  position = m * position;\n}\nvoid CCSkin (inout StandardVertInput attr) {\n  mat4 m = skinMatrix();\n  attr.position = m * attr.position;\n  attr.normal = (m * vec4(attr.normal, 0.0)).xyz;\n  attr.tangent.xyz = (m * vec4(attr.tangent.xyz, 0.0)).xyz;\n}\n#endif\nuniform highp mat4 cc_matView;\nuniform highp mat4 cc_matProj;\n#if USE_INSTANCING\n  attribute vec4 a_matWorld0;\n  attribute vec4 a_matWorld1;\n  attribute vec4 a_matWorld2;\n#elif USE_BATCHING\n  attribute float a_dyn_batch_id;\n  uniform highp mat4 cc_matWorlds[10];\n#else\nuniform highp mat4 cc_matWorld;\n#endif\nuniform highp mat4 cc_matLightPlaneProj;\nvec4 vert () {\n  vec4 position;\n  position = vec4(a_position, 1.0);\n  #if CC_USE_MORPH\n    applyMorph(position);\n  #endif\n  #if CC_USE_SKINNING\n    CCSkin(position);\n  #endif\n  mat4 matWorld;\n  #if USE_INSTANCING\n    matWorld = mat4(\n      vec4(a_matWorld0.xyz, 0.0),\n      vec4(a_matWorld1.xyz, 0.0),\n      vec4(a_matWorld2.xyz, 0.0),\n      vec4(a_matWorld0.w, a_matWorld1.w, a_matWorld2.w, 1.0)\n    );\n  #elif USE_BATCHING\n    matWorld = cc_matWorlds[int(a_dyn_batch_id)];\n  #else\n    matWorld = cc_matWorld;\n  #endif\n  position = cc_matProj * (cc_matView * cc_matLightPlaneProj * matWorld) * position;\n  position.z -= 0.0001;\n  return position;\n}\nvoid main() { gl_Position = vert(); }",frag:"\nprecision mediump float;\nuniform lowp vec4 cc_shadowColor;\nuniform mediump vec4 cc_exposure;\nvec3 SRGBToLinear (vec3 gamma) {\n  return gamma * gamma;\n}\nvec4 CCFragOutput (vec4 color) {\n  #if CC_USE_HDR\n    color.rgb = mix(color.rgb, SRGBToLinear(color.rgb) * cc_exposure.w, vec3(cc_exposure.z));\n  #endif\n  return color;\n}\nvec4 frag () {\n  return CCFragOutput(cc_shadowColor);\n}\nvoid main() { gl_FragColor = frag(); }"},builtins:{globals:{blocks:[{name:"CCGlobal",defines:[]},{name:"CCShadow",defines:[]}],samplers:[]},locals:{blocks:[{name:"CCMorph",defines:["CC_USE_MORPH"]},{name:"CCSkinningTexture",defines:["CC_USE_SKINNING","CC_USE_BAKED_ANIMATION"]},{name:"CCSkinningAnimation",defines:["CC_USE_SKINNING","CC_USE_BAKED_ANIMATION"]},{name:"CCSkinning",defines:["CC_USE_SKINNING","!CC_USE_BAKED_ANIMATION"]},{name:"CCLocalBatched",defines:["!USE_INSTANCING","USE_BATCHING"]},{name:"CCLocal",defines:["!USE_INSTANCING","!USE_BATCHING"]}],samplers:[{name:"cc_PositionDisplacements",defines:["CC_USE_MORPH","CC_MORPH_TARGET_HAS_POSITION"]},{name:"cc_NormalDisplacements",defines:["CC_USE_MORPH","CC_MORPH_TARGET_HAS_NORMAL"]},{name:"cc_TangentDisplacements",defines:["CC_USE_MORPH","CC_MORPH_TARGET_HAS_TANGENT"]},{name:"cc_jointTexture",defines:["CC_USE_SKINNING","CC_USE_BAKED_ANIMATION"]}]}},defines:[{name:"CC_USE_MORPH",type:"boolean"},{name:"CC_MORPH_TARGET_COUNT",type:"number",range:[2,8]},{name:"CC_MORPH_PRECOMPUTED",type:"boolean"},{name:"CC_MORPH_TARGET_HAS_POSITION",type:"boolean"},{name:"CC_MORPH_TARGET_HAS_NORMAL",type:"boolean"},{name:"CC_MORPH_TARGET_HAS_TANGENT",type:"boolean"},{name:"CC_USE_SKINNING",type:"boolean"},{name:"CC_USE_BAKED_ANIMATION",type:"boolean"},{name:"USE_INSTANCING",type:"boolean"},{name:"CC_SUPPORT_FLOAT_TEXTURE",type:"boolean"},{name:"USE_BATCHING",type:"boolean"},{name:"CC_USE_HDR",type:"boolean"}],blocks:[],samplers:[],attributes:[{name:"a_position",type:15,count:1,defines:[],format:32,location:0},{name:"a_vertexId",type:13,count:1,defines:["CC_USE_MORPH"],format:11,location:1},{name:"a_weights",type:16,count:1,defines:["CC_USE_SKINNING"],format:43,location:2},{name:"a_joints",type:16,count:1,defines:["CC_USE_SKINNING"],format:43,location:3},{name:"a_jointAnimInfo",type:16,count:1,precision:"highp ",defines:["CC_USE_SKINNING","CC_USE_BAKED_ANIMATION","USE_INSTANCING"],format:43,isInstanced:!0,location:4},{name:"a_matWorld0",type:16,count:1,defines:["USE_INSTANCING"],format:43,isInstanced:!0,location:5},{name:"a_matWorld1",type:16,count:1,defines:["USE_INSTANCING"],format:43,isInstanced:!0,location:6},{name:"a_matWorld2",type:16,count:1,defines:["USE_INSTANCING"],format:43,isInstanced:!0,location:7},{name:"a_dyn_batch_id",type:13,count:1,defines:["!USE_INSTANCING","USE_BATCHING"],format:11,location:8}]}]},{name:"pipeline/skybox",_uuid:"511d2633-09a7-4bdd-ac42-f778032124b3",techniques:[{passes:[{rasterizerState:{cullMode:0},program:"pipeline/skybox|sky-vs:vert|sky-fs:frag",priority:245,depthStencilState:{depthTest:!0,depthWrite:!1}}]}],shaders:[{name:"pipeline/skybox|sky-vs:vert|sky-fs:frag",hash:1449700672,glsl3:{vert:"\nprecision highp float;\nuniform CCGlobal {\n  highp   vec4 cc_time;\n  mediump vec4 cc_screenSize;\n  mediump vec4 cc_screenScale;\n  mediump vec4 cc_nativeSize;\n  highp   mat4 cc_matView;\n  highp   mat4 cc_matViewInv;\n  highp   mat4 cc_matProj;\n  highp   mat4 cc_matProjInv;\n  highp   mat4 cc_matViewProj;\n  highp   mat4 cc_matViewProjInv;\n  highp   vec4 cc_cameraPos;\n  mediump vec4 cc_exposure;\n  mediump vec4 cc_mainLitDir;\n  mediump vec4 cc_mainLitColor;\n  mediump vec4 cc_ambientSky;\n  mediump vec4 cc_ambientGround;\n};\nstruct StandardVertInput {\n  highp vec4 position;\n  vec3 normal;\n  vec4 tangent;\n};\nin vec3 a_position;\nout vec4 viewDir;\nvec4 vert () {\n  viewDir = vec4(a_position, 1.0);\n  mat4 matViewRotOnly = mat4(mat3(cc_matView));\n  vec4 pos = matViewRotOnly * viewDir;\n  vec2 f = cc_matProj[3][3] > 0.0 ? vec2(4.8, 2.4) : vec2(cc_matProj[1][1]);\n  pos.xy *= vec2(cc_screenSize.y * cc_screenSize.z, 1.0) * f;\n  pos.zw = vec2(-0.99999 * pos.z, -pos.z);\n  return pos;\n}\nvoid main() { gl_Position = vert(); }",frag:"\nprecision mediump float;\nuniform CCGlobal {\n  highp   vec4 cc_time;\n  mediump vec4 cc_screenSize;\n  mediump vec4 cc_screenScale;\n  mediump vec4 cc_nativeSize;\n  highp   mat4 cc_matView;\n  highp   mat4 cc_matViewInv;\n  highp   mat4 cc_matProj;\n  highp   mat4 cc_matProjInv;\n  highp   mat4 cc_matViewProj;\n  highp   mat4 cc_matViewProjInv;\n  highp   vec4 cc_cameraPos;\n  mediump vec4 cc_exposure;\n  mediump vec4 cc_mainLitDir;\n  mediump vec4 cc_mainLitColor;\n  mediump vec4 cc_ambientSky;\n  mediump vec4 cc_ambientGround;\n};\nuniform samplerCube cc_environment;\nvec3 unpackRGBE (vec4 rgbe) {\n  return rgbe.rgb * pow(2.0, rgbe.a * 255.0 - 128.0);\n}\nvec3 SRGBToLinear (vec3 gamma) {\n  return gamma * gamma;\n}\nvec3 ACESToneMap (vec3 color) {\n  color = min(color, vec3(8.0));\n  const float A = 2.51;\n  const float B = 0.03;\n  const float C = 2.43;\n  const float D = 0.59;\n  const float E = 0.14;\n  return (color * (A * color + B)) / (color * (C * color + D) + E);\n}\nvec4 CCFragOutput (vec4 color) {\n  #if !CC_USE_HDR\n    color.rgb = sqrt(ACESToneMap(color.rgb));\n  #endif\n  return color;\n}\nin vec4 viewDir;\nvec4 frag () {\n  #if USE_RGBE_CUBEMAP\n    vec3 c = unpackRGBE(texture(cc_environment, viewDir.xyz));\n  #else\n    vec3 c = SRGBToLinear(texture(cc_environment, viewDir.xyz).rgb);\n  #endif\n  return CCFragOutput(vec4(c * cc_ambientSky.w, 1.0));\n}\nout vec4 cc_FragColor;\nvoid main() { cc_FragColor = frag(); }"},glsl1:{vert:"\nprecision highp float;\nuniform mediump vec4 cc_screenSize;\nuniform highp mat4 cc_matView;\nuniform highp mat4 cc_matProj;\nstruct StandardVertInput {\n  highp vec4 position;\n  vec3 normal;\n  vec4 tangent;\n};\nattribute vec3 a_position;\nvarying vec4 viewDir;\nvec4 vert () {\n  viewDir = vec4(a_position, 1.0);\n  mat4 matViewRotOnly = mat4(mat3(cc_matView));\n  vec4 pos = matViewRotOnly * viewDir;\n  vec2 f = cc_matProj[3][3] > 0.0 ? vec2(4.8, 2.4) : vec2(cc_matProj[1][1]);\n  pos.xy *= vec2(cc_screenSize.y * cc_screenSize.z, 1.0) * f;\n  pos.zw = vec2(-0.99999 * pos.z, -pos.z);\n  return pos;\n}\nvoid main() { gl_Position = vert(); }",frag:"\nprecision mediump float;\nuniform mediump vec4 cc_ambientSky;\nuniform samplerCube cc_environment;\nvec3 unpackRGBE (vec4 rgbe) {\n  return rgbe.rgb * pow(2.0, rgbe.a * 255.0 - 128.0);\n}\nvec3 SRGBToLinear (vec3 gamma) {\n  return gamma * gamma;\n}\nvec3 ACESToneMap (vec3 color) {\n  color = min(color, vec3(8.0));\n  const float A = 2.51;\n  const float B = 0.03;\n  const float C = 2.43;\n  const float D = 0.59;\n  const float E = 0.14;\n  return (color * (A * color + B)) / (color * (C * color + D) + E);\n}\nvec4 CCFragOutput (vec4 color) {\n  #if !CC_USE_HDR\n    color.rgb = sqrt(ACESToneMap(color.rgb));\n  #endif\n  return color;\n}\nvarying vec4 viewDir;\nvec4 frag () {\n  #if USE_RGBE_CUBEMAP\n    vec3 c = unpackRGBE(textureCube(cc_environment, viewDir.xyz));\n  #else\n    vec3 c = SRGBToLinear(textureCube(cc_environment, viewDir.xyz).rgb);\n  #endif\n  return CCFragOutput(vec4(c * cc_ambientSky.w, 1.0));\n}\nvoid main() { gl_FragColor = frag(); }"},builtins:{globals:{blocks:[{name:"CCGlobal",defines:[]}],samplers:[{name:"cc_environment",defines:[]}]},locals:{blocks:[],samplers:[]}},defines:[{name:"CC_USE_IBL",type:"number",range:[0,2]},{name:"CC_USE_HDR",type:"boolean"},{name:"USE_RGBE_CUBEMAP",type:"boolean"}],blocks:[],samplers:[],attributes:[{name:"a_position",type:15,count:1,defines:[],format:32,location:0}]}]},{name:"util/profiler",_uuid:"871c3b6c-7379-419d-bda3-794b239ab90d",techniques:[{passes:[{blendState:{targets:[{blend:!0,blendSrc:2,blendDst:4,blendDstAlpha:4}]},rasterizerState:{cullMode:0},program:"util/profiler|profiler-vs:vert|profiler-fs:frag",depthStencilState:{depthTest:!1,depthWrite:!1}}]}],shaders:[{name:"util/profiler|profiler-vs:vert|profiler-fs:frag",hash:3438710735,glsl3:{vert:"\nprecision mediump float;\nuniform CCGlobal {\n  highp   vec4 cc_time;\n  mediump vec4 cc_screenSize;\n  mediump vec4 cc_screenScale;\n  mediump vec4 cc_nativeSize;\n  highp   mat4 cc_matView;\n  highp   mat4 cc_matViewInv;\n  highp   mat4 cc_matProj;\n  highp   mat4 cc_matProjInv;\n  highp   mat4 cc_matViewProj;\n  highp   mat4 cc_matViewProjInv;\n  highp   vec4 cc_cameraPos;\n  mediump vec4 cc_exposure;\n  mediump vec4 cc_mainLitDir;\n  mediump vec4 cc_mainLitColor;\n  mediump vec4 cc_ambientSky;\n  mediump vec4 cc_ambientGround;\n};\nstruct StandardVertInput {\n  highp vec4 position;\n  vec3 normal;\n  vec4 tangent;\n};\nin vec3 a_position;\nin vec4 a_color;\nout vec2 v_uv;\nuniform Constants {\n  vec4 offset;\n};\nuniform PerFrameInfo {\n  vec4 digits[8 * 10 / 4];\n};\nfloat getComponent(vec4 v, float i) {\n  if (i < 1.0) { return v.x; }\n  else if (i < 2.0) { return v.y; }\n  else if (i < 3.0) { return v.z; }\n  else { return v.w; }\n}\nvec4 vert () {\n  vec4 position;\n  position = vec4(a_position, 1.0);\n  position.x *= cc_screenSize.y * cc_screenSize.z;\n  position.xy += offset.xy + abs(position.xy);\n  v_uv = a_color.xy;\n  if (a_color.z >= 0.0) {\n    float n = getComponent(digits[int(a_color.z)], a_color.w);\n    v_uv += vec2(offset.z * n, 0.0);\n  }\n  return position;\n}\nvoid main() { gl_Position = vert(); }",frag:"\nprecision mediump float;\nuniform CCGlobal {\n  highp   vec4 cc_time;\n  mediump vec4 cc_screenSize;\n  mediump vec4 cc_screenScale;\n  mediump vec4 cc_nativeSize;\n  highp   mat4 cc_matView;\n  highp   mat4 cc_matViewInv;\n  highp   mat4 cc_matProj;\n  highp   mat4 cc_matProjInv;\n  highp   mat4 cc_matViewProj;\n  highp   mat4 cc_matViewProjInv;\n  highp   vec4 cc_cameraPos;\n  mediump vec4 cc_exposure;\n  mediump vec4 cc_mainLitDir;\n  mediump vec4 cc_mainLitColor;\n  mediump vec4 cc_ambientSky;\n  mediump vec4 cc_ambientGround;\n};\nvec3 SRGBToLinear (vec3 gamma) {\n  return gamma * gamma;\n}\nvec4 CCFragOutput (vec4 color) {\n  #if CC_USE_HDR\n    color.rgb = mix(color.rgb, SRGBToLinear(color.rgb) * cc_exposure.w, vec3(cc_exposure.z));\n  #endif\n  return color;\n}\nin vec2 v_uv;\nuniform sampler2D mainTexture;\nvec4 frag () {\n  return CCFragOutput(texture(mainTexture, v_uv));\n}\nout vec4 cc_FragColor;\nvoid main() { cc_FragColor = frag(); }"},glsl1:{vert:"\nprecision mediump float;\nuniform mediump vec4 cc_screenSize;\nstruct StandardVertInput {\n  highp vec4 position;\n  vec3 normal;\n  vec4 tangent;\n};\nattribute vec3 a_position;\nattribute vec4 a_color;\nvarying vec2 v_uv;\nuniform vec4 offset;\nuniform vec4 digits[20];\nfloat getComponent(vec4 v, float i) {\n  if (i < 1.0) { return v.x; }\n  else if (i < 2.0) { return v.y; }\n  else if (i < 3.0) { return v.z; }\n  else { return v.w; }\n}\nvec4 vert () {\n  vec4 position;\n  position = vec4(a_position, 1.0);\n  position.x *= cc_screenSize.y * cc_screenSize.z;\n  position.xy += offset.xy + abs(position.xy);\n  v_uv = a_color.xy;\n  if (a_color.z >= 0.0) {\n    float n = getComponent(digits[int(a_color.z)], a_color.w);\n    v_uv += vec2(offset.z * n, 0.0);\n  }\n  return position;\n}\nvoid main() { gl_Position = vert(); }",frag:"\nprecision mediump float;\nuniform mediump vec4 cc_exposure;\nvec3 SRGBToLinear (vec3 gamma) {\n  return gamma * gamma;\n}\nvec4 CCFragOutput (vec4 color) {\n  #if CC_USE_HDR\n    color.rgb = mix(color.rgb, SRGBToLinear(color.rgb) * cc_exposure.w, vec3(cc_exposure.z));\n  #endif\n  return color;\n}\nvarying vec2 v_uv;\nuniform sampler2D mainTexture;\nvec4 frag () {\n  return CCFragOutput(texture2D(mainTexture, v_uv));\n}\nvoid main() { gl_FragColor = frag(); }"},builtins:{globals:{blocks:[{name:"CCGlobal",defines:[]}],samplers:[]},locals:{blocks:[],samplers:[]}},defines:[{name:"CC_USE_HDR",type:"boolean"}],blocks:[{name:"Constants",defines:[],binding:0,members:[{name:"offset",type:16,count:1}]},{name:"PerFrameInfo",defines:[],binding:1,members:[{name:"digits",type:16,count:20}]}],samplers:[{name:"mainTexture",type:28,count:1,defines:[],binding:31}],attributes:[{name:"a_position",type:15,count:1,defines:[],format:32,location:0},{name:"a_color",type:16,count:1,defines:[],format:43,location:1}]}]}],Ic=function(){function e(){Z(this,e),this._device=null,this._resources={}}return J(e,[{key:"initBuiltinRes",value:function(e){this._device=e;var t=this._resources,i=document.createElement("canvas"),n=i.getContext("2d"),r=new Gl(i),a=i.width=i.height=2;n.fillStyle="#000",n.fillRect(0,0,a,a);var o=new gu;o._uuid="black-texture",o.image=r,t[o._uuid]=o,n.fillStyle="rgba(0,0,0,0)",n.fillRect(0,0,a,a);for(var s=new Uint8Array(16),l=0;l<s.length;++l)s[l]=0;var u=new gu;u._uuid="empty-texture",u.image=r,u.uploadData(s),t[u._uuid]=u;var c=new Oc;c._uuid="black-cube-texture",c.setMipFilter(Oc.Filter.LINEAR),c.image={front:new Gl(i),back:new Gl(i),left:new Gl(i),right:new Gl(i),top:new Gl(i),bottom:new Gl(i)},t[c._uuid]=c,n.fillStyle="#777",n.fillRect(0,0,a,a);var h=new gu;h._uuid="grey-texture",h.image=r,t[h._uuid]=h,n.fillStyle="#fff",n.fillRect(0,0,a,a);var p=new gu;p._uuid="white-texture",p.image=r,t[p._uuid]=p;var _=new Oc;_._uuid="white-cube-texture",_.setMipFilter(Oc.Filter.LINEAR),_.image={front:new Gl(i),back:new Gl(i),left:new Gl(i),right:new Gl(i),top:new Gl(i),bottom:new Gl(i)},t[_._uuid]=_,n.fillStyle="#7f7fff",n.fillRect(0,0,a,a);var f=new gu;f._uuid="normal-texture",f.image=r,t[f._uuid]=f,i.width=i.height=16,n.fillStyle="#ddd",n.fillRect(0,0,16,16),n.fillStyle="#555",n.fillRect(0,0,8,8),n.fillStyle="#555",n.fillRect(8,8,8,8);var d=new gu;d._uuid="default-texture",d.image=r,t[d._uuid]=d;var m=new Oc;m.setMipFilter(Oc.Filter.LINEAR),m._uuid="default-cube-texture",m.image={front:new Gl(i),back:new Gl(i),left:new Gl(i),right:new Gl(i),top:new Gl(i),bottom:new Gl(i)},t[m._uuid]=m;var v=new Ac,y=r._texture;v.texture=y,v._uuid="default-spriteframe",t[v._uuid]=v,Mc.forEach((function(e){Object.assign(new cc.EffectAsset,e).onLoaded()}));var g=new cc.Material;g._uuid="standard-material",g.initialize({effectName:"builtin-standard"}),t[g._uuid]=g;var x=new cc.Material;x._uuid="missing-effect-material",x.initialize({effectName:"builtin-unlit",defines:{USE_COLOR:!0}}),x.setProperty("mainColor",cc.color("#ffff00")),t[x._uuid]=x;var b=new cc.Material;b._uuid="missing-material",b.initialize({effectName:"builtin-unlit",defines:{USE_COLOR:!0}}),b.setProperty("mainColor",cc.color("#ff00ff")),t[b._uuid]=b;var T=new cc.Material;T._uuid="ui-base-material",T.initialize({defines:{USE_TEXTURE:!1},effectName:"builtin-sprite"}),t[T._uuid]=T;var S=new cc.Material;S._uuid="ui-sprite-material",S.initialize({defines:{USE_TEXTURE:!0,IS_GRAY:!1},effectName:"builtin-sprite"}),t[S._uuid]=S;var E=new cc.Material;E._uuid="ui-sprite-gray-material",E.initialize({defines:{USE_TEXTURE:!0,IS_GRAY:!0},effectName:"builtin-sprite"}),t[E._uuid]=E;var w=new cc.Material;w._uuid="default-particle-material",w.initialize({effectName:"builtin-particle"}),t[w._uuid]=w;var C=new cc.Material;C._uuid="default-particle-gpu-material",C.initialize({effectName:"builtin-particle-gpu"}),t[C._uuid]=C;var A=new cc.Material;A._uuid="default-trail-material",A.initialize({effectName:"builtin-particle-trail"}),t[A._uuid]=A;var O=new cc.Material;O._uuid="default-billboard-material",O.initialize({effectName:"builtin-billboard"}),t[O._uuid]=O}},{key:"get",value:function(e){return this._resources[e]}}]),e}(),Pc=cc.builtinResMgr=new Ic,Lc=function(){function e(){Z(this,e),this.priority=Su.DEFAULT,this._psos=null,this._subMeshObject=null,this._material=null,this._inputAssembler=null,this._cmdBuffers=[]}return J(e,[{key:"initialize",value:function(e,t,i){this.psos=i,this.subMeshData=e,this.material=t}},{key:"destroy",value:function(){this._inputAssembler&&(this._inputAssembler.destroy(),this._inputAssembler=null);for(var e=0;e<this.passes.length;e++)this.passes[e].destroyPipelineState(this._psos[e]);for(var t,i=_e(this._cmdBuffers);!(t=i()).done;){t.value.destroy()}this._cmdBuffers.length=0,this._material=null}},{key:"updateCommandBuffer",value:function(){if(this._material){for(var e=0;e<this._material.passes.length;e++)this.recordCommandBuffer(e);for(var t=this._cmdBuffers.length-1;t>=this._material.passes.length;t--){var i=this._cmdBuffers.pop();i&&i.destroy()}}}},{key:"recordCommandBuffer",value:function(e){var t=cc.director.root.device,i=this._psos[e];if(null==this._cmdBuffers[e]){var n={allocator:t.commandAllocator,type:exports.GFXCommandBufferType.SECONDARY};this._cmdBuffers[e]=t.createCommandBuffer(n)}else this._cmdBuffers[e].status===exports.GFXStatus.UNREADY&&this._cmdBuffers[e].initialize({allocator:t.commandAllocator,type:exports.GFXCommandBufferType.SECONDARY});var r=this._inputAssembler,a=this._cmdBuffers[e];a.begin(),a.bindPipelineState(i),a.bindBindingLayout(i.pipelineLayout.layouts[0]),a.bindInputAssembler(r),a.draw(r),a.end()}},{key:"psos",set:function(e){this._psos=e},get:function(){return this._psos}},{key:"subMeshData",set:function(e){this._inputAssembler&&this._inputAssembler.destroy(),this._subMeshObject=e,this._inputAssembler?this._inputAssembler.initialize(e):this._inputAssembler=cc.director.root.device.createInputAssembler(e)},get:function(){return this._subMeshObject}},{key:"material",set:function(e){this._material=e,null!=e&&this.updateCommandBuffer()},get:function(){return this._material}},{key:"passes",get:function(){return this._material.passes}},{key:"inputAssembler",get:function(){return this._inputAssembler}},{key:"commandBuffers",get:function(){return this._cmdBuffers}}]),e}(),Dc=function(e,t,i){var n=arguments.length>3&&void 0!==arguments[3]?arguments[3]:0;return e<<28&4026531840|i<<22&264241152|t<<14&4177920|16383&n},Nc=function(e){return(4026531840&e)>>>28},zc=function(e){return(264241152&e)>>>22},Bc=function(e){return(4177920&e)>>>14},Gc=function(e){return 16383&e},Uc=function(e,t){return-264241153&e|t<<22&264241152},Xc=($(Rc={},exports.GFXType.UNKNOWN,(function(e,t){return console.warn("illegal uniform handle")})),$(Rc,exports.GFXType.INT,(function(e,t){var i=arguments.length>2&&void 0!==arguments[2]?arguments[2]:0;return e[i]})),$(Rc,exports.GFXType.INT2,(function(e,t){var i=arguments.length>2&&void 0!==arguments[2]?arguments[2]:0;return ki.fromArray(t,e,i)})),$(Rc,exports.GFXType.INT3,(function(e,t){var i=arguments.length>2&&void 0!==arguments[2]?arguments[2]:0;return Ii.fromArray(t,e,i)})),$(Rc,exports.GFXType.INT4,(function(e,t){var i=arguments.length>2&&void 0!==arguments[2]?arguments[2]:0;return Ni.fromArray(t,e,i)})),$(Rc,exports.GFXType.FLOAT,(function(e,t){var i=arguments.length>2&&void 0!==arguments[2]?arguments[2]:0;return e[i]})),$(Rc,exports.GFXType.FLOAT2,(function(e,t){var i=arguments.length>2&&void 0!==arguments[2]?arguments[2]:0;return ki.fromArray(t,e,i)})),$(Rc,exports.GFXType.FLOAT3,(function(e,t){var i=arguments.length>2&&void 0!==arguments[2]?arguments[2]:0;return Ii.fromArray(t,e,i)})),$(Rc,exports.GFXType.FLOAT4,(function(e,t){var i=arguments.length>2&&void 0!==arguments[2]?arguments[2]:0;return Ni.fromArray(t,e,i)})),$(Rc,exports.GFXType.MAT3,(function(e,t){var i=arguments.length>2&&void 0!==arguments[2]?arguments[2]:0;return Bi.fromArray(t,e,i)})),$(Rc,exports.GFXType.MAT4,(function(e,t){var i=arguments.length>2&&void 0!==arguments[2]?arguments[2]:0;return Ki.fromArray(t,e,i)})),Rc),Vc=($(Fc={},exports.GFXType.UNKNOWN,(function(e,t){return console.warn("illegal uniform handle")})),$(Fc,exports.GFXType.INT,(function(e,t){var i=arguments.length>2&&void 0!==arguments[2]?arguments[2]:0;return e[i]=t})),$(Fc,exports.GFXType.INT2,(function(e,t){var i=arguments.length>2&&void 0!==arguments[2]?arguments[2]:0;return ki.toArray(e,t,i)})),$(Fc,exports.GFXType.INT3,(function(e,t){var i=arguments.length>2&&void 0!==arguments[2]?arguments[2]:0;return Ii.toArray(e,t,i)})),$(Fc,exports.GFXType.INT4,(function(e,t){var i=arguments.length>2&&void 0!==arguments[2]?arguments[2]:0;return Ni.toArray(e,t,i)})),$(Fc,exports.GFXType.FLOAT,(function(e,t){var i=arguments.length>2&&void 0!==arguments[2]?arguments[2]:0;return e[i]=t})),$(Fc,exports.GFXType.FLOAT2,(function(e,t){var i=arguments.length>2&&void 0!==arguments[2]?arguments[2]:0;return ki.toArray(e,t,i)})),$(Fc,exports.GFXType.FLOAT3,(function(e,t){var i=arguments.length>2&&void 0!==arguments[2]?arguments[2]:0;return Ii.toArray(e,t,i)})),$(Fc,exports.GFXType.FLOAT4,(function(e,t){var i=arguments.length>2&&void 0!==arguments[2]?arguments[2]:0;return Ni.toArray(e,t,i)})),$(Fc,exports.GFXType.MAT3,(function(e,t){var i=arguments.length>2&&void 0!==arguments[2]?arguments[2]:0;return Bi.toArray(e,t,i)})),$(Fc,exports.GFXType.MAT4,(function(e,t){var i=arguments.length>2&&void 0!==arguments[2]?arguments[2]:0;return Ki.toArray(e,t,i)})),Fc),Hc=[Object.freeze([0]),Object.freeze([0,0]),Object.freeze([0,0,0,0]),Object.freeze([1,0,0,0,0,1,0,0,0,0,1,0,0,0,0,1])];function Wc(e){switch(e){case exports.GFXType.BOOL:case exports.GFXType.INT:case exports.GFXType.UINT:case exports.GFXType.FLOAT:return Hc[0];case exports.GFXType.BOOL2:case exports.GFXType.INT2:case exports.GFXType.UINT2:case exports.GFXType.FLOAT2:return Hc[1];case exports.GFXType.BOOL4:case exports.GFXType.INT4:case exports.GFXType.UINT4:case exports.GFXType.FLOAT4:return Hc[2];case exports.GFXType.MAT4:return Hc[3];case exports.GFXType.SAMPLER2D:return"default-texture";case exports.GFXType.SAMPLER_CUBE:return"default-cube-texture"}return Hc[0]}function jc(e,t){for(var i=Object.entries(t),n=!1,r=0;r<i.length;r++)e[i[r][0]]!==i[r][1]&&(e[i[r][0]]=i[r][1],n=!0);return n}function qc(e){return Math.ceil(Math.log2(Math.max(e,2)))}function Yc(e,t){switch(e.type){case"boolean":return("number"==typeof t?t:t?1:0)+"";case"string":return void 0!==t?t:e.options[0];case"number":return(void 0!==t?t:e.range[0])+""}return console.warn("unknown define type '".concat(e.type,"'")),"-1"}function Kc(e,t){return e+t.reduce((function(e,t){return t.isDefault?e:"".concat(e,"|").concat(t.name).concat(t.value)}),"")}function Zc(e,t,i){for(var n,r=e.builtins[i],a=e.blocks,o=_e(r.blocks);!(n=o()).done;){var s=n.value,l=t.get(s.name);if(l&&l.type===exports.GFXBindingType.UNIFORM_BUFFER){var u=Object.assign({defines:s.defines,size:Qc(l.blockInfo),bindingType:exports.GFXBindingType.UNIFORM_BUFFER,defaultValue:l.defaultValue},l.blockInfo);a.push(u)}else console.warn("builtin UBO '".concat(s.name,"' not available!"))}for(var c,h=e.samplers,p=_e(r.samplers);!(c=p()).done;){var _=c.value,f=t.get(_.name);if(f&&f.type===exports.GFXBindingType.SAMPLER){var d=Object.assign({defines:_.defines,bindingType:exports.GFXBindingType.SAMPLER,defaultValue:f.defaultValue},f.samplerInfo);h.push(d)}else console.warn("builtin sampler '".concat(_.name,"' not available!"))}}function Qc(e){return e.members.reduce((function(e,t){return e+Tr(t.type)*t.count}),0)}function Jc(e,t){for(var i=0;i<e.length;i++){var n=e[i];if("!"===n[0]){if(t[n.slice(1)])return!1}else if(!t[n])return!1}return!0}var $c=new(function(){function e(){Z(this,e),this._templates=void 0,this._cache=void 0,this._templates={},this._cache={}}return J(e,[{key:"define",value:function(e){var t=this._templates[e.name];if(!t||t.hash!==e.hash){for(var i,n=e,r=0,a=function(){var e=i.value,t=1;if("number"===e.type){var n=e.range;t=qc(n[1]-n[0]+1),e._map=function(e){return e-n[0]}}else"string"===e.type?(t=qc(e.options.length),e._map=function(t){return Math.max(0,e.options.findIndex((function(e){return e===t})))}):"boolean"===e.type&&(e._map=function(e){return e?1:0});e._offset=r,r+=t},o=_e(n.defines);!(i=o()).done;)a();r>31&&(n.uber=!0),n.blocks.forEach((function(e){e.bindingType=exports.GFXBindingType.UNIFORM_BUFFER,e.size=Qc(e)})),n.samplers.forEach((function(e){return e.bindingType=exports.GFXBindingType.SAMPLER})),n.handleMap=function(e){for(var t={},i=0;i<e.blocks.length;i++)for(var n=e.blocks[i],r=n.members,a=0,o=0;o<r.length;o++){var s=r[o];t[s.name]=Dc(exports.GFXBindingType.UNIFORM_BUFFER,n.binding,s.type,a),a+=(Tr(s.type)>>2)*s.count}for(var l=0;l<e.samplers.length;l++){var u=e.samplers[l];t[u.name]=Dc(exports.GFXBindingType.SAMPLER,u.binding,u.type)}return t}(n),n.localsInited||(Zc(n,ku,"locals"),n.localsInited=!0),this._templates[e.name]=n}}},{key:"getTemplate",value:function(e){return this._templates[e]}},{key:"hasProgram",value:function(e){return void 0!==this._templates[e]}},{key:"getKey",value:function(e,t){var i=this._templates[e],n=i.defines;if(i.uber){for(var r="",a=0;a<n.length;a++){var o=n[a],s=t[o.name];if(s&&o._map){var l=o._map(s);r+=o._offset+(l+"|")}}return r+i.hash}for(var u=0,c=0;c<n.length;c++){var h=n[c],p=t[h.name];if(p&&h._map)u|=h._map(p)<<h._offset}return"".concat(u.toString(16),"|").concat(i.hash)}},{key:"destroyShaderByDefines",value:function(e){var t=this,i=Object.keys(e);if(i.length)for(var n,r=i.map((function(t){var i=e[t];return"boolean"==typeof i&&(i=i?"1":"0"),new RegExp(t+i)})),a=_e(Object.keys(this._cache).filter((function(e){return r.every((function(i){return i.test(t._cache[e].shader.name)}))})));!(n=a()).done;){var o=n.value,s=this._cache[o].shader;console.log("destroyed shader ".concat(s.name)),s.destroy(),delete this._cache[o]}}},{key:"getGFXShader",value:function(e,t,i,n,r){r||(r=this.getKey(t,i));var a=this._cache[r];if(a)return a;var o=this._templates[t];o.globalsInited||(Zc(o,n.globalBindings,"globals"),o.globalsInited=!0);var s=function(e,t){for(var i,n=[],r=_e(t);!(i=r()).done;){var a=i.value,o=a.name,s=e[o],l=Yc(a,s),u=!s||"0"===s;n.push({name:o,value:l,isDefault:u})}return n}(i,o.defines),l=s.reduce((function(e,t){return"".concat(e,"#define ").concat(t.name," ").concat(t.value,"\n")}),"")+"\n",u=o.glsl3;switch(e.gfxAPI){case exports.GFXAPI.WEBGL2:u=o.glsl3;break;default:u=o.glsl1}var c=[],h=[],p=[],_=new Nr;!function(e,t,i,n,r,a){for(var o=e.blocks,s=e.samplers,l=e.attributes,u=0;u<o.length;u++){var c=o[u];Jc(c.defines,t)&&(i.push(c),r.push(c))}for(var h=0;h<s.length;h++){var p=s[h];Jc(p.defines,t)&&(n.push(p),r.push(p))}for(var _=0;_<l.length;_++){var f=l[_];Jc(f.defines,t)&&a.push(f)}}(o,i,c,h,p,_.attributes);var f=e.createShader({name:Kc(t,s),blocks:c,samplers:h,stages:[{type:exports.GFXShaderType.VERTEX,source:l+u.vert},{type:exports.GFXShaderType.FRAGMENT,source:l+u.frag}]});return this._cache[r]={shader:f,bindings:p,inputState:_}}}]),e}());cc.programLib=$c;var eh,th=new Ki,ih=new To((function(){return new Lc}),32);!function(e){e[e.DEFAULT=0]="DEFAULT",e[e.SKINNING=1]="SKINNING",e[e.BAKED_SKINNING=2]="BAKED_SKINNING",e[e.UI_BATCH=3]="UI_BATCH",e[e.PARTICLE_BATCH=4]="PARTICLE_BATCH",e[e.LINE=5]="LINE"}(eh||(eh={}));var nh,rh,ah=function(){function e(){Z(this,e),this.type=eh.DEFAULT,this.scene=null,this.node=null,this.transform=null,this.enabled=!0,this.visFlags=bu.Enum.NONE,this.castShadow=!1,this.isDynamicBatching=!1,this.instancedAttributes={buffer:null,list:[]},this._device=void 0,this._worldBounds=null,this._modelBounds=null,this._subModels=[],this._implantPSOs=[],this._matPSORecord=new Map,this._matRefCount=new Map,this._localData=new Float32Array(Ru.COUNT),this._localBuffer=null,this._lightBuffer=null,this._inited=!1,this._updateStamp=-1,this._transformUpdated=!0,this._instMatWorldIdx=-1,this._device=cc.director.root.device}return J(e,[{key:"subModels",get:function(){return this._subModels}},{key:"subModelNum",get:function(){return this._subModels.length}},{key:"inited",get:function(){return this._inited}},{key:"worldBounds",get:function(){return this._worldBounds}},{key:"modelBounds",get:function(){return this._modelBounds}},{key:"lightBuffer",get:function(){return this._lightBuffer}},{key:"localBuffer",get:function(){return this._localBuffer}},{key:"updateStamp",get:function(){return this._updateStamp}},{key:"isInstancingEnabled",get:function(){return this._instMatWorldIdx>=0}}]),J(e,[{key:"initialize",value:function(e){this.transform=this.node=e}},{key:"destroy",value:function(){for(var e,t=_e(this._subModels);!(e=t()).done;){var i=e.value;i.destroy(),ih.free(i)}this._localBuffer&&(this._localBuffer.destroy(),this._localBuffer=null),this._lightBuffer&&(this._lightBuffer.destroy(),this._lightBuffer=null),this._worldBounds=null,this._modelBounds=null,this._subModels.length=0,this._matPSORecord.clear(),this._matRefCount.clear(),this._inited=!1,this._transformUpdated=!0,this.isDynamicBatching=!1}},{key:"attachToScene",value:function(e){this.scene=e}},{key:"detachFromScene",value:function(){this.scene=null}},{key:"getSubModel",value:function(e){return this._subModels[e]}},{key:"updateTransform",value:function(e){var t=this.transform;(t.hasChangedFlags||t._dirtyFlags)&&(t.updateWorldTransform(),this._transformUpdated=!0,this._modelBounds&&this._worldBounds&&this._modelBounds.transform(t._mat,t._pos,t._rot,t._scale,this._worldBounds))}},{key:"updateLightingmap",value:function(e,t){Ni.toArray(this._localData,t,Ru.LIGHTINGMAP_UVPARAM),null===e&&(e=Pc.get("empty-texture"));var i=e.getGFXTextureView();if(null!==i){var n;if(e.mipmaps.length>1){var r=Wl([exports.GFXFilter.LINEAR,exports.GFXFilter.LINEAR,exports.GFXFilter.LINEAR,exports.GFXAddress.CLAMP,exports.GFXAddress.CLAMP,exports.GFXAddress.CLAMP]);n=ou.getSampler(this._device,r)}else{var a=Wl([exports.GFXFilter.NONE,exports.GFXFilter.NONE,exports.GFXFilter.NONE,exports.GFXAddress.CLAMP,exports.GFXAddress.CLAMP,exports.GFXAddress.CLAMP]);n=ou.getSampler(this._device,a)}for(var o,s=_e(this._subModels);!(o=s()).done;){var l=o.value;if(null!==l.psos)for(var u=0;u<l.psos.length;u++)l.psos[u].pipelineLayout.layouts[0].bindTextureView(Gu.binding,i),l.psos[u].pipelineLayout.layouts[0].bindSampler(Gu.binding,n),l.psos[u].pipelineLayout.layouts[0].update()}}}},{key:"updateUBOs",value:function(e){if(this._matPSORecord.forEach(this._updatePass,this),this._updateStamp=e,this._transformUpdated){this._transformUpdated=!1;var t=this.transform._mat,i=this._instMatWorldIdx;if(i>=0){var n=this.instancedAttributes.list;!function(e,t,i,n){t[0]=e.m00,t[1]=e.m01,t[2]=e.m02,t[3]=e.m12,i[0]=e.m04,i[1]=e.m05,i[2]=e.m06,i[3]=e.m13,n[0]=e.m08,n[1]=e.m09,n[2]=e.m10,n[3]=e.m14}(t,n[i].view,n[i+1].view,n[i+2].view)}else Ki.toArray(this._localData,t,Ru.MAT_WORLD_OFFSET),Ki.inverseTranspose(th,t),Ki.toArray(this._localData,th,Ru.MAT_WORLD_IT_OFFSET),this._localBuffer.update(this._localData)}}},{key:"createBoundingShape",value:function(e,t){e&&t&&(this._modelBounds=lo.fromPoints(lo.create(),e,t),this._worldBounds=lo.clone(this._modelBounds))}},{key:"initSubModel",value:function(e,t,i){if(this.initLocalBindings(i),null==this._subModels[e])this._subModels[e]=ih.alloc();else{var n=this._subModels[e].material;this._subModels[e].destroy(),this.releasePSO(n)}this.allocatePSO(i,e),this._subModels[e].initialize(t,i,this._matPSORecord.get(i)),this._inited=!0}},{key:"setSubModelMesh",value:function(e,t){null==this._subModels[e]&&(this._subModels[e]=ih.alloc()),this._subModels[e].subMeshData=t}},{key:"setSubModelMaterial",value:function(e,t){this.initLocalBindings(t),this._subModels[e]&&(this._subModels[e].material===t?t&&(this.destroyPipelineStates(t,this._matPSORecord.get(t)),this._matPSORecord.set(t,this.createPipelineStates(t,e))):(this._subModels[e].material&&this.releasePSO(this._subModels[e].material),t&&this.allocatePSO(t,e)),this._subModels[e].psos=t&&this._matPSORecord.get(t)||null,this._subModels[e].material=t)}},{key:"onGlobalPipelineStateChanged",value:function(){var e=this,t=this._subModels;this._matPSORecord.forEach((function(i,n){for(var r=0;r<t.length&&t[r].material!==n;r++);if(!(r>=t.length)){for(var a=0;a<n.passes.length;a++){var o=n.passes[a];o.destroyPipelineState(i[a]),o.beginChangeStatesSilently(),o.tryCompile(),o.endChangeStatesSilently()}var s=e.createPipelineStates(n,r);i.length=s.length;for(var l=0;l<s.length;l++)i[l]=s[l]}}));for(var i=0;i<t.length;i++)t[i].updateCommandBuffer()}},{key:"insertImplantPSO",value:function(e){this._implantPSOs.push(e)}},{key:"removeImplantPSO",value:function(e){var t=this._implantPSOs.indexOf(e);t>=0&&this._implantPSOs.splice(t,1)}},{key:"createPipelineStates",value:function(e,t){for(var i=[],n=0;n<e.passes.length;n++){var r=e.passes[n];i[n]=this.createPipelineState(r,t)}return i[0]&&this.updateInstancedAttributeList(i[0],e.passes[0]),i}},{key:"destroyPipelineStates",value:function(e,t){for(var i=0;i<e.passes.length;i++){e.passes[i].destroyPipelineState(t[i])}}},{key:"createPipelineState",value:function(e,t,i){var n=e.createPipelineState(i),r=n.pipelineLayout.layouts[0];return this._localBuffer&&r.bindBuffer(Ru.BLOCK.binding,this._localBuffer),this._lightBuffer&&r.bindBuffer(Mu.BLOCK.binding,this._lightBuffer),n}},{key:"updateInstancedAttributeList",value:function(e,t){if(t.device.hasFeature(exports.GFXFeature.INSTANCED_ARRAYS)){for(var i=e.inputState.attributes,n=0,r=0;r<i.length;r++){var a=i[r];a.isInstanced&&(n+=yr[a.format].size)}var o=this.instancedAttributes;o.buffer=new Uint8Array(n),o.list.length=0;for(var s=0,l=o.buffer.buffer,u=0;u<i.length;u++){var c=i[u];if(c.isInstanced){var h=c.format,p=yr[h],_=new(Sr(p))(l,s,p.count),f=c.isNormalized;s+=p.size,o.list.push({name:c.name,format:h,isNormalized:f,view:_})}}t.instancedBuffer&&t.instancedBuffer.destroy(),this._instMatWorldIdx=this.getInstancedAttributeIndex("a_matWorld0"),this._transformUpdated=!0}}},{key:"getInstancedAttributeIndex",value:function(e){for(var t=this.instancedAttributes.list,i=0;i<t.length;i++)if(t[i].name===e)return i;return-1}},{key:"initLocalBindings",value:function(e){if(this._localBuffer||(this._localBuffer=this._device.createBuffer({usage:exports.GFXBufferUsageBit.UNIFORM|exports.GFXBufferUsageBit.TRANSFER_DST,memUsage:exports.GFXMemoryUsageBit.HOST|exports.GFXMemoryUsageBit.DEVICE,size:Ru.SIZE,stride:Ru.SIZE})),e){for(var t,i=!1,n=_e(e.passes);!(t=n()).done;){var r=t.value;if($c.getTemplate(r.program).builtins.locals.blocks.find((function(e){return e.name===Mu.BLOCK.name}))){i=!0;break}}i&&!this._lightBuffer&&(this._lightBuffer=this._device.createBuffer({usage:exports.GFXBufferUsageBit.UNIFORM|exports.GFXBufferUsageBit.TRANSFER_DST,memUsage:exports.GFXMemoryUsageBit.HOST|exports.GFXMemoryUsageBit.DEVICE,size:Mu.SIZE,stride:Mu.SIZE}))}}},{key:"_updatePass",value:function(e,t){for(var i=0;i<t.passes.length;i++)t.passes[i].update();for(var n=0;n<e.length;n++)e[n].pipelineLayout.layouts[0].update()}},{key:"allocatePSO",value:function(e,t){null==this._matRefCount.get(e)?(this._matRefCount.set(e,1),this._matPSORecord.set(e,this.createPipelineStates(e,t))):this._matRefCount.set(e,this._matRefCount.get(e)+1)}},{key:"releasePSO",value:function(e){this._matRefCount.set(e,this._matRefCount.get(e)-1),0===this._matRefCount.get(e)&&(this.destroyPipelineStates(e,this._matPSORecord.get(e)),this._matPSORecord.delete(e),this._matRefCount.delete(e))}}]),e}(),oh=function(e){function t(){var e,i;Z(this,t);for(var n=arguments.length,r=new Array(n),a=0;a<n;a++)r[a]=arguments[a];return(i=re(this,(e=te(t)).call.apply(e,[this].concat(r))))._morphRenderingInstance=null,i._usedMaterials=new Set,i}return ee(t,ah),J(t,[{key:"createPipelineState",value:function(e,i,n){var r;if(!this._morphRenderingInstance)return oe(te(t.prototype),"createPipelineState",this).apply(this,arguments);var a=this._morphRenderingInstance.requiredPatches(i),o=oe(te(t.prototype),"createPipelineState",this).call(this,e,i,a?null!==(r=null==n?void 0:n.concat(a))&&void 0!==r?r:a:n);return this._morphRenderingInstance.adaptPipelineState(i,o),o}},{key:"initSubModel",value:function(e,i,n){return oe(te(t.prototype),"initSubModel",this).call(this,e,i,this._launderMaterial(n))}},{key:"setSubModelMaterial",value:function(e,i){return oe(te(t.prototype),"setSubModelMaterial",this).call(this,e,i?this._launderMaterial(i):i)}},{key:"_launderMaterial",value:function(e){return e}},{key:"setMorphRendering",value:function(e){this._morphRenderingInstance=e}}]),t}();!function(e){e[e.LOCAL=0]="LOCAL",e[e.WORLD=1]="WORLD"}(nh||(nh={})),function(e){e[e.NONE=0]="NONE",e[e.POSITION=1]="POSITION",e[e.ROTATION=2]="ROTATION",e[e.SCALE=4]="SCALE",e[e.RS=e.ROTATION|e.SCALE]="RS",e[e.TRS=e.POSITION|e.ROTATION|e.SCALE]="TRS",e[e.TRS_MASK=~e.TRS]="TRS_MASK"}(rh||(rh={})),cc.internal.TransformBit=rh;var sh,lh,uh,ch,hh,ph,_h,fh,dh,mh=new Fu,vh=function(){function e(t){Z(this,e),this.batches=[],this.pass=void 0,this.pass=t}return J(e,[{key:"destroy",value:function(){for(var e=0;e<this.batches.length;++e){for(var t=this.batches[e],i=0;i<t.vbs.length;++i)t.vbs[i].destroy();t.vbIdx.destroy(),t.ia.destroy(),t.ubo.destroy()}this.batches.length=0}},{key:"merge",value:function(e,t,i){var n=e.subMeshData.flatBuffers;if(0!==n.length){for(var r=0,a=0,o=n[0].count,s=i.pipelineLayout.layouts[0],l=!1,u=0;u<this.batches.length;++u){var c=this.batches[u];if(c.vbs.length===n.length&&c.mergeCount<Fu.BATCHING_COUNT){l=!0;for(var h=0;h<c.vbs.length;++h){if(c.vbs[h].stride!==n[h].stride){l=!1;break}}if(l){for(var p=0;p<c.vbs.length;++p){var _=n[p],f=c.vbs[p],d=c.vbDatas[p];(r=(o+c.vbCount)*_.stride)>f.size&&(f.resize(r),d=c.vbDatas[p]=new Uint8Array(f.bufferView.buffer)),d.set(_.buffer,c.vbCount*_.stride)}(a=4*(o+c.vbCount))>c.vbIdx.size&&(c.vbIdx.resize(a),c.vbIdxData=new Float32Array(c.vbIdx.bufferView.buffer));var m=c.vbCount,v=m+o,y=c.vbIdxData,g=c.mergeCount;if(y[m]!==g||y[v-1]!==g)for(var x=m;x<v;x++)y[x]=g+.1;return Ki.toArray(c.uboData.view,t.model.transform.worldMatrix,Fu.MAT_WORLDS_OFFSET+16*c.mergeCount),c.mergeCount||c.pso===i||(s.bindBuffer(Fu.BLOCK.binding,c.ubo),s.update(),c.pso=i),++c.mergeCount,c.vbCount+=o,void(c.ia.vertexCount+=o)}}}for(var b=this.pass.device,T=[],S=[],E=[],w=0;w<n.length;++w){var C=n[w],A=b.createBuffer({usage:exports.GFXBufferUsageBit.VERTEX|exports.GFXBufferUsageBit.TRANSFER_DST,memUsage:exports.GFXMemoryUsageBit.HOST|exports.GFXMemoryUsageBit.DEVICE,size:C.count*C.stride,stride:C.stride,flags:exports.GFXBufferFlagBit.BAKUP_BUFFER});A.update(C.buffer.buffer),T.push(A),S.push(new Uint8Array(A.bufferView.buffer)),E.push(A)}var O=b.createBuffer({usage:exports.GFXBufferUsageBit.VERTEX|exports.GFXBufferUsageBit.TRANSFER_DST,memUsage:exports.GFXMemoryUsageBit.HOST|exports.GFXMemoryUsageBit.DEVICE,size:4*o,stride:4,flags:exports.GFXBufferFlagBit.BAKUP_BUFFER}),k=new Float32Array(o);k.fill(0),O.update(k),E.push(O);for(var R=new Float32Array(O.bufferView.buffer),F=e.inputAssembler.attributes,M=new Array(F.length+1),I=0;I<F.length;++I)M[I]=F[I];M[F.length]={name:"a_dyn_batch_id",format:exports.GFXFormat.R32F,stream:n.length};var P=b.createInputAssembler({attributes:M,vertexBuffers:E}),L=this.pass.device.createBuffer({usage:exports.GFXBufferUsageBit.UNIFORM|exports.GFXBufferUsageBit.TRANSFER_DST,memUsage:exports.GFXMemoryUsageBit.HOST|exports.GFXMemoryUsageBit.DEVICE,size:Fu.SIZE});s.bindBuffer(Fu.BLOCK.binding,L),s.update();var D=new Fu;Ki.toArray(D.view,t.model.transform.worldMatrix,Fu.MAT_WORLDS_OFFSET),this.batches.push({mergeCount:1,vbs:T,vbDatas:S,vbIdx:O,vbIdxData:R,vbCount:o,ia:P,ubo:L,uboData:D,pso:i})}}},{key:"clear",value:function(){for(var e=0;e<this.batches.length;++e){var t=this.batches[e];t.vbCount=0,t.mergeCount=0,t.ia.vertexCount=0}}},{key:"clearUBO",value:function(){for(var e=0;e<this.batches.length;++e){this.batches[e].ubo.update(mh.view.buffer)}}}]),e}(),yh=function(){function e(t){Z(this,e),this.instances=[],this.pass=void 0,this.pass=t}return J(e,[{key:"destroy",value:function(){for(var e=0;e<this.instances.length;++e){var t=this.instances[e];t.vb.destroy(),t.ia.destroy()}this.instances.length=0}},{key:"merge",value:function(e,t,i){var n=t.buffer.length;if(n){for(var r=e.inputAssembler,a=0;a<this.instances.length;++a){var o=this.instances[a];if(!(o.ia.indexBuffer!==r.indexBuffer||o.count>=1024)){if(o.pso!==i){var s=o.pso.pipelineLayout.layouts[0].getBindingUnit(Gu.binding),l=i.pipelineLayout.layouts[0].getBindingUnit(Gu.binding);if((null==s?void 0:s.texView)!==(null==l?void 0:l.texView))continue}if(o.stride!==n)return;if(o.count>=o.capacity){o.capacity<<=1;var u=o.stride*o.capacity,c=o.data;o.data=new Uint8Array(u),o.data.set(c),o.vb.resize(u)}return void o.data.set(t.buffer,o.stride*o.count++)}}for(var h=this.pass.device,p=h.createBuffer({usage:exports.GFXBufferUsageBit.VERTEX|exports.GFXBufferUsageBit.TRANSFER_DST,memUsage:exports.GFXMemoryUsageBit.HOST|exports.GFXMemoryUsageBit.DEVICE,size:32*n,stride:n}),_=new Uint8Array(32*n),f=r.vertexBuffers.slice(),d=r.attributes.slice(),m=r.indexBuffer||void 0,v=0;v<t.list.length;v++){var y=t.list[v],g={name:y.name,format:y.format,stream:f.length,isInstanced:!0};void 0!==y.isNormalized&&(g.isNormalized=y.isNormalized),d.push(g)}_.set(t.buffer),f.push(p);var x=h.createInputAssembler({attributes:d,vertexBuffers:f,indexBuffer:m});this.instances.push({pso:i,count:1,capacity:32,vb:p,data:_,ia:x,stride:n})}}},{key:"uploadBuffers",value:function(){for(var e=0;e<this.instances.length;++e){var t=this.instances[e];t.count&&(t.ia.instanceCount=t.count,t.vb.update(t.data))}}},{key:"clear",value:function(){for(var e=0;e<this.instances.length;++e){this.instances[e].count=0}}}]),e}(),gh=(sh=new Map,lh=0,function(e){return"number"==typeof e?e:(sh.has(e)||(sh.set(e,1<<lh),lh++),sh.get(e))}),xh={memUsage:exports.GFXMemoryUsageBit.HOST|exports.GFXMemoryUsageBit.DEVICE,size:0,usage:exports.GFXBufferUsageBit.UNIFORM|exports.GFXBufferUsageBit.TRANSFER_DST},bh={bindings:null},Th={layouts:null},Sh={primitive:0,shader:null,inputState:null,rasterizerState:null,depthStencilState:null,blendState:null,dynamicStates:null,layout:null,renderPass:null,hash:0,program:"",defines:null,stage:0},Eh=function(){function e(t){Z(this,e),this._buffers={},this._samplers={},this._textureViews={},this._resources=[],this._phase=gh("default"),this._idxInTech=0,this._programName="",this._priority=Su.DEFAULT,this._primitive=exports.GFXPrimitiveMode.TRIANGLE_LIST,this._stage=Tu.DEFAULT,this._bindings=[],this._inputState=new Nr,this._bs=new Dr,this._dss=new Pr,this._rs=new Ir,this._dynamicStates=[],this._dynamics={},this._customizations=[],this._handleMap={},this._blocks=[],this._shaderInfo=null,this._defines={},this._properties={},this._hash=0,this._device=void 0,this._renderPass=null,this._shader=null,this._batchedBuffer=null,this._instancedBuffer=null,this._device=t}return J(e,null,[{key:"fillinPipelineInfo",value:function(e,t){void 0!==t.priority&&(e._priority=t.priority),void 0!==t.primitive&&(e._primitive=t.primitive),void 0!==t.stage&&(e._stage=t.stage),void 0!==t.dynamicStates&&(e._dynamicStates=t.dynamicStates),t.customizations&&(e._customizations=t.customizations),t.phase&&(e._phase=gh(t.phase));var i=e._bs;if(t.blendState){var n=Object.assign({},t.blendState);n.targets&&n.targets.forEach((function(e,t){return Object.assign(i.targets[t]||(i.targets[t]=new Lr),e)})),delete n.targets,Object.assign(i,n)}Object.assign(e._rs,t.rasterizerState),Object.assign(e._dss,t.depthStencilState)}},{key:"getPSOHash",value:function(e){var t,i=$c.getKey(e.program,e.defines)+","+e.primitive;return i+=function(e){for(var t,i=",bs,".concat(e.isA2C,",").concat(e.blendColor),n=_e(e.targets);!(t=n()).done;){var r=t.value;i+=",bt,".concat(r.blend,",").concat(r.blendEq,",").concat(r.blendAlphaEq,",").concat(r.blendColorMask),i+=",".concat(r.blendSrc,",").concat(r.blendDst,",").concat(r.blendSrcAlpha,",").concat(r.blendDstAlpha)}return i}(e.blendState),i+=function(e){var t=",dss,".concat(e.depthTest,",").concat(e.depthWrite,",").concat(e.depthFunc);return t+=",".concat(e.stencilTestFront,",").concat(e.stencilFuncFront,",").concat(e.stencilRefFront,",").concat(e.stencilReadMaskFront),t+=",".concat(e.stencilFailOpFront,",").concat(e.stencilZFailOpFront,",").concat(e.stencilPassOpFront,",").concat(e.stencilWriteMaskFront),t+=",".concat(e.stencilTestBack,",").concat(e.stencilFuncBack,",").concat(e.stencilRefBack,",").concat(e.stencilReadMaskBack),t+=",".concat(e.stencilFailOpBack,",").concat(e.stencilZFailOpBack,",").concat(e.stencilPassOpBack,",").concat(e.stencilWriteMaskBack)}(e.depthStencilState),i+=",rs,"+(t=e.rasterizerState).cullMode+","+t.depthBias+","+t.isFrontFaceCCW,rl(i+=function(e){var t=",ds";for(var i in e)t+=","+i;return t}(e.dynamicStates),666)}}]),J(e,[{key:"initialize",value:function(e){this._doInit(e),this.resetUBOs(),this.resetTextures()}},{key:"getHandle",value:function(e){var t=arguments.length>1&&void 0!==arguments[1]?arguments[1]:0,i=arguments.length>2&&void 0!==arguments[2]?arguments[2]:exports.GFXType.UNKNOWN,n=this._handleMap[e];if(n)return i?n=Uc(n,i):t&&(n=Uc(n,zc(n)-t)),n+t}},{key:"getBinding",value:function(t){var i=this.getHandle(t);if(void 0!==i)return e.getBindingFromHandle(i)}},{key:"setUniform",value:function(t,i){var n=e.getBindingFromHandle(t),r=e.getTypeFromHandle(t),a=e.getOffsetFromHandle(t),o=this._blocks[n];Vc[r](o.view,i,a),o.dirty=!0}},{key:"getUniform",value:function(t,i){var n=e.getBindingFromHandle(t),r=e.getTypeFromHandle(t),a=e.getOffsetFromHandle(t),o=this._blocks[n];return Xc[r](o.view,i,a)}},{key:"setUniformArray",value:function(t,i){for(var n=e.getBindingFromHandle(t),r=e.getTypeFromHandle(t),a=Tr(r)>>2,o=this._blocks[n],s=e.getOffsetFromHandle(t),l=0;l<i.length;l++,s+=a)null!==i[l]&&Vc[r](o.view,i[l],s);o.dirty=!0}},{key:"bindBuffer",value:function(e,t){if(this._buffers[e]!==t){this._buffers[e]=t;for(var i=this._resources.length,n=0;n<i;n++){this._resources[n].bindingLayout.bindBuffer(e,t)}}}},{key:"bindTextureView",value:function(e,t){if(this._textureViews[e]!==t){this._textureViews[e]=t;for(var i=this._resources.length,n=0;n<i;n++){this._resources[n].bindingLayout.bindTextureView(e,t)}}}},{key:"bindSampler",value:function(e,t){if(this._samplers[e]!==t){this._samplers[e]=t;for(var i=this._resources.length,n=0;n<i;n++){this._resources[n].bindingLayout.bindSampler(e,t)}}}},{key:"setDynamicState",value:function(e,t){var i=this._dynamics[e];i&&i.value===t||(i.value=t,i.dirty=!0)}},{key:"overridePipelineStates",value:function(e,t){console.warn("base pass cannot override states, please use pass instance instead.")}},{key:"update",value:function(){for(var e=this._blocks.length,t=0;t<e;t++){var i=this._blocks[t];i.dirty&&(this._buffers[t].update(i.view),i.dirty=!1)}for(var n=cc.director.root.pipeline.globalBindings,r=this._shaderInfo.builtins.globals,a=r.samplers.length,o=0;o<a;o++){var s=r.samplers[o],l=n.get(s.name);l.sampler&&this.bindSampler(l.samplerInfo.binding,l.sampler),this.bindTextureView(l.samplerInfo.binding,l.textureView)}}},{key:"destroy",value:function(){for(var e,t=_e(this._shaderInfo.blocks);!(e=t()).done;){var i=e.value;wu(i.binding)||this._buffers[i.binding].destroy()}this._buffers={},this._samplers={},this._textureViews={},this._instancedBuffer&&(this._instancedBuffer.destroy(),this._instancedBuffer=null),this._batchedBuffer&&(this._batchedBuffer.destroy(),this._batchedBuffer=null)}},{key:"resetUniform",value:function(t){var i=this.getHandle(t),n=e.getTypeFromHandle(i),r=e.getBindingFromHandle(i),a=e.getOffsetFromHandle(i),o=this._blocks[r],s=this._properties[t],l=s&&s.value||Wc(n);Vc[n](o.view,l,a),o.dirty=!0}},{key:"resetTexture",value:function(t){var i=this.getHandle(t),n=e.getTypeFromHandle(i),r=e.getBindingFromHandle(i),a=this._properties[t],o=a&&a.value,s=o?o+"-texture":Wc(n),l=Pc.get(s),u=l&&l.getGFXTextureView(),c=a&&void 0!==a.samplerHash?a.samplerHash:l.getSamplerHash(),h=ou.getSampler(this._device,c);this._textureViews[r]=u,this._samplers[r]=h;for(var p=0;p<this._resources.length;p++){var _=this._resources[p];_.bindingLayout.bindSampler(r,h),_.bindingLayout.bindTextureView(r,u)}}},{key:"resetUBOs",value:function(){for(var e,t=_e(this._shaderInfo.blocks);!(e=t()).done;){var i=e.value;if(!wu(i.binding)){var n=this._blocks[i.binding];if(n){for(var r=0,a=0;a<i.members.length;a++){for(var o=i.members[a],s=this._properties[o.name],l=s&&s.value,u=l||Wc(o.type),c=(Tr(o.type)>>2)*o.count,h=0;h+u.length<=c;h+=u.length)n.view.set(u,r+h);r+=c}n.dirty=!0}}}}},{key:"resetTextures",value:function(){for(var e,t=_e(this._shaderInfo.samplers);!(e=t()).done;){var i=e.value;wu(i.binding)||this.resetTexture(i.name)}}},{key:"tryCompile",value:function(){var t=cc.director.root.pipeline;if(!t)return this._hash=e.getPSOHash(this),null;if(this._dynamicBatchingSync(),this._renderPass=t.getRenderPass(this._stage),!this._renderPass)return console.warn("illegal pass stage."),!1;Object.assign(this._defines,t.macros);var i=$c.getKey(this._programName,this._defines),n=$c.getGFXShader(this._device,this._programName,this._defines,t,i);return n.shader?(this._shader=n.shader,this._bindings=n.bindings,this._inputState=n.inputState,this._hash=e.getPSOHash(this),!0):(console.warn("create shader ".concat(this._programName," failed")),!1)}},{key:"createPipelineState",value:function(e){if(!(this._renderPass&&this._shader&&this._bindings.length||this.tryCompile()))return console.warn("pass resources not complete, create PSO failed"),null;var t=e?this._getShaderWithBuiltinMacroPatches(e):null,i=t&&t.shader||this._shader;bh.bindings=t&&t.bindings||this._bindings;var n=this._device.createBindingLayout(bh);for(var r in this._buffers)n.bindBuffer(parseInt(r),this._buffers[r]);for(var a in this._samplers)n.bindSampler(parseInt(a),this._samplers[a]);for(var o in this._textureViews)n.bindTextureView(parseInt(o),this._textureViews[o]);for(var s,l=cc.director.root.pipeline.globalBindings,u=this._shaderInfo.builtins.globals,c=_e(u.blocks);!(s=c()).done;){var h=s.value,p=l.get(h.name);p&&p.type===exports.GFXBindingType.UNIFORM_BUFFER?n.bindBuffer(p.blockInfo.binding,p.buffer):console.warn("builtin UBO '".concat(h.name,"' not available!"))}for(var _,f=_e(u.samplers);!(_=f()).done;){var d=_.value,m=l.get(d.name);m&&m.type===exports.GFXBindingType.SAMPLER?(m.sampler&&n.bindSampler(m.samplerInfo.binding,m.sampler),n.bindTextureView(m.samplerInfo.binding,m.textureView)):console.warn("builtin texture '".concat(d.name,"' not available!"))}Th.layouts=[n];var v=this._device.createPipelineLayout(Th);Sh.inputState=t&&t.inputState||this._inputState,Sh.primitive=this._primitive,Sh.shader=i,Sh.rasterizerState=this._rs,Sh.depthStencilState=this._dss,Sh.blendState=this._bs,Sh.dynamicStates=this._dynamicStates,Sh.layout=v,Sh.renderPass=this._renderPass,Sh.program=this._programName,Sh.defines=this._defines,Sh.stage=this._stage,Sh.hash=this._hash;var y=this._device.createPipelineState(Sh);return this._resources.push({bindingLayout:n,pipelineLayout:v,pipelineState:y}),y}},{key:"destroyPipelineState",value:function(e){var t=this._resources.findIndex((function(t){return t.pipelineState===e}));if(t>=0){var i=this._resources[t],n=i.bindingLayout,r=i.pipelineLayout,a=i.pipelineState;n.destroy(),r.destroy(),a.destroy(),this._resources.splice(t,1)}}},{key:"beginChangeStatesSilently",value:function(){}},{key:"endChangeStatesSilently",value:function(){}},{key:"_doInit",value:function(t){var i=arguments.length>1&&void 0!==arguments[1]&&arguments[1];this._idxInTech=t.idxInTech,this._programName=t.program,this._defines=i?Object.assign({},t.defines):t.defines,this._shaderInfo=$c.getTemplate(t.program),this._properties=t.properties||this._properties;var n=this._device;e.fillinPipelineInfo(this,t),t.stateOverrides&&e.fillinPipelineInfo(this,t.stateOverrides);for(var r=this._shaderInfo.blocks,a=0;a<r.length;a++){var o=r[a],s=o.size,l=o.binding;if(!wu(l)){xh.size=16*Math.ceil(s/16),this._buffers[l]=n.createBuffer(xh);var u=new ArrayBuffer(s);this._blocks[l]={view:new Float32Array(u),dirty:!1}}}var c=this._handleMap=this._shaderInfo.handleMap,h={};for(var p in this._properties){var _=this._properties[p];_.handleInfo&&(h[p]=this.getHandle.apply(this,_.handleInfo))}Object.assign(c,h),this.tryCompile()}},{key:"_dynamicBatchingSync",value:function(){this._defines.USE_INSTANCING?this._device.hasFeature(exports.GFXFeature.INSTANCED_ARRAYS)?this._instancedBuffer||(this._instancedBuffer=new yh(this)):this._defines.USE_INSTANCING=!1:this._defines.USE_BATCHING&&(this._batchedBuffer||(this._batchedBuffer=new vh(this))),!this._defines.USE_INSTANCING&&this._instancedBuffer&&(this._instancedBuffer.destroy(),this._instancedBuffer=null),!this._defines.USE_BATCHING&&this._batchedBuffer&&(this._batchedBuffer.destroy(),this._batchedBuffer=null)}},{key:"_getShaderWithBuiltinMacroPatches",value:function(e){var t=cc.director.root.pipeline;if(!t)return null;for(var i=0;i<e.length;i++){var n=e[i];this._defines[n.name]=n.value}for(var r=$c.getGFXShader(this._device,this._programName,this._defines,t),a=0;a<e.length;a++){var o=e[a];delete this._defines[o.name]}return r}},{key:"priority",get:function(){return this._priority}},{key:"primitive",get:function(){return this._primitive}},{key:"stage",get:function(){return this._stage}},{key:"inputState",get:function(){return this._inputState}},{key:"rasterizerState",get:function(){return this._rs}},{key:"depthStencilState",get:function(){return this._dss}},{key:"blendState",get:function(){return this._bs}},{key:"dynamicStates",get:function(){return this._dynamicStates}},{key:"customizations",get:function(){return this._customizations}},{key:"phase",get:function(){return this._phase}},{key:"device",get:function(){return this._device}},{key:"shaderInfo",get:function(){return this._shaderInfo}},{key:"program",get:function(){return this._programName}},{key:"properties",get:function(){return this._properties}},{key:"defines",get:function(){return this._defines}},{key:"idxInTech",get:function(){return this._idxInTech}},{key:"bindings",get:function(){return this._bindings}},{key:"shader",get:function(){return this._shader}},{key:"renderPass",get:function(){return this._renderPass}},{key:"dynamics",get:function(){return this._dynamics}},{key:"batchedBuffer",get:function(){return this._batchedBuffer}},{key:"instancedBuffer",get:function(){return this._instancedBuffer}},{key:"blocks",get:function(){return this._blocks}},{key:"hash",get:function(){return this._hash}}]),e}();Eh.getBindingTypeFromHandle=Nc,Eh.getTypeFromHandle=zc,Eh.getBindingFromHandle=Bc,Eh.getOffsetFromHandle=Gc;var wh,Ch,Ah,Oh,kh,Rh,Fh,Mh,Ih,Ph={},Lh=Yo("cc.EffectAsset")((dh=fh=function(e){function t(){var e,i;Z(this,t);for(var n=arguments.length,r=new Array(n),a=0;a<n;a++)r[a]=arguments[a];return fe(i=re(this,(e=te(t)).call.apply(e,[this].concat(r))),"techniques",hh,ne(i)),fe(i,"shaders",ph,ne(i)),fe(i,"combinations",_h,ne(i)),i}return ee(t,zl),J(t,[{key:"onLoaded",value:function(){this.shaders.forEach((function(e){return $c.define(e)})),cc.game.once(cc.Game.EVENT_ENGINE_INITED,this._precompile,this),t.register(this)}},{key:"_precompile",value:function(){for(var e=this,t=cc.director.root,i=function(i){var n=e.shaders[i],r=e.combinations[i];if(!r)return"continue";Object.keys(r).reduce((function(e,t){return e.reduce((function(e,i){var n=r[t],a=[i].concat(ce(Array(n.length-1)).map((function(){return Object.assign({},i)})));return a.forEach((function(e,i){return e[t]=n[i]})),e.concat(a)}),[])}),[{}]).forEach((function(e){return $c.getGFXShader(t.device,n.name,e,t.pipeline)}))},n=0;n<this.shaders.length;n++)i(n)}}],[{key:"register",value:function(e){Ph[e.name]=e}},{key:"remove",value:function(e){if(Ph[e])delete Ph[e];else for(var t in Ph)if(Ph[t]._uuid===e)return void delete Ph[t]}},{key:"get",value:function(e){if(Ph[e])return Ph[e];for(var t in Ph)if(Ph[t]._uuid===e)return Ph[t];return null}},{key:"getAll",value:function(){return Ph}}]),t}(),fh._effects={},hh=de((ch=dh).prototype,"techniques",[Ko],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return[]}}),ph=de(ch.prototype,"shaders",[Ko],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return[]}}),_h=de(ch.prototype,"combinations",[Ko],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return[]}}),uh=ch))||uh;cc.EffectAsset=Lh;var Dh,Nh,zh,Bh=(wh=Yo("cc.Material"),Ch=Ko(Lh),wh((kh=de((Oh=function(e){function t(){var e;return Z(this,t),fe(e=re(this,te(t).call(this)),"_effectAsset",kh,ne(e)),fe(e,"_techIdx",Rh,ne(e)),fe(e,"_defines",Fh,ne(e)),fe(e,"_states",Mh,ne(e)),fe(e,"_props",Ih,ne(e)),e._passes=[],e._hash=0,e.loaded=!1,e}return ee(t,zl),J(t,[{key:"effectAsset",get:function(){return this._effectAsset}},{key:"effectName",get:function(){return this._effectAsset?this._effectAsset.name:""}},{key:"technique",get:function(){return this._techIdx}},{key:"passes",get:function(){return this._passes}},{key:"hash",get:function(){return this._hash}},{key:"parent",get:function(){return null}},{key:"owner",get:function(){return null}}],[{key:"getHash",value:function(e){for(var t,i=0,n=_e(e.passes);!(t=n()).done;){i^=t.value.hash}return i}}]),J(t,[{key:"initialize",value:function(e){this._defines||(this._defines=[]),this._states||(this._states=[]),this._props||(this._props=[]),void 0!==e.technique&&(this._techIdx=e.technique),e.effectAsset?this._effectAsset=e.effectAsset:e.effectName&&(this._effectAsset=Lh.get(e.effectName)),e.defines&&this._prepareInfo(e.defines,this._defines),e.states&&this._prepareInfo(e.states,this._states),this._update()}},{key:"reset",value:function(e){this.initialize(e)}},{key:"destroy",value:function(){return this._doDestroy(),oe(te(t.prototype),"destroy",this).call(this)}},{key:"recompileShaders",value:function(e,t){console.warn("Shaders in material asset '"+this.name+"' cannot be modified at runtime, please instantiate the material first.")}},{key:"overridePipelineStates",value:function(e,t){console.warn("Pipeline states in material asset '"+this.name+"' cannot be modified at runtime, please instantiate the material first.")}},{key:"onLoaded",value:function(){this._update(),this.loaded=!0,this.emit("load")}},{key:"resetUniforms",value:function(){var e=!(arguments.length>0&&void 0!==arguments[0])||arguments[0];this._props.length=this._passes.length;for(var t=0;t<this._props.length;t++)this._props[t]={};if(e)for(var i,n=_e(this._passes);!(i=n()).done;){var r=i.value;r.resetUBOs(),r.resetTextures()}}},{key:"setProperty",value:function(e,t,i){var n=!1;if(void 0===i)for(var r=this._passes,a=r.length,o=0;o<a;o++){var s=r[o];this._uploadProperty(s,e,t)&&(this._props[o][e]=t,n=!0)}else{if(i>=this._passes.length)return void console.warn("illegal pass index: ".concat(i,"."));var l=this._passes[i];this._uploadProperty(l,e,t)&&(this._props[i][e]=t,n=!0)}n||console.warn("illegal property name: ".concat(e,"."))}},{key:"getProperty",value:function(e,t){if(void 0===t)for(var i=this._props,n=i.length,r=0;r<n;r++){var a=i[r];for(var o in a)if(o===e)return a[o]}else{if(t>=this._props.length)return console.warn("illegal pass index: ".concat(t,".")),null;var s=this._props[t];for(var l in s)if(l===e)return s[l]}return null}},{key:"copy",value:function(e){this._techIdx=e._techIdx,this._props.length=e._props.length;for(var t=0;t<e._props.length;t++)this._props[t]=Object.assign({},e._props[t]);this._defines.length=e._defines.length;for(var i=0;i<e._defines.length;i++)this._defines[i]=Object.assign({},e._defines[i]);this._states.length=e._states.length;for(var n=0;n<e._states.length;n++)this._states[n]=Object.assign({},e._states[n]);this._effectAsset=e._effectAsset,this._update()}},{key:"_prepareInfo",value:function(e,t){if(!Array.isArray(e)){var i=this._effectAsset?this._effectAsset.techniques[this._techIdx].passes.length:1;e=Array(i).fill(e)}for(var n=0;n<e.length;++n)Object.assign(t[n]||(t[n]={}),e[n])}},{key:"_createPasses",value:function(){var e=this._effectAsset.techniques[this._techIdx||0];if(!e)return[];for(var t=e.passes.length,i=[],n=0;n<t;++n){var r=e.passes[n],a=r.defines=this._defines.length>n?this._defines[n]:{};if(!r.switch||a[r.switch]){r.stateOverrides=this._states.length>n?this._states[n]:{},r.idxInTech=n;var o=new Eh(cc.director.root.device);o.initialize(r),i.push(o)}}return i}},{key:"_update",value:function(){var e=this,i=!(arguments.length>0&&void 0!==arguments[0])||arguments[0];if(this._effectAsset){if(this._passes&&this._passes.length)for(var n,r=_e(this._passes);!(n=r()).done;){var a=n.value;a.destroy()}this._passes=this._createPasses();var o=this._effectAsset.techniques[this._techIdx].passes.length;if(this._props.length=o,i)this._passes.forEach((function(t,i){var n=e._props[t.idxInTech];for(var r in n||(n=e._props[i]={}),n)e._uploadProperty(t,r,n[r])}));else for(var s=0;s<this._props.length;s++)this._props[s]={}}else{var l=Pc.get("missing-effect-material");l&&(this._passes=l._passes.slice())}this._hash=t.getHash(this)}},{key:"_uploadProperty",value:function(e,t,i){var n=e.getHandle(t);if(void 0===n)return!1;var r=Eh.getBindingTypeFromHandle(n);if(r===exports.GFXBindingType.UNIFORM_BUFFER)Array.isArray(i)?e.setUniformArray(n,i):null!==i?e.setUniform(n,i):e.resetUniform(t);else if(r===exports.GFXBindingType.SAMPLER){var a=Eh.getBindingFromHandle(n);if(i instanceof qr)e.bindTextureView(a,i);else if(i instanceof lu||i instanceof Ac){var o=i.getGFXTextureView();if(!o||!o.texture.width||!o.texture.height)return!1;e.bindTextureView(a,o),i instanceof lu&&e.bindSampler(a,ou.getSampler(cc.director.root.device,i.getSamplerHash()))}else i||e.resetTexture(t)}return!0}},{key:"_doDestroy",value:function(){if(this._passes&&this._passes.length)for(var e,t=_e(this._passes);!(e=t()).done;){e.value.destroy()}this._effectAsset=null,this._passes.length=0,this._props.length=0,this._defines.length=0,this._states.length=0}}]),t}()).prototype,"_effectAsset",[Ch],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return null}}),Rh=de(Oh.prototype,"_techIdx",[Ko],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return 0}}),Fh=de(Oh.prototype,"_defines",[Ko],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return[]}}),Mh=de(Oh.prototype,"_states",[Ko],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return[]}}),Ih=de(Oh.prototype,"_props",[Ko],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return[]}}),Ah=Oh))||Ah);cc.Material=Bh;var Gh=Yo("cc.Script")(Dh=function(e){function t(){return Z(this,t),re(this,te(t).apply(this,arguments))}return ee(t,zl),t}())||Dh;cc._Script=Gh;var Uh=Yo("cc.JavaScript")(Nh=function(e){function t(){return Z(this,t),re(this,te(t).apply(this,arguments))}return ee(t,Gh),t}())||Nh;cc._JavaScript=Uh;var Xh,Vh,Hh,Wh,jh,qh,Yh,Kh,Zh,Qh,Jh,$h,ep,tp=Yo("cc.TypeScript")(zh=function(e){function t(){return Z(this,t),re(this,te(t).apply(this,arguments))}return ee(t,Gh),t}())||zh;cc._TypeScript=tp;var ip=new be("Comp"),np=(sl.Flags.IsOnEnableCalled,sl.Flags.IsOnLoadCalled),rp=(Xh=Yo("cc.Component"),Vh=Ko({visible:!1}),Hh=Ko({visible:!1}),Wh=Ko({displayName:"Script",type:Gh,tooltip:void 0}),jh=Ko({visible:!1}),qh=Ko({visible:!1}),Yh=Ko({visible:!1}),Xh((ep=$h=function(e){function t(){var e,i;Z(this,t);for(var n=arguments.length,r=new Array(n),a=0;a<n;a++)r[a]=arguments[a];return fe(i=re(this,(e=te(t)).call.apply(e,[this].concat(r))),"node",Qh,ne(i)),fe(i,"_enabled",Jh,ne(i)),i._sceneGetter=null,i._id=ip.getNewId(),i}return ee(t,sl),J(t,[{key:"_getRenderScene",value:function(){return this._sceneGetter?this._sceneGetter():this.node.scene._renderScene}},{key:"addComponent",value:function(e){return this.node.addComponent(e)}},{key:"getComponent",value:function(e){return this.node.getComponent(e)}},{key:"getComponents",value:function(e){return this.node.getComponents(e)}},{key:"getComponentInChildren",value:function(e){return this.node.getComponentInChildren(e)}},{key:"getComponentsInChildren",value:function(e){return this.node.getComponentsInChildren(e)}},{key:"destroy",value:function(){oe(te(t.prototype),"destroy",this).call(this)&&this._enabled&&this.node.activeInHierarchy&&cc.director._compScheduler.disableComp(this)}},{key:"_onPreDestroy",value:function(){this.unscheduleAllCallbacks(),cc.director._nodeActivator.destroyComp(this),this.node._removeComponent(this)}},{key:"_instantiate",value:function(e){return e||(e=cc.instantiate._clone(this,this)),e.node=null,e}},{key:"schedule",value:function(e){var t=arguments.length>1&&void 0!==arguments[1]?arguments[1]:0,i=arguments.length>2&&void 0!==arguments[2]?arguments[2]:cc.macro.REPEAT_FOREVER,n=arguments.length>3&&void 0!==arguments[3]?arguments[3]:0;cc.assertID(e,1619),cc.assertID(t>=0,1620),t=t||0,i=isNaN(i)?cc.macro.REPEAT_FOREVER:i,n=n||0;var r=cc.director.getScheduler(),a=r.isTargetPaused(this);r.schedule(e,this,t,i,n,a)}},{key:"scheduleOnce",value:function(e){var t=arguments.length>1&&void 0!==arguments[1]?arguments[1]:0;this.schedule(e,0,0,t)}},{key:"unschedule",value:function(e){e&&cc.director.getScheduler().unschedule(e,this)}},{key:"unscheduleAllCallbacks",value:function(){cc.director.getScheduler().unscheduleAllForTarget(this)}},{key:"name",get:function(){if(this._name)return this._name;var e=Fe(this),t=e.lastIndexOf(".");return t>=0&&(e=e.slice(t+1)),this.node.name+"<"+e+">"},set:function(e){this._name=e}},{key:"uuid",get:function(){return this._id}},{key:"__scriptAsset",get:function(){return null}},{key:"enabled",get:function(){return this._enabled},set:function(e){if(this._enabled!==e&&(this._enabled=e,this.node.activeInHierarchy)){var t=cc.director._compScheduler;e?t.enableComp(this):t.disableComp(this)}}},{key:"enabledInHierarchy",get:function(){return this._enabled&&this.node&&this.node.activeInHierarchy}},{key:"_isOnLoadCalled",get:function(){return this._objFlags&np}}]),t}(),$h.system=null,de((Zh=ep).prototype,"name",[Vh],Object.getOwnPropertyDescriptor(Zh.prototype,"name"),Zh.prototype),de(Zh.prototype,"uuid",[Hh],Object.getOwnPropertyDescriptor(Zh.prototype,"uuid"),Zh.prototype),de(Zh.prototype,"__scriptAsset",[Wh],Object.getOwnPropertyDescriptor(Zh.prototype,"__scriptAsset"),Zh.prototype),de(Zh.prototype,"enabled",[jh],Object.getOwnPropertyDescriptor(Zh.prototype,"enabled"),Zh.prototype),de(Zh.prototype,"enabledInHierarchy",[qh],Object.getOwnPropertyDescriptor(Zh.prototype,"enabledInHierarchy"),Zh.prototype),Qh=de(Zh.prototype,"node",[Yh],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return null}}),Jh=de(Zh.prototype,"_enabled",[Ko],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return!0}}),Kh=Zh))||Kh),ap=rp.prototype;ap.update=null,ap.lateUpdate=null,ap.__preload=null,ap.onLoad=null,ap.start=null,ap.onEnable=null,ap.onDisable=null,ap.onDestroy=null,ap.onFocusInEditor=null,ap.onLostFocusInEditor=null,ap.resetInEditor=null,ap._getLocalBounds=null,ap.onRestore=null,rp._requireComponent=null,rp._executionOrder=0,Ce(rp,"_registerEditorProps",(function(e,t){var i=t.requireComponent;i&&(e._requireComponent=i);var n=t.executionOrder;n&&"number"==typeof n&&(e._executionOrder=n)})),cc.Component=rp;var op,sp,lp,up,cp,hp,pp,_p,fp,dp,mp,vp,yp,gp,xp,bp,Tp,Sp,Ep,wp,Cp,Ap,Op,kp,Rp,Fp,Mp,Ip,Pp,Lp,Dp,Np,zp,Bp,Gp,Up=function(e){function t(e,i){var n;Z(this,t),(n=re(this,te(t).call(this,e.device)))._parent=void 0,n._owner=void 0,n._dontNotify=!1,n._parent=e,n._owner=i,n._doInit(n._parent,!0);for(var r,a=_e(n._shaderInfo.blocks);!(r=a()).done;){var o=r.value;if(!wu(o.binding)){var s=n._blocks[o.binding],l=n._parent.blocks[o.binding];s.view.set(l.view),s.dirty=!0}}for(var u,c=_e(n._shaderInfo.samplers);!(u=c()).done;){var h=u.value;wu(h.binding)||(n._textureViews[h.binding]=n._parent._textureViews[h.binding],n._samplers[h.binding]=n._parent._samplers[h.binding])}return n}return ee(t,Eh),J(t,[{key:"parent",get:function(){return this._parent}}]),J(t,[{key:"overridePipelineStates",value:function(e,t){this._bs=new Dr,this._dss=new Pr,this._rs=new Ir,Eh.fillinPipelineInfo(this,e),Eh.fillinPipelineInfo(this,t),this._onStateChange()}},{key:"tryCompile",value:function(e){if(e&&!jc(this._defines,e))return!1;var i=oe(te(t.prototype),"tryCompile",this).call(this);return this._onStateChange(),i}},{key:"beginChangeStatesSilently",value:function(){this._dontNotify=!0}},{key:"endChangeStatesSilently",value:function(){this._dontNotify=!1}},{key:"_dynamicBatchingSync",value:function(){this._defines.USE_BATCHING=this._defines.USE_INSTANCING=!1}},{key:"_onStateChange",value:function(){this._hash=Eh.getPSOHash(this),this._owner.onPassStateChange(this._dontNotify)}}]),t}(),Xp=function(e){function t(e){var i;return Z(this,t),(i=re(this,te(t).call(this)))._passes=[],i._parent=void 0,i._owner=void 0,i._subModelIdx=0,i._parent=e.parent,i._owner=e.owner||null,i._subModelIdx=e.subModelIdx||0,i.copy(i._parent),i}return ee(t,Bh),J(t,[{key:"parent",get:function(){return this._parent}},{key:"owner",get:function(){return this._owner}}]),J(t,[{key:"recompileShaders",value:function(e,t){if(this._passes&&this.effectAsset)if(void 0===t)for(var i,n=_e(this._passes);!(i=n()).done;){i.value.tryCompile(e)}else this._passes[t].tryCompile(e)}},{key:"overridePipelineStates",value:function(e,t){if(this._passes&&this.effectAsset){var i=this.effectAsset.techniques[this.technique].passes;if(void 0===t)for(var n=0;n<this._passes.length;n++){var r=this._passes[n];this._states[n]=e,r.overridePipelineStates(i[r.idxInTech],e)}else this._states[t]=e,this._passes[t].overridePipelineStates(i[t],e)}}},{key:"destroy",value:function(){return this._doDestroy(),!0}},{key:"onPassStateChange",value:function(e){this._hash=Bh.getHash(this),!e&&this._owner&&this._owner._onRebuildPSO(this._subModelIdx,this)}},{key:"_createPasses",value:function(){var e=[],t=this._parent.passes;if(!t)return e;for(var i=0;i<t.length;++i)e.push(new Up(t[i],this));return e}}]),t}(),Vp={parent:null,owner:null,subModelIdx:0},Hp=(op=Yo("cc.RenderableComponent"),sp=Ko({type:[Bh]}),lp=Ko({visible:!1}),up=Ko({type:Bh,displayName:"Materials"}),op((pp=de((hp=function(e){function t(){var e,i;Z(this,t);for(var n=arguments.length,r=new Array(n),a=0;a<n;a++)r[a]=arguments[a];return fe(i=re(this,(e=te(t)).call.apply(e,[this].concat(r))),"_materials",pp,ne(i)),fe(i,"_visFlags",_p,ne(i)),i._materialInstances=[],i._models=[],i}return ee(t,rp),J(t,[{key:"getMaterial",value:function(e){return e<0||e>=this._materials.length?null:this._materials[e]}},{key:"setMaterial",value:function(e,t){e&&e instanceof Xp&&console.error("Can't set a material instance to a sharedMaterial slot"),this._materials[t]=e;var i=this._materialInstances[t];i?i.parent!==this._materials[t]&&(i.destroy(),this._materialInstances[t]=null,this._onMaterialModified(t,this._materials[t])):this._onMaterialModified(t,this._materials[t])}},{key:"getMaterialInstance",value:function(e){if(!this._materials[e])return null;if(!this._materialInstances[e]){Vp.parent=this._materials[e],Vp.owner=this,Vp.subModelIdx=e;var t=new Xp(Vp);this.setMaterialInstance(e,t)}return this._materialInstances[e]}},{key:"setMaterialInstance",value:function(e,t){t&&t.parent?t!==this._materialInstances[e]&&(this._materialInstances[e]=t,this._onMaterialModified(e,t)):t!==this._materials[e]&&this.setMaterial(t,e)}},{key:"getRenderMaterial",value:function(e){return this._materialInstances[e]||this._materials[e]}},{key:"_collectModels",value:function(){return this._models}},{key:"_attachToScene",value:function(){}},{key:"_detachFromScene",value:function(){}},{key:"_onMaterialModified",value:function(e,t){}},{key:"_onRebuildPSO",value:function(e,t){}},{key:"_clearMaterials",value:function(){}},{key:"_onVisibilityChange",value:function(e){}},{key:"visibility",get:function(){return this._visFlags},set:function(e){this._visFlags=e,this._onVisibilityChange(e)}},{key:"sharedMaterials",get:function(){return this._materials},set:function(e){for(var t=0;t<e.length;t++)e[t]!==this._materials[t]&&this.setMaterial(e[t],t);if(e.length<this._materials.length){for(var i=e.length;i<this._materials.length;i++)this.setMaterial(null,i);this._materials.splice(e.length)}}},{key:"materials",get:function(){for(var e=0;e<this._materials.length;e++)this._materialInstances[e]=this.getMaterialInstance(e);return this._materialInstances},set:function(e){var t=e.length-this._materials.length;if(t>0)this._materials.length=e.length,this._materialInstances.length=e.length;else if(t<0)for(var i=this._materials.length-t;i<this._materials.length;++i)this.setMaterialInstance(i,null);for(var n=0;n<this._materialInstances.length;n++)this._materialInstances[n]!=e[n]&&this.setMaterialInstance(n,e[n])}},{key:"sharedMaterial",get:function(){return this.getMaterial(0)}},{key:"material",get:function(){return this.getMaterialInstance(0)},set:function(e){1===this._materials.length&&this._materials[0]===e||this.setMaterialInstance(0,e)}}]),t}()).prototype,"_materials",[sp],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return[]}}),_p=de(hp.prototype,"_visFlags",[Ko],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return bu.Enum.NONE}}),de(hp.prototype,"visibility",[lp],Object.getOwnPropertyDescriptor(hp.prototype,"visibility"),hp.prototype),de(hp.prototype,"sharedMaterials",[up],Object.getOwnPropertyDescriptor(hp.prototype,"sharedMaterials"),hp.prototype),cp=hp))||cp),Wp=xt({OFF:0,ON:1}),jp=(fp=Yo("cc.ModelLightmapSettings"),dp=Ko({visible:!1}),mp=Ko({visible:!1}),vp=Ko({formerlySerializedAs:"_recieveShadow"}),fp((xp=de((gp=function(){function e(){Z(this,e),fe(this,"texture",xp,this),fe(this,"uvParam",bp,this),fe(this,"_bakeable",Tp,this),fe(this,"_castShadow",Sp,this),fe(this,"_receiveShadow",Ep,this),fe(this,"_lightmapSize",wp,this)}return J(e,[{key:"bakeable",get:function(){return this._bakeable},set:function(e){this._bakeable=e}},{key:"castShadow",get:function(){return this._castShadow},set:function(e){this._castShadow=e}},{key:"receiveShadow",get:function(){return this._receiveShadow},set:function(e){this._receiveShadow=e}},{key:"lightmapSize",get:function(){return this._lightmapSize},set:function(e){this._lightmapSize=e}}]),e}()).prototype,"texture",[dp],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return null}}),bp=de(gp.prototype,"uvParam",[mp],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return new Ni}}),Tp=de(gp.prototype,"_bakeable",[Ko],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return!1}}),Sp=de(gp.prototype,"_castShadow",[Ko],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return!1}}),Ep=de(gp.prototype,"_receiveShadow",[vp],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return!1}}),wp=de(gp.prototype,"_lightmapSize",[Ko],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return 64}}),de(gp.prototype,"bakeable",[Ko],Object.getOwnPropertyDescriptor(gp.prototype,"bakeable"),gp.prototype),de(gp.prototype,"castShadow",[Ko],Object.getOwnPropertyDescriptor(gp.prototype,"castShadow"),gp.prototype),de(gp.prototype,"receiveShadow",[Ko],Object.getOwnPropertyDescriptor(gp.prototype,"receiveShadow"),gp.prototype),de(gp.prototype,"lightmapSize",[Ko],Object.getOwnPropertyDescriptor(gp.prototype,"lightmapSize"),gp.prototype),yp=gp))||yp);function qp(e,t){var i=e.sharedMaterials.length;if(i!==t.sharedMaterials.length)return!1;for(var n=0;n<i;n++)if(e.getRenderMaterial(n)!==t.getRenderMaterial(n))return!1;return!0}exports.ModelComponent=(Cp=Yo("cc.ModelComponent"),Ap=os("i18n:cc.ModelComponent"),Op=ts(100),kp=es("Components/Model"),Rp=Ko({type:Wp,tooltip:"i18n:model.shadow_casting_model"}),Fp=Ko({type:rc,tooltip:"i18n:model.mesh"}),Mp=Ko({visible:function(){return!!(this.mesh&&this.mesh.struct.morph&&this.mesh.struct.morph.subMeshMorphs.some((function(e){return!!e})))}}),Cp(Ip=Ap(Ip=Op(Ip=kp(Ip=Jo((Gp=Bp=function(e){function t(){var e;return Z(this,t),fe(e=re(this,te(t).call(this)),"lightmapSettings",Lp,ne(e)),fe(e,"_mesh",Dp,ne(e)),fe(e,"_shadowCastingMode",Np,ne(e)),e._modelType=void 0,e._model=null,e._morphInstance=null,fe(e,"_enableMorph",zp,ne(e)),e._modelType=ah,e}return ee(t,Hp),J(t,[{key:"shadowCastingMode",get:function(){return this._shadowCastingMode},set:function(e){this._shadowCastingMode=e,this._updateCastShadow()}},{key:"mesh",get:function(){return this._mesh},set:function(e){var t,i=this._mesh;this._mesh=e,null===(t=this._mesh)||void 0===t||t.initialize(),this._watchMorphInMesh(),this._onMeshChanged(i),this._updateModels(),this.enabledInHierarchy&&this._attachToScene()}},{key:"model",get:function(){return this._model}},{key:"enableMorph",get:function(){return this._enableMorph},set:function(e){this._enableMorph=e}}]),J(t,[{key:"onLoad",value:function(){var e;null===(e=this._mesh)||void 0===e||e.initialize(),this._watchMorphInMesh(),this._updateModels(),this._updateCastShadow()}},{key:"onRestore",value:function(){this._updateModels()}},{key:"onEnable",value:function(){this._model||this._updateModels(),this._attachToScene()}},{key:"onDisable",value:function(){this._model&&this._detachFromScene()}},{key:"onDestroy",value:function(){this._model&&(cc.director.root.destroyModel(this._model),this._model=null,this._models.length=0),this._morphInstance&&this._morphInstance.destroy()}},{key:"setWeights",value:function(e,t){this._morphInstance&&this._morphInstance.setWeights(t,e)}},{key:"setInstancedAttribute",value:function(e,t){if(this.model)for(var i=this.model.instancedAttributes.list,n=0;n<i.length;n++)if(i[n].name===e){i[n].view.set(t);break}}},{key:"_updateLightmap",value:function(e,t,i,n,r){this.lightmapSettings.texture=e,this.lightmapSettings.uvParam.x=t,this.lightmapSettings.uvParam.y=i,this.lightmapSettings.uvParam.z=n,this.lightmapSettings.uvParam.w=r,this._onUpdateLightingmap()}},{key:"_updateModels",value:function(){this.enabledInHierarchy&&this._mesh&&(this._model?(this._model.destroy(),this._model.initialize(this.node)):this._createModel(),this._updateModelParams(),this._onUpdateLightingmap())}},{key:"_createModel",value:function(){var e=!!this._morphInstance&&this._modelType===ah?oh:this._modelType;this._model=cc.director.root.createModel(e),this._model.visFlags=this.visibility,this._model.initialize(this.node),this._models.length=0,this._models.push(this._model),this._morphInstance&&this._model instanceof oh&&this._model.setMorphRendering(this._morphInstance)}},{key:"_attachToScene",value:function(){if(this.node.scene&&this._model){var e=this._getRenderScene();null!=this._model.scene&&this._detachFromScene(),e.addModel(this._model)}}},{key:"_detachFromScene",value:function(){this._model&&this._model.scene&&this._model.scene.removeModel(this._model)}},{key:"_updateModelParams",value:function(){if(this._mesh&&this._model){this.node.hasChangedFlags|=rh.POSITION,this._model.transform.hasChangedFlags|=rh.POSITION,this._model.isDynamicBatching=this._isBatchingEnabled();var e=this._mesh?this._mesh.subMeshCount:0,t=this._mesh.renderingSubMeshes;if(t)for(var i=0;i<e;++i){var n=this.getRenderMaterial(i),r=t[i];r&&this._model.initSubModel(i,r,n||this._getBuiltinMaterial())}this._model.createBoundingShape(this._mesh.minPosition,this._mesh.maxPosition),this._model.enabled=!0}}},{key:"_onUpdateLightingmap",value:function(){null!==this.model&&this.model.updateLightingmap(this.lightmapSettings.texture,this.lightmapSettings.uvParam),this.setInstancedAttribute("a_lightingMapUVParam",[this.lightmapSettings.uvParam.x,this.lightmapSettings.uvParam.y,this.lightmapSettings.uvParam.z,this.lightmapSettings.uvParam.w])}},{key:"_onMaterialModified",value:function(e,t){this._model&&this._model.inited&&this._onRebuildPSO(e,t||this._getBuiltinMaterial())}},{key:"_onRebuildPSO",value:function(e,t){this._model&&this._model.inited&&(this._model.isDynamicBatching=this._isBatchingEnabled(),this._model.setSubModelMaterial(e,t),this._onUpdateLightingmap())}},{key:"_onMeshChanged",value:function(e){}},{key:"_clearMaterials",value:function(){if(this._model)for(var e=0;e<this._model.subModelNum;++e)this._onMaterialModified(e,null)}},{key:"_getBuiltinMaterial",value:function(){return Pc.get("missing-material")}},{key:"_onVisibilityChange",value:function(e){this._model&&(this._model.visFlags=e)}},{key:"_updateCastShadow",value:function(){this._model&&(this._shadowCastingMode===Wp.OFF?this._model.castShadow=!1:(this._shadowCastingMode,Wp.ON,"ShadowCastingMode ".concat(this._shadowCastingMode," is not supported."),this._model.castShadow=!0))}},{key:"_isBatchingEnabled",value:function(){for(var e=0;e<this._materials.length;++e){var t=this._materials[e];if(t)for(var i=0;i<t.passes.length;++i){var n=t.passes[i];if(n.instancedBuffer||n.batchedBuffer)return!0}}return!1}},{key:"_watchMorphInMesh",value:function(){if(this._morphInstance&&(this._morphInstance.destroy(),this._morphInstance=null),this._enableMorph&&this._mesh&&this._mesh.struct.morph&&this._mesh.morphRendering){var e=this._mesh.struct.morph;this._morphInstance=this._mesh.morphRendering.createInstance();for(var t=this._mesh.struct.primitives.length,i=0;i<t;++i){var n=e.subMeshMorphs[i];if(n){var r=n.weights||e.weights,a=r?r.slice():new Array(n.targets.length).fill(0);this._morphInstance.setWeights(i,a)}}this._model&&this._model instanceof oh&&this._model.setMorphRendering(this._morphInstance)}}},{key:"_syncMorphWeights",value:function(e){if(this._morphInstance){var t=this._morphInstance[e];t&&t.renderResources&&t.renderResources.setWeights(t.weights)}}}]),t}(),Bp.ShadowCastingMode=Wp,Lp=de((Pp=Gp).prototype,"lightmapSettings",[Ko],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return new jp}}),Dp=de(Pp.prototype,"_mesh",[Ko],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return null}}),Np=de(Pp.prototype,"_shadowCastingMode",[Ko],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return Wp.OFF}}),de(Pp.prototype,"shadowCastingMode",[Rp],Object.getOwnPropertyDescriptor(Pp.prototype,"shadowCastingMode"),Pp.prototype),de(Pp.prototype,"mesh",[Fp],Object.getOwnPropertyDescriptor(Pp.prototype,"mesh"),Pp.prototype),de(Pp.prototype,"enableMorph",[Mp],Object.getOwnPropertyDescriptor(Pp.prototype,"enableMorph"),Pp.prototype),zp=de(Pp.prototype,"_enableMorph",[Ko],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return!0}}),Ip=Pp))||Ip)||Ip)||Ip)||Ip)||Ip),exports.ModelComponent||(exports.ModelComponent={});var Yp=function(){function e(){Z(this,e)}return J(e,null,[{key:"batchStaticModel",value:function(e,t){var i=e.getComponentsInChildren(exports.ModelComponent);if(i.length<2)return console.error("the number of static models to batch is less than 2,it needn't batch."),!1;for(var n=1;n<i.length;n++){if(!i[0].mesh.validateMergingMesh(i[n].mesh))return console.error("the meshes of "+i[0].node.name+" and "+i[n].node.name+" can't be merged"),!1;if(!qp(i[0],i[n]))return console.error("the materials of "+i[0].node.name+" and "+i[n].node.name+" can't be merged"),!1}var r=new rc,a=new Ki,o=new Ki;e.getWorldMatrix(o),Ki.invert(o,o);for(var s=0;s<i.length;s++){var l=i[s];l.node.getWorldMatrix(a),Ki.multiply(a,o,a),r.merge(i[s].mesh,a),l.enabled=!1}var u=t.addComponent(exports.ModelComponent);return u.mesh=r,u.sharedMaterials=i[0].sharedMaterials,!0}},{key:"unbatchStaticModel",value:function(e,t){for(var i=e.getComponentsInChildren(exports.ModelComponent),n=0;n<i.length;n++){i[n].enabled=!0}var r=t.getComponent(exports.ModelComponent);return r&&r.destroy(),!0}}]),e}(),Kp=new Ii;function Zp(e,t,i,n){n||(n=new Ii),e.convertToUINode(t,i,n);var r=i.position;return n.add(r),n}function Qp(e,t,i){return i||(i=new Ii),e.worldToScreen(t,i),i.x=i.x/cc.view.getScaleX(),i.y=i.y/cc.view.getScaleY(),i}var Jp,$p,e_,t_,i_,n_,r_,a_,o_,s_,l_,u_,c_,h_={WorldNode3DToLocalNodeUI:Zp,WorldNode3DToWorldNodeUI:Qp};cc.pipelineUtils=h_,exports.replaceProperty(cc.pipelineUtils,"cc.pipelineUtils",[{name:"WorldNode3DToLocalNodeUI",newName:"convertToUINode",targetName:"cc.CameraComponent.prototype",customFunction:function(){for(var e=arguments.length,t=new Array(e),i=0;i<e;i++)t[i]=arguments[i];var n=t[0],r=t[3]||Kp;return n.convertToUINode(t[1],t[2],r),r.add(t[2].position),t[3]||r.clone()}}]);var p_=(Jp=Yo("cc.MissingClass"),$p=Ko({visible:!1,editorOnly:!0}),Jp((i_=de((t_=function e(){Z(this,e),fe(this,"_$erialized",i_,this)}).prototype,"_$erialized",[$p],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return null}}),e_=t_))||e_),__=(n_=Yo("cc.MissingScript"),r_=rs("packages://inspector/inspectors/comps/missing-script.js"),a_=Ko({serializable:!1}),o_=Ko({visible:!1,editorOnly:!0}),n_(s_=r_((u_=de((l_=function(e){function t(){var e;return Z(this,t),fe(e=re(this,te(t).call(this)),"compiled",u_,ne(e)),fe(e,"_$erialized",c_,ne(e)),e}return ee(t,rp),J(t,null,[{key:"safeFindClass",value:function(e,i){var n=Qe(e);return n||(e?(cc.deserialize.reportMissingClass(e),t.getMissingWrapper(e,i)):null)}},{key:"getMissingWrapper",value:function(e,i){return i.node&&(/^[0-9a-zA-Z+/]{23}$/.test(e)||rt.test(e))?t:p_}}]),J(t,[{key:"onLoad",value:function(){cc.warnID(4600,this.node.name)}}]),t}()).prototype,"compiled",[a_],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return!1}}),c_=de(l_.prototype,"_$erialized",[o_],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return null}}),s_=l_))||s_)||s_);cc._MissingScript=__;var f_=function(){function e(){Z(this,e),this.uuidList=void 0,this.uuidObjList=void 0,this.uuidPropList=void 0,this._stillUseUrl=void 0,this.uuidList=[],this.uuidObjList=[],this.uuidPropList=[],this._stillUseUrl=Re(!0)}return J(e,[{key:"reset",value:function(){this.uuidList.length=0,this.uuidObjList.length=0,this.uuidPropList.length=0,We(this._stillUseUrl)}},{key:"push",value:function(e,t,i,n){n&&(this._stillUseUrl[this.uuidList.length]=!0),this.uuidList.push(i),this.uuidObjList.push(e),this.uuidPropList.push(t)}}]),e}();f_.pool=void 0,f_.pool=new et((function(e){e.reset()}),10),f_.pool.get=function(){return this._get()||new f_};function d_(e,t,i,n,r){var a;n.hasOwnProperty("__deserialize__")?a=n.__deserialize__:(a=function(e,t){var i,n=rt.test($e(t)),r=cc.js.isChildClassOf(t,cc._BaseNode)||cc.js.isChildClassOf(t,cc.Component),a=[],o=a,s=[],l=s,u=[],c=[];return function(){var e=t.__values__;i="_$erialized"===e[e.length-1];for(var r=Ct(t),h=0;h<e.length;h++){var p=e[h],_=p;r[p+"$_$formerlySerializedAs"]&&(_=r[p+"$_$formerlySerializedAs"]);var f=r[p+"$_$saveUrlAsAsset"],d=ni.getDefault(r[p+"$_$default"]),m=!1;if(n){var v=r[p+"$_$type"];if(void 0===d&&v)m=v===cc.String||v===cc.Integer||v===cc.Float||v===cc.Boolean;else{var y=K(d);m="string"===y&&!f||"number"===y||"boolean"===y}}n&&m?(_!==p&&o===a&&(o=a.slice()),a.push(p),o!==a&&o.push(_)):(_!==p&&l===s&&(l=s.slice()),s.push(p),l!==s&&l.push(_),u.push(f),c.push(d instanceof cc.ValueType&&d.constructor))}}(),function(e,t,h,p,_){for(var f=0;f<a.length;++f){var d=h[o[f]];void 0!==d&&(t[a[f]]=d)}for(var m=0;m<s.length;++m){var v=s[m],y=h[l[m]];if(void 0!==y)if(n||"object"===K(y)){var g=c[m];g?n||y?e._deserializeTypedObject(t[v],y,g):t[v]=null:y?e._deserializeObjField(t,y,v,null,u[m]):t[v]=null}else t[v]=y}r&&h._id&&(t._id=h._id),i&&(t._$erialized=JSON.parse(JSON.stringify(h)),e._deserializePrimitiveObject(t._$erialized,h))}}(0,n),Ce(n,"__deserialize__",a,!0)),a(e,t,i,n,r),t.__postDeserialize&&t.__postDeserialize()}var m_=function(){function e(t,i,n,r,a){Z(this,e),this.result=void 0,this.customEnv=void 0,this.deserializedList=void 0,this.deserializedData=void 0,this._classFinder=void 0,this._target=void 0,this._ignoreEditorOnly=void 0,this._idList=void 0,this._idObjList=void 0,this._idPropList=void 0,this.result=t,this.customEnv=r,this.deserializedList=[],this.deserializedData=null,this._classFinder=n,this._idList=[],this._idObjList=[],this._idPropList=[]}return J(e,[{key:"deserialize",value:function(e){if(Array.isArray(e)){var t=e,i=t.length;this.deserializedList.length=i;for(var n=0;n<i;n++)t[n]&&(this.deserializedList[n]=this._deserializeObject(t[n],!1));this.deserializedData=i>0?this.deserializedList[0]:[]}else this.deserializedList.length=1,this.deserializedData=e?this._deserializeObject(e,!1):null,this.deserializedList[0]=this.deserializedData;return function(e){var t,i,n,r=e.deserializedList,a=e._idPropList,o=e._idList,s=e._idObjList;for(e._classFinder&&e._classFinder.onDereferenced,t=0;t<o.length;t++)i=a[t],n=o[t],s[t][i]=r[n]}(this),this.deserializedData}},{key:"_deserializeObject",value:function(e,t,i,n,r){var a,o=null,s=null,l=e.__type__;if("TypedArray"===l){var u=e.array;o=new window[e.ctor](u.length);for(var c=0;c<u.length;++c)o[c]=u[c];return o}if(l){if(!(s=this._classFinder(l,e,n,r)))return this._classFinder===Qe&&cc.deserialize.reportMissingClass(l),null;var h=this;(o=new s)._deserialize?o._deserialize(e.content,h):cc.Class._isCCClass(s)?d_(h,o,e,s,i):h._deserializeTypedObject(o,e,s)}else if(Array.isArray(e)){o=new Array(e.length);for(var p=0;p<e.length;p++)"object"===K(a=e[p])&&a?this._deserializeObjField(o,a,""+p,null,t):o[p]=a}else o={},this._deserializePrimitiveObject(o,e);return o}},{key:"_deserializeObjField",value:function(e,t,i,n,r){var a=t.__id__;if(void 0===a){var o=t.__uuid__;o?this.result.push(e,i,o,r):e[i]=this._deserializeObject(t,r)}else{var s=this.deserializedList[a];s?e[i]=s:(this._idList.push(a),this._idObjList.push(e),this._idPropList.push(i))}}},{key:"_deserializePrimitiveObject",value:function(e,t){for(var i in t)if(t.hasOwnProperty(i)){var n=t[i];"object"!==K(n)?"__type__"!==i&&(e[i]=n):n?this._deserializeObjField(e,n,i):e[i]=null}}},{key:"_deserializeTypedObject",value:function(e,t,i){if(i===cc.Vec2)return e.x=t.x||0,void(e.y=t.y||0);if(i===cc.Vec3)return e.x=t.x||0,e.y=t.y||0,void(e.z=t.z||0);if(i!==cc.Color){if(i===cc.Size)return e.width=t.width||0,void(e.height=t.height||0);for(var n=Ct(i),r=i.__props__||Object.keys(e),a=0;a<r.length;a++){var o=r[a],s=t[o];void 0!==s&&t.hasOwnProperty(o)||(s=ni.getDefault(n[o+"$_$default"])),"object"!==K(s)?e[o]=s:s?this._deserializeObjField(e,s,o):e[o]=null}}else{e.r=t.r||0,e.g=t.g||0,e.b=t.b||0;var l=t.a;e.a=void 0===l?255:l}}}]),e}();function v_(e,t,i){var n=(i=i||{}).classFinder||Qe,r=i.createAssetRefs||cc.sys.platform===cc.sys.EDITOR_CORE,a=i.customEnv,o=i.ignoreEditorOnly;"string"==typeof e&&(e=JSON.parse(e));var s=!t;t=t||f_.pool.get();var l=m_.pool.get(t,!1,n,a,o);cc.game._isCloning=!0;var u=l.deserialize(e);return cc.game._isCloning=!1,m_.pool.put(l),r&&t.assignAssetsBy(EditorExtends.serialize.asAsset),s&&f_.pool.put(t),u}m_.pool=void 0,m_.pool=new et((function(e){e.result=null,e.customEnv=null,e.deserializedList.length=0,e.deserializedData=null,e._classFinder=null,e._idList.length=0,e._idObjList.length=0,e._idPropList.length=0}),1),m_.pool.get=function(e,t,i,n,r){var a=this._get();return a?(a.result=e,a.customEnv=n,a._classFinder=i,a):new m_(e,t,i,n,r)},v_.Details=f_,v_.reportMissingClass=function(e){g(5302,e)},cc.deserialize=v_;var y_,g_,x_,b_,T_,S_,E_,w_,C_,A_,O_,k_=sl.Flags.Destroyed,R_=sl.Flags.PersistentMask,F_=[];function M_(e,t){if(!t){if("object"!==K(e)||Array.isArray(e))return null;if(!e)return null;if(!cc.isValid(e))return null}var i;if(e instanceof sl){if((e=e)._instantiate)return cc.game._isCloning=!0,i=e._instantiate(),cc.game._isCloning=!1,i;if(e instanceof cc.Asset)return null}return cc.game._isCloning=!0,i=I_(e),cc.game._isCloning=!1,i}function I_(e,t){if(Array.isArray(e))return null;if(_t&&_t(e))return null;var i;if(e._iN$t)i=e._iN$t;else if(e.constructor){i=new(0,e.constructor)}else i=Object.create(null);P_(e,i,t);for(var n=0,r=F_.length;n<r;++n)F_[n]._iN$t=null;return F_.length=0,i}function P_(e,t,i){Ce(e,"_iN$t",t,!0),F_.push(e);var n=e.constructor;if(cc.Class._isCCClass(n))!function(e,t,i,n){for(var r=e.__values__,a=0;a<r.length;a++){var o=r[a],s=t[o];if("object"===K(s)&&s){var l=i[o];l instanceof Tt&&l.constructor===s.constructor?l.set(s):i[o]=s._iN$t||L_(s,n)}else i[o]=s}}(n,e,t,i);else for(var r in e)if(e.hasOwnProperty(r)&&(95!==r.charCodeAt(0)||95!==r.charCodeAt(1)||"__type__"===r)){var a=e[r];if("object"===K(a)&&a){if(a===t)continue;t[r]=a._iN$t||L_(a,i)}else t[r]=a}e instanceof sl&&(t._objFlags&=R_)}function L_(e,t){if(e instanceof Tt)return e.clone();if(e instanceof cc.Asset)return e;var i;if(Array.isArray(e)){var n=e.length;i=new Array(n),e._iN$t=i;for(var r=0;r<n;++r){var a=e[r];"object"===K(a)&&a?i[r]=a._iN$t||L_(a,t):i[r]=a}return F_.push(e),i}if(e._objFlags&k_)return null;var o=e.constructor;if(cc.Class._isCCClass(o)){if(t)if(t instanceof cc.Component){if(e instanceof cc._BaseNode||e instanceof cc.Component)return e}else if(t instanceof cc._BaseNode)if(e instanceof cc._BaseNode){if(!e.isChildOf(t))return e}else if(e instanceof cc.Component&&!e.node.isChildOf(t))return e;i=new o}else if(o===Object)i={};else{if(o)return e;i=Object.create(null)}return P_(e,i,t),i}M_._clone=I_,cc.instantiate=M_,function(e){e[e.Uint8=0]="Uint8",e[e.Uint16=1]="Uint16",e[e.Uint32=2]="Uint32",e[e.Int8=3]="Int8",e[e.Int16=4]="Int16",e[e.Int32=5]="Int32",e[e.Float32=6]="Float32",e[e.Float64=7]="Float64"}(A_||(A_={})),function(e){e[e.Scalar=0]="Scalar",e[e.Vec2=1]="Vec2",e[e.Vec3=2]="Vec3",e[e.Vec4=3]="Vec4",e[e.Quat=4]="Quat",e[e.Mat4=5]="Mat4"}(O_||(O_={}));function D_(e,t){return(t<<3)+e}var N_=Yo("cc.CompactValueTypeArray")((w_=E_=function(){function e(){Z(this,e),fe(this,"_byteOffset",x_,this),fe(this,"_unitCount",b_,this),fe(this,"_unitElement",T_,this),fe(this,"_length",S_,this)}return J(e,[{key:"decompress",value:function(e){for(var t,i={storageUnit:7&(t=this._unitElement),elementType:t>>3},n=i.storageUnit,r=z_(i.elementType),a=new(B_(n))(e,this._byteOffset,this._unitCount),o=new Array(this._length),s=0;s<this._length;++s)o[s]=r.decompress(a,s);return o}}],[{key:"lengthFor",value:function(e,t,i){return z_(t).requiredUnits*e.length*B_(i).BYTES_PER_ELEMENT}},{key:"compress",value:function(t,i,n,r,a,o){for(var s=z_(i),l=B_(n),u=s.requiredUnits*t.length,c=new l(r,a,u),h=0;h<t.length;++h)s.compress(c,h,t[h]);var p=new e;return p._unitElement=D_(n,i),p._byteOffset=o,p._unitCount=u,p._length=t.length,p}}]),e}(),E_.StorageUnit=A_,E_.ElementType=O_,x_=de((g_=w_).prototype,"_byteOffset",[Ko],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return 0}}),b_=de(g_.prototype,"_unitCount",[Ko],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return 0}}),T_=de(g_.prototype,"_unitElement",[Ko],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return D_(A_.Uint8,O_.Scalar)}}),S_=de(g_.prototype,"_length",[Ko],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return 0}}),y_=g_))||y_;function z_(e){return G_[e]}function B_(e){switch(e){case A_.Uint8:return Uint8Array;case A_.Uint16:return Uint16Array;case A_.Uint32:return Uint32Array;case A_.Int8:return Int8Array;case A_.Int16:return Int16Array;case A_.Int32:return Int32Array;case A_.Float32:return Float32Array;case A_.Float64:return Float64Array}}var G_=($(C_={},O_.Scalar,{requiredUnits:1,compress:function(e,t,i){e[t]=i},decompress:function(e,t){return e[t]}}),$(C_,O_.Vec2,{requiredUnits:2,compress:function(e,t,i){e[2*t]=i.x,e[2*t+1]=i.y},decompress:function(e,t){return new Ii(e[2*t],e[2*t+1])}}),$(C_,O_.Vec3,{requiredUnits:3,compress:function(e,t,i){e[3*t]=i.x,e[3*t+1]=i.y,e[3*t+2]=i.z},decompress:function(e,t){return new Ii(e[3*t],e[3*t+1],e[3*t+2])}}),$(C_,O_.Vec4,{requiredUnits:4,compress:function(e,t,i){e[4*t]=i.x,e[4*t+1]=i.y,e[4*t+2]=i.z,e[4*t+3]=i.w},decompress:function(e,t){return new Ni(e[4*t],e[4*t+1],e[4*t+2],e[4*t+3])}}),$(C_,O_.Quat,{requiredUnits:4,compress:function(e,t,i){e[4*t]=i.x,e[4*t+1]=i.y,e[4*t+2]=i.z,e[4*t+3]=i.w},decompress:function(e,t){return new Xi(e[4*t],e[4*t+1],e[4*t+2],e[4*t+3])}}),$(C_,O_.Mat4,{requiredUnits:16,compress:function(e,t,i){Ki.toArray(e,i,16*t)},decompress:function(e,t){return Ki.fromArray(new Ki,e,16*t)}}),C_);function U_(e){var t=[];return function e(t,i){for(var n,r=_e(i);!(n=r()).done;){var a=n.value;Array.isArray(a)?e(t,a):t.push(a)}}(t,e),t.join("")}cc._decorator=gs;var X_=sl.Flags.Destroyed,V_=sl.Flags.PersistentMask,H_=ni.IDENTIFIER_RE,W_={"cc.Node":"cc.Node","cc.Sprite":"cc.Sprite","cc.Label":"cc.Label","cc.Button":"cc.Button","cc.Widget":"cc.Widget","cc.Animation":"cc.Animation","cc.ClickEvent":!1,"cc.PrefabInfo":!1},j_=ni.escapeForJS,q_=function(){function e(t,i){Z(this,e),this.varName=void 0,this.expression=void 0,this.varName=t,this.expression=i}return J(e,[{key:"toString",value:function(){return"var "+this.varName+"="+this.expression+";"}}]),e}();function Y_(e,t){return t instanceof q_?new q_(t.varName,e+t.expression):e+t}function K_(e,t,i){Array.isArray(i)?(i[0]=Y_(t,i[0]),e.push(i)):e.push(Y_(t,i)+";")}var Z_=function(){function e(t){Z(this,e),this._exps=void 0,this._targetExp=void 0,this._exps=[],this._targetExp=t}return J(e,[{key:"append",value:function(e,t){this._exps.push([e,t])}},{key:"writeCode",value:function(e){var t;if(this._exps.length>1)e.push("t="+this._targetExp+";"),t="t";else{if(1!==this._exps.length)return;t=this._targetExp}for(var i=0;i<this._exps.length;i++){var n=this._exps[i];K_(e,t+Q_(n[0])+"=",n[1])}}}]),e}();function Q_(e){return H_.test(e)?"."+e:"["+j_(e)+"]"}Z_.pool=void 0,Z_.pool=new et((function(e){e._exps.length=0,e._targetExp=null}),1),Z_.pool.get=function(e){var t=this._get()||new Z_;return t._targetExp=e,t};var J_,$_,ef,tf,nf,rf,af,of=function(){function e(t,i){var n;Z(this,e),this.parent=void 0,this.objsToClear_iN$t=void 0,this.codeArray=void 0,this.objs=void 0,this.funcs=void 0,this.funcModuleCache=void 0,this.globalVariables=void 0,this.globalVariableId=void 0,this.localVariableId=void 0,this.result=void 0,this.parent=i,this.objsToClear_iN$t=[],this.codeArray=[],this.objs=[],this.funcs=[],this.funcModuleCache=Re(),Ue(this.funcModuleCache,W_),this.globalVariables=[],this.globalVariableId=0,this.localVariableId=0,this.codeArray.push("var o,t;","if(R){","o=R;","}else{","o=R=new "+this.getFuncModule(t.constructor,!0)+"();","}"),t._iN$t={globalVar:"R"},this.objsToClear_iN$t.push(t),this.enumerateObject(this.codeArray,t),this.globalVariables.length>0&&(n="var "+this.globalVariables.join(",")+";");var r=U_(["return (function(R){",n||[],this.codeArray,"return o;","})"]);this.result=Function("O","F",r)(this.objs,this.funcs);for(var a=0,o=this.objsToClear_iN$t.length;a<o;++a)this.objsToClear_iN$t[a]._iN$t=null;this.objsToClear_iN$t.length=0}return J(e,[{key:"getFuncModule",value:function(e,t){var i=Fe(e);if(i){var n=this.funcModuleCache[i];if(n)return n;if(void 0===n){var r=-1!==i.indexOf(".");if(r)try{if(r=e===Function("return "+i)())return this.funcModuleCache[i]=i,i}catch(e){}}}var a=this.funcs.indexOf(e);a<0&&(a=this.funcs.length,this.funcs.push(e));var o="F["+a+"]";return t&&(o="("+o+")"),this.funcModuleCache[i]=o,o}},{key:"getObjRef",value:function(e){var t=this.objs.indexOf(e);return t<0&&(t=this.objs.length,this.objs.push(e)),"O["+t+"]"}},{key:"setValueType",value:function(e,t,i,n){var r=Z_.pool.get(n),a=t.constructor.__props__;a||(a=Object.keys(t));for(var o=0;o<a.length;o++){var s=a[o],l=i[s];if(t[s]!==l){var u=this.enumerateField(i,s,l);r.append(s,u)}}r.writeCode(e),Z_.pool.put(r)}},{key:"enumerateCCClass",value:function(e,t,i){for(var n=i.__values__,r=Ct(i),a=0;a<n.length;a++){var o=n[a],s=t[o],l=r[o+"$_$default"];if(!sf(l,s))if("object"===K(s)&&s instanceof cc.ValueType&&(l=ni.getDefault(l))&&l.constructor===s.constructor){var u="o"+Q_(o);this.setValueType(e,l,s,u)}else this.setObjProp(e,t,o,s)}}},{key:"instantiateArray",value:function(e){if(0===e.length)return"[]";var t="a"+ ++this.localVariableId,i=[new q_(t,"new Array("+e.length+")")];e._iN$t={globalVar:"",source:i},this.objsToClear_iN$t.push(e);for(var n=0;n<e.length;++n){K_(i,t+"["+n+"]=",this.enumerateField(e,n,e[n]))}return i}},{key:"enumerateField",value:function(e,t,i){if("object"===K(i)&&i){var n=i._iN$t;if(n){var r=n.globalVar;if(!r){r=n.globalVar="v"+ ++this.globalVariableId,this.globalVariables.push(r);var a=n.source[0];n.source[0]=Y_(r+"=",a)}return r}return Array.isArray(i)?this.instantiateArray(i):this.instantiateObj(i)}return"function"==typeof i?this.getFuncModule(i):"string"==typeof i?j_(i):("_objFlags"===t&&e instanceof sl&&(i&=V_),i)}},{key:"setObjProp",value:function(e,t,i,n){K_(e,"o"+Q_(i)+"=",this.enumerateField(t,i,n))}},{key:"enumerateObject",value:function(e,t){var i=t.constructor;if(cc.Class._isCCClass(i))this.enumerateCCClass(e,t,i);else for(var n in t)if(t.hasOwnProperty(n)&&(95!==n.charCodeAt(0)||95!==n.charCodeAt(1)||"__type__"===n)){var r=t[n];"object"===K(r)&&r&&r===t._iN$t||this.setObjProp(e,t,n,r)}}},{key:"instantiateObj",value:function(e){if(e instanceof cc.ValueType)return ni.getNewValueTypeCode(e);if(e instanceof cc.Asset)return this.getObjRef(e);if(e._objFlags&X_)return null;var t,i=e.constructor;if(cc.Class._isCCClass(i)){if(this.parent)if(this.parent instanceof cc.Component){if(e instanceof cc._BaseNode||e instanceof cc.Component)return this.getObjRef(e)}else if(this.parent instanceof cc._BaseNode)if(e instanceof cc._BaseNode){if(!e.isChildOf(this.parent))return this.getObjRef(e)}else if(e instanceof cc.Component&&!e.node.isChildOf(this.parent))return this.getObjRef(e);t=new q_("o","new "+this.getFuncModule(i,!0)+"()")}else if(i===Object)t=new q_("o","{}");else{if(i)return this.getObjRef(e);t=new q_("o","Object.create(null)")}var n=[t];return e._iN$t={globalVar:"",source:n},this.objsToClear_iN$t.push(e),this.enumerateObject(n,e),["(function(){",n,"return o;})();"]}}]),e}();function sf(e,t){if("function"==typeof e)try{e=e()}catch(e){return!1}if(e===t)return!0;if(e&&t){if(e instanceof cc.ValueType&&e.equals(t))return!0;if(Array.isArray(e)&&Array.isArray(t)||e.constructor===Object&&t.constructor===Object)try{return Array.isArray(e)&&Array.isArray(t)&&0===e.length&&0===t.length}catch(e){}}return!1}var lf,uf,cf,hf,pf=xt({AUTO:0,SINGLE_INSTANCE:1,MULTI_INSTANCE:2}),_f=Yo("cc.Prefab")((af=rf=function(e){function t(){var e;return Z(this,t),fe(e=re(this,te(t).call(this)),"data",ef,ne(e)),fe(e,"optimizationPolicy",tf,ne(e)),fe(e,"asyncLoadAssets",nf,ne(e)),e._createFunction=void 0,e._instantiatedTimes=void 0,e._createFunction=null,e._instantiatedTimes=0,e}return ee(t,zl),J(t,[{key:"createNode",value:function(e){var t=cc.instantiate(this);t.name=this.name,e(null,t)}},{key:"compileCreateFunction",value:function(){var e,t;this._createFunction=(e=this.data,t=e instanceof cc._BaseNode&&e,new of(e,t).result)}},{key:"_doInstantiate",value:function(e){return this.data._prefab?this.data._prefab._synced=!0:cc.warnID(3700),this._createFunction||this.compileCreateFunction(),this._createFunction(e)}},{key:"_instantiate",value:function(){var e;return this.data._prefab._synced=!0,e=this.data._instantiate(),++this._instantiatedTimes,e}}]),t}(),rf.OptimizationPolicy=pf,rf.OptimizationPolicyThreshold=3,ef=de(($_=af).prototype,"data",[Ko],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return null}}),tf=de($_.prototype,"optimizationPolicy",[Ko],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return pf.AUTO}}),nf=de($_.prototype,"asyncLoadAssets",[Ko],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return!1}}),J_=$_))||J_;cc.Prefab=_f,Me(cc,"cc._Prefab","Prefab");var ff,df,mf,vf=Yo("cc.SceneAsset")((cf=de((uf=function(e){function t(){var e,i;Z(this,t);for(var n=arguments.length,r=new Array(n),a=0;a<n;a++)r[a]=arguments[a];return fe(i=re(this,(e=te(t)).call.apply(e,[this].concat(r))),"scene",cf,ne(i)),fe(i,"asyncLoadAssets",hf,ne(i)),i}return ee(t,zl),t}()).prototype,"scene",[Ko],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return null}}),hf=de(uf.prototype,"asyncLoadAssets",[Ko],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return!1}}),lf=uf))||lf;cc.SceneAsset=vf;var yf,gf,xf,bf=Yo("cc.SpriteAtlas")((mf=de((df=function(e){function t(){var e,i;Z(this,t);for(var n=arguments.length,r=new Array(n),a=0;a<n;a++)r[a]=arguments[a];return fe(i=re(this,(e=te(t)).call.apply(e,[this].concat(r))),"spriteFrames",mf,ne(i)),i}return ee(t,zl),J(t,[{key:"getTexture",value:function(){var e=Object.keys(this.spriteFrames);if(e.length>0){var t=this.spriteFrames[e[0]];return t&&t.texture}return null}},{key:"getSpriteFrame",value:function(e){var t=this.spriteFrames[e];return t?(t.name||(t.name=e),t):null}},{key:"getSpriteFrames",value:function(){for(var e=[],t=this.spriteFrames,i=0,n=Object.keys(t);i<n.length;i++){var r=n[i];e.push(t[r])}return e}},{key:"_serialize",value:function(e){for(var t=[],i=0,n=Object.keys(this.spriteFrames);i<n.length;i++){var r=n[i],a=this.spriteFrames[r],o=a?a._uuid:"";o&&e&&(o=EditorExtends.UuidUtils.compressUuid(o,!0)),t.push(r),t.push(o)}return{name:this._name,spriteFrames:t}}},{key:"_deserialize",value:function(e,t){var i=e;this._name=i.name;var n=i.spriteFrames;this.spriteFrames=Re();for(var r=0;r<n.length;r+=2)t.result.push(this.spriteFrames,n[r],n[r+1])}}]),t}()).prototype,"spriteFrames",[Ko],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return Re()}}),ff=df))||ff;cc.SpriteAtlas=bf;var Tf,Sf,Ef,wf=Yo("cc.TextAsset")((xf=de((gf=function(e){function t(){var e,i;Z(this,t);for(var n=arguments.length,r=new Array(n),a=0;a<n;a++)r[a]=arguments[a];return fe(i=re(this,(e=te(t)).call.apply(e,[this].concat(r))),"text",xf,ne(i)),i}return ee(t,zl),J(t,[{key:"toString",value:function(){return this.text}}]),t}()).prototype,"text",[Ko],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return""}}),yf=gf))||yf;cc.TextAsset=wf;var Cf=Yo("cc.JsonAsset")((Ef=de((Sf=function(e){function t(){var e,i;Z(this,t);for(var n=arguments.length,r=new Array(n),a=0;a<n;a++)r[a]=arguments[a];return fe(i=re(this,(e=te(t)).call.apply(e,[this].concat(r))),"json",Ef,ne(i)),i}return ee(t,zl),t}()).prototype,"json",[Ko],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return null}}),Tf=Sf))||Tf;cc.JsonAsset=Cf;var Af="0123456789abcdef".split(""),Of=["","","",""],kf=Of.concat(Of,"-",Of,"-",Of,"-",Of,"-",Of,Of,Of),Rf=kf.map((function(e,t){return"-"===e?NaN:t})).filter(isFinite);function Ff(e){var t=e.split("@")[0];if(22!==t.length)return e;kf[0]=e[0],kf[1]=e[1];for(var i=2,n=2;i<22;i+=2){var r=lt[e.charCodeAt(i)],a=lt[e.charCodeAt(i+1)];kf[Rf[n++]]=Af[r>>2],kf[Rf[n++]]=Af[(3&r)<<2|a>>4],kf[Rf[n++]]=Af[15&a]}return e.replace(t,kf.join(""))}var Mf={_rawAssets:"",normalize:function(e){return e&&(46===e.charCodeAt(0)&&47===e.charCodeAt(1)?e=e.slice(2):47===e.charCodeAt(0)&&(e=e.slice(1))),e},raw:function(e){if((e=this.normalize(e)).startsWith("resources/")){var t=cc.loader._getResUuid(e.slice(10),cc.Asset,null,!0);if(t)return cc.AssetLibrary.getLibUrlNoExt(t,!0)+I(e)}else b(7002,e);return this._rawAssets+e},_init:function(e){this._rawAssets=G(e)+"/"}};cc.url=Mf;var If=function e(t,i){Z(this,e),this.uuid=void 0,this.type=void 0,this.uuid=t,this.type=i};function Pf(e,t){return!(e.length>t.length)||47===e.charCodeAt(t.length)}var Lf=function(){function e(){Z(this,e),this._pathToUuid=void 0,this._pathToUuid=Re(!0)}return J(e,[{key:"getUuid",value:function(e,t){e=Mf.normalize(e);var i=this._pathToUuid[e];if(i)if(Array.isArray(i)){if(!t)return i[0].uuid;for(var n=0;n<i.length;n++){var r=i[n];if(He(r.type,t))return r.uuid}}else if(!t||He(i.type,t))return i.uuid;return""}},{key:"getUuidArray",value:function(e,t,i){"/"===(e=Mf.normalize(e))[e.length-1]&&(e=e.slice(0,-1));var n=this._pathToUuid,r=[];for(var a in n)if(a.startsWith(e)&&Pf(a,e)||!e){var o=n[a];if(Array.isArray(o))for(var s=0;s<o.length;s++){var l=o[s];t&&!He(l.type,t)||(r.push(l.uuid),i&&i.push(a))}else t&&!He(o.type,t)||(r.push(o.uuid),i&&i.push(a))}return r}},{key:"add",value:function(e,t,i,n){n&&(e=e.substring(0,e.length-I(e).length));var r=new If(t,i);ht(this._pathToUuid,e,r,n)}},{key:"_getInfo_DEBUG",value:function(e,t){for(var i=this._pathToUuid,n=Object.keys(i),r=0;r<n.length;++r){var a=n[r],o=i[a];if(Array.isArray(o))for(var s=0;s<o.length;s++){var l=o[s];if(l.uuid===e)return t.path=a,t.type=l.type,!0}else if(o.uuid===e)return t.path=a,t.type=o.type,!0}return!1}},{key:"reset",value:function(){this._pathToUuid=Re(!0)}}]),e}();function Df(e,t){var i=cc.loader.getItem(e);if(i){var n=i.dependKeys;if(n)for(var r=0;r<n.length;r++){var a=n[r];t[a]||(t[a]=!0,Df(a,t))}}}function Nf(e,t){if(e._uuid){var i=cc.loader._getReferenceKey(e);t[i]||(t[i]=!0,Df(i,t))}}function zf(e,t){for(var i=Object.getOwnPropertyNames(e),n=0;n<i.length;n++){var r=e[i[n]];if("object"===K(r)&&r)if(Array.isArray(r))for(var a=0;a<r.length;a++){var o=r[a];o instanceof Al&&Nf(o,t)}else if(r.constructor&&r.constructor!==Object)r instanceof Al&&Nf(r,t);else for(var s=Object.getOwnPropertyNames(r),l=0;l<s.length;l++){var u=r[s[l]];u instanceof Al&&Nf(u,t)}}}function Bf(e,t){for(var i=0;i<e._components.length;i++)zf(e._components[i],t);for(var n=0;n<e._children.length;n++)Bf(e._children[n],t)}function Gf(e){var t={};return Df(e,t),Object.keys(t)}var Uf,Xf=0|998*Math.random(),Vf=Re(!0),Hf=[];!function(e){e[e.WORKING=0]="WORKING",e[e.COMPLETE=1]="COMPLETE",e[e.ERROR=2]="ERROR"}(Uf||(Uf={}));var Wf=Re(!0);function jf(e){if(e){var t=e.split("?");if(t&&t[0]&&t[1]){var i={};return t[1].split("&").forEach((function(e){var t=e.split("=");i[t[0]]=t[1]})),i}}}function qf(e,t){var i="object"===K(e)?e.url:e,n={queueId:t,id:i,url:i,rawUrl:void 0,urlParam:jf(i),type:"",error:null,content:null,complete:!1,states:{},deps:null,isScene:e.uuid&&cc.game._sceneInfos.find((function(t){return t.uuid===e.uuid}))};if("object"===K(e)&&(Ue(n,e),e.skips))for(var r=0;r<e.skips.length;r++){var a=e.skips[r];n.states[a]=Uf.COMPLETE}return n.rawUrl=n.url,i&&!n.type&&(n.type=I(i).toLowerCase().substr(1)),n}var Yf=[];function Kf(e,t,i){if(!e||!t)return!1;var n=!1;if(Yf.push(t.id),t.deps){var r,a,o=t.deps;for(r=0;r<o.length;r++){if((a=o[r]).id===e.id){n=!0;break}if(!(Yf.indexOf(a.id)>=0)&&(a.deps&&Kf(e,a,!0))){n=!0;break}}}return i||(Yf.length=0),n}var Zf=function(e){function t(e,i,n,r){var a;return Z(this,t),(a=re(this,te(t).call(this))).onProgress=void 0,a.onComplete=void 0,a.map=Re(!0),a.completed={},a.totalCount=0,a.completedCount=0,a.active=void 0,a._id=void 0,a._pipeline=void 0,a._errorUrls=[],a._appending=!1,a._ownerQueue=null,a._id=++Xf,Vf[a._id]=ne(a),a._pipeline=e,a.onProgress=n,a.onComplete=r,a._pipeline?a.active=!0:a.active=!1,i&&(i.length>0?a.append(i):a.allComplete()),a}return ee(t,ml),J(t,[{key:"append",value:function(e,i){var n=this;if(!this.active)return[];i&&!i.deps&&(i.deps=[]),this._appending=!0;var r,a,o,s,l=[];for(r=0;r<e.length;++r){if((a=e[r]).queueId&&!this.map[a.id]){if(this.map[a.id]=a,i&&i.deps.push(a),a.complete||Kf(i,a)){this.totalCount++,this.itemComplete(a.id);continue}if("continue"===function(){var e=n,r=Vf[a.queueId];return r&&(n.totalCount++,t.registerQueueDep(i||n._id,a.id),r.addListener(a.id,(function(t){e.itemComplete(t.id)}))),"continue"}())continue}if("string"==typeof((s=a).url||s)){var u=(o=qf(a,this._id)).id;this.map[u]||(this.map[u]=o,this.totalCount++,i&&i.deps.push(o),t.registerQueueDep(i||this._id,u),l.push(o))}}return this._appending=!1,this.completedCount===this.totalCount?this.allComplete():this._pipeline.flowIn(l),l}},{key:"_childOnProgress",value:function(e){if(this.onProgress){var t=Wf[this._id];this.onProgress(t?t.completed.length:this.completedCount,t?t.deps.length:this.totalCount,e)}}},{key:"allComplete",value:function(){var e=0===this._errorUrls.length?null:this._errorUrls;this.onComplete&&this.onComplete(e,this)}},{key:"isCompleted",value:function(){return this.completedCount>=this.totalCount}},{key:"isItemCompleted",value:function(e){return!!this.completed[e]}},{key:"exists",value:function(e){return!!this.map[e]}},{key:"getContent",value:function(e){var t=this.map[e],i=null;return t&&(t.content?i=t.content:t.alias&&(i=t.alias.content)),i}},{key:"getError",value:function(e){var t=this.map[e],i=null;return t&&(t.error?i=t.error:t.alias&&(i=t.alias.error)),i}},{key:"removeItem",value:function(e){var t=this.map[e];t&&this.completed[t.alias||e]&&(delete this.completed[e],delete this.map[e],t.alias&&(delete this.completed[t.alias.id],delete this.map[t.alias.id]),this.completedCount--,this.totalCount--)}},{key:"itemComplete",value:function(e){var i=this.map[e];if(i){var n=this._errorUrls.indexOf(e);if(i.error&&-1===n?this._errorUrls.push(e):i.error||-1===n||this._errorUrls.splice(n,1),this.completed[e]=i,this.completedCount++,t.finishDep(i.id),this.onProgress){var r=Wf[this._id];this.onProgress(r?r.completed.length:this.completedCount,r?r.deps.length:this.totalCount,i)}this.emit(e,i),this.removeAll(e),!this._appending&&this.completedCount>=this.totalCount&&this.allComplete()}}},{key:"destroy",value:function(){this.active=!1,this._appending=!1,this._pipeline=null,this._ownerQueue=null,this._errorUrls.length=0,this.onProgress=void 0,this.onComplete=void 0,this.map=Re(!0),this.completed={},this.totalCount=0,this.completedCount=0,this.clear(),Vf[this._id]=null,Wf[this._id]&&(Wf[this._id].completed.length=0,Wf[this._id].deps.length=0),-1===Hf.indexOf(this)&&Hf.length<10&&Hf.push(this)}},{key:"addListener",value:function(e,i,n){return oe(te(t.prototype),"on",this).call(this,e,i,n)}},{key:"hasListener",value:function(e,i,n){return oe(te(t.prototype),"hasEventListener",this).call(this,e,i,n)}},{key:"removeListener",value:function(e,i,n){return oe(te(t.prototype),"off",this).call(this,e,i,n)}},{key:"removeAllListeners",value:function(e){oe(te(t.prototype),"removeAll",this).call(this,e)}}],[{key:"create",value:function(e,i,n,r){void 0===n?"function"==typeof i&&(r=i,i=n=null):void 0===r&&("function"==typeof i?(r=n,n=i,i=null):(r=n,n=null));var a=Hf.pop();return a?(a._pipeline=e,a.onProgress=n,a.onComplete=r,Vf[a._id]=a,a._pipeline&&(a.active=!0),i&&a.append(i)):a=new t(e,i,n,r),a}},{key:"getQueue",value:function(e){return e.queueId?Vf[e.queueId]:null}},{key:"itemComplete",value:function(e){var t=Vf[e.queueId];t&&t.itemComplete(e.id)}},{key:"initQueueDeps",value:function(e){var t=Wf[e._id];t?(t.completed.length=0,t.deps.length=0):t=Wf[e._id]={completed:[],deps:[]}}},{key:"registerQueueDep",value:function(e,t){var i=e.queueId||e;if(!i)return!1;var n=Wf[i];if(n)-1===n.deps.indexOf(t)&&n.deps.push(t);else if(e.id)for(var r in Wf){var a=Wf[r];-1!==a.deps.indexOf(e.id)&&-1===a.deps.indexOf(t)&&a.deps.push(t)}}},{key:"finishDep",value:function(e){for(var t in Wf){var i=Wf[t];-1!==i.deps.indexOf(e)&&-1===i.completed.indexOf(e)&&i.completed.push(e)}}}]),t}();Zf.ItemState=new cc.Enum(Uf),cc.LoadingItems=Zf;var Qf=Zf.ItemState;function Jf(e,t){var i=e.id,n=t.states[i],r=e.next,a=e.pipeline;if(!t.error&&n!==Qf.WORKING&&n!==Qf.ERROR)if(n===Qf.COMPLETE)r?Jf(r,t):a.flowOut(t);else{t.states[i]=Qf.WORKING;var o=e.handle(t,(function(e,n){e?(t.error=e,t.states[i]=Qf.ERROR,a.flowOut(t)):(n&&(t.content=n),t.states[i]=Qf.COMPLETE,r?Jf(r,t):a.flowOut(t))}));o instanceof Error?(t.error=o,t.states[i]=Qf.ERROR,a.flowOut(t)):void 0!==o&&(null!==o&&(t.content=o),t.states[i]=Qf.COMPLETE,r?Jf(r,t):a.flowOut(t))}}var $f=function(){function e(t){Z(this,e),this._pipes=void 0,this._cache=Re(!0),this._pipes=t;for(var i=0;i<t.length;++i){var n=t[i];n.handle&&n.id&&(n.pipeline=this,n.next=i<t.length-1?t[i+1]:null)}}return J(e,[{key:"insertPipe",value:function(e,t){if(!e.handle||!e.id||t>this._pipes.length)cc.warnID(4921);else if(this._pipes.indexOf(e)>0)cc.warnID(4922);else{e.pipeline=this;var i=null;t<this._pipes.length&&(i=this._pipes[t]);var n=null;t>0&&(n=this._pipes[t-1]),n&&(n.next=e),e.next=i,this._pipes.splice(t,0,e)}}},{key:"insertPipeAfter",value:function(e,t){var i=this._pipes.indexOf(e);i<0||this.insertPipe(t,i+1)}},{key:"appendPipe",value:function(e){e.handle&&e.id&&(e.pipeline=this,e.next=null,this._pipes.length>0&&(this._pipes[this._pipes.length-1].next=e),this._pipes.push(e))}},{key:"flowIn",value:function(e){var t,i,n=this._pipes[0];if(n){for(t=0;t<e.length;t++)(i=e[t]).isScene||(this._cache[i.id]=i);for(t=0;t<e.length;t++)Jf(n,i=e[t])}else for(t=0;t<e.length;t++)this.flowOut(e[t])}},{key:"flowInDeps",value:function(e,t,i){return Zf.create(this,(function(e,t){i(e,t),t.destroy()})).append(t,e)}},{key:"flowOut",value:function(e){e.error?delete this._cache[e.id]:this._cache[e.id]||e.isScene||(this._cache[e.id]=e),e.complete=!0,Zf.itemComplete(e)}},{key:"copyItemStates",value:function(e,t){if(t instanceof Array)for(var i=0;i<t.length;++i)t[i].states=e.states;else t.states=e.states}},{key:"getItem",value:function(e){var t=this._cache[e];return t?(t.alias&&(t=t.alias),t):t}},{key:"removeItem",value:function(e){var t=this._cache[e];return t&&t.complete&&delete this._cache[e],t}},{key:"clear",value:function(){for(var e in this._cache){var t=this._cache[e];delete this._cache[e],t.complete||(t.error=new Error("Canceled manually"),this.flowOut(t))}}}]),e}();$f.ItemState=Qf,cc.Pipeline=$f;var ed="MD5Pipe",td=/(\.[^.\n\\/]*)$/,id=/.*[/\\][0-9a-fA-F]{2}[/\\]([0-9a-fA-F-@]{8,}).*/;var nd=function(){function e(t,i,n){Z(this,e),this.id=ed,this.async=!1,this.pipeline=null,this.md5AssetsMap=void 0,this.md5NativeAssetsMap=void 0,this.libraryBase=void 0,this.id=ed,this.async=!1,this.pipeline=null,this.md5AssetsMap=t,this.md5NativeAssetsMap=i,this.libraryBase=n}return J(e,[{key:"handle",value:function(e){var t=!1;return"ttf"===e.type&&(t=!0),e.url=this.transformURL(e.url,t),e}},{key:"transformURL",value:function(e,t){var i=function(e){var t=e.match(id);return t?t[1]:""}(e);if(i){var n=(!e.match(this.libraryBase)?this.md5NativeAssetsMap:this.md5AssetsMap)[i];if(n)if(t){var r=cc.path.dirname(e),a=cc.path.basename(e);e="".concat(r,".").concat(n,"/").concat(a)}else{var o=!1;e=e.replace(td,(function(e,t){return o=!0,"."+n+t})),o||(e=e+"."+n)}}return e}}]),e}();nd.ID=ed,$f.MD5Pipe=nd;var rd,ad=function(){function e(){Z(this,e),this.jsons={}}return J(e,[{key:"load",value:function(e,t){t.length!==e.length&&b(4915);for(var i=0;i<e.length;i++){var n=e[i],r=t[i];this.jsons[n]=r}}},{key:"retrieve",value:function(e){return this.jsons[e]||null}}]),e}(),od=function(){function e(){Z(this,e),this.contents={}}return J(e,[{key:"load",value:function(e,t){var i=t.data;i.length!==e.length&&b(4915);for(var n=0;n<e.length;n++)this.contents[e[n]]={base:i[n][0],mipmaps:i[n][1]}}},{key:"retrieve",value:function(e){var t=this.contents[e];return t?{__type__:it._getClassId(gu),content:t}:null}}]),e}(),sd=/\?/;function ld(e){return cc.game.config.noCache&&"string"==typeof e&&(sd.test(e)?e+="&_t="+(new Date-0):e+="?_t="+(new Date-0)),e}function ud(e,t){if(Array.isArray(e))for(var i=0,n=e.length;i<n;i++)ud(e[i],t);else if("object"===K(e))for(var r in e)ud(e[r],t),Number.isNaN(Number(r))||(e[t[r]]=e[r],delete e[r]);return null}!function(e){e[e.Invalid=0]="Invalid",e[e.Removed=1]="Removed",e[e.Downloading=2]="Downloading",e[e.Loaded=3]="Loaded"}(rd||(rd={}));var cd=function e(){Z(this,e),this.unpacker=void 0,this.state=void 0,this.unpacker=null,this.state=rd.Invalid},hd={},pd={},_d={};function fd(e,t){return new Error("Can not retrieve "+e+" from packer "+t)}function dd(e){for(var t in pd=e,e)for(var i=e[t],n=0;n<i.length;n++){var r=i[n],a=1===i.length;ht(hd,r,t,a)}}function md(e,t,i){var n=cc.AssetLibrary.getLibUrlNoExt(t)+".json";cc.loader.load({url:n,ignoreMaxConcurrency:!0},(function(n,r){if(n)return b(4916,e),i(n);var a=vd(e,t,r);a?i(null,a):i(fd(e,t))}))}function vd(e,t,i){var n=_d[t];if(n.state!==rd.Loaded){if("string"==typeof i&&(i=JSON.parse(i)),i.keys&&i.data){var r=i.keys;ud(i=i.data,r)}Array.isArray(i)?n.unpacker=new ad:i.type===$e(gu)&&(n.unpacker=new od),n.unpacker.load(pd[t],i),n.state=rd.Loaded}return n.unpacker.retrieve(e)}function yd(e){for(var t=rd.Invalid,i="",n=0;n<e.length;n++){var r=e[n],a=_d[r];if(a){var o=a.state;if(o===rd.Loaded)return r;o>t&&(t=o,i=r)}}return t!==rd.Invalid?i:e[0]}function gd(e,t){var i=e.uuid,n=hd[i];if(n){Array.isArray(n)&&(n=yd(n));var r=_d[n];if(r&&r.state===rd.Loaded){var a=r.unpacker.retrieve(i);return a||fd(i,n)}return r||(console.log("Create unpacker %s for %s",n,i),(r=_d[n]=new cd).state=rd.Downloading),md(i,n,t),null}}var xd=Object.freeze({__proto__:null,initPacks:dd,_loadNewPack:md,_doPreload:function(e,t){var i=_d[e];i||((i=_d[e]=new cd).state=rd.Downloading),i.state!==rd.Loaded&&(i.unpacker=new ad,i.unpacker.load(pd[e],t),i.state=rd.Loaded)},_doLoadNewPack:vd,_selectLoadedPack:yd,load:gd}),bd=/.*[/\\][0-9a-fA-F]{2}[/\\]([0-9a-fA-F-@]{8,}).*/;var Td=Object.create(null),Sd=function(){function e(t){Z(this,e),this.id="SubPackPipe",this.async=!1,this.pipeline=null;var i=function(e){var i=t[e];i.uuids&&i.uuids.forEach((function(e){var t=Ff(e),n=t.split("@").map((function(e){return encodeURIComponent(e)}));t=n.join("@"),Td[t]=i.path}))};for(var n in t)i(n)}return J(e,[{key:"handle",value:function(e){return e.url=this.transformURL(e.url),null}},{key:"transformURL",value:function(e){var t=function(e){var t=e.match(bd);return t?t[1]:""}(e);if(t){var i=Td[t];if(i)return e.replace("res/raw-assets/",i+"raw-assets/")}return e}}]),e}();Sd.ID="SubPackPipe",$f.SubPackPipe=Sd;var Ed="",wd="",Cd=Re(!0);function Ad(e,t){this.url=e,this.type=t}var Od,kd={_uuidToAsset:{},loadAsset:function(e,t,i){if("string"!=typeof e)return ft(t,new Error("[AssetLibrary] uuid must be string"),null);var n={uuid:e,type:"uuid"};i&&i.existingAsset&&(n.existingAsset=i.existingAsset),cc.loader.load(n,(function(i,n){if(i||!n)i=new Error("[AssetLibrary] loading JSON or dependencies failed: "+(i?i.message:"Unknown error"));else if(n.constructor===cc.SceneAsset){var r=cc.loader._getReferenceKey(e);n.scene.dependAssets=Gf(r)}t&&t(i,n)}))},getLibUrlNoExt:function(e,t){var i=(e=Ff(e)).split("@").map((function(e){return encodeURIComponent(e)}));return e=i.join("@"),(t?wd+"assets/":Ed)+e.slice(0,2)+"/"+e},_queryAssetInfoInEditor:function(e,t){t(new Error("Unable to load resource: EditorExtends is not defined."))},_getAssetInfoInRuntime:function(e,t){t=t||{url:null,raw:!1};var i=Cd[e];return i&&!He(i.type,cc.Asset)?(t.url=wd+i.url,t.raw=!0):(t.url=this.getLibUrlNoExt(e)+".json",t.raw=!1),t},_uuidInSettings:function(e){return e in Cd},queryAssetInfo:function(e,t){var i=this._getAssetInfoInRuntime(e);t(null,i.url,i.raw)},parseUuidInEditor:function(e){},loadJson:function(e,t){var i=""+((new Date).getTime()+Math.random()),n={uuid:i,type:"uuid",content:e,skips:[cc.loader.assetLoader.id,cc.loader.downloader.id]};cc.loader.load(n,(function(e,n){if(e)e=new Error("[AssetLibrary] loading JSON or dependencies failed: "+e.message);else{if(n.constructor===cc.SceneAsset){var r=cc.loader._getReferenceKey(i);n.scene.dependAssets=Gf(r)}if(function(e){return e&&(e.constructor===cc.SceneAsset||e instanceof cc.Scene)}(n)){var a=cc.loader._getReferenceKey(i);cc.loader.removeItem(a)}}n._uuid="",t&&t(e,n)}))},getAssetByUuid:function(e){return kd._uuidToAsset[e]||null},init:function(e){var t=e.libraryPath;t=t.replace(/\\/g,"/"),Ed=cc.path.stripSep(t)+"/",wd=e.rawAssetsBase;var i=e.md5AssetsMap;if(i&&i.import){var n=0,r=Re(!0),a=i.import;for(n=0;n<a.length;n+=2){var o=Ff(a[n]).split("@").map((function(e){return encodeURIComponent(e)}));r[o.join("@")]=a[n+1]}var s=Re(!0);for(a=i["raw-assets"],n=0;n<a.length;n+=2){var l=Ff(a[n]).split("@").map((function(e){return encodeURIComponent(e)}));s[l.join("@")]=a[n+1]}var u=new nd(r,s,Ed);cc.loader.insertPipeAfter(cc.loader.assetLoader,u),cc.loader.md5Pipe=u}var c=e.subPackages;if(c){cc.loader.downloader.setSubPackages(c);var h=new Sd(c);cc.loader.insertPipeAfter(cc.loader.assetLoader,h),cc.loader.subPackPipe=h}var p=cc.loader._assetTables;for(var _ in p)p[_].reset();var f=e.rawAssets;if(f)for(var d in f){var m=f[d];for(var v in m){var y=m[v],g=y[0],x=y[1],b=Qe(x);if(b){Cd[v]=new Ad(d+"/"+g,b);var T=1===y[2];p[d]||(p[d]=new Lf),p[d].add(g,v,b,!T)}else cc.error("Cannot get",x)}}e.packedAssets&&dd(e.packedAssets),cc.url._init(e.mountPaths&&e.mountPaths.assets||wd+"assets")}};cc.AssetLibrary=kd;var Rd,Fd,Md,Id,Pd,Ld=Yo("cc.Font")(Od=function(e){function t(){return Z(this,t),re(this,te(t).apply(this,arguments))}return ee(t,zl),t}())||Od;cc.Font=Ld;var Dd,Nd,zd,Bd,Gd,Ud,Xd,Vd,Hd=(Rd=Yo("cc.TTFFont"),Fd=Ko({override:!0}),Rd((Pd=de((Id=function(e){function t(){var e,i;Z(this,t);for(var n=arguments.length,r=new Array(n),a=0;a<n;a++)r[a]=arguments[a];return fe(i=re(this,(e=te(t)).call.apply(e,[this].concat(r))),"_fontFamily",Pd,ne(i)),i}return ee(t,Ld),J(t,[{key:"_nativeAsset",get:function(){return this._fontFamily},set:function(e){this._fontFamily=e||"Arial"}}]),t}()).prototype,"_fontFamily",[Ko],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return null}}),de(Id.prototype,"_nativeAsset",[Fd,cs],Object.getOwnPropertyDescriptor(Id.prototype,"_nativeAsset"),Id.prototype),Md=Id))||Md);cc.TTFFont=Hd;var Wd,jd=(Dd=Yo("cc.BitmapFont"),Nd=Ko({type:Ac}),Dd((Gd=de((Bd=function(e){function t(){var e,i;Z(this,t);for(var n=arguments.length,r=new Array(n),a=0;a<n;a++)r[a]=arguments[a];return fe(i=re(this,(e=te(t)).call.apply(e,[this].concat(r))),"fntDataStr",Gd,ne(i)),fe(i,"spriteFrame",Ud,ne(i)),fe(i,"fontSize",Xd,ne(i)),fe(i,"fntConfig",Vd,ne(i)),i}return ee(t,Ld),t}()).prototype,"fntDataStr",[Ko],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return""}}),Ud=de(Bd.prototype,"spriteFrame",[Nd],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return null}}),Xd=de(Bd.prototype,"fontSize",[Ko],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return-1}}),Vd=de(Bd.prototype,"fntConfig",[Ko],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return null}}),zd=Bd))||zd);cc.BitmapFont=jd;var qd=Yo("cc.LabelAtlas")(Wd=function(e){function t(){return Z(this,t),re(this,te(t).apply(this,arguments))}return ee(t,jd),t}())||Wd;cc.LabelAtlas=qd;var Yd=[],Kd=function(){function e(){Z(this,e),this.id="AssetLoader",this.async=!0,this.pipeline=null}return J(e,[{key:"handle",value:function(e,t){var i=e.uuid;if(!i)return e.content||null;cc.AssetLibrary.queryAssetInfo(i,(function(n,r,a){if(n)t(n);else if(e.url=e.rawUrl=r,e.isRawAsset=a,a){var o=I(r).toLowerCase();if(!o)return void t(new Error(w(4931,i,r)));o=o.substr(1);var s=Zf.getQueue(e);Yd[0]={queueId:e.queueId,id:r,url:r,type:o,error:null,alias:e,complete:!0},s&&s.append(Yd),e.type=o,t(null,e.content)}else e.type="uuid",t(null,e.content)}))}}]),e}();function Zd(e,t){var i=e.url,n=cc.loader.getXMLHttpRequest(),r="Load binary data failed: "+i;n.open("GET",i,!0),n.responseType="arraybuffer",n.onload=function(){var e=n.response;e?t(null,e):t({status:n.status,errorMessage:r+"(no response)"})},n.onerror=function(){t({status:n.status,errorMessage:r+"(error)"})},n.ontimeout=function(){t({status:n.status,errorMessage:r+"(time out)"})},n.send(null)}function Qd(e,t){var i=e.url;i=ld(i);var n=cc.loader.getXMLHttpRequest(),r="Load text file failed: "+i;n.open("GET",i,!0),n.overrideMimeType&&n.overrideMimeType("text/plain; charset=utf-8"),n.onload=function(){4===n.readyState?200===n.status||0===n.status?t(null,n.responseText):t({status:n.status,errorMessage:r+"(wrong status)"}):t({status:n.status,errorMessage:r+"(wrong readyState)"})},n.onerror=function(){t({status:n.status,errorMessage:r+"(error)"})},n.ontimeout=function(){t({status:n.status,errorMessage:r+"(time out)"})},n.send(null)}Kd.ID="AssetLoader",$f.AssetLoader=Kd;var Jd={INITIALIZING:0,PLAYING:1,STOPPED:2},$d=function(){function e(t){var i=this;Z(this,e),this._state=Jd.STOPPED,this._duration=0,this._eventTarget=void 0,this._onHide=void 0,this._onShow=void 0,this._interrupted=!1,this._blocking=!1,this._duration=t.duration,this._eventTarget=t.eventTarget,this._onHide=function(){i._blocking=!0,i._state===Jd.PLAYING&&(i.pause(),i._interrupted=!0)},this._onShow=function(){i._blocking=!1,i._interrupted&&(i.play(),i._interrupted=!1)},cc.game.on(cc.Game.EVENT_HIDE,this._onHide),cc.game.on(cc.Game.EVENT_SHOW,this._onShow)}return J(e,[{key:"getState",value:function(){return this._state}},{key:"getDuration",value:function(){return this._duration}},{key:"destroy",value:function(){cc.game.off(cc.Game.EVENT_HIDE,this._onHide),cc.game.off(cc.Game.EVENT_SHOW,this._onShow)}}]),e}();cc.internal.AudioPlayer=$d;var em,tm,im,nm,rm,am,om,sm,lm=function(e){function t(e){var i;return Z(this,t),(i=re(this,te(t).call(this,e)))._volume=1,i._loop=!1,i._oneShotOngoing=!1,i._audio=void 0,i._cbRegistered=!1,i._remove_cb=void 0,i._post_play=void 0,i._on_gesture=void 0,i._post_gesture=void 0,i._audio=e.clip,i._remove_cb=function(){i._cbRegistered&&(cc.game.canvas.removeEventListener("touchend",i._on_gesture),cc.game.canvas.removeEventListener("mouseup",i._on_gesture),i._cbRegistered=!1)},i._post_play=function(){i._state=Jd.PLAYING,i._eventTarget.emit("started"),i._remove_cb()},i._post_gesture=function(){i._interrupted?(i._post_play(),i._interrupted=!1):(i._audio.pause(),i._audio.currentTime=0)},i._on_gesture=function(){if(i._audio){var e=i._audio.play();if(!e)return i._state=Jd.PLAYING,void cc.director.once(cc.Director.EVENT_AFTER_UPDATE,i._post_gesture);e.then(i._post_gesture),i._remove_cb()}},i._audio.volume=i._volume,i._audio.loop=i._loop,i._audio.addEventListener("ended",(function(){i._oneShotOngoing||(i._state=Jd.STOPPED,i._audio.currentTime=0,i._eventTarget.emit("ended"))})),cc.game.canvas.addEventListener("touchend",i._on_gesture),cc.game.canvas.addEventListener("mouseup",i._on_gesture),i._cbRegistered=!0,i}return ee(t,$d),J(t,[{key:"play",value:function(){var e=this;if(this._audio&&this._state!==Jd.PLAYING)if(this._blocking)this._interrupted=!0;else{var t=this._audio.play();if(!t)return this._state=Jd.PLAYING,void cc.director.once(cc.Director.EVENT_AFTER_UPDATE,this._post_play);t.then(this._post_play).catch((function(){e._interrupted=!0}))}}},{key:"pause",value:function(){this._audio&&this._state===Jd.PLAYING&&(this._audio.pause(),this._state=Jd.STOPPED,this._oneShotOngoing=!1)}},{key:"stop",value:function(){this._audio&&(this._audio.currentTime=0,this._state===Jd.PLAYING&&(this._audio.pause(),this._state=Jd.STOPPED,this._oneShotOngoing=!1))}},{key:"playOneShot",value:function(){var e=this,t=arguments.length>0&&void 0!==arguments[0]?arguments[0]:1,i=this._audio;i&&(i.currentTime=0,i.volume=t,this._oneShotOngoing||(i.loop=!1,this._oneShotOngoing=!0,i.play().then((function(){i.addEventListener("ended",(function(){i.currentTime=0,i.volume=e._volume,i.loop=e._loop,e._oneShotOngoing=!1}),{once:!0})})).catch((function(){e._oneShotOngoing=!1}))))}},{key:"setCurrentTime",value:function(e){this._audio&&(this._audio.currentTime=pi(e,0,this._duration))}},{key:"getCurrentTime",value:function(){return this._audio?this._audio.currentTime:0}},{key:"setVolume",value:function(e,t){this._volume=e,this._audio&&(this._audio.volume=e)}},{key:"getVolume",value:function(){return this._audio?this._audio.volume:this._volume}},{key:"setLoop",value:function(e){this._loop=e,this._audio&&(this._audio.loop=e)}},{key:"getLoop",value:function(){return this._loop}},{key:"destroy",value:function(){this._audio&&(this._audio.src=""),oe(te(t.prototype),"destroy",this).call(this)}}]),t}(),um=Cs.__audioSupport,cm=function(e){function t(e){var i;return Z(this,t),(i=re(this,te(t).call(this,e)))._startTime=0,i._offset=0,i._volume=1,i._loop=!1,i._currentTimer=0,i._audio=void 0,i._context=void 0,i._sourceNode=void 0,i._gainNode=void 0,i._startInvoked=!1,i._onEndedCB=void 0,i._onGestureCB=void 0,i._onGestureProceedCB=void 0,i._audio=e.clip,i._context=um.context,i._sourceNode=i._context.createBufferSource(),i._gainNode=i._context.createGain(),i._gainNode.connect(i._context.destination),i._onEndedCB=i._onEnded.bind(ne(i)),i._onGestureCB=i._onGesture.bind(ne(i)),i._onGestureProceedCB=i._onGestureProceed.bind(ne(i)),"running"!==i._context.state&&i._context.resume&&(cc.game.canvas.addEventListener("touchend",i._onGestureCB),cc.game.canvas.addEventListener("mouseup",i._onGestureCB)),i}return ee(t,$d),J(t,[{key:"play",value:function(){this._audio&&this._state!==Jd.PLAYING&&(this._blocking||"running"!==this._context.state?this._interrupted=!0:this._doPlay())}},{key:"pause",value:function(){this._state===Jd.PLAYING&&(this._doStop(),this._offset+=this._context.currentTime-this._startTime,this._state=Jd.STOPPED,clearInterval(this._currentTimer))}},{key:"stop",value:function(){this._offset=0,this._state===Jd.PLAYING&&(this._doStop(),this._state=Jd.STOPPED,clearInterval(this._currentTimer))}},{key:"playOneShot",value:function(){var e=arguments.length>0&&void 0!==arguments[0]?arguments[0]:1;if(this._audio){var t=this._context.createGain();t.connect(this._context.destination),t.gain.value=e;var i=this._context.createBufferSource();i.buffer=this._audio,i.loop=!1,i.connect(t),i.start()}}},{key:"setCurrentTime",value:function(e){this._offset=pi(e,0,this._audio&&this._audio.duration||this._duration),this._state===Jd.PLAYING&&(this._doStop(),this._doPlay())}},{key:"getCurrentTime",value:function(){return this._state!==Jd.PLAYING?this._offset:this._context.currentTime-this._startTime+this._offset}},{key:"setVolume",value:function(e,t){this._volume=e,!t&&this._gainNode.gain.setTargetAtTime?this._gainNode.gain.setTargetAtTime(e,this._context.currentTime,.01):this._gainNode.gain.value=e}},{key:"getVolume",value:function(){return this._volume}},{key:"setLoop",value:function(e){this._loop=e,this._sourceNode.loop=e}},{key:"getLoop",value:function(){return this._loop}},{key:"destroy",value:function(){oe(te(t.prototype),"destroy",this).call(this)}},{key:"_doPlay",value:function(){var e=this;this._state=Jd.PLAYING,this._sourceNode=this._context.createBufferSource(),this._sourceNode.buffer=this._audio,this._sourceNode.loop=this._loop,this._sourceNode.connect(this._gainNode),this._startTime=this._context.currentTime,this._startInvoked=!1,cc.director.once(cc.Director.EVENT_AFTER_UPDATE,this._playAndEmit,this),clearInterval(this._currentTimer),this._currentTimer=window.setInterval((function(){e._onEnded(),clearInterval(e._currentTimer),e._sourceNode.loop&&(e._currentTimer=window.setInterval(e._onEndedCB,1e3*e._audio.duration))}),1e3*(this._audio.duration-this._offset))}},{key:"_doStop",value:function(){this._startInvoked?this._sourceNode.stop():cc.director.off(cc.Director.EVENT_AFTER_UPDATE,this._playAndEmit,this)}},{key:"_playAndEmit",value:function(){this._sourceNode.start(0,this._offset),this._eventTarget.emit("started"),this._startInvoked=!0}},{key:"_onEnded",value:function(){this._offset=0,this._startTime=this._context.currentTime,this._sourceNode.loop||(this._eventTarget.emit("ended"),this._state=Jd.STOPPED)}},{key:"_onGestureProceed",value:function(){this._interrupted&&(this._doPlay(),this._interrupted=!1),cc.game.canvas.removeEventListener("touchend",this._onGestureCB),cc.game.canvas.removeEventListener("mouseup",this._onGestureCB)}},{key:"_onGesture",value:function(){"running"!==this._context.state?this._context.resume().then(this._onGestureProceedCB):this._onGestureProceed()}}]),t}(),hm=xt({WEB_AUDIO:0,DOM_AUDIO:1,JSB_AUDIO:2,UNKNOWN_AUDIO:3});exports.AudioClip=(em=Yo("cc.AudioClip"),tm=Ko({type:hm}),em((sm=om=function(e){function t(){var e;return Z(this,t),fe(e=re(this,te(t).call(this)),"_duration",rm,ne(e)),fe(e,"_loadMode",am,ne(e)),e._audio=null,e._player=null,e.loaded=!1,e}return ee(t,zl),J(t,[{key:"destroy",value:function(){return this._player&&this._player.destroy(),oe(te(t.prototype),"destroy",this).call(this)}},{key:"play",value:function(){this._player&&this._player.play()}},{key:"pause",value:function(){this._player&&this._player.pause()}},{key:"stop",value:function(){this._player&&this._player.stop()}},{key:"playOneShot",value:function(e){this._player&&this._player.playOneShot(e)}},{key:"setCurrentTime",value:function(e){this._player&&this._player.setCurrentTime(e)}},{key:"getCurrentTime",value:function(){return this._player?this._player.getCurrentTime():0}},{key:"getDuration",value:function(){return this._player?this._player.getDuration():this._duration}},{key:"setVolume",value:function(e,t){this._player&&this._player.setVolume(e,t||!1)}},{key:"getVolume",value:function(){return this._player?this._player.getVolume():1}},{key:"setLoop",value:function(e){this._player&&this._player.setLoop(e)}},{key:"getLoop",value:function(){return!!this._player&&this._player.getLoop()}},{key:"_getPlayer",value:function(e){var t;return"undefined"!=typeof AudioBuffer&&e instanceof AudioBuffer?(t=cm,this._loadMode=hm.WEB_AUDIO):(t=lm,this._loadMode=hm.DOM_AUDIO),t}},{key:"_nativeAsset",set:function(e){if(this._audio=e,e){var t=this._getPlayer(e);this._player=new t({clip:e,duration:this._duration,eventTarget:this}),this.loaded=!0,this.emit("load")}else this._player=null,this._loadMode=hm.UNKNOWN_AUDIO,this._duration=0,this.loaded=!1},get:function(){return this._audio}},{key:"loadMode",get:function(){return this._loadMode}},{key:"state",get:function(){return this._player?this._player.getState():Jd.INITIALIZING}}]),t}(),om.PlayingState=Jd,om.AudioType=hm,om.preventDeferredLoadDependents=!0,rm=de((nm=sm).prototype,"_duration",[Ko],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return 0}}),am=de(nm.prototype,"_loadMode",[tm],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return hm.UNKNOWN_AUDIO}}),im=nm))||im),exports.AudioClip||(exports.AudioClip={}),cc.AudioClip=exports.AudioClip;var pm=Cs.__audioSupport,_m=pm.format;function fm(e,t){var i=document.createElement("audio");i.src=e.url;var n=function(){clearTimeout(r),i.removeEventListener("canplaythrough",a,!1),i.removeEventListener("error",o,!1),pm.USE_LOADER_EVENT&&i.removeEventListener(pm.USE_LOADER_EVENT,a,!1)},r=setTimeout((function(){0===i.readyState?o():a()}),8e3),a=function(){n(),t(null,i)},o=function(){n();var i="load audio failure - "+e.url;u(i),t(i)};i.addEventListener("canplaythrough",a,!1),i.addEventListener("error",o,!1),pm.USE_LOADER_EVENT&&i.addEventListener(pm.USE_LOADER_EVENT,a,!1)}function dm(e,t){var i=pm.context;i||t(new Error(w(4926)));var n=cc.loader.getXMLHttpRequest();n.open("GET",e.url,!0),n.responseType="arraybuffer",n.onload=function(){i.decodeAudioData(n.response,(function(e){t(null,e)}),(function(){t("decode error - "+e.id,null)}))},n.onerror=function(){t("request error - "+e.id,null)},n.send()}function mm(e,t){if(0===_m.length)return new Error(w(4927));var i;pm.WEB_AUDIO?i=e._owner instanceof exports.AudioClip?e._owner.loadMode===hm.WEB_AUDIO?dm:fm:e.urlParam&&e.urlParam.useDom?fm:dm:i=fm;i(e,t)}function vm(){return null}function ym(e,t,i){var n=e.url,r=document,a=document.createElement("script");function o(){a.parentNode&&a.parentNode.removeChild(a),a.removeEventListener("load",o,!1),a.removeEventListener("error",s,!1),t(null,n)}function s(){a.parentNode&&a.parentNode.removeChild(a),a.removeEventListener("load",o,!1),a.removeEventListener("error",s,!1),t(new Error(w(4928,n)))}a.async=!!i,a.src=ld(n),a.addEventListener("load",o,!1),a.addEventListener("error",s,!1),r.body.appendChild(a)}function gm(e,t,i,n){void 0===i&&(i=!0);var r=ld(e.url);function a(){n.removeEventListener("load",a),n.removeEventListener("error",o),n.id=e.id,t(null,n)}function o(){n.removeEventListener("load",a),n.removeEventListener("error",o),"https:"!==window.location.protocol&&n.crossOrigin&&"anonymous"===n.crossOrigin.toLowerCase()?gm(e,t,!1,n):t(new Error(w(4930,r)))}if(n=n||new Image,i&&"file:"!==window.location.protocol?n.crossOrigin="anonymous":n.crossOrigin=null,n.complete&&n.naturalWidth>0&&n.src===r)return n;n.addEventListener("load",a),n.addEventListener("error",o),n.src=r}var xm={js:ym,png:gm,jpg:gm,bmp:gm,jpeg:gm,gif:gm,ico:gm,tiff:gm,webp:gm,image:gm,pvr:Zd,pkm:Zd,mp3:mm,ogg:mm,wav:mm,m4a:mm,txt:Qd,xml:Qd,vsh:Qd,fsh:Qd,atlas:Qd,tmx:Qd,tsx:Qd,json:Qd,ExportJson:Qd,plist:Qd,fnt:Qd,font:vm,eot:vm,ttf:vm,woff:vm,svg:vm,ttc:vm,uuid:function(e,t){var i=gd(e,t);return void 0===i?this.extMap.json(e,t):i||void 0},binary:Zd,bin:Zd,default:Qd},bm=function(){function e(t){Z(this,e),this.id="Downloader",this.async=!0,this.pipeline=null,this.extMap=void 0,this._curConcurrent=0,this._loadQueue=[],this._subPackages={},this.extMap=Ue(t,xm)}return J(e,[{key:"setSubPackages",value:function(e){this._subPackages=e}},{key:"addHandlers",value:function(e){Ue(this.extMap,e)}},{key:"_handleLoadQueue",value:function(){for(;this._curConcurrent<cc.macro.DOWNLOAD_MAX_CONCURRENT;){var e=this._loadQueue.shift();if(!e)break;var t=this.handle(e.item,e.callback);void 0!==t&&(t instanceof Error?e.callback(t):e.callback(null,t))}}},{key:"handle",value:function(e,t){var i=this,n=this.extMap[e.type]||this.extMap.default,r=void 0;if(this._curConcurrent<cc.macro.DOWNLOAD_MAX_CONCURRENT){if(this._curConcurrent++,void 0!==(r=n.call(this,e,(function(e,n){i._curConcurrent=Math.max(0,i._curConcurrent-1),i._handleLoadQueue(),t&&t(e,n)}))))return this._curConcurrent=Math.max(0,this._curConcurrent-1),this._handleLoadQueue(),r}else if(e.ignoreMaxConcurrency){if(void 0!==(r=n.call(this,e,t)))return r}else this._loadQueue.push({item:e,callback:t})}},{key:"loadSubpackage",value:function(e,t){var i=this._subPackages[e];i?i.loaded?t&&t():ym({url:i.path},(function(e){e||(i.loaded=!0),t&&t(e)})):t&&t(new Error("Can't find subpackage ".concat(e)))}}]),e}();bm.ID="Downloader",bm.PackDownloader=xd,$f.Downloader=bm;var Tm=function(){function e(){Z(this,e),this._isSupportDOMParser=void 0,this._parser=void 0,window.DOMParser?(this._isSupportDOMParser=!0,this._parser=new DOMParser):(this._isSupportDOMParser=!1,this._parser=null)}return J(e,[{key:"parse",value:function(e){return this._parseXML(e)}},{key:"_parseXML",value:function(e){var t;return this._isSupportDOMParser?t=this._parser.parseFromString(e,"text/xml"):((t=new ActiveXObject("Microsoft.XMLDOM")).async="false",t.loadXML(e)),t}}]),e}(),Sm=new(function(e){function t(){return Z(this,t),re(this,te(t).apply(this,arguments))}return ee(t,Tm),J(t,[{key:"parse",value:function(e){var t=this._parseXML(e),i=t.documentElement;if("plist"!==i.tagName)return g(5100),{};for(var n=null,r=0,a=i.childNodes.length;r<a&&1!==(n=i.childNodes[r]).nodeType;r++);return t=null,this._parseNode(n)}},{key:"_parseNode",value:function(e){var t=null,i=e.tagName;if("dict"===i)t=this._parseDict(e);else if("array"===i)t=this._parseArray(e);else if("string"===i)if(1===e.childNodes.length)t=e.firstChild.nodeValue;else{t="";for(var n=0;n<e.childNodes.length;n++)t+=e.childNodes[n].nodeValue}else"false"===i?t=!1:"true"===i?t=!0:"real"===i?t=parseFloat(e.firstChild.nodeValue):"integer"===i&&(t=parseInt(e.firstChild.nodeValue,10));return t}},{key:"_parseArray",value:function(e){for(var t=[],i=0,n=e.childNodes.length;i<n;i++){var r=e.childNodes[i];1===r.nodeType&&t.push(this._parseNode(r))}return t}},{key:"_parseDict",value:function(e){for(var t={},i=null,n=0,r=e.childNodes.length;n<r;n++){var a=e.childNodes[n];1===a.nodeType&&("key"===a.tagName?i=a.firstChild.nodeValue:t[i]=this._parseNode(a))}return t}}]),t}());function Em(e){return e&&(e[0]&&"cc.Scene"===e[0].__type__||e[1]&&"cc.Scene"===e[1].__type__||e[0]&&"cc.Prefab"===e[0].__type__)}function wm(e,t){var i,n;if("string"==typeof e.content)try{if((i=JSON.parse(e.content)).keys&&i.data){var r=i.keys;ud(i=i.data,r)}}catch(t){return new Error(w(4923,e.id,t.stack))}else{if("object"!==K(e.content))return new Error(w(4924));i=e.content}if(null==i)return new Error(w(4923,e.id));var a=Em(i);n=a?cc._MissingScript.safeFindClass:function(e){var t=Qe(e);return t||(cc.warnID(4903,e),Object)};var o,s=cc.deserialize.Details.pool.get();try{o=cc.deserialize(i,s,{classFinder:n,target:e.existingAsset,customEnv:e})}catch(t){return cc.deserialize.Details.pool.put(s),console.error(t),new Error("Failed to load asset ".concat(e.id,", exception occurs during deserialization: ").concat(t.stack,"."))}o._uuid=e.uuid;var l=function(e,t,i,n){var r,a,o,s=i.uuidList,l=i.uuidObjList,u=i.uuidPropList,c=i._stillUseUrl,h=e.dependKeys=[];if(n)for(r=[],a=0;a<s.length;a++){o=s[a];var p=l[a],_=u[a],f=cc.AssetLibrary._getAssetInfoInRuntime(o);if(f.raw){var d=f.url;p[_]=d,h.push(d)}else r.push({type:"uuid",uuid:o,deferredLoadRaw:!0,_owner:p,_ownerProp:_,_stillUseUrl:c[a]})}else{for(r=new Array(s.length),a=0;a<s.length;a++)o=s[a],r[a]={type:"uuid",uuid:o,_owner:l[a],_ownerProp:u[a],_stillUseUrl:c[a]};t._native&&!t.constructor.preventPreloadNativeObject&&r.push({url:t.nativeUrl,_owner:t,_ownerProp:"_nativeAsset"})}return r}(e,o,s,function(e,t,i){var n=t.deferredLoadRaw;return n?e instanceof cc.Asset&&e.constructor.preventDeferredLoadDependents&&(n=!1):i&&(e instanceof cc.SceneAsset||e instanceof cc.Prefab)&&(n=e.asyncLoadAssets),n}(o,e,a));cc.deserialize.Details.pool.put(s);var u=function(e,i){if(!e&&i.onLoaded)try{i.onLoaded()}catch(t){e=t}t(e,i)};if(0===l.length)return u(null,o);!function(e,t,i,n,r){t.content=i;var a=t.dependKeys;e.flowInDeps(t,n,(function(e,t){var o,s=t.map;for(var l in s)(o=s[l]).uuid&&o.content&&(o.content._uuid=o.uuid);for(var u=0;u<n.length;u++){var c=function(e){var t=e.content;this._stillUseUrl&&(t=t?t.nativeUrl:e.rawUrl),this._owner[this._ownerProp]=t,e.uuid!==i._uuid&&a.indexOf(e.id)<0&&a.push(e.id)},h=n[u],p=h.uuid,_=h.url;h._owner,h._ownerProp;if(o=s[_]){var f=h;if(o.complete||o.content)o.error?cc._throw(o.error):c.call(f,o);else{var d=Zf.getQueue(o);d&&d.addListener(p,c,f)}}}r(e,i)}))}(this.pipeline,e,o,l,u)}wm.isSceneObj=Em;var Cm,Am=null,Om={},km=-1,Rm=[],Fm=function(){if(!Cm)if(window.FontFace){var e=/Gecko.*Firefox\/(\d+)/.exec(window.navigator.userAgent),t=/OS X.*Version\/10\..*Safari/.exec(window.navigator.userAgent)&&/Apple/.exec(window.navigator.vendor);Cm=e?parseInt(e[1],10)>42:!t}else Cm=!1;return Cm};function Mm(){for(var e=!0,t=Date.now(),i=Rm.length-1;i>=0;i--){var n=Rm[i],r=n.fontFamilyName;if(t-n.startTime>3e3)cc.warnID(4933,r),n.callback(null,r),Rm.splice(i,1);else{var a=n.refWidth;Am.font="40px "+r,a!==Io(Am,"BES bswy:->@123丁ぁᄁ")?(Rm.splice(i,1),n.callback(null,r)):e=!1}}e&&(clearInterval(km),km=-1)}function Im(e,t){var i=e.url,n=function(e){var t=e.lastIndexOf(".ttf");if(-1===t)return e;var i,n=e.lastIndexOf("/");i=-1===n?e.substring(0,t)+"_LABEL":e.substring(n+1,t)+"_LABEL";-1!==i.indexOf(" ")&&(i='"'+i+'"');return i}(i);if(Om[n])return n;if(!Am){var r=document.createElement("canvas");r.width=100,r.height=100,Am=r.getContext("2d")}var a="40px "+n;Am.font=a;var o=Io(Am,"BES bswy:->@123丁ぁᄁ"),s=document.createElement("style");s.type="text/css";var l="";isNaN(n-0)?l+="@font-face { font-family:"+n+"; src:":l+="@font-face { font-family:'"+n+"'; src:",l+="url('"+i+"');",s.textContent=l+"}",document.body.appendChild(s);var u=document.createElement("div"),c=u.style;if(c.fontFamily=n,u.innerHTML=".",c.position="absolute",c.left="-100px",c.top="-100px",document.body.appendChild(u),Fm())!function(e,t,i){var n,r=new Promise((function(i,n){!function r(){Date.now()-e>=3e3?n():document.fonts.load("40px "+t).then((function(e){e.length>=1?i():setTimeout(r,100)}),(function(){n()}))}()})),a=new Promise((function(e,t){n=setTimeout(t,3e3)}));Promise.race([a,r]).then((function(){n&&(clearTimeout(n),n=null),i(null,t)}),(function(){cc.warnID(4933,t),i(null,t)}))}(Date.now(),n,t);else{var h={fontFamilyName:n,refWidth:o,callback:t,startTime:Date.now()};Rm.push(h),-1===km&&(km=setInterval(Mm,100))}Om[n]=s}function Pm(e){if("string"!=typeof e.content)return new Error("JSON Loader: Input item doesn't contain string content");try{return JSON.parse(e.content)}catch(t){return new Error("JSON Loader: Parse json ["+e.id+"] failed : "+t)}}function Lm(e){if(e._owner instanceof cc.Asset)return null;var t=e.content;if(cc.sys.platform!==cc.sys.FB_PLAYABLE_ADS&&!(t instanceof Image))return new Error("Image Loader: Input item doesn't contain Image content");var i=e.rawUrl,n=e.imageAsset||new Gl;return n._uuid=e.uuid,n._url=i,n._setRawAsset(i,!1),n._nativeAsset=t,n}function Dm(e,t){if(e._owner instanceof cc.Asset)return null;var i=new cc.AudioClip;return i._setRawAsset(e.rawUrl,!1),i._nativeAsset=e.content,i}function Nm(e){return e.load?e.load(e.content):e.content}function zm(e,t){return e[t]<<8|e[t+1]}var Bm={png:Lm,jpg:Lm,bmp:Lm,jpeg:Lm,gif:Lm,ico:Lm,tiff:Lm,webp:Lm,image:Lm,pvr:function(e){var t=e.content instanceof ArrayBuffer?e.content:e.content.buffer,i=new Int32Array(t,0,13);if(55727696===i[0]){var n=i[7],r=i[6],a=i[12]+52;return t=t.slice(a,t.byteLength),{_data:new Uint8Array(t),_compressed:!0,width:n,height:r}}if(559044176===i[11]){var o=i[0],s=i[1],l=i[2];return t=t.slice(o,t.byteLength),{_data:new Uint8Array(t),_compressed:!0,width:l,height:s}}return new Error("Invalid magic number in PVR header")},pkm:function(e){var t=e.content instanceof ArrayBuffer?e.content:e.content.buffer,i=new Uint8Array(t),n=zm(i,6);if(0!==n&&1!==n&&3!==n)return new Error("Invalid magic number in ETC header");var r=zm(i,12),a=zm(i,14);return zm(i,8),zm(i,10),t=t.slice(16,t.byteLength),{_data:new Uint8Array(t),_compressed:!0,width:r,height:a}},mp3:Dm,ogg:Dm,wav:Dm,m4a:Dm,json:Pm,ExportJson:Pm,plist:function(e){if("string"!=typeof e.content)return new Error("Plist Loader: Input item doesn't contain string content");var t=Sm.parse(e.content);return t||new Error("Plist Loader: Parse ["+e.id+"] failed")},uuid:wm,prefab:wm,fire:wm,scene:wm,binary:Nm,bin:Nm,font:Im,eot:Im,ttf:Im,woff:Im,svg:Im,ttc:Im,default:function(){return null}},Gm=function(){function e(t){Z(this,e),this.id="Loader",this.async=!0,this.pipeline=null,this.extMap=void 0,this.extMap=Ue(t,Bm)}return J(e,[{key:"addHandlers",value:function(e){this.extMap=Ue(this.extMap,e)}},{key:"handle",value:function(e,t){return(this.extMap[e.type]||this.extMap.default).call(this,e,t)}}]),e}();Gm.ID="Loader",$f.Loader=Gm;var Um=Object.create(null);function Xm(){return window.XMLHttpRequest?new window.XMLHttpRequest:new ActiveXObject("MSXML2.XMLHTTP")}Um.assets=new Lf,Um.internal=new Lf;var Vm={url:null,raw:!1};function Hm(e){var t,i,n;if("object"===K(e)){if(i=e,e.url)return i;t=e.uuid}else i={},t=e;return n=i.type?"uuid"===i.type:cc.AssetLibrary._uuidInSettings(t),cc.AssetLibrary._getAssetInfoInRuntime(t,Vm),i.url=n?Vm.url:t,Vm.url&&"uuid"===i.type&&Vm.raw?(i.type=null,i.isRawAsset=!0):n||(i.isRawAsset=!0),i}var Wm=[],jm=[],qm=function(e){function t(){var e;Z(this,t);var i=new Kd,n=new bm,r=new Gm;return(e=re(this,te(t).call(this,[i,n,r]))).getXMLHttpRequest=void 0,e.assetLoader=void 0,e.md5Pipe=void 0,e.downloader=void 0,e.loader=void 0,e.onProgress=void 0,e._assetTables=void 0,e._autoReleaseSetting=void 0,e._releasedAssetChecker_DEBUG=void 0,e.getXMLHttpRequest=Xm,e.assetLoader=i,e.md5Pipe=null,e.downloader=n,e.loader=r,e.onProgress=null,e._assetTables=Um,e._autoReleaseSetting=Re(!0),e}return ee(t,$f),J(t,[{key:"init",value:function(e){}},{key:"addDownloadHandlers",value:function(e){this.downloader.addHandlers(e)}},{key:"addLoadHandlers",value:function(e){this.loader.addHandlers(e)}},{key:"load",value:function(e,t,i){void 0===i&&(i=t,t=this.onProgress||null);var n,r,a=this,o=!1;e instanceof Array?n=e:e?(o=!0,n=[e]):n=[],Wm.length=0;for(var s=0;s<n.length;++s){var l=n[s];if(l&&l.id&&(g(4920,l.id),l.uuid||l.url||(l.url=l.id)),(r=Hm(l)).url||r.uuid){var u=this._cache[r.url];Wm.push(u||r)}}var c=Zf.create(this,t,(function(e,t){ft((function(){if(i){if(o){var n=r.url;i.call(a,t.getError(n),t.getContent(n))}else i.call(a,e,t);i=null}t.destroy()}))}));Zf.initQueueDeps(c),c.append(Wm),Wm.length=0}},{key:"flowInDeps",value:function(e,t,i){jm.length=0;for(var n=0;n<t.length;++n){var r=Hm(t[n]);if(r.url||r.uuid){var a=this._cache[r.url];a?jm.push(a):jm.push(r)}}var o=Zf.create(this,e?function(e,t,i){o._ownerQueue&&o._ownerQueue.onProgress&&o._ownerQueue._childOnProgress(i)}:null,(function(t,n){i(t,n),e&&e.deps&&(e.deps.length=0),n.destroy()}));if(e){var s=Zf.getQueue(e);o._ownerQueue=s&&s._ownerQueue||s}var l=o.append(jm,e);return jm.length=0,l}},{key:"loadRes",value:function(e,t,i,n,r){5!==arguments.length&&(r=n,n=i,i="assets");var a=this._parseLoadResArgs(t,n,r);t=a.type,n=a.onProgress,r=a.onComplete;var o=this,s=o._getResUuid(e,t,i,!0);s?this.load({type:"uuid",uuid:s},n,(function(e,t){t&&o.setAutoReleaseRecursively(s,!1),r&&r(e,t)})):o._urlNotFound(e,t,r)}},{key:"loadResDir",value:function(e,t,i,n,r){if(5!==arguments.length&&(r=n,n=i,i="assets"),Um[i]){var a=this._parseLoadResArgs(t,n,r);t=a.type,n=a.onProgress,r=a.onComplete;var o=[],s=Um[i].getUuidArray(e,t,o);this._loadResUuids(s,n,(function(e,t,i){for(var n=t.length,a=0;a<n;++a)if(t[a]instanceof bf){var o=t[a].getSpriteFrames();for(var s in o){var l=o[s];t.push(l),i&&i.push("".concat(i[a],"/").concat(l.name))}}r&&r(e,t,i)}),o)}}},{key:"loadResArray",value:function(e,t,i,n,r){5!==arguments.length&&(r=n,n=i,i="assets");var a=this._parseLoadResArgs(t,n,r);t=a.type,n=a.onProgress,r=a.onComplete;for(var o=[],s=0;s<e.length;s++){var l=e[s],u=this._getResUuid(l,t,i,!0);if(!u)return void this._urlNotFound(l,t,r);o.push(u)}this._loadResUuids(o,n,r)}},{key:"getRes",value:function(e,t){var i=this._cache[e];if(!i){var n=this._getResUuid(e,t,null,!0);if(!n)return null;var r=this._getReferenceKey(n);i=this._cache[r]}return i&&i.alias&&(i=i.alias),i&&i.complete?i.content:null}},{key:"getResCount",value:function(){return Object.keys(this._cache).length}},{key:"getDependsRecursively",value:function(e){if(e){var t=this._getReferenceKey(e),i=Gf(t);return i.push(t),i}return[]}},{key:"release",value:function(e){if(Array.isArray(e))for(var t=0;t<e.length;t++){var i=e[t];this.release(i)}else if(e){var n=this._getReferenceKey(e),r=this.getItem(n);if(r){this.removeItem(n);if((e=r.content)instanceof zl){var a=e.nativeUrl;a&&this.release(a),e.destroy()}}}}},{key:"releaseAsset",value:function(e){var t=e._uuid;t&&this.release(t)}},{key:"releaseRes",value:function(e,t,i){var n=this._getResUuid(e,t,i,!0);n?this.release(n):b(4914,e)}},{key:"releaseResDir",value:function(e,t,i){if(Um[i=i||"assets"])for(var n=Um[i].getUuidArray(e,t),r=0;r<n.length;r++){var a=n[r];this.release(a)}}},{key:"releaseAll",value:function(){for(var e in this._cache)this.release(e)}},{key:"removeItem",value:function(e){var t=$f.prototype.removeItem.call(this,e);return delete this._autoReleaseSetting[e],t}},{key:"setAutoRelease",value:function(e,t){var i=this._getReferenceKey(e);i&&(this._autoReleaseSetting[i]=!!t)}},{key:"setAutoReleaseRecursively",value:function(e,t){t=!!t;var i=this._getReferenceKey(e);if(i){this._autoReleaseSetting[i]=t;for(var n=Gf(i),r=0;r<n.length;r++){var a=n[r];this._autoReleaseSetting[a]=t}}}},{key:"isAutoRelease",value:function(e){var t=this._getReferenceKey(e);return!!t&&!!this._autoReleaseSetting[t]}},{key:"_getResUuid",value:function(e,t,i,n){var r="",a=Um[i=i||"assets"];if(e&&a){var o=e.indexOf("?");if(-1!==o&&(e=e.substr(0,o)),!(r=a.getUuid(e,t))){var s=I(e);s&&(e=e.slice(0,-s.length),(r=a.getUuid(e,t))&&!n&&g(4901,e,s))}}return!r&&t&&(He(t,Ac)||He(t,gu)||He(t,Oc))&&g(4934),r}},{key:"_getReferenceKey",value:function(e){var t;return"object"===K(e)?t=e._uuid||null:"string"==typeof e&&(t=this._getResUuid(e,void 0,void 0,!0)||e),t?(cc.AssetLibrary._getAssetInfoInRuntime(t,Vm),this._cache[Vm.url]?Vm.url:t):(g(4800,e),t)}},{key:"_urlNotFound",value:function(e,t,i){ft((function(){e=cc.url.normalize(e);var n="".concat(t?Fe(t):"Asset",' in "resources/').concat(e,'" does not exist.');i&&i(new Error(n),[])}))}},{key:"_parseLoadResArgs",value:function(e,t,i){if(void 0===i){var n=He(e,cc.RawAsset);t?(i=t,n&&(t=this.onProgress||null)):void 0!==t||n||(i=e,t=this.onProgress||null,e=null),void 0===t||n||(t=e,e=null)}return{type:e,onProgress:t,onComplete:i}}},{key:"_loadResUuids",value:function(e,t,i,n){if(e.length>0){var r=this,a=e.map((function(e){return{type:"uuid",uuid:e}}));this.load(a,t,(function(e,t){if(i){for(var o=[],s=n&&[],l=0;l<a.length;++l){var u=a[l].uuid,c=r._getReferenceKey(u),h=t.getContent(c);h&&(r.setAutoReleaseRecursively(u,!1),o.push(h),s&&s.push(n[l]))}n?i(e,o,s):i(e,o)}}))}else i&&ft((function(){n?i(null,[],[]):i(null,[])}))}}]),t}(),Ym=cc.loader=new qm;var Km,Zm,Qm,Jm,$m,ev,tv,iv,nv,rv,av,ov,sv,lv=Object.freeze({__proto__:null,loadImage:function(e,t,i){E(!!e,3103);var n=Ym.getRes(e);return n?n.loaded?(t&&t.call(i,null,n),n):(n.once("load",(function(){t&&t.call(i,null,n)}),i),n):(n=new Gl,Ym.load({url:e,imageAsset:n},(function(e,r){if(e)return t&&t.call(i,e||new Error("Unknown error")),n;t&&t.call(i,null,r)})),n)},cacheImage:function(e,t){if(e&&t){var i=new Gl(t),n={id:e,url:e,error:null,content:i,complete:!1};return Ym.flowOut(n),i}},postLoadImage:function(e,t){e.loaded?t&&t():e.nativeUrl?Ym.load({url:e.nativeUrl,skips:e.isCompressed?void 0:["Loader"]},(function(i,n){n&&(e.loaded||(e._nativeAsset=n)),t&&t(i)})):t&&t()}}),uv=(Km=Yo("cc.Skeleton"),Zm=Ko([It]),Qm=Ko([Ki]),Km((ev=de(($m=function(e){function t(){var e,i;Z(this,t);for(var n=arguments.length,r=new Array(n),a=0;a<n;a++)r[a]=arguments[a];return fe(i=re(this,(e=te(t)).call.apply(e,[this].concat(r))),"_joints",ev,ne(i)),fe(i,"_bindposes",tv,ne(i)),fe(i,"_hash",iv,ne(i)),i._invBindposes=null,i}return ee(t,zl),J(t,[{key:"destroy",value:function(){return cc.director.root.dataPoolManager.releaseSkeleton(this),oe(te(t.prototype),"destroy",this).call(this)}},{key:"joints",get:function(){return this._joints},set:function(e){this._joints=e}},{key:"bindposes",get:function(){return this._bindposes},set:function(e){this._bindposes=e}},{key:"inverseBindposes",get:function(){if(!this._invBindposes){this._invBindposes=[];for(var e=0;e<this._bindposes.length;e++){var t=new Ki;Ki.invert(t,this._bindposes[e]),this._invBindposes.push(t)}}return this._invBindposes}},{key:"hash",get:function(){if(!this._hash){for(var e="",t=0;t<this._bindposes.length;t++){var i=this._bindposes[t];e+=i.m00.toPrecision(2)+" "+i.m01.toPrecision(2)+" "+i.m02.toPrecision(2)+" "+i.m03.toPrecision(2)+" "+i.m04.toPrecision(2)+" "+i.m05.toPrecision(2)+" "+i.m06.toPrecision(2)+" "+i.m07.toPrecision(2)+" "+i.m08.toPrecision(2)+" "+i.m09.toPrecision(2)+" "+i.m10.toPrecision(2)+" "+i.m11.toPrecision(2)+" "+i.m12.toPrecision(2)+" "+i.m13.toPrecision(2)+" "+i.m14.toPrecision(2)+" "+i.m15.toPrecision(2)+"\n"}this._hash=rl(e,666)}return this._hash}}]),t}()).prototype,"_joints",[Zm],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return[]}}),tv=de($m.prototype,"_bindposes",[Qm],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return[]}}),iv=de($m.prototype,"_hash",[Ko],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return 0}}),Jm=$m))||Jm);cc.Skeleton=uv,function(e){e[e.VERTICAL=0]="VERTICAL",e[e.HORIZONTAL=1]="HORIZONTAL"}(nv||(nv={})),function(e){e[e.ORTHO=0]="ORTHO",e[e.PERSPECTIVE=1]="PERSPECTIVE"}(rv||(rv={})),function(e){e[e.F1_8=0]="F1_8",e[e.F2_0=1]="F2_0",e[e.F2_2=2]="F2_2",e[e.F2_5=3]="F2_5",e[e.F2_8=4]="F2_8",e[e.F3_2=5]="F3_2",e[e.F3_5=6]="F3_5",e[e.F4_0=7]="F4_0",e[e.F4_5=8]="F4_5",e[e.F5_0=9]="F5_0",e[e.F5_6=10]="F5_6",e[e.F6_3=11]="F6_3",e[e.F7_1=12]="F7_1",e[e.F8_0=13]="F8_0",e[e.F9_0=14]="F9_0",e[e.F10_0=15]="F10_0",e[e.F11_0=16]="F11_0",e[e.F13_0=17]="F13_0",e[e.F14_0=18]="F14_0",e[e.F16_0=19]="F16_0",e[e.F18_0=20]="F18_0",e[e.F20_0=21]="F20_0",e[e.F22_0=22]="F22_0"}(av||(av={})),function(e){e[e.ISO100=0]="ISO100",e[e.ISO200=1]="ISO200",e[e.ISO400=2]="ISO400",e[e.ISO800=3]="ISO800"}(ov||(ov={})),function(e){e[e.D1=0]="D1",e[e.D2=1]="D2",e[e.D4=2]="D4",e[e.D8=3]="D8",e[e.D15=4]="D15",e[e.D30=5]="D30",e[e.D60=6]="D60",e[e.D125=7]="D125",e[e.D250=8]="D250",e[e.D500=9]="D500",e[e.D1000=10]="D1000",e[e.D2000=11]="D2000",e[e.D4000=12]="D4000"}(sv||(sv={}));var cv,hv=[1.8,2,2.2,2.5,2.8,3.2,3.5,4,4.5,5,5.6,6.3,7.1,8,9,10,11,13,14,16,18,20,22],pv=[1,.5,1/4,1/8,1/15,1/30,1/60,.008,.004,.002,.001,5e-4,1/4e3],_v=[100,200,400,800],fv=new Ii,dv=new Ii,mv=new Ki,vv=new Ki,yv=exports.GFXClearFlag.STENCIL<<1,gv=function(){function e(){Z(this,e),this.isWindowSize=!0,this.screenScale=void 0,this.viewport=new nn(0,0,1,1),this.clearStencil=0,this.clearDepth=1,this.clearFlag=exports.GFXClearFlag.NONE,this._scene=null,this._node=null,this._name=null,this._enabled=!1,this._proj=-1,this._width=void 0,this._height=void 0,this._aspect=void 0,this._orthoHeight=10,this._fovAxis=nv.VERTICAL,this._fov=di(45),this._nearClip=1,this._farClip=1e3,this._clearColor={r:.2,g:.2,b:.2,a:1},this._isProjDirty=!0,this._matView=new Ki,this._matViewInv=null,this._matProj=new Ki,this._matProjInv=new Ki,this._matViewProj=new Ki,this._matViewProjInv=new Ki,this._frustum=new mo,this._forward=new Ii,this._position=new Ii,this._view=null,this._visibility=Xu,this._priority=0,this._aperture=av.F16_0,this._apertureValue=void 0,this._shutter=sv.D125,this._shutterValue=0,this._iso=ov.ISO100,this._isoValue=0,this._ec=0,this._exposure=0,this._apertureValue=hv[this._aperture],this._shutterValue=pv[this._shutter],this._isoValue=_v[this._iso],this.updateExposure(),this._aspect=this._width=this._height=this.screenScale=1}return J(e,[{key:"initialize",value:function(e){this._name=e.name,this._node=e.node,this._proj=e.projection,this._priority=e.priority||0,this._view=cc.director.root.createView({camera:this,name:this._name,priority:this._priority,flows:e.flows}),this.changeTargetWindow(e.window),console.log("Created Camera: "+this._name+" "+this._width+"x"+this._height)}},{key:"destroy",value:function(){cc.director.root.destroyView(this._view),this._view=null,this._name=null}},{key:"attachToScene",value:function(e){this._scene=e,this._view&&this._view.enable(!0)}},{key:"detachFromScene",value:function(){this._scene=null,this._view&&this._view.enable(!1)}},{key:"resize",value:function(e,t){this._width=e,this._height=t,this._aspect=this._width/this._height,this._isProjDirty=!0}},{key:"setFixedSize",value:function(e,t){this._width=e,this._height=t,this._aspect=this._width/this._height,this.isWindowSize=!1}},{key:"update",value:function(){var e=arguments.length>0&&void 0!==arguments[0]&&arguments[0];if(this._node){if((this._node.hasChangedFlags||e)&&(Ki.invert(this._matView,this._node.worldMatrix),this._forward.x=-this._matView.m02,this._forward.y=-this._matView.m06,this._forward.z=-this._matView.m10,this._node.getWorldPosition(this._position)),this._isProjDirty){if(this._proj===rv.PERSPECTIVE)Ki.perspective(this._matProj,this._fov,this._aspect,this._nearClip,this._farClip,this._fovAxis===nv.VERTICAL);else{var t=this._orthoHeight*this._aspect,i=this._orthoHeight;Ki.ortho(this._matProj,-t,t,-i,i,this._nearClip,this._farClip)}Ki.invert(this._matProjInv,this._matProj)}(this._node.hasChangedFlags||this._isProjDirty||e)&&(Ki.multiply(this._matViewProj,this._matProj,this._matView),Ki.invert(this._matViewProjInv,this._matViewProj),this._frustum.update(this._matViewProj,this._matViewProjInv)),this._isProjDirty=!1}}},{key:"getSplitFrustum",value:function(e,t,i){if(this._node){if(t=Math.max(t,this._nearClip),i=Math.min(i,this._farClip),Ki.invert(this._matView,this._node.worldMatrix),this._proj===rv.PERSPECTIVE)Ki.perspective(mv,this._fov,this._aspect,t,i,this._fovAxis===nv.VERTICAL);else{var n=this._orthoHeight*this._aspect,r=this._orthoHeight;Ki.ortho(mv,-n,n,-r,r,t,i)}Ki.multiply(vv,mv,this._matView),Ki.invert(mv,vv),e.update(vv,mv)}}},{key:"changeTargetWindow",value:function(){var e=arguments.length>0&&void 0!==arguments[0]?arguments[0]:null,t=e||cc.director.root.mainWindow;t&&this._view&&(this._view.window=t,this.resize(t.width,t.height))}},{key:"screenPointToRay",value:function(e,t,i){var n=this.viewport.x*this._width,r=this.viewport.y*this._height,a=this.viewport.width*this._width,o=this.viewport.height*this._height;return Ii.set(fv,(t-n)/a*2-1,(i-r)/o*2-1,1),Ii.transformMat4(fv,fv,this._matViewProjInv),this._proj===rv.PERSPECTIVE?this._node&&this._node.getWorldPosition(dv):(Ii.set(dv,(t-n)/a*2-1,(i-r)/o*2-1,-1),Ii.transformMat4(dv,dv,this._matViewProjInv)),Cn.fromPoints(e,dv,fv)}},{key:"screenToWorld",value:function(e,t){var i=this.viewport.x*this._width,n=this.viewport.y*this._height,r=this.viewport.width*this._width,a=this.viewport.height*this._height;return this._proj===rv.PERSPECTIVE?(Ii.set(e,(t.x-i)/r*2-1,(t.y-n)/a*2-1,1),Ii.transformMat4(e,e,this._matViewProjInv),this._node&&this._node.getWorldPosition(fv),Ii.lerp(e,fv,e,fi(this._nearClip/this._farClip,1,t.z))):(Ii.set(e,(t.x-i)/r*2-1,(t.y-n)/a*2-1,2*t.z-1),Ii.transformMat4(e,e,this.matViewProjInv)),e}},{key:"worldToScreen",value:function(e,t){var i=this.viewport.x*this._width,n=this.viewport.y*this._height,r=this.viewport.width*this._width,a=this.viewport.height*this._height;return Ii.transformMat4(e,t,this.matViewProj),e.x=i+.5*(e.x+1)*r,e.y=n+.5*(e.y+1)*a,e.z=.5*e.z+.5,e}},{key:"updateExposure",value:function(){var e=Math.log2(this._apertureValue*this._apertureValue/this._shutterValue*100/this._isoValue);this._exposure=.833333/Math.pow(2,e)}},{key:"node",set:function(e){this._node=e},get:function(){return this._node}},{key:"enabled",set:function(e){this._enabled=e,this._view&&this._view.enable(e)},get:function(){return this._enabled}},{key:"view",get:function(){return this._view}},{key:"orthoHeight",set:function(e){this._orthoHeight=e,this._isProjDirty=!0},get:function(){return this._orthoHeight}},{key:"projectionType",set:function(e){this._proj=e,this._isProjDirty=!0},get:function(){return this._proj}},{key:"fovAxis",set:function(e){this._fovAxis=e,this._isProjDirty=!0},get:function(){return this._fovAxis}},{key:"fov",set:function(e){this._fov=e,this._isProjDirty=!0},get:function(){return this._fov}},{key:"nearClip",set:function(e){this._nearClip=e,this._isProjDirty=!0},get:function(){return this._nearClip}},{key:"farClip",set:function(e){this._farClip=e,this._isProjDirty=!0},get:function(){return this._farClip}},{key:"clearColor",set:function(e){this._clearColor.r=e.r,this._clearColor.g=e.g,this._clearColor.b=e.b,this._clearColor.a=e.a},get:function(){return this._clearColor}},{key:"scene",get:function(){return this._scene}},{key:"name",get:function(){return this._name}},{key:"width",get:function(){return this._width}},{key:"height",get:function(){return this._height}},{key:"aspect",get:function(){return this._aspect}},{key:"matView",set:function(e){this._matView=e},get:function(){return this._matView}},{key:"matViewInv",set:function(e){this._matViewInv=e},get:function(){return this._matViewInv||this._node.worldMatrix}},{key:"matProj",set:function(e){this._matProj=e},get:function(){return this._matProj}},{key:"matProjInv",set:function(e){this._matProjInv=e},get:function(){return this._matProjInv}},{key:"matViewProj",set:function(e){this._matViewProj=e},get:function(){return this._matViewProj}},{key:"matViewProjInv",set:function(e){this._matViewProjInv=e},get:function(){return this._matViewProjInv}},{key:"frustum",set:function(e){this._frustum=e},get:function(){return this._frustum}},{key:"forward",set:function(e){this._forward=e},get:function(){return this._forward}},{key:"position",set:function(e){this._position=e},get:function(){return this._position}},{key:"visibility",set:function(e){this._visibility=e,this._view&&(this._view.visibility=e)},get:function(){return this._visibility}},{key:"priority",get:function(){return this._view?this._view.priority:-1},set:function(e){this._priority=e,this._view&&(this._view.priority=this._priority)}},{key:"aperture",set:function(e){this._aperture=e,this._apertureValue=hv[this._aperture],this.updateExposure()},get:function(){return this._aperture}},{key:"apertureValue",get:function(){return this._apertureValue}},{key:"shutter",set:function(e){this._shutter=e,this._shutterValue=pv[this._shutter],this.updateExposure()},get:function(){return this._shutter}},{key:"shutterValue",get:function(){return this._shutterValue}},{key:"iso",set:function(e){this._iso=e,this._isoValue=_v[this._iso],this.updateExposure()},get:function(){return this._iso}},{key:"isoValue",get:function(){return this._isoValue}},{key:"ec",set:function(e){this._ec=e},get:function(){return this._ec}},{key:"exposure",get:function(){return this._exposure}},{key:"flows",set:function(e){this._view&&this._view.setExecuteFlows(e)}}]),e}();(cv=exports.SystemEventType||(exports.SystemEventType={})).TOUCH_START="touch-start",cv.TOUCH_MOVE="touch-move",cv.TOUCH_END="touch-end",cv.TOUCH_CANCEL="touch-cancel",cv.MOUSE_DOWN="mouse-down",cv.MOUSE_MOVE="mouse-move",cv.MOUSE_UP="mouse-up",cv.MOUSE_WHEEL="mouse-wheel",cv.MOUSE_ENTER="mouse-enter",cv.MOUSE_LEAVE="mouse-leave",cv.KEY_DOWN="keydown",cv.KEY_UP="keyup",cv.DEVICEMOTION="devicemotion",cv.TRANSFORM_CHANGED="transform-changed",cv.SCENE_CHANGED_FOR_PERSISTS="scene-changed-for-persists",cv.SIZE_CHANGED="size-changed",cv.ANCHOR_CHANGED="anchor-changed",cv.CHILD_ADDED="child-added",cv.CHILD_REMOVED="child-removed",cv.PARENT_CHANGED="parent-changed",cv.NODE_DESTROYED="node-destroyed",bt(exports.SystemEventType),cc.SystemEventType=exports.SystemEventType;var xv=new ki,bv=function(e){function t(e,i,n){var r;return Z(this,t),(r=re(this,te(t).call(this,al.MOUSE,i))).movementX=0,r.movementY=0,r.eventType=void 0,r._button=t.BUTTON_MISSING,r._x=0,r._y=0,r._prevX=0,r._prevY=0,r._scrollX=0,r._scrollY=0,r.eventType=e,n&&(r._prevX=n.x,r._prevY=n.y),r}return ee(t,al),J(t,[{key:"setScrollData",value:function(e,t){this._scrollX=e,this._scrollY=t}},{key:"getScrollX",value:function(){return this._scrollX}},{key:"getScrollY",value:function(){return this._scrollY}},{key:"setLocation",value:function(e,t){this._x=e,this._y=t}},{key:"getLocation",value:function(e){return e||(e=new ki),ki.set(e,this._x,this._y),e}},{key:"getLocationInView",value:function(e){return e||(e=new ki),ki.set(e,this._x,cc.view._designResolutionSize.height-this._y),e}},{key:"getUILocation",value:function(e){return e||(e=new ki),ki.set(e,this._x,this._y),cc.view._convertPointWithScale(e),e}},{key:"getPreviousLocation",value:function(e){return e||(e=new ki),ki.set(e,this._prevX,this._prevY),e}},{key:"getUIPreviousLocation",value:function(e){return e||(e=new ki),ki.set(e,this._prevX,this._prevY),cc.view._convertPointWithScale(e),e}},{key:"getDelta",value:function(e){return e||(e=new ki),ki.set(e,this._x-this._prevX,this._y-this._prevY),e}},{key:"getDeltaX",value:function(){return this._x-this._prevX}},{key:"getDeltaY",value:function(){return this._y-this._prevY}},{key:"getUIDelta",value:function(e){return e||(e=new ki),ki.set(e,(this._x-this._prevX)/cc.view.getScaleX(),(this._y-this._prevY)/cc.view.getScaleY()),e}},{key:"getUIDeltaX",value:function(){return(this._x-this._prevX)/cc.view.getScaleX()}},{key:"getUIDeltaY",value:function(){return(this._y-this._prevY)/cc.view.getScaleY()}},{key:"setButton",value:function(e){this._button=e}},{key:"getButton",value:function(){return this._button}},{key:"getLocationX",value:function(){return this._x}},{key:"getLocationY",value:function(){return this._y}},{key:"getUILocationX",value:function(){var e=cc.view.getViewportRect();return(this._x-e.x)/cc.view.getScaleX()}},{key:"getUILocationY",value:function(){var e=cc.view.getViewportRect();return(this._y-e.y)/cc.view.getScaleY()}}]),t}();bv.NONE=0,bv.DOWN=1,bv.UP=2,bv.MOVE=3,bv.SCROLL=4,bv.BUTTON_MISSING=-1,bv.BUTTON_LEFT=0,bv.BUTTON_RIGHT=2,bv.BUTTON_MIDDLE=1,bv.BUTTON_4=3,bv.BUTTON_5=4,bv.BUTTON_6=5,bv.BUTTON_7=6,bv.BUTTON_8=7;var Tv=function(e){function t(e,i,n){var r;return Z(this,t),(r=re(this,te(t).call(this,al.TOUCH,i))).touch=null,r.simulate=!1,r._eventCode=void 0,r._touches=void 0,r._eventCode=n||0,r._touches=e||[],r}return ee(t,al),J(t,[{key:"getEventCode",value:function(){return this._eventCode}},{key:"getTouches",value:function(){return this._touches}},{key:"setLocation",value:function(e,t){this.touch&&this.touch.setTouchInfo(this.touch.getID(),e,t)}},{key:"getLocation",value:function(e){return this.touch?this.touch.getLocation(e):new ki}},{key:"getUILocation",value:function(e){return this.touch?this.touch.getUILocation(e):new ki}},{key:"getLocationInView",value:function(e){return this.touch?this.touch.getLocationInView(e):new ki}},{key:"getPreviousLocation",value:function(e){return this.touch?this.touch.getPreviousLocation(e):new ki}},{key:"getStartLocation",value:function(e){return this.touch?this.touch.getStartLocation(e):new ki}},{key:"getUIStartLocation",value:function(e){return this.touch?this.touch.getUIStartLocation(e):new ki}},{key:"getID",value:function(){return this.touch?this.touch.getID():null}},{key:"getDelta",value:function(e){return this.touch?this.touch.getDelta(e):new ki}},{key:"getUIDelta",value:function(e){return this.touch?this.touch.getUIDelta(e):new ki}},{key:"getDeltaX",value:function(){return this.touch?this.touch.getDelta(xv).x:0}},{key:"getDeltaY",value:function(){return this.touch?this.touch.getDelta(xv).y:0}},{key:"getLocationX",value:function(){return this.touch?this.touch.getLocationX():0}},{key:"getLocationY",value:function(){return this.touch?this.touch.getLocationY():0}}]),t}();Tv.MAX_TOUCHES=5,Tv.BEGAN=0,Tv.MOVED=1,Tv.ENDED=2,Tv.CANCELLED=3;var Sv=function(e){function t(e,i){var n;return Z(this,t),(n=re(this,te(t).call(this,al.ACCELERATION,i))).acc=void 0,n.acc=e,n}return ee(t,al),t}(),Ev=function(e){function t(e,i,n){var r;return Z(this,t),(r=re(this,te(t).call(this,al.KEYBOARD,n))).keyCode=void 0,r.rawEvent=void 0,r.isPressed=void 0,"number"==typeof e?r.keyCode=e:(r.keyCode=e.keyCode,r.rawEvent=e),r.isPressed=i,r}return ee(t,al),t}();al.EventMouse=bv,al.EventTouch=Tv,al.EventAcceleration=Sv,al.EventKeyboard=Ev;var wv=function(){function e(t,i,n){Z(this,e),this.owner=null,this.mask=null,this._previousIn=!1,this._target=null,this._onEvent=void 0,this._type=void 0,this._listenerID=void 0,this._registered=!1,this._fixedPriority=0,this._node=null,this._paused=!0,this._isEnabled=!0,this._onEvent=n,this._type=t||0,this._listenerID=i||""}return J(e,[{key:"onEvent",get:function(){return this._onEvent}}],[{key:"create",value:function(e){cc.assertID(e&&e.event,1900);var t=e.event;delete e.event;var i=null;if(t===cc.EventListener.TOUCH_ONE_BY_ONE?i=new Ov:t===cc.EventListener.TOUCH_ALL_AT_ONCE?i=new kv:t===cc.EventListener.MOUSE?i=new Av:t===cc.EventListener.KEYBOARD?i=new Fv:t===cc.EventListener.ACCELERATION&&(i=new Rv(e.callback),delete e.callback),i)for(var n=0,r=Object.keys(e);n<r.length;n++){var a=r[n];i[a]=e[a]}return i}}]),J(e,[{key:"_setPaused",value:function(e){this._paused=e}},{key:"_isPaused",value:function(){return this._paused}},{key:"_setRegistered",value:function(e){this._registered=e}},{key:"_isRegistered",value:function(){return this._registered}},{key:"_getType",value:function(){return this._type}},{key:"_getListenerID",value:function(){return this._listenerID}},{key:"_setFixedPriority",value:function(e){this._fixedPriority=e}},{key:"_getFixedPriority",value:function(){return this._fixedPriority}},{key:"_setSceneGraphPriority",value:function(e){this._target=e,this._node=e}},{key:"_getSceneGraphPriority",value:function(){return this._node}},{key:"checkAvailable",value:function(){return null!==this._onEvent}},{key:"clone",value:function(){return null}},{key:"setEnabled",value:function(e){this._isEnabled=e}},{key:"isEnabled",value:function(){return this._isEnabled}}]),e}();wv.UNKNOWN=0,wv.TOUCH_ONE_BY_ONE=1,wv.TOUCH_ALL_AT_ONCE=2,wv.KEYBOARD=3,wv.MOUSE=4,wv.ACCELERATION=6,wv.CUSTOM=8,wv.ListenerID={MOUSE:"__cc_mouse",TOUCH_ONE_BY_ONE:"__cc_touch_one_by_one",TOUCH_ALL_AT_ONCE:"__cc_touch_all_at_once",KEYBOARD:"__cc_keyboard",ACCELERATION:"__cc_acceleration"};var Cv=wv.ListenerID,Av=function(e){function t(){var e;return Z(this,t),(e=re(this,te(t).call(this,wv.MOUSE,Cv.MOUSE,null))).onMouseDown=null,e.onMouseUp=null,e.onMouseMove=null,e.onMouseScroll=null,e._onEvent=function(t){return e._callback(t)},e}return ee(t,wv),J(t,[{key:"_callback",value:function(e){var t=cc.Event.EventMouse;switch(e.eventType){case t.DOWN:this.onMouseDown&&this.onMouseDown(e);break;case t.UP:this.onMouseUp&&this.onMouseUp(e);break;case t.MOVE:this.onMouseMove&&this.onMouseMove(e);break;case t.SCROLL:this.onMouseScroll&&this.onMouseScroll(e)}}},{key:"clone",value:function(){var e=new t;return e.onMouseDown=this.onMouseDown,e.onMouseUp=this.onMouseUp,e.onMouseMove=this.onMouseMove,e.onMouseScroll=this.onMouseScroll,e}},{key:"checkAvailable",value:function(){return!0}}]),t}(),Ov=function(e){function t(){var e;return Z(this,t),(e=re(this,te(t).call(this,wv.TOUCH_ONE_BY_ONE,Cv.TOUCH_ONE_BY_ONE,null))).swallowTouches=!1,e.onTouchBegan=null,e.onTouchMoved=null,e.onTouchEnded=null,e.onTouchCancelled=null,e._claimedTouches=[],e}return ee(t,wv),J(t,[{key:"setSwallowTouches",value:function(e){this.swallowTouches=e}},{key:"isSwallowTouches",value:function(){return this.swallowTouches}},{key:"clone",value:function(){var e=new t;return e.onTouchBegan=this.onTouchBegan,e.onTouchMoved=this.onTouchMoved,e.onTouchEnded=this.onTouchEnded,e.onTouchCancelled=this.onTouchCancelled,e.swallowTouches=this.swallowTouches,e}},{key:"checkAvailable",value:function(){return!!this.onTouchBegan||(cc.logID(1801),!1)}}]),t}(),kv=function(e){function t(){var e;return Z(this,t),(e=re(this,te(t).call(this,wv.TOUCH_ALL_AT_ONCE,Cv.TOUCH_ALL_AT_ONCE,null))).onTouchesBegan=null,e.onTouchesMoved=null,e.onTouchesEnded=null,e.onTouchesCancelled=null,e}return ee(t,wv),J(t,[{key:"clone",value:function(){var e=new t;return e.onTouchesBegan=this.onTouchesBegan,e.onTouchesMoved=this.onTouchesMoved,e.onTouchesEnded=this.onTouchesEnded,e.onTouchesCancelled=this.onTouchesCancelled,e}},{key:"checkAvailable",value:function(){return null!==this.onTouchesBegan||null!==this.onTouchesMoved||null!==this.onTouchesEnded||null!==this.onTouchesCancelled||(cc.logID(1802),!1)}}]),t}(),Rv=function(e){function t(e){var i;return Z(this,t),(i=re(this,te(t).call(this,wv.ACCELERATION,Cv.ACCELERATION,null)))._onAccelerationEvent=null,i._onEvent=function(e){return i._callback(e)},i._onAccelerationEvent=e,i}return ee(t,wv),J(t,[{key:"_callback",value:function(e){this._onAccelerationEvent&&this._onAccelerationEvent(e.acc,e)}},{key:"checkAvailable",value:function(){return cc.assertID(this._onAccelerationEvent,1803),!0}},{key:"clone",value:function(){return new t(this._onAccelerationEvent)}}]),t}(),Fv=function(e){function t(){var e;return Z(this,t),(e=re(this,te(t).call(this,wv.KEYBOARD,Cv.KEYBOARD,null))).onKeyPressed=null,e.onKeyReleased=null,e._onEvent=function(t){return e._callback(t)},e}return ee(t,wv),J(t,[{key:"_callback",value:function(e){e.isPressed?this.onKeyPressed&&this.onKeyPressed(e.keyCode,e):this.onKeyReleased&&this.onKeyReleased(e.keyCode,e)}},{key:"clone",value:function(){var e=new t;return e.onKeyPressed=this.onKeyPressed,e.onKeyReleased=this.onKeyReleased,e}},{key:"checkAvailable",value:function(){return null!==this.onKeyPressed||null!==this.onKeyReleased||(cc.logID(1800),!1)}}]),t}();cc.EventListener=wv;var Mv=wv.ListenerID;var Iv=function(){function e(){Z(this,e),this.gt0Index=0,this._fixedListeners=[],this._sceneGraphListeners=[]}return J(e,[{key:"size",value:function(){return this._fixedListeners.length+this._sceneGraphListeners.length}},{key:"empty",value:function(){return 0===this._fixedListeners.length&&0===this._sceneGraphListeners.length}},{key:"push",value:function(e){0===e._getFixedPriority()?this._sceneGraphListeners.push(e):this._fixedListeners.push(e)}},{key:"clearSceneGraphListeners",value:function(){this._sceneGraphListeners.length=0}},{key:"clearFixedListeners",value:function(){this._fixedListeners.length=0}},{key:"clear",value:function(){this._sceneGraphListeners.length=0,this._fixedListeners.length=0}},{key:"getFixedPriorityListeners",value:function(){return this._fixedListeners}},{key:"getSceneGraphPriorityListeners",value:function(){return this._sceneGraphListeners}}]),e}();var Pv=new(function(){function e(){Z(this,e),this._listenersMap={},this._priorityDirtyFlagMap={},this._nodeListenersMap={},this._toAddedListeners=[],this._toRemovedListeners=[],this._dirtyListeners=[],this._inDispatch=0,this._isEnabled=!1,this._internalCustomListenerIDs=[],this._currentTouch=null,this._currentTouchListener=null}return J(e,[{key:"pauseTarget",value:function(e){var t=arguments.length>1&&void 0!==arguments[1]&&arguments[1];if(e instanceof cc._BaseNode){var i=this._nodeListenersMap[e.uuid];if(i)for(var n=0;n<i.length;++n){var r=i[n];r._setPaused(!0)}if(!0===t){var a=e.children;if(a)for(var o=0;o<a.length;++o){var s=a[o];this.pauseTarget(s,!0)}}}else cc.warnID(3506)}},{key:"resumeTarget",value:function(e){var t=arguments.length>1&&void 0!==arguments[1]&&arguments[1];if(e instanceof cc._BaseNode){var i=this._nodeListenersMap[e.uuid];if(i)for(var n=0;n<i.length;++n){var r=i[n];r._setPaused(!1)}if(this._setDirtyForNode(e),!0===t&&e.children.length>0){var a=e.children;if(a)for(var o=0;o<a.length;++o){var s=a[o];this.resumeTarget(s,!0)}}}else cc.warnID(3506)}},{key:"frameUpdateListeners",value:function(){var e=this._listenersMap,t=this._priorityDirtyFlagMap;for(var i in e)e[i].empty()&&(delete t[i],delete e[i]);var n=this._toAddedListeners;if(0!==n.length){for(var r=0,a=n.length;r<a;r++)this._forceAddEventListener(n[r]);n.length=0}0!==this._toRemovedListeners.length&&this._cleanToRemovedListeners()}},{key:"hasEventListener",value:function(e){return!!this._getListeners(e)}},{key:"addListener",value:function(e,t){if(cc.assertID(e&&t,3503),cc.js.isNumber(t)||t instanceof cc._BaseNode){if(e instanceof cc.EventListener){if(e._isRegistered())return void cc.logID(3505)}else cc.assertID(!cc.js.isNumber(t),3504),e=cc.EventListener.create(e);if(e.checkAvailable()){if(cc.js.isNumber(t)){if(0===t)return void cc.logID(3500);e._setSceneGraphPriority(null),e._setFixedPriority(t),e._setRegistered(!0),e._setPaused(!1),this._addListener(e)}else{if(!(i=t)||!i.getComponent("cc.UITransformComponent"))return void cc.logID(3512);e._setSceneGraphPriority(t),e._setFixedPriority(0),e._setRegistered(!0),this._addListener(e)}var i;return e}}else cc.warnID(3506)}},{key:"addCustomListener",value:function(e,t){var i=wv.create({event:cc.EventListener.CUSTOM,eventName:e,callback:t});return this.addListener(i,1),i}},{key:"removeListener",value:function(e){if(null!=e){var t=!1,i=this._listenersMap;for(var n in i){var r=i[n],a=r.getFixedPriorityListeners(),o=r.getSceneGraphPriorityListeners();if((t=this._removeListenerInVector(o,e))?this._setDirty(e._getListenerID(),2):(t=this._removeListenerInVector(a,e))&&this._setDirty(e._getListenerID(),1),r.empty()&&(delete this._priorityDirtyFlagMap[e._getListenerID()],delete i[n]),t)break}if(!t)for(var s=this._toAddedListeners,l=s.length-1;l>=0;l--){var u=s[l];if(u===e){cc.js.array.removeAt(s,l),u._setRegistered(!1);break}}}}},{key:"removeListeners",value:function(e){var t=arguments.length>1&&void 0!==arguments[1]&&arguments[1];if(cc.js.isNumber(e)||e instanceof cc._BaseNode)if(void 0!==e._id){var i=this._nodeListenersMap[e._id];if(i){for(var n=cc.js.array.copy(i),r=0;r<n.length;++r){var a=n[r];this.removeListener(a)}delete this._nodeListenersMap[e._id]}for(var o=this._toAddedListeners,s=0;s<o.length;){var l=o[s];l._getSceneGraphPriority()===e?(l._setSceneGraphPriority(null),l._setRegistered(!1),o.splice(s,1)):++s}if(!0===t)for(var u=e.getChildren(),c=0;c<u.length;++c){var h=u[c];this.removeListeners(h,!0)}}else e===cc.EventListener.TOUCH_ONE_BY_ONE?this._removeListenersForListenerID(Mv.TOUCH_ONE_BY_ONE):e===cc.EventListener.TOUCH_ALL_AT_ONCE?this._removeListenersForListenerID(Mv.TOUCH_ALL_AT_ONCE):e===cc.EventListener.MOUSE?this._removeListenersForListenerID(Mv.MOUSE):e===cc.EventListener.ACCELERATION?this._removeListenersForListenerID(Mv.ACCELERATION):e===cc.EventListener.KEYBOARD?this._removeListenersForListenerID(Mv.KEYBOARD):cc.logID(3501);else cc.warnID(3506)}},{key:"removeCustomListeners",value:function(e){this._removeListenersForListenerID(e)}},{key:"removeAllListeners",value:function(){var e=this._listenersMap,t=this._internalCustomListenerIDs;for(var i in e)-1===t.indexOf(i)&&this._removeListenersForListenerID(i)}},{key:"setPriority",value:function(e,t){if(null!=e){var i=this._listenersMap;for(var n in i){var r=i[n].getFixedPriorityListeners();if(r)if(-1!==r.indexOf(e))return null!=e._getSceneGraphPriority()&&cc.logID(3502),void(e._getFixedPriority()!==t&&(e._setFixedPriority(t),this._setDirty(e._getListenerID(),1)))}}}},{key:"setEnabled",value:function(e){this._isEnabled=e}},{key:"isEnabled",value:function(){return this._isEnabled}},{key:"dispatchEvent",value:function(e){if(this._isEnabled)if(this._updateDirtyFlagForSceneGraph(),this._inDispatch++,e&&e.getType){if(e.getType().startsWith(cc.Event.TOUCH))return this._dispatchTouchEvent(e),void this._inDispatch--;var t=function(e){var t=al,i=e.type;return i===t.ACCELERATION?Mv.ACCELERATION:i===t.KEYBOARD?Mv.KEYBOARD:i.startsWith(t.MOUSE)?Mv.MOUSE:(i.startsWith(t.TOUCH)&&cc.logID(2e3),"")}(e);this._sortEventListeners(t);var i=this._listenersMap[t];null!=i&&(this._dispatchEventToListeners(i,this._onListenerCallback,e),this._onUpdateListeners(i)),this._inDispatch--}else cc.errorID(3511)}},{key:"_onListenerCallback",value:function(e,t){t.currentTarget=e._target;var i=e.onEvent;return i&&i(t),t.isStopped()}},{key:"dispatchCustomEvent",value:function(e,t){var i=new cc.Event.EventCustom(e);i.setUserData(t),this.dispatchEvent(i)}},{key:"_setDirtyForNode",value:function(e){var t=this._nodeListenersMap[e._id];if(void 0!==t)for(var i=0,n=t.length;i<n;i++){var r=t[i]._getListenerID();null==this._dirtyListeners[r]&&(this._dirtyListeners[r]=!0)}if(e.children.length>0)for(var a=e.children,o=0,s=a?a.length:0;o<s;o++)this._setDirtyForNode(a[o])}},{key:"_addListener",value:function(e){0===this._inDispatch?this._forceAddEventListener(e):this._toAddedListeners.push(e)}},{key:"_forceAddEventListener",value:function(e){var t=e._getListenerID(),i=this._listenersMap[t];if(i||(i=new Iv,this._listenersMap[t]=i),i.push(e),0===e._getFixedPriority()){this._setDirty(t,2);var n=e._getSceneGraphPriority();null===n&&cc.logID(3507),this._associateNodeAndEventListener(n,e),n.activeInHierarchy&&this.resumeTarget(n)}else this._setDirty(t,1)}},{key:"_getListeners",value:function(e){return this._listenersMap[e]}},{key:"_updateDirtyFlagForSceneGraph",value:function(){var e=this._dirtyListeners;for(var t in e)this._setDirty(t,2);this._dirtyListeners.length=0}},{key:"_removeAllListenersInVector",value:function(e){if(e)for(var t,i=e.length-1;i>=0;i--)(t=e[i])._setRegistered(!1),null!=t._getSceneGraphPriority()&&(this._dissociateNodeAndEventListener(t._getSceneGraphPriority(),t),t._setSceneGraphPriority(null)),0===this._inDispatch&&cc.js.array.removeAt(e,i)}},{key:"_removeListenersForListenerID",value:function(e){var t=this._listenersMap[e];if(t){var i=t.getFixedPriorityListeners(),n=t.getSceneGraphPriorityListeners();this._removeAllListenersInVector(n),this._removeAllListenersInVector(i),delete this._priorityDirtyFlagMap[e],this._inDispatch||(t.clear(),delete this._listenersMap[e])}for(var r=this._toAddedListeners,a=r.length-1;a>=0;a--){var o=r[a];o&&o._getListenerID()===e&&cc.js.array.removeAt(r,a)}}},{key:"_sortEventListeners",value:function(e){var t=0,i=this._priorityDirtyFlagMap;(i[e]&&(t=i[e]),0!==t)&&(i[e]=0,1&t&&this._sortListenersOfFixedPriority(e),2&t&&cc.director.getScene()&&this._sortListenersOfSceneGraphPriority(e))}},{key:"_sortListenersOfSceneGraphPriority",value:function(e){var t=this._getListeners(e);if(t){var i=t.getSceneGraphPriorityListeners();i&&0!==i.length&&t.getSceneGraphPriorityListeners().sort(this._sortEventListenersOfSceneGraphPriorityDes)}}},{key:"_sortEventListenersOfSceneGraphPriorityDes",value:function(e,t){var i=e._getSceneGraphPriority(),n=t._getSceneGraphPriority();if(!(t&&n&&n._activeInHierarchy&&n._uiProps.uiTransformComp))return-1;if(!(e&&i&&i._activeInHierarchy&&i._uiProps.uiTransformComp))return 1;var r=i,a=n,o=i._uiProps.uiTransformComp,s=n._uiProps.uiTransformComp,l=!1;if(o.visibility!==s.visibility)return s.visibility-o.visibility;for(;r.parent._id!==a.parent._id;)r=null===r.parent.parent?(l=!0)&&n:r.parent,a=null===a.parent.parent?(l=!0)&&i:a.parent;if(r._id===a._id){if(r._id===n._id)return-1;if(r._id===i._id)return 1}var u=r.getSiblingIndex(),c=a.getSiblingIndex();return l?u-c:c-u}},{key:"_sortListenersOfFixedPriority",value:function(e){var t=this._listenersMap[e];if(t){var i=t.getFixedPriorityListeners();if(i&&0!==i.length){i.sort(this._sortListenersOfFixedPriorityAsc);for(var n=0,r=i.length;n<r&&!(i[n]._getFixedPriority()>=0);)++n;t.gt0Index=n}}}},{key:"_sortListenersOfFixedPriorityAsc",value:function(e,t){return e._getFixedPriority()-t._getFixedPriority()}},{key:"_onUpdateListeners",value:function(e){var t=e.getFixedPriorityListeners(),i=e.getSceneGraphPriorityListeners(),n=this._toRemovedListeners;if(i)for(var r=i.length-1;r>=0;r--){var a=i[r];if(!a._isRegistered()){cc.js.array.removeAt(i,r);var o=n.indexOf(a);-1!==o&&n.splice(o,1)}}if(t)for(var s=t.length-1;s>=0;s--){var l=t[s];if(!l._isRegistered()){cc.js.array.removeAt(t,s);var u=n.indexOf(l);-1!==u&&n.splice(u,1)}}i&&0===i.length&&e.clearSceneGraphListeners(),t&&0===t.length&&e.clearFixedListeners()}},{key:"_updateTouchListeners",value:function(e){var t=this._inDispatch;if(cc.assertID(t>0,3508),!(t>1)){var i;(i=this._listenersMap[Mv.TOUCH_ONE_BY_ONE])&&this._onUpdateListeners(i),(i=this._listenersMap[Mv.TOUCH_ALL_AT_ONCE])&&this._onUpdateListeners(i),cc.assertID(1===t,3509);var n=this._toAddedListeners;if(0!==n.length){for(var r=0,a=n.length;r<a;r++)this._forceAddEventListener(n[r]);this._toAddedListeners.length=0}0!==this._toRemovedListeners.length&&this._cleanToRemovedListeners()}}},{key:"_cleanToRemovedListeners",value:function(){for(var e=this._toRemovedListeners,t=0;t<e.length;++t){var i=e[t],n=this._listenersMap[i._getListenerID()];if(n){var r=n.getFixedPriorityListeners(),a=n.getSceneGraphPriorityListeners();if(a){var o=a.indexOf(i);-1!==o&&a.splice(o,1)}if(r){var s=r.indexOf(i);-1!==s&&r.splice(s,1)}}}e.length=0}},{key:"_onTouchEventCallback",value:function(e,t){if(!e._isRegistered())return!1;var i=t.event,n=i.touch;i.currentTarget=e._getSceneGraphPriority();var r=!1,a=-1,o=i.getEventCode();if(o===Tv.BEGAN){if(!cu.ENABLE_MULTI_TOUCH&&Pv._currentTouch){var s=Pv._currentTouchListener._node;if(!s||s.activeInHierarchy)return!1}e.onTouchBegan&&(r=e.onTouchBegan(n,i))&&e._isRegistered()&&(e._claimedTouches.push(n),Pv._currentTouch=n,Pv._currentTouchListener=e)}else if(e._claimedTouches.length>0&&-1!==(a=e._claimedTouches.indexOf(n))){if(r=!0,!cu.ENABLE_MULTI_TOUCH&&Pv._currentTouch&&Pv._currentTouch!==n)return!1;o===Tv.MOVED&&e.onTouchMoved?e.onTouchMoved(n,i):o===Tv.ENDED?(e.onTouchEnded&&e.onTouchEnded(n,i),e._isRegistered()&&e._claimedTouches.splice(a,1),Pv._currentTouch=null,Pv._currentTouchListener=null):o===Tv.CANCELLED&&(e.onTouchCancelled&&e.onTouchCancelled(n,i),e._isRegistered()&&e._claimedTouches.splice(a,1),Pv._currentTouch=null,Pv._currentTouchListener=null)}return i.isStopped()?(Pv._updateTouchListeners(i),!0):!!(r&&e._isRegistered()&&e.swallowTouches)&&(t.needsMutableSet&&t.touches.splice(n,1),!0)}},{key:"_dispatchTouchEvent",value:function(e){this._sortEventListeners(Mv.TOUCH_ONE_BY_ONE),this._sortEventListeners(Mv.TOUCH_ALL_AT_ONCE);var t=this._getListeners(Mv.TOUCH_ONE_BY_ONE),i=this._getListeners(Mv.TOUCH_ALL_AT_ONCE);if(null!==t||null!==i){var n=e.getTouches(),r=cc.js.array.copy(n),a={event:e,needsMutableSet:t&&i,touches:r,selTouch:null};if(t)for(var o=0;o<n.length;++o){var s=n[o];e.touch=s,e.propagationStopped=e.propagationImmediateStopped=!1,this._dispatchEventToListeners(t,this._onTouchEventCallback,a)}i&&r.length>0&&(this._dispatchEventToListeners(i,this._onTouchesEventCallback,{event:e,touches:r}),e.isStopped())||this._updateTouchListeners(e)}}},{key:"_onTouchesEventCallback",value:function(e,t){if(!e._isRegistered())return!1;var i=t.event,n=t.touches,r=i.getEventCode();return i.currentTarget=e._getSceneGraphPriority(),r===Tv.BEGAN&&e.onTouchesBegan?e.onTouchesBegan(n,i):r===Tv.MOVED&&e.onTouchesMoved?e.onTouchesMoved(n,i):r===Tv.ENDED&&e.onTouchesEnded?e.onTouchesEnded(n,i):r===Tv.CANCELLED&&e.onTouchesCancelled&&e.onTouchesCancelled(n,i),!!i.isStopped()&&(Pv._updateTouchListeners(i),!0)}},{key:"_associateNodeAndEventListener",value:function(e,t){var i=this._nodeListenersMap[e.uuid];i||(i=[],this._nodeListenersMap[e.uuid]=i),i.push(t)}},{key:"_dissociateNodeAndEventListener",value:function(e,t){var i=this._nodeListenersMap[e.uuid];i&&(cc.js.array.remove(i,t),0===i.length&&delete this._nodeListenersMap[e.uuid])}},{key:"_dispatchEventToListeners",value:function(e,t,i){var n=!1,r=e.getFixedPriorityListeners(),a=e.getSceneGraphPriorityListeners(),o=0;if(r&&0!==r.length)for(;o<e.gt0Index;++o){var s=r[o];if(s.isEnabled()&&!s._isPaused()&&s._isRegistered()&&t(s,i)){n=!0;break}}if(a&&!n)for(var l=0;l<a.length;++l){var u=a[l];if(u.isEnabled()&&!u._isPaused()&&u._isRegistered()&&t(u,i)){n=!0;break}}if(r&&!n)for(;o<r.length;++o){var c=r[o];if(c.isEnabled()&&!c._isPaused()&&c._isRegistered()&&t(c,i)){n=!0;break}}}},{key:"_setDirty",value:function(e,t){var i=this._priorityDirtyFlagMap;null==i[e]?i[e]=t:i[e]=t|i[e]}},{key:"_sortNumberAsc",value:function(e,t){return e-t}},{key:"_removeListenerInCallback",value:function(e,t){if(null==e)return!1;for(var i=e.length-1;i>=0;i--){var n=e[i];if(n._onCustomEvent===t||n.onEvent===t)return n._setRegistered(!1),null!=n._getSceneGraphPriority()&&(this._dissociateNodeAndEventListener(n._getSceneGraphPriority(),n),n._setSceneGraphPriority(null)),0===this._inDispatch?cc.js.array.removeAt(e,i):this._toRemovedListeners.push(n),!0}return!1}},{key:"_removeListenerInVector",value:function(e,t){if(null==e)return!1;for(var i=e.length-1;i>=0;i--){var n=e[i];if(n===t)return n._setRegistered(!1),null!=n._getSceneGraphPriority()&&(this._dissociateNodeAndEventListener(n._getSceneGraphPriority(),n),n._setSceneGraphPriority(null)),0===this._inDispatch?cc.js.array.removeAt(e,i):this._toRemovedListeners.push(n),!0}return!1}}]),e}());cc.eventManager=Pv;var Lv=new Array(16),Dv=null,Nv=new ki,zv=[exports.SystemEventType.TOUCH_START.toString(),exports.SystemEventType.TOUCH_MOVE.toString(),exports.SystemEventType.TOUCH_END.toString(),exports.SystemEventType.TOUCH_CANCEL.toString()],Bv=[exports.SystemEventType.MOUSE_DOWN.toString(),exports.SystemEventType.MOUSE_ENTER.toString(),exports.SystemEventType.MOUSE_MOVE.toString(),exports.SystemEventType.MOUSE_LEAVE.toString(),exports.SystemEventType.MOUSE_UP.toString(),exports.SystemEventType.MOUSE_WHEEL.toString()];function Gv(e,t){var i=this.owner;return!(!i||!i._uiProps.uiTransformComp)&&(e.getUILocation(Nv),!!i._uiProps.uiTransformComp.isHit(Nv,this)&&(t.type=exports.SystemEventType.TOUCH_START.toString(),t.touch=e,t.bubbles=!0,i.dispatchEvent(t),!0))}function Uv(e,t){var i=this.owner;if(!i||!i._uiProps.uiTransformComp)return!1;t.type=exports.SystemEventType.TOUCH_MOVE.toString(),t.touch=e,t.bubbles=!0,i.dispatchEvent(t)}function Xv(e,t){var i=this.owner;i&&i._uiProps.uiTransformComp&&(e.getUILocation(Nv),i._uiProps.uiTransformComp.isHit(Nv,this)?t.type=exports.SystemEventType.TOUCH_END.toString():t.type=exports.SystemEventType.TOUCH_CANCEL.toString(),t.touch=e,t.bubbles=!0,i.dispatchEvent(t))}function Vv(e,t){var i=this.owner;i&&i._uiProps.uiTransformComp&&(t.type=exports.SystemEventType.TOUCH_CANCEL.toString(),t.touch=e,t.bubbles=!0,i.dispatchEvent(t))}function Hv(e){var t=this.owner;t&&t._uiProps.uiTransformComp&&(Nv=e.getUILocation(),t._uiProps.uiTransformComp.isHit(Nv,this)&&(e.type=exports.SystemEventType.MOUSE_DOWN.toString(),e.bubbles=!0,t.dispatchEvent(e)))}function Wv(e){var t=this.owner;if(t&&t._uiProps.uiTransformComp){if(Nv=e.getUILocation(),t._uiProps.uiTransformComp.isHit(Nv,this))this._previousIn||(Dv&&Dv.eventProcessor.mouseListener&&(e.type=exports.SystemEventType.MOUSE_LEAVE,Dv.dispatchEvent(e),Dv.eventProcessor.mouseListener&&(Dv.eventProcessor.mouseListener._previousIn=!1)),Dv=t,e.type=exports.SystemEventType.MOUSE_ENTER.toString(),t.dispatchEvent(e),this._previousIn=!0),e.type=exports.SystemEventType.MOUSE_MOVE.toString(),e.bubbles=!0,t.dispatchEvent(e);else{if(!this._previousIn)return;e.type=exports.SystemEventType.MOUSE_LEAVE.toString(),t.dispatchEvent(e),this._previousIn=!1,Dv=null}e.propagationStopped=!0}}function jv(e){var t=this.owner;t&&t._uiProps.uiTransformComp&&(Nv=e.getUILocation(),t._uiProps.uiTransformComp.isHit(Nv,this)&&(e.type=exports.SystemEventType.MOUSE_UP.toString(),e.bubbles=!0,t.dispatchEvent(e),e.propagationStopped=!0))}function qv(e){var t=this.owner;t&&t._uiProps.uiTransformComp&&(Nv=e.getUILocation(),t._uiProps.uiTransformComp.isHit(Nv,this)&&(e.type=exports.SystemEventType.MOUSE_WHEEL.toString(),e.bubbles=!0,t.dispatchEvent(e),e.propagationStopped=!0))}function Yv(e){var t=cc.MaskComponent;if(t)for(var i=0,n=e;n&&cc.Node.isNode(n);n=n.parent,++i)if(n.getComponent(t))return{index:i,node:n};return null}function Kv(e,t){if(!e._persistNode){if(e.eventProcessor.bubblingTargets)for(var i=0;i<t.length;++i)if(e.eventProcessor.bubblingTargets.hasEventListener(t[i]))return!0;if(e.eventProcessor.capturingTargets)for(var n=0;n<t.length;++n)if(e.eventProcessor.capturingTargets.hasEventListener(t[n]))return!0;return!1}return!0}var Zv=function(){function e(t){Z(this,e),this.bubblingTargets=null,this.capturingTargets=null,this.touchListener=null,this.mouseListener=null,this._node=void 0,this._node=t}return J(e,[{key:"node",get:function(){return this._node}}]),J(e,[{key:"reattach",value:function(){if(this.touchListener){var e=this.touchListener.mask=Yv(this._node);this.mouseListener&&(this.mouseListener.mask=e)}else this.mouseListener&&(this.mouseListener.mask=Yv(this._node))}},{key:"destroy",value:function(){Dv===this._node&&(Dv=null),(this.touchListener||this.mouseListener)&&(Pv.removeListeners(this._node),this.touchListener&&(this.touchListener.owner=null,this.touchListener.mask=null,this.touchListener=null),this.mouseListener&&(this.mouseListener.owner=null,this.mouseListener.mask=null,this.mouseListener=null)),this.capturingTargets&&this.capturingTargets.clear(),this.bubblingTargets&&this.bubblingTargets.clear()}},{key:"on",value:function(e,t,i,n){return this._checknSetupSysEvent(e)?this._onDispatch(e,t,i,n):(this.bubblingTargets||(this.bubblingTargets=new ml),this.bubblingTargets.on(e,t,i))}},{key:"once",value:function(e,t,i,n){var r,a=this;(r=this._checknSetupSysEvent(e)&&n?this.capturingTargets=this.capturingTargets||new ml:this.bubblingTargets=this.bubblingTargets||new ml).on(e,t,i,!0),r.on(e,(function(){a.off(e,t,i)}),void 0,!0)}},{key:"off",value:function(e,t,i,n){var r=-1!==zv.indexOf(e),a=!r&&-1!==Bv.indexOf(e);r||a?(this._offDispatch(e,t,i,n),r?this.touchListener&&!Kv(this._node,zv)&&(Pv.removeListener(this.touchListener),this.touchListener=null):a&&this.mouseListener&&!Kv(this._node,Bv)&&(Pv.removeListener(this.mouseListener),this.mouseListener=null)):this.bubblingTargets&&this.bubblingTargets.off(e,t,i)}},{key:"emit",value:function(e,t,i,n,r,a){this.bubblingTargets&&this.bubblingTargets.emit(e,t,i,n,r,a)}},{key:"dispatchEvent",value:function(e){!function(e,t){var i,n=0;for(t.target=e,Lv.length=0,e.eventProcessor.getCapturingTargets(t.type,Lv),t.eventPhase=1,n=Lv.length-1;n>=0;--n)if((i=Lv[n]).eventProcessor.capturingTargets&&(t.currentTarget=i,i.eventProcessor.capturingTargets.emit(t.type,t,Lv),t.propagationStopped))return void(Lv.length=0);if(Lv.length=0,t.eventPhase=2,t.currentTarget=e,e.eventProcessor.capturingTargets&&e.eventProcessor.capturingTargets.emit(t.type,t),!t.propagationImmediateStopped&&e.eventProcessor.bubblingTargets&&e.eventProcessor.bubblingTargets.emit(t.type,t),!t.propagationStopped&&t.bubbles)for(e.eventProcessor.getBubblingTargets(t.type,Lv),t.eventPhase=3,n=0;n<Lv.length;++n)if((i=Lv[n]).eventProcessor.bubblingTargets&&(t.currentTarget=i,i.eventProcessor.bubblingTargets.emit(t.type,t),t.propagationStopped))return void(Lv.length=0);Lv.length=0}(this._node,e),Lv.length=0}},{key:"hasEventListener",value:function(e,t,i){var n=!1;return this.bubblingTargets&&(n=this.bubblingTargets.hasEventListener(e,t,i)),!n&&this.capturingTargets&&(n=this.capturingTargets.hasEventListener(e,t,i)),n}},{key:"targetOff",value:function(e){this.capturingTargets&&this.capturingTargets.removeAll(e),this.bubblingTargets&&this.bubblingTargets.removeAll(e),this.touchListener&&!Kv(this.node,zv)&&(Pv.removeListener(this.touchListener),this.touchListener=null),this.mouseListener&&!Kv(this.node,Bv)&&(Pv.removeListener(this.mouseListener),this.mouseListener=null)}},{key:"getCapturingTargets",value:function(e,t){for(var i=this._node.parent;i;)i.eventProcessor.capturingTargets&&i.eventProcessor.capturingTargets.hasEventListener(e)&&t.push(i),i=i.parent}},{key:"getBubblingTargets",value:function(e,t){for(var i=this._node.parent;i;)i.eventProcessor.bubblingTargets&&i.eventProcessor.bubblingTargets.hasEventListener(e)&&t.push(i),i=i.parent}},{key:"_checknSetupSysEvent",value:function(e){var t=this,i=!1,n=!1;return-1!==zv.indexOf(e)?(this.touchListener||(this.touchListener=cc.EventListener.create({event:cc.EventListener.TOUCH_ONE_BY_ONE,swallowTouches:!0,owner:this._node,mask:Yv(this._node),onTouchBegan:Gv,onTouchMoved:Uv,onTouchEnded:Xv,onTouchCancelled:Vv}),Pv.addListener(this.touchListener,this._node),i=!0),n=!0):-1!==Bv.indexOf(e)&&(this.mouseListener||(this.mouseListener=cc.EventListener.create({event:cc.EventListener.MOUSE,_previousIn:!1,owner:this._node,mask:Yv(this._node),onMouseDown:Hv,onMouseMove:Wv,onMouseUp:jv,onMouseScroll:qv}),Pv.addListener(this.mouseListener,this._node),i=!0),n=!0),i&&!this._node.activeInHierarchy&&cc.director.getScheduler().schedule((function(){t._node.activeInHierarchy||Pv.pauseTarget(t._node)}),this._node,0,0,0,!1),n}},{key:"_onDispatch",value:function(e,t,i,n){if("boolean"==typeof i?(n=i,i=void 0):n=!!n,t){var r=null;return(r=n?this.capturingTargets=this.capturingTargets||new ml:this.bubblingTargets=this.bubblingTargets||new ml).hasEventListener(e,t,i)||r.on(e,t,i),t}cc.errorID(6800)}},{key:"_offDispatch",value:function(e,t,i,n){if("boolean"==typeof i?(n=i,i=void 0):n=!!n,t){var r=n?this.capturingTargets:this.bubblingTargets;r&&r.off(e,t,i)}else this.capturingTargets&&this.capturingTargets.removeAll(e),this.bubblingTargets&&this.bubblingTargets.removeAll(e)}}]),e}();cc.NodeEventProcessor=Zv;sl.Flags.Destroying;var Qv,Jv,$v,ey,ty,iy,ny,ry,ay,oy=sl.Flags.Destroying,sy=sl.Flags.DontDestroy,ly=sl.Flags.Deactivating,uy=(sl.Flags.Activating,new be("Node"));function cy(e){return e?"string"==typeof e?Je(e):e:(b(3804),null)}var hy,py,_y,fy,dy,my,vy,yy,gy,xy,by,Ty,Sy,Ey,wy=Yo("cc.BaseNode")((ay=ry=function(e){function t(e){var i;return Z(this,t),fe(i=re(this,te(t).call(this,e)),"_parent",$v,ne(i)),fe(i,"_children",ey,ne(i)),fe(i,"_active",ty,ne(i)),fe(i,"_components",iy,ne(i)),fe(i,"_prefab",ny,ne(i)),i._scene=null,i._activeInHierarchy=!1,i._id=uy.getNewId(),i._name=void 0,i._eventProcessor=new Zv(ne(i)),i._eventMask=0,i._siblingIndex=0,i._registerIfAttached=void 0,i._name=void 0!==e?e:"New Node",i}return ee(t,sl),J(t,[{key:"components",get:function(){return this._components}},{key:"_persistNode",get:function(){return(this._objFlags&sy)>0},set:function(e){e?this._objFlags|=sy:this._objFlags&=~sy}},{key:"name",get:function(){return this._name},set:function(e){this._name=e}},{key:"uuid",get:function(){return this._id}},{key:"children",get:function(){return this._children}},{key:"active",get:function(){return this._active},set:function(e){if(this._active!==e){this._active=e;var t=this._parent;if(t)t._activeInHierarchy&&cc.director._nodeActivator.activateNode(this,e)}}},{key:"activeInHierarchy",get:function(){return this._activeInHierarchy}},{key:"parent",get:function(){return this._parent},set:function(e){this.setParent(e)}},{key:"scene",get:function(){return this._scene}},{key:"eventProcessor",get:function(){return this._eventProcessor}}],[{key:"_setScene",value:function(e){e instanceof cc.Scene?e._scene=e:null==e._parent?cc.error("Node %s(%s) has not attached to a scene.",e.name,e.uuid):e._scene=e._parent._scene}},{key:"_findComponent",value:function(e,t){var i=t,n=e._components;if(i._sealed)for(var r=0;r<n.length;++r){var a=n[r];if(a.constructor===t)return a}else for(var o=0;o<n.length;++o){var s=n[o];if(s instanceof t)return s}return null}},{key:"_findComponents",value:function(e,t,i){var n=t,r=e._components;if(n._sealed)for(var a=0;a<r.length;++a){var o=r[a];o.constructor===t&&i.push(o)}else for(var s=0;s<r.length;++s){var l=r[s];l instanceof t&&i.push(l)}}},{key:"_findChildComponent",value:function(e,i){for(var n=0;n<e.length;++n){var r=e[n],a=t._findComponent(r,i);if(a)return a;if(r._children.length>0&&(a=t._findChildComponent(r._children,i)))return a}return null}},{key:"_findChildComponents",value:function(e,i,n){for(var r=0;r<e.length;++r){var a=e[r];t._findComponents(a,i,n),a._children.length>0&&t._findChildComponents(a._children,i,n)}}}]),J(t,[{key:"attr",value:function(e){Ue(this,e)}},{key:"getParent",value:function(){return this._parent}},{key:"setParent",value:function(e){var t=arguments.length>1&&void 0!==arguments[1]&&arguments[1];if(this._parent!==e){var i=this._parent,n=e;if(this._parent=n,this._siblingIndex=0,this._onSetParent(i,t),this.emit&&this.emit(exports.SystemEventType.PARENT_CHANGED,i),n&&(n._children.push(this),this._siblingIndex=n._children.length-1,n.emit&&n.emit(exports.SystemEventType.CHILD_ADDED,this)),i&&!(i._objFlags&oy)){var r=i._children.indexOf(this);i._children.splice(r,1),i._updateSiblingIndex(),i.emit&&i.emit(exports.SystemEventType.CHILD_REMOVED,this)}this._onHierarchyChanged(i)}}},{key:"getChildByUuid",value:function(e){if(!e)return cc.log("Invalid uuid"),null;for(var t=this._children,i=0,n=t.length;i<n;i++)if(t[i]._id===e)return t[i];return null}},{key:"getChildByName",value:function(e){if(!e)return cc.log("Invalid name"),null;for(var t=this._children,i=0,n=t.length;i<n;i++)if(t[i]._name===e)return t[i];return null}},{key:"getChildByPath",value:function(e){for(var t=e.split("/"),i=this,n=function(e){var n=t[e];if(0===n.length)return"continue";var r=i.children.find((function(e){return e.name===n}));if(!r)return{v:null};i=r},r=0;r<t.length;++r){var a=n(r);switch(a){case"continue":continue;default:if("object"===K(a))return a.v}}return i}},{key:"addChild",value:function(e){cc.assertID(e,1606),cc.assertID(null===e._parent,1605),e.setParent(this)}},{key:"insertChild",value:function(e,t){e.parent=this,e.setSiblingIndex(t)}},{key:"getSiblingIndex",value:function(){return this._siblingIndex}},{key:"setSiblingIndex",value:function(e){if(this._parent)if(this._parent._objFlags&ly)b(3821);else{var t=this._parent._children;e=-1!==e?e:t.length-1;var i=t.indexOf(this);e!==i&&(t.splice(i,1),e<t.length?t.splice(e,0,this):t.push(this),this._parent._updateSiblingIndex(),this._onSiblingIndexChanged&&this._onSiblingIndexChanged(e))}}},{key:"walk",value:function(e,i){var n=1,r=null,a=null,o=0,s=t._stacks[t._stackId];s||(s=[],t._stacks.push(s)),t._stackId++,s.length=0,s[0]=this;for(var l=null,u=!1;n;)if(a=s[--n])if(!u&&e?e(a):u&&i&&i(a),s[n]=null,u){if(u=!1,r)if(r[++o])s[n]=r[o],n++;else if(l&&(s[n]=l,n++,u=!0,l._parent?(o=(r=l._parent._children).indexOf(l),l=l._parent):(l=null,r=null),o<0))break}else a._children.length>0?(l=a,r=a._children,o=0,s[n]=r[o],n++):(s[n]=a,n++,u=!0);s.length=0,t._stackId--}},{key:"removeFromParent",value:function(){this._parent&&this._parent.removeChild(this)}},{key:"removeChild",value:function(e){this._children.indexOf(e)>-1&&(e.parent=null)}},{key:"removeAllChildren",value:function(){for(var e=this._children,t=e.length-1;t>=0;t--){var i=e[t];i&&(i.parent=null)}this._children.length=0}},{key:"isChildOf",value:function(e){var t=this;do{if(t===e)return!0;t=t._parent}while(t);return!1}},{key:"getComponent",value:function(e){var i=cy(e);return i?t._findComponent(this,i):null}},{key:"getComponents",value:function(e){var i=cy(e),n=[];return i&&t._findComponents(this,i,n),n}},{key:"getComponentInChildren",value:function(e){var i=cy(e);return i?t._findChildComponent(this._children,i):null}},{key:"getComponentsInChildren",value:function(e){var i=cy(e),n=[];return i&&(t._findComponents(this,i,n),t._findChildComponents(this._children,i,n)),n}},{key:"addComponent",value:function(e){var t;if("string"==typeof e){if(!(t=Je(e)))return b(3807,e),cc._RF.peek()&&b(3808,e),null}else{if(!e)return b(3804),null;t=e}if("function"!=typeof t)return b(3809),null;if(!He(t,cc.Component))return b(3810),null;var i=t._requireComponent;if(i&&!this.getComponent(i)&&!this.addComponent(i))return null;var n=new t;return n.node=this,this._components.push(n),this._activeInHierarchy&&cc.director._nodeActivator.activateComp(n),n}},{key:"removeComponent",value:function(e){if(e){var t=null;(t=e instanceof rp?e:this.getComponent(e))&&t.destroy()}else b(3813)}},{key:"on",value:function(e,t,i){var n=arguments.length>3&&void 0!==arguments[3]&&arguments[3];switch(e){case exports.SystemEventType.TRANSFORM_CHANGED:this._eventMask|=1}this._eventProcessor.on(e,t,i,n)}},{key:"off",value:function(e,t,i){var n=arguments.length>3&&void 0!==arguments[3]&&arguments[3];this._eventProcessor.off(e,t,i,n);var r=this._eventProcessor.hasEventListener(e);if(!r)switch(e){case exports.SystemEventType.TRANSFORM_CHANGED:this._eventMask&=-2}}},{key:"once",value:function(e,t,i,n){this._eventProcessor.once(e,t,i,n)}},{key:"emit",value:function(e,t,i,n,r,a){this._eventProcessor.emit(e,t,i,n,r,a)}},{key:"dispatchEvent",value:function(e){this._eventProcessor.dispatchEvent(e)}},{key:"hasEventListener",value:function(e,t,i){return this._eventProcessor.hasEventListener(e,t,i)}},{key:"targetOff",value:function(e){this._eventProcessor.targetOff(e),1&this._eventMask&&!this._eventProcessor.hasEventListener(exports.SystemEventType.TRANSFORM_CHANGED)&&(this._eventMask&=-2)}},{key:"destroy",value:function(){return!!oe(te(t.prototype),"destroy",this).call(this)&&(this._activeInHierarchy&&this._disableChildComps(),!0)}},{key:"destroyAllChildren",value:function(){for(var e=this._children,t=0;t<e.length;++t)e[t].destroy()}},{key:"_removeComponent",value:function(e){if(e){if(!(this._objFlags&oy)){var t=this._components.indexOf(e);-1!==t?this._components.splice(t,1):e.node!==this&&b(3815)}}else b(3814)}},{key:"_updateSiblingIndex",value:function(){for(var e=0;e<this._children.length;++e)this._children[e]._siblingIndex=e}},{key:"_onSetParent",value:function(e){this._parent&&(null!=e&&e._scene===this._parent._scene||null==this._parent._scene||this.walk((function(e){t._setScene(e)})))}},{key:"_onPostActivated",value:function(e){}},{key:"_onBatchRestored",value:function(){}},{key:"_onBatchCreated",value:function(){this._parent&&(this._siblingIndex=this._parent.children.indexOf(this))}},{key:"_onPreDestroy",value:function(){this._onPreDestroyBase()}},{key:"_onHierarchyChanged",value:function(e){return this._onHierarchyChangedBase(e)}},{key:"_instantiate",value:function(e){e||(e=cc.instantiate._clone(this,this));var t=this._prefab;t&&this===t.root&&t.sync;return e._parent=null,e._onBatchRestored(),e}},{key:"_onHierarchyChangedBase",value:function(e){var t=this._parent;!this._persistNode||t instanceof cc.Scene||cc.game.removePersistRootNode(this);var i=this._active&&!(!t||!t._activeInHierarchy);this._activeInHierarchy!==i&&cc.director._nodeActivator.activateNode(this,i)}},{key:"_onPreDestroyBase",value:function(){this._objFlags|=oy;var e=this._parent,t=!!e&&0!=(e._objFlags&oy);if(this._persistNode&&cc.game.removePersistRootNode(this),!t&&e){this.emit(exports.SystemEventType.PARENT_CHANGED,this);var i=e._children.indexOf(this);e._children.splice(i,1),this._siblingIndex=0,e.emit&&e.emit(exports.SystemEventType.CHILD_REMOVED,this)}this.emit(exports.SystemEventType.NODE_DESTROYED,this),this._eventProcessor.destroy();for(var n=this._children,r=0;r<n.length;++r)n[r]._destroyImmediate();for(var a=this._components,o=0;o<a.length;++o)a[o]._destroyImmediate();return t}},{key:"_disableChildComps",value:function(){for(var e=this._components,t=0;t<e.length;++t){var i=e[t];i._enabled&&cc.director._compScheduler.disableComp(i)}for(var n=this._children,r=0;r<n.length;++r){var a=n[r];a._active&&a._disableChildComps()}}}]),t}(),ry.idGenerator=uy,ry._stacks=[[]],ry._stackId=0,de((Jv=ay).prototype,"_persistNode",[Ko],Object.getOwnPropertyDescriptor(Jv.prototype,"_persistNode"),Jv.prototype),de(Jv.prototype,"name",[Ko],Object.getOwnPropertyDescriptor(Jv.prototype,"name"),Jv.prototype),de(Jv.prototype,"uuid",[Ko],Object.getOwnPropertyDescriptor(Jv.prototype,"uuid"),Jv.prototype),de(Jv.prototype,"children",[Ko],Object.getOwnPropertyDescriptor(Jv.prototype,"children"),Jv.prototype),de(Jv.prototype,"active",[Ko],Object.getOwnPropertyDescriptor(Jv.prototype,"active"),Jv.prototype),de(Jv.prototype,"activeInHierarchy",[Ko],Object.getOwnPropertyDescriptor(Jv.prototype,"activeInHierarchy"),Jv.prototype),de(Jv.prototype,"parent",[Ko],Object.getOwnPropertyDescriptor(Jv.prototype,"parent"),Jv.prototype),$v=de(Jv.prototype,"_parent",[Ko],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return null}}),ey=de(Jv.prototype,"_children",[Ko],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return[]}}),ty=de(Jv.prototype,"_active",[Ko],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return!0}}),iy=de(Jv.prototype,"_components",[Ko],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return[]}}),ny=de(Jv.prototype,"_prefab",[Ko],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return null}}),Qv=Jv))||Qv;cc._BaseNode=wy;var Cy=new ki,Ay=new ki,Oy=new Ki,ky=new Ki,Ry=new Ki,Fy=new Ki(0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0),My=new nn,Iy=(hy=Yo("cc.UITransformComponent"),py=os("i18n:cc.UITransformComponent"),_y=ts(110),fy=es("UI/UITransform"),dy=Ko({displayOrder:0,tooltip:"内容尺寸"}),my=Ko({displayOrder:1,tooltip:"锚点位置"}),vy=Ko({tooltip:"渲染排序优先级"}),hy(yy=py(yy=_y(yy=fy(yy=Jo((Ey=Sy=function(e){function t(){var e,i;Z(this,t);for(var n=arguments.length,r=new Array(n),a=0;a<n;a++)r[a]=arguments[a];return fe(i=re(this,(e=te(t)).call.apply(e,[this].concat(r))),"_priority",xy,ne(i)),i._canvas=null,fe(i,"_contentSize",by,ne(i)),fe(i,"_anchorPoint",Ty,ne(i)),i}return ee(t,rp),J(t,[{key:"__preload",value:function(){this.node._uiProps.uiTransformComp=this}},{key:"onEnable",value:function(){this._updateVisibility(),this.node.on(exports.SystemEventType.PARENT_CHANGED,this._parentChanged,this),this._sortSiblings()}},{key:"onDisable",value:function(){this.node.off(exports.SystemEventType.PARENT_CHANGED,this._parentChanged,this),this._canvas=null}},{key:"onDestroy",value:function(){this.node._uiProps.uiTransformComp=null}},{key:"setContentSize",value:function(e,t){var i=this._contentSize;if(void 0===t){if((e=e).width===i.width&&e.height===i.height)return;i.width=e.width,i.height=e.height}else{if(e===i.width&&t===i.height)return;i.width=e,i.height=t}this.node.emit(exports.SystemEventType.SIZE_CHANGED)}},{key:"setAnchorPoint",value:function(e,t){var i=this._anchorPoint;if(void 0===t){if((e=e).x===i.x&&e.y===i.y)return;i.x=e.x,i.y=e.y}else{if(e===i.x&&t===i.y)return;i.x=e,i.y=t}this.node.emit(exports.SystemEventType.ANCHOR_CHANGED,this._anchorPoint)}},{key:"isHit",value:function(e,t){var i=this._contentSize.width,n=this._contentSize.height,r=Cy,a=Ay,o=this._canvas;if(o){o.node.getWorldRT(Oy);var s=Oy.m12,l=Oy.m13,u=cc.visibleRect.center;if(Oy.m12=u.x-(Oy.m00*s+Oy.m04*l),Oy.m13=u.y-(Oy.m01*s+Oy.m05*l),Ki.invert(Oy,Oy),ki.transformMat4(r,e,Oy),this.node.getWorldMatrix(Ry),Ki.invert(Oy,Ry),Ki.strictEquals(Oy,Fy))return!1;if(ki.transformMat4(a,r,Oy),a.x+=this._anchorPoint.x*i,a.y+=this._anchorPoint.y*n,a.x>=0&&a.y>=0&&a.x<=i&&a.y<=n){if(t&&t.mask){for(var c=t.mask,h=this.node,p=0;h&&p<c.index;++p,h=h.parent);if(h===c.node){var _=h.getComponent(cc.MaskComponent);return!_||!_.enabledInHierarchy||_.isHit(r)}return t.mask=null,!0}return!0}return!1}}},{key:"convertToNodeSpaceAR",value:function(e,t){return this.node.getWorldMatrix(Ry),Ki.invert(Oy,Ry),t||(t=new Ii),Ii.transformMat4(t,e,Oy)}},{key:"convertToWorldSpaceAR",value:function(e,t){return this.node.getWorldMatrix(Ry),t||(t=new Ii),Ii.transformMat4(t,e,Ry)}},{key:"getBoundingBox",value:function(){Ki.fromRTS(ky,this.node.getRotation(),this.node.getPosition(),this.node.getScale());var e=this._contentSize.width,t=this._contentSize.height,i=new nn(-this._anchorPoint.x*e,-this._anchorPoint.y*t,e,t);return i.transformMat4(ky),i}},{key:"getBoundingBoxToWorld",value:function(){return this.node.parent?(this.node.parent.getWorldMatrix(Ry),this.getBoundingBoxTo(Ry)):this.getBoundingBox()}},{key:"getBoundingBoxTo",value:function(e){Ki.fromRTS(ky,this.node.getRotation(),this.node.getPosition(),this.node.getScale());var i=this._contentSize.width,n=this._contentSize.height,r=new nn(-this._anchorPoint.x*i,-this._anchorPoint.y*n,i,n);if(Ki.multiply(Ry,e,ky),r.transformMat4(Ry),!this.node.children)return r;for(var a,o=_e(this.node.children);!(a=o()).done;){var s=a.value;if(s&&s.active){var l=s.getComponent(t);if(l){var u=l.getBoundingBoxTo(e);u&&nn.union(r,r,u)}}}return r}},{key:"getComputeAABB",value:function(e){var t=this._contentSize.width,i=this._contentSize.height;My.set(-this._anchorPoint.x*t,-this._anchorPoint.y*i,t,i),My.transformMat4(this.node.worldMatrix);var n=My.x+.5*My.width,r=My.y+.5*My.height,a=this.node.worldPosition.z,o=My.width/2,s=My.height/2;if(null==e)return new lo(n,r,a,o,s,.001);lo.set(e,n,r,a,o,s,.001)}},{key:"_updateVisibility",value:function(){for(var e=this.node;e;){if(e){var t=e.getComponent("cc.CanvasComponent");if(t){this._canvas=t;break}}e=e.parent}}},{key:"_parentChanged",value:function(e){this._canvas&&this._canvas.node===this.node||this._sortSiblings()}},{key:"_sortSiblings",value:function(){var e=this.node.parent&&this.node.parent.children;e&&(e.sort((function(e,t){var i=e._uiProps.uiTransformComp,n=t._uiProps.uiTransformComp,r=(i?i.priority:0)-(n?n.priority:0);return 0===r?e.getSiblingIndex()-t.getSiblingIndex():r})),this.node.parent._updateSiblingIndex())}},{key:"contentSize",get:function(){return this._contentSize},set:function(e){this._contentSize.equals(e)||(this._contentSize.set(e),this.node.emit(exports.SystemEventType.SIZE_CHANGED))}},{key:"width",get:function(){return this._contentSize.width},set:function(e){this._contentSize.width!==e&&(this._contentSize.width=e,this.node.emit(exports.SystemEventType.SIZE_CHANGED))}},{key:"height",get:function(){return this._contentSize.height},set:function(e){this.contentSize.height!==e&&(this._contentSize.height=e,this.node.emit(exports.SystemEventType.SIZE_CHANGED))}},{key:"anchorPoint",get:function(){return this._anchorPoint},set:function(e){this._anchorPoint.equals(e)||(this._anchorPoint.set(e),this.node.emit(exports.SystemEventType.ANCHOR_CHANGED,this._anchorPoint))}},{key:"anchorX",get:function(){return this._anchorPoint.x},set:function(e){this._anchorPoint.x!==e&&(this._anchorPoint.x=e,this.node.emit(exports.SystemEventType.ANCHOR_CHANGED,this._anchorPoint))}},{key:"anchorY",get:function(){return this._anchorPoint.y},set:function(e){this._anchorPoint.y!==e&&(this._anchorPoint.y=e,this.node.emit(exports.SystemEventType.ANCHOR_CHANGED,this._anchorPoint))}},{key:"priority",get:function(){return this._priority},set:function(e){this._priority!==e&&(this._canvas&&this._canvas.node===this.node?cc.warn(9200):(this._priority=e,this._sortSiblings()))}},{key:"visibility",get:function(){return this._canvas?this._canvas.visibility:-1}}]),t}(),Sy.EventType=exports.SystemEventType,de((gy=Ey).prototype,"contentSize",[dy],Object.getOwnPropertyDescriptor(gy.prototype,"contentSize"),gy.prototype),de(gy.prototype,"anchorPoint",[my],Object.getOwnPropertyDescriptor(gy.prototype,"anchorPoint"),gy.prototype),de(gy.prototype,"priority",[vy],Object.getOwnPropertyDescriptor(gy.prototype,"priority"),gy.prototype),xy=de(gy.prototype,"_priority",[Ko],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return 0}}),by=de(gy.prototype,"_contentSize",[Ko],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return new en(100,100)}}),Ty=de(gy.prototype,"_anchorPoint",[Ko],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return new ki(.5,.5)}}),yy=gy))||yy)||yy)||yy)||yy)||yy);cc.UITransformComponent=Iy;var Py,Ly,Dy,Ny,zy,By,Gy,Uy,Xy,Vy,Hy,Wy=function(){function e(t){Z(this,e),this.uiComp=null,this.opacity=1,this._uiTransformComp=null,this._node=void 0,this._node=t}return J(e,[{key:"uiTransformComp",get:function(){return this._uiTransformComp||(this._uiTransformComp=this._node.getComponent(Iy)),this._uiTransformComp},set:function(e){this._uiTransformComp=e}}]),e}(),jy=new Ii,qy=new Xi,Yy=new Xi,Ky=new Array(10),Zy=new Xi,Qy=new Bi,Jy=new Bi,$y=new Ki,eg=new Map,tg=(Py=Yo("cc.Node"),Ly=Ko({type:Ii}),Py((Hy=Vy=function(e){function t(){var e,i;Z(this,t);for(var n=arguments.length,r=new Array(n),a=0;a<n;a++)r[a]=arguments[a];return(i=re(this,(e=te(t)).call.apply(e,[this].concat(r))))._uiProps=new Wy(ne(i)),i._static=!1,i._pos=new Ii,i._rot=new Xi,i._scale=new Ii(1,1,1),i._mat=new Ki,fe(i,"_lpos",zy,ne(i)),fe(i,"_lrot",By,ne(i)),fe(i,"_lscale",Gy,ne(i)),fe(i,"_layer",Uy,ne(i)),fe(i,"_euler",Xy,ne(i)),i._dirtyFlags=rh.NONE,i._eulerDirty=!1,i}return ee(t,wy),J(t,[{key:"setParent",value:function(e){var i=arguments.length>1&&void 0!==arguments[1]&&arguments[1];i&&this.updateWorldTransform(),oe(te(t.prototype),"setParent",this).call(this,e,i)}},{key:"_onSetParent",value:function(e,i){if(oe(te(t.prototype),"_onSetParent",this).call(this,e,i),i){var n=this._parent;n?(n.updateWorldTransform(),Ki.multiply($y,Ki.invert($y,n._mat),this._mat),Ki.toRTS($y,this._lrot,this._lpos,this._lscale)):(Ii.copy(this._lpos,this._pos),Xi.copy(this._lrot,this._rot),Ii.copy(this._lscale,this._scale)),this._eulerDirty=!0}this.invalidateChildren(rh.TRS)}},{key:"_onBatchCreated",value:function(){oe(te(t.prototype),"_onBatchCreated",this).call(this),eg.set(this._id,rh.TRS),this._dirtyFlags=rh.TRS;for(var e=this._children.length,i=0;i<e;++i)this._children[i]._onBatchCreated()}},{key:"_onBatchRestored",value:function(){this._onBatchCreated()}},{key:"_onBeforeSerialize",value:function(){this.eulerAngles}},{key:"_onPostActivated",value:function(e){e?(Pv.resumeTarget(this),this.eventProcessor.reattach(),this.invalidateChildren(rh.TRS)):Pv.pauseTarget(this)}},{key:"translate",value:function(e,t){var i=t||nh.LOCAL;if(i===nh.LOCAL)Ii.transformQuat(jy,e,this._lrot),this._lpos.x+=jy.x,this._lpos.y+=jy.y,this._lpos.z+=jy.z;else if(i===nh.WORLD)if(this._parent){Xi.invert(qy,this._parent.worldRotation),Ii.transformQuat(jy,e,qy);var n=this.worldScale;this._lpos.x+=jy.x/n.x,this._lpos.y+=jy.y/n.y,this._lpos.z+=jy.z/n.z}else this._lpos.x+=e.x,this._lpos.y+=e.y,this._lpos.z+=e.z;this.invalidateChildren(rh.POSITION),1&this._eventMask&&this.emit(exports.SystemEventType.TRANSFORM_CHANGED,rh.POSITION)}},{key:"rotate",value:function(e,t){var i=t||nh.LOCAL;if(Xi.normalize(qy,e),i===nh.LOCAL)Xi.multiply(this._lrot,this._lrot,qy);else if(i===nh.WORLD){var n=this.worldRotation;Xi.multiply(Yy,qy,n),Xi.invert(qy,n),Xi.multiply(Yy,qy,Yy),Xi.multiply(this._lrot,this._lrot,Yy)}this._eulerDirty=!0,this.invalidateChildren(rh.ROTATION),1&this._eventMask&&this.emit(exports.SystemEventType.TRANSFORM_CHANGED,rh.ROTATION)}},{key:"lookAt",value:function(e,t){this.getWorldPosition(jy),Ii.subtract(jy,jy,e),Ii.normalize(jy,jy),Xi.fromViewUp(qy,jy,t),this.setWorldRotation(qy)}},{key:"invalidateChildren",value:function(e){if((this._dirtyFlags&this.hasChangedFlags&e)!==e){this._dirtyFlags|=e,eg.set(this._id,this.hasChangedFlags|e),e|=rh.POSITION;for(var t=this._children.length,i=0;i<t;++i){var n=this._children[i];n.isValid&&n.invalidateChildren(e)}}}},{key:"updateWorldTransform",value:function(){if(this._dirtyFlags){for(var e,t=this,i=0;t&&t._dirtyFlags;)Ky[i++]=t,t=t._parent;for(var n=0;i;)n|=(e=Ky[--i])._dirtyFlags,t?(n&rh.POSITION&&(Ii.transformMat4(e._pos,e._lpos,t._mat),e._mat.m12=e._pos.x,e._mat.m13=e._pos.y,e._mat.m14=e._pos.z),n&rh.RS&&(Ki.fromRTS(e._mat,e._lrot,e._lpos,e._lscale),Ki.multiply(e._mat,t._mat,e._mat),n&rh.ROTATION&&Xi.multiply(e._rot,t._rot,e._lrot),Bi.fromQuat(Qy,Xi.conjugate(Zy,e._rot)),Bi.multiplyMat4(Qy,Qy,e._mat),e._scale.x=Qy.m00,e._scale.y=Qy.m04,e._scale.z=Qy.m08)):(n&rh.POSITION&&(Ii.copy(e._pos,e._lpos),e._mat.m12=e._pos.x,e._mat.m13=e._pos.y,e._mat.m14=e._pos.z),n&rh.RS&&(n&rh.ROTATION&&Xi.copy(e._rot,e._lrot),n&rh.SCALE&&Ii.copy(e._scale,e._lscale),Ki.fromRTS(e._mat,e._rot,e._pos,e._scale))),e._dirtyFlags=rh.NONE,t=e}}},{key:"setPosition",value:function(e,t,i){void 0===t||void 0===i?Ii.copy(this._lpos,e):Ii.set(this._lpos,e,t,i),this.invalidateChildren(rh.POSITION),1&this._eventMask&&this.emit(exports.SystemEventType.TRANSFORM_CHANGED,rh.POSITION)}},{key:"getPosition",value:function(e){return e?Ii.set(e,this._lpos.x,this._lpos.y,this._lpos.z):Ii.copy(new Ii,this._lpos)}},{key:"setRotation",value:function(e,t,i,n){void 0===t||void 0===i||void 0===n?Xi.copy(this._lrot,e):Xi.set(this._lrot,e,t,i,n),this._eulerDirty=!0,this.invalidateChildren(rh.ROTATION),1&this._eventMask&&this.emit(exports.SystemEventType.TRANSFORM_CHANGED,rh.ROTATION)}},{key:"setRotationFromEuler",value:function(e,t,i){Ii.set(this._euler,e,t,i),Xi.fromEuler(this._lrot,e,t,i),this._eulerDirty=!1,this.invalidateChildren(rh.ROTATION),1&this._eventMask&&this.emit(exports.SystemEventType.TRANSFORM_CHANGED,rh.ROTATION)}},{key:"getRotation",value:function(e){return e?Xi.set(e,this._lrot.x,this._lrot.y,this._lrot.z,this._lrot.w):Xi.copy(new Xi,this._lrot)}},{key:"setScale",value:function(e,t,i){void 0===t||void 0===i?Ii.copy(this._lscale,e):Ii.set(this._lscale,e,t,i),this.invalidateChildren(rh.SCALE),1&this._eventMask&&this.emit(exports.SystemEventType.TRANSFORM_CHANGED,rh.SCALE)}},{key:"getScale",value:function(e){return e?Ii.set(e,this._lscale.x,this._lscale.y,this._lscale.z):Ii.copy(new Ii,this._lscale)}},{key:"inverseTransformPoint",value:function(e,t){Ii.copy(e,t);for(var i=this,n=0;i._parent;)Ky[n++]=i,i=i._parent;for(;n>=0;)Ii.transformInverseRTS(e,e,i._lrot,i._lpos,i._lscale),i=Ky[--n];return e}},{key:"setWorldPosition",value:function(e,t,i){void 0===t||void 0===i?Ii.copy(this._pos,e):Ii.set(this._pos,e,t,i);var n=this._parent,r=this._lpos;n?(n.updateWorldTransform(),Ii.transformMat4(r,this._pos,Ki.invert($y,n._mat))):Ii.copy(r,this._pos),this.invalidateChildren(rh.POSITION),1&this._eventMask&&this.emit(exports.SystemEventType.TRANSFORM_CHANGED,rh.POSITION)}},{key:"getWorldPosition",value:function(e){return this.updateWorldTransform(),e?Ii.copy(e,this._pos):Ii.copy(new Ii,this._pos)}},{key:"setWorldRotation",value:function(e,t,i,n){void 0===t||void 0===i||void 0===n?Xi.copy(this._rot,e):Xi.set(this._rot,e,t,i,n),this._parent?(this._parent.updateWorldTransform(),Xi.multiply(this._lrot,Xi.conjugate(this._lrot,this._parent._rot),this._rot)):Xi.copy(this._lrot,this._rot),this._eulerDirty=!0,this.invalidateChildren(rh.ROTATION),1&this._eventMask&&this.emit(exports.SystemEventType.TRANSFORM_CHANGED,rh.ROTATION)}},{key:"setWorldRotationFromEuler",value:function(e,t,i){Xi.fromEuler(this._rot,e,t,i),this._parent?(this._parent.updateWorldTransform(),Xi.multiply(this._lrot,Xi.conjugate(this._lrot,this._parent._rot),this._rot)):Xi.copy(this._lrot,this._rot),this._eulerDirty=!0,this.invalidateChildren(rh.ROTATION),1&this._eventMask&&this.emit(exports.SystemEventType.TRANSFORM_CHANGED,rh.ROTATION)}},{key:"getWorldRotation",value:function(e){return this.updateWorldTransform(),e?Xi.copy(e,this._rot):Xi.copy(new Xi,this._rot)}},{key:"setWorldScale",value:function(e,t,i){void 0===t||void 0===i?Ii.copy(this._scale,e):Ii.set(this._scale,e,t,i);var n=this._parent;n?(n.updateWorldTransform(),Bi.fromQuat(Qy,Xi.conjugate(Zy,n._rot)),Bi.multiplyMat4(Qy,Qy,n._mat),Jy.m00=this._scale.x,Jy.m04=this._scale.y,Jy.m08=this._scale.z,Bi.multiply(Qy,Jy,Bi.invert(Qy,Qy)),this._lscale.x=Ii.set(jy,Qy.m00,Qy.m01,Qy.m02).length(),this._lscale.y=Ii.set(jy,Qy.m03,Qy.m04,Qy.m05).length(),this._lscale.z=Ii.set(jy,Qy.m06,Qy.m07,Qy.m08).length()):Ii.copy(this._lscale,this._scale),this.invalidateChildren(rh.SCALE),1&this._eventMask&&this.emit(exports.SystemEventType.TRANSFORM_CHANGED,rh.SCALE)}},{key:"getWorldScale",value:function(e){return this.updateWorldTransform(),e?Ii.copy(e,this._scale):Ii.copy(new Ii,this._scale)}},{key:"getWorldMatrix",value:function(e){return this.updateWorldTransform(),e||(e=new Ki),Ki.copy(e,this._mat)}},{key:"getWorldRS",value:function(e){return this.updateWorldTransform(),e||(e=new Ki),Ki.copy(e,this._mat),e.m12=0,e.m13=0,e.m14=0,e}},{key:"getWorldRT",value:function(e){return this.updateWorldTransform(),e||(e=new Ki),Ki.fromRT(e,this._rot,this._pos)}},{key:"setRTS",value:function(e,t,i){var n=0;e&&(n|=rh.ROTATION,void 0!==e.w?(Xi.copy(this._lrot,e),this._eulerDirty=!0):(Ii.copy(this._euler,e),Xi.fromEuler(this._lrot,e.x,e.y,e.z),this._eulerDirty=!1)),t&&(Ii.copy(this._lpos,t),n|=rh.POSITION),i&&(Ii.copy(this._lscale,i),n|=rh.SCALE),n&&(this.invalidateChildren(n),1&this._eventMask&&this.emit(exports.SystemEventType.TRANSFORM_CHANGED,n))}},{key:"getAnchorPoint",value:function(e){return e||(e=new ki),e.set(this._uiProps.uiTransformComp.anchorPoint),e}},{key:"setAnchorPoint",value:function(e,t){this._uiProps.uiTransformComp.setAnchorPoint(e,t)}},{key:"getContentSize",value:function(e){return e||(e=new en),e.set(this._uiProps.uiTransformComp.contentSize),e}},{key:"setContentSize",value:function(e,t){this._uiProps.uiTransformComp.setContentSize(e,t)}},{key:"pauseSystemEvents",value:function(e){Pv.pauseTarget(this,e)}},{key:"resumeSystemEvents",value:function(e){Pv.resumeTarget(this,e)}},{key:"position",get:function(){return this._lpos},set:function(e){this.setPosition(e)}},{key:"worldPosition",get:function(){return this.updateWorldTransform(),this._pos},set:function(e){this.setWorldPosition(e)}},{key:"rotation",get:function(){return this._lrot},set:function(e){this.setRotation(e)}},{key:"eulerAngles",set:function(e){this.setRotationFromEuler(e.x,e.y,e.z)},get:function(){return this._eulerDirty&&(Xi.toEuler(this._euler,this._lrot),this._eulerDirty=!1),this._euler}},{key:"worldRotation",get:function(){return this.updateWorldTransform(),this._rot},set:function(e){this.setWorldRotation(e)}},{key:"scale",get:function(){return this._lscale},set:function(e){this.setScale(e)}},{key:"worldScale",get:function(){return this.updateWorldTransform(),this._scale},set:function(e){this.setWorldScale(e)}},{key:"matrix",set:function(e){Ki.toRTS(e,this._lrot,this._lpos,this._lscale),this.invalidateChildren(rh.TRS),this._eulerDirty=!0,1&this._eventMask&&this.emit(exports.SystemEventType.TRANSFORM_CHANGED,rh.TRS)}},{key:"worldMatrix",get:function(){return this.updateWorldTransform(),this._mat}},{key:"forward",get:function(){return Ii.transformQuat(new Ii,Ii.FORWARD,this.worldRotation)},set:function(e){var t=e.length();Ii.multiplyScalar(jy,e,-1/t),Xi.fromViewUp(qy,jy),this.setWorldRotation(qy)}},{key:"layer",set:function(e){this._layer=e},get:function(){return this._layer}},{key:"hasChangedFlags",get:function(){return eg.get(this._id)||0},set:function(e){eg.set(this._id,e)}},{key:"width",get:function(){return this._uiProps.uiTransformComp.width},set:function(e){this._uiProps.uiTransformComp.width=e}},{key:"height",get:function(){return this._uiProps.uiTransformComp.height},set:function(e){this._uiProps.uiTransformComp.height=e}},{key:"anchorX",get:function(){return this._uiProps.uiTransformComp.anchorX},set:function(e){this._uiProps.uiTransformComp.anchorX=e}},{key:"anchorY",get:function(){return this._uiProps.uiTransformComp.anchorY},set:function(e){this._uiProps.uiTransformComp.anchorY=e}}],[{key:"isNode",value:function(e){return e instanceof t&&(e.constructor===t||!(e instanceof cc.Scene))}}]),t}(),Vy.bookOfChange=eg,Vy.EventType=exports.SystemEventType,Vy.NodeSpace=nh,Vy.TransformDirtyBit=rh,Vy.TransformBit=rh,zy=de((Ny=Hy).prototype,"_lpos",[Ko],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return new Ii}}),By=de(Ny.prototype,"_lrot",[Ko],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return new Xi}}),Gy=de(Ny.prototype,"_lscale",[Ko],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return new Ii(1,1,1)}}),Uy=de(Ny.prototype,"_layer",[Ko],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return bu.Enum.DEFAULT}}),Xy=de(Ny.prototype,"_euler",[Ko],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return new Ii}}),de(Ny.prototype,"eulerAngles",[Ly],Object.getOwnPropertyDescriptor(Ny.prototype,"eulerAngles"),Ny.prototype),de(Ny.prototype,"layer",[Ko],Object.getOwnPropertyDescriptor(Ny.prototype,"layer"),Ny.prototype),Dy=Ny))||Dy);cc.Node=tg;var ig,ng,rg,ag,og,sg,lg,ug,cg,hg,pg,_g,fg,dg,mg,vg,yg,gg,xg,bg,Tg,Sg,Eg,wg,Cg,Ag,Og,kg,Rg,Fg,Mg,Ig,Pg,Lg,Dg,Ng,zg,Bg,Gg=function(){function e(t){Z(this,e),this._enabled=!0,this._skyColor=Float32Array.from([.2,.5,.8,1]),this._skyIllum=e.SKY_ILLUM,this._groundAlbedo=Float32Array.from([.2,.2,.2,1]),this._scene=void 0,this._scene=t}return J(e,[{key:"enabled",set:function(e){this._enabled=e},get:function(){return this._enabled}},{key:"skyColor",get:function(){return this._skyColor},set:function(e){this._skyColor=e}},{key:"skyIllum",set:function(e){this._skyIllum=e},get:function(){return this._skyIllum}},{key:"groundAlbedo",get:function(){return this._groundAlbedo},set:function(e){this._groundAlbedo=e}}]),J(e,[{key:"update",value:function(){}}]),e}();Gg.SUN_ILLUM=65e3,Gg.SKY_ILLUM=2e4;var Ug=new Ii(0,1,0),Xg=new Ii,Vg=new Xi,Hg=(ig=Yo("cc.AmbientInfo"),ng=Ko({type:an}),rg=Ko({type:an}),ig((sg=de((og=function(){function e(){Z(this,e),fe(this,"_skyColor",sg,this),fe(this,"_skyIllum",lg,this),fe(this,"_groundAlbedo",ug,this),this._resource=null}return J(e,[{key:"skyColor",set:function(e){this._skyColor.set(e),this._resource&&an.toArray(this._resource.skyColor,this.skyColor)},get:function(){return this._skyColor}},{key:"skyIllum",set:function(e){this._skyIllum=e,this._resource&&(this._resource.skyIllum=this.skyIllum)},get:function(){return this._skyIllum}},{key:"groundAlbedo",set:function(e){this._groundAlbedo.set(e),this._resource&&Ii.toArray(this._resource.groundAlbedo,this.groundAlbedo)},get:function(){return this._groundAlbedo}},{key:"renderScene",set:function(e){this._resource=e.ambient,this.skyColor=this._skyColor,this.skyIllum=this._skyIllum,this.groundAlbedo=this._groundAlbedo}}]),e}()).prototype,"_skyColor",[Ko],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return new an(51,128,204,1)}}),lg=de(og.prototype,"_skyIllum",[Ko],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return Gg.SKY_ILLUM}}),ug=de(og.prototype,"_groundAlbedo",[Ko],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return new an(51,51,51,255)}}),de(og.prototype,"skyColor",[ng],Object.getOwnPropertyDescriptor(og.prototype,"skyColor"),og.prototype),de(og.prototype,"skyIllum",[ls],Object.getOwnPropertyDescriptor(og.prototype,"skyIllum"),og.prototype),de(og.prototype,"groundAlbedo",[rg],Object.getOwnPropertyDescriptor(og.prototype,"groundAlbedo"),og.prototype),ag=og))||ag);cc.AmbientInfo=Hg;var Wg=(cg=Yo("cc.SkyboxInfo"),hg=Ko(Oc),pg=Ko({type:Mt}),_g=Ko({type:Mt}),fg=Ko({type:Oc}),dg=Ko({type:Mt}),cg((yg=de((vg=function(){function e(){Z(this,e),fe(this,"_envmap",yg,this),fe(this,"_isRGBE",gg,this),fe(this,"_enabled",xg,this),fe(this,"_useIBL",bg,this),this._resource=null}return J(e,[{key:"enabled",set:function(e){this._enabled=e,this._resource&&(this._resource.enabled=this._enabled)},get:function(){return this._enabled}},{key:"useIBL",set:function(e){this._useIBL=e,this._resource&&(this._resource.useIBL=this._useIBL)},get:function(){return this._useIBL}},{key:"envmap",set:function(e){this._envmap=e,this._resource&&(this._resource.envmap=this._envmap)},get:function(){return this._envmap}},{key:"isRGBE",set:function(e){this._isRGBE=e,this._resource&&(this._resource.isRGBE=this._isRGBE)},get:function(){return this._isRGBE}},{key:"renderScene",set:function(e){this._resource=e.skybox,this.isRGBE=this._isRGBE,this.envmap=this._envmap,this.enabled=this._enabled,this.useIBL=this._useIBL}}]),e}()).prototype,"_envmap",[hg],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return null}}),gg=de(vg.prototype,"_isRGBE",[Ko],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return!1}}),xg=de(vg.prototype,"_enabled",[Ko],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return!1}}),bg=de(vg.prototype,"_useIBL",[Ko],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return!1}}),de(vg.prototype,"enabled",[pg],Object.getOwnPropertyDescriptor(vg.prototype,"enabled"),vg.prototype),de(vg.prototype,"useIBL",[_g],Object.getOwnPropertyDescriptor(vg.prototype,"useIBL"),vg.prototype),de(vg.prototype,"envmap",[fg],Object.getOwnPropertyDescriptor(vg.prototype,"envmap"),vg.prototype),de(vg.prototype,"isRGBE",[dg],Object.getOwnPropertyDescriptor(vg.prototype,"isRGBE"),vg.prototype),mg=vg))||mg);cc.SkyboxInfo=Wg;var jg=(Tg=Yo("cc.PlanarShadowInfo"),Sg=Ko({type:Mt}),Eg=Ko({type:Ii}),wg=Ko({type:Ft}),Cg=Ko({type:an}),Tg((kg=de((Og=function(){function e(){Z(this,e),fe(this,"_enabled",kg,this),fe(this,"_normal",Rg,this),fe(this,"_distance",Fg,this),fe(this,"_shadowColor",Mg,this),this._resource=null}return J(e,[{key:"setPlaneFromNode",value:function(e){e.getWorldRotation(Vg),this.normal=Ii.transformQuat(Xg,Ug,Vg),e.getWorldPosition(Xg),this.distance=Ii.dot(this._normal,Xg)}},{key:"enabled",set:function(e){this._enabled=e,this._resource&&(this._resource.enabled=e)},get:function(){return this._enabled}},{key:"normal",set:function(e){Ii.copy(this._normal,e),this._resource&&(this._resource.normal=e)},get:function(){return this._normal}},{key:"distance",set:function(e){this._distance=e,this._resource&&(this._resource.distance=e)},get:function(){return this._distance}},{key:"shadowColor",set:function(e){this._shadowColor.set(e),this._resource&&(this._resource.shadowColor=e)},get:function(){return this._shadowColor}},{key:"renderScene",set:function(e){this._resource=e.planarShadows,this.normal=this._normal,this.distance=this._distance,this.shadowColor=this._shadowColor,this.enabled=this._enabled}}]),e}()).prototype,"_enabled",[Ko],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return!1}}),Rg=de(Og.prototype,"_normal",[Ko],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return new Ii(0,1,0)}}),Fg=de(Og.prototype,"_distance",[Ko],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return 0}}),Mg=de(Og.prototype,"_shadowColor",[Ko],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return new an(0,0,0,76)}}),de(Og.prototype,"enabled",[Sg],Object.getOwnPropertyDescriptor(Og.prototype,"enabled"),Og.prototype),de(Og.prototype,"normal",[Eg],Object.getOwnPropertyDescriptor(Og.prototype,"normal"),Og.prototype),de(Og.prototype,"distance",[wg],Object.getOwnPropertyDescriptor(Og.prototype,"distance"),Og.prototype),de(Og.prototype,"shadowColor",[Cg],Object.getOwnPropertyDescriptor(Og.prototype,"shadowColor"),Og.prototype),Ag=Og))||Ag);cc.PlanarShadowInfo=jg;var qg,Yg,Kg,Zg,Qg=(Ig=Yo("cc.SceneGlobals"),Pg=Ko({type:Wg}),Ig((Ng=de((Dg=function(){function e(){Z(this,e),fe(this,"ambient",Ng,this),fe(this,"planarShadows",zg,this),fe(this,"_skybox",Bg,this)}return J(e,[{key:"skybox",get:function(){return this._skybox},set:function(e){this._skybox=e}},{key:"renderScene",set:function(e){this.ambient.renderScene=e,this.skybox.renderScene=e,this.planarShadows.renderScene=e}}]),e}()).prototype,"ambient",[Ko],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return new Hg}}),zg=de(Dg.prototype,"planarShadows",[Ko],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return new jg}}),Bg=de(Dg.prototype,"_skybox",[Ko],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return new Wg}}),de(Dg.prototype,"skybox",[Pg],Object.getOwnPropertyDescriptor(Dg.prototype,"skybox"),Dg.prototype),Lg=Dg))||Lg);cc.SceneGlobals=Qg;var Jg,$g=Yo("cc.Scene")((Kg=de((Yg=function(e){function t(e){var i;return Z(this,t),fe(i=re(this,te(t).call(this,e)),"autoReleaseAssets",Kg,ne(i)),i._renderScene=null,i.dependAssets=null,fe(i,"_globals",Zg,ne(i)),i._inited=void 0,i._prefabSyncedInLiveReload=!1,i._pos=Ii.ZERO,i._rot=Xi.IDENTITY,i._scale=Ii.ONE,i._mat=Ki.IDENTITY,i._dirtyFlags=0,i._activeInHierarchy=!1,cc.director&&cc.director.root&&(i._renderScene=cc.director.root.createScene({})),i._inited=!cc.game||!cc.game._isCloning,i}return ee(t,wy),J(t,[{key:"renderScene",get:function(){return this._renderScene}},{key:"globals",get:function(){return this._globals}}]),J(t,[{key:"destroy",value:function(){var e=oe(te(t.prototype),"destroy",this).call(this);return cc.director.root.destroyScene(this._renderScene),this._activeInHierarchy=!1,e}},{key:"addComponent",value:function(e){return g(3822),null}},{key:"_onHierarchyChanged",value:function(){}},{key:"_onBatchCreated",value:function(){oe(te(t.prototype),"_onBatchCreated",this).call(this);for(var e=this._children.length,i=0;i<e;++i)this._children[i]._onBatchCreated()}},{key:"_onBatchRestored",value:function(){this._onBatchCreated()}},{key:"getPosition",value:function(e){return Ii.copy(e||new Ii,Ii.ZERO)}},{key:"getRotation",value:function(e){return Xi.copy(e||new Xi,Xi.IDENTITY)}},{key:"getScale",value:function(e){return Ii.copy(e||new Ii,Ii.ONE)}},{key:"getWorldPosition",value:function(e){return Ii.copy(e||new Ii,Ii.ZERO)}},{key:"getWorldRotation",value:function(e){return Xi.copy(e||new Xi,Xi.IDENTITY)}},{key:"getWorldScale",value:function(e){return Ii.copy(e||new Ii,Ii.ONE)}},{key:"getWorldMatrix",value:function(e){return Ki.copy(e||new Ki,Ki.IDENTITY)}},{key:"getWorldRS",value:function(e){return Ki.copy(e||new Ki,Ki.IDENTITY)}},{key:"getWorldRT",value:function(e){return Ki.copy(e||new Ki,Ki.IDENTITY)}},{key:"updateWorldTransform",value:function(){}},{key:"_instantiate",value:function(){}},{key:"_load",value:function(){this._inited||(this._onBatchCreated(),this._inited=!0),this.walk(wy._setScene)}},{key:"_activate",value:function(e){e=!1!==e,cc.director._nodeActivator.activateNode(this,e),this._globals.renderScene=this._renderScene}},{key:"position",get:function(){return Ii.ZERO}},{key:"worldPosition",get:function(){return Ii.ZERO}},{key:"rotation",get:function(){return Xi.IDENTITY}},{key:"worldRotation",get:function(){return Xi.IDENTITY}},{key:"scale",get:function(){return Ii.ONE}},{key:"worldScale",get:function(){return Ii.ONE}},{key:"eulerAngles",get:function(){return Ii.ZERO}},{key:"worldMatrix",get:function(){return Ki.IDENTITY}}]),t}()).prototype,"autoReleaseAssets",[Ko],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return!1}}),Zg=de(Yg.prototype,"_globals",[Ko],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return new Qg}}),qg=Yg))||qg;function ex(e,t){if(!t){var i=cc.director.getScene();if(!i)return null;t=i}return t.getChildByPath(e)}cc.Scene=$g,cc.find=ex;var tx=sl.Flags.HideInHierarchy,ix=Yo("cc.PrivateNode")(Jg=function(e){function t(e){var i;return Z(this,t),(i=re(this,te(t).call(this,e)))._objFlags|=tx,i}return ee(t,tg),t}())||Jg;cc.PrivateNode=ix;var nx=tt.fastRemoveAt,rx=sl.Flags.IsStartCalled,ax=sl.Flags.IsOnEnableCalled;sl.Flags.IsEditorOnEnableCalled;function ox(e,t){for(var i=t.constructor._executionOrder,n=t._id,r=0,a=e.length-1,o=a>>>1;r<=a;o=r+a>>>1){var s=e[o],l=s.constructor._executionOrder;if(l>i)a=o-1;else if(l<i)r=o+1;else{var u=s._id;if(u>n)a=o-1;else{if(!(u<n))return o;r=o+1}}}return~r}function sx(e,t){for(var i=e.array,n=e.i+1;n<i.length;){var r=i[n];r._enabled&&r.node._activeInHierarchy?++n:(e.removeAt(n),t&&(r._objFlags&=~t))}}var lx=function e(t){Z(this,e),this._zero=void 0,this._neg=void 0,this._pos=void 0,this._invoke=void 0;var i=me;this._zero=new i([]),this._neg=new i([]),this._pos=new i([]),this._invoke=t};function ux(e,t){return e.constructor._executionOrder-t.constructor._executionOrder}lx.stableRemoveInactive=sx;var cx=function(e){function t(){return Z(this,t),re(this,te(t).apply(this,arguments))}return ee(t,lx),J(t,[{key:"add",value:function(e){var t=e.constructor._executionOrder;(0===t?this._zero:t<0?this._neg:this._pos).array.push(e)}},{key:"remove",value:function(e){var t=e.constructor._executionOrder;(0===t?this._zero:t<0?this._neg:this._pos).fastRemove(e)}},{key:"cancelInactive",value:function(e){sx(this._zero,e),sx(this._neg,e),sx(this._pos,e)}},{key:"invoke",value:function(){var e=this._neg;e.array.length>0&&(e.array.sort(ux),this._invoke(e),e.array.length=0),this._invoke(this._zero),this._zero.array.length=0;var t=this._pos;t.array.length>0&&(t.array.sort(ux),this._invoke(t),t.array.length=0)}}]),t}(),hx=function(e){function t(){return Z(this,t),re(this,te(t).apply(this,arguments))}return ee(t,lx),J(t,[{key:"add",value:function(e){var t=e.constructor._executionOrder;if(0===t)this._zero.array.push(e);else{var i=t<0?this._neg.array:this._pos.array,n=ox(i,e);n<0&&i.splice(~n,0,e)}}},{key:"remove",value:function(e){var t=e.constructor._executionOrder;if(0===t)this._zero.fastRemove(e);else{var i=t<0?this._neg:this._pos,n=ox(i.array,e);n>=0&&i.removeAt(n)}}},{key:"invoke",value:function(e){this._neg.array.length>0&&this._invoke(this._neg,e),this._invoke(this._zero,e),this._pos.array.length>0&&this._invoke(this._pos,e)}}]),t}();function px(e,t,i){return function(n,r){try{t(n,r)}catch(t){cc._throw(t);var a=n.array;for(i&&(a[n.i]._objFlags|=i),++n.i;n.i<a.length;++n.i)try{e(a[n.i],r)}catch(e){cc._throw(e),i&&(a[n.i]._objFlags|=i)}}}}var _x=px((function(e){e.start(),e._objFlags|=rx}),(function(e){var t=e.array;for(e.i=0;e.i<t.length;++e.i){var i=t[e.i];i.start(),i._objFlags|=rx}}),rx),fx=px((function(e,t){e.update(t)}),(function(e,t){var i=e.array;for(e.i=0;e.i<i.length;++e.i)i[e.i].update(t)})),dx=px((function(e,t){e.lateUpdate(t)}),(function(e,t){var i=e.array;for(e.i=0;e.i<i.length;++e.i)i[e.i].lateUpdate(t)})),mx=function(e){var t=cc.director._compScheduler,i=e.array;for(e.i=0;e.i<i.length;++e.i){var n=i[e.i];if(n._enabled)n.onEnable(),!n.node._activeInHierarchy||t._onEnabled(n)}},vx=function(){function e(){Z(this,e),this._deferredComps=[],this.unscheduleAll()}return J(e,[{key:"unscheduleAll",value:function(){this.startInvoker=new cx(_x),this.updateInvoker=new hx(fx),this.lateUpdateInvoker=new hx(dx),this._updating=!1}},{key:"_onEnabled",value:function(e){cc.director.getScheduler().resumeTarget(e),e._objFlags|=ax,this._updating?this._deferredComps.push(e):this._scheduleImmediate(e)}},{key:"_onDisabled",value:function(e){cc.director.getScheduler().pauseTarget(e),e._objFlags&=~ax;var t=this._deferredComps.indexOf(e);t>=0?nx(this._deferredComps,t):(!e.start||e._objFlags&rx||this.startInvoker.remove(e),e.update&&this.updateInvoker.remove(e),e.lateUpdate&&this.lateUpdateInvoker.remove(e))}},{key:"enableComp",value:function(e,t){if(!(e._objFlags&ax)){if(e.onEnable){if(t)return void t.add(e);if(e.onEnable(),!e.node._activeInHierarchy)return}this._onEnabled(e)}}},{key:"disableComp",value:function(e){e._objFlags&ax&&(e.onDisable&&e.onDisable(),this._onDisabled(e))}},{key:"startPhase",value:function(){this._updating=!0,this.startInvoker.invoke(),this._startForNewComps()}},{key:"updatePhase",value:function(e){this.updateInvoker.invoke(e)}},{key:"lateUpdatePhase",value:function(e){this.lateUpdateInvoker.invoke(e),this._updating=!1,this._startForNewComps()}},{key:"_startForNewComps",value:function(){this._deferredComps.length>0&&(this._deferredSchedule(),this.startInvoker.invoke())}},{key:"_scheduleImmediate",value:function(e){"function"!=typeof e.start||e._objFlags&rx||this.startInvoker.add(e),"function"==typeof e.update&&this.updateInvoker.add(e),"function"==typeof e.lateUpdate&&this.lateUpdateInvoker.add(e)}},{key:"_deferredSchedule",value:function(){for(var e=this._deferredComps,t=0,i=e.length;t<i;t++)this._scheduleImmediate(e[t]);e.length=0}}]),e}(),yx=sl.Flags.IsPreloadStarted,gx=sl.Flags.IsOnLoadStarted,xx=sl.Flags.IsOnLoadCalled,bx=sl.Flags.Deactivating,Tx=function(e){function t(){return Z(this,t),re(this,te(t).apply(this,arguments))}return ee(t,lx),J(t,[{key:"add",value:function(e){this._zero.array.push(e)}},{key:"remove",value:function(e){this._zero.fastRemove(e)}},{key:"cancelInactive",value:function(e){lx.stableRemoveInactive(this._zero,e)}},{key:"invoke",value:function(){this._invoke(this._zero),this._zero.array.length=0}}]),t}(),Sx=px((function(e){e.__preload()}),(function(e){var t=e.array;for(e.i=0;e.i<t.length;++e.i)t[e.i].__preload()})),Ex=px((function(e){e.onLoad(),e._objFlags|=xx}),(function(e){var t=e.array;for(e.i=0;e.i<t.length;++e.i){var i=t[e.i];i.onLoad(),i._objFlags|=xx}}),xx),wx=new et(4);function Cx(e,t,i){t?e._removeComponent(t):tt.removeAt(e._components,i)}wx.get=function(){var e=this._get()||{preload:new Tx(Sx),onLoad:new cx(Ex),onEnable:new cx(mx)};e.preload._zero.i=-1;var t=e.onLoad;return t._zero.i=-1,t._neg.i=-1,t._pos.i=-1,(t=e.onEnable)._zero.i=-1,t._neg.i=-1,t._pos.i=-1,e};var Ax,Ox,kx,Rx,Fx,Mx,Ix,Px,Lx,Dx,Nx,zx,Bx,Gx,Ux,Xx,Vx,Hx,Wx,jx,qx,Yx,Kx,Zx,Qx,Jx,$x,eb,tb,ib,nb,rb,ab,ob,sb,lb,ub,cb,hb,pb,_b,fb,db,mb,vb,yb,gb,xb,bb,Tb,Sb,Eb,wb,Cb,Ab,Ob,kb,Rb,Fb,Mb,Ib,Pb,Lb,Db=function(){function e(){Z(this,e),this.resetComp=void 0,this.reset()}return J(e,[{key:"reset",value:function(){this._activatingStack=[]}},{key:"activateNode",value:function(e,t){if(t){var i=wx.get();this._activatingStack.push(i),this._activateNodeRecursively(e,i.preload,i.onLoad,i.onEnable),i.preload.invoke(),i.onLoad.invoke(),i.onEnable.invoke(),this._activatingStack.pop(),wx.put(i)}else{this._deactivateNodeRecursively(e);for(var n,r=_e(this._activatingStack);!(n=r()).done;){var a=n.value;a.preload.cancelInactive(yx),a.onLoad.cancelInactive(gx),a.onEnable.cancelInactive()}}e.emit("active-in-hierarchy-changed",e)}},{key:"activateComp",value:function(e,t,i,n){if(e._objFlags&yx||(e._objFlags|=yx,e.__preload&&(t?t.add(e):e.__preload())),e._objFlags&gx||(e._objFlags|=gx,e.onLoad?i?i.add(e):(e.onLoad(),e._objFlags|=xx):e._objFlags|=xx),e._enabled){if(!e.node._activeInHierarchy)return;cc.director._compScheduler.enableComp(e,n)}}},{key:"destroyComp",value:function(e){cc.director._compScheduler.disableComp(e),e.onDestroy&&e._objFlags&xx&&e.onDestroy()}},{key:"_activateNodeRecursively",value:function(e,t,i,n){if(e._objFlags&bx)cc.errorID(3816,e.name);else{e._activeInHierarchy=!0;for(var r=e._components.length,a=0;a<r;++a){var o=e._components[a];o instanceof cc.Component?this.activateComp(o,t,i,n):(Cx(e,o,a),--a,--r)}e._childArrivalOrder=e._children.length;for(var s=0,l=e._children.length;s<l;++s){var u=e._children[s];u._active&&this._activateNodeRecursively(u,t,i,n)}e._onPostActivated(!0)}}},{key:"_deactivateNodeRecursively",value:function(e){e._objFlags|=bx,e._activeInHierarchy=!1;for(var t=e._components.length,i=0;i<t;++i){var n=e._components[i];if(n._enabled&&(cc.director._compScheduler.disableComp(n),e._activeInHierarchy))return void(e._objFlags&=~bx)}for(var r=0,a=e._children.length;r<a;++r){var o=e._children[r];if(o._activeInHierarchy&&(this._deactivateNodeRecursively(o),e._activeInHierarchy))return void(e._objFlags&=~bx)}e._onPostActivated(!1),e._objFlags&=~bx}}]),e}();exports.replaceProperty(wy.prototype,"BaseNode",[{name:"childrenCount",newName:"children.length",customGetter:function(){return this.children.length}}]),exports.removeProperty(tg.prototype,"Node.prototype",[{name:"addLayer"},{name:"removeLayer"}]),exports.removeProperty(bu,"Layers",[{name:"All"},{name:"RaycastMask"},{name:"check"}]),exports.replaceProperty(bu,"Layers",[{name:"Default",newName:"DEFAULT",target:bu.Enum,targetName:"Layers.Enum"},{name:"Always",newName:"ALWAYS",target:bu.Enum,targetName:"Layers.Enum"},{name:"IgnoreRaycast",newName:"IGNORE_RAYCAST",target:bu.Enum,targetName:"Layers.Enum"},{name:"Gizmos",newName:"GIZMOS",target:bu.Enum,targetName:"Layers.Enum"},{name:"Editor",newName:"EDITOR",target:bu.Enum,targetName:"Layers.Enum"},{name:"UI",newName:"UI_3D",target:bu.Enum,targetName:"Layers.Enum"},{name:"UI2D",newName:"UI_2D",target:bu.Enum,targetName:"Layers.Enum"},{name:"SceneGizmo",newName:"SCENE_GIZMO",target:bu.Enum,targetName:"Layers.Enum"},{name:"makeInclusiveMask",newName:"makeMaskInclude",target:bu,targetName:"Layers"},{name:"makeExclusiveMask",newName:"makeMaskExclude",target:bu,targetName:"Layers"}]),exports.removeProperty(bu.Enum,"Layers.Enum",[{name:"ALWAYS"}]),exports.removeProperty(bu.BitMask,"Layers.BitMask",[{name:"ALWAYS"}]),bt(exports.GFXTextureType),bt(exports.GFXTextureViewType),bt(exports.GFXTextureUsageBit),bt(exports.GFXStoreOp),bt(exports.GFXLoadOp),bt(exports.GFXTextureLayout),function(e){e[e.SCENE=0]="SCENE",e[e.POSTPROCESS=1]="POSTPROCESS",e[e.UI=2]="UI"}(Lb||(Lb={})),bt(Lb);var Nb=(Ax=Yo("RenderTextureDesc"),Ox=Ko({type:exports.GFXTextureType}),kx=Ko({type:exports.GFXTextureViewType}),Rx=Ko({type:exports.GFXTextureUsageBit}),Fx=Ko({type:exports.GFXFormat}),Ax((Px=de((Ix=function e(){Z(this,e),fe(this,"name",Px,this),fe(this,"type",Lx,this),fe(this,"viewType",Dx,this),fe(this,"usage",Nx,this),fe(this,"format",zx,this),fe(this,"width",Bx,this),fe(this,"height",Gx,this)}).prototype,"name",[Ko],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return""}}),Lx=de(Ix.prototype,"type",[Ox],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return exports.GFXTextureType.TEX2D}}),Dx=de(Ix.prototype,"viewType",[kx],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return exports.GFXTextureViewType.TV2D}}),Nx=de(Ix.prototype,"usage",[Rx],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return exports.GFXTextureUsageBit.COLOR_ATTACHMENT}}),zx=de(Ix.prototype,"format",[Fx],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return exports.GFXFormat.UNKNOWN}}),Bx=de(Ix.prototype,"width",[Ko],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return-1}}),Gx=de(Ix.prototype,"height",[Ko],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return-1}}),Mx=Ix))||Mx),zb=(Ux=Yo("FrameBufferDesc"),Xx=Ko({type:[It]}),Ux((Wx=de((Hx=function e(){Z(this,e),fe(this,"name",Wx,this),fe(this,"renderPass",jx,this),fe(this,"colorViews",qx,this),fe(this,"depthStencilView",Yx,this)}).prototype,"name",[Ko],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return""}}),jx=de(Hx.prototype,"renderPass",[Ko],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return 0}}),qx=de(Hx.prototype,"colorViews",[Xx],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return[]}}),Yx=de(Hx.prototype,"depthStencilView",[Ko],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return""}}),Vx=Hx))||Vx),Bb=(Kx=Yo("ColorDesc"),Zx=Ko({type:exports.GFXFormat}),Qx=Ko({type:exports.GFXLoadOp}),Jx=Ko({type:exports.GFXStoreOp}),$x=Ko({type:exports.GFXTextureLayout}),eb=Ko({type:exports.GFXTextureLayout}),Kx((nb=de((ib=function e(){Z(this,e),fe(this,"format",nb,this),fe(this,"loadOp",rb,this),fe(this,"storeOp",ab,this),fe(this,"sampleCount",ob,this),fe(this,"beginLayout",sb,this),fe(this,"endLayout",lb,this)}).prototype,"format",[Zx],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return exports.GFXFormat.UNKNOWN}}),rb=de(ib.prototype,"loadOp",[Qx],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return exports.GFXLoadOp.CLEAR}}),ab=de(ib.prototype,"storeOp",[Jx],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return exports.GFXStoreOp.STORE}}),ob=de(ib.prototype,"sampleCount",[Ko],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return 1}}),sb=de(ib.prototype,"beginLayout",[$x],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return exports.GFXTextureLayout.COLOR_ATTACHMENT_OPTIMAL}}),lb=de(ib.prototype,"endLayout",[eb],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return exports.GFXTextureLayout.COLOR_ATTACHMENT_OPTIMAL}}),tb=ib))||tb),Gb=(ub=Yo("DepthStencilDesc"),cb=Ko({type:exports.GFXFormat}),hb=Ko({type:exports.GFXLoadOp}),pb=Ko({type:exports.GFXStoreOp}),_b=Ko({type:exports.GFXLoadOp}),fb=Ko({type:exports.GFXStoreOp}),db=Ko({type:exports.GFXTextureLayout}),mb=Ko({type:exports.GFXTextureLayout}),ub((gb=de((yb=function e(){Z(this,e),fe(this,"format",gb,this),fe(this,"depthLoadOp",xb,this),fe(this,"depthStoreOp",bb,this),fe(this,"stencilLoadOp",Tb,this),fe(this,"stencilStoreOp",Sb,this),fe(this,"sampleCount",Eb,this),fe(this,"beginLayout",wb,this),fe(this,"endLayout",Cb,this)}).prototype,"format",[cb],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return exports.GFXFormat.UNKNOWN}}),xb=de(yb.prototype,"depthLoadOp",[hb],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return exports.GFXLoadOp.CLEAR}}),bb=de(yb.prototype,"depthStoreOp",[pb],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return exports.GFXStoreOp.STORE}}),Tb=de(yb.prototype,"stencilLoadOp",[_b],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return exports.GFXLoadOp.CLEAR}}),Sb=de(yb.prototype,"stencilStoreOp",[fb],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return exports.GFXStoreOp.STORE}}),Eb=de(yb.prototype,"sampleCount",[Ko],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return 1}}),wb=de(yb.prototype,"beginLayout",[db],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return exports.GFXTextureLayout.COLOR_ATTACHMENT_OPTIMAL}}),Cb=de(yb.prototype,"endLayout",[mb],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return exports.GFXTextureLayout.COLOR_ATTACHMENT_OPTIMAL}}),vb=yb))||vb),Ub=(Ab=Yo("RenderPassDesc"),Ob=Ko({type:[Bb]}),kb=Ko({type:Gb}),Ab((Mb=de((Fb=function e(){Z(this,e),fe(this,"index",Mb,this),fe(this,"colorAttachments",Ib,this),fe(this,"depthStencilAttachment",Pb,this)}).prototype,"index",[Ko],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return-1}}),Ib=de(Fb.prototype,"colorAttachments",[Ob],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return[]}}),Pb=de(Fb.prototype,"depthStencilAttachment",[kb],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return new Gb}}),Rb=Fb))||Rb);function Xb(e,t){return e.hash-t.hash||e.depth-t.depth||e.shaderId-t.shaderId}function Vb(e,t){return e.hash-t.hash||t.depth-e.depth||e.shaderId-t.shaderId}var Hb,Wb,jb,qb,Yb,Kb,Zb,Qb,Jb,$b,eT,tT,iT,nT,rT,aT,oT,sT,lT,uT,cT=function(){function e(t){Z(this,e),this.queue=void 0,this.cmdBuffs=void 0,this.cmdBuffCount=0,this._passDesc=void 0,this._passPool=void 0,this._passDesc=t,this._passPool=new So((function(){return{hash:0,depth:0,shaderId:0,subModel:null,cmdBuff:null}}),64),this.cmdBuffs=new Eo(64),this.queue=new Eo(64,this._passDesc.sortFunc)}return J(e,[{key:"clear",value:function(){this.queue.clear(),this._passPool.reset(),this.cmdBuffCount=0}},{key:"insertRenderPass",value:function(e,t,i){var n=e.model.getSubModel(t),r=n.passes[i],a=n.psos[i];if(a.blendState.targets[0].blend!==this._passDesc.isTransparent||!(r.phase&this._passDesc.phases))return!1;var o=0|r.priority<<16|n.priority<<8|i,s=this._passPool.add();return s.hash=o,s.depth=e.depth,s.shaderId=a.shader.id,s.subModel=n,s.cmdBuff=n.commandBuffers[i],this.queue.push(s),!0}},{key:"sort",value:function(){this.queue.sort(),this.cmdBuffCount=this.queue.length;for(var e=0;e<this.queue.length;++e)this.cmdBuffs.array[e]=this.queue.array[e].cmdBuff}}]),e}(),hT=[{r:0,g:0,b:0,a:1}],pT=[];!function(e){e[e.FRONT_TO_BACK=0]="FRONT_TO_BACK",e[e.BACK_TO_FRONT=1]="BACK_TO_FRONT"}(uT||(uT={})),bt(uT);var _T,fT,dT,mT,vT,yT,gT,xT,bT,TT,ST,ET,wT,CT=(Hb=Yo("RenderQueueDesc"),Wb=Ko({type:uT}),jb=Ko({type:[It]}),Hb((Kb=de((Yb=function e(){Z(this,e),fe(this,"isTransparent",Kb,this),fe(this,"sortMode",Zb,this),fe(this,"stages",Qb,this)}).prototype,"isTransparent",[Ko],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return!1}}),Zb=de(Yb.prototype,"sortMode",[Wb],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return uT.FRONT_TO_BACK}}),Qb=de(Yb.prototype,"stages",[jb],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return[]}}),qb=Yb))||qb),AT=(Jb=Yo("RenderStage"),$b=Ko({displayOrder:0,visible:!0}),eT=Ko({displayOrder:1,visible:!0}),tT=Ko({displayOrder:2,visible:!0}),iT=Ko({type:[CT],displayOrder:3,visible:!0}),Jb((aT=de((rT=function(){function e(){Z(this,e),fe(this,"_name",aT,this),fe(this,"_priority",oT,this),fe(this,"frameBuffer",sT,this),fe(this,"renderQueues",lT,this),this._renderQueues=[],this._flow=null,this._pipeline=null,this._device=null,this._framebuffer=null,this._cmdBuff=null,this._clearColors=null,this._clearDepth=1,this._clearStencil=0,this._renderArea=null,this._pass=null,this._pso=null}return J(e,[{key:"initialize",value:function(e){return void 0!==e.name&&(this._name=e.name),this._priority=e.priority,e.framebuffer&&(this.frameBuffer=e.framebuffer),e.renderQueues&&(this.renderQueues=e.renderQueues),!0}},{key:"activate",value:function(e){if(this._flow=e,this._pipeline=e.pipeline,this._device=e.device,!this._flow.pipeline.root.device)throw new Error("");this._device=this._flow.pipeline.root.device,this._clearColors=[{r:.3,g:.6,b:.9,a:1}],this._renderArea={x:0,y:0,width:0,height:0};for(var t=0;t<this.renderQueues.length;t++){for(var i=0,n=0;n<this.renderQueues[t].stages.length;n++)i|=gh(this.renderQueues[t].stages[n]);var r=Xb;switch(this.renderQueues[t].sortMode){case uT.BACK_TO_FRONT:r=Vb;break;case uT.FRONT_TO_BACK:r=Xb}this._renderQueues[t]=new cT({isTransparent:this.renderQueues[t].isTransparent,phases:i,sortFunc:r})}"window"===this.frameBuffer?this._framebuffer=this._flow.pipeline.root.mainWindow.framebuffer:this._framebuffer=this._flow.pipeline.getFrameBuffer(this.frameBuffer)}},{key:"setClearColor",value:function(e){this._clearColors.length>0?this._clearColors[0]=e:this._clearColors.push(e)}},{key:"setClearColors",value:function(e){this._clearColors=e}},{key:"setClearDepth",value:function(e){this._clearDepth=e}},{key:"setClearStencil",value:function(e){this._clearStencil=e}},{key:"setRenderArea",value:function(e,t){this._renderArea.width=e,this._renderArea.height=t}},{key:"sortRenderQueue",value:function(){this._renderQueues.forEach(this.renderQueueClearFunc);for(var e=this._pipeline.renderObjects,t=0;t<e.length;++t)for(var i=e[t],n=0;n<i.model.subModelNum;n++)for(var r=0;r<i.model.getSubModel(n).passes.length;r++)for(var a=0;a<this._renderQueues.length;a++)this._renderQueues[a].insertRenderPass(i,n,r);this._renderQueues.forEach(this.renderQueueSortFunc)}},{key:"executeCommandBuffer",value:function(e){var t=e.camera,i=this._cmdBuff,n=t.viewport;this._renderArea.x=n.x*t.width,this._renderArea.y=n.y*t.height,this._renderArea.width=n.width*t.width*this.pipeline.shadingScale,this._renderArea.height=n.height*t.height*this.pipeline.shadingScale,t.clearFlag&exports.GFXClearFlag.COLOR&&(hT[0].a=t.clearColor.a,hT[0].r=t.clearColor.r,hT[0].g=t.clearColor.g,hT[0].b=t.clearColor.b),this._framebuffer||(this._framebuffer=e.window.framebuffer),i.begin(),i.beginRenderPass(this._framebuffer,this._renderArea,t.clearFlag,hT,t.clearDepth,t.clearStencil);for(var r=0;r<this._renderQueues.length;r++)i.execute(this._renderQueues[r].cmdBuffs.array,this._renderQueues[r].cmdBuffCount);i.endRenderPass(),i.end(),pT[0]=i,this._device.queue.submit(pT)}},{key:"createCmdBuffer",value:function(){this._cmdBuff=this._device.createCommandBuffer({allocator:this._device.commandAllocator,type:exports.GFXCommandBufferType.PRIMARY})}},{key:"renderQueueClearFunc",value:function(e){e.clear()}},{key:"renderQueueSortFunc",value:function(e){e.sort()}},{key:"flow",get:function(){return this._flow}},{key:"pipeline",get:function(){return this._pipeline}},{key:"priority",get:function(){return this._priority}},{key:"framebuffer",get:function(){return this._framebuffer}}]),e}()).prototype,"_name",[$b],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return""}}),oT=de(rT.prototype,"_priority",[eT],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return 0}}),sT=de(rT.prototype,"frameBuffer",[tT],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return""}}),lT=de(rT.prototype,"renderQueues",[iT],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return[]}}),nT=rT))||nT);cc.RenderStage=AT;var OT,kT,RT,FT,MT,IT,PT,LT,DT,NT,zT,BT=(_T=Yo("RenderFlow"),fT=Ko({displayOrder:0,visible:!0}),dT=Ko({displayOrder:1,visible:!0}),mT=Ko({type:cc.Material,displayOrder:2,visible:!0}),vT=Ko({type:Lb,displayOrder:3,visible:!0}),yT=Ko({type:[AT],displayOrder:4,visible:!0}),_T((bT=de((xT=function(){function e(){Z(this,e),this._device=null,this._pipeline=null,fe(this,"_name",bT,this),fe(this,"_priority",TT,this),fe(this,"_material",ST,this),fe(this,"_type",ET,this),fe(this,"_stages",wT,this)}return J(e,[{key:"initialize",value:function(e){void 0!==e.name&&(this._name=e.name),this._priority=e.priority,e.material&&(this._material=e.material),e.type&&(this._type=e.type)}},{key:"activate",value:function(e){this._device=e.device,this._pipeline=e,this._activateStages()}},{key:"resize",value:function(e,t){for(var i=0;i<this._stages.length;i++)this._stages[i].resize(e,t)}},{key:"render",value:function(e){for(var t=0;t<this._stages.length;t++)this._stages[t].render(e)}},{key:"destroyStages",value:function(){for(var e=0;e<this._stages.length;e++)this._stages[e].destroy();this._stages=[]}},{key:"_activateStages",value:function(){for(var e=0;e<this._stages.length;e++)this._stages[e].activate(this);this._stages.sort((function(e,t){return e.priority-t.priority}))}},{key:"device",get:function(){return this._device}},{key:"pipeline",get:function(){return this._pipeline}},{key:"name",get:function(){return this._name}},{key:"priority",get:function(){return this._priority}},{key:"stages",get:function(){return this._stages}},{key:"material",get:function(){return this._material}},{key:"type",get:function(){return this._type}}]),e}()).prototype,"_name",[fT],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return""}}),TT=de(xT.prototype,"_priority",[dT],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return 0}}),ST=de(xT.prototype,"_material",[mT],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return null}}),ET=de(xT.prototype,"_type",[vT],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return Lb.SCENE}}),wT=de(xT.prototype,"_stages",[yT],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return[]}}),gT=xT))||gT);cc.RenderFlow=BT;var GT,UT,XT,VT,HT,WT=new Ii,jT=(OT=Yo("RenderPipeline"),kT=Ko({type:[BT],visible:!0}),RT=Ko({type:[Nb]}),FT=Ko({type:[zb]}),MT=Ko({type:[Ub]}),OT((LT=de((PT=function(){function e(){Z(this,e),this._root=null,this._device=null,this._renderObjects=[],fe(this,"_flows",LT,this),this._activeFlows=[],this._isHDRSupported=!1,this._isHDR=!1,this._lightMeterScale=1e4,this._fboCount=0,this._colorFmt=exports.GFXFormat.UNKNOWN,this._depthStencilFmt=exports.GFXFormat.UNKNOWN,this._shadingWidth=0,this._shadingHeight=0,this._shadingScale=1,this._curIdx="shading",this._prevIdx="shading1",this._usePostProcess=!1,this._useMSAA=!1,this._useSMAA=!1,this._quadVB=null,this._quadIB=null,this._quadIA=null,this._uboGlobal=new Cu,this._globalBindings=new Map,this._defaultTex=null,this._defaultTexView=null,this._fpScale=1/1024,this._fpScaleInv=1024,this._macros={},this._useDynamicBatching=!1,fe(this,"renderTextures",DT,this),fe(this,"framebuffers",NT,this),fe(this,"renderPasses",zT,this),this._renderTextures=new Map,this._textureViews=new Map,this._frameBuffers=new Map,this._renderPasses=new Map}return J(e,[{key:"getTextureView",value:function(e){return this._textureViews.get(e)}},{key:"getRenderTexture",value:function(e){return this._renderTextures.get(e)}},{key:"getFrameBuffer",value:function(e){return this._frameBuffers.get(e)}},{key:"initialize",value:function(e){this._usePostProcess=void 0!==e.enablePostProcess&&e.enablePostProcess,this._isHDR=void 0!==e.enableHDR&&e.enableHDR,this._useSMAA=void 0!==e.enableSMAA&&e.enableSMAA,this._useMSAA=void 0!==e.enableMSAA&&e.enableMSAA,e.renderTextures&&(this.renderTextures=e.renderTextures),e.framebuffers&&(this.framebuffers=e.framebuffers),e.renderPasses&&(this.renderPasses=e.renderPasses)}},{key:"activate",value:function(e){if(this._root=e,this._device=e.device,!this._initRenderResource())return console.error("RenderPipeline:"+this.name+" startup failed!"),!1;for(var t=0;t<this._flows.length;t++){var i=this._flows[t];i.type===Lb.SCENE&&(i.activate(this),this.activateFlow(i))}return!0}},{key:"render",value:function(e){for(var t=0;t<e.flows.length;t++)e.flows[t].render(e)}},{key:"rebuild",value:function(){this.updateMacros()}},{key:"resize",value:function(e,t){var i=Math.floor(e*this._shadingScale),n=Math.floor(t*this._shadingScale);(i>this._shadingWidth||n>this._shadingHeight)&&this.resizeFBOs(i,n);for(var r=0;r<this._flows.length;r++)this._flows[r].resize(e,t)}},{key:"swapFBOs",value:function(){var e=this._curIdx;this._curIdx=this._prevIdx,this._prevIdx=e}},{key:"addRenderPass",value:function(e,t){t&&this._renderPasses.set(e,t)}},{key:"getRenderPass",value:function(e){var t=this._renderPasses.get(e);return t||null}},{key:"removeRenderPass",value:function(e){this._renderPasses.delete(e)}},{key:"clearRenderPasses",value:function(){this._renderPasses.clear()}},{key:"destroyFlows",value:function(){for(var e=0;e<this._flows.length;e++)this._flows[e].destroy();this._flows=[]}},{key:"getFlow",value:function(e){for(var t=0;t<this._flows.length;t++)if(this._flows[t].name===e)return this._flows[t];return null}},{key:"updateMacros",value:function(){$c.destroyShaderByDefines(this._macros),this._macros.CC_USE_HDR=this._isHDR,this._macros.CC_SUPPORT_FLOAT_TEXTURE=this.device.hasFeature(exports.GFXFeature.TEXTURE_FLOAT);for(var e=0;e<this._root.scenes.length;e++)this._root.scenes[e].onGlobalPipelineStateChanged()}},{key:"updateUBOs",value:function(e){var t=e.camera,i=t.scene,n=this._root.device,r=i.mainLight,a=i.ambient,o=this._uboGlobal.view;o[Cu.TIME_OFFSET]=this._root.cumulativeTime,o[Cu.TIME_OFFSET+1]=this._root.frameTime,o[Cu.TIME_OFFSET+2]=cc.director.getTotalFrames(),o[Cu.SCREEN_SIZE_OFFSET]=n.width,o[Cu.SCREEN_SIZE_OFFSET+1]=n.height,o[Cu.SCREEN_SIZE_OFFSET+2]=1/o[Cu.SCREEN_SIZE_OFFSET],o[Cu.SCREEN_SIZE_OFFSET+3]=1/o[Cu.SCREEN_SIZE_OFFSET+1],o[Cu.SCREEN_SCALE_OFFSET]=t.width/this._shadingWidth*this._shadingScale,o[Cu.SCREEN_SCALE_OFFSET+1]=t.height/this._shadingHeight*this._shadingScale,o[Cu.SCREEN_SCALE_OFFSET+2]=1/o[Cu.SCREEN_SCALE_OFFSET],o[Cu.SCREEN_SCALE_OFFSET+3]=1/o[Cu.SCREEN_SCALE_OFFSET+1],o[Cu.NATIVE_SIZE_OFFSET]=this._shadingWidth,o[Cu.NATIVE_SIZE_OFFSET+1]=this._shadingHeight,o[Cu.NATIVE_SIZE_OFFSET+2]=1/o[Cu.NATIVE_SIZE_OFFSET],o[Cu.NATIVE_SIZE_OFFSET+3]=1/o[Cu.NATIVE_SIZE_OFFSET+1],Ki.toArray(o,t.matView,Cu.MAT_VIEW_OFFSET),Ki.toArray(o,t.node.worldMatrix,Cu.MAT_VIEW_INV_OFFSET),Ki.toArray(o,t.matProj,Cu.MAT_PROJ_OFFSET),Ki.toArray(o,t.matProjInv,Cu.MAT_PROJ_INV_OFFSET),Ki.toArray(o,t.matViewProj,Cu.MAT_VIEW_PROJ_OFFSET),Ki.toArray(o,t.matViewProjInv,Cu.MAT_VIEW_PROJ_INV_OFFSET),Ii.toArray(o,t.position,Cu.CAMERA_POS_OFFSET);var s=t.exposure;if(o[Cu.EXPOSURE_OFFSET]=s,o[Cu.EXPOSURE_OFFSET+1]=1/s,o[Cu.EXPOSURE_OFFSET+2]=this._isHDR?1:0,o[Cu.EXPOSURE_OFFSET+3]=this._fpScale/s,r){if(Ii.toArray(o,r.direction,Cu.MAIN_LIT_DIR_OFFSET),Ii.toArray(o,r.color,Cu.MAIN_LIT_COLOR_OFFSET),r.useColorTemperature){var l=r.colorTemperatureRGB;o[Cu.MAIN_LIT_COLOR_OFFSET]*=l.x,o[Cu.MAIN_LIT_COLOR_OFFSET+1]*=l.y,o[Cu.MAIN_LIT_COLOR_OFFSET+2]*=l.z}this._isHDR?o[Cu.MAIN_LIT_COLOR_OFFSET+3]=r.illuminance*this._fpScale:o[Cu.MAIN_LIT_COLOR_OFFSET+3]=r.illuminance*s}else Ii.toArray(o,Ii.UNIT_Z,Cu.MAIN_LIT_DIR_OFFSET),Ni.toArray(o,Ni.ZERO,Cu.MAIN_LIT_COLOR_OFFSET);var u=a.skyColor;this._isHDR?u[3]=a.skyIllum*this._fpScale:u[3]=a.skyIllum*s,this._uboGlobal.view.set(u,Cu.AMBIENT_SKY_OFFSET),this._uboGlobal.view.set(a.groundAlbedo,Cu.AMBIENT_GROUND_OFFSET),this._globalBindings.get(Cu.BLOCK.name).buffer.update(this._uboGlobal.view)}},{key:"sceneCulling",value:function(e){var t=e.camera,i=t.scene;this._renderObjects.length=0;var n=i.mainLight,r=i.planarShadows;n&&(n.update(),r.enabled&&n.node.hasChangedFlags&&r.updateDirLight(n)),i.skybox.enabled&&t.clearFlag&yv&&this.addVisibleModel(i.skybox,t);for(var a=i.models,o=cc.director.getTotalFrames(),s=0;s<a.length;s++){var l=a[s];if(l.enabled)if(e.visibility&bu.BitMask.UI_2D)(l.node&&e.visibility===l.node.layer||e.visibility===l.visFlags)&&(l.updateTransform(o),l.updateUBOs(o),this.addVisibleModel(l,t));else if(l.node&&(e.visibility&l.node.layer)===l.node.layer||e.visibility&l.visFlags){if(l.updateTransform(o),l.worldBounds&&!Ka.aabb_frustum(l.worldBounds,t.frustum))continue;l.updateUBOs(o),this.addVisibleModel(l,t)}}r.enabled&&r.updateCommandBuffers(t.frustum,o)}},{key:"_initRenderResource",value:function(){this._usePostProcess&&((this._device.hasFeature(exports.GFXFeature.FORMAT_R11G11B10F)||this._device.hasFeature(exports.GFXFeature.TEXTURE_HALF_FLOAT)||this._device.hasFeature(exports.GFXFeature.TEXTURE_FLOAT))&&(this._isHDRSupported=!0),this._fboCount=1,this._useMSAA&&(this._useMSAA=this.device.hasFeature(exports.GFXFeature.MSAA))),this._isHDR&&this._isHDRSupported&&(this._device.hasFeature(exports.GFXFeature.COLOR_HALF_FLOAT)&&this._device.hasFeature(exports.GFXFeature.TEXTURE_HALF_FLOAT_LINEAR)?this._device.hasFeature(exports.GFXFeature.FORMAT_R11G11B10F)?(this._colorFmt=exports.GFXFormat.R11G11B10F,this._isHDR=!0):this._device.hasFeature(exports.GFXFeature.TEXTURE_HALF_FLOAT)&&(this._colorFmt=exports.GFXFormat.RGBA16F,this._isHDR=!0):this._device.hasFeature(exports.GFXFeature.COLOR_FLOAT)&&this._device.hasFeature(exports.GFXFeature.TEXTURE_FLOAT_LINEAR)&&this._device.hasFeature(exports.GFXFeature.TEXTURE_FLOAT)&&(this._colorFmt=exports.GFXFormat.RGBA32F,this._isHDR=!0)),this._isHDR||(this._colorFmt=exports.GFXFormat.RGBA8),24===this._device.depthBits?8===this._device.stencilBits?this._depthStencilFmt=exports.GFXFormat.D24S8:this._depthStencilFmt=exports.GFXFormat.D24:this._depthStencilFmt=exports.GFXFormat.D16,this._shadingScale=1,this._shadingWidth=Math.floor(this._device.width),this._shadingHeight=Math.floor(this._device.height),console.info("USE_POST_PROCESS: "+this._usePostProcess),this._usePostProcess&&(console.info("USE_MSAA: "+this._useMSAA),console.info("USE_SMAA: "+this._useSMAA),console.info("USE_HDR: "+this._isHDR)),console.info("SHADING_SIZE: "+this._shadingWidth+" x "+this._shadingHeight),console.info("SHADING_SCALE: "+this._shadingScale.toFixed(4)),console.info("SHADING_COLOR_FORMAT: "+yr[this._colorFmt].name),console.info("SHADING_DEPTH_FORMAT: "+yr[this._depthStencilFmt].name);for(var e=0;e<this.renderTextures.length;e++){var t=this.renderTextures[e];this._renderTextures.set(t.name,this._device.createTexture({type:t.type,usage:t.usage,format:this._getTextureFormat(t.format,t.usage),width:-1===t.width?this._shadingWidth:t.width,height:-1===t.height?this._shadingHeight:t.height}));var i=this._renderTextures.get(t.name);if(null==i)return console.error("RenderTexture:"+t.name+" not found!"),!1;this._textureViews.set(t.name,this._device.createTextureView({texture:i,type:t.viewType,format:this._getTextureFormat(t.format,t.usage)}))}for(var n=0;n<this.renderPasses.length;n++){var r=this.renderPasses[n];this._renderPasses.set(r.index,this._device.createRenderPass({colorAttachments:r.colorAttachments,depthStencilAttachment:r.depthStencilAttachment}))}for(var a=0;a<this.framebuffers.length;a++){var o=this.framebuffers[a],s=this._renderPasses.get(o.renderPass);if(null==s)return console.error("RenderPass:"+o.renderPass+" not found!"),!1;for(var l=[],u=0;u<o.colorViews.length;u++){var c=this._textureViews.get(o.colorViews[u]);if(null==c)return console.error("TextureView:"+o.colorViews[u]+" not found!"),!1;l.push(c)}var h=this._textureViews.get(o.depthStencilView);this._frameBuffers.set(o.name,this._device.createFramebuffer({renderPass:s,colorViews:l,depthStencilView:h}))}if(!this.createQuadInputAssembler())return!1;if(!this.createUBOs())return!1;var p=this._root.mainWindow,_=null;return p&&(_=p.renderPass),_?(this.addRenderPass(Tu.DEFAULT,_),this.updateMacros(),!0):(console.error("RenderPass of main window is null."),!1)}},{key:"_destroy",value:function(){this.destroyFlows(),this.clearRenderPasses(),this.destroyQuadInputAssembler(),this.destroyUBOs();for(var e=this._renderTextures.values(),t=e.next();!t.done;)t.value.destroy(),t=e.next();for(var i=this._textureViews.values(),n=i.next();!n.done;)n.value.destroy(),n=i.next();for(var r=this._renderPasses.values(),a=r.next();!a.done;)a.value.destroy(),a=r.next();for(var o=this._frameBuffers.values(),s=o.next();!s.done;)s.value.destroy(),s=o.next()}},{key:"resizeFBOs",value:function(e,t){var i=this;this._shadingWidth=e,this._shadingHeight=t;for(var n=0;n<this.renderTextures.length;n++){var r=this.renderTextures[n];this._renderTextures.get(r.name).resize(e,t),this._textureViews.get(r.name).destroy(),this._textureViews.get(r.name).initialize({texture:this._renderTextures.get(r.name),type:r.viewType,format:this._getTextureFormat(r.format,r.usage)})}for(var a=0;a<this.framebuffers.length;a++){var o=this.framebuffers[a];this._frameBuffers.get(o.name).destroy(),this._frameBuffers.get(o.name).initialize({renderPass:this._renderPasses.get(o.renderPass),colorViews:o.colorViews.map((function(e){return i._textureViews.get(e)}),this),depthStencilView:this._textureViews.get(o.depthStencilView)})}console.info("Resizing shading fbos: "+this._shadingWidth+"x"+this._shadingHeight)}},{key:"createQuadInputAssembler",value:function(){var e=4*Float32Array.BYTES_PER_ELEMENT,t=4*e;if(this._quadVB=this._device.createBuffer({usage:exports.GFXBufferUsageBit.VERTEX|exports.GFXBufferUsageBit.TRANSFER_DST,memUsage:exports.GFXMemoryUsageBit.HOST|exports.GFXMemoryUsageBit.DEVICE,size:t,stride:e}),!this._quadVB)return!1;var i=new Float32Array(16),n=0;i[n++]=-1,i[n++]=-1,i[n++]=0,i[n++]=0,i[n++]=1,i[n++]=-1,i[n++]=1,i[n++]=0,i[n++]=-1,i[n++]=1,i[n++]=0,i[n++]=1,i[n++]=1,i[n++]=1,i[n++]=1,i[n++]=1,this._quadVB.update(i);var r=Uint8Array.BYTES_PER_ELEMENT,a=6*r;if(this._quadIB=this._device.createBuffer({usage:exports.GFXBufferUsageBit.INDEX|exports.GFXBufferUsageBit.TRANSFER_DST,memUsage:exports.GFXMemoryUsageBit.HOST|exports.GFXMemoryUsageBit.DEVICE,size:a,stride:r}),!this._quadIB)return!1;var o=new Uint8Array(6);o[0]=0,o[1]=1,o[2]=2,o[3]=1,o[4]=3,o[5]=2,this._quadIB.update(o);var s=[{name:"a_position",format:exports.GFXFormat.RG32F},{name:"a_texCoord",format:exports.GFXFormat.RG32F}];return this._quadIA=this._device.createInputAssembler({attributes:s,vertexBuffers:[this._quadVB],indexBuffer:this._quadIB}),!0}},{key:"destroyQuadInputAssembler",value:function(){this._quadVB&&(this._quadVB.destroy(),this._quadVB=null),this._quadIB&&(this._quadIB.destroy(),this._quadIB=null),this._quadIA&&(this._quadIA.destroy(),this._quadIA=null)}},{key:"createUBOs",value:function(){if(!this._globalBindings.get(Cu.BLOCK.name)){var e=this._root.device.createBuffer({usage:exports.GFXBufferUsageBit.UNIFORM|exports.GFXBufferUsageBit.TRANSFER_DST,memUsage:exports.GFXMemoryUsageBit.HOST|exports.GFXMemoryUsageBit.DEVICE,size:Cu.SIZE});this._globalBindings.set(Cu.BLOCK.name,{type:exports.GFXBindingType.UNIFORM_BUFFER,blockInfo:Cu.BLOCK,buffer:e})}if(!this._globalBindings.get(Au.BLOCK.name)){var t=this._root.device.createBuffer({usage:exports.GFXBufferUsageBit.UNIFORM|exports.GFXBufferUsageBit.TRANSFER_DST,memUsage:exports.GFXMemoryUsageBit.HOST|exports.GFXMemoryUsageBit.DEVICE,size:Au.SIZE});this._globalBindings.set(Au.BLOCK.name,{type:exports.GFXBindingType.UNIFORM_BUFFER,blockInfo:Au.BLOCK,buffer:t})}return this._globalBindings.get(Ou.name)||this._globalBindings.set(Ou.name,{type:exports.GFXBindingType.SAMPLER,samplerInfo:Ou}),!0}},{key:"destroyUBOs",value:function(){var e=this._globalBindings.get(Cu.BLOCK.name);e&&(e.buffer.destroy(),this._globalBindings.delete(Cu.BLOCK.name));var t=this._globalBindings.get(Au.BLOCK.name);t&&(t.buffer.destroy(),this._globalBindings.delete(Au.BLOCK.name))}},{key:"addVisibleModel",value:function(e,t){var i=0;e.node&&(Ii.subtract(WT,e.node.worldPosition,t.position),i=Ii.dot(WT,t.forward)),this._renderObjects.push({model:e,depth:i})}},{key:"activateFlow",value:function(e){this._activeFlows.push(e),this._activeFlows.sort((function(e,t){return e.priority-t.priority}))}},{key:"_getTextureFormat",value:function(e,t){return e===exports.GFXFormat.UNKNOWN?t&exports.GFXTextureUsageBit.COLOR_ATTACHMENT?this._colorFmt:t&exports.GFXTextureUsageBit.DEPTH_STENCIL_ATTACHMENT?this._depthStencilFmt:exports.GFXFormat.UNKNOWN:e}},{key:"root",get:function(){return this._root}},{key:"device",get:function(){return this._device}},{key:"name",get:function(){return it.getClassName(this.constructor)}},{key:"renderObjects",get:function(){return this._renderObjects}},{key:"flows",get:function(){return this._flows}},{key:"activeFlows",get:function(){return this._activeFlows}},{key:"usePostProcess",get:function(){return this._usePostProcess}},{key:"isHDRSupported",get:function(){return this._isHDRSupported}},{key:"isHDR",get:function(){return this._isHDR}},{key:"shadingScale",get:function(){return this._shadingScale}},{key:"lightMeterScale",set:function(e){this._lightMeterScale=e},get:function(){return this._lightMeterScale}},{key:"useMSAA",get:function(){return this._useMSAA}},{key:"useSMAA",get:function(){return this._useSMAA}},{key:"quadIA",get:function(){return this._quadIA}},{key:"globalBindings",get:function(){return this._globalBindings}},{key:"defaultTexture",get:function(){return this._defaultTex}},{key:"fpScale",get:function(){return this._fpScale}},{key:"fpScaleInv",get:function(){return this._fpScaleInv}},{key:"macros",get:function(){return this._macros}},{key:"defaultGlobalUBOData",get:function(){return this._uboGlobal.view}},{key:"currShading",get:function(){return this._curIdx}},{key:"prevShading",get:function(){return this._prevIdx}},{key:"useDynamicBatching",get:function(){return this._useDynamicBatching}}]),e}()).prototype,"_flows",[kT],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return[]}}),DT=de(PT.prototype,"renderTextures",[RT],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return[]}}),NT=de(PT.prototype,"framebuffers",[FT],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return[]}}),zT=de(PT.prototype,"renderPasses",[MT],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return[]}}),IT=PT))||IT);cc.RenderPipeline=jT;var qT=(GT=Yo("cc.RenderPipelineAsset"),UT=Ko({type:jT}),GT((HT=de((VT=function(e){function t(){var e,i;Z(this,t);for(var n=arguments.length,r=new Array(n),a=0;a<n;a++)r[a]=arguments[a];return fe(i=re(this,(e=te(t)).call.apply(e,[this].concat(r))),"renderPipeline",HT,ne(i)),i}return ee(t,zl),t}()).prototype,"renderPipeline",[UT],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return null}}),XT=VT))||XT);cc.RenderPipelineAsset=qT,exports.replaceProperty(rc.prototype,"Mesh.prototype",[{name:"renderingMesh",newName:"renderingSubMeshes"}]),exports.removeProperty(rc.prototype,"Mesh.prototype",[{name:"hasFlatBuffers"},{name:"destroyFlatBuffers"}]),cc.textureUtil=lv;var YT,KT={topLeft:cc.v2(0,0),topRight:cc.v2(0,0),top:cc.v2(0,0),bottomLeft:cc.v2(0,0),bottomRight:cc.v2(0,0),bottom:cc.v2(0,0),center:cc.v2(0,0),left:cc.v2(0,0),right:cc.v2(0,0),width:0,height:0,init:function(e){var t=this.width=e.width,i=this.height=e.height,n=e.x,r=e.y,a=r+i,o=n+t;this.topLeft.x=n,this.topLeft.y=a,this.topRight.x=o,this.topRight.y=a,this.top.x=n+t/2,this.top.y=a,this.bottomLeft.x=n,this.bottomLeft.y=r,this.bottomRight.x=o,this.bottomRight.y=r,this.bottom.x=n+t/2,this.bottom.y=r,this.center.x=n+t/2,this.center.y=r+i/2,this.left.x=n,this.left.y=r+i/2,this.right.x=o,this.right.y=r+i/2}};cc.visibleRect=KT,function(e){e[e.GENERAL=100]="GENERAL"}(YT||(YT={}));var ZT,QT=function(){function e(t,i){Z(this,e),this._root=void 0,this._name="",this._window=null,this._priority=0,this._visibility=Xu,this._camera=void 0,this._isEnable=!1,this._flows=[],this._root=t,this._camera=i}return J(e,[{key:"name",get:function(){return this._name}},{key:"window",get:function(){return this._window},set:function(e){this._window=e}},{key:"priority",get:function(){return this._priority},set:function(e){this._priority=e,cc.director.root&&cc.director.root.sortViews()}},{key:"visibility",set:function(e){this._visibility=e},get:function(){return this._visibility}},{key:"camera",get:function(){return this._camera}},{key:"isEnable",get:function(){return this._isEnable}},{key:"flows",get:function(){return this._flows}}],[{key:"registerCreateFunc",value:function(t){t._createViewFun=function(t,i){return new e(t,i)}}}]),J(e,[{key:"initialize",value:function(e){return this._name=e.name,this.priority=e.priority,this.setExecuteFlows(e.flows),!0}},{key:"destroy",value:function(){this._window=null,this._priority=0}},{key:"enable",value:function(e){this._isEnable=e}},{key:"setExecuteFlows",value:function(e){if(this.flows.length=0,e&&1===e.length&&"UIFlow"===e[0])this._flows.push(cc.director.root.pipeline.getFlow("UIFlow"));else for(var t=cc.director.root.pipeline.activeFlows,i=0;i<t.length;++i){var n=t[i];(n.type===Lb.SCENE||e&&-1!==e.indexOf(n.name))&&this.flows.push(n)}}}]),e}();function JT(e,t){t<1e3?t=1e3:t>15e3&&(t=15e3);var i=t*t,n=(.860117757+.000154118254*t+1.28641212e-7*i)/(1+.000842420235*t+7.08145163e-7*i),r=(.317398726+422806245e-13*t+4.20481691e-8*i)/(1-289741816e-13*t+1.61456053e-7*i),a=2*n-8*r+4,o=3*n/a,s=2*r/a,l=1/s*o,u=1/s*(1-o-s);e.x=3.2404542*l-1.5371385+-.4985314*u,e.y=-.969266*l+1.8760108+.041556*u,e.z=.0556434*l-.2040259+1.0572252*u}!function(e){e[e.DIRECTIONAL=0]="DIRECTIONAL",e[e.SPHERE=1]="SPHERE",e[e.SPOT=2]="SPOT",e[e.UNKNOWN=3]="UNKNOWN"}(ZT||(ZT={}));var $T=function(e){return 4*Math.PI*Math.PI*e*e},eS=function(){function e(){Z(this,e),this._color=new Ii(1,1,1),this._useColorTemp=!1,this._colorTemp=6550,this._colorTempRGB=new Ii(1,1,1),this._scene=null,this._node=null,this._type=void 0,this._name=null,this._type=ZT.UNKNOWN}return J(e,[{key:"color",set:function(e){this._color.set(e)},get:function(){return this._color}},{key:"useColorTemperature",set:function(e){this._useColorTemp=e},get:function(){return this._useColorTemp}},{key:"colorTemperature",set:function(e){this._colorTemp=e,JT(this._colorTempRGB,this._colorTemp)},get:function(){return this._colorTemp}},{key:"colorTemperatureRGB",get:function(){return this._colorTempRGB}},{key:"node",set:function(e){this._node=e,this._node&&(this._node.hasChangedFlags|=rh.ROTATION)},get:function(){return this._node}},{key:"type",get:function(){return this._type}},{key:"name",get:function(){return this._name}},{key:"scene",get:function(){return this._scene}}]),J(e,[{key:"initialize",value:function(e,t){this._name=e,this._type=ZT.UNKNOWN,this._node=t}},{key:"attachToScene",value:function(e){this._scene=e}},{key:"detachFromScene",value:function(){this._scene=null}},{key:"destroy",value:function(){this._name=null,this._type=ZT.UNKNOWN,this._node=null}},{key:"update",value:function(){}}]),e}();function tS(e,t){return!(!t.worldBounds||Ka.aabb_aabb(t.worldBounds,e.aabb))}function iS(e,t){return!(!t.worldBounds||Ka.aabb_aabb(t.worldBounds,e.aabb)&&Ka.aabb_frustum(t.worldBounds,e.frustum))}(nS=new mo).accurate=!0;var nS,rS,aS,oS=function(){var e=new Ii,t=new Ii,i=new Xi,n=new mo;n.accurate=!0;var r=new Ki,a=new Ki,o=new Ii,s=new Ii;return function(l,u,c,h,p,_){Ki.fromRT(r,c.node.getWorldRotation(i),u.node.getWorldPosition(e)),Ki.invert(a,r),u.getSplitFrustum(n,h,p),n.transform(a),Ii.set(o,n.vertices[0].x,n.vertices[0].y,n.vertices[0].z),Ii.copy(s,o);for(var f=1;f<n.vertices.length;f++)o.x=Math.min(o.x,n.vertices[f].x),o.y=Math.min(o.y,n.vertices[f].y),o.z=Math.min(o.z,n.vertices[f].z),s.x=Math.max(s.x,n.vertices[f].x),s.y=Math.max(s.y,n.vertices[f].y),s.z=Math.max(s.z,n.vertices[f].z);Ii.set(t,(o.x+s.x)/2,(o.y+s.y)/2,s.z),t.z+=_,Ii.transformMat4(e,t,r),Ki.fromRT(r,c.node.getWorldRotation(i),e),mo.createOrtho(l,s.x-o.x,s.y-o.y,0,o.z-_-s.z,r)}}();!function(e){e[e.FORWARD=0]="FORWARD"}(rS||(rS={})),function(e){e[e.FORWARD=0]="FORWARD",e[e.UI=10]="UI"}(aS||(aS={}));var sS=[],lS=[],uS=function(e){function t(){return Z(this,t),re(this,te(t).apply(this,arguments))}return ee(t,AT),J(t,[{key:"activate",value:function(e){oe(te(t.prototype),"activate",this).call(this,e),this._cmdBuff=this._device.createCommandBuffer({allocator:this._device.commandAllocator,type:exports.GFXCommandBufferType.PRIMARY})}},{key:"destroy",value:function(){this._cmdBuff&&(this._cmdBuff.destroy(),this._cmdBuff=null)}},{key:"resize",value:function(e,t){}},{key:"rebuild",value:function(){}},{key:"render",value:function(e){this._renderQueues[0].clear();for(var t,i=_e(this._pipeline.renderObjects);!(t=i()).done;)for(var n=t.value,r=0;r<n.model.subModelNum;r++)for(var a=0;a<n.model.getSubModel(r).passes.length;a++)this._renderQueues[0].insertRenderPass(n,r,a);this._renderQueues[0].sort();var o=e.window.framebuffer,s=this._cmdBuff,l=e.camera,u=l.viewport;this._renderArea.x=u.x*l.width,this._renderArea.y=u.y*l.height,this._renderArea.width=u.width*l.width,this._renderArea.height=u.height*l.height,lS[0]=l.clearColor,s.begin(),s.beginRenderPass(o,this._renderArea,l.clearFlag,[l.clearColor],l.clearDepth,l.clearStencil),s.execute(this._renderQueues[0].cmdBuffs.array,this._renderQueues[0].cmdBuffCount),s.endRenderPass(),s.end(),sS[0]=s,this._device.queue.submit(sS)}}]),t}();uS.initInfo={name:"UIStage",priority:0,renderQueues:[{isTransparent:!0,stages:["default"],sortMode:uT.BACK_TO_FRONT}],framebuffer:"window"};var cS=function(e){function t(){return Z(this,t),re(this,te(t).apply(this,arguments))}return ee(t,BT),J(t,[{key:"initialize",value:function(e){oe(te(t.prototype),"initialize",this).call(this,e);var i=new uS;return i.initialize(uS.initInfo),this._stages.push(i),!0}},{key:"destroy",value:function(){this.destroyStages()}},{key:"rebuild",value:function(){}},{key:"render",value:function(e){e.camera.update(),this.pipeline.sceneCulling(e),this.pipeline.updateUBOs(e);var i=this.pipeline.defaultGlobalUBOData[Cu.EXPOSURE_OFFSET+2];this.pipeline.defaultGlobalUBOData[Cu.EXPOSURE_OFFSET+2]=0,this.pipeline.globalBindings.get(Cu.BLOCK.name).buffer.update(this.pipeline.defaultGlobalUBOData),oe(te(t.prototype),"render",this).call(this,e),this.pipeline.defaultGlobalUBOData[Cu.EXPOSURE_OFFSET+2]=i,this.pipeline.globalBindings.get(Cu.BLOCK.name).buffer.update(this.pipeline.defaultGlobalUBOData)}}]),t}();cS.initInfo={name:"UIFlow",priority:aS.UI,type:Lb.UI};var hS,pS,_S,fS,dS,mS,vS,yS,gS,xS,bS,TS,SS,ES,wS,CS=function(){function e(){Z(this,e),this.queue=new Set}return J(e,[{key:"clear",value:function(){for(var e=this.queue.values(),t=e.next();!t.done;)t.value.clear(),t=e.next();this.queue.clear()}},{key:"recordCommandBuffer",value:function(e){for(var t=this.queue.values(),i=t.next();!i.done;){for(var n=!1,r=0;r<i.value.batches.length;++r){var a=i.value.batches[r];if(a.mergeCount){for(var o=0;o<a.vbs.length;++o)a.vbs[o].update(a.vbDatas[o]);a.vbIdx.update(a.vbIdxData.buffer),a.ubo.update(a.uboData.view),n||(e.bindPipelineState(a.pso),n=!0),e.bindBindingLayout(a.pso.pipelineLayout.layouts[0]),e.bindInputAssembler(a.ia),e.draw(a.ia)}}i=t.next()}}}]),e}(),AS=function(){function e(){Z(this,e),this.queue=new Set}return J(e,[{key:"clear",value:function(){for(var e=this.queue.values(),t=e.next();!t.done;)t.value.clear(),t=e.next();this.queue.clear()}},{key:"recordCommandBuffer",value:function(e){for(var t=this.queue.values(),i=t.next();!i.done;){var n=i.value.instances;if(n.length>0){i.value.uploadBuffers();for(var r=0;r<n.length;++r){var a=n[r];a.count&&(e.bindPipelineState(a.pso),e.bindBindingLayout(a.pso.pipelineLayout.layouts[0]),e.bindInputAssembler(a.ia),e.draw(a.ia))}}i=t.next()}}}]),e}(),OS=[{r:0,g:0,b:0,a:1}],kS=[],RS=Yo("ForwardStage")((_S=pS=function(e){function t(){var e;return Z(this,t),(e=re(this,te(t).call(this)))._opaqueBatchedQueue=void 0,e._opaqueInstancedQueue=void 0,e._opaqueBatchedQueue=new CS,e._opaqueInstancedQueue=new AS,e}return ee(t,AT),J(t,[{key:"activate",value:function(e){oe(te(t.prototype),"activate",this).call(this,e),this.createCmdBuffer()}},{key:"destroy",value:function(){this._cmdBuff&&(this._cmdBuff.destroy(),this._cmdBuff=null)}},{key:"resize",value:function(e,t){}},{key:"rebuild",value:function(){}},{key:"render",value:function(e){this._opaqueInstancedQueue.clear(),this._opaqueBatchedQueue.clear(),this._renderQueues.forEach(this.renderQueueClearFunc);for(var t=this._pipeline.renderObjects,i=0;i<t.length;++i){var n=t[i];if(n.model.isDynamicBatching)for(var r=n.model.subModels,a=0;a<r.length;++a)for(var o=r[a],s=o.passes,l=0;l<s.length;++l){var u=s[l],c=o.psos[l];if(u.instancedBuffer)u.instancedBuffer.merge(o,n.model.instancedAttributes,c),this._opaqueInstancedQueue.queue.add(u.instancedBuffer);else if(u.batchedBuffer)u.batchedBuffer.merge(o,n,c),this._opaqueBatchedQueue.queue.add(u.batchedBuffer);else for(var h=0;h<this._renderQueues.length;h++)this._renderQueues[h].insertRenderPass(n,a,l)}else for(var p=0;p<n.model.subModelNum;p++)for(var _=0;_<n.model.getSubModel(p).passes.length;_++)for(var f=0;f<this._renderQueues.length;f++)this._renderQueues[f].insertRenderPass(n,p,_)}this._renderQueues.forEach(this.renderQueueSortFunc);var d,m,v=e.camera,y=this._cmdBuff,g=v.viewport;if(this._renderArea.x=g.x*v.width,this._renderArea.y=g.y*v.height,this._renderArea.width=g.width*v.width*this.pipeline.shadingScale,this._renderArea.height=g.height*v.height*this.pipeline.shadingScale,v.clearFlag&exports.GFXClearFlag.COLOR)if(this._pipeline.isHDR){d=OS[0],m=v.clearColor,d.r=m.r*m.r,d.g=m.g*m.g,d.b=m.b*m.b;var x=this._pipeline.fpScale/v.exposure;OS[0].r*=x,OS[0].g*=x,OS[0].b*=x}else OS[0].r=v.clearColor.r,OS[0].g=v.clearColor.g,OS[0].b=v.clearColor.b;OS[0].a=v.clearColor.a,this._pipeline.usePostProcess?this._pipeline.useMSAA?this._framebuffer=this._pipeline.getFrameBuffer("msaa"):this._framebuffer=this._pipeline.getFrameBuffer(this._pipeline.currShading):this._framebuffer=e.window.framebuffer;var b=v.scene.planarShadows;y.begin(),y.beginRenderPass(this._framebuffer,this._renderArea,v.clearFlag,OS,v.clearDepth,v.clearStencil),y.execute(this._renderQueues[0].cmdBuffs.array,this._renderQueues[0].cmdBuffCount),this._opaqueInstancedQueue.recordCommandBuffer(y),this._opaqueBatchedQueue.recordCommandBuffer(y),v.visibility&bu.BitMask.DEFAULT&&b.recordCommandBuffer(y),y.execute(this._renderQueues[1].cmdBuffs.array,this._renderQueues[1].cmdBuffCount),y.endRenderPass(),y.end(),kS[0]=y,this._device.queue.submit(kS),this._pipeline.useMSAA&&this._device.blitFramebuffer(this._framebuffer,this._pipeline.getFrameBuffer(this._pipeline.currShading),this._renderArea,this._renderArea,exports.GFXFilter.POINT)}}]),t}(),pS.initInfo={name:"ForwardStage",priority:rS.FORWARD,renderQueues:[{isTransparent:!1,sortMode:uT.FRONT_TO_BACK,stages:["default"]},{isTransparent:!0,sortMode:uT.BACK_TO_FRONT,stages:["default","planarShadow"]}]},hS=_S))||hS,FS=Yo("ForwardFlow")((mS=dS=function(e){function t(){return Z(this,t),re(this,te(t).apply(this,arguments))}return ee(t,BT),J(t,[{key:"initialize",value:function(e){oe(te(t.prototype),"initialize",this).call(this,e);var i=new RS;i.initialize(RS.initInfo),this._stages.push(i)}},{key:"render",value:function(e){e.camera.update(),this.pipeline.sceneCulling(e),this.pipeline.updateUBOs(e),oe(te(t.prototype),"render",this).call(this,e)}},{key:"destroy",value:function(){this.destroyStages()}},{key:"rebuild",value:function(){}}]),t}(),dS.initInfo={name:"ForwardFlow",priority:aS.FORWARD},fS=mS))||fS,MS=[],IS=Yo("ToneMapStage")((gS=yS=function(e){function t(){var e,i;Z(this,t);for(var n=arguments.length,r=new Array(n),a=0;a<n;a++)r[a]=arguments[a];return(i=re(this,(e=te(t)).call.apply(e,[this].concat(r))))._hTexSampler=0,i._hBlendTexSampler=0,i._bindingLayout=null,i}return ee(t,AT),J(t,[{key:"activate",value:function(e){oe(te(t.prototype),"activate",this).call(this,e),this._createCmdBuffer(),this.rebuild()}},{key:"destroy",value:function(){this._cmdBuff&&(this._cmdBuff.destroy(),this._cmdBuff=null)}},{key:"resize",value:function(e,t){}},{key:"rebuild",value:function(){this._pass=this._flow.material.passes[0],this._hTexSampler=this._pass.getBinding("u_texSampler");var e=this._pipeline.globalBindings.get(Cu.BLOCK.name);this._pso=this._pass.createPipelineState(),this._bindingLayout=this._pso.pipelineLayout.layouts[0],this._pass.bindBuffer(Cu.BLOCK.binding,e.buffer),this._pass.bindTextureView(this._hTexSampler,this._pipeline.getTextureView(this._pipeline.currShading)),this._pipeline.useSMAA&&(this._hBlendTexSampler=this._pass.getBinding("u_blendTexSampler"),this._pass.bindTextureView(this._hBlendTexSampler,this._pipeline.getTextureView("smaaBlend"))),this._pass.update(),this._bindingLayout.update()}},{key:"render",value:function(e){var t=e.camera;if(this._cmdBuff){this._renderArea.width=t.width,this._renderArea.height=t.height;var i=e.window.framebuffer;this._cmdBuff.begin(),this._cmdBuff.beginRenderPass(i,this._renderArea,exports.GFXClearFlag.ALL,[{r:0,g:0,b:0,a:1}],1,0),this._cmdBuff.bindPipelineState(this._pso),this._cmdBuff.bindBindingLayout(this._pso.pipelineLayout.layouts[0]),this._cmdBuff.bindInputAssembler(this._pipeline.quadIA),this._cmdBuff.draw(this._pipeline.quadIA),this._cmdBuff.endRenderPass(),this._cmdBuff.end()}MS[0]=this._cmdBuff,this._device.queue.submit(MS)}},{key:"_createCmdBuffer",value:function(){this._cmdBuff=this._device.createCommandBuffer({allocator:this._device.commandAllocator,type:exports.GFXCommandBufferType.PRIMARY})}}]),t}(),yS.initInfo={name:"ToneMapStage",priority:0,framebuffer:"window"},vS=gS))||vS,PS=Yo("ToneMapFlow")((TS=bS=function(e){function t(){return Z(this,t),re(this,te(t).apply(this,arguments))}return ee(t,BT),J(t,[{key:"initialize",value:function(e){oe(te(t.prototype),"initialize",this).call(this,e),this._material.recompileShaders({CC_USE_SMAA:this._pipeline.useSMAA});var i=new IS;return i.initialize(IS.initInfo),this._stages.push(i),!0}},{key:"destroy",value:function(){this._material&&this._material.destroy(),this.destroyStages()}},{key:"rebuild",value:function(){this._material&&this._material.recompileShaders({CC_USE_SMAA:this._pipeline.useSMAA});for(var e,t=_e(this._stages);!(e=t()).done;){e.value.rebuild()}}}]),t}(),bS.initInfo={name:"ToneMapFlow",priority:aS.FORWARD+1},xS=TS))||xS,LS=new Float32Array(4),DS=Fn.create(0,0,0,1),NS=[],zS=[],BS=new Ii,GS=Yo("ForwardPipeline")((wS=ES=function(e){function t(){var e;return Z(this,t),(e=re(this,te(t).call(this)))._uboLights=new Mu,e._lightsUBO=null,e._validLights=void 0,e._lightIndexOffset=void 0,e._lightIndices=void 0,e._validLights=[],e._lightIndexOffset=[],e._lightIndices=[],e}return ee(t,jT),J(t,[{key:"lightsUBO",get:function(){return this._lightsUBO}}]),J(t,[{key:"initialize",value:function(e){oe(te(t.prototype),"initialize",this).call(this,e);var i=new FS;i.initialize(FS.initInfo),this._flows.push(i)}},{key:"activate",value:function(e){if(!oe(te(t.prototype),"activate",this).call(this,e))return!1;if(this._usePostProcess){this._useSMAA;var i=new PS;i.initialize(FS.initInfo),this._flows.push(i),i.activate(this)}var n=new cS;return n.initialize(cS.initInfo),this._flows.push(n),n.activate(this),!0}},{key:"destroy",value:function(){this._destroy()}},{key:"rebuild",value:function(){oe(te(t.prototype),"rebuild",this).call(this);for(var e=0;e<this._flows.length;e++)this._flows[e].rebuild()}},{key:"updateUBOs",value:function(e){oe(te(t.prototype),"updateUBOs",this).call(this,e);for(var i=e.camera.exposure,n=0;n<this._renderObjects.length;n++){this._uboLights.view.fill(0);var r=n+1<this._renderObjects.length?this._lightIndexOffset[n+1]:this._lightIndices.length;if(this._renderObjects[n].model.lightBuffer&&!this._renderObjects[n].model.isDynamicBatching){for(var a=0,o=0,s=this._lightIndexOffset[n];s<r;s++){var l=this._validLights[this._lightIndices[s]];if(l)switch(l.type){case ZT.SPHERE:if(a>=Mu.MAX_SPHERE_LIGHTS)continue;var u=l;if(Ii.toArray(LS,u.position),this._uboLights.view.set(LS,Mu.SPHERE_LIGHT_POS_OFFSET+4*a),LS[0]=u.size,LS[1]=u.range,LS[2]=0,this._uboLights.view.set(LS,Mu.SPHERE_LIGHT_SIZE_RANGE_OFFSET+4*a),Ii.toArray(LS,l.color),l.useColorTemperature){var c=l.colorTemperatureRGB;LS[0]*=c.x,LS[1]*=c.y,LS[2]*=c.z}this._isHDR?LS[3]=u.luminance*this._fpScale*this._lightMeterScale:LS[3]=u.luminance*i*this._lightMeterScale,this._uboLights.view.set(LS,Mu.SPHERE_LIGHT_COLOR_OFFSET+4*a),a++;break;case ZT.SPOT:if(o>=Mu.MAX_SPOT_LIGHTS)continue;var h=l;if(Ii.toArray(LS,h.position),LS[3]=h.size,this._uboLights.view.set(LS,Mu.SPOT_LIGHT_POS_OFFSET+4*o),LS[0]=h.size,LS[1]=h.range,LS[2]=h.spotAngle,this._uboLights.view.set(LS,Mu.SPOT_LIGHT_SIZE_RANGE_ANGLE_OFFSET+4*o),Ii.toArray(LS,h.direction),this._uboLights.view.set(LS,Mu.SPOT_LIGHT_DIR_OFFSET+4*o),Ii.toArray(LS,l.color),l.useColorTemperature){var p=l.colorTemperatureRGB;LS[0]*=p.x,LS[1]*=p.y,LS[2]*=p.z}this._isHDR?LS[3]=h.luminance*this._fpScale*this._lightMeterScale:LS[3]=h.luminance*i*this._lightMeterScale,this._uboLights.view.set(LS,Mu.SPOT_LIGHT_COLOR_OFFSET+4*o),o++}}this._renderObjects[n].model.lightBuffer.update(this._uboLights.view)}}}},{key:"sceneCulling",value:function(e){oe(te(t.prototype),"sceneCulling",this).call(this,e),this._validLights.length=0;for(var i=e.camera.scene.sphereLights,n=0;n<i.length;n++){var r=i[n];r.update(),Fn.set(DS,r.position.x,r.position.y,r.position.z,r.range),Ka.sphere_frustum(DS,e.camera.frustum)&&this._validLights.push(r)}for(var a=e.camera.scene.spotLights,o=0;o<a.length;o++){var s=a[o];s.update(),Fn.set(DS,s.position.x,s.position.y,s.position.z,s.range),Ka.sphere_frustum(DS,e.camera.frustum)&&this._validLights.push(s)}if(this._lightIndexOffset.length=this._lightIndices.length=0,this._validLights.length)for(var l=0;l<this._renderObjects.length;l++)this._lightIndexOffset[l]=this._lightIndices.length,this._renderObjects[l].model.lightBuffer&&this.cullLightPerModel(this._renderObjects[l].model)}},{key:"cullLightPerModel",value:function(e){NS.length=0;for(var t=0;t<this._validLights.length;t++){var i=!1;switch(this._validLights[t].type){case ZT.DIRECTIONAL:this._validLights[t],i=!1;break;case ZT.SPHERE:i=tS(this._validLights[t],e);break;case ZT.SPOT:i=iS(this._validLights[t],e)}i||(NS.push(t),this._validLights[t].type===ZT.DIRECTIONAL?zS[t]=0:zS[t]=Ii.distance(this._validLights[t].position,e.node.getWorldPosition(BS)))}NS.sort(this.sortLight),Array.prototype.push.apply(this._lightIndices,NS)}},{key:"sortLight",value:function(e,t){return zS[e]-zS[t]}}]),t}(),ES.initInfo={},SS=wS))||SS,US=Wu,XS=new ki,VS=function(){function e(t,i){var n=arguments.length>2&&void 0!==arguments[2]?arguments[2]:0;Z(this,e),this._point=new ki,this._prevPoint=new ki,this._lastModified=0,this._id=0,this._startPoint=new ki,this._startPointCaptured=!1,this.setTouchInfo(n,t,i)}return J(e,[{key:"lastModified",get:function(){return this._lastModified}}]),J(e,[{key:"getLocation",value:function(e){return e||(e=new ki),e.set(this._point.x,this._point.y),e}},{key:"getLocationX",value:function(){return this._point.x}},{key:"getLocationY",value:function(){return this._point.y}},{key:"getUILocation",value:function(e){return e||(e=new ki),e.set(this._point.x,this._point.y),cc.view._convertPointWithScale(e),e}},{key:"getUILocationX",value:function(){var e=cc.view.getViewportRect();return(this._point.x-e.x)/cc.view.getScaleX()}},{key:"getUILocationY",value:function(){var e=cc.view.getViewportRect();return(this._point.y-e.y)/cc.view.getScaleY()}},{key:"getPreviousLocation",value:function(e){return e||(e=new ki),e.set(this._prevPoint.x,this._prevPoint.y),e}},{key:"getUIPreviousLocation",value:function(e){return e||(e=new ki),e.set(this._prevPoint.x,this._prevPoint.y),cc.view._convertPointWithScale(e),e}},{key:"getStartLocation",value:function(e){return e||(e=new ki),e.set(this._startPoint.x,this._startPoint.y),e}},{key:"getUIStartLocation",value:function(e){return e||(e=new ki),e.set(this._startPoint.x,this._startPoint.y),cc.view._convertPointWithScale(e),e}},{key:"getDelta",value:function(e){return e||(e=new ki),e.set(this._point),e.subtract(this._prevPoint),e}},{key:"getUIDelta",value:function(e){return e||(e=new ki),XS.set(this._point),XS.subtract(this._prevPoint),e.set(cc.view.getScaleX(),cc.view.getScaleY()),ki.divide(e,XS,e),e}},{key:"getLocationInView",value:function(e){return e||(e=new ki),e.set(this._point.x,cc.view._designResolutionSize.height-this._point.y),e}},{key:"getPreviousLocationInView",value:function(e){return e||(e=new ki),e.set(this._prevPoint.x,cc.view._designResolutionSize.height-this._prevPoint.y),e}},{key:"getStartLocationInView",value:function(e){return e||(e=new ki),e.set(this._startPoint.x,cc.view._designResolutionSize.height-this._startPoint.y),e}},{key:"getID",value:function(){return this._id}},{key:"setTouchInfo",value:function(){var e=arguments.length>0&&void 0!==arguments[0]?arguments[0]:0,t=arguments.length>1?arguments[1]:void 0,i=arguments.length>2?arguments[2]:void 0;this._prevPoint=this._point,this._point=new ki(t||0,i||0),this._id=e,this._startPointCaptured||(this._startPoint=new ki(this._point),this._startPointCaptured=!0)}},{key:"setPoint",value:function(e,t){"object"===K(e)?(this._point.x=e.x,this._point.y=e.y):(this._point.x=e||0,this._point.y=t||0),this._lastModified=cc.director.getCurrentTime()}},{key:"setPrevPoint",value:function(e,t){"object"===K(e)?this._prevPoint=new ki(e.x,e.y):this._prevPoint=new ki(e||0,t||0),this._lastModified=cc.director.getCurrentTime()}}]),e}();cc.Touch=VS;var HS,WS=cu.TOUCH_TIMEOUT,jS=new ki,qS=new ki,YS=function e(){var t=arguments.length>0&&void 0!==arguments[0]?arguments[0]:0,i=arguments.length>1&&void 0!==arguments[1]?arguments[1]:0,n=arguments.length>2&&void 0!==arguments[2]?arguments[2]:0,r=arguments.length>3&&void 0!==arguments[3]?arguments[3]:0;Z(this,e),this.x=void 0,this.y=void 0,this.z=void 0,this.timestamp=void 0,this.x=t,this.y=i,this.z=n,this.timestamp=r};cc.internal.Acceleration=YS;var KS=new(function(){function e(){Z(this,e),this._mousePressed=!1,this._isRegisterEvent=!1,this._preTouchPoint=new ki,this._prevMousePoint=new ki,this._preTouchPool=[],this._preTouchPoolPointer=0,this._touches=[],this._touchesIntegerDict={},this._indexBitsUsed=0,this._maxTouches=8,this._accelEnabled=!1,this._accelInterval=.2,this._accelMinus=1,this._accelCurTime=0,this._acceleration=null,this._accelDeviceEvent=null,this._glView=null,this._pointLocked=!1}return J(e,[{key:"handleTouchesBegin",value:function(e){for(var t=[],i=this._touchesIntegerDict,n=0;n<e.length;++n){var r=e[n],a=r.getID();if(null!==a)if(void 0===i[a]){var o=this._getUnUsedIndex();if(-1===o){cc.logID(2300,o);continue}r.getLocation(jS);var s=new VS(jS.x,jS.y,a);this._touches[o]=s,r.getPreviousLocation(jS),s.setPrevPoint(jS),i[a]=o,t.push(s)}}if(t.length>0){var l=new Tv(t,!1,Tv.BEGAN);Pv.dispatchEvent(l)}}},{key:"handleTouchesMove",value:function(e){for(var t=[],i=this._touches,n=0;n<e.length;++n){var r=e[n],a=r.getID();if(null!==a){var o=this._touchesIntegerDict[a];void 0!==o&&i[o]&&(r.getLocation(jS),i[o].setPoint(jS),r.getPreviousLocation(jS),i[o].setPrevPoint(jS),t.push(i[o]))}}if(t.length>0){var s=new Tv(t,!1,Tv.MOVED);Pv.dispatchEvent(s)}}},{key:"handleTouchesEnd",value:function(e){var t=this.getSetOfTouchesEndOrCancel(e);if(t.length>0){var i=new Tv(t,!1,Tv.ENDED);Pv.dispatchEvent(i)}this._preTouchPool.length=0}},{key:"handleTouchesCancel",value:function(e){var t=this.getSetOfTouchesEndOrCancel(e);if(t.length>0){var i=new Tv(t,!1,Tv.CANCELLED);Pv.dispatchEvent(i)}this._preTouchPool.length=0}},{key:"getSetOfTouchesEndOrCancel",value:function(e){for(var t=[],i=this._touches,n=this._touchesIntegerDict,r=0;r<e.length;++r){var a=e[r],o=a.getID();if(null!==o){var s=n[o];void 0!==s&&i[s]&&(a.getLocation(jS),i[s].setPoint(jS),a.getPreviousLocation(jS),i[s].setPrevPoint(jS),t.push(i[s]),this._removeUsedIndexBit(s),delete n[o])}}return t}},{key:"getHTMLElementPosition",value:function(e){if(Cs.platform===Cs.WECHAT_GAME)return{left:0,top:0,width:window.innerWidth,height:window.innerHeight};var t=document.documentElement,i=Cs.os===Cs.OS_IOS&&Cs.isBrowser?window.screenLeft:window.pageXOffset;i-=t.clientLeft;var n=Cs.os===Cs.OS_IOS&&Cs.isBrowser?window.screenTop:window.pageYOffset;if(n-=t.clientTop,e.getBoundingClientRect){var r=e.getBoundingClientRect();return{left:r.left+i,top:r.top+n,width:r.width,height:r.height}}return e instanceof HTMLCanvasElement?{left:i,top:n,width:e.width,height:e.height}:{left:i,top:n,width:parseInt(e.style.width||"0",void 0),height:parseInt(e.style.height||"0",void 0)}}},{key:"getPreTouch",value:function(e){for(var t=null,i=this._preTouchPool,n=e.getID(),r=i.length-1;r>=0;r--)if(i[r].getID()===n){t=i[r];break}return t||(t=e),t}},{key:"setPreTouch",value:function(e){for(var t=!1,i=this._preTouchPool,n=e.getID(),r=i.length-1;r>=0;r--)if(i[r].getID()===n){i[r]=e,t=!0;break}t||(i.length<=50?i.push(e):(i[this._preTouchPoolPointer]=e,this._preTouchPoolPointer=(this._preTouchPoolPointer+1)%50))}},{key:"getTouchByXY",value:function(e,t,i,n){var r=this._preTouchPoint,a=this._glView.convertToLocationInView(t,i,n);this._pointLocked&&(a.x=r.x+e.movementX,a.y=r.y-e.movementY);var o=new VS(a.x,a.y,0);return o.setPrevPoint(r.x,r.y),r.x=a.x,r.y=a.y,o}},{key:"getMouseEvent",value:function(e,t,i){var n=this._prevMousePoint,r=new bv(i,!1,n);return n.x=e.x,n.y=e.y,this._glView._convertMouseToLocation(n,t),r.setLocation(n.x,n.y),r}},{key:"getPointByEvent",value:function(e,t){return null!=e.pageX?{x:e.pageX,y:e.pageY}:(Cs.platform===Cs.WECHAT_GAME?(t.left=0,t.top=0):(t.left-=document.body.scrollLeft,t.top-=document.body.scrollTop),{x:e.clientX,y:e.clientY})}},{key:"getTouchesByEvent",value:function(e,t){for(var i=[],n=this._glView,r=this._preTouchPoint,a=e.changedTouches.length,o=0;o<a;o++){var s=e.changedTouches[o];if(s){var l=void 0;l=Cs.BROWSER_TYPE_FIREFOX===Cs.browserType?n.convertToLocationInView(s.pageX,s.pageY,t,jS):n.convertToLocationInView(s.clientX,s.clientY,t,jS);var u=void 0;null!=s.identifier?(u=new VS(l.x,l.y,s.identifier),this.getPreTouch(u).getLocation(qS),u.setPrevPoint(qS.x,qS.y),this.setPreTouch(u)):(u=new VS(l.x,l.y)).setPrevPoint(r.x,r.y),r.x=l.x,r.y=l.y,i.push(u)}}return i}},{key:"registerSystemEvent",value:function(e){if(!this._isRegisterEvent&&e){this._glView=cc.view;var t=Cs.isMobile,i="mouse"in Cs.capabilities,n="touches"in Cs.capabilities;Cs.platform===Cs.WECHAT_GAME&&(t=!1,n=!0,i=!1),i&&this._registerMouseEvents(e,t),window.navigator.msPointerEnabled&&this._registerMousePointerEvents(e),n&&this._registerTouchEvents(e),this._registerKeyboardEvent(),this._isRegisterEvent=!0}}},{key:"setAccelerometerEnabled",value:function(e){if(this._accelEnabled!==e){this._accelEnabled=e;var t=cc.director.getScheduler();t.enableForTarget(this),this._accelEnabled?(this._registerAccelerometerEvent(),this._accelCurTime=0,t.scheduleUpdate(this)):(this._unregisterAccelerometerEvent(),this._accelCurTime=0,t.unscheduleUpdate(this))}}},{key:"didAccelerate",value:function(e){if(this._accelEnabled){var t=this._acceleration,i=0,n=0,r=0;if(this._accelDeviceEvent===window.DeviceMotionEvent){var a=e.accelerationIncludingGravity;a&&(i=this._accelMinus*(a.x||0)*.1,n=this._accelMinus*(a.y||0)*.1,r=.1*(a.z||0))}else{var o=e;i=(o.gamma||0)/90*.981,n=-(o.beta||0)/90*.981,r=(o.alpha||0)/90*.981}if(cc.view._isRotated){var s=i;i=-n,n=s}t.x=i,t.y=n,t.z=r,t.timestamp=e.timeStamp||Date.now();var l=t.x;90===window.orientation?(t.x=-t.y,t.y=l):-90===window.orientation?(t.x=t.y,t.y=-l):180===window.orientation&&(t.x=-t.x,t.y=-t.y),cc.sys.os===cc.sys.OS_ANDROID&&cc.sys.browserType!==cc.sys.BROWSER_TYPE_MOBILE_QQ&&(t.x=-t.x,t.y=-t.y)}}},{key:"update",value:function(e){this._accelCurTime>this._accelInterval&&(this._accelCurTime-=this._accelInterval,Pv.dispatchEvent(new Sv(this._acceleration))),this._accelCurTime+=e}},{key:"setAccelerometerInterval",value:function(e){this._accelInterval!==e&&(this._accelInterval=e)}},{key:"_getUnUsedIndex",value:function(){for(var e=this._indexBitsUsed,t=cc.director.getCurrentTime(),i=0;i<this._maxTouches;i++){if(!(1&e))return this._indexBitsUsed|=1<<i,i;var n=this._touches[i];if(t-n.lastModified>WS){this._removeUsedIndexBit(i);var r=n.getID();return null!==r&&delete this._touchesIntegerDict[r],i}e>>=1}return-1}},{key:"_removeUsedIndexBit",value:function(e){if(!(e<0||e>=this._maxTouches)){var t=1<<e;t=~t,this._indexBitsUsed&=t}}},{key:"_registerMouseEvents",value:function(e,t){this._registerPointerLockEvent(),t||this._registerWindowMouseEvents(e),this._registerElementMouseEvents(e,t)}},{key:"_registerPointerLockEvent",value:function(){var e=this,t=function(){var t=cc.game.canvas;document.pointerLockElement===t||document.mozPointerLockElement===t?e._pointLocked=!0:e._pointLocked=!1};"onpointerlockchange"in document?document.addEventListener("pointerlockchange",t,!1):"onmozpointerlockchange"in document&&document.addEventListener("mozpointerlockchange",t,!1)}},{key:"_registerWindowMouseEvents",value:function(e){var t=this;window.addEventListener("mousedown",(function(){t._mousePressed=!0}),!1),window.addEventListener("mouseup",(function(i){if(t._mousePressed){t._mousePressed=!1;var n=t.getHTMLElementPosition(e),r=t.getPointByEvent(i,n);if(!rn(n.left,n.top,n.width,n.height).contains(new ki(r.x,r.y))){t.handleTouchesEnd([t.getTouchByXY(i,r.x,r.y,n)]);var a=t.getMouseEvent(r,n,bv.UP);a.setButton(i.button),Pv.dispatchEvent(a)}}}),!1)}},{key:"_registerElementMouseEvents",value:function(e,t){var i=this,n=function(t,n,r){e.addEventListener(t,(function(t){var a=i.getHTMLElementPosition(e),o=i.getPointByEvent(t,a),s=i.getMouseEvent(o,a,n);s.setButton(t.button),r(t,s,o,a),Pv.dispatchEvent(s),t.stopPropagation(),t.preventDefault()}))};t||(n("mousedown",bv.DOWN,(function(t,n,r,a){i._mousePressed=!0,i.handleTouchesBegin([i.getTouchByXY(t,r.x,r.y,a)]),e.focus()})),n("mouseup",bv.UP,(function(e,t,n,r){i._mousePressed=!1,i.handleTouchesEnd([i.getTouchByXY(e,n.x,n.y,r)])})),n("mousemove",bv.MOVE,(function(e,t,n,r){i.handleTouchesMove([i.getTouchByXY(e,n.x,n.y,r)]),i._mousePressed||t.setButton(bv.BUTTON_MISSING),void 0!==e.movementX&&void 0!==e.movementY&&(t.movementX=e.movementX,t.movementY=e.movementY)}))),n("mousewheel",bv.SCROLL,(function(e,t,i,n){t.setScrollData(0,e.wheelDelta)})),n("DOMMouseScroll",bv.SCROLL,(function(e,t,i,n){t.setScrollData(0,-120*e.detail)}))}},{key:"_registerMousePointerEvents",value:function(e){var t=this,i={MSPointerDown:this.handleTouchesBegin,MSPointerMove:this.handleTouchesMove,MSPointerUp:this.handleTouchesEnd,MSPointerCancel:this.handleTouchesCancel},n=function(n){var r=i[n];e.addEventListener(n,(function(i){var n=t.getHTMLElementPosition(e);n.left-=document.documentElement.scrollLeft,n.top-=document.documentElement.scrollTop,r.call(t,[t.getTouchByXY(i,i.clientX,i.clientY,n)]),i.stopPropagation()}),!1)};for(var r in i)n(r)}},{key:"_registerTouchEvents",value:function(e){var t=this,i=function(i){return function(n){if(n.changedTouches){var r=t.getHTMLElementPosition(e),a=document.body;r.left-=a.scrollLeft||0,r.top-=a.scrollTop||0,i(t.getTouchesByEvent(n,r)),n.stopPropagation(),n.preventDefault()}}};e.addEventListener("touchstart",i((function(i){t.handleTouchesBegin(i),Cs.platform!==Cs.WECHAT_GAME&&e.focus()})),!1),e.addEventListener("touchmove",i((function(e){t.handleTouchesMove(e)})),!1),e.addEventListener("touchend",i((function(e){t.handleTouchesEnd(e)})),!1),e.addEventListener("touchcancel",i((function(e){t.handleTouchesCancel(e)})),!1)}},{key:"_registerKeyboardEvent",value:function(){var e=cc.game.canvas;e.addEventListener("keydown",(function(e){Pv.dispatchEvent(new Ev(e,!0)),e.stopPropagation(),e.preventDefault()}),!1),e.addEventListener("keyup",(function(e){Pv.dispatchEvent(new Ev(e,!1)),e.stopPropagation(),e.preventDefault()}),!1)}},{key:"_registerAccelerometerEvent",value:function(){var e=this;this._acceleration=new YS,this._accelDeviceEvent=window.DeviceMotionEvent||window.DeviceOrientationEvent,cc.sys.browserType===cc.sys.BROWSER_TYPE_MOBILE_QQ&&(this._accelDeviceEvent=window.DeviceOrientationEvent);var t=this._accelDeviceEvent===window.DeviceMotionEvent?"devicemotion":"deviceorientation";HS=function(){return e.didAccelerate.apply(e,arguments)},window.addEventListener(t,HS,!1)}},{key:"_unregisterAccelerometerEvent",value:function(){var e=this._accelDeviceEvent===window.DeviceMotionEvent?"devicemotion":"deviceorientation";HS&&window.removeEventListener(e,HS,!1)}}]),e}());cc.internal.inputManager=KS;var ZS=function(e){function t(){var e,i;Z(this,t);for(var n=arguments.length,r=new Array(n),a=0;a<n;a++)r[a]=arguments[a];return(i=re(this,(e=te(t)).call.apply(e,[this].concat(r)))).frame=null,i.container=null,i.canvas=null,i.renderType=-1,i.eventTargetOn=oe(te(t.prototype),"on",ne(i)),i.eventTargetOnce=oe(te(t.prototype),"once",ne(i)),i.config={},i.onStart=null,i._persistRootNodes={},i._paused=!0,i._configLoaded=!1,i._isCloning=!1,i._inited=!1,i._rendererInitialized=!1,i._gfxDevice=null,i._intervalId=null,i._lastTime=null,i._frameTime=null,i._sceneInfos=[],i.collisionMatrix=[],i.groupList=[],i}return ee(t,gl),J(t,[{key:"setFrameRate",value:function(e){var t=this.config;"number"!=typeof e&&(e=parseInt(e),isNaN(e)&&(e=60)),t.frameRate=e,this._paused=!0,this._setAnimFrame(),this._runMainLoop()}},{key:"getFrameRate",value:function(){return this.config.frameRate||0}},{key:"step",value:function(){cc.director.mainLoop()}},{key:"pause",value:function(){this._paused||(this._paused=!0,this._intervalId&&(window.cAF(this._intervalId),this._intervalId=0))}},{key:"resume",value:function(){this._paused&&(this._paused=!1,this._runMainLoop())}},{key:"isPaused",value:function(){return this._paused}},{key:"restart",value:function(){cc.director.once(cc.Director.EVENT_AFTER_DRAW,(function(){for(var e in cc.game._persistRootNodes)cc.game.removePersistRootNode(cc.game._persistRootNodes[e]);cc.director.getScene().destroy(),cc.Object._deferredDestroy(),cc.director.reset(),cc.game.onStart(),cc.game._safeEmit(cc.Game.EVENT_RESTART)}))}},{key:"end",value:function(){this._gfxDevice&&(this._gfxDevice.destroy(),this._gfxDevice=null),close()}},{key:"on",value:function(e,i,n,r){this._inited&&e===t.EVENT_ENGINE_INITED?i.call(n):this.eventTargetOn(e,i,n,r)}},{key:"once",value:function(e,i,n){this._inited&&e===t.EVENT_ENGINE_INITED?i.call(n):this.eventTargetOnce(e,i,n)}},{key:"init",value:function(e){return this._initConfig(e),this.config.assetOptions&&kd.init(this.config.assetOptions),this._initEngine(),cc.internal.SplashScreenWebgl&&this.canvas&&cc.internal.SplashScreenWebgl.instance.main(this.canvas),cc.director.root.dataPoolManager.jointTexturePool.registerCustomTextureLayouts(e.customJointTextureLayouts),this._inited}},{key:"run",value:function(e,i){var n=this;if(this._initEvents(),"function"!=typeof e&&i){var r=this.onStart;this.init(r),this.onStart=i}else this.onStart=e;this._setAnimFrame(),this._runMainLoop(),QS.config.registerSystemEvent&&KS.registerSystemEvent(QS.canvas);var a=cc.internal.SplashScreenWebgl&&cc.internal.SplashScreenWebgl.instance,o=a;o&&a.setOnFinish((function(){n.onStart&&n.onStart()}));var s=this.config.renderPipeline;s?cc.loader.load({uuid:s},(function(e,i){!e&&i instanceof jT?n.setRenderPipeline(i):(console.warn("Failed load renderpipeline: ".concat(s,", engine failed to initialize, all process stopped")),console.warn(e)),n._safeEmit(t.EVENT_GAME_INITED),o?a.loadFinish=!0:n.onStart&&n.onStart()})):(this._safeEmit(t.EVENT_GAME_INITED),o?a.loadFinish=!0:this.onStart&&this.onStart())}},{key:"addPersistRootNode",value:function(e){if(cc.Node.isNode(e)&&e.uuid){var t=e.uuid;if(!this._persistRootNodes[t]){var i=cc.director._scene;if(cc.isValid(i))if(e.parent){if(!(e.parent instanceof cc.Scene))return void g(3801);if(e.parent!==i)return void g(3802)}else e.parent=i;this._persistRootNodes[t]=e,e._persistNode=!0}}else g(3800)}},{key:"removePersistRootNode",value:function(e){var t=e.uuid||"";e===this._persistRootNodes[t]&&(delete this._persistRootNodes[t],e._persistNode=!1)}},{key:"isPersistRootNode",value:function(e){return e._persistNode}},{key:"_initEngine",value:function(){this._initDevice(),cc.director._init(),this.setRenderPipeline(),console.log("Cocos Creator 3D v"+cc.ENGINE_VERSION),this._safeEmit(t.EVENT_ENGINE_INITED),this._inited=!0}},{key:"_setAnimFrame",value:function(){this._lastTime=new Date;var e=cc.game.config.frameRate;this._frameTime=1e3/e,this._intervalId&&(window.cAF(this._intervalId),this._intervalId=0),60!==e&&30!==e?(window.rAF=this._stTime,window.cAF=this._ctTime):(window.rAF=window.requestAnimationFrame||window.webkitRequestAnimationFrame||window.mozRequestAnimationFrame||window.oRequestAnimationFrame||window.msRequestAnimationFrame||this._stTime,window.cAF=window.cancelAnimationFrame||window.cancelRequestAnimationFrame||window.msCancelRequestAnimationFrame||window.mozCancelRequestAnimationFrame||window.oCancelRequestAnimationFrame||window.webkitCancelRequestAnimationFrame||window.msCancelAnimationFrame||window.mozCancelAnimationFrame||window.webkitCancelAnimationFrame||window.ocancelAnimationFrame||this._ctTime)}},{key:"_stTime",value:function(e){var t=(new Date).getTime(),i=Math.max(0,cc.game._frameTime-(t-cc.game._lastTime)),n=window.setTimeout(e,i);return cc.game._lastTime=t+i,n}},{key:"_ctTime",value:function(e){window.clearTimeout(e)}},{key:"_runMainLoop",value:function(){var e,t=this,i=this.config,n=cc.director,r=!0,a=i.frameRate;A(!!i.showFPS),n.startAnimation(),e=function(i){t._paused||(t._intervalId=window.rAF(e),30===a&&(r=!r)||n.mainLoop(i))},this._intervalId&&(window.cAF(this._intervalId),this._intervalId=0),this._intervalId=window.rAF(e),this._paused=!1}},{key:"_initConfig",value:function(e){"number"!=typeof e.debugMode&&(e.debugMode=0),e.exposeClassName=!!e.exposeClassName,"number"!=typeof e.frameRate&&(e.frameRate=60);var t=e.renderMode;("number"!=typeof t||t>2||t<0)&&(e.renderMode=0),"boolean"!=typeof e.registerSystemEvent&&(e.registerSystemEvent=!0),e.showFPS=!!e.showFPS,this._sceneInfos=e.scenes||[],this.collisionMatrix=e.collisionMatrix||[],this.groupList=e.groupList||[],_(e.debugMode),this.config=e,this._configLoaded=!0}},{key:"_determineRenderType",value:function(){var e=this.config,i=parseInt(e.renderMode);this.renderType=t.RENDER_TYPE_CANVAS;var n=!1;if(0===i?cc.sys.capabilities.opengl?(this.renderType=t.RENDER_TYPE_WEBGL,n=!0):cc.sys.capabilities.canvas&&(this.renderType=t.RENDER_TYPE_CANVAS,n=!0):1===i&&cc.sys.capabilities.canvas?(this.renderType=t.RENDER_TYPE_CANVAS,n=!0):2===i&&cc.sys.capabilities.opengl&&(this.renderType=t.RENDER_TYPE_WEBGL,n=!0),!n)throw new Error(w(3820,i))}},{key:"_initDevice",value:function(){if(!this._rendererInitialized){if(this.canvas=this.config.adapter.canvas,this.frame=this.config.adapter.frame,this.container=this.config.adapter.container,this._determineRenderType(),this.renderType===t.RENDER_TYPE_WEBGL){var e=!!window.WebGL2RenderingContext,i=window.navigator.userAgent.toLowerCase();(-1!==i.indexOf("safari")&&-1===i.indexOf("chrome")||Cs.browserType===Cs.BROWSER_TYPE_UC)&&(e=!1),e&&cc.WebGL2GFXDevice?this._gfxDevice=new cc.WebGL2GFXDevice:cc.WebGLGFXDevice&&(this._gfxDevice=new cc.WebGLGFXDevice);var n={canvasElm:this.canvas,debug:!0,isAntialias:cu.ENABLE_WEBGL_ANTIALIAS,devicePixelRatio:window.devicePixelRatio,nativeWidth:Math.floor(screen.width*window.devicePixelRatio),nativeHeight:Math.floor(screen.height*window.devicePixelRatio)};!this._gfxDevice.initialize(n)&&e&&(this._gfxDevice=new cc.WebGLGFXDevice,this._gfxDevice.initialize(n))}if(!this._gfxDevice)return console.error("can not support canvas rendering in 3D"),void(this.renderType=t.RENDER_TYPE_CANVAS);this.canvas.oncontextmenu=function(){if(!cc._isContextMenuEnable)return!1}}}},{key:"_initEvents",value:function(){var e,i=window;void 0!==document.hidden?e="hidden":void 0!==document.mozHidden?e="mozHidden":void 0!==document.msHidden?e="msHidden":void 0!==document.webkitHidden&&(e="webkitHidden");var n=!1;function r(){n||(n=!0,cc.game.emit(t.EVENT_HIDE))}function a(){n&&(n=!1,cc.game.emit(t.EVENT_SHOW))}if(e)for(var o=["visibilitychange","mozvisibilitychange","msvisibilitychange","webkitvisibilitychange","qbrowserVisibilityChange"],s=0;s<o.length;s++)document.addEventListener(o[s],(function(t){var i=document[e];(i=i||t.hidden)?r():a()}));else i.addEventListener("blur",r),i.addEventListener("focus",a);window.navigator.userAgent.indexOf("MicroMessenger")>-1&&(i.onfocus=a),"onpageshow"in window&&"onpagehide"in window&&(i.addEventListener("pagehide",r),i.addEventListener("pageshow",a),document.addEventListener("pagehide",r),document.addEventListener("pageshow",a)),this.on(t.EVENT_HIDE,(function(){cc.game.pause()})),this.on(t.EVENT_SHOW,(function(){cc.game.resume()}))}},{key:"setRenderPipeline",value:function(e){e||(e=new GS).initialize(GS.initInfo),cc.director.root.setRenderPipeline(e)||this.setRenderPipeline(),this._rendererInitialized=!0,this._safeEmit(t.EVENT_RENDERER_INITED)}},{key:"_safeEmit",value:function(e){this.emit(e)}},{key:"inited",get:function(){return this._inited}}]),t}();ZS.EVENT_HIDE="game_on_hide",ZS.EVENT_SHOW="game_on_show",ZS.EVENT_GAME_INITED="game_inited",ZS.EVENT_ENGINE_INITED="engine_inited",ZS.EVENT_RENDERER_INITED="renderer_inited",ZS.EVENT_RESTART="game_on_restart",ZS.RENDER_TYPE_CANVAS=0,ZS.RENDER_TYPE_WEBGL=1,ZS.RENDER_TYPE_OPENGL=2,cc.Game=ZS;var QS=cc.game=new ZS,JS=new(function(){function e(){Z(this,e),this.html=void 0,this.meta={width:"device-width"},this.adaptationType=cc.sys.browserType}return J(e,[{key:"init",value:function(){}},{key:"availWidth",value:function(e){return cc.sys.isMobile||!e||e===this.html?window.innerWidth:e.clientWidth}},{key:"availHeight",value:function(e){return cc.sys.isMobile||!e||e===this.html?window.innerHeight:e.clientHeight}}]),e}());cc.sys.os===cc.sys.OS_IOS&&(JS.adaptationType=cc.sys.BROWSER_TYPE_SAFARI),JS.availWidth=function(){return window.innerWidth},JS.availHeight=function(){return window.innerHeight};var $S=function(e){function t(){var e;Z(this,t),(e=re(this,te(t).call(this)))._resizeWithBrowserSize=void 0,e._designResolutionSize=void 0,e._originalDesignResolutionSize=void 0,e._frameSize=void 0,e._scaleX=void 0,e._scaleY=void 0,e._viewportRect=void 0,e._visibleRect=void 0,e._autoFullScreen=void 0,e._devicePixelRatio=void 0,e._maxPixelRatio=void 0,e._retinaEnabled=void 0,e._resizeCallback=void 0,e._resizing=void 0,e._orientationChanging=void 0,e._isRotated=void 0,e._orientation=void 0,e._isAdjustViewport=void 0,e._antiAliasEnabled=void 0,e._resolutionPolicy=void 0,e._rpExactFit=void 0,e._rpShowAll=void 0,e._rpNoBorder=void 0,e._rpFixedHeight=void 0,e._rpFixedWidth=void 0;ne(e);var i=eE,n=tE;return e._frameSize=new en(0,0),e._designResolutionSize=new en(0,0),e._originalDesignResolutionSize=new en(0,0),e._scaleX=1,e._scaleY=1,e._viewportRect=new nn(0,0,0,0),e._visibleRect=new nn(0,0,0,0),e._autoFullScreen=!1,e._devicePixelRatio=1,e._maxPixelRatio=2,e._retinaEnabled=!1,e._resizeCallback=null,e._resizing=!1,e._resizeWithBrowserSize=!1,e._orientationChanging=!0,e._isRotated=!1,e._orientation=cc.macro.ORIENTATION_AUTO,e._isAdjustViewport=!0,e._antiAliasEnabled=!1,e._rpExactFit=new iE(i.EQUAL_TO_FRAME,n.EXACT_FIT),e._rpShowAll=new iE(i.EQUAL_TO_FRAME,n.SHOW_ALL),e._rpNoBorder=new iE(i.EQUAL_TO_FRAME,n.NO_BORDER),e._rpFixedHeight=new iE(i.EQUAL_TO_FRAME,n.FIXED_HEIGHT),e._rpFixedWidth=new iE(i.EQUAL_TO_FRAME,n.FIXED_WIDTH),e._resolutionPolicy=e._rpShowAll,cc.game.once(cc.Game.EVENT_ENGINE_INITED,e.init,ne(e)),e}return ee(t,gl),J(t,[{key:"init",value:function(){JS.init(),this._initFrameSize(),this.enableAntiAlias(!0);var e=cc.game.canvas.width,t=cc.game.canvas.height;this._designResolutionSize.width=e,this._designResolutionSize.height=t,this._originalDesignResolutionSize.width=e,this._originalDesignResolutionSize.height=t,this._viewportRect.width=e,this._viewportRect.height=t,this._visibleRect.width=e,this._visibleRect.height=t,cc.winSize.width=this._visibleRect.width,cc.winSize.height=this._visibleRect.height,cc.visibleRect&&cc.visibleRect.init(this._visibleRect)}},{key:"resizeWithBrowserSize",value:function(e){e?this._resizeWithBrowserSize||(this._resizeWithBrowserSize=!0,window.addEventListener("resize",this._resizeEvent),window.addEventListener("orientationchange",this._orientationChange)):this._resizeWithBrowserSize&&(this._resizeWithBrowserSize=!1,window.removeEventListener("resize",this._resizeEvent),window.removeEventListener("orientationchange",this._orientationChange))}},{key:"setResizeCallback",value:function(e){"function"!=typeof e&&null!=e||(this._resizeCallback=e)}},{key:"setOrientation",value:function(e){(e&=cc.macro.ORIENTATION_AUTO)&&this._orientation!==e&&(this._orientation=e)}},{key:"adjustViewportMeta",value:function(e){this._isAdjustViewport=e}},{key:"enableRetina",value:function(e){this._retinaEnabled=!!e}},{key:"isRetinaEnabled",value:function(){return this._retinaEnabled}},{key:"enableAntiAlias",value:function(e){if(this._antiAliasEnabled!==e)if(this._antiAliasEnabled=e,cc.game.renderType===cc.Game.RENDER_TYPE_WEBGL){var t=cc.loader._cache;for(var i in t){var n=t[i],r=n&&n.content instanceof cc.Texture2D?n.content:null;if(r){var a=cc.Texture2D.Filter;e?r.setFilters(a.LINEAR,a.LINEAR):r.setFilters(a.NEAREST,a.NEAREST)}}}else if(cc.game.renderType===cc.Game.RENDER_TYPE_CANVAS){var o=cc.game.canvas.getContext("2d");o.imageSmoothingEnabled=e,o.mozImageSmoothingEnabled=e}}},{key:"isAntiAliasEnabled",value:function(){return this._antiAliasEnabled}},{key:"enableAutoFullScreen",value:function(e){e&&e!==this._autoFullScreen&&cc.sys.isMobile&&cc.sys.browserType!==cc.sys.BROWSER_TYPE_WECHAT?(this._autoFullScreen=!0,cc.screen.autoFullScreen(cc.game.frame)):this._autoFullScreen=!1}},{key:"isAutoFullScreenEnabled",value:function(){return this._autoFullScreen}},{key:"setCanvasSize",value:function(e,t){var i=cc.game.canvas,n=cc.game.container;this._devicePixelRatio=window.devicePixelRatio,i.width=e*this._devicePixelRatio,i.height=t*this._devicePixelRatio,i.style.width=e+"px",i.style.height=t+"px",n.style.width=e+"px",n.style.height=t+"px",this._resizeEvent()}},{key:"getCanvasSize",value:function(){return new en(cc.game.canvas.width,cc.game.canvas.height)}},{key:"getFrameSize",value:function(){return new en(this._frameSize.width,this._frameSize.height)}},{key:"setFrameSize",value:function(e,t){this._frameSize.width=e,this._frameSize.height=t,cc.frame.style.width=e+"px",cc.frame.style.height=t+"px",this._resizeEvent()}},{key:"getVisibleSize",value:function(){return new en(this._visibleRect.width,this._visibleRect.height)}},{key:"getVisibleSizeInPixel",value:function(){return new en(this._visibleRect.width*this._scaleX,this._visibleRect.height*this._scaleY)}},{key:"getVisibleOrigin",value:function(){return new ki(this._visibleRect.x,this._visibleRect.y)}},{key:"getVisibleOriginInPixel",value:function(){return new ki(this._visibleRect.x*this._scaleX,this._visibleRect.y*this._scaleY)}},{key:"getResolutionPolicy",value:function(){return this._resolutionPolicy}},{key:"setResolutionPolicy",value:function(e){var t=this;if(e instanceof iE)t._resolutionPolicy=e;else{var i=iE;e===i.EXACT_FIT&&(t._resolutionPolicy=t._rpExactFit),e===i.SHOW_ALL&&(t._resolutionPolicy=t._rpShowAll),e===i.NO_BORDER&&(t._resolutionPolicy=t._rpNoBorder),e===i.FIXED_HEIGHT&&(t._resolutionPolicy=t._rpFixedHeight),e===i.FIXED_WIDTH&&(t._resolutionPolicy=t._rpFixedWidth)}}},{key:"setDesignResolutionSize",value:function(e,t,i){if(e>0||t>0){this.setResolutionPolicy(i);var n=this._resolutionPolicy;if(n&&n.preApply(this),cc.sys.isMobile&&this._adjustViewportMeta(),this._orientationChanging=!0,this._resizing||this._initFrameSize(),n){this._originalDesignResolutionSize.width=this._designResolutionSize.width=e,this._originalDesignResolutionSize.height=this._designResolutionSize.height=t;var r=n.apply(this,this._designResolutionSize);if(r.scale&&2===r.scale.length&&(this._scaleX=r.scale[0],this._scaleY=r.scale[1]),r.viewport){var a=this._viewportRect,o=this._visibleRect,s=r.viewport;a.x=s.x,a.y=s.y,a.width=s.width,a.height=s.height,o.x=0,o.y=0,o.width=s.width/this._scaleX,o.height=s.height/this._scaleY}n.postApply(this),cc.winSize.width=this._visibleRect.width,cc.winSize.height=this._visibleRect.height,KT&&KT.init(this._visibleRect),this.emit("design-resolution-changed")}else cc.logID(2201)}else cc.logID(2200)}},{key:"getDesignResolutionSize",value:function(){return new en(this._designResolutionSize.width,this._designResolutionSize.height)}},{key:"setRealPixelResolution",value:function(e,t,i){this.setDesignResolutionSize(e,t,i)}},{key:"getViewportRect",value:function(){return this._viewportRect}},{key:"getScaleX",value:function(){return this._scaleX}},{key:"getScaleY",value:function(){return this._scaleY}},{key:"getDevicePixelRatio",value:function(){return this._devicePixelRatio}},{key:"convertToLocationInView",value:function(e,t,i,n){var r=n||new ki,a=this._devicePixelRatio*(e-i.left),o=this._devicePixelRatio*(i.top+i.height-t);return this._isRotated?(r.x=cc.game.canvas.width-o,r.y=a):(r.x=a,r.y=o),r}},{key:"_convertPointWithScale",value:function(e){var t=this._viewportRect;e.x=(e.x-t.x)/this._scaleX,e.y=(e.y-t.y)/this._scaleY}},{key:"_resizeEvent",value:function(){var e=cc.view,t=e._frameSize.width,i=e._frameSize.height,n=e._isRotated;if(cc.sys.isMobile){var r=cc.game.container.style,a=r.margin;r.margin="0",r.display="none",e._initFrameSize(),r.margin=a,r.display="block"}else e._initFrameSize();if(e._orientationChanging||e._isRotated!==n||e._frameSize.width!==t||e._frameSize.height!==i){var o=e._originalDesignResolutionSize.width,s=e._originalDesignResolutionSize.height;e._resizing=!0,o>0&&e.setDesignResolutionSize(o,s,e._resolutionPolicy),e._resizing=!1,e._resizeCallback&&e._resizeCallback.call()}}},{key:"_orientationChange",value:function(){cc.view._orientationChanging=!0,cc.view._resizeEvent()}},{key:"_initFrameSize",value:function(){var e=this._frameSize,t=JS.availWidth(cc.game.frame),i=JS.availHeight(cc.game.frame),n=t>=i;!cc.sys.isMobile||n&&this._orientation&cc.macro.ORIENTATION_LANDSCAPE||!n&&this._orientation&cc.macro.ORIENTATION_PORTRAIT?(e.width=t,e.height=i,cc.game.container.style["-webkit-transform"]="rotate(0deg)",cc.game.container.style.transform="rotate(0deg)",this._isRotated=!1):(e.width=i,e.height=t,cc.game.container.style["-webkit-transform"]="rotate(90deg)",cc.game.container.style.transform="rotate(90deg)",cc.game.container.style["-webkit-transform-origin"]="0px 0px 0px",cc.game.container.style.transformOrigin="0px 0px 0px",this._isRotated=!0,cc.game.canvas.style["-webkit-transform"]="translateZ(0px)",cc.game.canvas.style.transform="translateZ(0px)"),this._orientationChanging&&setTimeout((function(){cc.view._orientationChanging=!1}),1e3)}},{key:"_adjustSizeKeepCanvasSize",value:function(){var e=this._originalDesignResolutionSize.width,t=this._originalDesignResolutionSize.height;e>0&&this.setDesignResolutionSize(e,t,this._resolutionPolicy)}},{key:"_setViewportMeta",value:function(e,t){var i=document.getElementById("cocosMetaElement");i&&t&&document.head.removeChild(i);var n,r,a,o=document.getElementsByName("viewport"),s=o?o[0]:null;for(r in n=s?s.content:"",(i=i||document.createElement("meta")).id="cocosMetaElement",i.name="viewport",i.content="",e)-1===n.indexOf(r)?n+=","+r+"="+e[r]:t&&(a=new RegExp(r+"s*=s*[^,]+"),n.replace(a,r+"="+e[r]));/^,/.test(n)&&(n=n.substr(1)),i.content=n,s&&(s.content=n),document.head.appendChild(i)}},{key:"_adjustViewportMeta",value:function(){this._isAdjustViewport,0}},{key:"_convertMouseToLocation",value:function(e,t){e.x=this._devicePixelRatio*(e.x-t.left),e.y=this._devicePixelRatio*(t.top+t.height-e.y)}},{key:"_convertTouchWidthScale",value:function(e){var t=this._viewportRect,i=this._scaleX,n=this._scaleY;e._point.x=(e._point.x-t.x)/i,e._point.y=(e._point.y-t.y)/n,e._prevPoint.x=(e._prevPoint.x-t.x)/i,e._prevPoint.y=(e._prevPoint.y-t.y)/n}},{key:"_convertTouchesWithScale",value:function(e){for(var t,i,n=this._viewportRect,r=this._scaleX,a=this._scaleY,o=0;o<e.length;o++){var s=e[o];t=s._point,i=s._prevPoint,t.x=(t.x-n.x)/r,t.y=(t.y-n.y)/a,i.x=(i.x-n.x)/r,i.y=(i.y-n.y)/a}}}]),t}();$S.instance=void 0;var eE=function(){function e(){Z(this,e),this.name="ContainerStrategy"}return J(e,[{key:"preApply",value:function(e){}},{key:"apply",value:function(e,t){}},{key:"postApply",value:function(e){}},{key:"_setupContainer",value:function(e,t,i){var n=cc.game.canvas,r=cc.game.container;cc.sys.platform!==cc.sys.WECHAT_GAME&&(cc.sys.os===cc.sys.OS_ANDROID&&(document.body.style.width=(e._isRotated?i:t)+"px",document.body.style.height=(e._isRotated?t:i)+"px"),r.style.width=n.style.width=t+"px",r.style.height=n.style.height=i+"px");var a=e._devicePixelRatio=1;e.isRetinaEnabled()&&(a=e._devicePixelRatio=Math.min(e._maxPixelRatio,window.devicePixelRatio||1)),n.width=t*a,n.height=i*a}},{key:"_fixContainer",value:function(){document.body.insertBefore(cc.game.container,document.body.firstChild);var e=document.body.style;e.width=window.innerWidth+"px",e.height=window.innerHeight+"px",e.overflow="hidden";var t=cc.game.container.style;t.position="fixed",t.left=t.top="0px",document.body.scrollTop=0}}]),e}();eE.EQUAL_TO_FRAME=void 0,eE.PROPORTION_TO_FRAME=void 0;var tE=function(){function e(){Z(this,e),this.name="ContentStrategy",this._result=void 0,this._result={scale:[1,1],viewport:null}}return J(e,[{key:"preApply",value:function(e){}},{key:"apply",value:function(e,t){return{scale:[1,1]}}},{key:"postApply",value:function(e){}},{key:"_buildResult",value:function(e,t,i,n,r,a){Math.abs(e-i)<2&&(i=e),Math.abs(t-n)<2&&(n=t);var o=new nn(Math.round((e-i)/2),Math.round((t-n)/2),i,n);return this._result.scale=[r,a],this._result.viewport=o,this._result}}]),e}();tE.EXACT_FIT=void 0,tE.SHOW_ALL=void 0,tE.NO_BORDER=void 0,tE.FIXED_HEIGHT=void 0,tE.FIXED_WIDTH=void 0,function(){var e=function(e){function t(){var e,i;Z(this,t);for(var n=arguments.length,r=new Array(n),a=0;a<n;a++)r[a]=arguments[a];return(i=re(this,(e=te(t)).call.apply(e,[this].concat(r)))).name="EqualToFrame",i}return ee(t,eE),J(t,[{key:"apply",value:function(e){var t=e._frameSize.height,i=cc.game.container.style;this._setupContainer(e,e._frameSize.width,e._frameSize.height),e._isRotated?i.margin="0 0 0 "+t+"px":i.margin="0px",i.padding="0px"}}]),t}(),t=function(e){function t(){var e,i;Z(this,t);for(var n=arguments.length,r=new Array(n),a=0;a<n;a++)r[a]=arguments[a];return(i=re(this,(e=te(t)).call.apply(e,[this].concat(r)))).name="ProportionalToFrame",i}return ee(t,eE),J(t,[{key:"apply",value:function(e,t){var i,n,r=e._frameSize.width,a=e._frameSize.height,o=cc.game.container.style,s=t.width,l=t.height,u=r/s,c=a/l;u<c?(i=r,n=l*u):(i=s*c,n=a);var h=Math.round((r-i)/2),p=Math.round((a-n)/2);i=r-2*h,n=a-2*p,this._setupContainer(e,i,n),e._isRotated?o.margin="0 0 0 "+a+"px":o.margin="0px",o.paddingLeft=h+"px",o.paddingRight=h+"px",o.paddingTop=p+"px",o.paddingBottom=p+"px"}}]),t}(),i=("undefined"==typeof window?global:window).__globalAdapter;i&&(i.adaptContainerStrategy&&i.adaptContainerStrategy(eE.prototype),i.adaptView&&i.adaptView($S.prototype)),eE.EQUAL_TO_FRAME=new e,eE.PROPORTION_TO_FRAME=new t;var n=function(e){function t(){var e,i;Z(this,t);for(var n=arguments.length,r=new Array(n),a=0;a<n;a++)r[a]=arguments[a];return(i=re(this,(e=te(t)).call.apply(e,[this].concat(r)))).name="ExactFit",i}return ee(t,tE),J(t,[{key:"apply",value:function(e,t){var i=cc.game.canvas.width,n=cc.game.canvas.height,r=i/t.width,a=n/t.height;return this._buildResult(i,n,i,n,r,a)}}]),t}(),r=function(e){function t(){var e,i;Z(this,t);for(var n=arguments.length,r=new Array(n),a=0;a<n;a++)r[a]=arguments[a];return(i=re(this,(e=te(t)).call.apply(e,[this].concat(r)))).name="ShowAll",i}return ee(t,tE),J(t,[{key:"apply",value:function(e,t){var i,n,r=cc.game.canvas.width,a=cc.game.canvas.height,o=t.width,s=t.height,l=r/o,u=a/s,c=0;return l<u?(i=r,n=s*(c=l)):(i=o*(c=u),n=a),this._buildResult(r,a,i,n,c,c)}}]),t}(),a=function(e){function t(){var e,i;Z(this,t);for(var n=arguments.length,r=new Array(n),a=0;a<n;a++)r[a]=arguments[a];return(i=re(this,(e=te(t)).call.apply(e,[this].concat(r)))).name="NoBorder",i}return ee(t,tE),J(t,[{key:"apply",value:function(e,t){var i,n,r,a=cc.game.canvas.width,o=cc.game.canvas.height,s=t.width,l=t.height,u=a/s,c=o/l;return u<c?(n=s*(i=c),r=o):(n=a,r=l*(i=u)),this._buildResult(a,o,n,r,i,i)}}]),t}(),o=function(e){function t(){var e,i;Z(this,t);for(var n=arguments.length,r=new Array(n),a=0;a<n;a++)r[a]=arguments[a];return(i=re(this,(e=te(t)).call.apply(e,[this].concat(r)))).name="FixedHeight",i}return ee(t,tE),J(t,[{key:"apply",value:function(e,t){var i=cc.game.canvas.width,n=cc.game.canvas.height,r=n/t.height,a=i,o=n;return this._buildResult(i,n,a,o,r,r)}}]),t}(),s=function(e){function t(){var e,i;Z(this,t);for(var n=arguments.length,r=new Array(n),a=0;a<n;a++)r[a]=arguments[a];return(i=re(this,(e=te(t)).call.apply(e,[this].concat(r)))).name="FixedWidth",i}return ee(t,tE),J(t,[{key:"apply",value:function(e,t){var i=cc.game.canvas.width,n=cc.game.canvas.height,r=i/t.width,a=i,o=n;return this._buildResult(i,n,a,o,r,r)}}]),t}();tE.EXACT_FIT=new n,tE.SHOW_ALL=new r,tE.NO_BORDER=new a,tE.FIXED_HEIGHT=new o,tE.FIXED_WIDTH=new s}();var iE=function(){function e(t,i){Z(this,e),this.name="ResolutionPolicy",this._containerStrategy=void 0,this._contentStrategy=void 0,this._containerStrategy=null,this._contentStrategy=null,this.setContainerStrategy(t),this.setContentStrategy(i)}return J(e,[{key:"preApply",value:function(e){this._containerStrategy.preApply(e),this._contentStrategy.preApply(e)}},{key:"apply",value:function(e,t){return this._containerStrategy.apply(e,t),this._contentStrategy.apply(e,t)}},{key:"postApply",value:function(e){this._containerStrategy.postApply(e),this._contentStrategy.postApply(e)}},{key:"setContainerStrategy",value:function(e){e instanceof eE&&(this._containerStrategy=e)}},{key:"setContentStrategy",value:function(e){e instanceof tE&&(this._contentStrategy=e)}},{key:"canvasSize",get:function(){return cc.v2(cc.game.canvas.width,cc.game.canvas.height)}}]),e}();iE.EXACT_FIT=0,iE.NO_BORDER=1,iE.SHOW_ALL=2,iE.FIXED_HEIGHT=3,iE.FIXED_WIDTH=4,iE.UNKNOWN=5,iE.ContainerStrategy=eE,iE.ContentStrategy=tE,cc.ResolutionPolicy=iE;var nE=$S.instance=cc.view=new $S;cc.winSize=new ki;var rE=null,aE=null,oE=null,sE=null,lE=function(e){function t(){return Z(this,t),re(this,te(t).call(this))}return ee(t,gl),J(t,[{key:"setAccelerometerEnabled",value:function(e){e&&window.DeviceMotionEvent&&"function"==typeof DeviceMotionEvent.requestPermission?DeviceMotionEvent.requestPermission().then((function(e){console.log("Device Motion Event request permission: ".concat(e)),KS.setAccelerometerEnabled("granted"===e)})):KS.setAccelerometerEnabled(e)}},{key:"setAccelerometerInterval",value:function(e){KS.setAccelerometerInterval(e)}},{key:"on",value:function(e,i,n,r){return oe(te(t.prototype),"on",this).call(this,e,i,n,r),e!==exports.SystemEventType.KEY_DOWN&&e!==exports.SystemEventType.KEY_UP||rE||(rE=wv.create({event:wv.KEYBOARD,onKeyPressed:function(e,t){t.type=exports.SystemEventType.KEY_DOWN,uE.emit(t.type,t)},onKeyReleased:function(e,t){t.type=exports.SystemEventType.KEY_UP,uE.emit(t.type,t)}}),Pv.addListener(rE,256)),e===exports.SystemEventType.DEVICEMOTION&&(aE||(aE=wv.create({event:wv.ACCELERATION,callback:function(e,t){t.type=exports.SystemEventType.DEVICEMOTION,cc.systemEvent.emit(t.type,t)}}),Pv.addListener(aE,256))),e!==exports.SystemEventType.TOUCH_START&&e!==exports.SystemEventType.TOUCH_MOVE&&e!==exports.SystemEventType.TOUCH_END&&e!==exports.SystemEventType.TOUCH_CANCEL||oE||(oE=wv.create({event:wv.TOUCH_ONE_BY_ONE,onTouchBegan:function(e,t){return t.type=exports.SystemEventType.TOUCH_START,cc.systemEvent.emit(t.type,e,t),!0},onTouchMoved:function(e,t){t.type=exports.SystemEventType.TOUCH_MOVE,cc.systemEvent.emit(t.type,e,t)},onTouchEnded:function(e,t){t.type=exports.SystemEventType.TOUCH_END,cc.systemEvent.emit(t.type,e,t)},onTouchCancelled:function(e,t){t.type=exports.SystemEventType.TOUCH_CANCEL,cc.systemEvent.emit(t.type,e,t)}}),Pv.addListener(oE,256)),e!==exports.SystemEventType.MOUSE_DOWN&&e!==exports.SystemEventType.MOUSE_MOVE&&e!==exports.SystemEventType.MOUSE_UP&&e!==exports.SystemEventType.MOUSE_WHEEL||sE||(sE=wv.create({event:wv.MOUSE,onMouseDown:function(e){e.type=exports.SystemEventType.MOUSE_DOWN,cc.systemEvent.emit(e.type,e)},onMouseMove:function(e){e.type=exports.SystemEventType.MOUSE_MOVE,cc.systemEvent.emit(e.type,e)},onMouseUp:function(e){e.type=exports.SystemEventType.MOUSE_UP,cc.systemEvent.emit(e.type,e)},onMouseScroll:function(e){e.type=exports.SystemEventType.MOUSE_WHEEL,cc.systemEvent.emit(e.type,e)}}),Pv.addListener(sE,256)),i}},{key:"off",value:function(e,i,n){if(oe(te(t.prototype),"off",this).call(this,e,i,n),rE&&(e===exports.SystemEventType.KEY_DOWN||e===exports.SystemEventType.KEY_UP)){var r=this.hasEventListener(exports.SystemEventType.KEY_DOWN),a=this.hasEventListener(exports.SystemEventType.KEY_UP);r||a||(Pv.removeListener(rE),rE=null)}if(aE&&e===exports.SystemEventType.DEVICEMOTION&&(Pv.removeListener(aE),aE=null),oE&&(e===exports.SystemEventType.TOUCH_START||e===exports.SystemEventType.TOUCH_MOVE||e===exports.SystemEventType.TOUCH_END||e===exports.SystemEventType.TOUCH_CANCEL)){var o=this.hasEventListener(exports.SystemEventType.TOUCH_START),s=this.hasEventListener(exports.SystemEventType.TOUCH_MOVE),l=this.hasEventListener(exports.SystemEventType.TOUCH_END),u=this.hasEventListener(exports.SystemEventType.TOUCH_CANCEL);o||s||l||u||(Pv.removeListener(oE),oE=null)}if(sE&&(e===exports.SystemEventType.MOUSE_DOWN||e===exports.SystemEventType.MOUSE_MOVE||e===exports.SystemEventType.MOUSE_UP||e===exports.SystemEventType.MOUSE_WHEEL)){var c=this.hasEventListener(exports.SystemEventType.MOUSE_DOWN),h=this.hasEventListener(exports.SystemEventType.MOUSE_MOVE),p=this.hasEventListener(exports.SystemEventType.MOUSE_UP),_=this.hasEventListener(exports.SystemEventType.MOUSE_WHEEL);c||h||p||_||(Pv.removeListener(sE),sE=null)}}}]),t}();lE.EventType=exports.SystemEventType,cc.SystemEvent=lE;var uE=new lE;cc.systemEvent=uE,exports.replaceProperty(exports.SystemEventType,"Node.EventType",[{name:"POSITION_PART",newName:"TRANSFORM_CHANGED"},{name:"ROTATION_PART",newName:"TRANSFORM_CHANGED"},{name:"SCALE_PART",newName:"TRANSFORM_CHANGED"}]);var cE={_supportsFullScreen:!1,_preOnFullScreenChange:null,_touchEvent:"",_fn:null,_fnMap:[["requestFullscreen","exitFullscreen","fullscreenchange","fullscreenEnabled","fullscreenElement"],["requestFullScreen","exitFullScreen","fullScreenchange","fullScreenEnabled","fullScreenElement"],["webkitRequestFullScreen","webkitCancelFullScreen","webkitfullscreenchange","webkitIsFullScreen","webkitCurrentFullScreenElement"],["mozRequestFullScreen","mozCancelFullScreen","mozfullscreenchange","mozFullScreen","mozFullScreenElement"],["msRequestFullscreen","msExitFullscreen","MSFullscreenChange","msFullscreenEnabled","msFullscreenElement"]],init:function(){this._fn={};var e,t,i,n,r=this._fnMap;for(e=0,t=r.length;e<t;e++)if((i=r[e])&&void 0!==document[i[1]]){for(e=0,n=i.length;e<n;e++)this._fn[r[0][e]]=i[e];break}this._supportsFullScreen=void 0!==this._fn.requestFullscreen,this._touchEvent="ontouchstart"in window?"touchstart":"mousedown"},fullScreen:function(){return!!this._supportsFullScreen&&(void 0!==document[this._fn.fullscreenElement]&&null!==document[this._fn.fullscreenElement])},requestFullScreen:function(e,t){if(this._supportsFullScreen){if(e=e||document.documentElement,t){var i=this._fn.fullscreenchange;this._preOnFullScreenChange&&document.removeEventListener(i,this._preOnFullScreenChange),this._preOnFullScreenChange=t,document.addEventListener(i,t,!1)}return e[this._fn.requestFullscreen]()}},exitFullScreen:function(){return!this._supportsFullScreen||document[this._fn.exitFullscreen]()},autoFullScreen:function(e,t){e=e||document.body;var i=cc.game.canvas||e,n=this;this.requestFullScreen(e,t),i.addEventListener(this._touchEvent,(function r(){i.removeEventListener(n._touchEvent,r),n.requestFullScreen(e,t)}))}};cE.init(),cc.screen=cE;var hE,pE,_E=0,fE={},dE=function(e){if(void 0===fE[e]){var t=1<<_E;fE[e]=t,_E+=1}};function mE(e){return--e,e|=e>>16,e|=e>>8,e|=e>>4,e|=e>>2,e|=e>>1,++e}function vE(e,t){return Math.ceil(e/t)*t}!function(e){e[e.OPAQUE=0]="OPAQUE",e[e.TRANSPARENT=1]="TRANSPARENT",e[e.OVERLAY=2]="OVERLAY"}(hE||(hE={})),function(e){e[e.DEFAULT=1]="DEFAULT",e[e.FORWARD=2]="FORWARD",e[e.SHADOWCAST=4]="SHADOWCAST"}(pE||(pE={}));var yE,gE,xE,bE,TE,SE,EE=function(){function e(t){Z(this,e),this._device=void 0,this._format=exports.GFXFormat.UNKNOWN,this._formatSize=0,this._chunks=[],this._chunkCount=0,this._handles=[],this._region0=new vr,this._region1=new vr,this._region2=new vr,this._roundUpFn=null,this._bufferViewCtor=Uint8Array,this._channels=4,this._alignment=1,this._device=t}return J(e,[{key:"initialize",value:function(e){var t=yr[e.format];this._format=e.format,this._formatSize=t.size,this._channels=t.count,this._bufferViewCtor=Sr(t),this._roundUpFn=e.roundUpFn||null,this._alignment=e.alignment||1,e.inOrderFree&&(this.alloc=this._McDonaldAlloc)}},{key:"destroy",value:function(){for(var e=0;e<this._chunkCount;++e){var t=this._chunks[e];t.texView.destroy(),t.texture.destroy()}this._chunks.length=0,this._handles.length=0}},{key:"alloc",value:function(e,t){e=vE(e,this._alignment);var i=-1,n=-1;if(void 0!==t&&(i=t,n=this._findAvailableSpace(e,i)),n<0)for(var r=0;r<this._chunkCount&&(i=r,!((n=this._findAvailableSpace(e,i))>=0));++r);if(n>=0){var a=this._chunks[i];a.start+=e;var o={chunkIdx:i,start:n,end:n+e,texture:a.texture,texView:a.texView};return this._handles.push(o),o}var s=Math.sqrt(e/this._formatSize),l=this._roundUpFn&&this._roundUpFn(s,this._formatSize)||Math.max(1024,mE(s)),u=this._chunks[this.createChunk(l)];u.start+=e;var c={chunkIdx:this._chunkCount-1,start:0,end:e,texture:u.texture,texView:u.texView};return this._handles.push(c),c}},{key:"free",value:function(e){for(var t=0;t<this._handles.length;++t)if(this._handles[t]===e)return this._chunks[e.chunkIdx].end=e.end,void this._handles.splice(t,1)}},{key:"createChunk",value:function(e){var t=e*e*this._formatSize;console.info("TextureBufferPool: Allocate chunk "+this._chunkCount+", size: "+t+", format: "+this._format);var i=this._device.createTexture({type:exports.GFXTextureType.TEX2D,usage:exports.GFXTextureUsageBit.SAMPLED,format:this._format,width:e,height:e,mipLevel:1}),n={texture:i,texView:this._device.createTextureView({texture:i,type:exports.GFXTextureViewType.TV2D,format:this._format}),size:t,start:0,end:t};return this._chunks[this._chunkCount]=n,this._chunkCount++}},{key:"update",value:function(e,t){var i=[],n=[],r=e.start/this._formatSize,a=t.byteLength/this._formatSize,o=r%e.texture.width,s=Math.floor(r/e.texture.width),l=Math.min(e.texture.width-o,a),u=0;o>0&&(this._region0.texOffset.x=o,this._region0.texOffset.y=s,this._region0.texExtent.width=l,this._region0.texExtent.height=1,i.push(new this._bufferViewCtor(t,u*this._formatSize,l*this._channels)),n.push(this._region0),o=0,s+=1,a-=l,u+=l),a>0&&(this._region1.texOffset.x=o,this._region1.texOffset.y=s,a>e.texture.width?(this._region1.texExtent.width=e.texture.width,this._region1.texExtent.height=Math.floor(a/e.texture.width),l=this._region1.texExtent.width*this._region1.texExtent.height):(l=a,this._region1.texExtent.width=l,this._region1.texExtent.height=1),i.push(new this._bufferViewCtor(t,u*this._formatSize,l*this._channels)),n.push(this._region1),o=0,s+=this._region1.texExtent.height,a-=l,u+=l),a>0&&(this._region2.texOffset.x=o,this._region2.texOffset.y=s,this._region2.texExtent.width=a,this._region2.texExtent.height=1,i.push(new this._bufferViewCtor(t,u*this._formatSize,a*this._channels)),n.push(this._region2)),this._device.copyBuffersToTexture(i,e.texture,n)}},{key:"_findAvailableSpace",value:function(e,t){var i=this._chunks[t],n=!1,r=i.start;if(r+e<=i.size)n=!0;else{r=0;for(var a=this._handles.filter((function(e){return e.chunkIdx===t})).sort((function(e,t){return e.start-t.start})),o=0;o<a.length;o++){var s=a[o];if(r+e<=s.start){n=!0;break}r=s.end}!n&&r+e<=i.size&&(n=!0)}return n?r:-1}},{key:"_McDonaldAlloc",value:function(e){e=vE(e,this._alignment);for(var t=0;t<this._chunkCount;++t){var i=this._chunks[t],n=!1,r=i.start;if(r+e<=i.end?n=!0:r>i.end?r+e<=i.size?n=!0:e<=i.end&&(i.start=r=0,n=!0):r===i.end&&(i.start=r=0,i.end=i.size,e<=i.end&&(n=!0)),n){i.start+=e;var a={chunkIdx:t,start:r,end:r+e,texture:i.texture,texView:i.texView};return this._handles.push(a),a}}var o=Math.sqrt(e/this._formatSize),s=this._roundUpFn&&this._roundUpFn(o,this._formatSize)||Math.max(1024,mE(o)),l=this._chunks[this.createChunk(s)];l.start+=e;var u={chunkIdx:this._chunkCount,start:0,end:e,texture:l.texture,texView:l.texView};return this._handles.push(u),u}}]),e}();function wE(e){return"string"==typeof e||"number"==typeof e}function CE(e,t){return e instanceof t}var AE=Yo("cc.animation.HierarchyPath")((xE=de((gE=function(){function e(t){Z(this,e),fe(this,"path",xE,this),this.path=t||""}return J(e,[{key:"get",value:function(e){if(!(e instanceof tg))return c("Target of hierarchy path should be of type Node."),null;var t=e.getChildByPath(this.path);return t||(c('Node "'.concat(e.name,'" has no path "').concat(this.path,'"')),null)}}]),e}()).prototype,"path",[Ko],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return""}}),yE=gE))||yE,OE=Yo("cc.animation.ComponentPath")((SE=de((TE=function(){function e(t){Z(this,e),fe(this,"component",SE,this),this.component=t||""}return J(e,[{key:"get",value:function(e){if(!(e instanceof tg))return c("Target of component path should be of type Node."),null;var t=e.getComponent(this.component);return t||(c('Node "'.concat(e.name,'" has no component "').concat(this.component,'"')),null)}}]),e}()).prototype,"component",[Ko],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return""}}),bE=TE))||bE;function kE(e){for(var t=e,i=0;i<(arguments.length<=1?0:arguments.length-1);++i){var n=i+1<1||arguments.length<=i+1?void 0:arguments[i+1];if(wE(n)){if(!(n in t))return c('Target object has no property "'.concat(n,'"')),null;t=t[n]}else t=n.get(t);if(null===t)break}return t}var RE=function(){function e(){Z(this,e)}return J(e,null,[{key:"getOrExtract",value:function(t){var i=e.pool.get(t);return i&&i.info.sample===t.sample||(i&&cc.director.root.dataPoolManager.releaseAnimationClip(t),i=function(e){var t={};e.curves.forEach((function(e){if(!e.valueAdapter&&CE(e.modifiers[0],AE)&&wE(e.modifiers[1])){var i=e.modifiers[0].path,n=t[i];n||(n=t[i]={}),n[e.modifiers[1]]={values:e.data.values,keys:e.data.keys}}}));for(var i=Math.ceil(e.sample*e.duration)+1,n=function(){var n=a[r],o=t[n];if(!o)return"continue";Object.defineProperty(o,"worldMatrix",{get:function(){if(!o._worldMatrix){var r=o.position,a=o.rotation,s=o.scale;FE(e,r,i),FE(e,a,i),FE(e,s,i),function(e,t,i){var n=i.position.values,r=i.rotation.values,a=i.scale.values,o=n.map((function(){return new Ki})),s=t.lastIndexOf("/"),l=null;if(s>0){var u=t.substring(0,s),c=e[u];if(!c)return void console.warn("no data for parent bone?");l=c.worldMatrix.values}for(var h=0;h<n.length;h++){var p=n[h],_=r[h],f=a[h],d=o[h];Ki.fromRTS(d,_,p,f),l&&Ki.multiply(d,l[h],d)}Object.keys(i).forEach((function(e){return delete i[e]})),i._worldMatrix={keys:0,interpolate:!1,values:o}}(t,n,o)}return o._worldMatrix}})},r=0,a=Object.keys(t);r<a.length;r++)n();return{info:{frames:i,sample:e.sample},data:t}}(t),e.pool.set(t,i)),i}},{key:"destroy",value:function(t){e.pool.delete(t)}}]),e}();function FE(e,t,i){var n=e.keys[t.keys],r=[];if(n&&1!==n.length)for(var a=t.values[0]instanceof Xi,o=0,s=0;o<i;o++){for(var l=o/e.sample;n[s]<=l;)s++;s>n.length-1?l=n[s=n.length-1]:0===s&&(s=1);var u=t.values[s-1].clone(),c=n[s]-n[s-1],h=c?_i((l-n[s-1])/c):1;a?u.slerp(t.values[s],h):u.lerp(t.values[s],h),r[o]=u}else for(var p=0;p<i;p++)r[p]=t.values[0].clone();t.values=r}RE.pool=new Map;var ME=new Ki;function IE(e,t,i){for(Ki.identity(i);e!==t;)Ki.fromRTS(ME,e.rotation,e.position,e.scale),Ki.multiply(i,ME,i),e=e.parent;return i}var PE=function(e,t,i,n){e[t+0]=i.m00,e[t+1]=i.m01,e[t+2]=i.m02,e[t+3]=i.m12,e[t+4]=i.m04,e[t+5]=i.m05,e[t+6]=i.m06,e[t+7]=i.m13,e[t+8]=i.m08,e[t+9]=i.m09,e[t+10]=i.m10,e[t+11]=i.m14};function LE(e){return e.hasFeature(exports.GFXFeature.TEXTURE_FLOAT)?exports.GFXFormat.RGBA32F:exports.GFXFormat.RGBA8}new Xi,new Xi,new Ii,new Xi,new Ii;function DE(e,t){var i=4/Math.sqrt(t);return 12*Math.ceil(Math.max(480*i,e)/12)}var NE=Wl([exports.GFXFilter.POINT,exports.GFXFilter.POINT,exports.GFXFilter.NONE,exports.GFXAddress.CLAMP,exports.GFXAddress.CLAMP,exports.GFXAddress.CLAMP]),zE=new Ii,BE=new Ii,GE=new Ii,UE=new Ii,XE=new Ki,VE=new Ki,HE=new lo,WE=Number.MAX_SAFE_INTEGER,jE=function(){function e(t){Z(this,e),this._device=void 0,this._pool=void 0,this._textureBuffers=new Map,this._formatSize=void 0,this._pixelsPerJoint=void 0,this._customPool=void 0,this._chunkIdxMap=new Map,this._device=t;var i=LE(this._device);this._formatSize=yr[i].size,this._pixelsPerJoint=48/this._formatSize,this._pool=new EE(t),this._pool.initialize({format:i,roundUpFn:DE}),this._customPool=new EE(t),this._customPool.initialize({format:i,roundUpFn:DE})}return J(e,[{key:"pixelsPerJoint",get:function(){return this._pixelsPerJoint}}]),J(e,[{key:"clear",value:function(){this._pool.destroy(),this._textureBuffers.clear()}},{key:"registerCustomTextureLayouts",value:function(e){for(var t=0;t<e.length;t++)for(var i=e[t],n=this._customPool.createChunk(i.textureLength),r=0;r<i.contents.length;r++){var a=i.contents[r],o=a.skeleton;this._chunkIdxMap.set(o,n);for(var s=0;s<a.clips.length;s++){var l=a.clips[s];this._chunkIdxMap.set(o^l,n)}}}},{key:"getDefaultPoseTexture",value:function(e,t,i){var n=0^e.hash,r=this._textureBuffers.get(n)||null;if(r&&r.bounds.has(t.hash))return r.refCount++,r;var a=e.joints,o=e.bindposes,s=null,l=!1,u=a.length;if(r)r.refCount++;else{var c=12*u,h=this._chunkIdxMap.get(n),p=void 0!==h?this._customPool.alloc(c*Float32Array.BYTES_PER_ELEMENT,h):this._pool.alloc(c*Float32Array.BYTES_PER_ELEMENT);if(!p)return r;r={pixelOffset:p.start/this._formatSize,refCount:1,bounds:new Map,skeletonHash:e.hash,clipHash:0,readyToBeDeleted:!1,handle:p},s=new Float32Array(c),l=!0}Ii.set(GE,WE,WE,WE),Ii.set(UE,-WE,-WE,-WE);for(var _=t.getBoneSpaceBounds(e),f=0,d=0;f<u;f++,d+=12){var m=i.getChildByPath(a[f]),v=m?IE(m,i,XE):e.inverseBindposes[f],y=_[f];y&&(lo.transform(HE,y,v),HE.getBoundary(zE,BE),Ii.min(GE,GE,zE),Ii.max(UE,UE,BE)),l&&(m&&Ki.multiply(v,v,o[f]),PE(s,d,m?v:Ki.IDENTITY))}var g=[new lo];return r.bounds.set(t.hash,g),lo.fromPoints(g[0],GE,UE),l&&(this._pool.update(r.handle,s.buffer),this._textureBuffers.set(n,r)),r}},{key:"getSequencePoseTexture",value:function(e,t,i,n){var r=e.hash^t.hash,a=this._textureBuffers.get(r)||null;if(a&&a.bounds.has(i.hash))return a.refCount++,a;var o=e.joints,s=e.bindposes,l=RE.getOrExtract(t).info.frames,u=null,c=!1,h=o.length;if(a)a.refCount++;else{var p=12*h*l,_=this._chunkIdxMap.get(r),f=void 0!==_?this._customPool.alloc(p*Float32Array.BYTES_PER_ELEMENT,_):this._pool.alloc(p*Float32Array.BYTES_PER_ELEMENT);if(!f)return null;var d=this._createAnimInfos(e,t,n);a={pixelOffset:f.start/this._formatSize,refCount:1,bounds:new Map,skeletonHash:e.hash,clipHash:t.hash,readyToBeDeleted:!1,handle:f,animInfos:d},u=new Float32Array(p),c=!0}var m=i.getBoneSpaceBounds(e),v=[];a.bounds.set(i.hash,v);for(var y=0;y<l;y++)v.push(new lo(WE,WE,WE,-WE,-WE,-WE));for(var g=0,x=0;g<l;g++){for(var b=v[g],T=0;T<h;T++,x+=12){var S=a.animInfos[T],E=S.curveData,w=S.downstream,C=S.bindposeIdx,A=S.bindposeCorrection,O=void 0,k=!0;E&&w?O=Ki.multiply(XE,E[g],w):E?O=E[g]:w?O=w:(O=e.inverseBindposes[C],k=!1);var R=m[T];if(R){var F=A?Ki.multiply(VE,O,A):O;lo.transform(HE,R,F),HE.getBoundary(zE,BE),Ii.min(b.center,b.center,zE),Ii.max(b.halfExtents,b.halfExtents,BE)}c&&(k&&Ki.multiply(XE,O,s[C]),PE(u,x,k?XE:Ki.IDENTITY))}lo.fromPoints(b,b.center,b.halfExtents)}return c&&(this._pool.update(a.handle,u.buffer),this._textureBuffers.set(r,a)),a}},{key:"releaseHandle",value:function(e){if(e.refCount>0&&e.refCount--,!e.refCount&&e.readyToBeDeleted){var t=e.skeletonHash^e.clipHash;(void 0!==this._chunkIdxMap.get(t)?this._customPool:this._pool).free(e.handle),this._textureBuffers.get(t)===e&&this._textureBuffers.delete(t)}}},{key:"releaseSkeleton",value:function(e){for(var t=this._textureBuffers.values(),i=t.next();!i.done;){var n=i.value;n.skeletonHash===e.hash&&(n.readyToBeDeleted=!0,n.refCount?this._textureBuffers.delete(n.skeletonHash^n.clipHash):this.releaseHandle(n)),i=t.next()}}},{key:"releaseAnimationClip",value:function(e){for(var t=this._textureBuffers.values(),i=t.next();!i.done;){var n=i.value;n.clipHash===e.hash&&(n.readyToBeDeleted=!0,n.refCount?this._textureBuffers.delete(n.skeletonHash^n.clipHash):this.releaseHandle(n)),i=t.next()}}},{key:"_createAnimInfos",value:function(e,t,i){for(var n=[],r=e.joints,a=e.bindposes,o=r.length,s=RE.getOrExtract(t),l=0;l<o;l++){for(var u=r[l],c=s.data[u],h=i.getChildByPath(u),p=void 0,_=void 0;!c;){var f=u.lastIndexOf("/");if(u=u.substring(0,f),c=s.data[u],h?(p||(p=new Ki),Ki.fromRTS(XE,h.rotation,h.position,h.scale),Ki.multiply(p,XE,p),h=h.parent):_=u,f<0)break}var d=l,m=void 0;if(void 0!==_&&c){d=l-1;for(var v=0;v<o;v++)if(r[v]===_){d=v,m=new Ki,Ki.multiply(m,a[v],e.inverseBindposes[l]);break}}n.push({curveData:c&&c.worldMatrix.values,downstream:p,bindposeIdx:d,bindposeCorrection:m})}return n}}]),e}(),qE=function(){function e(t){Z(this,e),this._pool=new Map,this._device=void 0,this._device=t}return J(e,[{key:"getData",value:function(){var e=arguments.length>0&&void 0!==arguments[0]?arguments[0]:"-1",t=this._pool.get(e);if(t)return t;var i=this._device.createBuffer({usage:exports.GFXBufferUsageBit.UNIFORM|exports.GFXBufferUsageBit.TRANSFER_DST,memUsage:exports.GFXMemoryUsageBit.HOST|exports.GFXMemoryUsageBit.DEVICE,size:Pu.SIZE,stride:Pu.SIZE}),n=new Float32Array([0,0,0,0]);i.update(n);var r={buffer:i,data:n,dirty:!1};return this._pool.set(e,r),r}},{key:"destroy",value:function(e){var t=this._pool.get(e);t&&(t.buffer.destroy(),this._pool.delete(e))}},{key:"switchClip",value:function(e,t){return e.data[0]=0,e.buffer.update(e.data),e.dirty=!1,e}},{key:"clear",value:function(){for(var e,t=_e(this._pool.values());!(e=t()).done;){e.value.buffer.destroy()}this._pool.clear()}}]),e}(),YE=[],KE=new Map,ZE=[{name:"CC_USE_SKINNING",value:!0}];function QE(e,t){for(var i=0,n=Ki.IDENTITY;e;){if(e.stamp===t||e.stamp+1===t&&!e.node.hasChangedFlags){n=e.world,e.stamp=t;break}e.stamp=t,YE[i++]=e,e=e.parent}for(;i>0;){var r=(e=YE[--i]).node;Ki.fromRTS(e.local,r.rotation,r.position,r.scale),n=Ki.multiply(e.world,n,e.local)}return n}function JE(e,t){for(var i,n=null,r=0;e!==t;){var a=e.uuid;if(KE.has(a)){n=KE.get(a);break}n={node:e,local:new Ki,world:new Ki,stamp:-1,parent:null},KE.set(a,n),YE[r++]=n,e=e.parent,n=null}for(;r>0;)(i=YE[--r]).parent=n,n=i;return n}function $E(e){for(var t=KE.get(e.uuid)||null;t;)KE.delete(t.node.uuid),t=t.parent}function ew(e,t,i,n){for(var r=0;r<i.length;r++){for(var a=i[r],o=-1,s=0;s<a.length;s++)if(a[s]===n){o=s;break}o>=0&&(t.push(r),e.push(o))}}var tw,iw=new Ii,nw=new Ii,rw=new Ii,aw=new Ii,ow=new Ki,sw=new lo,lw=function(e){function t(){var e;return Z(this,t),(e=re(this,te(t).call(this))).uploadAnimation=null,e._buffers=[],e._dataArray=[],e._joints=[],e._bufferIndices=null,e.type=eh.SKINNING,e}return ee(t,oh),J(t,[{key:"destroy",value:function(){if(this.bindSkeleton(),this._buffers.length){for(var e=0;e<this._buffers.length;e++)this._buffers[e].destroy();this._buffers.length=0}oe(te(t.prototype),"destroy",this).call(this)}},{key:"bindSkeleton",value:function(){for(var e=arguments.length>0&&void 0!==arguments[0]?arguments[0]:null,t=arguments.length>1&&void 0!==arguments[1]?arguments[1]:null,i=arguments.length>2&&void 0!==arguments[2]?arguments[2]:null,n=0;n<this._joints.length;n++)$E(this._joints[n].target);if(this._bufferIndices=null,this._joints.length=0,e&&t&&i){this.transform=t;var r=i.getBoneSpaceBounds(e),a=i.struct.jointMaps;this._ensureEnoughBuffers(a&&a.length||1),this._bufferIndices=i.jointBufferIndices;for(var o=0;o<e.joints.length;o++){var s=r[o],l=t.getChildByPath(e.joints[o]);if(s&&l){var u=JE(l,t),c=e.bindposes[o],h=[],p=[];a?ew(h,p,a,o):(h.push(o),p.push(0)),this._joints.push({indices:h,buffers:p,bound:s,target:l,bindpose:c,transform:u})}}}}},{key:"updateTransform",value:function(e){var t=this.transform;(t.hasChangedFlags||t._dirtyFlags)&&(t.updateWorldTransform(),this._transformUpdated=!0),Ii.set(iw,1/0,1/0,1/0),Ii.set(nw,-1/0,-1/0,-1/0);for(var i=0;i<this._joints.length;i++){var n=this._joints[i],r=n.bound,a=QE(n.transform,e);lo.transform(sw,r,a),sw.getBoundary(rw,aw),Ii.min(iw,iw,rw),Ii.max(nw,nw,aw)}this._modelBounds&&this._worldBounds&&(lo.fromPoints(this._modelBounds,iw,nw),this._modelBounds.transform(t._mat,t._pos,t._rot,t._scale,this._worldBounds))}},{key:"updateUBOs",value:function(e){oe(te(t.prototype),"updateUBOs",this).call(this,e);for(var i=0;i<this._joints.length;i++){var n=this._joints[i],r=n.indices,a=n.buffers,o=n.transform,s=n.bindpose;Ki.multiply(ow,o.world,s);for(var l=0;l<a.length;l++)PE(this._dataArray[a[l]],12*r[l],ow)}for(var u=0;u<this._buffers.length;u++)this._buffers[u].update(this._dataArray[u]);return!0}},{key:"initSubModel",value:function(e,i,n){var r=i.vertexBuffers;i.vertexBuffers=i.jointMappedBuffers,oe(te(t.prototype),"initSubModel",this).call(this,e,i,n),i.vertexBuffers=r}},{key:"createPipelineState",value:function(e,i,n){var r,a=oe(te(t.prototype),"createPipelineState",this).call(this,e,i,null!==(r=null==n?void 0:n.concat(ZE))&&void 0!==r?r:ZE),o=a.pipelineLayout.layouts[0],s=this._buffers[this._bufferIndices[i]];return s&&o.bindBuffer(Lu.BLOCK.binding,s),a}},{key:"_ensureEnoughBuffers",value:function(e){for(var t=0;t<e;t++)this._buffers[t]||(this._buffers[t]=this._device.createBuffer({usage:exports.GFXBufferUsageBit.UNIFORM|exports.GFXBufferUsageBit.TRANSFER_DST,memUsage:exports.GFXMemoryUsageBit.HOST|exports.GFXMemoryUsageBit.DEVICE,size:Lu.SIZE,stride:Lu.SIZE})),this._dataArray[t]||(this._dataArray[t]=new Float32Array(Lu.COUNT))}}]),t}(),uw=[{name:"CC_USE_SKINNING",value:!0},{name:"CC_USE_BAKED_ANIMATION",value:!0}],cw=function(e){function t(){var e;Z(this,t),(e=re(this,te(t).call(this))).uploadedAnim=void 0,e._jointsMedium=void 0,e._skeleton=null,e._mesh=null,e._dataPoolManager=void 0,e._instAnimInfoIdx=-1,e.type=eh.BAKED_SKINNING,e._dataPoolManager=cc.director.root.dataPoolManager;var i=new Float32Array(4),n=e._dataPoolManager.jointAnimationInfo.getData();return e._jointsMedium={buffer:null,jointTextureInfo:i,animInfo:n,texture:null,boundsInfo:null},e}return ee(t,oh),J(t,[{key:"destroy",value:function(){this.uploadedAnim=void 0,this._jointsMedium.boundsInfo=null,this._jointsMedium.buffer&&(this._jointsMedium.buffer.destroy(),this._jointsMedium.buffer=null),this._applyJointTexture(),oe(te(t.prototype),"destroy",this).call(this)}},{key:"bindSkeleton",value:function(){var e=arguments.length>0&&void 0!==arguments[0]?arguments[0]:null,t=arguments.length>1&&void 0!==arguments[1]?arguments[1]:null,i=arguments.length>2&&void 0!==arguments[2]?arguments[2]:null;if(this._skeleton=e,this._mesh=i,e&&t&&i){this.transform=t;var n=this._dataPoolManager;this._jointsMedium.animInfo=n.jointAnimationInfo.getData(t.uuid),this._jointsMedium.buffer||(this._jointsMedium.buffer=this._device.createBuffer({usage:exports.GFXBufferUsageBit.UNIFORM|exports.GFXBufferUsageBit.TRANSFER_DST,memUsage:exports.GFXMemoryUsageBit.HOST|exports.GFXMemoryUsageBit.DEVICE,size:Iu.SIZE,stride:Iu.SIZE}))}}},{key:"updateTransform",value:function(e){if(oe(te(t.prototype),"updateTransform",this).call(this,e),this.uploadedAnim){var i=this._jointsMedium,n=i.animInfo,r=i.boundsInfo[n.data[0]],a=this.transform;this._worldBounds&&r&&r.transform(a._mat,a._pos,a._rot,a._scale,this._worldBounds)}}},{key:"updateUBOs",value:function(e){oe(te(t.prototype),"updateUBOs",this).call(this,e);var i=this._jointsMedium.animInfo,n=this._instAnimInfoIdx;n>=0?this.instancedAttributes.list[n].view[0]=i.data[0]:i.dirty&&(i.buffer.update(i.data),i.dirty=!1);return!0}},{key:"createBoundingShape",value:function(e,t){e&&t&&(this._worldBounds=new lo)}},{key:"uploadAnimation",value:function(e){if(this._skeleton&&this._mesh&&this.uploadedAnim!==e){this.uploadedAnim=e;var t=this._dataPoolManager,i=null;e?(i=t.jointTexturePool.getSequencePoseTexture(this._skeleton,e,this._mesh,this.transform),this._jointsMedium.boundsInfo=i&&i.bounds.get(this._mesh.hash),this._modelBounds=null):(i=t.jointTexturePool.getDefaultPoseTexture(this._skeleton,this._mesh,this.transform),this._jointsMedium.boundsInfo=null,this._modelBounds=i&&i.bounds.get(this._mesh.hash)[0]),this._applyJointTexture(i)}}},{key:"_applyJointTexture",value:function(){var e=arguments.length>0&&void 0!==arguments[0]?arguments[0]:null,t=this._jointsMedium.texture;if(t&&t!==e&&this._dataPoolManager.jointTexturePool.releaseHandle(t),this._jointsMedium.texture=e,e){var i=this._jointsMedium,n=i.buffer,r=i.jointTextureInfo;r[0]=e.handle.texture.width,r[1]=this._skeleton.joints.length,r[2]=e.pixelOffset+.1,r[3]=1/r[0],this.updateInstancedJointTextureInfo(),n&&n.update(r);for(var a=e.handle.texView,o=this._matPSORecord.values(),s=o.next();!s.done;){for(var l=s.value,u=0;u<l.length;u++){var c=l[u].pipelineLayout.layouts[0];c.bindTextureView(Du.binding,a)}s=o.next()}for(var h=0;h<this._implantPSOs.length;h++){var p=this._implantPSOs[h].pipelineLayout.layouts[0];p.bindTextureView(Du.binding,a),p.update()}}}},{key:"createPipelineState",value:function(e,i,n){var r,a=oe(te(t.prototype),"createPipelineState",this).call(this,e,i,null!==(r=null==n?void 0:n.concat(uw))&&void 0!==r?r:uw),o=this._jointsMedium,s=o.buffer,l=o.texture,u=o.animInfo,c=a.pipelineLayout.layouts[0];c.bindBuffer(Iu.BLOCK.binding,s),c.bindBuffer(Pu.BLOCK.binding,u.buffer);var h=ou.getSampler(this._device,NE);return l&&(c.bindTextureView(Du.binding,l.handle.texView),c.bindSampler(Du.binding,h)),a}},{key:"updateInstancedAttributeList",value:function(e,i){oe(te(t.prototype),"updateInstancedAttributeList",this).call(this,e,i),this._instAnimInfoIdx=this.getInstancedAttributeIndex("a_jointAnimInfo"),this.updateInstancedJointTextureInfo()}},{key:"updateInstancedJointTextureInfo",value:function(){var e=this._jointsMedium,t=e.jointTextureInfo,i=e.animInfo,n=this._instAnimInfoIdx;if(n>=0){var r=this.instancedAttributes.list[n].view;r[0]=i.data[0],r[1]=t[1],r[2]=t[2]}}}]),t}(),hw=new Ii(0,0,-1),pw=new Ii,_w=new lo,fw=new Xi,dw=function(){function e(t){Z(this,e),this._scene=void 0,this._enabled=!1,this._normal=new Ii(0,1,0),this._distance=0,this._matLight=new Ki,this._data=Float32Array.from([1,0,0,0,0,1,0,0,0,0,1,0,0,0,0,1,0,0,0,.3]),this._globalBindings=void 0,this._record=new Map,this._pendingModels=[],this._material=void 0,this._instancingMaterial=void 0,this._scene=t,this._globalBindings=t.root.pipeline.globalBindings.get(Au.BLOCK.name),this._material=new Bh,this._material.initialize({effectName:"pipeline/planar-shadow"}),this._instancingMaterial=new Bh,this._instancingMaterial.initialize({effectName:"pipeline/planar-shadow",defines:{USE_INSTANCING:!0}})}return J(e,[{key:"enabled",set:function(e){this._enabled=e,this._scene.mainLight&&this.updateDirLight(this._scene.mainLight)},get:function(){return this._enabled}},{key:"normal",set:function(e){Ii.copy(this._normal,e),this._scene.mainLight&&this.updateDirLight(this._scene.mainLight)},get:function(){return this._normal}},{key:"distance",set:function(e){this._distance=e,this._scene.mainLight&&this.updateDirLight(this._scene.mainLight)},get:function(){return this._distance}},{key:"shadowColor",set:function(e){an.toArray(this._data,e,Au.SHADOW_COLOR_OFFSET),this._globalBindings.buffer.update(this.data)}},{key:"matLight",get:function(){return this._matLight}},{key:"data",get:function(){return this._data}}]),J(e,[{key:"updateSphereLight",value:function(e){e.node.getWorldPosition(pw);var t=this._normal,i=this._distance+.001,n=Ii.dot(t,pw),r=pw.x,a=pw.y,o=pw.z,s=t.x,l=t.y,u=t.z,c=this._matLight;c.m00=n-i-r*s,c.m01=-a*s,c.m02=-o*s,c.m03=-s,c.m04=-r*l,c.m05=n-i-a*l,c.m06=-o*l,c.m07=-l,c.m08=-r*u,c.m09=-a*u,c.m10=n-i-o*u,c.m11=-u,c.m12=r*i,c.m13=a*i,c.m14=o*i,c.m15=n,Ki.toArray(this.data,this._matLight),this._globalBindings.buffer.update(this.data)}},{key:"updateDirLight",value:function(e){e.node.getWorldRotation(fw),Ii.transformQuat(pw,hw,fw);var t=this._normal,i=this._distance+.001,n=1/Ii.dot(t,pw),r=pw.x*n,a=pw.y*n,o=pw.z*n,s=t.x,l=t.y,u=t.z,c=this._matLight;c.m00=1-s*r,c.m01=-s*a,c.m02=-s*o,c.m03=0,c.m04=-l*r,c.m05=1-l*a,c.m06=-l*o,c.m07=0,c.m08=-u*r,c.m09=-u*a,c.m10=1-u*o,c.m11=0,c.m12=r*i,c.m13=a*i,c.m14=o*i,c.m15=1,Ki.toArray(this.data,this._matLight,Au.MAT_LIGHT_PLANE_PROJ_OFFSET),this._globalBindings.buffer.update(this.data)}},{key:"updateCommandBuffers",value:function(e,t){if(this._pendingModels.length=0,this._scene.mainLight)for(var i=this._scene.models,n=0;n<i.length;n++){var r=i[n];if(r.enabled&&r.node&&r.castShadow&&(!r.worldBounds||(lo.transform(_w,r.worldBounds,this._matLight),Ka.aabb_frustum(_w,e)))){var a=this._record.get(r);a&&!!a.instancedBuffer!==r.isInstancingEnabled&&(this.destroyShadowData(r),a=void 0),a||(a=this.createShadowData(r),this._record.set(r,a)),r.updateStamp!==t&&r.updateUBOs(t),this._pendingModels.push(a)}}}},{key:"recordCommandBuffer",value:function(e){var t=this._pendingModels,i=t.length,n=this._instancingMaterial.passes[0].instancedBuffer;n&&n.clear();for(var r=0;r<i;r++)for(var a=t[r],o=a.model,s=a.psos,l=a.instancedBuffer,u=0;u<s.length;u++){var c=o.getSubModel(u),h=s[u];if(l)l.merge(c,o.instancedAttributes,h);else{var p=c.inputAssembler;e.bindPipelineState(h),e.bindBindingLayout(h.pipelineLayout.layouts[0]),e.bindInputAssembler(p),e.draw(p)}}if(n&&n.instances.length>0){n.uploadBuffers();for(var _=0;_<n.instances.length;++_){var f=n.instances[_];f.count&&(e.bindPipelineState(f.pso),e.bindBindingLayout(f.pso.pipelineLayout.layouts[0]),e.bindInputAssembler(f.ia),e.draw(f.ia))}}}},{key:"createShadowData",value:function(e){for(var t=[],i=e.isInstancingEnabled?this._instancingMaterial:this._material,n=0;n<e.subModelNum;n++){var r=e.createPipelineState(i.passes[0],n);e.insertImplantPSO(r),r.pipelineLayout.layouts[0].update(),t.push(r)}return{model:e,psos:t,instancedBuffer:i.passes[0].instancedBuffer}}},{key:"destroyShadowData",value:function(e){var t=this._record.get(e);if(t){for(var i=t.instancedBuffer?this._instancingMaterial:this._material,n=0;n<t.psos.length;n++){var r=t.psos[n];e.removeImplantPSO(r),i.passes[0].destroyPipelineState(r)}this._record.delete(e)}}},{key:"onGlobalPipelineStateChanged",value:function(){for(var e=this._record.keys(),t=e.next();!t.done;)this.destroyShadowData(t.value),t=e.next();this._record.clear()}},{key:"destroy",value:function(){this.onGlobalPipelineStateChanged(),this._material.destroy()}}]),e}();!function(e){e[e.positions=exports.GFXAttributeName.ATTR_POSITION]="positions",e[e.normals=exports.GFXAttributeName.ATTR_NORMAL]="normals",e[e.uvs=exports.GFXAttributeName.ATTR_TEX_COORD]="uvs",e[e.colors=exports.GFXAttributeName.ATTR_COLOR]="colors"}(tw||(tw={}));var mw=[{name:exports.GFXAttributeName.ATTR_POSITION,format:exports.GFXFormat.RGB32F},{name:exports.GFXAttributeName.ATTR_NORMAL,format:exports.GFXFormat.RGB32F},{name:exports.GFXAttributeName.ATTR_TEX_COORD,format:exports.GFXFormat.RG32F},{name:exports.GFXAttributeName.ATTR_COLOR,format:exports.GFXFormat.RGBA32F}],vw=new Ii;function yw(e,t,i){i=i||{};var n,r=[],a=0,o=[],s=0;if(e.positions.length>0){if(n=null,e.attributes)for(var l,u=_e(e.attributes);!(l=u()).done;){var c=l.value;if(c.name===exports.GFXAttributeName.ATTR_POSITION){n=c;break}}n||(n=mw[0]);var h=yr[n.format];r.push(n),s=Math.max(s,Math.floor(e.positions.length/h.count)),o.push({offset:a,data:e.positions,attribute:n}),a+=h.size}if(e.normals&&e.normals.length>0){if(n=null,e.attributes)for(var p,_=_e(e.attributes);!(p=_()).done;){var f=p.value;if(f.name===exports.GFXAttributeName.ATTR_NORMAL){n=f;break}}n||(n=mw[1]);var d=yr[n.format];r.push(n),s=Math.max(s,Math.floor(e.normals.length/d.count)),o.push({offset:a,data:e.normals,attribute:n}),a+=d.size}if(e.uvs&&e.uvs.length>0){if(n=null,e.attributes)for(var m,v=_e(e.attributes);!(m=v()).done;){var y=m.value;if(y.name===exports.GFXAttributeName.ATTR_TEX_COORD){n=y;break}}n||(n=mw[2]);var g=yr[n.format];r.push(n),s=Math.max(s,Math.floor(e.uvs.length/g.count)),o.push({offset:a,data:e.uvs,attribute:n}),a+=g.size}if(e.colors&&e.colors.length>0){if(n=null,e.attributes)for(var x,b=_e(e.attributes);!(x=b()).done;){var T=x.value;if(T.name===exports.GFXAttributeName.ATTR_COLOR){n=T;break}}n||(n=mw[3]);var S=yr[n.format];r.push(n),s=Math.max(s,Math.floor(e.colors.length/S.count)),o.push({offset:a,data:e.colors,attribute:n}),a+=S.size}if(e.customAttributes)for(var E,w=_e(e.customAttributes);!(E=w()).done;){var C=E.value,A=yr[C.attr.format];r.push(C.attr),s=Math.max(s,Math.floor(C.values.length/A.count)),o.push({offset:a,data:C.values,attribute:C.attr}),a+=A.size}for(var O=new tl,k=new ArrayBuffer(s*a),R=new DataView(k),F=0,M=o;F<M.length;F++){var I=M[F];Js(R,I.data,I.attribute.format,I.offset,a)}O.setNextAlignment(0);var P={attributes:r,view:{offset:O.getLength(),length:k.byteLength,count:s,stride:a}};O.addBuffer(k);var L=null,D=0;if(e.indices){var N=e.indices;D=N.length,L=new ArrayBuffer(2*D),Js(new DataView(L),N,exports.GFXFormat.R16UI)}var z={primitiveMode:e.primitiveMode||exports.GFXPrimitiveMode.TRIANGLE_LIST,vertexBundelIndices:[0]};L&&(O.setNextAlignment(2),z.indexView={offset:O.getLength(),length:L.byteLength,count:D,stride:2},O.addBuffer(L));var B=e.minPos;if(!B&&i.calculateBounds){B=Ii.set(new Ii,1/0,1/0,1/0);for(var G=0;G<s;++G)Ii.set(vw,e.positions[3*G+0],e.positions[3*G+1],e.positions[3*G+2]),Ii.min(B,B,vw)}var U=e.maxPos;if(!U&&i.calculateBounds){U=Ii.set(new Ii,-1/0,-1/0,-1/0);for(var X=0;X<s;++X)Ii.set(vw,e.positions[3*X+0],e.positions[3*X+1],e.positions[3*X+2]),Ii.max(U,U,vw)}var V={vertexBundles:[P],primitives:[z]};return B&&(V.minPosition=new Ii(B.x,B.y,B.z)),U&&(V.maxPosition=new Ii(U.x,U.y,U.z)),t||(t=new rc),t.reset({struct:V,data:new Uint8Array(O.getCombined())}),t}var gw=Object.freeze({__proto__:null,find:ex,toPPM:function(e,t,i){return"P3 ".concat(t," ").concat(i," 255\n").concat(e.filter((function(e,t){return t%4<3})).toString(),"\n")},readMesh:function(e){for(var t,i=arguments.length>1&&void 0!==arguments[1]?arguments[1]:0,n={positions:[]},r=new DataView(e._nativeAsset),a=e.struct,o=a.primitives[i],s=_e(o.vertexBundelIndices);!(t=s()).done;)for(var l,u=t.value,c=a.vertexBundles[u],h=c.view.offset,p=c.view,_=p.length,f=p.stride,d=_e(c.attributes);!(l=d()).done;){var m=l.value,v=tw[m.name];v&&(n[v]=(n[v]||[]).concat($s(r,m.format,h,_,f))),h+=yr[m.format].size}var y=o.indexView;return n.indices=$s(r,exports.GFXFormat["R".concat(8*y.stride,"UI")],y.offset,y.length),n},createMesh:yw,readBuffer:$s,writeBuffer:Js,mapBuffer:el});function xw(e){return void 0===(e=e||{}).includeNormal&&(e.includeNormal=!0),void 0===e.includeUV&&(e.includeUV=!0),e}function bw(e){var t=(e=e||{}).widthSegments||1,i=e.heightSegments||1,n=e.lengthSegments||1,r=(e.width||1)/2,a=(e.height||1)/2,o=(e.length||1)/2,s=[Ii.set(Cw,-r,-a,o),Ii.set(Aw,r,-a,o),Ii.set(Ow,r,a,o),Ii.set(kw,-r,a,o),Ii.set(Rw,r,-a,-o),Ii.set(Fw,-r,-a,-o),Ii.set(Mw,-r,a,-o),Ii.set(Iw,r,a,-o)],l=[[2,3,1],[4,5,7],[7,6,2],[1,0,4],[1,4,2],[5,0,6]],u=[[0,0,1],[0,0,-1],[0,1,0],[0,-1,0],[1,0,0],[-1,0,0]],c=[],h=[],p=[],_=[],f=new Ii(-r,-a,-o),d=new Ii(r,a,o),m=Math.sqrt(r*r+a*a+o*o);function v(e,t,i){var n,r,a,o,f=c.length/3,d=l[e],m=u[e];for(o=0;o<=i;o++)for(a=0;a<=t;a++)if(n=a/t,r=o/i,Ii.lerp(Tw,s[d[0]],s[d[1]],n),Ii.lerp(Sw,s[d[0]],s[d[2]],r),Ii.subtract(Ew,Sw,s[d[0]]),Ii.add(ww,Tw,Ew),c.push(ww.x,ww.y,ww.z),h.push(m[0],m[1],m[2]),p.push(n,r),a<t&&o<i){var v=t+1,y=a+o*v,g=a+(o+1)*v,x=a+1+(o+1)*v,b=a+1+o*v;_.push(f+y,f+b,f+g),_.push(f+g,f+b,f+x)}}return v(0,t,i),v(4,n,i),v(1,t,i),v(5,n,i),v(3,t,n),v(2,t,n),{positions:c,normals:h,uvs:p,indices:_,minPos:f,maxPos:d,boundingRadius:m}}var Tw=new Ii,Sw=new Ii,Ew=new Ii,ww=new Ii,Cw=new Ii,Aw=new Ii,Ow=new Ii,kw=new Ii,Rw=new Ii,Fw=new Ii,Mw=new Ii,Iw=new Ii,Pw=new Ii(0,0,0),Lw=new Ii(0,0,0);function Dw(){var e=arguments.length>0&&void 0!==arguments[0]?arguments[0]:.5,t=arguments.length>1&&void 0!==arguments[1]?arguments[1]:.5,i=arguments.length>2&&void 0!==arguments[2]?arguments[2]:2,n=arguments.length>3&&void 0!==arguments[3]?arguments[3]:{},r=.5*i,a=n.radialSegments||32,o=n.heightSegments||1,s=void 0===n.capped||n.capped,l=n.arc||2*Math.PI,u=0;s||(e>0&&u++,t>0&&u++);var c=(a+1)*(o+1);s&&(c+=(a+1)*u+a*u);var h=a*o*2*3;s&&(h+=a*u*3);var p=new Array(h),_=new Array(3*c),f=new Array(3*c),d=new Array(2*c),m=Math.max(e,t),v=new Ii(-m,-r,-m),y=new Ii(m,r,m),g=Math.sqrt(m*m+r*r),x=0,b=0;return T(),s&&(t>0&&S(!1),e>0&&S(!0)),{positions:_,normals:f,uvs:d,indices:p,minPos:v,maxPos:y,boundingRadius:g};function T(){for(var n=[],s=e-t,u=s*s/i*Math.sign(s),c=0;c<=o;c++){for(var h=[],m=c/o,v=m*s+t,y=0;y<=a;++y){var g=y/a,T=g*l,S=Math.sin(T),E=Math.cos(T);_[3*x]=v*S,_[3*x+1]=m*i-r,_[3*x+2]=v*E,Ii.normalize(Pw,Ii.set(Lw,S,-u,E)),f[3*x]=Pw.x,f[3*x+1]=Pw.y,f[3*x+2]=Pw.z,d[2*x]=2*(1-g)%1,d[2*x+1]=m,h.push(x),++x}n.push(h)}for(var w=0;w<o;++w)for(var C=0;C<a;++C){var A=n[w][C],O=n[w+1][C],k=n[w+1][C+1],R=n[w][C+1];p[b]=A,++b,p[b]=R,++b,p[b]=O,++b,p[b]=R,++b,p[b]=k,++b,p[b]=O,++b}}function S(i){for(var n=i?e:t,o=i?1:-1,s=x,u=1;u<=a;++u)_[3*x]=0,_[3*x+1]=r*o,_[3*x+2]=0,f[3*x]=0,f[3*x+1]=o,f[3*x+2]=0,d[2*x]=.5,d[2*x+1]=.5,++x;for(var c=x,h=0;h<=a;++h){var m=h/a*l,v=Math.cos(m),y=Math.sin(m);_[3*x]=n*y,_[3*x+1]=r*o,_[3*x+2]=n*v,f[3*x]=0,f[3*x+1]=o,f[3*x+2]=0,d[2*x]=.5-.5*y*o,d[2*x+1]=.5+.5*v,++x}for(var g=0;g<a;++g){var T=s+g,S=c+g;i?(p[b]=S+1,++b,p[b]=T,++b,p[b]=S,++b):(p[b]=T,++b,p[b]=S+1,++b,p[b]=S,++b)}}}var Nw=new Ii(0,0,0),zw=new Ii(0,0,0),Bw=new Ii(0,0,0),Gw=new Ii(0,0,0),Uw=new Ii(0,0,0),Xw=new Ii(0,0,0),Vw=new Ii(0,0,0);var Hw=new Ii(0,0,0),Ww=new Ii(0,0,0);var jw=Object.freeze({__proto__:null,box:bw,cone:function(){var e=arguments.length>0&&void 0!==arguments[0]?arguments[0]:.5,t=arguments.length>1&&void 0!==arguments[1]?arguments[1]:1,i=arguments.length>2&&void 0!==arguments[2]?arguments[2]:{};return Dw(0,e,t,i)},cylinder:Dw,plane:function(e){var t=function(e){return(e=xw(e)).width=e.width||10,e.length=e.length||10,e.widthSegments=e.widthSegments||10,e.lengthSegments=e.lengthSegments||10,e}(e),i=t.width,n=t.length,r=t.widthSegments,a=t.lengthSegments,o=.5*i,s=.5*n,l=[],u=[],c=[],h=new Ii(-o,0,-s),p=new Ii(o,0,s),_=Math.sqrt(i*i+n*n);Ii.set(Uw,-o,0,s),Ii.set(Xw,o,0,s),Ii.set(Vw,-o,0,-s);for(var f=0;f<=a;f++)for(var d=0;d<=r;d++){var m=d/r,v=f/a;if(Ii.lerp(Nw,Uw,Xw,m),Ii.lerp(zw,Uw,Vw,v),Ii.subtract(Bw,zw,Uw),Ii.add(Gw,Nw,Bw),l.push(Gw.x,Gw.y,Gw.z),t.includeUV&&u.push(m,v),d<r&&f<a){var y=r+1,g=d+f*y,x=d+(f+1)*y,b=d+1+(f+1)*y,T=d+1+f*y;c.push(g,T,x),c.push(T,b,x)}}var S={positions:l,indices:c,minPos:h,maxPos:p,boundingRadius:_};if(t.includeNormal){var E=(a+1)*(r+1),w=new Array(3*E);S.normals=w;for(var C=0;C<E;++C)w[3*C+0]=0,w[3*C+1]=1,w[3*C+2]=0}return t.includeUV&&(S.uvs=u),S},quad:function(e){var t=xw(e),i={positions:[-.5,-.5,0,-.5,.5,0,.5,.5,0,.5,-.5,0],indices:[0,3,1,3,2,1],minPos:{x:-.5,y:-.5,z:0},maxPos:{x:.5,y:.5,z:0},boundingRadius:Math.sqrt(.5)};return!1!==t.includeNormal&&(i.normals=[0,0,1,0,0,1,0,0,1,0,0,1]),!1!==t.includeUV&&(i.uvs=[0,0,0,1,1,1,1,0]),i},sphere:function(){for(var e=arguments.length>0&&void 0!==arguments[0]?arguments[0]:.5,t=arguments.length>1&&void 0!==arguments[1]?arguments[1]:{},i=void 0!==t.segments?t.segments:32,n=[],r=[],a=[],o=[],s=new Ii(-e,-e,-e),l=new Ii(e,e,e),u=e,c=0;c<=i;++c)for(var h=c*Math.PI/i,p=Math.sin(h),_=-Math.cos(h),f=0;f<=i;++f){var d=2*f*Math.PI/i-Math.PI/2,m=Math.sin(d),v=Math.cos(d),y=m*p,g=_,x=v*p,b=f/i,T=c/i;if(n.push(y*e,g*e,x*e),r.push(y,g,x),a.push(b,T),c<i&&f<i){var S=i+1,E=S*c+f,w=S*(c+1)+f,C=S*(c+1)+f+1,A=S*c+f+1;o.push(E,A,w),o.push(A,C,w)}}return{positions:n,indices:o,normals:r,uvs:a,minPos:s,maxPos:l,boundingRadius:u}},torus:function(){for(var e=arguments.length>0&&void 0!==arguments[0]?arguments[0]:.4,t=arguments.length>1&&void 0!==arguments[1]?arguments[1]:.1,i=arguments.length>2&&void 0!==arguments[2]?arguments[2]:{},n=i.radialSegments||32,r=i.tubularSegments||32,a=i.arc||2*Math.PI,o=[],s=[],l=[],u=[],c=new Ii(-e-t,-t,-e-t),h=new Ii(e+t,t,e+t),p=e+t,_=0;_<=n;_++)for(var f=0;f<=r;f++){var d=f/r,m=_/n,v=d*a,y=m*Math.PI*2,g=(e+t*Math.cos(y))*Math.sin(v),x=t*Math.sin(y),b=(e+t*Math.cos(y))*Math.cos(v),T=Math.sin(v)*Math.cos(y),S=Math.sin(y),E=Math.cos(v)*Math.cos(y);if(o.push(g,x,b),s.push(T,S,E),l.push(d,m),f<r&&_<n){var w=r+1,C=w*_+f,A=w*(_+1)+f,O=w*(_+1)+f+1,k=w*_+f+1;u.push(C,k,A),u.push(k,O,A)}}return{positions:o,normals:s,uvs:l,indices:u,minPos:c,maxPos:h,boundingRadius:p}},capsule:function(){var e=arguments.length>0&&void 0!==arguments[0]?arguments[0]:.5,t=arguments.length>1&&void 0!==arguments[1]?arguments[1]:.5,i=arguments.length>2&&void 0!==arguments[2]?arguments[2]:2,n=arguments.length>3&&void 0!==arguments[3]?arguments[3]:{},r=i-e-t,a=n.sides||32,o=n.heightSegments||32,s=t/i,l=r/i,u=e/i,c=Math.floor(o*s),h=Math.floor(o*u),p=Math.floor(o*l),_=r+t-i/2,f=t-i/2,d=t-i/2,m=n.arc||2*Math.PI,v=[],y=[],g=[],x=[],b=Math.max(e,t),T=new Ii(-b,-i/2,-b),S=new Ii(b,i/2,b),E=i/2,w=0,C=[];return O(),A(),k(),{positions:v,normals:y,uvs:g,indices:x,minPos:T,maxPos:S,boundingRadius:E};function A(){for(var i=(e-t)/r,n=0;n<=p;n++){for(var o=[],u=n/p,c=u*(e-t)+t,h=0;h<=a;++h){var _=h/a,d=u*l+s,b=_*m-m/4,T=Math.sin(b),S=Math.cos(b);v.push(c*T),v.push(u*r+f),v.push(c*S),Ii.normalize(Hw,Ii.set(Ww,T,-i,S)),y.push(Hw.x),y.push(Hw.y),y.push(Hw.z),g.push(_,d),o.push(w),++w}C.push(o)}for(var E=0;E<p;++E)for(var A=0;A<a;++A){var O=C[E][A],k=C[E+1][A],R=C[E+1][A+1],F=C[E][A+1];x.push(O),x.push(F),x.push(k),x.push(F),x.push(R),x.push(k)}}function O(){for(var e=0;e<=c;++e)for(var i=e*Math.PI/c/2,n=Math.sin(i),r=-Math.cos(i),s=0;s<=a;++s){var l=2*s*Math.PI/a-Math.PI/2,u=Math.sin(l)*n,h=r,p=Math.cos(l)*n,_=s/a,f=e/o;if(v.push(u*t,h*t+d,p*t),y.push(u,h,p),g.push(_,f),e<c&&s<a){var m=a+1,b=m*e+s,T=m*(e+1)+s,S=m*(e+1)+s+1,E=m*e+s+1;x.push(b,E,T),x.push(E,S,T)}++w}}function k(){for(var t=0;t<=h;++t)for(var i=t*Math.PI/h/2+Math.PI/2,n=Math.sin(i),r=-Math.cos(i),s=0;s<=a;++s){var l=2*s*Math.PI/a-Math.PI/2,c=Math.sin(l)*n,f=r,d=Math.cos(l)*n,m=s/a,b=t/o+(1-u);if(v.push(c*e,f*e+_,d*e),y.push(c,f,d),g.push(m,b),t<h&&s<a){var T=a+1,S=T*t+s+C[p][a]+1,E=T*(t+1)+s+C[p][a]+1,w=T*(t+1)+s+1+C[p][a]+1,A=T*t+s+1+C[p][a]+1;x.push(S,A,E),x.push(A,w,E)}}}},circle:function(e){var t=function(e){return(e=xw(e)).segments=64,e}(e).segments,i=new Array(3*(t+1));i[0]=0,i[1]=0,i[2]=0;var n=new Array(1+2*t);n[0]=0;for(var r=2*Math.PI/t,a=0;a<t;++a){var o=r*a,s=Math.cos(o),l=Math.sin(o),u=3*(a+1);i[u+0]=s,i[u+1]=l,i[u+2]=0;var c=2*a;n[1+c]=a+1,n[1+(c+1)]=a+2}return t>0&&(n[n.length-1]=1),{positions:i,indices:n,minPos:{x:1,y:1,z:0},maxPos:{x:-1,y:-1,z:0},boundingRadius:1,primitiveMode:exports.GFXPrimitiveMode.TRIANGLE_FAN}},translate:function(e,t){for(var i=t.x||0,n=t.y||0,r=t.z||0,a=Math.floor(e.positions.length/3),o=0;o<a;++o){var s=3*o,l=3*o+1,u=3*o+2;e.positions[s]=e.positions[s]+i,e.positions[l]=e.positions[l]+n,e.positions[u]=e.positions[u]+r}return e.minPos&&(e.minPos.x+=i,e.minPos.y+=n,e.minPos.z+=r),e.maxPos&&(e.maxPos.x+=i,e.maxPos.y+=n,e.maxPos.z+=r),e},scale:function(e,t){for(var i=t.x||0,n=t.y||0,r=t.z||0,a=Math.floor(e.positions.length/3),o=0;o<a;++o){var s=3*o,l=3*o+1,u=3*o+2;e.positions[s]*=i,e.positions[l]*=n,e.positions[u]*=r}return e.minPos&&(e.minPos.x*=i,e.minPos.y*=n,e.minPos.z*=r),e.maxPos&&(e.maxPos.x*=i,e.maxPos.y*=n,e.maxPos.z*=r),e.boundingRadius=Math.max(Math.max(i,n),r),e},wireframed:function(e){var t=e.indices;if(!t)return e;if(e.primitiveMode&&e.primitiveMode!==exports.GFXPrimitiveMode.TRIANGLE_LIST)return e;for(var i=[[0,1],[1,2],[2,0]],n=[],r={},a=0;a<t.length;a+=3)for(var o=0;o<3;++o){var s=t[a+i[o][0]],l=t[a+i[o][1]],u=s>l?l<<16|s:s<<16|l;void 0===r[u]&&(r[u]=0,n.push(s,l))}return e.indices=n,e.primitiveMode=exports.GFXPrimitiveMode.LINE_LIST,e},wireframe:function(e){for(var t=[[0,1],[1,2],[2,0]],i=[],n={},r=0;r<e.length;r+=3)for(var a=0;a<3;++a){var o=e[r+t[a][0]],s=e[r+t[a][1]],l=o>s?s<<16|o:o<<16|s;void 0===n[l]&&(n[l]=0,i.push(o,s))}return i},invWinding:function(e){for(var t=[],i=0;i<e.length;i+=3)t.push(e[i],e[i+2],e[i+1]);return t},toWavefrontOBJ:function(e){var t=arguments.length>1&&void 0!==arguments[1]?arguments[1]:1;if(!e.indices||!e.uvs||!e.normals||void 0!==e.primitiveMode&&e.primitiveMode!==exports.GFXPrimitiveMode.TRIANGLE_LIST)return"";for(var i=e.positions,n=e.uvs,r=e.normals,a=e.indices,o=function(e){return"".concat(a[e]+1,"/").concat(a[e]+1,"/").concat(a[e]+1)},s="",l=0;l<i.length;l+=3)s+="v ".concat(i[l]*t," ").concat(i[l+1]*t," ").concat(i[l+2]*t,"\n");for(var u=0;u<n.length;u+=2)s+="vt ".concat(n[u]," ").concat(n[u+1],"\n");for(var c=0;c<r.length;c+=3)s+="vn ".concat(r[c]," ").concat(r[c+1]," ").concat(r[c+2],"\n");for(var h=0;h<a.length;h+=3)s+="f ".concat(o(h)," ").concat(o(h+1)," ").concat(o(h+2),"\n");return s},normals:function(e,t){for(var i=arguments.length>2&&void 0!==arguments[2]?arguments[2]:1,n=new Array(2*e.length),r=0;r<e.length/3;++r){var a=3*r,o=6*r;n[o+0]=e[a+0],n[o+1]=e[a+1],n[o+2]=e[a+2],n[o+3]=e[a+0]+t[a+0]*i,n[o+4]=e[a+1]+t[a+1]*i,n[o+5]=e[a+2]+t[a+2]*i}return n},applyDefaultGeometryOptions:xw}),qw=null,Yw=null,Kw=function(e){function t(e){var i;if(Z(this,t),(i=re(this,te(t).call(this)))._default=Pc.get("default-cube-texture"),i._envmap=i._default,i._isRGBE=!1,i._useIBL=!1,i._globalBinding=void 0,i.scene=e,i._globalBinding=i.scene.root.pipeline.globalBindings.get(Ou.name),!Yw){var n=new Bh;n.initialize({effectName:"pipeline/skybox",defines:{USE_RGBE_CUBEMAP:i._isRGBE}}),Yw=new Xp({parent:n})}return qw||(qw=yw(bw({width:2,height:2,length:2}))),i.initSubModel(0,qw.renderingSubMeshes[0],Yw),i}return ee(t,ah),J(t,[{key:"useIBL",set:function(e){this._useIBL=e,this._updatePipeline()},get:function(){return this._useIBL}},{key:"isRGBE",set:function(e){this._isRGBE=e,Yw.recompileShaders({USE_RGBE_CUBEMAP:this._isRGBE}),this.setSubModelMaterial(0,Yw),this._updatePipeline()},get:function(){return this._isRGBE}},{key:"envmap",set:function(e){var t=e||this._default;this._envmap=t,this.scene.ambient.groundAlbedo[3]=this._envmap.mipmapLevel,this._updateGlobalBinding()},get:function(){return this._envmap}}]),J(t,[{key:"onGlobalPipelineStateChanged",value:function(){oe(te(t.prototype),"onGlobalPipelineStateChanged",this).call(this),this._updateGlobalBinding()}},{key:"_updatePipeline",value:function(){var e=this._useIBL?this._isRGBE?2:1:0,t=this.scene.root.pipeline;(t.macros.CC_USE_IBL||0)!==e&&(t.macros.CC_USE_IBL=e,this.scene.onGlobalPipelineStateChanged())}},{key:"_updateGlobalBinding",value:function(){var e=this._envmap.getGFXTextureView(),t=ou.getSampler(this._device,this._envmap.getSamplerHash());this._globalBinding.sampler=t,this._globalBinding.textureView=e;var i=Yw;i.passes[0].bindSampler(Ou.binding,t),i.passes[0].bindTextureView(Ou.binding,e);for(var n=this._matPSORecord.get(i),r=0;r<n.length;r++)n[r].pipelineLayout.layouts[0].update()}}]),t}(),Zw=function(){function e(t){Z(this,e),this._root=void 0,this._name="",this._cameras=[],this._ambient=void 0,this._skybox=void 0,this._planarShadows=void 0,this._models=[],this._directionalLights=[],this._sphereLights=[],this._spotLights=[],this._mainLight=null,this._modelId=0,this._root=t,this._ambient=new Gg(this),this._skybox=new Kw(this),this._planarShadows=new dw(this)}return J(e,[{key:"root",get:function(){return this._root}},{key:"name",get:function(){return this._name}},{key:"cameras",get:function(){return this._cameras}},{key:"ambient",get:function(){return this._ambient}},{key:"skybox",get:function(){return this._skybox}},{key:"planarShadows",get:function(){return this._planarShadows}},{key:"mainLight",get:function(){return this._mainLight}},{key:"sphereLights",get:function(){return this._sphereLights}},{key:"spotLights",get:function(){return this._spotLights}},{key:"models",get:function(){return this._models}},{key:"rayResultCanvas",get:function(){return oC}},{key:"rayResultModels",get:function(){return nC}},{key:"rayResultAll",get:function(){return sC}},{key:"rayResultSingleModel",get:function(){return lC}}],[{key:"registerCreateFunc",value:function(t){t._createSceneFun=function(t){return new e(t)}}}]),J(e,[{key:"initialize",value:function(e){return this._name=e.name,!0}},{key:"destroy",value:function(){this.removeCameras(),this.removeSphereLights(),this.removeSpotLights(),this.removeModels(),this._skybox.destroy(),this._planarShadows.destroy()}},{key:"addCamera",value:function(e){e.attachToScene(this),this._cameras.push(e)}},{key:"removeCamera",value:function(e){for(var t=0;t<this._cameras.length;++t)if(this._cameras[t]===e)return this._cameras.splice(t,1),void e.detachFromScene()}},{key:"removeCameras",value:function(){for(var e,t=_e(this._cameras);!(e=t()).done;){e.value.detachFromScene()}this._cameras.splice(0)}},{key:"setMainLight",value:function(e){this._mainLight=e}},{key:"unsetMainLight",value:function(e){if(this._mainLight===e){var t=this._directionalLights;t.length?(this._mainLight=t[t.length-1],this._mainLight.node&&(this._mainLight.node.hasChangedFlags|=rh.ROTATION)):this._mainLight=null}}},{key:"addDirectionalLight",value:function(e){e.attachToScene(this),this._directionalLights.push(e)}},{key:"removeDirectionalLight",value:function(e){for(var t=0;t<this._directionalLights.length;++t)if(this._directionalLights[t]===e)return e.detachFromScene(),void this._directionalLights.splice(t,1)}},{key:"addSphereLight",value:function(e){e.attachToScene(this),this._sphereLights.push(e)}},{key:"removeSphereLight",value:function(e){for(var t=0;t<this._sphereLights.length;++t)if(this._sphereLights[t]===e)return e.detachFromScene(),void this._sphereLights.splice(t,1)}},{key:"addSpotLight",value:function(e){e.attachToScene(this),this._spotLights.push(e)}},{key:"removeSpotLight",value:function(e){for(var t=0;t<this._spotLights.length;++t)if(this._spotLights[t]===e)return e.detachFromScene(),void this._spotLights.splice(t,1)}},{key:"removeSphereLights",value:function(){for(var e=0;e<this._sphereLights.length;++e)this._sphereLights[e].detachFromScene();this._sphereLights.length=0}},{key:"removeSpotLights",value:function(){for(var e=0;e<this._spotLights.length;++e)this._spotLights[e].detachFromScene();this._spotLights=[]}},{key:"addModel",value:function(e){e.attachToScene(this),this._models.push(e)}},{key:"removeModel",value:function(e){for(var t=0;t<this._models.length;++t)if(this._models[t]===e)return this._planarShadows.destroyShadowData(e),e.detachFromScene(),void this._models.splice(t,1)}},{key:"removeModels",value:function(){for(var e,t=_e(this._models);!(e=t()).done;){var i=e.value;this._planarShadows.destroyShadowData(i),i.detachFromScene()}this._models.length=0}},{key:"onGlobalPipelineStateChanged",value:function(){for(var e,t=_e(this._models);!(e=t()).done;){e.value.onGlobalPipelineStateChanged()}this._skybox.onGlobalPipelineStateChanged(),this._planarShadows.onGlobalPipelineStateChanged()}},{key:"generateModelId",value:function(){return this._modelId++}},{key:"raycastAll",value:function(e){var t=arguments.length>1&&void 0!==arguments[1]?arguments[1]:bu.Enum.DEFAULT|bu.Enum.UI_2D,i=arguments.length>2&&void 0!==arguments[2]?arguments[2]:1/0,n=this.raycastAllModels(e,t,i),r=this.raycastAllCanvas(e,t,i),a=n||r;return sC.length=0,a&&(Array.prototype.push.apply(sC,nC),Array.prototype.push.apply(sC,oC)),a}},{key:"raycastAllModels",value:function(e){var t=arguments.length>1&&void 0!==arguments[1]?arguments[1]:bu.Enum.DEFAULT,i=arguments.length>2&&void 0!==arguments[2]?arguments[2]:1/0;iC.reset();for(var n,r=_e(this._models);!(n=r()).done;){var a=n.value,o=a.transform;if(o&&a.enabled&&a.node.layer&t&~bu.Enum.IGNORE_RAYCAST&&a.worldBounds){var s=Ka.ray_aabb(e,a.worldBounds);if(!(s<=0||s>=i)){if(a.type===eh.DEFAULT){Ki.invert($w,o.getWorldMatrix($w)),Ii.transformMat4(Qw.o,e.o,$w),Ii.normalize(Qw.d,Ii.transformMat4Normal(Qw.d,e.d,$w)),s=1/0;for(var l=0;l<a.subModelNum;++l){var u=a.getSubModel(l).subMeshData;if(u&&u.geometricInfo){var c=u.geometricInfo,h=c.positions,p=c.indices,_=c.doubleSided;uC(h,p,u.primitiveMode,_,i),s=Math.min(s,eC*Ii.multiply(Jw,Qw.d,o.worldScale).length())}}}if(s<i){var f=iC.add();f.node=a.node,f.distance=s,nC[iC.length-1]=f}}}}return nC.length=iC.length,nC.length>0}},{key:"raycastSingleModel",value:function(e,t){var i=arguments.length>2&&void 0!==arguments[2]?arguments[2]:bu.Enum.DEFAULT,n=arguments.length>3&&void 0!==arguments[3]?arguments[3]:1/0;iC.reset();var r=t,a=r.transform;if(!(a&&r.enabled&&r.node.layer&i&~bu.Enum.IGNORE_RAYCAST&&r.worldBounds))return!1;var o=Ka.ray_aabb(e,r.worldBounds);if(o<=0||o>=n)return!1;if(r.type===eh.DEFAULT){Ki.invert($w,a.getWorldMatrix($w)),Ii.transformMat4(Qw.o,e.o,$w),Ii.normalize(Qw.d,Ii.transformMat4Normal(Qw.d,e.d,$w)),o=1/0;for(var s=0;s<r.subModelNum;++s){var l=r.getSubModel(s).subMeshData;if(l&&l.geometricInfo){var u=l.geometricInfo,c=u.positions,h=u.indices,p=u.doubleSided;uC(c,h,l.primitiveMode,p,n),o=Math.min(o,eC*Ii.multiply(Jw,Qw.d,a.worldScale).length())}}}if(o<n){var _=iC.add();_.node=r.node,_.distance=o,lC[iC.length-1]=_}return lC.length=iC.length,lC.length>0}},{key:"raycastAllCanvas",value:function(e){var t=arguments.length>1&&void 0!==arguments[1]?arguments[1]:bu.Enum.UI_2D,i=arguments.length>2&&void 0!==arguments[2]?arguments[2]:1/0;aC.reset();var n=cc.director.getScene().getComponentsInChildren(cc.CanvasComponent);if(null!=n&&n.length>0)for(var r=0;r<n.length;r++){var a=n[r].node;null!=a&&a.active&&this._raycastUI2DNodeRecursiveChildren(e,a,t,i)}return oC.length=aC.length,oC.length>0}},{key:"_raycastUI2DNode",value:function(e,t){var i=arguments.length>2&&void 0!==arguments[2]?arguments[2]:bu.Enum.UI_2D,n=arguments.length>3&&void 0!==arguments[3]?arguments[3]:1/0,r=t._uiProps.uiTransformComp;if(!(null==r||t.layer&bu.Enum.IGNORE_RAYCAST)&&t.layer&i){r.getComputeAABB(rC);var a=Ka.ray_aabb(e,rC);if(!(a<=0)&&a<n){var o=aC.add();return o.node=t,o.distance=a,o}}}},{key:"_raycastUI2DNodeRecursiveChildren",value:function(e,t){var i=arguments.length>2&&void 0!==arguments[2]?arguments[2]:bu.Enum.UI_2D,n=arguments.length>3&&void 0!==arguments[3]?arguments[3]:1/0,r=this._raycastUI2DNode(e,t,i,n);null!=r&&(oC[aC.length-1]=r);for(var a,o=_e(t.children);!(a=o()).done;){var s=a.value;null!=s&&s.active&&this._raycastUI2DNodeRecursiveChildren(e,s,i,n)}}}]),e}(),Qw=Cn.create(),Jw=new Ii,$w=new Ki,eC=1/0,tC=Mn.create(),iC=new So((function(){return{node:null,distance:1/0}}),8),nC=[],rC=new lo,aC=new So((function(){return{node:null,distance:1/0}}),8),oC=[],sC=[],lC=[],uC=function(e,t,i,n){var r=arguments.length>4&&void 0!==arguments[4]?arguments[4]:1/0;if(eC=r,i===exports.GFXPrimitiveMode.TRIANGLE_LIST)for(var a=t.length,o=0;o<a;o+=3){var s=3*t[o],l=3*t[o+1],u=3*t[o+2];Ii.set(tC.a,e[s],e[s+1],e[s+2]),Ii.set(tC.b,e[l],e[l+1],e[l+2]),Ii.set(tC.c,e[u],e[u+1],e[u+2]);var c=Ka.ray_triangle(Qw,tC,n);c<=0||c>=eC||(eC=c)}else if(i===exports.GFXPrimitiveMode.TRIANGLE_STRIP)for(var h=t.length-2,p=0,_=0;_<h;_+=1){var f=3*t[_-p],d=3*t[_+p+1],m=3*t[_+2];Ii.set(tC.a,e[f],e[f+1],e[f+2]),Ii.set(tC.b,e[d],e[d+1],e[d+2]),Ii.set(tC.c,e[m],e[m+1],e[m+2]),p=~p;var v=Ka.ray_triangle(Qw,tC,n);v<=0||v>=eC||(eC=v)}else if(i===exports.GFXPrimitiveMode.TRIANGLE_FAN){var y=t.length-1,g=3*t[0];Ii.set(tC.a,e[g],e[g+1],e[g+2]);for(var x=1;x<y;x+=1){var b=3*t[x],T=3*t[x+1];Ii.set(tC.b,e[b],e[b+1],e[b+2]),Ii.set(tC.c,e[T],e[T+1],e[T+2]);var S=Ka.ray_triangle(Qw,tC,n);S<=0||S>=eC||(eC=S)}}};exports.replaceProperty(Zw.prototype,"RenderScene.prototype",[{name:"raycastUI",newName:"raycastAllCanvas"},{name:"raycastUI2D",newName:"raycastAllCanvas"},{name:"raycast",newName:"raycastAllModels"},{name:"raycastModels",newName:"raycastAllModels"},{name:"raycastModel",newName:"raycastSingleModel"}]),exports.removeProperty(Zw.prototype,"RenderScene.prototype",[{name:"raycastUI2DNode"},{name:"raycastUINode"}]),exports.markAsWarning(Zw.prototype,"RenderScene.prototype",[{name:"raycastAll",suggest:"using intersect in geometry"},{name:"raycastAllModels",suggest:"using intersect in geometry"},{name:"raycastSingleModel",suggest:"using intersect in geometry"},{name:"raycastAllCanvas",suggest:"using intersect in geometry"},{name:"rayResultCanvas"},{name:"rayResultModels"},{name:"rayResultAll"},{name:"rayResultSingleModel"}]);var cC={};exports.removeProperty(cC,"CameraVisFlags",[{name:"GENERAL"}]),exports.replaceProperty(cC,"CameraVisFlags",[{name:"PROFILER",newName:"PROFILER",target:bu.BitMask,targetName:"PROFILER"},{name:"GIZMOS",newName:"GIZMOS",target:bu.BitMask,targetName:"GIZMOS"},{name:"EDITOR",newName:"EDITOR",target:bu.BitMask,targetName:"EDITOR"},{name:"UI",newName:"UI",target:bu.BitMask,targetName:"UI_3D"},{name:"UI2D",newName:"UI2D",target:bu.BitMask,targetName:"UI_2D"}]),cc.CameraVisFlags=cC;var hC={};exports.removeProperty(hC,"VisibilityFlags",[{name:"GENERAL"}]),exports.replaceProperty(hC,"VisibilityFlags",[{name:"ALWALS",newName:"ALWALS",target:bu.Enum,targetName:"ALWALS"},{name:"PROFILER",newName:"PROFILER",target:bu.Enum,targetName:"PROFILER"},{name:"GIZMOS",newName:"GIZMOS",target:bu.Enum,targetName:"GIZMOS"},{name:"EDITOR",newName:"EDITOR",target:bu.Enum,targetName:"EDITOR"},{name:"UI",newName:"UI",target:bu.Enum,targetName:"UI_3D"},{name:"UI2D",newName:"UI2D",target:bu.Enum,targetName:"UI_2D"}]),cc.VisibilityFlags=hC;var pC,_C,fC,dC,mC,vC,yC,gC,xC,bC,TC,SC,EC,wC,CC,AC=new Ii(0,0,-1),OC=new Ii,kC=new Xi,RC=function(e){function t(){var e;return Z(this,t),(e=re(this,te(t).call(this)))._dir=new Ii(1,-1,-1),e._illum=Gg.SUN_ILLUM,e._type=ZT.DIRECTIONAL,e}return ee(t,eS),J(t,[{key:"direction",set:function(e){this._dir=e,Ii.normalize(this._dir,this._dir)},get:function(){return this._dir}},{key:"illuminance",set:function(e){this._illum=e},get:function(){return this._illum}}]),J(t,[{key:"update",value:function(){this._node&&this._node.hasChangedFlags&&(this._dir=Ii.transformQuat(OC,AC,this._node.getWorldRotation(kC)),Ii.normalize(this._dir,this._dir))}}]),t}(),FC=function(e){function t(){var e;return Z(this,t),(e=re(this,te(t).call(this)))._needUpdate=!1,e._size=.15,e._range=1,e._luminance=1700/$T(e._size),e._pos=void 0,e._aabb=void 0,e._type=ZT.SPHERE,e._aabb=lo.create(),e._pos=new Ii,e}return ee(t,eS),J(t,[{key:"position",get:function(){return this._pos}},{key:"size",set:function(e){this._size=e},get:function(){return this._size}},{key:"range",set:function(e){this._range=e,this._needUpdate=!0},get:function(){return this._range}},{key:"luminance",set:function(e){this._luminance=e},get:function(){return this._luminance}},{key:"aabb",get:function(){return this._aabb}}]),J(t,[{key:"update",value:function(){this._node&&(this._node.hasChangedFlags||this._needUpdate)&&(this._node.getWorldPosition(this._pos),lo.set(this._aabb,this._pos.x,this._pos.y,this._pos.z,this._range,this._range,this._range),this._needUpdate=!1)}}]),t}(),MC=new Ii(0,0,-1),IC=(new Ii,new Xi),PC=new Ki,LC=new Ki,DC=new Ki,NC=new Ki,zC=function(e){function t(){var e;return Z(this,t),(e=re(this,te(t).call(this)))._dir=new Ii(1,-1,-1),e._size=.15,e._range=5,e._luminance=1700/$T(e._size),e._spotAngle=Math.cos(Math.PI/6),e._pos=void 0,e._aabb=void 0,e._frustum=void 0,e._angle=0,e._needUpdate=!1,e._type=ZT.SPOT,e._aabb=lo.create(),e._frustum=mo.create(),e._pos=new Ii,e}return ee(t,eS),J(t,[{key:"position",get:function(){return this._pos}},{key:"size",set:function(e){this._size=e},get:function(){return this._size}},{key:"range",set:function(e){this._range=e,this._needUpdate=!0},get:function(){return this._range}},{key:"luminance",set:function(e){this._luminance=e},get:function(){return this._luminance}},{key:"direction",get:function(){return this._dir}},{key:"spotAngle",get:function(){return this._spotAngle},set:function(e){this._angle=.5*e,this._spotAngle=Math.cos(.5*e),this._needUpdate=!0}},{key:"aabb",get:function(){return this._aabb}},{key:"frustum",get:function(){return this._frustum}}]),J(t,[{key:"update",value:function(){this._node&&(this._node.hasChangedFlags||this._needUpdate)&&(this._node.getWorldPosition(this._pos),Ii.transformQuat(this._dir,MC,this._node.getWorldRotation(IC)),Ii.normalize(this._dir,this._dir),lo.set(this._aabb,this._pos.x,this._pos.y,this._pos.z,this._range,this._range,this._range),this._node.getWorldRT(PC),Ki.invert(PC,PC),Ki.perspective(LC,this._angle,1,.001,this._range),Ki.multiply(DC,LC,PC),this._frustum.update(DC,NC),this._needUpdate=!1)}}]),t}(),BC=function e(){Z(this,e),this.material=null,this.vertexCount=0,this.indiceCount=0},GC=function(e){function t(){var e,i;Z(this,t);for(var n=arguments.length,r=new Array(n),a=0;a<n;a++)r[a]=arguments[a];return(i=re(this,(e=te(t)).call.apply(e,[this].concat(r)))).vData=null,i.uvDirty=!0,i.vertDirty=!0,i._datas=[],i._indices=[],i._pivotX=0,i._pivotY=0,i._width=0,i._height=0,i}return ee(t,BC),J(t,[{key:"updateSizeNPivot",value:function(e,t,i,n){e===this._width&&t===this._height&&i===this._pivotX&&n===this._pivotY||(this._width=e,this._height=t,this._pivotX=i,this._pivotY=n,this.vertDirty=!0)}},{key:"clear",value:function(){this._datas.length=0,this._indices.length=0,this._pivotX=0,this._pivotY=0,this._width=0,this._height=0,this.uvDirty=!0,this.vertDirty=!0,this.material=null,this.vertexCount=0,this.indiceCount=0}},{key:"dataLength",get:function(){return this._datas.length},set:function(e){var t=this._datas;if(t.length!==e){var i=t.length,n=0;for(n=e;n<i;n++)XC.free(t[n]);for(n=i;n<e;n++)t[n]=XC.alloc();t.length=e}}},{key:"datas",get:function(){return this._datas}}],[{key:"add",value:function(){return VC.add()}},{key:"remove",value:function(e){var t=VC.data.indexOf(e);-1!==t&&(VC.data[t].clear(),VC.removeAt(t))}}]),t}(),UC=function(e){function t(){var e,i;Z(this,t);for(var n=arguments.length,r=new Array(n),a=0;a<n;a++)r[a]=arguments[a];return(i=re(this,(e=te(t)).call.apply(e,[this].concat(r)))).vData=new Float32Array(2304*Float32Array.BYTES_PER_ELEMENT),i.iData=new Uint16Array(1536),i.vertexStart=0,i.indiceStart=0,i.byteStart=0,i.byteCount=0,i._formatByte=9*Float32Array.BYTES_PER_ELEMENT,i}return ee(t,BC),J(t,[{key:"request",value:function(e,t){var i=this.byteCount+e*this._formatByte,n=this.indiceCount+t;if(e+this.vertexCount>65535)return!1;var r=this.vData.byteLength,a=this.iData.length,o=this.vData.length,s=this.iData.length;if(i>r||n>a){for(;r<i||a<n;)r=4*(o*=2),a=s*=2;var l=new Float32Array(this.vData.buffer);this.vData=new Float32Array(o),this.vData.set(l,0);var u=new Uint16Array(this.iData.buffer);this.iData=new Uint16Array(s),this.iData.set(u,0)}return this.vertexCount+=e,this.indiceCount+=t,this.byteCount=i,!0}},{key:"reset",value:function(){this.vertexCount=0,this.indiceCount=0,this.byteCount=0,this.vertexStart=0,this.indiceStart=0,this.byteStart=0}}]),t}(),XC=new To((function(){return{x:0,y:0,z:0,u:0,v:0,color:an.WHITE.clone()}}),128),VC=new So((function(){return new GC}),32),HC=dE,WC=Object.freeze({__proto__:null,addStage:HC,createIA:function(e,t){if(!t.positions)return console.error("The data must have positions field"),null;for(var i=[],n=t.positions.length/3,r=0;r<n;++r)i.push(t.positions[3*r],t.positions[3*r+1],t.positions[3*r+2]),t.normals&&i.push(t.normals[3*r],t.normals[3*r+1],t.normals[3*r+2]),t.uvs&&i.push(t.uvs[2*r],t.uvs[2*r+1]),t.colors&&i.push(t.colors[3*r],t.uvs[3*r+1],t.colors[3*r+2]);var a=[];a.push({name:exports.GFXAttributeName.ATTR_POSITION,format:exports.GFXFormat.RGB32F}),t.normals&&a.push({name:exports.GFXAttributeName.ATTR_NORMAL,format:exports.GFXFormat.RGB32F}),t.uvs&&a.push({name:exports.GFXAttributeName.ATTR_TEX_COORD,format:exports.GFXFormat.RG32F}),t.colors&&a.push({name:exports.GFXAttributeName.ATTR_COLOR,format:exports.GFXFormat.RGB32F});var o=e.createBuffer({usage:exports.GFXBufferUsageBit.VERTEX|exports.GFXBufferUsageBit.TRANSFER_DST,memUsage:exports.GFXMemoryUsageBit.HOST|exports.GFXMemoryUsageBit.DEVICE,size:4*i.length,stride:4*i.length/n});o.update(new Float32Array(i));var s=e.createBuffer({usage:exports.GFXBufferUsageBit.INDEX|exports.GFXBufferUsageBit.TRANSFER_DST,memUsage:exports.GFXMemoryUsageBit.HOST|exports.GFXMemoryUsageBit.DEVICE,size:2*t.indices.length,stride:2});return s.update(new Uint16Array(t.indices)),e.createInputAssembler({attributes:a,vertexBuffers:[o],indexBuffer:s})},get RenderQueue(){return hE},get PassStage(){return pE},genHandle:Dc,getBindingTypeFromHandle:Nc,getTypeFromHandle:zc,getBindingFromHandle:Bc,getOffsetFromHandle:Gc,customizeType:Uc,type2reader:Xc,type2writer:Vc,getDefaultFromType:Wc,assignDefines:jc,Pass:Eh,programLib:$c,get SamplerInfoIndex(){return Bl},genSamplerHash:Wl,samplerLib:ou,nearestPOT:mE,TextureBufferPool:EE,MaterialInstance:Xp,PassInstance:Up,uploadJointData:PE,MINIMUM_JOINT_TEXTURE_SIZE:480,selectJointsMediumFormat:LE,jointTextureSamplerHash:NE,JointTexturePool:jE,JointAnimationInfo:qE,getWorldMatrix:QE,getTransform:JE,deleteTransform:$E,SkinningModel:lw,BakedSkinningModel:cw,Ambient:Gg,get CameraFOVAxis(){return nv},get CameraProjection(){return rv},get CameraAperture(){return av},get CameraISO(){return ov},get CameraShutter(){return sv},SKYBOX_FLAG:yv,Camera:gv,CameraVisFlags:cC,VisibilityFlags:hC,DirectionalLight:RC,ColorTemperatureToRGB:JT,get LightType(){return ZT},nt2lm:$T,Light:eS,get ModelType(){return eh},Model:ah,PlanarShadows:dw,RenderScene:Zw,Skybox:Kw,SphereLight:FC,SpotLight:zC,SubModel:Lc}),jC=Yo("cc.UIComponent")(pC=$o(Iy)(pC=ts(110)(pC=is(pC=Jo(pC=function(e){function t(){var e,i;Z(this,t);for(var n=arguments.length,r=new Array(n),a=0;a<n;a++)r[a]=arguments[a];return(i=re(this,(e=te(t)).call.apply(e,[this].concat(r))))._lastParent=null,i}return ee(t,rp),J(t,[{key:"__preload",value:function(){this.node._uiProps.uiComp=this}},{key:"onEnable",value:function(){}},{key:"onDisable",value:function(){}},{key:"onDestroy",value:function(){this.node._uiProps.uiComp===this&&(this.node._uiProps.uiComp=null)}},{key:"updateAssembler",value:function(e){}},{key:"postUpdateAssembler",value:function(e){}}]),t}())||pC)||pC)||pC)||pC)||pC;bt(exports.GFXBlendFactor),(CC=exports.InstanceMaterialType||(exports.InstanceMaterialType={}))[CC.ADDCOLOR=0]="ADDCOLOR",CC[CC.ADDCOLORANDTEXTURE=1]="ADDCOLORANDTEXTURE",CC[CC.GRAYSCALE=2]="GRAYSCALE";var qC,YC,KC,ZC,QC,JC,$C,eA,tA,iA,nA,rA,aA,oA,sA,lA,uA,cA,hA,pA,_A,fA,dA,mA,vA,yA,gA,xA,bA,TA,SA,EA={parent:null,owner:null,subModelIdx:0},wA=(_C=Yo("cc.UIRenderComponent"),fC=Ko({type:exports.GFXBlendFactor,displayOrder:0,tooltip:"原图混合模式"}),dC=Ko({type:exports.GFXBlendFactor,displayOrder:1,tooltip:"目标混合模式"}),mC=Ko({displayOrder:2,tooltip:"渲染颜色"}),vC=Ko({type:Bh,displayOrder:3,tooltip:"源材质",visible:!1}),_C((wC=EC=function(e){function t(){var e,i;Z(this,t);for(var n=arguments.length,r=new Array(n),a=0;a<n;a++)r[a]=arguments[a];return fe(i=re(this,(e=te(t)).call.apply(e,[this].concat(r))),"_srcBlendFactor",xC,ne(i)),fe(i,"_dstBlendFactor",bC,ne(i)),fe(i,"_color",TC,ne(i)),fe(i,"_sharedMaterial",SC,ne(i)),i._assembler=null,i._postAssembler=null,i._renderData=null,i._renderDataFlag=!0,i._renderFlag=!0,i._delegateSrc=null,i._material=null,i._instanceMaterialType=exports.InstanceMaterialType.ADDCOLORANDTEXTURE,i._blendTemplate={blendState:{targets:[{blendSrc:exports.GFXBlendFactor.SRC_ALPHA,blendDst:exports.GFXBlendFactor.ONE_MINUS_SRC_ALPHA}]},depthStencilState:{},rasterizerState:{}},i}return ee(t,jC),J(t,[{key:"__preload",value:function(){oe(te(t.prototype),"__preload",this).call(this),this._instanceMaterial(),this._flushAssembler&&this._flushAssembler()}},{key:"onEnable",value:function(){oe(te(t.prototype),"onEnable",this).call(this),this.node.on(exports.SystemEventType.ANCHOR_CHANGED,this._nodeStateChange,this),this.node.on(exports.SystemEventType.SIZE_CHANGED,this._nodeStateChange,this),this._renderFlag=this._canRender()}},{key:"onDisable",value:function(){oe(te(t.prototype),"onDisable",this).call(this),this.node.off(exports.SystemEventType.ANCHOR_CHANGED,this._nodeStateChange,this),this.node.off(exports.SystemEventType.SIZE_CHANGED,this._nodeStateChange,this),this._renderFlag=!1}},{key:"onDestroy",value:function(){oe(te(t.prototype),"onDestroy",this).call(this),this.destroyRenderData(),this._material&&this._material.destroy(),this._updateMaterial(null),this._renderData=null}},{key:"markForUpdateRenderData",value:function(){var e=!(arguments.length>0&&void 0!==arguments[0])||arguments[0];if(this._renderFlag=this._canRender(),e&&this._renderFlag){var t=this._renderData;t&&(t.vertDirty=!0),this._renderDataFlag=e}else e||(this._renderDataFlag=e)}},{key:"requestRenderData",value:function(){var e=GC.add();return this._renderData=e,e}},{key:"destroyRenderData",value:function(){this._renderData&&(GC.remove(this._renderData),this._renderData=null)}},{key:"updateAssembler",value:function(e){oe(te(t.prototype),"updateAssembler",this).call(this,e),this._renderFlag&&(this._checkAndUpdateRenderData(),this._render(e))}},{key:"postUpdateAssembler",value:function(e){oe(te(t.prototype),"postUpdateAssembler",this).call(this,e),this._renderFlag&&this._postRender(e)}},{key:"_render",value:function(e){}},{key:"_postRender",value:function(e){}},{key:"_checkAndUpdateRenderData",value:function(){this._renderDataFlag&&(this._assembler.updateRenderData(this),this._renderDataFlag=!1)}},{key:"_canRender",value:function(){return null!==this.material&&this.enabled&&(this._delegateSrc?this._delegateSrc.activeInHierarchy:this.enabledInHierarchy)}},{key:"_postCanRender",value:function(){}},{key:"_updateColor",value:function(){this._assembler&&this._assembler.updateColor&&this._assembler.updateColor(this)}},{key:"_updateMaterial",value:function(e){this._material=e,this._updateBlendFunc()}},{key:"_updateBlendFunc",value:function(){if(this._material){var e=this._blendTemplate.blendState.targets[0];e.blendDst===this._dstBlendFactor&&e.blendSrc===this._srcBlendFactor||(e.blendDst=this._dstBlendFactor,e.blendSrc=this._srcBlendFactor,this._blendTemplate.depthStencilState=this._material.passes[0].depthStencilState,this._blendTemplate.rasterizerState=this._material.passes[0].rasterizerState,this._material.overridePipelineStates(this._blendTemplate,0))}}},{key:"_nodeStateChange",value:function(e){this._renderData&&this.markForUpdateRenderData();for(var i,n=_e(this.node.children);!(i=n()).done;){var r=i.value.getComponent(t);r&&r.markForUpdateRenderData()}}},{key:"_instanceMaterial",value:function(){var e=null;if(EA.owner=new Hp,this._sharedMaterial)EA.parent=this._sharedMaterial,e=new Xp(EA);else switch(this._instanceMaterialType){case exports.InstanceMaterialType.ADDCOLOR:EA.parent=Pc.get("ui-base-material"),e=new Xp(EA);break;case exports.InstanceMaterialType.ADDCOLORANDTEXTURE:EA.parent=Pc.get("ui-sprite-material"),e=new Xp(EA);break;case exports.InstanceMaterialType.GRAYSCALE:EA.parent=Pc.get("ui-sprite-gray-material"),e=new Xp(EA)}this._updateMaterial(e)}},{key:"srcBlendFactor",get:function(){return this._srcBlendFactor},set:function(e){this._srcBlendFactor!==e&&(this._srcBlendFactor=e,this._updateBlendFunc())}},{key:"dstBlendFactor",get:function(){return this._dstBlendFactor},set:function(e){this._dstBlendFactor!==e&&(this._dstBlendFactor=e,this._updateBlendFunc())}},{key:"color",get:function(){return this._color},set:function(e){this._color!==e&&(this._color.set(e),this._updateColor(),this.markForUpdateRenderData())}},{key:"sharedMaterial",get:function(){return this._sharedMaterial},set:function(e){this._sharedMaterial!==e&&(this._sharedMaterial=e,this._instanceMaterial&&this._instanceMaterial())}},{key:"material",get:function(){return this._material||this._instanceMaterial&&this._instanceMaterial(),this._material}},{key:"renderData",get:function(){return this._renderData}},{key:"delegateSrc",set:function(e){this._delegateSrc=e}}]),t}(),EC.BlendState=exports.GFXBlendFactor,EC.Assembler=null,EC.PostAssembler=null,de((gC=wC).prototype,"srcBlendFactor",[fC],Object.getOwnPropertyDescriptor(gC.prototype,"srcBlendFactor"),gC.prototype),de(gC.prototype,"dstBlendFactor",[dC],Object.getOwnPropertyDescriptor(gC.prototype,"dstBlendFactor"),gC.prototype),de(gC.prototype,"color",[mC],Object.getOwnPropertyDescriptor(gC.prototype,"color"),gC.prototype),de(gC.prototype,"sharedMaterial",[vC],Object.getOwnPropertyDescriptor(gC.prototype,"sharedMaterial"),gC.prototype),xC=de(gC.prototype,"_srcBlendFactor",[Ko],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return exports.GFXBlendFactor.SRC_ALPHA}}),bC=de(gC.prototype,"_dstBlendFactor",[Ko],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return exports.GFXBlendFactor.ONE_MINUS_SRC_ALPHA}}),TC=de(gC.prototype,"_color",[Ko],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return an.WHITE.clone()}}),SC=de(gC.prototype,"_sharedMaterial",[Ko],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return null}}),yC=gC))||yC);cc.UIRenderComponent=wA,function(e){e[e.SIMPLE=0]="SIMPLE",e[e.SLICED=1]="SLICED",e[e.TILED=2]="TILED",e[e.FILLED=3]="FILLED"}(xA||(xA={})),bt(xA),function(e){e[e.HORIZONTAL=0]="HORIZONTAL",e[e.VERTICAL=1]="VERTICAL",e[e.RADIAL=2]="RADIAL"}(bA||(bA={})),bt(bA),function(e){e[e.CUSTOM=0]="CUSTOM",e[e.TRIMMED=1]="TRIMMED",e[e.RAW=2]="RAW"}(TA||(TA={})),bt(TA),function(e){e.SPRITE_FRAME_CHANGED="spriteframe-changed"}(SA||(SA={}));var CA,AA,OA,kA,RA,FA,MA,IA,PA,LA=(qC=Yo("cc.SpriteComponent"),YC=os("i18n:cc.SpriteComponent"),KC=ts(110),ZC=es("UI/Render/Sprite"),QC=Ko({type:bf,displayOrder:4,tooltip:"图片资源所属的 Atlas 图集资源"}),JC=Ko({type:Ac,displayOrder:5,tooltip:"渲染 Sprite 使用的 SpriteFrame 图片资源"}),$C=Ko({type:xA,displayOrder:6,tooltip:"渲染模式：\n- 普通（Simple）：修改尺寸会整体拉伸图像，适用于序列帧动画和普通图像 \n- 九宫格（Sliced）：修改尺寸时四个角的区域不会拉伸，适用于 UI 按钮和面板背景 \n- 填充（Filled）：设置一定的填充起始位置和方向，能够以一定比率剪裁显示图片"}),eA=Ko({type:bA,tooltip:"填充方向，可以选择横向（Horizontal），纵向（Vertical）和扇形（Radial）三种方向"}),tA=Ko({tooltip:"扇形填充时，指定扇形的中心点，取值范围 0 ~ 1"}),iA=Ko({range:[0,1,.1],tooltip:"填充起始位置，输入一个 0 ~ 1 之间的小数表示起始位置的百分比"}),nA=Ko({range:[0,1,.1],tooltip:"填充总量，取值范围 0 ~ 1 指定显示图像范围的百分比"}),rA=Ko({displayOrder:8,tooltip:"节点约束框内是否包括透明像素区域，勾选此项会去除节点约束框内的透明区域"}),aA=Ko({type:TA,displayOrder:7,tooltip:"指定 Sprite 所在节点的尺寸，CUSTOM 表示自定义尺寸，TRIMMED 表示取原始图片剪裁透明像素后的尺寸，RAW 表示取原始图片未剪裁的尺寸"}),qC(oA=YC(oA=KC(oA=ZC((gA=yA=function(e){function t(){var e,i;Z(this,t);for(var n=arguments.length,r=new Array(n),a=0;a<n;a++)r[a]=arguments[a];return fe(i=re(this,(e=te(t)).call.apply(e,[this].concat(r))),"_spriteFrame",lA,ne(i)),fe(i,"_type",uA,ne(i)),fe(i,"_fillType",cA,ne(i)),fe(i,"_sizeMode",hA,ne(i)),fe(i,"_fillCenter",pA,ne(i)),fe(i,"_fillStart",_A,ne(i)),fe(i,"_fillRange",fA,ne(i)),fe(i,"_isTrimmedMode",dA,ne(i)),fe(i,"_useGrayscale",mA,ne(i)),fe(i,"_atlas",vA,ne(i)),i}return ee(t,wA),J(t,[{key:"__preload",value:function(){this._useGrayscale&&(this._instanceMaterialType=exports.InstanceMaterialType.GRAYSCALE),oe(te(t.prototype),"__preload",this)&&oe(te(t.prototype),"__preload",this).call(this),this._spriteFrame&&(this._spriteFrame.on("load",this._markForUpdateUvDirty,this),this._markForUpdateUvDirty())}},{key:"onEnable",value:function(){oe(te(t.prototype),"onEnable",this).call(this),this._activateMaterial()}},{key:"onDestroy",value:function(){oe(te(t.prototype),"onDestroy",this).call(this),this.destroyRenderData(),this._spriteFrame&&this._spriteFrame.off("load")}},{key:"changeSpriteFrameFromAtlas",value:function(e){if(this._atlas){var t=this._atlas.getSpriteFrame(e);this.spriteFrame=t}else console.warn("SpriteAtlas is null.")}},{key:"_render",value:function(e){e.commitComp(this,this._spriteFrame.getGFXTextureView(),this._assembler,this._spriteFrame.texture.getGFXSampler())}},{key:"_canRender",value:function(){if(!oe(te(t.prototype),"_canRender",this).call(this))return!1;var e=this._spriteFrame;return!(!e||!e.textureLoaded())}},{key:"_flushAssembler",value:function(){var e=t.Assembler.getAssembler(this);this._assembler!==e&&(this.destroyRenderData(),this._assembler=e),this._renderData||this._assembler&&this._assembler.createData&&(this._renderData=this._assembler.createData(this),this._renderData.material=this._material,this.markForUpdateRenderData(),this._updateColor())}},{key:"_applySpriteSize",value:function(){if(this._spriteFrame){if(TA.RAW===this._sizeMode){var e=this._spriteFrame.originalSize;this.node.setContentSize(e)}else if(TA.TRIMMED===this._sizeMode){var t=this._spriteFrame.getRect();this.node.setContentSize(t.width,t.height)}this._activateMaterial()}}},{key:"_resized",value:function(){}},{key:"_activateMaterial",value:function(){var e=this._spriteFrame,t=this._material;cc.game.renderType!==cc.game.RENDER_TYPE_CANVAS?(e&&t&&this.markForUpdateRenderData(),this._renderData&&(this._renderData.material=t)):this.markForUpdateRenderData()}},{key:"_onTextureLoaded",value:function(){this.isValid&&this._applySpriteSize()}},{key:"_applySpriteFrame",value:function(e){var t=this._spriteFrame;this._renderData&&(e&&e.off("load",this._markForUpdateUvDirty),t&&t.on("load",this._markForUpdateUvDirty,this),this._renderData.uvDirty||(this._renderData.uvDirty=!e||!t||e.uvHash!==t.uvHash),this._renderDataFlag=this._renderData.uvDirty),t&&(e&&t===e||(t.loaded?this._onTextureLoaded():t.once("load",this._onTextureLoaded,this)))}},{key:"_markForUpdateUvDirty",value:function(){this._renderData&&(this._renderData.uvDirty=!0,this._renderDataFlag=!0)}},{key:"spriteAtlas",get:function(){return this._atlas},set:function(e){this._atlas!==e&&(this._atlas=e)}},{key:"spriteFrame",get:function(){return this._spriteFrame},set:function(e){if(this._spriteFrame!==e){var t=this._spriteFrame;this._spriteFrame=e,this.markForUpdateRenderData(!1),this._applySpriteFrame(t)}}},{key:"type",get:function(){return this._type},set:function(e){this._type!==e&&(this._type=e,this._flushAssembler())}},{key:"fillType",get:function(){return this._fillType},set:function(e){this._fillType!==e&&(e===bA.RADIAL||this._fillType===bA.RADIAL?(this.destroyRenderData(),this._renderData=null):this._renderData&&this.markForUpdateRenderData(!0)),this._fillType=e,this._flushAssembler()}},{key:"fillCenter",get:function(){return this._fillCenter},set:function(e){this._fillCenter.x=e.x,this._fillCenter.y=e.y,this._type===xA.FILLED&&this._renderData&&this.markForUpdateRenderData()}},{key:"fillStart",get:function(){return this._fillStart},set:function(e){this._fillStart=pi(e,-1,1),this._type===xA.FILLED&&this._renderData&&(this.markForUpdateRenderData(),this._renderData.uvDirty=!0)}},{key:"fillRange",get:function(){return this._fillRange},set:function(e){this._fillRange=pi(e,0,1),this._type===xA.FILLED&&this._renderData&&(this.markForUpdateRenderData(),this._renderData.uvDirty=!0)}},{key:"trim",get:function(){return this._isTrimmedMode},set:function(e){this._isTrimmedMode!==e&&(this._isTrimmedMode=e,this._type===xA.SIMPLE&&this._renderData&&this.markForUpdateRenderData(!0))}},{key:"grayscale",get:function(){return this._useGrayscale},set:function(e){this._useGrayscale!==e&&(this._useGrayscale=e,this._instanceMaterialType=!0===e?exports.InstanceMaterialType.GRAYSCALE:exports.InstanceMaterialType.ADDCOLORANDTEXTURE,this._instanceMaterial())}},{key:"sizeMode",get:function(){return this._sizeMode},set:function(e){this._sizeMode!==e&&(this._sizeMode=e,e!==TA.CUSTOM&&this._applySpriteSize())}}]),t}(),yA.FillType=bA,yA.Type=xA,yA.SizeMode=TA,yA.EventType=SA,de((sA=gA).prototype,"spriteAtlas",[QC],Object.getOwnPropertyDescriptor(sA.prototype,"spriteAtlas"),sA.prototype),de(sA.prototype,"spriteFrame",[JC],Object.getOwnPropertyDescriptor(sA.prototype,"spriteFrame"),sA.prototype),de(sA.prototype,"type",[$C],Object.getOwnPropertyDescriptor(sA.prototype,"type"),sA.prototype),de(sA.prototype,"fillType",[eA],Object.getOwnPropertyDescriptor(sA.prototype,"fillType"),sA.prototype),de(sA.prototype,"fillCenter",[tA],Object.getOwnPropertyDescriptor(sA.prototype,"fillCenter"),sA.prototype),de(sA.prototype,"fillStart",[iA],Object.getOwnPropertyDescriptor(sA.prototype,"fillStart"),sA.prototype),de(sA.prototype,"fillRange",[nA],Object.getOwnPropertyDescriptor(sA.prototype,"fillRange"),sA.prototype),de(sA.prototype,"trim",[rA],Object.getOwnPropertyDescriptor(sA.prototype,"trim"),sA.prototype),de(sA.prototype,"grayscale",[Ko],Object.getOwnPropertyDescriptor(sA.prototype,"grayscale"),sA.prototype),de(sA.prototype,"sizeMode",[aA],Object.getOwnPropertyDescriptor(sA.prototype,"sizeMode"),sA.prototype),lA=de(sA.prototype,"_spriteFrame",[Ko],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return null}}),uA=de(sA.prototype,"_type",[Ko],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return xA.SIMPLE}}),cA=de(sA.prototype,"_fillType",[Ko],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return bA.HORIZONTAL}}),hA=de(sA.prototype,"_sizeMode",[Ko],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return TA.TRIMMED}}),pA=de(sA.prototype,"_fillCenter",[Ko],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return new ki(0,0)}}),_A=de(sA.prototype,"_fillStart",[Ko],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return 0}}),fA=de(sA.prototype,"_fillRange",[Ko],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return 0}}),dA=de(sA.prototype,"_isTrimmedMode",[Ko],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return!0}}),mA=de(sA.prototype,"_useGrayscale",[Ko],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return!1}}),vA=de(sA.prototype,"_atlas",[Ko],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return null}}),oA=sA))||oA)||oA)||oA)||oA);cc.SpriteComponent=LA;var DA=(CA=Yo("cc.SubContextView"),AA=os("i18n:cc.SubContextView"),OA=ts(110),kA=$o(Iy),RA=es("Components/SubContextView"),FA=Ko({tooltip:"帧数"}),CA(MA=AA(MA=OA(MA=kA(MA=RA((de((IA=function(e){function t(){var e;return Z(this,t),fe(e=re(this,te(t).call(this)),"_fps",PA,ne(e)),e._sprite=void 0,e._imageAsset=void 0,e._context=void 0,e._updatedTime=0,e._updateInterval=0,e._firstlyEnabled=!0,e._sprite=null,e._imageAsset=new Gl,e._context=null,e._updatedTime=performance.now(),e}return ee(t,rp),J(t,[{key:"fps",get:function(){return this._fps},set:function(e){this._fps!==e&&(this._fps=e,this._updateInterval=1/e,this._updateSubContextFrameRate())}}]),J(t,[{key:"onLoad",value:function(){if(window.__globalAdapter&&__globalAdapter.getOpenDataContext){this._updateInterval=1e3/this._fps,this._context=__globalAdapter.getOpenDataContext(),this.reset();var e=this._imageAsset,t=this._context.canvas;if(e.reset(t),e._texture.create(t.width,t.height),this._sprite=this.node.getComponent(LA),this._sprite||(this._sprite=this.node.addComponent(LA)),this._sprite.spriteFrame)this._sprite.spriteFrame.texture=this._imageAsset._texture;else{var i=new Ac;i.texture=this._imageAsset._texture,this._sprite.spriteFrame=i}}else this.enabled=!1}},{key:"onEnable",value:function(){this._firstlyEnabled&&this._context?(this._context.postMessage({fromEngine:!0,event:"boot"}),this._firstlyEnabled=!1):this._runSubContextMainLoop(),this._registerNodeEvent(),this._updateSubContextFrameRate(),this.updateSubContextViewport()}},{key:"onDisable",value:function(){this._unregisterNodeEvent(),this._stopSubContextMainLoop()}},{key:"update",value:function(e){if(void 0===e)return this._context&&this._context.postMessage({fromEngine:!0,event:"step"}),void this._updateSubContextTexture();performance.now()-this._updatedTime>=this._updateInterval&&(this._updatedTime+=this._updateInterval,this._updateSubContextTexture())}},{key:"reset",value:function(){if(this._context){this.updateSubContextViewport();var e=this._context.canvas,t=this.node.getComponent(Iy);e&&(e.width=t.width,e.height=t.height)}}},{key:"updateSubContextViewport",value:function(){if(this._context){var e=this.node.getComponent(Iy).getBoundingBoxToWorld(),t=nE.getScaleX(),i=nE.getScaleY(),n=nE.getViewportRect();this._context.postMessage({fromEngine:!0,event:"viewport",x:e.x*t+n.x,y:e.y*i+n.y,width:e.width*t,height:e.height*i})}}},{key:"_updateSubContextTexture",value:function(){var e=this._imageAsset;if(e&&this._context&&!(e.width<=0||e.height<=0)){var t=this._context.canvas;e.reset(t),(t.width>e.width||t.height>e.height)&&this._imageAsset._texture.create(t.width,t.height),this._imageAsset._texture.uploadData(t)}}},{key:"_registerNodeEvent",value:function(){this.node.on(tg.EventType.TRANSFORM_CHANGED,this.updateSubContextViewport,this),this.node.on(tg.EventType.SIZE_CHANGED,this.updateSubContextViewport,this)}},{key:"_unregisterNodeEvent",value:function(){this.node.off(tg.EventType.TRANSFORM_CHANGED,this.updateSubContextViewport,this),this.node.off(tg.EventType.SIZE_CHANGED,this.updateSubContextViewport,this)}},{key:"_runSubContextMainLoop",value:function(){this._context&&this._context.postMessage({fromEngine:!0,event:"mainLoop",value:!0})}},{key:"_stopSubContextMainLoop",value:function(){this._context&&this._context.postMessage({fromEngine:!0,event:"mainLoop",value:!1})}},{key:"_updateSubContextFrameRate",value:function(){this._context&&this._context.postMessage({fromEngine:!0,event:"frameRate",value:this._fps})}}]),t}()).prototype,"fps",[FA],Object.getOwnPropertyDescriptor(IA.prototype,"fps"),IA.prototype),PA=de(IA.prototype,"_fps",[Ko],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return 60}}),MA=IA))||MA)||MA)||MA)||MA)||MA);cc.SubContextView=DA;var NA=function(){function e(){Z(this,e),this._id="",this._priority=0,this._executeInEditMode=!1}return J(e,[{key:"init",value:function(){}},{key:"update",value:function(e){}},{key:"postUpdate",value:function(e){}},{key:"priority",set:function(e){this._priority=e},get:function(){return this._priority}},{key:"id",set:function(e){this._id=e},get:function(){return this._id}}],[{key:"sortByPriority",value:function(e,t){return e._priority<t._priority?1:e._priority>t.priority?-1:0}}]),e}(),zA=new be("Scheduler"),BA=function e(t,i,n,r){Z(this,e),this.target=void 0,this.priority=void 0,this.paused=void 0,this.markedForDeletion=void 0,this.target=t,this.priority=i,this.paused=n,this.markedForDeletion=r};BA.get=function(e,t,i,n){var r=BA._listEntries.pop();return r?(r.target=e,r.priority=t,r.paused=i,r.markedForDeletion=n):r=new BA(e,t,i,n),r},BA.put=function(e){BA._listEntries.length<20&&(e.target=null,BA._listEntries.push(e))},BA._listEntries=[];var GA=function e(t,i,n,r){Z(this,e),this.list=void 0,this.entry=void 0,this.target=void 0,this.callback=void 0,this.list=t,this.entry=i,this.target=n,this.callback=r};GA.get=function(e,t,i,n){var r=GA._hashUpdateEntries.pop();return r?(r.list=e,r.entry=t,r.target=i,r.callback=n):r=new GA(e,t,i,n),r},GA.put=function(e){GA._hashUpdateEntries.length<20&&(e.list=e.entry=e.target=e.callback=null,GA._hashUpdateEntries.push(e))},GA._hashUpdateEntries=[];var UA=function e(t,i,n,r,a,o){Z(this,e),this.timers=void 0,this.target=void 0,this.timerIndex=void 0,this.currentTimer=void 0,this.currentTimerSalvaged=void 0,this.paused=void 0,this.timers=t,this.target=i,this.timerIndex=n,this.currentTimer=r,this.currentTimerSalvaged=a,this.paused=o};UA.get=function(e,t,i,n,r,a){var o=UA._hashTimerEntries.pop();return o?(o.timers=e,o.target=t,o.timerIndex=i,o.currentTimer=n,o.currentTimerSalvaged=r,o.paused=a):o=new UA(e,t,i,n,r,a),o},UA.put=function(e){UA._hashTimerEntries.length<20&&(e.timers=e.target=e.currentTimer=null,UA._hashTimerEntries.push(e))},UA._hashTimerEntries=[];var XA=function(){function e(){Z(this,e),this._lock=void 0,this._scheduler=void 0,this._elapsed=void 0,this._runForever=void 0,this._useDelay=void 0,this._timesExecuted=void 0,this._repeat=void 0,this._delay=void 0,this._interval=void 0,this._target=void 0,this._callback=void 0,this._lock=!1,this._scheduler=null,this._elapsed=-1,this._runForever=!1,this._useDelay=!1,this._timesExecuted=0,this._repeat=0,this._delay=0,this._interval=0,this._target=null,this._callback=null}return J(e,[{key:"initWithCallback",value:function(e,t,i,n,r,a){return this._lock=!1,this._scheduler=e,this._target=i,this._callback=t,this._elapsed=-1,this._interval=n,this._delay=a,this._useDelay=this._delay>0,this._repeat=r,this._runForever=this._repeat===cc.macro.REPEAT_FOREVER,!0}},{key:"getInterval",value:function(){return this._interval}},{key:"setInterval",value:function(e){this._interval=e}},{key:"update",value:function(e){-1===this._elapsed?(this._elapsed=0,this._timesExecuted=0):(this._elapsed+=e,this._runForever&&!this._useDelay?this._elapsed>=this._interval&&(this.trigger(),this._elapsed=0):(this._useDelay?this._elapsed>=this._delay&&(this.trigger(),this._elapsed-=this._delay,this._timesExecuted+=1,this._useDelay=!1):this._elapsed>=this._interval&&(this.trigger(),this._elapsed=0,this._timesExecuted+=1),this._callback&&!this._runForever&&this._timesExecuted>this._repeat&&this.cancel()))}},{key:"getCallback",value:function(){return this._callback}},{key:"trigger",value:function(){this._target&&this._callback&&(this._lock=!0,this._callback.call(this._target,this._elapsed),this._lock=!1)}},{key:"cancel",value:function(){this._scheduler.unschedule(this._callback,this._target)}}]),e}();XA._timers=[],XA.get=function(){return XA._timers.pop()||new XA},XA.put=function(e){XA._timers.length<20&&!e._lock&&(e._scheduler=e._target=e._callback=null,XA._timers.push(e))};var VA=function(e){function t(){var e;return Z(this,t),(e=re(this,te(t).call(this)))._timeScale=void 0,e._updatesNegList=void 0,e._updates0List=void 0,e._updatesPosList=void 0,e._hashForUpdates=void 0,e._hashForTimers=void 0,e._currentTarget=void 0,e._currentTargetSalvaged=void 0,e._updateHashLocked=void 0,e._arrayForTimers=void 0,e._timeScale=1,e._updatesNegList=[],e._updates0List=[],e._updatesPosList=[],e._hashForUpdates=Re(!0),e._hashForTimers=Re(!0),e._currentTarget=null,e._currentTargetSalvaged=!1,e._updateHashLocked=!1,e._arrayForTimers=[],e}return ee(t,NA),J(t,null,[{key:"enableForTarget",value:function(e){var t=!1;(e.uuid||e.id)&&(t=!0),t||(e.__instanceId?cc.warnID(1513):e.id=zA.getNewId())}}]),J(t,[{key:"setTimeScale",value:function(e){this._timeScale=e}},{key:"getTimeScale",value:function(){return this._timeScale}},{key:"update",value:function(e){var t,i,n,r,a;for(this._updateHashLocked=!0,1!==this._timeScale&&(e*=this._timeScale),t=0,n=(i=this._updatesNegList).length;t<n;t++)(r=i[t]).paused||r.markedForDeletion||r.target.update(e);for(t=0,n=(i=this._updates0List).length;t<n;t++)(r=i[t]).paused||r.markedForDeletion||r.target.update(e);for(t=0,n=(i=this._updatesPosList).length;t<n;t++)(r=i[t]).paused||r.markedForDeletion||r.target.update(e);var o=this._arrayForTimers;for(t=0;t<o.length;t++){if(a=o[t],this._currentTarget=a,this._currentTargetSalvaged=!1,!a.paused)for(a.timerIndex=0;a.timerIndex<a.timers.length;++a.timerIndex)a.currentTimer=a.timers[a.timerIndex],a.currentTimerSalvaged=!1,a.currentTimer.update(e),a.currentTimer=null;this._currentTargetSalvaged&&0===this._currentTarget.timers.length&&(this._removeHashElement(this._currentTarget),--t)}for(t=0,i=this._updatesNegList;t<i.length;)(r=i[t]).markedForDeletion?this._removeUpdateFromHash(r):t++;for(t=0,i=this._updates0List;t<i.length;)(r=i[t]).markedForDeletion?this._removeUpdateFromHash(r):t++;for(t=0,i=this._updatesPosList;t<i.length;)(r=i[t]).markedForDeletion?this._removeUpdateFromHash(r):t++;this._updateHashLocked=!1,this._currentTarget=null}},{key:"schedule",value:function(e,t,i,n,r,a){if("function"!=typeof e){var o=e;e=t,t=o}3!==arguments.length&&4!==arguments.length&&5!==arguments.length||(a=!!n,n=cc.macro.REPEAT_FOREVER,r=0),cc.assertID(t,1502);var s=t.uuid||t.id;if(s){var l,u,c=this._hashForTimers[s];if(c?c.paused!==a&&cc.warnID(1511):(c=UA.get(null,t,0,null,null,a),this._arrayForTimers.push(c),this._hashForTimers[s]=c),null==c.timers)c.timers=[];else for(u=0;u<c.timers.length;++u)if((l=c.timers[u])&&e===l._callback)return cc.logID(1507,l.getInterval(),i),void(l._interval=i);(l=XA.get()).initWithCallback(this,e,t,i,n,r),c.timers.push(l),this._currentTarget===c&&this._currentTargetSalvaged&&(this._currentTargetSalvaged=!1)}else cc.errorID(1510)}},{key:"scheduleUpdate",value:function(e,t,i){var n=e.uuid||e.id;if(n){var r=this._hashForUpdates[n];if(r&&r.entry){if(r.entry.priority===t)return r.entry.markedForDeletion=!1,void(r.entry.paused=i);if(this._updateHashLocked)return cc.logID(1506),r.entry.markedForDeletion=!1,void(r.entry.paused=i);this.unscheduleUpdate(e)}var a,o=BA.get(e,t,i,!1);0===t?(a=this._updates0List,this._appendIn(a,o)):(a=t<0?this._updatesNegList:this._updatesPosList,this._priorityIn(a,o,t)),this._hashForUpdates[n]=GA.get(a,o,e,null)}else cc.errorID(1510)}},{key:"unschedule",value:function(e,t){if(t&&e){var i=t.uuid||t.id;if(i){var n=this._hashForTimers[i];if(n)for(var r=n.timers,a=0,o=r.length;a<o;a++){var s=r[a];if(e===s._callback)return s!==n.currentTimer||n.currentTimerSalvaged||(n.currentTimerSalvaged=!0),r.splice(a,1),XA.put(s),n.timerIndex>=a&&n.timerIndex--,void(0===r.length&&(this._currentTarget===n?this._currentTargetSalvaged=!0:this._removeHashElement(n)))}}else cc.errorID(1510)}}},{key:"unscheduleUpdate",value:function(e){if(e){var t=e.uuid||e.id;if(t){var i=this._hashForUpdates[t];i&&(this._updateHashLocked?i.entry.markedForDeletion=!0:this._removeUpdateFromHash(i.entry))}else cc.errorID(1510)}}},{key:"unscheduleAllForTarget",value:function(e){if(e){var t=e.uuid||e.id;if(t){var i=this._hashForTimers[t];if(i){var n=i.timers;n.indexOf(i.currentTimer)>-1&&!i.currentTimerSalvaged&&(i.currentTimerSalvaged=!0);for(var r=0,a=n.length;r<a;r++)XA.put(n[r]);n.length=0,this._currentTarget===i?this._currentTargetSalvaged=!0:this._removeHashElement(i)}this.unscheduleUpdate(e)}else cc.errorID(1510)}}},{key:"unscheduleAll",value:function(){this.unscheduleAllWithMinPriority(cc.Scheduler.PRIORITY_SYSTEM)}},{key:"unscheduleAllWithMinPriority",value:function(e){var t,i,n,r=this._arrayForTimers;for(t=r.length-1;t>=0;t--)i=r[t],this.unscheduleAllForTarget(i.target);var a=0;if(e<0)for(t=0;t<this._updatesNegList.length;)a=this._updatesNegList.length,(n=this._updatesNegList[t])&&n.priority>=e&&this.unscheduleUpdate(n.target),a===this._updatesNegList.length&&t++;if(e<=0)for(t=0;t<this._updates0List.length;)a=this._updates0List.length,(n=this._updates0List[t])&&this.unscheduleUpdate(n.target),a===this._updates0List.length&&t++;for(t=0;t<this._updatesPosList.length;)a=this._updatesPosList.length,(n=this._updatesPosList[t])&&n.priority>=e&&this.unscheduleUpdate(n.target),a===this._updatesPosList.length&&t++}},{key:"isScheduled",value:function(e,t){cc.assertID(e,1508),cc.assertID(t,1509);var i=t.uuid||t.id;if(i){var n=this._hashForTimers[i];if(!n)return!1;if(null==n.timers)return!1;for(var r=n.timers,a=0;a<r.length;++a){if(e===r[a]._callback)return!0}return!1}cc.errorID(1510)}},{key:"pauseAllTargets",value:function(){return this.pauseAllTargetsWithMinPriority(cc.Scheduler.PRIORITY_SYSTEM)}},{key:"pauseAllTargetsWithMinPriority",value:function(e){var t,i,n,r,a=[],o=this._arrayForTimers;for(i=0,n=o.length;i<n;i++)(t=o[i])&&(t.paused=!0,a.push(t.target));if(e<0)for(i=0;i<this._updatesNegList.length;i++)(r=this._updatesNegList[i])&&r.priority>=e&&(r.paused=!0,a.push(r.target));if(e<=0)for(i=0;i<this._updates0List.length;i++)(r=this._updates0List[i])&&(r.paused=!0,a.push(r.target));for(i=0;i<this._updatesPosList.length;i++)(r=this._updatesPosList[i])&&r.priority>=e&&(r.paused=!0,a.push(r.target));return a}},{key:"resumeTargets",value:function(e){if(e)for(var t=0;t<e.length;t++)this.resumeTarget(e[t])}},{key:"pauseTarget",value:function(e){cc.assertID(e,1503);var t=e.uuid||e.id;if(t){var i=this._hashForTimers[t];i&&(i.paused=!0);var n=this._hashForUpdates[t];n&&(n.entry.paused=!0)}else cc.errorID(1510)}},{key:"resumeTarget",value:function(e){cc.assertID(e,1504);var t=e.uuid||e.id;if(t){var i=this._hashForTimers[t];i&&(i.paused=!1);var n=this._hashForUpdates[t];n&&(n.entry.paused=!1)}else cc.errorID(1510)}},{key:"isTargetPaused",value:function(e){cc.assertID(e,1505);var t=e.uuid||e.id;if(!t)return cc.errorID(1510),!1;var i=this._hashForTimers[t];if(i)return i.paused;var n=this._hashForUpdates[t];return!!n&&n.entry.paused}},{key:"_removeHashElement",value:function(e){var t=e.target.uuid||e.target.id;delete this._hashForTimers[t];for(var i=this._arrayForTimers,n=0,r=i.length;n<r;n++)if(i[n]===e){i.splice(n,1);break}UA.put(e)}},{key:"_removeUpdateFromHash",value:function(e){var t=e.target.uuid||e.target.id,i=this._hashForUpdates[t];if(i){for(var n=i.list,r=i.entry,a=0,o=n.length;a<o;a++)if(n[a]===r){n.splice(a,1);break}delete this._hashForUpdates[t],BA.put(r),GA.put(i)}}},{key:"_priorityIn",value:function(e,t,i){for(var n=0;n<e.length;n++)if(i<e[n].priority)return void e.splice(n,0,t);e.push(t)}},{key:"_appendIn",value:function(e,t){e.push(t)}}]),t}();VA.PRIORITY_SYSTEM=1<<31,VA.PRIORITY_NON_SYSTEM=VA.PRIORITY_SYSTEM+1,VA.ID="scheduler",cc.Scheduler=VA;var HA,WA=function(){function e(t){Z(this,e),this.jointTexturePool=void 0,this.jointAnimationInfo=void 0,this.jointTexturePool=new jE(t),this.jointAnimationInfo=new qE(t)}return J(e,[{key:"releaseSkeleton",value:function(e){this.jointTexturePool.releaseSkeleton(e)}},{key:"releaseAnimationClip",value:function(e){this.jointTexturePool.releaseAnimationClip(e)}},{key:"clear",value:function(){this.jointTexturePool.clear(),this.jointAnimationInfo.clear()}}]),e}(),jA=function(){function e(t){Z(this,e),this.batcher=void 0,this.vData=null,this.iData=null,this.vb=null,this.ib=null,this.ia=null,this.byteStart=0,this.byteOffset=0,this.indiceStart=0,this.indiceOffset=0,this.vertexStart=0,this.vertexOffset=0,this.lastByteOffset=1,this.dirty=!1,this._vertexFormatBytes=9*Float32Array.BYTES_PER_ELEMENT,this._initVDataCount=256*this._vertexFormatBytes,this._initIDataCount=1536,this._outofCallback=null,this.batcher=t}return J(e,[{key:"initialize",value:function(e,t){this._outofCallback=t;var i=9*Float32Array.BYTES_PER_ELEMENT;this.vb=this.vb||this.batcher.device.createBuffer({usage:exports.GFXBufferUsageBit.VERTEX|exports.GFXBufferUsageBit.TRANSFER_DST,memUsage:exports.GFXMemoryUsageBit.HOST|exports.GFXMemoryUsageBit.DEVICE,size:0,stride:i});var n=Uint16Array.BYTES_PER_ELEMENT;this.ib=this.ib||this.batcher.device.createBuffer({usage:exports.GFXBufferUsageBit.INDEX|exports.GFXBufferUsageBit.TRANSFER_DST,memUsage:exports.GFXMemoryUsageBit.HOST|exports.GFXMemoryUsageBit.DEVICE,size:0,stride:n}),this.ia=this.ia||this.batcher.device.createInputAssembler({attributes:e,vertexBuffers:[this.vb],indexBuffer:this.ib}),this._reallocBuffer()}},{key:"request",value:function(){var e=arguments.length>0&&void 0!==arguments[0]?arguments[0]:4,t=arguments.length>1&&void 0!==arguments[1]?arguments[1]:6;this.lastByteOffset=this.byteOffset;var i=this.byteOffset+e*this._vertexFormatBytes,n=this.indiceOffset+t;if(e+this.vertexOffset>65535)return this.batcher.autoMergeBatches(),this._outofCallback&&this._outofCallback.call(this.batcher,e,t),!1;var r=this.vData.byteLength,a=this.iData.length;if(i>r||n>a){for(;r<i||a<n;)this._initVDataCount*=2,this._initIDataCount*=2,r=4*this._initVDataCount,a=this._initIDataCount;this._reallocBuffer()}return this.vertexOffset+=e,this.indiceOffset+=t,this.byteOffset=i,this.dirty=!0,!0}},{key:"reset",value:function(){this.byteStart=0,this.byteOffset=0,this.indiceStart=0,this.indiceOffset=0,this.vertexStart=0,this.vertexOffset=0,this.lastByteOffset=0,this.dirty=!1}},{key:"destroy",value:function(){this.ib.destroy(),this.vb.destroy(),this.ia.destroy(),this.ib=null,this.vb=null,this.ia=null}},{key:"uploadData",value:function(){if(0!==this.byteOffset&&this.dirty){var e=new Float32Array(this.vData.buffer,0,this.byteOffset>>2),t=new Uint16Array(this.iData.buffer,0,this.indiceOffset);this.byteOffset>this.vb.size&&this.vb.resize(this.byteOffset),this.vb.update(e),2*this.indiceOffset>this.ib.size&&this.ib.resize(2*this.indiceOffset),this.ib.update(t)}}},{key:"_reallocBuffer",value:function(){this._reallocVData(!0),this._reallocIData(!0)}},{key:"_reallocVData",value:function(e){var t;if(this.vData&&(t=new Uint8Array(this.vData.buffer)),this.vData=new Float32Array(this._initVDataCount),t&&e)for(var i=new Uint8Array(this.vData.buffer),n=0,r=t.length;n<r;n++)i[n]=t[n]}},{key:"_reallocIData",value:function(e){var t=this.iData;if(this.iData=new Uint16Array(this._initIDataCount),t&&e)for(var i=this.iData,n=0,r=t.length;n<r;n++)i[n]=t[n]}}]),e}();jA.OPACITY_OFFSET=8,function(e){e[e.DISABLED=0]="DISABLED",e[e.CLEAR=1]="CLEAR",e[e.ENTER_LEVEL=2]="ENTER_LEVEL",e[e.ENABLED=3]="ENABLED",e[e.EXIT_LEVEL=4]="EXIT_LEVEL"}(HA||(HA={}));var qA=function(){function e(){Z(this,e),this.stage=HA.DISABLED,this._maskStack=[],this._stencilPattern={stencilTest:!0,func:exports.GFXComparisonFunc.ALWAYS,stencilMask:65535,writeMask:65535,failOp:exports.GFXStencilOp.KEEP,zFailOp:exports.GFXStencilOp.KEEP,passOp:exports.GFXStencilOp.KEEP,ref:1},this._defaultPipelineState={depthStencilState:{},rasterizerState:{},blendState:{}}}return J(e,[{key:"pushMask",value:function(e){this._maskStack.push(e)}},{key:"clear",value:function(){this.stage=HA.CLEAR}},{key:"enterLevel",value:function(){this.stage=HA.ENTER_LEVEL}},{key:"enableMask",value:function(){this.stage=HA.ENABLED}},{key:"exitMask",value:function(){0!==this._maskStack.length&&(this._maskStack.pop(),0===this._maskStack.length?this.stage=HA.DISABLED:this.stage=HA.ENABLED)}},{key:"handleMaterial",value:function(e){var t=this._stencilPattern;if(this.stage===HA.DISABLED)t.stencilTest=!1,t.func=exports.GFXComparisonFunc.ALWAYS,t.failOp=exports.GFXStencilOp.KEEP,t.stencilMask=t.writeMask=65535,t.ref=1;else if(t.stencilTest=!0,this.stage===HA.ENABLED)t.func=exports.GFXComparisonFunc.EQUAL,t.failOp=exports.GFXStencilOp.KEEP,t.stencilMask=t.ref=this.getStencilRef(),t.writeMask=this.getWriteMask();else if(this.stage===HA.CLEAR){var i=this._maskStack[this._maskStack.length-1];t.func=exports.GFXComparisonFunc.NEVER,t.failOp=i.inverted?exports.GFXStencilOp.REPLACE:exports.GFXStencilOp.ZERO,t.writeMask=t.stencilMask=t.ref=this.getWriteMask()}else if(this.stage===HA.ENTER_LEVEL){var n=this._maskStack[this._maskStack.length-1];t.func=exports.GFXComparisonFunc.NEVER,t.failOp=n.inverted?exports.GFXStencilOp.ZERO:exports.GFXStencilOp.REPLACE,t.writeMask=t.stencilMask=t.ref=this.getWriteMask()}var r=e.passes[0];if(this._changed(r)){var a=this._stencilPattern;return this._defaultPipelineState.depthStencilState={stencilTestFront:a.stencilTest,stencilFuncFront:a.func,stencilReadMaskFront:a.stencilMask,stencilWriteMaskFront:a.writeMask,stencilFailOpFront:a.failOp,stencilZFailOpFront:a.zFailOp,stencilPassOpFront:a.passOp,stencilRefFront:a.ref,stencilTestBack:a.stencilTest,stencilFuncBack:a.func,stencilReadMaskBack:a.stencilMask,stencilWriteMaskBack:a.writeMask,stencilFailOpBack:a.failOp,stencilZFailOpBack:a.zFailOp,stencilPassOpBack:a.passOp,stencilRefBack:a.ref},this._defaultPipelineState.blendState=r.blendState,this._defaultPipelineState.rasterizerState=r.rasterizerState,e.overridePipelineStates(this._defaultPipelineState),!0}return!1}},{key:"getWriteMask",value:function(){return 1<<this._maskStack.length-1}},{key:"getExitWriteMask",value:function(){return 1<<this._maskStack.length}},{key:"getStencilRef",value:function(){for(var e=0,t=0;t<this._maskStack.length;++t)e+=1<<t;return e}},{key:"reset",value:function(){this._maskStack.length=0,this.stage=HA.DISABLED}},{key:"_changed",value:function(e){var t=e.depthStencilState,i=this._stencilPattern;return i.stencilTest!==t.stencilTestFront||i.func!==t.stencilFuncFront||i.failOp!==t.stencilFailOpFront||i.zFailOp!==t.stencilZFailOpFront||i.passOp!==t.stencilPassOpFront||i.stencilMask!==t.stencilReadMaskFront||i.writeMask!==t.stencilWriteMaskFront||i.ref!==t.stencilRefFront}}]),e}();qA.sharedManager=null,qA.sharedManager=new qA;var YA=function(e){function t(){var e;return Z(this,t),(e=re(this,te(t).call(this)))._subModel=void 0,e.type=eh.UI_BATCH,e._subModel=new KA,e}return ee(t,ah),J(t,[{key:"updateTransform",value:function(){}},{key:"updateUBOs",value:function(){return!1}},{key:"directInitialize",value:function(e,t){this._subModel.directInitialize(e,t.material,t.pipelineState),this._subModels[0]=this._subModel}},{key:"destroy",value:function(){this._subModel.destroy()}}]),t}(),KA=function(e){function t(){var e;return Z(this,t),(e=re(this,te(t).call(this)))._psos=[],e}return ee(t,Lc),J(t,[{key:"directInitialize",value:function(e,t,i){this._inputAssembler=e,this._psos[0]=i,this.material=t}},{key:"destroy",value:function(){this.commandBuffers.length>0&&this.commandBuffers[0].destroy()}}]),t}(),ZA=function(){function e(){Z(this,e),this.camera=null,this.bufferBatch=null,this.model=null,this.material=null,this.texView=null,this.sampler=null,this.firstIdx=0,this.idxCount=0,this.pipelineState=null,this.bindingLayout=null,this.useLocalData=null,this.isStatic=!1}return J(e,[{key:"destroy",value:function(e){this.pipelineState&&(e._getUIMaterial(this.material).revertPipelineState(this.pipelineState),this.pipelineState=null),this.bindingLayout&&(this.bindingLayout=null)}},{key:"clear",value:function(e){this.pipelineState&&(e._getUIMaterial(this.material).revertPipelineState(this.pipelineState),this.pipelineState=null),this.camera=null,this.bufferBatch=null,this.material=null,this.texView=null,this.sampler=null,this.firstIdx=0,this.idxCount=0,this.model=null,this.isStatic=!1}}]),e}(),QA=function(){function e(){Z(this,e),this._material=null,this._pass=null,this._psos=void 0,this._refCount=0,this._psos=null}return J(e,[{key:"material",get:function(){return this._material}},{key:"pass",get:function(){return this._pass}}]),J(e,[{key:"initialize",value:function(e){var t=this;return!!e.material&&(this._material=new Bh,this._material.copy(e.material),this._pass=e.material.passes[0],this._pass.update(),this._psos=new To((function(){return t._pass.createPipelineState()}),1),!0)}},{key:"increase",value:function(){return this._refCount++,this._refCount}},{key:"decrease",value:function(){return this._refCount--,0===this._refCount&&this.destroy(),this._refCount}},{key:"getPipelineState",value:function(){return this._psos.alloc()}},{key:"revertPipelineState",value:function(e){this._psos.free(e)}},{key:"destroy",value:function(){var e=this;this._psos&&this._psos.clear((function(t){e._pass.destroyPipelineState(t)})),this._material&&(this._material.destroy(),this._material=null),this._refCount=0}}]),e}(),JA=[{name:exports.GFXAttributeName.ATTR_POSITION,format:exports.GFXFormat.RGB32F},{name:exports.GFXAttributeName.ATTR_TEX_COORD,format:exports.GFXFormat.RG32F},{name:exports.GFXAttributeName.ATTR_COLOR,format:exports.GFXFormat.RGBA32F}],$A=Object.freeze({__proto__:null,vfmt:JA}),eO=function(){function e(t){var i=this;Z(this,e),this.device=void 0,this._screens=[],this._bufferBatchPool=new So((function(){return new jA(i)}),128),this._drawBatchPool=new To((function(){return new ZA}),128),this._cmdBuff=null,this._scene=void 0,this._attributes=[],this._meshBuffers=[],this._meshBufferUseCount=0,this._uiMaterials=new Map,this._canvasMaterials=new Map,this._batches=void 0,this._uiModelPool=null,this._modelInUse=void 0,this._emptyMaterial=new Bh,this._currMaterial=this._emptyMaterial,this._currTexView=null,this._currSampler=null,this._currCanvas=null,this._currMeshBuffer=null,this._currStaticRoot=null,this._parentOpacity=1,this._root=t,this.device=t.device,this._scene=this._root.createScene({name:"GUIScene"}),this._uiModelPool=new To((function(){var e=cc.director.root.createModel(YA);return e.enabled=!0,e.visFlags|=bu.Enum.UI_3D,e}),2),this._modelInUse=new Eo(10),this._batches=new Eo(64),cc.director.on(cc.Director.EVENT_BEFORE_DRAW,this.update,this)}return J(e,[{key:"renderScene",get:function(){return this._scene}},{key:"currBufferBatch",get:function(){return this._currMeshBuffer},set:function(e){e&&(this._currMeshBuffer=e)}},{key:"currStaticRoot",set:function(e){this._currStaticRoot=e}}]),J(e,[{key:"initialize",value:function(){return this._attributes=JA,this._requireBufferBatch(),this._cmdBuff=this.device.createCommandBuffer({allocator:this.device.commandAllocator,type:exports.GFXCommandBufferType.PRIMARY}),!0}},{key:"destroy",value:function(){for(var e=0;e<this._batches.array.length;e++)this._batches.array[e].destroy(this);for(var t=0;t<this._meshBuffers.length;t++)this._meshBuffers[t].destroy();this._meshBuffers.splice(0),this._destroyUIMaterials(),this._cmdBuff&&(this._cmdBuff.destroy(),this._cmdBuff=null)}},{key:"getRenderSceneGetter",value:function(){return Object.getOwnPropertyDescriptor(Object.getPrototypeOf(this),"renderScene").get.bind(this)}},{key:"_getUIMaterial",value:function(e){if(this._uiMaterials.has(e.hash))return this._uiMaterials.get(e.hash);var t=new QA;return t.initialize({material:e}),this._uiMaterials.set(e.hash,t),t}},{key:"_removeUIMaterial",value:function(e){this._uiMaterials.has(e)&&0===this._uiMaterials.get(e).decrease()&&this._uiMaterials.delete(e)}},{key:"addScreen",value:function(e){for(var t=this._screens,i=0;i<t.length;i++){var n=t[i];if(n.camera){var r=n.camera.view.visibility,a=this._canvasMaterials.get(r);if(a){for(var o=a.keys(),s=o.next();!s.done;)this._removeUIMaterial(s.value),s=o.next();a.clear()}}}this._screens.push(e),this._screens.sort(this._screenSort);for(var l=0;l<t.length;l++){var u=t[l];u.camera&&(u.camera.view.visibility=bu.BitMask.UI_2D|l+1,this._canvasMaterials.has(u.camera.view.visibility)||this._canvasMaterials.set(u.camera.view.visibility,new Map))}}},{key:"getScreen",value:function(e){for(var t=this._screens,i=0;i<t.length;++i){var n=t[i];if(n.camera&&n.camera.view.visibility===e)return n}return null}},{key:"removeScreen",value:function(e){var t=this,i=this._screens.indexOf(e);if(-1!==i){if(this._screens.splice(i,1),e.camera){for(var n=this._canvasMaterials.get(e.camera.view.visibility),r=n.keys(),a=r.next();!a.done;)this._removeUIMaterial(a.value),a=r.next();n.clear()}for(var o,s=i;s<this._screens.length;s++)(o=this._screens[s].camera)&&function(){var e=t._canvasMaterials.get(o.view.visibility);o.view.visibility=bu.BitMask.UI_2D|s+1;var i=t._canvasMaterials.get(o.view.visibility);e.forEach((function(e,t){i.set(t,e)})),e.clear()}()}}},{key:"update",value:function(e){if(this._renderScreens(),this._batches.length>0)for(var t=this._meshBuffers,i=0;i<t.length;++i){var n=t[i];n.uploadData(),n.reset()}this.render(),this._reset()}},{key:"sortScreens",value:function(){this._screens.sort(this._screenSort)}},{key:"render",value:function(){for(var e=0,t=0;t<this._modelInUse.length;t++)this._scene.removeModel(this._modelInUse.get(t)),this._uiModelPool.free(this._modelInUse.get(t));if(this._modelInUse.clear(),this._batches.length)for(var i=0;i<this._batches.length;++i){var n=this._batches.array[i];if(n.model){if(n.camera){var r=n.camera.view.visibility;n.model.visFlags=r,n.model.node.layer=r}for(var a=0;a<n.model.subModelNum;a++)n.model.getSubModel(a).priority=e++}else{var o=n.bindingLayout;o.bindTextureView(Eu.CUSTOM_SAMPLER_BINDING_START_POINT,n.texView),o.bindSampler(Eu.CUSTOM_SAMPLER_BINDING_START_POINT,n.sampler),o.update();var s=n.bufferBatch.ia;s.firstIndex=n.firstIdx,s.indexCount=n.idxCount;var l=this._uiModelPool.alloc();l.directInitialize(s,n),this._scene.addModel(l),l.getSubModel(0).priority=e++,n.camera&&(l.visFlags=n.camera.view.visibility,null==this._canvasMaterials.get(n.camera.view.visibility).get(n.material.hash)&&(this._uiMaterials.get(n.material.hash).increase(),this._canvasMaterials.get(n.camera.view.visibility).set(n.material.hash,1))),this._modelInUse.push(l)}}}},{key:"commitComp",value:function(e){var t=arguments.length>1&&void 0!==arguments[1]?arguments[1]:null,i=arguments.length>2?arguments[2]:void 0,n=arguments.length>3&&void 0!==arguments[3]?arguments[3]:null,r=e,a=t,o=n;this._currMaterial.hash===r.material.hash&&this._currTexView===a&&this._currSampler===o||(this.autoMergeBatches(),this._currMaterial=r.material,this._currTexView=a,this._currSampler=o),i&&(i.fillBuffers(r,this),this._applyOpacity(r))}},{key:"commitModel",value:function(e,t,i){if((this._currMaterial!==this._emptyMaterial&&this.autoMergeBatches(),i)&&(qA.sharedManager.handleMaterial(i)&&t))for(var n=0;n<t.subModelNum;n++)t.setSubModelMaterial(n,i);var r=this._currCanvas,a=this._drawBatchPool.alloc();a.camera=r&&r.camera,a.model=t,a.bufferBatch=null,a.material=i,a.texView=null,a.sampler=null,a.firstIdx=0,a.idxCount=0,a.pipelineState=null,a.bindingLayout=null,this._currMaterial=this._emptyMaterial,this._currTexView=null,this._currSampler=null,this._batches.push(a)}},{key:"commitStaticBatch",value:function(e){this._batches.concat(e.drawBatchList),this.finishMergeBatches()}},{key:"autoMergeBatches",value:function(){var e=this._currMaterial,t=this._currMeshBuffer,i=t.indiceStart,n=t.indiceOffset-i;if(n&&e){var r=this._currCanvas;qA.sharedManager.handleMaterial(e);var a=this._currStaticRoot?this._currStaticRoot._requireDrawBatch():this._drawBatchPool.alloc();a.camera=r&&r.camera,a.bufferBatch=t,a.material=e,a.texView=this._currTexView,a.sampler=this._currSampler,a.firstIdx=i,a.idxCount=n,a.pipelineState=this._getUIMaterial(e).getPipelineState(),a.bindingLayout=a.pipelineState.pipelineLayout.layouts[0],this._batches.push(a),t.vertexStart=t.vertexOffset,t.indiceStart=t.indiceOffset,t.byteStart=t.byteOffset}}},{key:"forceMergeBatches",value:function(e,t){this._currMaterial=e,this._currTexView=t,this.autoMergeBatches()}},{key:"finishMergeBatches",value:function(){this.autoMergeBatches(),this._currMaterial=this._emptyMaterial,this._currTexView=null}},{key:"_destroyUIMaterials",value:function(){for(var e=this._uiMaterials.values(),t=e.next();!t.done;){t.value.destroy(),t=e.next()}this._uiMaterials.clear()}},{key:"_walk",value:function(e){var t=arguments.length>1&&void 0!==arguments[1]?arguments[1]:0,i=e.children.length,n=this._parentOpacity;if(this._parentOpacity*=e._uiProps.opacity,this._preprocess(e),i>0&&!e._static)for(var r=e.children,a=0;a<r.length;++a){var o=r[a];this._walk(o,t)}this._postprocess(e),this._parentOpacity=n,t+=1}},{key:"_renderScreens",value:function(){for(var e=this._screens,t=0;t<e.length;++t){var i=e[t];i.enabledInHierarchy&&(this._currCanvas=i,this._recursiveScreenNode(i.node))}}},{key:"_preprocess",value:function(e){if(e._uiProps.uiTransformComp){e._uiProps.uiTransformComp._canvas=this._currCanvas;var t=e._uiProps.uiComp;t&&t.enabledInHierarchy&&t.updateAssembler(this)}}},{key:"_postprocess",value:function(e){var t=e._uiProps.uiComp;t&&t.enabledInHierarchy&&t.postUpdateAssembler(this)}},{key:"_recursiveScreenNode",value:function(e){this._walk(e),this.autoMergeBatches()}},{key:"_reset",value:function(){for(var e=0;e<this._batches.length;++e){var t=this._batches.array[e];t.isStatic||(t.clear(this),this._drawBatchPool.free(t))}this._parentOpacity=1,this._batches.clear(),this._currMaterial=this._emptyMaterial,this._currCanvas=null,this._currTexView=null,this._currSampler=null,this._meshBufferUseCount=0,this._requireBufferBatch(),qA.sharedManager.reset()}},{key:"_createMeshBuffer",value:function(){var e=this._bufferBatchPool.add();return e.initialize(this._attributes,this._requireBufferBatch.bind(this)),this._meshBuffers.push(e),e}},{key:"_requireBufferBatch",value:function(){this._meshBufferUseCount>=this._meshBuffers.length?this._currMeshBuffer=this._createMeshBuffer():this._currMeshBuffer=this._meshBuffers[this._meshBufferUseCount],this._meshBufferUseCount++,2===arguments.length&&this._currMeshBuffer.request(arguments[0],arguments[1])}},{key:"_screenSort",value:function(e,t){var i=e.priority-t.priority;return 0===i?e.node.getSiblingIndex()-t.node.getSiblingIndex():i}},{key:"_applyOpacity",value:function(e){for(var t=e.color.a/255,i=this._parentOpacity=this._parentOpacity*t,n=this._currMeshBuffer.byteOffset>>2,r=this._currMeshBuffer.vData,a=this._currMeshBuffer.lastByteOffset>>2;a<n;a+=9)r[a+jA.OPACITY_OFFSET]=i;this._currMeshBuffer.lastByteOffset=this._currMeshBuffer.byteOffset}}]),e}(),tO=function(){function e(t){Z(this,e),this._createSceneFun=void 0,this._createViewFun=void 0,this._device=void 0,this._windows=[],this._mainWindow=null,this._curWindow=null,this._tempWindow=null,this._pipeline=null,this._ui=null,this._dataPoolMgr=void 0,this._scenes=[],this._views=[],this._modelPools=new Map,this._cameraPool=null,this._lightPools=new Map,this._time=0,this._frameTime=0,this._fpsTime=0,this._frameCount=0,this._fps=0,this._fixedFPS=0,this._fixedFPSFrameTime=0,this._device=t,this._dataPoolMgr=new WA(t),Zw.registerCreateFunc(this),QT.registerCreateFunc(this),this._cameraPool=new To((function(){return new gv}),4)}return J(e,[{key:"device",get:function(){return this._device}},{key:"mainWindow",get:function(){return this._mainWindow}},{key:"curWindow",set:function(e){this._curWindow=e},get:function(){return this._curWindow}},{key:"tempWindow",set:function(e){this._tempWindow=e},get:function(){return this._tempWindow}},{key:"windows",get:function(){return this._windows}},{key:"pipeline",get:function(){return this._pipeline}},{key:"ui",get:function(){return this._ui}},{key:"scenes",get:function(){return this._scenes}},{key:"views",get:function(){return this._views}},{key:"cumulativeTime",get:function(){return this._time}},{key:"frameTime",get:function(){return this._frameTime}},{key:"frameCount",get:function(){return this._frameCount}},{key:"fps",get:function(){return this._fps}},{key:"fixedFPS",set:function(e){e>0?(this._fixedFPS=e,this._fixedFPSFrameTime=1e3/e):this._fixedFPSFrameTime=0},get:function(){return this._fixedFPS}},{key:"dataPoolManager",get:function(){return this._dataPoolMgr}}]),J(e,[{key:"initialize",value:function(e){var t=this;return!!this._device.mainWindow&&(this._mainWindow=this._device.mainWindow,this._curWindow=this._mainWindow,Pc.initBuiltinRes(this._device),cc.view.on("design-resolution-changed",(function(){var e=cc.game.canvas.width,i=cc.game.canvas.height;t.resize(e,i)}),this),!0)}},{key:"destroy",value:function(){this.destroyViews(),this.destroyScenes(),this._pipeline&&(this._pipeline.destroy(),this._pipeline=null),this._ui&&(this._ui.destroy(),this._ui=null),this._curWindow=null,this._mainWindow=null,this.dataPoolManager.clear()}},{key:"resize",value:function(e,t){this._device.resize(e,t),this._mainWindow.resize(e,t);for(var i,n=_e(this._windows);!(i=n()).done;){var r=i.value;r.isOffscreen||r.resize(e,t)}this._pipeline&&this._pipeline.resize(e,t);for(var a,o=_e(this._views);!(a=o()).done;){var s=a.value;s.camera.isWindowSize&&s.camera.resize(e,t)}}},{key:"setRenderPipeline",value:function(e){return this._pipeline=e,!!this._pipeline.activate(this)&&(this._ui=new eO(this),!!this._ui.initialize()||(this.destroy(),!1))}},{key:"activeWindow",value:function(e){this._curWindow=e}},{key:"resetCumulativeTime",value:function(){this._time=0}},{key:"frameMove",value:function(e){this._frameTime=e,++this._frameCount,this._time+=this._frameTime,this._fpsTime+=this._frameTime,this._fpsTime>1&&(this._fps=this._frameCount,this._frameCount=0,this._fpsTime=0);for(var t=this._views,i=0;i<t.length;i++){var n=t[i];n.isEnable&&n.window&&(n.window.isOffscreen||!n.window.isOffscreen&&n.window===this._curWindow)&&this._pipeline&&this._pipeline.render(n)}}},{key:"createWindow",value:function(e){if(this._device){var t=this._device.createWindow(e);if(t)return this._windows.push(t),t}return null}},{key:"destroyWindow",value:function(e){for(var t=0;t<this._windows.length;++t)if(this._windows[t]===e)return e.destroy(),void this._windows.splice(t,1)}},{key:"destroyWindows",value:function(){for(var e,t=_e(this._windows);!(e=t()).done;){e.value.destroy()}this._windows=[]}},{key:"createScene",value:function(e){var t=this._createSceneFun(this);return t.initialize(e),this._scenes.push(t),t}},{key:"destroyScene",value:function(e){for(var t=0;t<this._scenes.length;++t)if(this._scenes[t]===e)return e.destroy(),void this._scenes.splice(t,1)}},{key:"destroyScenes",value:function(){for(var e,t=_e(this._scenes);!(e=t()).done;){e.value.destroy()}this._scenes=[]}},{key:"createView",value:function(e){var t=this._createViewFun(this,e.camera);return t.initialize(e),this._views.push(t),this.sortViews(),t}},{key:"destroyView",value:function(e){for(var t=0;t<this._views.length;++t)if(this._views[t]===e)return this._views.splice(t,1),void e.destroy()}},{key:"destroyViews",value:function(){for(var e,t=_e(this._views);!(e=t()).done;){e.value.destroy()}this._views=[]}},{key:"createModel",value:function(e){var t=this._modelPools.get(e);return t||(this._modelPools.set(e,new To((function(){return new e}),10)),t=this._modelPools.get(e)),t.alloc()}},{key:"destroyModel",value:function(e){var t=this._modelPools.get(e.constructor);t?(t.free(e),e.destroy(),e.scene&&e.scene.removeModel(e)):console.warn("'".concat(e.constructor.name,"'is not in the model pool and cannot be destroyed by destroyModel."))}},{key:"createCamera",value:function(){return this._cameraPool.alloc()}},{key:"destroyCamera",value:function(e){this._cameraPool.free(e),e.destroy(),e.scene&&e.scene.removeCamera(e),e.isWindowSize=!0}},{key:"createLight",value:function(e){var t=this._lightPools.get(e);return t||(this._lightPools.set(e,new To((function(){return new e}),4)),t=this._lightPools.get(e)),t.alloc()}},{key:"destroyLight",value:function(e){var t=this._lightPools.get(e.constructor);if(e.destroy(),t&&(t.free(e),e.scene))switch(e.type){case ZT.SPHERE:e.scene.removeSphereLight(e);break;case ZT.SPOT:e.scene.removeSpotLight(e)}}},{key:"sortViews",value:function(){this._views.sort((function(e,t){return e.priority-t.priority}))}}]),e}(),iO=function(e){function t(){var e;return Z(this,t),(e=re(this,te(t).call(this)))._compScheduler=void 0,e._nodeActivator=void 0,e._invalid=void 0,e._paused=void 0,e._purgeDirectorInNextLoop=void 0,e._root=void 0,e._loadingScene=void 0,e._scene=void 0,e._totalFrames=void 0,e._lastUpdate=void 0,e._deltaTime=void 0,e._scheduler=void 0,e._systems=void 0,e._invalid=!1,e._paused=!1,e._purgeDirectorInNextLoop=!1,e._root=null,e._loadingScene="",e._scene=null,e._totalFrames=0,e._lastUpdate=0,e._deltaTime=0,e._scheduler=new VA,e._compScheduler=new vx,e._nodeActivator=new Db,e._systems=[],cc.game.once(ZS.EVENT_RENDERER_INITED,e._initOnRendererInitialized,ne(e)),e}return ee(t,gl),J(t,[{key:"calculateDeltaTime",value:function(){var e=performance.now();this._deltaTime=(e-this._lastUpdate)/1e3,this._lastUpdate=e}},{key:"convertToGL",value:function(e){var t=cc.game.container,i=cc.view,n=t.getBoundingClientRect(),r=n.left+window.pageXOffset-t.clientLeft,a=n.top+window.pageYOffset-t.clientTop,o=i._devicePixelRatio*(e.x-r),s=i._devicePixelRatio*(a+n.height-e.y);return i._isRotated?Mi(i._viewportRect.width-s,o):Mi(o,s)}},{key:"convertToUI",value:function(e){var t=cc.game.container,i=cc.view,n=t.getBoundingClientRect(),r=n.left+window.pageXOffset-t.clientLeft,a=n.top+window.pageYOffset-t.clientTop,o=Mi(0,0);return i._isRotated?(o.x=r+e.y/i._devicePixelRatio,o.y=a+n.height-(i._viewportRect.width-e.x)/i._devicePixelRatio):(o.x=r+e.x*i._devicePixelRatio,o.y=a+n.height-e.y*i._devicePixelRatio),o}},{key:"end",value:function(){this._purgeDirectorInNextLoop=!0}},{key:"getWinSize",value:function(){return tn(cc.winSize)}},{key:"getWinSizeInPixels",value:function(){return tn(cc.winSize)}},{key:"pause",value:function(){this._paused||(this._paused=!0)}},{key:"purgeCachedData",value:function(){cc.loader.releaseAll()}},{key:"purgeDirector",value:function(){this._scheduler.unscheduleAll(),this._compScheduler.unscheduleAll(),this._nodeActivator.reset(),Pv&&Pv.setEnabled(!1),cc.isValid(this._scene)&&this._scene.destroy(),this._scene=null,this.stopAnimation(),cc.loader.releaseAll()}},{key:"reset",value:function(){this.purgeDirector(),this.emit(t.EVENT_RESET),Pv&&Pv.setEnabled(!0),this.startAnimation()}},{key:"runSceneImmediate",value:function(e,t,i){cc.assertID(e instanceof cc.Scene,1216);var n=cc.loader._getReferenceKey(e.uuid);cc.loader.removeItem(n),e._load();for(var r=Object.keys(cc.game._persistRootNodes).map((function(e){return cc.game._persistRootNodes[e]})),a=0;a<r.length;a++){var o=r[a];o.emit(cc.Node.SCENE_CHANGED_FOR_PERSISTS,e.renderScene);var s=e.getChildByUuid(o.uuid);if(s){var l=s.getSiblingIndex();s._destroyImmediate(),e.insertChild(o,l)}else o.parent=e}var u=this._scene;!function(e,t,i){var n=cc.loader._autoReleaseSetting,r=Re();if(t)for(var a=0;a<t.length;a++)r[t[a]]=!0;for(var o=0;o<i.length;o++)Bf(i[o],r);if(e)for(var s=0;s<e.length;s++){var l=e[s];!1===n[l]||r[l]||cc.loader.release(l)}for(var u=Object.keys(n),c=0;c<u.length;c++){var h=u[c];!0!==n[h]||r[h]||cc.loader.release(h)}}(u&&u.autoReleaseAssets&&u.dependAssets,e.dependAssets,r),cc.isValid(u)&&u.destroy(),this._scene=null,sl._deferredDestroy(),t&&t(),this.emit(cc.Director.EVENT_BEFORE_SCENE_LAUNCH,e),this._scene=e,e._activate(),this._root&&this._root.resetCumulativeTime(),this.startAnimation(),i&&i(null,e),this.emit(cc.Director.EVENT_AFTER_SCENE_LAUNCH,e)}},{key:"runScene",value:function(e,t,i){var n=this;cc.assertID(e,1205),cc.assertID(e instanceof cc.Scene,1216),e._load(),this.once(cc.Director.EVENT_AFTER_UPDATE,(function(){n.runSceneImmediate(e,t,i)}))}},{key:"_getSceneUuid",value:function(e){var t=cc.game._sceneInfos;if("string"==typeof e){e.endsWith(".scene")||(e+=".scene"),"/"===e[0]||e.startsWith("db://")||(e="/"+e);for(var i=0;i<t.length;i++){var n=t[i];if(n.url.endsWith(e))return n}}else if("number"==typeof e){if(0<=e&&e<t.length)return t[e];cc.errorID(1206,e)}else cc.errorID(1207,e);return null}},{key:"loadScene",value:function(e,t,i){if(this._loadingScene)return cc.errorID(1208,e,this._loadingScene),!1;var n=this._getSceneUuid(e);if(n){var r=n.uuid;return this.emit(cc.Director.EVENT_BEFORE_SCENE_LOADING,e),this._loadingScene=e,this._loadSceneByUuid(r,t,i),!0}return cc.errorID(1209,e),!1}},{key:"preloadScene",value:function(e,t,i){var n,r;void 0===i?(r=t,n=void 0):(r=i,n=t);var a=this._getSceneUuid(e);if(a)this.emit(cc.Director.EVENT_BEFORE_SCENE_LOADING,e),cc.loader.load({uuid:a.uuid,type:"uuid"},n,(function(t,i){t&&cc.errorID(1210,e,t.message),r&&r(t,i)}));else{var o='Can not preload the scene "'+e+'" because it is not in the build settings.';r&&r(new Error(o)),cc.error("preloadScene: "+o)}}},{key:"_loadSceneByUuid",value:function(e,t,i,n){var r,a;r=t,a=i,console.time("LoadScene "+e),cc.AssetLibrary.loadAsset(e,(function(t,i){console.timeEnd("LoadScene "+e);var n=_O;if(n._loadingScene="",t)t="Failed to load scene: "+t,cc.error(t);else{if(i instanceof cc.SceneAsset){var o=i.scene;return o._id=i._uuid,o._name=i._name,void n.runSceneImmediate(o,a,r)}t="The asset "+e+" is not a scene",cc.error(t)}r&&r(t)}))}},{key:"resume",value:function(){this._paused&&(this._lastUpdate=performance.now(),this._lastUpdate||cc.logID(1200),this._paused=!1,this._deltaTime=0)}},{key:"setDepthTest",value:function(e){cc.Camera.main&&(cc.Camera.main.depth=!!e)}},{key:"setClearColor",value:function(e){cc.Camera.main&&(cc.Camera.main.backgroundColor=e)}},{key:"getRunningScene",value:function(){return this._scene}},{key:"getScene",value:function(){return this._scene}},{key:"getAnimationInterval",value:function(){return 1e3/cc.game.getFrameRate()}},{key:"setAnimationInterval",value:function(e){cc.game.setFrameRate(Math.round(1e3/e))}},{key:"getDeltaTime",value:function(){return this._deltaTime}},{key:"getCurrentTime",value:function(){return this._lastUpdate}},{key:"getTotalFrames",value:function(){return this._totalFrames}},{key:"isPaused",value:function(){return this._paused}},{key:"getScheduler",value:function(){return this._scheduler}},{key:"setScheduler",value:function(e){this._scheduler!==e&&(this.unregisterSystem(this._scheduler),this._scheduler=e,this.registerSystem(VA.ID,e,200))}},{key:"registerSystem",value:function(e,t,i){t.id=e,t.priority=i,t.init(),this._systems.push(t),this._systems.sort(NA.sortByPriority)}},{key:"unregisterSystem",value:function(e){tt.fastRemove(this._systems,e),this._systems.sort(NA.sortByPriority)}},{key:"getSystem",value:function(e){return this._systems.find((function(t){return t.id===e}))}},{key:"getAnimationManager",value:function(){return this.getSystem(cc.AnimationManager.ID)}},{key:"startAnimation",value:function(){this._invalid=!1,this._lastUpdate=performance.now()}},{key:"stopAnimation",value:function(){this._invalid=!0}},{key:"mainLoop",value:function(e){if(this._purgeDirectorInNextLoop)this._purgeDirectorInNextLoop=!1,this.purgeDirector();else if(!this._invalid){this.calculateDeltaTime();var i=this._deltaTime;if(!this._paused){this.emit(t.EVENT_BEFORE_UPDATE),this._compScheduler.startPhase(),this._compScheduler.updatePhase(i);for(var n=0;n<this._systems.length;++n)this._systems[n].update(i);this._compScheduler.lateUpdatePhase(i),this.emit(t.EVENT_AFTER_UPDATE),sl._deferredDestroy();for(var r=0;r<this._systems.length;++r)this._systems[r].postUpdate(i)}this.emit(t.EVENT_BEFORE_DRAW),this._root.frameMove(this._deltaTime),this._root.device.present(),this.emit(t.EVENT_AFTER_DRAW),Pv.frameUpdateListeners(),tg.bookOfChange.clear(),this._totalFrames++}}},{key:"_initOnRendererInitialized",value:function(){this._totalFrames=0,this._lastUpdate=performance.now(),this._paused=!1,this._purgeDirectorInNextLoop=!1,Pv&&Pv.setEnabled(!0),this.registerSystem(VA.ID,this._scheduler,200),this.emit(t.EVENT_INIT)}},{key:"_init",value:function(){cc.loader.init(this),this._root=new tO(cc.game._gfxDevice);return!!this._root.initialize({})}},{key:"root",get:function(){return this._root}}]),t}();iO.EVENT_INIT="director_init",iO.EVENT_RESET="director_reset",iO.EVENT_BEFORE_SCENE_LOADING="director_before_scene_loading",iO.EVENT_BEFORE_SCENE_LAUNCH="director_before_scene_launch",iO.EVENT_AFTER_SCENE_LAUNCH="director_after_scene_launch",iO.EVENT_BEFORE_UPDATE="director_before_update",iO.EVENT_AFTER_UPDATE="director_after_update",iO.EVENT_BEFORE_DRAW="director_before_draw",iO.EVENT_AFTER_DRAW="director_after_draw",iO.EVENT_BEFORE_PHYSICS="director_before_physics",iO.EVENT_AFTER_PHYSICS="director_after_physics",iO.instance=void 0,cc.Director=iO;var nO,rO,aO,oO,sO,lO,uO,cO,hO,pO,_O=iO.instance=cc.director=new iO,fO=(nO=Yo("cc.ClickEvent"),rO=Ko(cc.Node),nO((de((oO=function(){function e(){Z(this,e),fe(this,"target",sO,this),fe(this,"component",lO,this),fe(this,"_componentId",uO,this),fe(this,"handler",cO,this),fe(this,"customEventData",hO,this)}return J(e,[{key:"emit",value:function(e){var t=this.target;if(cc.isValid(t)){this._genCompIdIfNeeded();var i=cc.js._getClassById(this._componentId),n=t.getComponent(i);if(cc.isValid(n)){var r=n[this.handler];"function"==typeof r&&(null!=this.customEventData&&""!==this.customEventData&&(e=e.slice()).push(this.customEventData),r.apply(n,e))}}}},{key:"_compName2Id",value:function(e){var t=cc.js.getClassByName(e);return cc.js._getClassId(t)}},{key:"_compId2Name",value:function(e){var t=cc.js._getClassById(e);return cc.js.getClassName(t)}},{key:"_genCompIdIfNeeded",value:function(){this._componentId||(this._componentName=this.component,this.component="")}},{key:"_componentName",get:function(){return this._genCompIdIfNeeded(),this._compId2Name(this._componentId)},set:function(e){this._componentId=this._compName2Id(e)}}],[{key:"emitEvents",value:function(t){for(var i=arguments.length,n=new Array(i>1?i-1:0),r=1;r<i;r++)n[r-1]=arguments[r];for(var a=0,o=t.length;a<o;a++){var s=t[a];s instanceof e&&s.emit(n)}}}]),e}()).prototype,"_componentName",[Ko],Object.getOwnPropertyDescriptor(oO.prototype,"_componentName"),oO.prototype),sO=de(oO.prototype,"target",[rO],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return null}}),lO=de(oO.prototype,"component",[Ko],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return""}}),uO=de(oO.prototype,"_componentId",[Ko],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return""}}),cO=de(oO.prototype,"handler",[Ko],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return""}}),hO=de(oO.prototype,"customEventData",[Ko],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return""}}),aO=oO))||aO);cc.Component.EventHandler=fO;var dO=[exports.SystemEventType.TOUCH_START,exports.SystemEventType.TOUCH_END,exports.SystemEventType.TOUCH_MOVE,exports.SystemEventType.MOUSE_DOWN,exports.SystemEventType.MOUSE_MOVE,exports.SystemEventType.MOUSE_UP,exports.SystemEventType.MOUSE_ENTER,exports.SystemEventType.MOUSE_LEAVE,exports.SystemEventType.MOUSE_WHEEL];function mO(e){e.propagationStopped=!0}var vO,yO,gO,xO,bO,TO,SO,EO,wO,CO,AO,OO,kO,RO,FO,MO,IO,PO,LO,DO,NO,zO,BO,GO,UO,XO,VO,HO,WO,jO,qO,YO,KO,ZO,QO,JO,$O,ek,tk,ik,nk,rk,ak=Yo("cc.BlockInputEventsComponent")(pO=os("i18n:cc.BlockInputEventsComponent")(pO=es("Components/BlockInputEvents")(pO=function(e){function t(){return Z(this,t),re(this,te(t).apply(this,arguments))}return ee(t,rp),J(t,[{key:"onEnable",value:function(){for(var e=0;e<dO.length;e++)this.node.on(dO[e],mO,this)}},{key:"onDisable",value:function(){for(var e=0;e<dO.length;e++)this.node.off(dO[e],mO,this)}}]),t}())||pO)||pO)||pO;cc.BlockInputEventsComponent=ak;var ok,sk,lk,uk,ck,hk,pk,_k,fk,dk,mk,vk,yk,gk,xk,bk,Tk,Sk,Ek,wk=new Ii,Ck=xt(rv),Ak=xt(nv),Ok=xt(av),kk=xt(sv),Rk=xt(ov),Fk=xt({SKYBOX:yv|exports.GFXClearFlag.DEPTH_STENCIL,SOLID_COLOR:exports.GFXClearFlag.ALL,DEPTH_ONLY:exports.GFXClearFlag.DEPTH_STENCIL,DONT_CLEAR:exports.GFXClearFlag.NONE});exports.CameraComponent=(vO=Yo("cc.CameraComponent"),yO=os("i18n:cc.CameraComponent"),gO=es("Components/Camera"),xO=Ko({tooltip:"i18n:camera.priority",displayOrder:0}),bO=Ko({type:bu.BitMask,tooltip:"i18n:camera.visibility",displayOrder:1}),TO=Ko({type:Fk,tooltip:"i18n:camera.clear_flags",displayOrder:2}),SO=Ko({tooltip:"i18n:camera.color",displayOrder:3}),EO=Ko({tooltip:"i18n:camera.depth",displayOrder:4}),wO=Ko({tooltip:"i18n:camera.stencil",displayOrder:5}),CO=Ko({type:Ck,tooltip:"i18n:camera.projection",displayOrder:6}),AO=Ko({type:Ak,tooltip:"i18n:camera.fov_axis",displayOrder:7}),OO=Ko({tooltip:"i18n:camera.fov",displayOrder:8}),kO=Ko({tooltip:"i18n:camera.ortho_height",displayOrder:9}),RO=Ko({tooltip:"i18n:camera.near",displayOrder:10}),FO=Ko({tooltip:"i18n:camera.far",displayOrder:11}),MO=Ko({type:Ok,tooltip:"i18n:camera.aperture",displayOrder:12}),IO=Ko({type:kk,tooltip:"i18n:camera.shutter",displayOrder:13}),PO=Ko({type:Rk,tooltip:"i18n:camera.ISO",displayOrder:14}),LO=Ko({tooltip:"i18n:camera.rect",displayOrder:15}),DO=Ko({type:gc,tooltip:"i18n:camera.target_texture",displayOrder:16}),vO(NO=yO(NO=gO(NO=Jo((rk=nk=function(e){function t(){var e,i;Z(this,t);for(var n=arguments.length,r=new Array(n),a=0;a<n;a++)r[a]=arguments[a];return fe(i=re(this,(e=te(t)).call.apply(e,[this].concat(r))),"_projection",BO,ne(i)),fe(i,"_priority",GO,ne(i)),fe(i,"_fov",UO,ne(i)),fe(i,"_fovAxis",XO,ne(i)),fe(i,"_orthoHeight",VO,ne(i)),fe(i,"_near",HO,ne(i)),fe(i,"_far",WO,ne(i)),fe(i,"_color",jO,ne(i)),fe(i,"_depth",qO,ne(i)),fe(i,"_stencil",YO,ne(i)),fe(i,"_clearFlags",KO,ne(i)),fe(i,"_rect",ZO,ne(i)),fe(i,"_aperture",QO,ne(i)),fe(i,"_shutter",JO,ne(i)),fe(i,"_iso",$O,ne(i)),fe(i,"_screenScale",ek,ne(i)),fe(i,"_visibility",tk,ne(i)),fe(i,"_targetTexture",ik,ne(i)),i._camera=null,i._inEditorMode=!1,i._flows=void 0,i}return ee(t,rp),J(t,[{key:"onLoad",value:function(){cc.director.on(cc.Director.EVENT_AFTER_SCENE_LAUNCH,this.onSceneChanged,this),this._createCamera()}},{key:"onEnable",value:function(){this.node.hasChangedFlags|=rh.POSITION,this._camera&&this._attachToScene()}},{key:"onDisable",value:function(){this._camera&&this._detachFromScene()}},{key:"onDestroy",value:function(){this._camera&&(cc.director.root.destroyCamera(this._camera),this._camera=null),this._targetTexture&&this._targetTexture.off("resize")}},{key:"screenPointToRay",value:function(e,t,i){return i||(i=Cn.create()),this._camera&&this._camera.screenPointToRay(i,e,t),i}},{key:"worldToScreen",value:function(e,t){return t||(t=new Ii),this._camera&&this._camera.worldToScreen(t,e),t}},{key:"screenToWorld",value:function(e,t){return t||(t=this.node.getWorldPosition()),this._camera&&this._camera.screenToWorld(t,e),t}},{key:"convertToUINode",value:function(e,t,i){if(i||(i=new Ii),!this._camera)return i;this.worldToScreen(e,wk);var n=t.getComponent("cc.UITransformComponent"),r=nE.getVisibleSize(),a=wk.x-.5*this._camera.width,o=wk.y-.5*this._camera.height;return wk.x=a/cc.view.getScaleX()+.5*r.width,wk.y=o/cc.view.getScaleY()+.5*r.height,n&&n.convertToNodeSpaceAR(wk,i),i}},{key:"_createCamera",value:function(){if(this._camera=cc.director.root.createCamera(),this._camera.initialize({name:this.node.name,node:this.node,projection:this._projection,window:this._inEditorMode?cc.director.root&&cc.director.root.mainWindow:cc.director.root&&cc.director.root.tempWindow,priority:this._priority,flows:this._flows}),this._camera){this._camera.viewport=this._rect,this._camera.fovAxis=this._fovAxis,this._camera.fov=di(this._fov),this._camera.orthoHeight=this._orthoHeight,this._camera.nearClip=this._near,this._camera.farClip=this._far;var e=this._color.x,t=this._color.y,i=this._color.z,n=this._color.w;this._camera.clearColor={r:e,g:t,b:i,a:n},this._camera.clearDepth=this._depth,this._camera.clearStencil=this._stencil,this._camera.clearFlag=this._clearFlags,this._camera.visibility=this._visibility,this._camera.aperture=this._aperture,this._camera.shutter=this._shutter,this._camera.iso=this._iso}this._updateTargetTexture()}},{key:"_attachToScene",value:function(){this.node.scene&&this._camera&&(this._camera&&this._camera.scene&&this._camera.scene.removeCamera(this._camera),this._getRenderScene().addCamera(this._camera))}},{key:"_detachFromScene",value:function(){this._camera&&this._camera.scene&&this._camera.scene.removeCamera(this._camera)}},{key:"onSceneChanged",value:function(e){this._camera&&null==this._camera.scene&&this._attachToScene()}},{key:"_chechTargetTextureEvent",value:function(e){var t=this;e&&e.off("resize"),this._targetTexture&&this._targetTexture.on("resize",(function(e){t._camera&&t._camera.setFixedSize(e.width,e.height)}),this)}},{key:"_updateTargetTexture",value:function(){if(this._camera&&this._targetTexture){var e=this._targetTexture.getGFXWindow();this._camera.changeTargetWindow(e),this._camera.setFixedSize(e.width,e.height)}}},{key:"camera",get:function(){return this._camera}},{key:"priority",get:function(){return this._priority},set:function(e){this._priority=e,this._camera&&(this._camera.priority=e)}},{key:"visibility",get:function(){return this._visibility},set:function(e){this._visibility=e,this._camera&&(this._camera.visibility=e)}},{key:"clearFlags",get:function(){return this._clearFlags},set:function(e){this._clearFlags=e,this._camera&&(this._camera.clearFlag=e)}},{key:"clearColor",get:function(){return this._color},set:function(e){this._color.set(e),this._camera&&(this._camera.clearColor.r=this._color.x,this._camera.clearColor.g=this._color.y,this._camera.clearColor.b=this._color.z,this._camera.clearColor.a=this._color.w)}},{key:"clearDepth",get:function(){return this._depth},set:function(e){this._depth=e,this._camera&&(this._camera.clearDepth=e)}},{key:"clearStencil",get:function(){return this._stencil},set:function(e){this._stencil=e,this._camera&&(this._camera.clearStencil=e)}},{key:"projection",get:function(){return this._projection},set:function(e){this._projection=e,this._camera&&(this._camera.projectionType=e)}},{key:"fovAxis",get:function(){return this._fovAxis},set:function(e){e!==this._fovAxis&&(this._fovAxis=e,this._camera&&(this._camera.fovAxis=e,e===nv.VERTICAL?this.fov=this._fov*this._camera.aspect:this.fov=this._fov/this._camera.aspect))}},{key:"fov",get:function(){return this._fov},set:function(e){this._fov=e,this._camera&&(this._camera.fov=di(e))}},{key:"orthoHeight",get:function(){return this._orthoHeight},set:function(e){this._orthoHeight=e,this._camera&&(this._camera.orthoHeight=e)}},{key:"near",get:function(){return this._near},set:function(e){this._near=e,this._camera&&(this._camera.nearClip=e)}},{key:"far",get:function(){return this._far},set:function(e){this._far=e,this._camera&&(this._camera.farClip=e)}},{key:"aperture",get:function(){return this._aperture},set:function(e){this._aperture=e,this._camera&&(this._camera.aperture=e)}},{key:"shutter",get:function(){return this._shutter},set:function(e){this._shutter=e,this._camera&&(this._camera.shutter=e)}},{key:"iso",get:function(){return this._iso},set:function(e){this._iso=e,this._camera&&(this._camera.iso=e)}},{key:"rect",get:function(){return this._rect},set:function(e){this._rect=e,this._camera&&(this._camera.viewport=e)}},{key:"targetTexture",get:function(){return this._targetTexture},set:function(e){if(this._targetTexture!==e){var t=this._targetTexture;this._targetTexture=e,this._chechTargetTextureEvent(t),this._updateTargetTexture(),!e&&this._camera&&(this._camera.changeTargetWindow(null),this._camera.isWindowSize=!0)}}},{key:"screenScale",get:function(){return this._screenScale},set:function(e){this._screenScale=e,this._camera&&(this._camera.screenScale=e)}},{key:"inEditorMode",get:function(){return this._inEditorMode},set:function(e){this._inEditorMode=e,this._camera&&this._camera.changeTargetWindow(e?cc.director.root&&cc.director.root.mainWindow:cc.director.root&&cc.director.root.tempWindow)}},{key:"flows",set:function(e){this._camera&&(this._camera.flows=e),this._flows=e}}]),t}(),nk.ProjectionType=Ck,nk.FOVAxis=Ak,nk.ClearFlag=Fk,nk.Aperture=Ok,nk.Shutter=kk,nk.ISO=Rk,BO=de((zO=rk).prototype,"_projection",[Ko],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return Ck.PERSPECTIVE}}),GO=de(zO.prototype,"_priority",[Ko],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return 0}}),UO=de(zO.prototype,"_fov",[Ko],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return 45}}),XO=de(zO.prototype,"_fovAxis",[Ko],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return Ak.VERTICAL}}),VO=de(zO.prototype,"_orthoHeight",[Ko],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return 10}}),HO=de(zO.prototype,"_near",[Ko],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return 1}}),WO=de(zO.prototype,"_far",[Ko],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return 1e3}}),jO=de(zO.prototype,"_color",[Ko],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return new an("#333333")}}),qO=de(zO.prototype,"_depth",[Ko],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return 1}}),YO=de(zO.prototype,"_stencil",[Ko],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return 0}}),KO=de(zO.prototype,"_clearFlags",[Ko],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return Fk.SOLID_COLOR}}),ZO=de(zO.prototype,"_rect",[Ko],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return new nn(0,0,1,1)}}),QO=de(zO.prototype,"_aperture",[Ko],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return Ok.F16_0}}),JO=de(zO.prototype,"_shutter",[Ko],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return kk.D125}}),$O=de(zO.prototype,"_iso",[Ko],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return Rk.ISO100}}),ek=de(zO.prototype,"_screenScale",[Ko],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return 1}}),tk=de(zO.prototype,"_visibility",[Ko],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return Xu}}),ik=de(zO.prototype,"_targetTexture",[Ko],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return null}}),de(zO.prototype,"priority",[xO],Object.getOwnPropertyDescriptor(zO.prototype,"priority"),zO.prototype),de(zO.prototype,"visibility",[bO],Object.getOwnPropertyDescriptor(zO.prototype,"visibility"),zO.prototype),de(zO.prototype,"clearFlags",[TO],Object.getOwnPropertyDescriptor(zO.prototype,"clearFlags"),zO.prototype),de(zO.prototype,"clearColor",[SO],Object.getOwnPropertyDescriptor(zO.prototype,"clearColor"),zO.prototype),de(zO.prototype,"clearDepth",[EO],Object.getOwnPropertyDescriptor(zO.prototype,"clearDepth"),zO.prototype),de(zO.prototype,"clearStencil",[wO],Object.getOwnPropertyDescriptor(zO.prototype,"clearStencil"),zO.prototype),de(zO.prototype,"projection",[CO],Object.getOwnPropertyDescriptor(zO.prototype,"projection"),zO.prototype),de(zO.prototype,"fovAxis",[AO],Object.getOwnPropertyDescriptor(zO.prototype,"fovAxis"),zO.prototype),de(zO.prototype,"fov",[OO],Object.getOwnPropertyDescriptor(zO.prototype,"fov"),zO.prototype),de(zO.prototype,"orthoHeight",[kO],Object.getOwnPropertyDescriptor(zO.prototype,"orthoHeight"),zO.prototype),de(zO.prototype,"near",[RO],Object.getOwnPropertyDescriptor(zO.prototype,"near"),zO.prototype),de(zO.prototype,"far",[FO],Object.getOwnPropertyDescriptor(zO.prototype,"far"),zO.prototype),de(zO.prototype,"aperture",[MO],Object.getOwnPropertyDescriptor(zO.prototype,"aperture"),zO.prototype),de(zO.prototype,"shutter",[IO],Object.getOwnPropertyDescriptor(zO.prototype,"shutter"),zO.prototype),de(zO.prototype,"iso",[PO],Object.getOwnPropertyDescriptor(zO.prototype,"iso"),zO.prototype),de(zO.prototype,"rect",[LO],Object.getOwnPropertyDescriptor(zO.prototype,"rect"),zO.prototype),de(zO.prototype,"targetTexture",[DO],Object.getOwnPropertyDescriptor(zO.prototype,"targetTexture"),zO.prototype),NO=zO))||NO)||NO)||NO)||NO),exports.CameraComponent||(exports.CameraComponent={});var Mk,Ik,Pk,Lk,Dk,Nk,zk,Bk,Gk,Uk,Xk,Vk,Hk=new Ii,Wk=xt({SOLID_COLOR:exports.GFXClearFlag.ALL,DEPTH_ONLY:exports.GFXClearFlag.DEPTH_STENCIL,DONT_CLEAR:exports.GFXClearFlag.NONE}),jk=xt({OVERLAY:0,INTERSPERSE:1}),qk=(ok=Yo("cc.CanvasComponent"),sk=os("i18n:cc.CanvasComponent"),lk=ts(100),uk=$o(Iy),ck=es("UI/Canvas"),hk=Ko({type:Wk,tooltip:"清理屏幕缓冲标记"}),pk=Ko({tooltip:"清理颜色缓冲区后的颜色"}),_k=Ko({type:jk,tooltip:"Canvas 渲染模式，intersperse 下可以指定 Canvas 与场景中的相机的渲染顺序，overlay 下 Canvas 会在所有场景相机渲染完成后渲染。\n注意：注意：场景里的相机（包括 Canvas 内置的相机）必须有一个的 ClearFlag 选择 SOLID_COLOR，否则在移动端可能会出现闪屏"}),fk=Ko({tooltip:"相机排序优先级。当 RenderMode 为 intersperse 时，指定与其它相机的渲染顺序，当 RenderMode 为 overlay 时，指定跟其余 Canvas 做排序使用。需要对多 Canvas 设定 priority 以免出现不同平台下的闪屏问题。"}),dk=Ko({type:gc,tooltip:"目标渲染纹理"}),mk=Ko({type:Wk}),vk=Ko({type:jk}),ok(yk=sk(yk=lk(yk=uk(yk=ck(yk=Jo(yk=is((de((gk=function(e){function t(){var e;return Z(this,t),fe(e=re(this,te(t).call(this)),"_priority",xk,ne(e)),fe(e,"_targetTexture",bk,ne(e)),fe(e,"_clearFlag",Tk,ne(e)),fe(e,"_color",Sk,ne(e)),fe(e,"_renderMode",Ek,ne(e)),e._thisOnResized=void 0,e._camera=null,e._pos=new Ii,e._thisOnResized=e.alignWithScreen.bind(ne(e)),e}return ee(t,rp),J(t,[{key:"clearFlag",get:function(){return this._clearFlag},set:function(e){this._clearFlag=e,this._camera&&(this._camera.clearFlag=this._clearFlag)}},{key:"color",get:function(){return this._color},set:function(e){an.copy(this._color,e),this._camera&&(this._camera.clearColor.r=e.r/255,this._camera.clearColor.g=e.g/255,this._camera.clearColor.b=e.b/255,this._camera.clearColor.a=e.a/255)}},{key:"renderMode",get:function(){return this._renderMode},set:function(e){this._renderMode=e,this._camera&&(this._camera.priority=this._getViewPriority())}},{key:"priority",get:function(){return this._priority},set:function(e){this._priority=e,this._camera&&(this._camera.priority=this._getViewPriority()),_O.root&&_O.root.ui&&_O.root.ui.sortScreens()}},{key:"targetTexture",get:function(){return this._targetTexture},set:function(e){if(this._targetTexture!==e){var t=this._targetTexture;this._targetTexture=e,this._checkTargetTextureEvent(t),this._updateTargetTexture()}}},{key:"visibility",get:function(){return this._camera?this._camera.view.visibility:-1}},{key:"camera",get:function(){return this._camera}}]),J(t,[{key:"__preload",value:function(){var e=new tg("UICamera_"+this.node.name);if(e.setPosition(0,0,1e3),this._camera=_O.root.createCamera(),this._camera.initialize({name:"ui_"+this.node.name,node:e,projection:exports.CameraComponent.ProjectionType.ORTHO,priority:this._getViewPriority(),flows:["UIFlow"]}),this._camera.fov=45,this._camera.clearFlag=this.clearFlag,this._camera.farClip=2e3,this._camera.viewport=new nn(0,0,1,1),this.color=this._color,this._targetTexture){var t=this._targetTexture.getGFXWindow();this._camera.changeTargetWindow(t)}nE.on("design-resolution-changed",this._thisOnResized),this.alignWithScreen(),_O.root.ui.addScreen(this)}},{key:"onEnable",value:function(){this._camera&&_O.root.ui.renderScene.addCamera(this._camera)}},{key:"onDisable",value:function(){this._camera&&_O.root.ui.renderScene.removeCamera(this._camera)}},{key:"onDestroy",value:function(){_O.root.ui.removeScreen(this),this._camera&&_O.root.destroyCamera(this._camera),this._targetTexture&&this._targetTexture.off("resize"),nE.off("design-resolution-changed",this._thisOnResized)}},{key:"alignWithScreen",value:function(){var e,t;this.node.getPosition(this._pos);var i=KT;e=i,t=nE.getDesignResolutionSize();var n=0,r=0;nE.getResolutionPolicy()===cc.view._rpNoBorder&&(n=.5*(t.width-i.width),r=.5*(t.height-i.height)),Ii.set(Hk,.5*i.width+n,.5*i.height+r,0),this._pos.equals(Hk)||this.node.setPosition(Hk),this.node.width!==e.width&&(this.node.width=e.width),this.node.height!==e.height&&(this.node.height=e.height),this.node.getWorldPosition(Hk);var a=this._camera;if(a){if(this._targetTexture)a.setFixedSize(i.width,i.height),a.orthoHeight=i.height/2;else{var o=QS.canvas;a.resize(o.width,o.height),a.orthoHeight=QS.canvas.height/nE.getScaleY()/2}a.node.setPosition(Hk.x,Hk.y,1e3),a.update()}}},{key:"_checkTargetTextureEvent",value:function(e){var t=this;e&&e.off("resize"),this._targetTexture&&this._targetTexture.on("resize",(function(e){t._camera&&t._camera.setFixedSize(e.width,e.height)}),this)}},{key:"_updateTargetTexture",value:function(){if(this._camera){var e=this._camera;if(this._targetTexture){var t=this._targetTexture.getGFXWindow();e.changeTargetWindow(t),e.orthoHeight=KT.height/2,e.isWindowSize=!1}else e.changeTargetWindow(),e.orthoHeight=QS.canvas.height/nE.getScaleY()/2,e.isWindowSize=!0}}},{key:"_getViewPriority",value:function(){return this._renderMode===jk.OVERLAY?this._priority|1<<30:this._priority}}]),t}()).prototype,"clearFlag",[hk],Object.getOwnPropertyDescriptor(gk.prototype,"clearFlag"),gk.prototype),de(gk.prototype,"color",[pk],Object.getOwnPropertyDescriptor(gk.prototype,"color"),gk.prototype),de(gk.prototype,"renderMode",[_k],Object.getOwnPropertyDescriptor(gk.prototype,"renderMode"),gk.prototype),de(gk.prototype,"priority",[fk],Object.getOwnPropertyDescriptor(gk.prototype,"priority"),gk.prototype),de(gk.prototype,"targetTexture",[dk],Object.getOwnPropertyDescriptor(gk.prototype,"targetTexture"),gk.prototype),xk=de(gk.prototype,"_priority",[Ko],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return 0}}),bk=de(gk.prototype,"_targetTexture",[Ko],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return null}}),Tk=de(gk.prototype,"_clearFlag",[mk],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return Wk.DONT_CLEAR}}),Sk=de(gk.prototype,"_color",[Ko],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return new an(0,0,0,0)}}),Ek=de(gk.prototype,"_renderMode",[vk],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return jk.OVERLAY}}),yk=gk))||yk)||yk)||yk)||yk)||yk)||yk)||yk);cc.CanvasComponent=qk,exports.removeProperty(jC.prototype,"UIComponent",[{name:"_visibility"},{name:"setVisibility"}]);var Yk,Kk,Zk,Qk,Jk,$k,eR,tR,iR,nR,rR,aR,oR,sR,lR,uR,cR,hR,pR,_R,fR,dR,mR,vR,yR,gR,xR,bR,TR,SR,ER,wR,CR,AR,OR,kR,RR,FR,MR,IR,PR,LR,DR,NR,zR,BR,GR,UR,XR,VR,HR,WR,jR=(Mk=Yo("cc.SkinningModelComponent"),Ik=os("i18n:cc.SkinningModelComponent"),Pk=ts(100),Lk=es("Components/SkinningModel"),Dk=Ko(uv),Nk=Ko(tg),zk=Ko({type:uv}),Bk=Ko({type:tg,tooltip:"i18n:model.skinning_root"}),Mk(Gk=Ik(Gk=Pk(Gk=Jo(Gk=Lk((Xk=de((Uk=function(e){function t(){var e;return Z(this,t),fe(e=re(this,te(t).call(this)),"_skeleton",Xk,ne(e)),fe(e,"_skinningRoot",Vk,ne(e)),e._clip=null,e._modelType=cw,e}return ee(t,exports.ModelComponent),J(t,[{key:"skeleton",get:function(){return this._skeleton},set:function(e){e!==this._skeleton&&(this._skeleton=e,this._update())}},{key:"skinningRoot",get:function(){return this._skinningRoot},set:function(e){e!==this._skinningRoot&&(this._skinningRoot=e,this._updateModelType(),this._update())}},{key:"model",get:function(){return this._model}}]),J(t,[{key:"__preload",value:function(){this._updateModelType()}},{key:"uploadAnimation",value:function(e){this._clip=e,this.model&&this.model.uploadAnimation&&this.model.uploadAnimation(e)}},{key:"setUseBakedAnimation",value:function(){var e=!(arguments.length>0&&void 0!==arguments[0])||arguments[0],t=e?cw:lw;if(this._modelType!==t){this._modelType=t;var i=!!this._model;i&&(cc.director.root.destroyModel(this._model),this._model=null,this._models.length=0);var n=this._mesh?this._mesh.subMeshCount:0;if(this._modelType===lw)for(var r=null,a=0;a<n;++a){var o=this.getRenderMaterial(a);o===r?this.getMaterialInstance(a):r=o}else for(var s=0;s<n;++s){var l=this.getRenderMaterial(s);l&&l.parent&&l.parent.passes[0].instancedBuffer&&(this._materialInstances[s].destroy(),this._materialInstances[s]=null)}i&&(this._updateModels(),this._updateCastShadow(),this.enabledInHierarchy&&this._attachToScene())}}},{key:"setMaterial",value:function(e,i){oe(te(t.prototype),"setMaterial",this).call(this,e,i),this._modelType===lw&&this.getMaterialInstance(i)}},{key:"_updateModelParams",value:function(){this._update(),oe(te(t.prototype),"_updateModelParams",this).call(this)}},{key:"_updateModelType",value:function(){if(this._skinningRoot){var e=this._skinningRoot.getComponent("cc.SkeletalAnimationComponent");e&&this.setUseBakedAnimation(e.useBakedAnimation)}}},{key:"_update",value:function(){this.model&&(this.model.bindSkeleton(this._skeleton,this._skinningRoot,this._mesh),this.model.uploadAnimation&&this.model.uploadAnimation(this._clip))}}]),t}()).prototype,"_skeleton",[Dk],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return null}}),Vk=de(Uk.prototype,"_skinningRoot",[Nk],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return null}}),de(Uk.prototype,"skeleton",[zk],Object.getOwnPropertyDescriptor(Uk.prototype,"skeleton"),Uk.prototype),de(Uk.prototype,"skinningRoot",[Bk],Object.getOwnPropertyDescriptor(Uk.prototype,"skinningRoot"),Uk.prototype),Gk=Uk))||Gk)||Gk)||Gk)||Gk)||Gk),qR={name:exports.GFXAttributeName.ATTR_BATCH_ID,format:exports.GFXFormat.R32F,isNormalized:!1},YR={name:exports.GFXAttributeName.ATTR_BATCH_UV,format:exports.GFXFormat.RG32F,isNormalized:!1},KR=yr[qR.format].size+yr[YR.format].size,ZR=(Yk=Yo("cc.SkinningModelUnit"),Kk=Ko(rc),Zk=Ko(uv),Qk=Ko(Bh),Jk=Ko({type:jR}),Yk((tR=de((eR=function(){function e(){Z(this,e),fe(this,"mesh",tR,this),fe(this,"skeleton",iR,this),fe(this,"material",nR,this),fe(this,"_localTransform",rR,this),fe(this,"_offset",aR,this),fe(this,"_size",oR,this)}return J(e,[{key:"offset",set:function(e){ki.copy(this._offset,e)},get:function(){return this._offset}},{key:"size",set:function(e){ki.copy(this._size,e)},get:function(){return this._size}},{key:"copyFrom",set:function(e){e&&(this.mesh=e.mesh,this.skeleton=e.skeleton,this.material=e.getMaterial(0),e.skinningRoot&&IE(e.node,e.skinningRoot,this._localTransform))},get:function(){return null}}]),e}()).prototype,"mesh",[Kk],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return null}}),iR=de(eR.prototype,"skeleton",[Zk],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return null}}),nR=de(eR.prototype,"material",[Qk],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return null}}),rR=de(eR.prototype,"_localTransform",[Ko],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return new Ki}}),aR=de(eR.prototype,"_offset",[Ko],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return new ki(0,0)}}),oR=de(eR.prototype,"_size",[Ko],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return new ki(1,1)}}),de(eR.prototype,"offset",[Ko],Object.getOwnPropertyDescriptor(eR.prototype,"offset"),eR.prototype),de(eR.prototype,"size",[Ko],Object.getOwnPropertyDescriptor(eR.prototype,"size"),eR.prototype),de(eR.prototype,"copyFrom",[Jk],Object.getOwnPropertyDescriptor(eR.prototype,"copyFrom"),eR.prototype),$k=eR))||$k),QR=new Ki,JR=(new Ki,new Ii),$R=(sR=Yo("cc.BatchedSkinningModelComponent"),lR=os("i18n:cc.BatchedSkinningModelComponent"),uR=ts(100),cR=es("Components/BatchedSkinningModel"),hR=Ko({tooltip:"i18n:batched_skinning_model.atlas_size"}),pR=Ko({type:[It],tooltip:"i18n:batched_skinning_model.batchable_texture_names"}),_R=Ko({type:[ZR],tooltip:"i18n:batched_skinning_model.units"}),fR=Ko({override:!0,visible:!1}),dR=Ko({override:!0,visible:!1}),sR(mR=lR(mR=uR(mR=Jo(mR=cR((yR=de((vR=function(e){function t(){var e,i;Z(this,t);for(var n=arguments.length,r=new Array(n),a=0;a<n;a++)r[a]=arguments[a];return fe(i=re(this,(e=te(t)).call.apply(e,[this].concat(r))),"atlasSize",yR,ne(i)),fe(i,"batchableTextureNames",gR,ne(i)),fe(i,"units",xR,ne(i)),i._textures={},i._batchMaterial=null,i}return ee(t,jR),J(t,[{key:"onLoad",value:function(){oe(te(t.prototype),"onLoad",this).call(this),this.cook()}},{key:"onDestroy",value:function(){for(var e in this._textures)this._textures[e].destroy();this._textures={},this._mesh&&(this._mesh.destroy(),this._mesh=null),oe(te(t.prototype),"onDestroy",this).call(this)}},{key:"_onMaterialModified",value:function(e,i){this.cookMaterials(),oe(te(t.prototype),"_onMaterialModified",this).call(this,e,this.getMaterialInstance(e))}},{key:"cook",value:function(){this.cookMaterials(),this.cookSkeletons(),this.cookMeshes()}},{key:"cookMaterials",value:function(){var e=this;this._batchMaterial||(this._batchMaterial=this.getMaterial(0));var t=this.getMaterialInstance(0);if(t&&this._batchMaterial&&this._batchMaterial.effectAsset){t.copy(this._batchMaterial),this.resizeAtlases();for(var i=t.effectAsset.techniques[t.technique],n=function(n){var r=i.passes[n];if(!r.properties)return"continue";var a=function(i){if(r.properties[i].type>=exports.GFXType.SAMPLER1D){var a=null;e.batchableTextureNames.find((function(e){return e===i}))?((a=e._textures[i])||(a=e.createTexture(i)),e.cookTextures(a,i,n)):e.units.some((function(e){return a=e.material&&e.material.getProperty(i,n)})),a&&t.setProperty(i,a,n)}else{for(var o=[],s=0;s<e.units.length;s++){var l=e.units[s];l.material&&o.push(l.material.getProperty(i.slice(0,-3),n))}t.setProperty(i,o,n)}};for(var o in r.properties)a(o)},r=0;r<i.passes.length;r++)n(r)}else console.warn("incomplete batch material!")}},{key:"cookSkeletons",value:function(){if(this._skinningRoot){for(var e=[],t=[],i=0;i<this.units.length;i++){var n=this.units[i];if(n&&n.skeleton){var r=n.skeleton;Ki.invert(QR,n._localTransform);for(var a=function(i){var n=r.joints[i];if(e.findIndex((function(e){return e===n}))>=0)return"continue";e.push(n),t.push(Ki.multiply(new Ki,r.bindposes[i]||Ki.IDENTITY,QR))},o=0;o<r.joints.length;o++)a(o)}}var s=Array.from(Array(e.length).keys()).sort((function(t,i){return e[t]>e[i]?1:e[t]<e[i]?-1:0})),l=new uv;l.joints=e.map((function(e,t,i){return i[s[t]]})),l.bindposes=t.map((function(e,t,i){return i[s[t]]})),this._skeleton&&this._skeleton.destroy(),this.skeleton=l}else console.warn("no skinning root specified!")}},{key:"cookMeshes",value:function(){for(var e=this,t=!1,i=0;i<this.units.length;i++){if(this.units[i].mesh){t=!0;break}}if(t&&this._skinningRoot){this._mesh?this._mesh.destroyRenderingMesh():this._mesh=new rc;for(var n=0,r=exports.GFXFormat.UNKNOWN,a=0,o=exports.GFXFormat.UNKNOWN,s=0,l=exports.GFXFormat.UNKNOWN,u=0,c=exports.GFXFormat.UNKNOWN,h=0,p=exports.GFXFormat.UNKNOWN,_=new Array(this.units.length),f=this.units.length,d=0;d<f;d++){var m=this.units[d];m&&m.skeleton&&(_[d]=m.skeleton.joints.map((function(t){return e._skeleton.joints.findIndex((function(e){return t===e}))})))}for(var v=function(t){var i=e.units[t];if(!i||!i.mesh||!i.mesh.data)return"continue";var f=e._createUnitMesh(t,i.mesh),d=new DataView(f.data.buffer);Ki.inverseTranspose(QR,i._localTransform);for(var m=i.offset,v=i.size,y=function(e){var y=f.struct.vertexBundles[e];n=y.view.offset,r=exports.GFXFormat.UNKNOWN;for(var g=0;g<y.attributes.length;g++){var x=y.attributes[g];if(x.name===exports.GFXAttributeName.ATTR_POSITION){r=x.format;break}n+=yr[x.format].size}if(r){for(var b=$s(d,r,n,y.view.length,y.view.stride),T=0;T<b.length;T+=3)Ii.fromArray(JR,b,T),Ii.transformMat4(JR,JR,i._localTransform),Ii.toArray(b,JR,T);Js(d,b,r,n,y.view.stride)}a=y.view.offset,o=exports.GFXFormat.UNKNOWN;for(var S=0;S<y.attributes.length;S++){var E=y.attributes[S];if(E.name===exports.GFXAttributeName.ATTR_NORMAL){o=E.format;break}a+=yr[E.format].size}if(o){for(var w=$s(d,o,a,y.view.length,y.view.stride),C=0;C<w.length;C+=3)Ii.fromArray(JR,w,C),Ii.transformMat4Normal(JR,JR,QR),Ii.toArray(w,JR,C);Js(d,w,o,a,y.view.stride)}s=y.view.offset,l=exports.GFXFormat.UNKNOWN;for(var A=0;A<y.attributes.length;A++){var O=y.attributes[A];if(O.name===exports.GFXAttributeName.ATTR_TANGENT){l=O.format;break}s+=yr[O.format].size}if(l){for(var k=$s(d,l,s,y.view.length,y.view.stride),R=0;R<k.length;R+=3)Ii.fromArray(JR,k,R),Ii.transformMat4Normal(JR,JR,QR),Ii.toArray(k,JR,R);Js(d,k,l,s,y.view.stride)}u=y.view.offset,c=exports.GFXFormat.UNKNOWN;for(var F=0;F<y.attributes.length;F++){var M=y.attributes[F];if(M.name===exports.GFXAttributeName.ATTR_BATCH_UV){c=M.format;break}u+=yr[M.format].size}c&&el(d,(function(e,t){var i,n=0===t?"x":"y";return(e=(i=e)-Math.floor(i))*v[n]+m[n]}),c,u,y.view.length,y.view.stride,d);var I=_[t];if(!I)return"continue";h=y.view.offset,p=exports.GFXFormat.UNKNOWN;for(var P=0;P<y.attributes.length;P++){var L=y.attributes[P];if(L.name===exports.GFXAttributeName.ATTR_JOINTS){p=L.format;break}h+=yr[L.format].size}p&&el(d,(function(e){return I[e]}),p,h,y.view.length,y.view.stride,d)},g=0;g<f.struct.vertexBundles.length;g++)y(g);e._mesh.merge(f)},y=0;y<f;y++)v(y);this._onMeshChanged(this._mesh),this._updateModels()}}},{key:"cookTextures",value:function(e,t,i){for(var n=[],r=[],a=[],o=[],s=0;s<this.units.length;s++){var l=this.units[s];if(l.material){var u=l.material.getProperty(t,i);if(u&&u.image&&u.image.data){var c=new vr;c.texOffset.x=l.offset.x*this.atlasSize,c.texOffset.y=l.offset.y*this.atlasSize,c.texExtent.width=l.size.x*this.atlasSize,c.texExtent.height=l.size.y*this.atlasSize;var h=u.image.data;h instanceof HTMLCanvasElement||h instanceof HTMLImageElement?(n.push(h),r.push(c)):(a.push(h),o.push(c))}}}var p=e.getGFXTexture(),_=cc.director.root.device;a.length>0&&_.copyBuffersToTexture(a,p,o),n.length>0&&_.copyTexImagesToTexture(n,p,r)}},{key:"createTexture",value:function(e){var t=new gu;return t.setFilters(Rl.LINEAR,Rl.LINEAR),t.setMipFilter(Rl.LINEAR),t.reset({width:this.atlasSize,height:this.atlasSize,format:Ol.RGBA8888}),t.loaded=!0,this._textures[e]=t,t}},{key:"resizeAtlases",value:function(){for(var e in this._textures){this._textures[e].reset({width:this.atlasSize,height:this.atlasSize,format:Ol.RGBA8888})}}},{key:"_createUnitMesh",value:function(e,t){for(var i=JSON.parse(JSON.stringify(t.struct)),n={},r=0;r<t.struct.primitives.length;r++){for(var a=t.struct.primitives[r],o=0,s=exports.GFXFormat.UNKNOWN,l=0;l<a.vertexBundelIndices.length;l++){var u=t.struct.vertexBundles[a.vertexBundelIndices[l]];o=u.view.offset,s=exports.GFXFormat.UNKNOWN;for(var c=0;c<u.attributes.length;c++){var h=u.attributes[c];if(h.name===exports.GFXAttributeName.ATTR_TEX_COORD){s=h.format;break}o+=yr[h.format].size}if(s)break}if(void 0===n[l]){n[l]=[s,o];var p=i.vertexBundles[l];p.attributes.push(qR),p.attributes.push(YR),p.view.offset=0,p.view.length+=p.view.count*KR,p.view.stride+=KR}}for(var _=0,f=0;f<i.vertexBundles.length;f++)_+=i.vertexBundles[f].view.length;for(var d=0;d<i.primitives.length;d++){var m=i.primitives[d];m.indexView&&(m.indexView.offset=_,_+=m.indexView.length)}var v=new Uint8Array(_),y=t.data,g=new DataView(v.buffer),x=new DataView(y.buffer),b=Cs.isLittleEndian;for(var T in n)for(var S=i.vertexBundles[T],E=t.struct.vertexBundles[T],w=ue(n[T],2),C=$s(x,w[0],w[1],E.view.length,E.view.stride),A=E.view,O=S.view,k=A.stride,R=O.stride,F=A.offset,M=O.offset,I=0;I<O.count;I++){var P=y.subarray(F,F+k);v.set(P,M),g.setFloat32(M+k,e),g.setFloat32(M+k+4,C[2*I],b),g.setFloat32(M+k+8,C[2*I+1],b),M+=R,F+=k}for(var L=0;L<i.primitives.length;L++){var D=t.struct.primitives[L],N=i.primitives[L];if(D.indexView&&N.indexView)for(var z=D.indexView.stride,B=N.indexView.stride,G=D.indexView.offset,U=N.indexView.offset,X=0;X<N.indexView.count;X++){var V=y.subarray(G,G+z);v.set(V,U),U+=B,G+=z}}var H=new rc;return H.reset({struct:i,data:v}),H}},{key:"mesh",get:function(){return oe(te(t.prototype),"mesh",this)},set:function(e){le(te(t.prototype),"mesh",e,this,!0)}},{key:"skeleton",get:function(){return oe(te(t.prototype),"skeleton",this)},set:function(e){le(te(t.prototype),"skeleton",e,this,!0)}}]),t}()).prototype,"atlasSize",[hR],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return 1024}}),gR=de(vR.prototype,"batchableTextureNames",[pR],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return[]}}),xR=de(vR.prototype,"units",[_R],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return[]}}),de(vR.prototype,"mesh",[fR],Object.getOwnPropertyDescriptor(vR.prototype,"mesh"),vR.prototype),de(vR.prototype,"skeleton",[dR],Object.getOwnPropertyDescriptor(vR.prototype,"skeleton"),vR.prototype),mR=vR))||mR)||mR)||mR)||mR)||mR),eF=xt({LUMINOUS_POWER:0,LUMINANCE:1}),tF=Yo("cc.StaticLightSettings")((SR=de((TR=function(){function e(){Z(this,e),fe(this,"_editorOnly",SR,this),fe(this,"_bakeable",ER,this),fe(this,"_castShadow",wR,this)}return J(e,[{key:"editorOnly",get:function(){return this._editorOnly},set:function(e){this._editorOnly=e}},{key:"bakeable",get:function(){return this._bakeable},set:function(e){this._bakeable=e}},{key:"castShadow",get:function(){return this._castShadow},set:function(e){this._castShadow=e}}]),e}()).prototype,"_editorOnly",[Ko],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return!1}}),ER=de(TR.prototype,"_bakeable",[Ko],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return!1}}),wR=de(TR.prototype,"_castShadow",[Ko],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return!1}}),de(TR.prototype,"editorOnly",[Ko],Object.getOwnPropertyDescriptor(TR.prototype,"editorOnly"),TR.prototype),de(TR.prototype,"bakeable",[Ko],Object.getOwnPropertyDescriptor(TR.prototype,"bakeable"),TR.prototype),de(TR.prototype,"castShadow",[Ko],Object.getOwnPropertyDescriptor(TR.prototype,"castShadow"),TR.prototype),bR=TR))||bR;exports.LightComponent||(exports.LightComponent={}),exports.LightComponent=(CR=Yo("cc.LightComponent"),AR=Ko({tooltip:"i18n:lights.color"}),OR=Ko({tooltip:"i18n:lights.use_color_temperature"}),kR=Ko({slide:!0,range:[1e3,15e3,1],tooltip:"i18n:lights.color_temperature"}),RR=Ko({type:tF}),CR((zR=NR=function(e){function t(){var e;return Z(this,t),fe(e=re(this,te(t).call(this)),"_color",IR,ne(e)),fe(e,"_useColorTemperature",PR,ne(e)),fe(e,"_colorTemperature",LR,ne(e)),fe(e,"_staticSettings",DR,ne(e)),e._type=ZT.UNKNOWN,e._lightType=void 0,e._light=null,e._lightType=eS,e}return ee(t,rp),J(t,[{key:"color",get:function(){return this._color},set:function(e){this._color=e,this._light&&(this._light.color.x=e.r/255,this._light.color.y=e.g/255,this._light.color.z=e.b/255)}},{key:"useColorTemperature",get:function(){return this._useColorTemperature},set:function(e){this._useColorTemperature=e,this._light&&(this._light.useColorTemperature=e)}},{key:"colorTemperature",get:function(){return this._colorTemperature},set:function(e){this._colorTemperature=e,this._light&&(this._light.colorTemperature=e)}},{key:"staticSettings",get:function(){return this._staticSettings},set:function(e){this._staticSettings=e}},{key:"type",get:function(){return this._type}}]),J(t,[{key:"onLoad",value:function(){this._createLight()}},{key:"onEnable",value:function(){this._attachToScene()}},{key:"onDisable",value:function(){this._detachFromScene()}},{key:"onDestroy",value:function(){this._destroyLight()}},{key:"_createLight",value:function(){this._light||(this._light=cc.director.root.createLight(this._lightType)),this.color=this._color,this.useColorTemperature=this._useColorTemperature,this.colorTemperature=this._colorTemperature,this._light.node=this.node}},{key:"_destroyLight",value:function(){this._light&&(cc.director.root.destroyLight(this),this._light=null)}},{key:"_attachToScene",value:function(){if(this._detachFromScene(),this._light&&!this._light.scene&&this.node.scene)switch(this._type){case ZT.DIRECTIONAL:this._getRenderScene().addDirectionalLight(this._light),this._getRenderScene().setMainLight(this._light);break;case ZT.SPHERE:this._getRenderScene().addSphereLight(this._light);break;case ZT.SPOT:this._getRenderScene().addSpotLight(this._light)}}},{key:"_detachFromScene",value:function(){if(this._light&&this._light.scene)switch(this._type){case ZT.DIRECTIONAL:var e=this._light.scene;e.removeDirectionalLight(this._light),e.unsetMainLight(this._light);break;case ZT.SPHERE:this._light.scene.removeSphereLight(this._light);break;case ZT.SPOT:this._light.scene.removeSpotLight(this._light)}}}]),t}(),NR.Type=ZT,NR.PhotometricTerm=eF,IR=de((MR=zR).prototype,"_color",[Ko],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return an.WHITE.clone()}}),PR=de(MR.prototype,"_useColorTemperature",[Ko],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return!1}}),LR=de(MR.prototype,"_colorTemperature",[Ko],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return 6550}}),DR=de(MR.prototype,"_staticSettings",[Ko],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return new tF}}),de(MR.prototype,"color",[AR],Object.getOwnPropertyDescriptor(MR.prototype,"color"),MR.prototype),de(MR.prototype,"useColorTemperature",[OR],Object.getOwnPropertyDescriptor(MR.prototype,"useColorTemperature"),MR.prototype),de(MR.prototype,"colorTemperature",[kR],Object.getOwnPropertyDescriptor(MR.prototype,"colorTemperature"),MR.prototype),de(MR.prototype,"staticSettings",[RR],Object.getOwnPropertyDescriptor(MR.prototype,"staticSettings"),MR.prototype),FR=MR))||FR);var iF,nF,rF,aF,oF,sF,lF,uF,cF,hF,pF,_F,fF,dF,mF,vF,yF,gF,xF,bF,TF,SF,EF,wF,CF,AF,OF,kF,RF,FF,MF,IF,PF,LF,DF,NF,zF,BF,GF,UF,XF,VF,HF,WF,jF,qF,YF=(BR=Yo("cc.DirectionalLightComponent"),GR=os("i18n:cc.DirectionalLightComponent"),UR=es("Light/DirectionalLight"),XR=Ko({unit:"lx",tooltip:"i18n:lights.illuminance"}),BR(VR=GR(VR=UR(VR=Jo((WR=de((HR=function(e){function t(){var e;return Z(this,t),fe(e=re(this,te(t).call(this)),"_illuminance",WR,ne(e)),e._type=ZT.DIRECTIONAL,e._light=null,e._lightType=RC,e}return ee(t,exports.LightComponent),J(t,[{key:"illuminance",get:function(){return this._illuminance},set:function(e){this._illuminance=e,this._light&&(this._light.illuminance=this._illuminance)}}]),J(t,[{key:"_createLight",value:function(){oe(te(t.prototype),"_createLight",this).call(this),this._light&&(this.illuminance=this._illuminance)}}]),t}()).prototype,"_illuminance",[Ko],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return 65e3}}),de(HR.prototype,"illuminance",[XR],Object.getOwnPropertyDescriptor(HR.prototype,"illuminance"),HR.prototype),VR=HR))||VR)||VR)||VR)||VR),KF=(iF=Yo("cc.SphereLightComponent"),nF=os("i18n:cc.SphereLightComponent"),rF=es("Light/SphereLight"),aF=Ko({unit:"lm",tooltip:"i18n:lights.luminous_power"}),oF=Ko({unit:"cd/m²",tooltip:"i18n:lights.luminance"}),sF=Ko({type:eF,tooltip:"i18n:lights.term"}),lF=Ko({tooltip:"i18n:lights.size"}),uF=Ko({tooltip:"i18n:lights.range"}),iF(cF=nF(cF=rF(cF=Jo((pF=de((hF=function(e){function t(){var e;return Z(this,t),fe(e=re(this,te(t).call(this)),"_size",pF,ne(e)),fe(e,"_luminance",_F,ne(e)),fe(e,"_term",fF,ne(e)),fe(e,"_range",dF,ne(e)),e._type=ZT.SPHERE,e._light=null,e._lightType=FC,e}return ee(t,exports.LightComponent),J(t,[{key:"luminousPower",get:function(){return this._luminance*$T(this._size)},set:function(e){this._luminance=e/$T(this._size),this._light&&(this._light.luminance=this._luminance)}},{key:"luminance",get:function(){return this._luminance},set:function(e){this._luminance=e,this._light&&(this._light.luminance=e)}},{key:"term",get:function(){return this._term},set:function(e){this._term=e}},{key:"size",get:function(){return this._size},set:function(e){this._size=e,this._light&&(this._light.size=e)}},{key:"range",get:function(){return this._range},set:function(e){this._range=e,this._light&&(this._light.range=e)}}]),J(t,[{key:"_createLight",value:function(){oe(te(t.prototype),"_createLight",this).call(this),this._light&&(this.luminance=this._luminance,this.size=this._size,this.range=this._range)}}]),t}()).prototype,"_size",[Ko],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return.15}}),_F=de(hF.prototype,"_luminance",[Ko],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return 1700/$T(.15)}}),fF=de(hF.prototype,"_term",[Ko],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return eF.LUMINOUS_POWER}}),dF=de(hF.prototype,"_range",[Ko],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return 1}}),de(hF.prototype,"luminousPower",[aF],Object.getOwnPropertyDescriptor(hF.prototype,"luminousPower"),hF.prototype),de(hF.prototype,"luminance",[oF],Object.getOwnPropertyDescriptor(hF.prototype,"luminance"),hF.prototype),de(hF.prototype,"term",[sF],Object.getOwnPropertyDescriptor(hF.prototype,"term"),hF.prototype),de(hF.prototype,"size",[lF],Object.getOwnPropertyDescriptor(hF.prototype,"size"),hF.prototype),de(hF.prototype,"range",[uF],Object.getOwnPropertyDescriptor(hF.prototype,"range"),hF.prototype),cF=hF))||cF)||cF)||cF)||cF),ZF=(mF=Yo("cc.SpotLightComponent"),vF=os("i18n:cc.SpotLightComponent"),yF=es("Light/SpotLight"),gF=Ko({unit:"lm",tooltip:"i18n:lights.luminous_power"}),xF=Ko({unit:"cd/m²",tooltip:"i18n:lights.luminance"}),bF=Ko({type:eF,tooltip:"i18n:lights.term"}),TF=Ko({tooltip:"i18n:lights.size"}),SF=Ko({tooltip:"i18n:lights.range"}),EF=Ko({slide:!0,range:[2,180,1],tooltip:"The spot light cone angle"}),mF(wF=vF(wF=yF(wF=Jo((AF=de((CF=function(e){function t(){var e;return Z(this,t),fe(e=re(this,te(t).call(this)),"_size",AF,ne(e)),fe(e,"_luminance",OF,ne(e)),fe(e,"_term",kF,ne(e)),fe(e,"_range",RF,ne(e)),fe(e,"_spotAngle",FF,ne(e)),e._type=ZT.SPOT,e._light=null,e._lightType=zC,e}return ee(t,exports.LightComponent),J(t,[{key:"luminousPower",get:function(){return this._luminance*$T(this._size)},set:function(e){this._luminance=e/$T(this._size),this._light&&(this._light.luminance=this._luminance)}},{key:"luminance",get:function(){return this._luminance},set:function(e){this._luminance=e,this._light&&(this._light.luminance=e)}},{key:"term",get:function(){return this._term},set:function(e){this._term=e}},{key:"size",get:function(){return this._size},set:function(e){this._size=e,this._light&&(this._light.size=e)}},{key:"range",get:function(){return this._range},set:function(e){this._range=e,this._light&&(this._light.range=e)}},{key:"spotAngle",get:function(){return this._spotAngle},set:function(e){this._spotAngle=e,this._light&&(this._light.spotAngle=di(e))}}]),J(t,[{key:"_createLight",value:function(){oe(te(t.prototype),"_createLight",this).call(this),this._light&&(this.luminance=this._luminance,this.size=this._size,this.range=this._range,this.spotAngle=this._spotAngle)}}]),t}()).prototype,"_size",[Ko],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return.15}}),OF=de(CF.prototype,"_luminance",[Ko],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return 1700/$T(.15)}}),kF=de(CF.prototype,"_term",[Ko],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return eF.LUMINOUS_POWER}}),RF=de(CF.prototype,"_range",[Ko],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return 1}}),FF=de(CF.prototype,"_spotAngle",[Ko],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return 60}}),de(CF.prototype,"luminousPower",[gF],Object.getOwnPropertyDescriptor(CF.prototype,"luminousPower"),CF.prototype),de(CF.prototype,"luminance",[xF],Object.getOwnPropertyDescriptor(CF.prototype,"luminance"),CF.prototype),de(CF.prototype,"term",[bF],Object.getOwnPropertyDescriptor(CF.prototype,"term"),CF.prototype),de(CF.prototype,"size",[TF],Object.getOwnPropertyDescriptor(CF.prototype,"size"),CF.prototype),de(CF.prototype,"range",[SF],Object.getOwnPropertyDescriptor(CF.prototype,"range"),CF.prototype),de(CF.prototype,"spotAngle",[EF],Object.getOwnPropertyDescriptor(CF.prototype,"spotAngle"),CF.prototype),wF=CF))||wF)||wF)||wF)||wF);exports.removeProperty(exports.ModelComponent.prototype,"ModelComponent.prototype",[{name:"enableDynamicBatching"},{name:"recieveShadows"}]),exports.replaceProperty(exports.CameraComponent,"CameraComponent",[{name:"CameraClearFlag",newName:"ClearFlag"}]),cc.CameraComponent=exports.CameraComponent,cc.RenderableComponent=Hp,cc.ModelComponent=exports.ModelComponent,cc.SkinningModelComponent=jR,cc.BatchedSkinningModelComponent=$R,cc.SkinningModelUnit=ZR,cc.LightComponent=exports.LightComponent,cc.DirectionalLightComponent=YF,cc.SphereLightComponent=KF,cc.SpotLightComponent=ZF,cc.utils=gw;var QF,JF,$F,eM,tM,iM,nM,rM,aM,oM=(MF=Yo("cc.UICoordinateTrackerComponent"),IF=os("i18n:cc.UICoordinateTrackerComponent"),PF=es("Components/UICoordinateTracker"),LF=ts(110),DF=Ko({type:tg,tooltip:"目标对象"}),NF=Ko({type:exports.CameraComponent,tooltip:"照射相机"}),zF=Ko({tooltip:"是否是缩放映射"}),BF=Ko({tooltip:"距相机多少距离为正常显示计算大小"}),GF=Ko({type:[fO],tooltip:"映射数据事件。回调的第一个参数是映射后的本地坐标，第二个是距相机距离比"}),MF(UF=IF(UF=PF(UF=LF((de((XF=function(e){function t(){var e,i;Z(this,t);for(var n=arguments.length,r=new Array(n),a=0;a<n;a++)r[a]=arguments[a];return fe(i=re(this,(e=te(t)).call.apply(e,[this].concat(r))),"syncEvents",VF,ne(i)),fe(i,"_target",HF,ne(i)),fe(i,"_camera",WF,ne(i)),fe(i,"_useScale",jF,ne(i)),fe(i,"_distance",qF,ne(i)),i._transformPos=new Ii,i._viewPos=new Ii,i._canMove=!0,i._lastWpos=new Ii,i._lastCameraPos=new Ii,i}return ee(t,rp),J(t,[{key:"onEnable",value:function(){this._checkCanMove()}},{key:"update",value:function(){var e=this.node.worldPosition,t=this._camera;if(this._canMove&&t._camera&&(!this._lastWpos.equals(e)||!this._lastCameraPos.equals(t.node.worldPosition))&&(this._lastWpos.set(e),this._lastCameraPos.set(t.node.worldPosition),t._camera.update(),h_.WorldNode3DToLocalNodeUI(t,e,this._target,this._transformPos),this._useScale&&Ii.transformMat4(this._viewPos,this.node.worldPosition,t._camera.matView),this.syncEvents.length>0)){var i=this._distance/Math.abs(this._viewPos.z);fO.emitEvents(this.syncEvents,this._transformPos,i)}}},{key:"_checkCanMove",value:function(){this._canMove=!(!this._camera||!this._target)}},{key:"target",get:function(){return this._target},set:function(e){this._target!==e&&(this._target=e,this._checkCanMove())}},{key:"camera",get:function(){return this._camera},set:function(e){this._camera!==e&&(this._camera=e,this._checkCanMove())}},{key:"useScale",get:function(){return this._useScale},set:function(e){this._useScale!==e&&(this._useScale=e)}},{key:"distance",get:function(){return this._distance},set:function(e){this._distance!==e&&(this._distance=e)}}]),t}()).prototype,"target",[DF],Object.getOwnPropertyDescriptor(XF.prototype,"target"),XF.prototype),de(XF.prototype,"camera",[NF],Object.getOwnPropertyDescriptor(XF.prototype,"camera"),XF.prototype),de(XF.prototype,"useScale",[zF],Object.getOwnPropertyDescriptor(XF.prototype,"useScale"),XF.prototype),de(XF.prototype,"distance",[BF],Object.getOwnPropertyDescriptor(XF.prototype,"distance"),XF.prototype),VF=de(XF.prototype,"syncEvents",[GF],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return[]}}),HF=de(XF.prototype,"_target",[Ko],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return null}}),WF=de(XF.prototype,"_camera",[Ko],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return null}}),jF=de(XF.prototype,"_useScale",[Ko],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return!0}}),qF=de(XF.prototype,"_distance",[Ko],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return 1}}),UF=XF))||UF)||UF)||UF)||UF),sM=Yo("cc.animation.UniformProxyFactory")(($F=de((JF=function(){function e(t,i){Z(this,e),fe(this,"passIndex",$F,this),fe(this,"uniformName",eM,this),fe(this,"channelIndex",tM,this),this.passIndex=i||0,this.uniformName=t||""}return J(e,[{key:"forTarget",value:function(e){var t=e.passes[this.passIndex],i=t.getHandle(this.uniformName);if(void 0===i)throw new Error('Material "'.concat(e.name,'" has no uniform "').concat(this.uniformName,'"'));var n=Eh.getBindingTypeFromHandle(i);if(n===exports.GFXBindingType.UNIFORM_BUFFER){var r=void 0===this.channelIndex?i:t.getHandle(this.uniformName,this.channelIndex,exports.GFXType.FLOAT);if(void 0===r)throw new Error('Uniform "'.concat(this.uniformName," (in material ").concat(e.name,") has no channel ").concat(this.channelIndex,'"'));return function(e,t){for(var i,n=_e(e.shaderInfo.blocks);!(i=n()).done;)for(var r,a=_e(i.value.members);!(r=a()).done;){var o=r.value;if(o.name===t)return o.count>1}return!1}(t,this.uniformName)?{set:function(e){t.setUniformArray(r,e)}}:{set:function(e){t.setUniform(r,e)}}}if(n===exports.GFXBindingType.SAMPLER){var a=Eh.getBindingFromHandle(i),o=t.properties[this.uniformName],s=o&&o.value?o.value+"-texture":Wc(o.type),l=Pc.get(s);return l||(c("Illegal texture default value: ".concat(s,".")),l=Pc.get("default-texture")),{set:function(e){e||(e=l);var i=e.getGFXTextureView();i&&i.texture.width&&i.texture.height&&(t.bindTextureView(a,i),e instanceof lu&&t.bindSampler(a,ou.getSampler(cc.game._gfxDevice,e.getSamplerHash())))}}}throw new Error("Animations are not available for uniforms with binding type ".concat(n,"."))}}]),e}()).prototype,"passIndex",[Ko],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return 0}}),eM=de(JF.prototype,"uniformName",[Ko],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return""}}),tM=de(JF.prototype,"channelIndex",[ls],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){}}),QF=JF))||QF;var lM,uM,cM,hM,pM,_M=Yo("cc.animation.MorphWeightsValueProxy")((rM=de((nM=function(){function e(){Z(this,e),fe(this,"subMeshIndex",rM,this)}return J(e,[{key:"forTarget",value:function(e){var t=this;return{set:function(i){e.setWeights(i,t.subMeshIndex)}}}}]),e}()).prototype,"subMeshIndex",[Ko],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return 0}}),iM=nM))||iM,fM=Yo("cc.animation.MorphWeightsAllValueProxy")(aM=function(){function e(){Z(this,e)}return J(e,[{key:"forTarget",value:function(e){return{set:function(t){for(var i,n,r=null!==(i=null===(n=e.mesh)||void 0===n?void 0:n.struct.primitives.length)&&void 0!==i?i:0,a=0;a<r;++a)e.setWeights(t,a)}}}}]),e}())||aM;function dM(e,t,i,n){var r,a,o,s,l,u=new t,c=new t,h=new t,p=Yo(e)((o=de((a=function(){function e(i,n,r){Z(this,e),fe(this,"dataPoint",o,this),fe(this,"inTangent",s,this),fe(this,"outTangent",l,this),this.dataPoint=i||new t,this.inTangent=n||new t,this.outTangent=r||new t}return J(e,[{key:"lerp",value:function(e,t,r){var a=this.dataPoint,o=e.dataPoint;c=i(c,this.inTangent,r),h=i(h,e.outTangent,r);var s=t*t*t,l=t*t,p=s-2*l+t,_=-2*s+3*l,f=s-l;return u=i(u,a,2*s-3*l+1),u=n(u,u,c,p),u=n(u,u,o,_),u=n(u,u,h,f)}},{key:"getNoLerp",value:function(){return this.dataPoint}}]),e}()).prototype,"dataPoint",[Ko],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return new t}}),s=de(a.prototype,"inTangent",[Ko],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return new t}}),l=de(a.prototype,"outTangent",[Ko],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return new t}}),r=a))||r;if(t===Xi){var _=p.prototype.lerp;p.prototype.lerp=function(e,t,i){var n=_.call(this,e,t,i);return Xi.normalize(n,n),n}}return p}var mM=dM("cc.CubicSplineVec2Value",ki,ki.multiplyScalar,ki.scaleAndAdd);cc.CubicSplineVec2Value=mM;var vM=dM("cc.CubicSplineVec3Value",Ii,Ii.multiplyScalar,Ii.scaleAndAdd);cc.CubicSplineVec3Value=vM;var yM=dM("cc.CubicSplineVec4Value",Ni,Ni.multiplyScalar,Ni.scaleAndAdd);cc.CubicSplineVec4Value=yM;var gM=dM("cc.CubicSplineQuatValue",Xi,Xi.multiplyScalar,Xi.scaleAndAdd);cc.CubicSplineQuatValue=gM;var xM=Yo("cc.CubicSplineNumberValue")((cM=de((uM=function(){function e(t,i,n){Z(this,e),fe(this,"dataPoint",cM,this),fe(this,"inTangent",hM,this),fe(this,"outTangent",pM,this),this.dataPoint=t,this.inTangent=i,this.outTangent=n}return J(e,[{key:"lerp",value:function(e,t,i){var n=this.dataPoint,r=e.dataPoint,a=t*t*t,o=t*t;return n*(2*a-3*o+1)+this.outTangent*i*(a-2*o+t)+r*(-2*a+3*o)+e.inTangent*i*(a-o)}},{key:"getNoLerp",value:function(){return this.dataPoint}}]),e}()).prototype,"dataPoint",[Ko],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return 0}}),hM=de(uM.prototype,"inTangent",[Ko],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return 0}}),pM=de(uM.prototype,"outTangent",[Ko],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return 0}}),lM=uM))||lM;cc.CubicSplineNumberValue=xM;var bM=Object.freeze({__proto__:null,UniformProxyFactory:sM,MorphWeightsValueProxy:_M,MorphWeightsAllValueProxy:fM,isPropertyPath:wE,isCustomPath:CE,HierarchyPath:AE,ComponentPath:OE,evaluatePath:kE,CubicSplineVec2Value:mM,CubicSplineVec3Value:vM,CubicSplineVec4Value:yM,CubicSplineQuatValue:gM,CubicSplineNumberValue:xM});function TM(e,t){for(var i=0,n=e.length-1,r=n>>>1;i<=n;r=i+n>>>1){var a=e[r];if(a>t+1e-6)n=r-1;else{if(!(a<t-1e-6))return r;i=r+1}}return~i}function SM(e,t,i,n,r){var a=1-r;return e*a*a*a+3*t*a*a*r+3*i*a*r*r+n*r*r*r}cc.bezier=SM;var EM=Math.cos,wM=Math.acos,CM=Math.max,AM=2*Math.PI,OM=Math.sqrt;function kM(e){return e<0?-Math.pow(-e,1/3):Math.pow(e,1/3)}function RM(e,t){var i=function(e,t){var i,n,r,a,o=t-0,s=t-e[0],l=3*o,u=3*s,c=3*(t-e[2]),h=1/(-o+u-c+(t-1)),p=(l-6*s+c)*h,_=p*(1/3),f=(-l+u)*h,d=1/3*(3*f-p*p),m=d*(1/3),v=(2*p*p*p-9*p*f+27*(o*h))/27,y=v/2,g=y*y+m*m*m;if(g<0){var x=1/3*-d,b=OM(x*x*x),T=-v/(2*b),S=wM(T<-1?-1:T>1?1:T),E=2*kM(b);return n=E*EM(S*(1/3))-_,r=E*EM((S+AM)*(1/3))-_,a=E*EM((S+2*AM)*(1/3))-_,0<=n&&n<=1?0<=r&&r<=1?0<=a&&a<=1?CM(n,r,a):CM(n,r):0<=a&&a<=1?CM(n,a):n:0<=r&&r<=1?0<=a&&a<=1?CM(r,a):r:a}if(0===g)return r=-(i=y<0?kM(-y):-kM(y))-_,0<=(n=2*i-_)&&n<=1?0<=r&&r<=1?CM(n,r):n:r;var w=OM(g);return n=(i=kM(-y+w))-kM(y+w)-_}(e,t),n=1-i;return 0*n*n*n+3*e[1]*i*n*n+3*e[3]*i*i*n+1*i*i*i}function FM(e){return e*e}function MM(e){return e*(2-e)}function IM(e){return e*e*e}function PM(e){return--e*e*e+1}function LM(e){return e*e*e*e}function DM(e){return 1- --e*e*e*e}function NM(e){return e*e*e*e*e}function zM(e){return--e*e*e*e*e+1}function BM(e){return 1-Math.cos(e*Math.PI/2)}function GM(e){return Math.sin(e*Math.PI/2)}function UM(e){return 0===e?0:Math.pow(1024,e-1)}function XM(e){return 1===e?1:1-Math.pow(2,-10*e)}function VM(e){return 1-Math.sqrt(1-e*e)}function HM(e){return Math.sqrt(1- --e*e)}function WM(e){var t,i=.1;return 0===e?0:1===e?1:(!i||i<1?(i=1,t=.1):t=.4*Math.asin(1/i)/(2*Math.PI),-i*Math.pow(2,10*(e-=1))*Math.sin((e-t)*(2*Math.PI)/.4))}function jM(e){var t,i=.1;return 0===e?0:1===e?1:(!i||i<1?(i=1,t=.1):t=.4*Math.asin(1/i)/(2*Math.PI),i*Math.pow(2,-10*e)*Math.sin((e-t)*(2*Math.PI)/.4)+1)}function qM(e){var t=1.70158;return e*e*((t+1)*e-t)}function YM(e){var t=1.70158;return--e*e*((t+1)*e+t)+1}function KM(e){return 1-ZM(1-e)}function ZM(e){return e<1/2.75?7.5625*e*e:e<2/2.75?7.5625*(e-=1.5/2.75)*e+.75:e<2.5/2.75?7.5625*(e-=2.25/2.75)*e+.9375:7.5625*(e-=2.625/2.75)*e+.984375}cc.bezierByTime=RM;var QM=sI(FM,MM),JM=sI(IM,PM),$M=sI(LM,DM),eI=sI(NM,zM),tI=sI(BM,GM),iI=sI(UM,XM),nI=sI(VM,HM),rI=sI(WM,jM),aI=sI(qM,YM),oI=sI(KM,ZM);function sI(e,t){return function(i){return i<.5?t(2*i)/2:e(2*i-1)/2+.5}}var lI,uI,cI=Object.freeze({__proto__:null,constant:function(){return 0},linear:function(e){return e},quadIn:FM,quadOut:MM,quadInOut:function(e){return(e*=2)<1?.5*e*e:-.5*(--e*(e-2)-1)},cubicIn:IM,cubicOut:PM,cubicInOut:function(e){return(e*=2)<1?.5*e*e*e:.5*((e-=2)*e*e+2)},quartIn:LM,quartOut:DM,quartInOut:function(e){return(e*=2)<1?.5*e*e*e*e:-.5*((e-=2)*e*e*e-2)},quintIn:NM,quintOut:zM,quintInOut:function(e){return(e*=2)<1?.5*e*e*e*e*e:.5*((e-=2)*e*e*e*e+2)},sineIn:BM,sineOut:GM,sineInOut:function(e){return.5*(1-Math.cos(Math.PI*e))},expoIn:UM,expoOut:XM,expoInOut:function(e){return 0===e?0:1===e?1:(e*=2)<1?.5*Math.pow(1024,e-1):.5*(2-Math.pow(2,-10*(e-1)))},circIn:VM,circOut:HM,circInOut:function(e){return(e*=2)<1?-.5*(Math.sqrt(1-e*e)-1):.5*(Math.sqrt(1-(e-=2)*e)+1)},elasticIn:WM,elasticOut:jM,elasticInOut:function(e){var t,i=.1,n=.4;return 0===e?0:1===e?1:(!i||i<1?(i=1,t=.1):t=n*Math.asin(1/i)/(2*Math.PI),(e*=2)<1?i*Math.pow(2,10*(e-=1))*Math.sin((e-t)*(2*Math.PI)/n)*-.5:i*Math.pow(2,-10*(e-=1))*Math.sin((e-t)*(2*Math.PI)/n)*.5+1)},backIn:qM,backOut:YM,backInOut:function(e){var t=2.5949095;return(e*=2)<1?e*e*((t+1)*e-t)*.5:.5*((e-=2)*e*((t+1)*e+t)+2)},bounceIn:KM,bounceOut:ZM,bounceInOut:function(e){return e<.5?.5*KM(2*e):.5*ZM(2*e-1)+.5},smooth:function(e){return e<=0?0:e>=1?1:e*e*(3-2*e)},fade:function(e){return e<=0?0:e>=1?1:e*e*e*(e*(6*e-15)+10)},quadOutIn:QM,cubicOutIn:JM,quartOutIn:$M,quintOutIn:eI,sineOutIn:tI,expoOutIn:iI,circOutIn:nI,elasticOutIn:rI,backOutIn:aI,bounceOutIn:oI});!function(e){e[e.Loop=2]="Loop",e[e.ShouldWrap=4]="ShouldWrap",e[e.PingPong=22]="PingPong",e[e.Reverse=36]="Reverse"}(lI||(lI={})),function(e){e[e.Default=0]="Default",e[e.Normal=1]="Normal",e[e.Reverse=lI.Reverse]="Reverse",e[e.Loop=lI.Loop]="Loop",e[e.LoopReverse=lI.Loop|lI.Reverse]="LoopReverse",e[e.PingPong=lI.PingPong]="PingPong",e[e.PingPongReverse=lI.PingPong|lI.Reverse]="PingPongReverse"}(uI||(uI={})),bt(uI);var hI=function(){function e(t){Z(this,e),this.ratio=0,this.time=0,this.direction=1,this.stopped=!0,this.iterations=0,this.frameIndex=void 0,t&&this.set(t)}return J(e,[{key:"set",value:function(e){this.ratio=e.ratio,this.time=e.time,this.direction=e.direction,this.stopped=e.stopped,this.iterations=e.iterations,this.frameIndex=e.frameIndex}}]),e}();var pI=function(){function e(t){var i,n;Z(this,e),this.ratios=void 0,this._findRatio=void 0,this.ratios=t;for(var r=!0,a=1,o=t.length;a<o;a++)if(i=t[a]-t[a-1],1===a)n=i;else if(Math.abs(i-n)>1e-6){r=!1;break}this._findRatio=r?vI:TM}return J(e,[{key:"sample",value:function(e){return this._findRatio(this.ratios,e)}}]),e}();cc.RatioSampler=pI;var _I=function(){function e(t,i){Z(this,e),this.types=void 0,this.type=null,this._values=[],this._lerp=void 0,this._duration=void 0,this._array=void 0,this._duration=i,this._values=t.values;var n=function(t){return"string"==typeof t?t:Array.isArray(t)?t[0]===t[1]&&t[2]===t[3]?e.Linear:e.Bezier(t):e.Linear};if(void 0!==t.easingMethod)this.type=n(t.easingMethod);else if(Array.isArray(t.easingMethods))this.types=t.easingMethods.map(n);else if(void 0!==t.easingMethods){this.types=new Array(this._values.length).fill(null);for(var r=0,a=Object.keys(t.easingMethods);r<a.length;r++){var o=a[r];this.types[o]=n(t.easingMethods[o])}}else this.type=null;var s=t.values[0];(void 0===t.interpolate||t.interpolate)&&(this._lerp=PI(s)),void 0!==t._arrayLength&&(this._array=new Array(t._arrayLength))}return J(e,null,[{key:"Bezier",value:function(e){return e}}]),J(e,[{key:"hasLerp",value:function(){return!!this._lerp}},{key:"valueAt",value:function(e){if(void 0===this._array){var t=this._values[e];return t&&t.getNoLerp?t.getNoLerp():t}for(var i=0;i<this._array.length;++i)this._array[i]=this._values[this._array.length*e+i];return this._array}},{key:"valueBetween",value:function(e,t,i,n,r){if(this._lerp){var a=this.types?this.types[t]:this.type,o=r-i,s=(e-i)/o;if(a&&(s=mI(s,a)),void 0===this._array){var l=this._values[t],u=this._values[n];return this._lerp(l,u,s,o*this._duration)}for(var c=0;c<this._array.length;++c){var h=this._values[this._array.length*t+c],p=this._values[this._array.length*n+c];this._array[c]=this._lerp(h,p,s,o*this._duration)}return this._array}if(void 0===this._array)return this.valueAt(t);for(var _=0;_<this._array.length;++_)this._array[_]=this._values[this._array.length*t+_];return this._array}},{key:"empty",value:function(){return 0===this._values.length}},{key:"constant",value:function(){return 1===this._values.length}}]),e}();_I.Linear=null,cc.AnimCurve=_I;var fI=function(){function e(){Z(this,e),this.events=[]}return J(e,[{key:"add",value:function(e,t){this.events.push({func:e||"",params:t||[]})}}]),e}();function dI(e,t,i){var n=t.sample(i);if(n<0)if((n=~n)<=0)n=0;else{if(!(n>=t.ratios.length))return e.valueBetween(i,n-1,t.ratios[n-1],n,t.ratios[n]);n=t.ratios.length-1}return e.valueAt(n)}function mI(e,t){if("string"==typeof t){var i=cI[t];i?e=i(e):b(3906,t)}else Array.isArray(t)&&(e=RM(t,e));return e}function vI(e,t){var i=e.length-1;if(0===i)return 0;var n=e[0];if(t<n)return 0;var r=e[i];if(t>r)return i;var a=(t=(t-n)/(r-n))/(1/i),o=0|a;return a-o<1e-6?o:o+1-a<1e-6?o+1:~(o+1)}cc.sampleAnimationCurve=dI;var yI,gI,xI,bI,TI,SI,EI,wI,CI,AI,OI,kI,RI,FI,MI,II,PI=function(){function e(e,t,i,n){return e.lerp(t,i,n)}return function(t){if(null!==t){if("number"==typeof t)return fi;if("object"===K(t)&&t.constructor){if(t instanceof Xi)return i=new Xi,function(e,t,n,r){return Xi.slerp(i,e,t,n)};if(t instanceof Tt)return function(e){var t=new e;return function(i,n,r){return e.lerp(t,i,n,r),t}}(t.constructor);if(t.constructor===Number)return fi;if("function"==typeof t.lerp)return e}var i}}}();function LI(e,t,i){var n,r=t[t.length-1];if(0!==t.length&&wE(r)&&!i){var a=kE.apply(void 0,[e].concat(ce(t.slice(0,t.length-1))));if(null===a)return null;n={isProxy:!1,object:a,property:r}}else{if(!i)return h("Empty animation curve."),null;var o=kE.apply(void 0,[e].concat(ce(t)));if(null===o)return null;n={isProxy:!0,proxy:i.forTarget(o)}}return{setValue:function(e){n.isProxy?n.proxy.set(e):n.object[n.property]=e},getValue:function(){return n.isProxy?n.proxy.get?n.proxy.get():(h("Target doesn't provide a get method."),null):n.object[n.property]}}}function DI(e,t,i){var n=LI(e,t,i);if(null===n)return null;var r=n.getValue(),a=zI(r);if(!a)return h("Value is not copyable!"),null;var o=a.createBuffer(),s=a.copy;return Object.assign(n,{peek:function(){return o},pull:function(){var e=n.getValue();s(o,e)},push:function(){n.setValue(o)}})}exports.AnimationClip=(yI=Yo("cc.AnimationClip"),gI=Ko({visible:!1}),yI((II=MI=function(e){function t(){var e,i;Z(this,t);for(var n=arguments.length,r=new Array(n),a=0;a<n;a++)r[a]=arguments[a];return fe(i=re(this,(e=te(t)).call.apply(e,[this].concat(r))),"sample",TI,ne(i)),fe(i,"speed",SI,ne(i)),fe(i,"wrapMode",EI,ne(i)),fe(i,"events",wI,ne(i)),fe(i,"_duration",CI,ne(i)),fe(i,"_keys",AI,ne(i)),fe(i,"_stepness",OI,ne(i)),fe(i,"_curves",kI,ne(i)),fe(i,"_commonTargets",RI,ne(i)),fe(i,"_hash",FI,ne(i)),i.frameRate=0,i._ratioSamplers=[],i._runtimeCurves=void 0,i._runtimeEvents=void 0,i._data=null,i}return ee(t,zl),J(t,[{key:"onLoaded",value:function(){this.frameRate=this.sample,this._decodeCVTAs()}},{key:"getPropertyCurves",value:function(){return this._runtimeCurves||this._createPropertyCurves(),this._runtimeCurves}},{key:"updateEventDatas",value:function(){delete this._runtimeEvents}},{key:"getEventGroupIndexAtRatio",value:function(e){return this._runtimeEvents||this._createRuntimeEvents(),function(e,t){for(var i=0,n=e.length-1,r=n>>>1;i<=n;r=i+n>>>1){var a=e[r];if(a>t+1e-6)n=r-1;else{if(!(a<t-1e-6))return r;i=r+1}}return~i}(this._runtimeEvents.ratios,e)}},{key:"hasEvents",value:function(){return 0!==this.events.length}},{key:"destroy",value:function(){return cc.director.root.dataPoolManager.releaseAnimationClip(this),RE.destroy(this),oe(te(t.prototype),"destroy",this).call(this)}},{key:"_createPropertyCurves",value:function(){var e=this;this._ratioSamplers=this._keys.map((function(t){return new pI(t.map((function(t){return t/e._duration})))})),this._runtimeCurves=this._curves.map((function(t){return{curve:new _I(t.data,e._duration),modifiers:t.modifiers,valueAdapter:t.valueAdapter,sampler:e._ratioSamplers[t.data.keys],commonTarget:t.commonTarget}})),this._applyStepness()}},{key:"_createRuntimeEvents",value:function(){for(var e,t=this,i=[],n=[],r=function(){var r=e.value,a=r.frame/t._duration,o=i.findIndex((function(e){return e===a}));o<0&&(o=i.length,i.push(a),n.push({events:[]})),n[o].events.push({functionName:r.func,parameters:r.params})},a=_e(this.events.sort((function(e,t){return e.frame-t.frame})));!(e=a()).done;)r();this._runtimeEvents={ratios:i,eventGroups:n}}},{key:"_applyStepness",value:function(){this._runtimeCurves}},{key:"_decodeCVTAs",value:function(){var e=ArrayBuffer.isView(this._nativeAsset)?this._nativeAsset.buffer:this._nativeAsset;if(e){for(var t=this._keys,i=0;i<t.length;++i){var n=t[i];n instanceof N_&&(t[i]=n.decompress(e))}for(var r=0;r<this._curves.length;++r){var a=this._curves[r];a.data.values instanceof N_&&(a.data.values=a.data.values.decompress(e))}}}},{key:"duration",get:function(){return this._duration},set:function(e){this._duration=e}},{key:"keys",get:function(){return this._keys},set:function(e){this._keys=e}},{key:"eventGroups",get:function(){return this._runtimeEvents||this._createRuntimeEvents(),this._runtimeEvents.eventGroups}},{key:"stepness",get:function(){return this._stepness},set:function(e){this._stepness=e,this._applyStepness()}},{key:"hash",get:function(){if(this._hash)return this._hash;var e=this._nativeAsset,t=new Uint8Array(ArrayBuffer.isView(e)?e.buffer:e);return this._hash=rl(t,666)}},{key:"curves",get:function(){return this._curves},set:function(e){this._curves=e,delete this._runtimeCurves}},{key:"data",get:function(){return this._data}},{key:"commonTargets",get:function(){return this._commonTargets},set:function(e){this._commonTargets=e}}],[{key:"createWithSpriteFrames",value:function(e,i){if(!Array.isArray(e))return b(3905),null;var n=new t;n.sample=i||n.sample,n.duration=e.length/n.sample;for(var r=1/n.sample,a=new Array(e.length),o=new Array(a.length),s=0;s<e.length;s++)a[s]=s*r,o[s]=e[s];return n.keys=[a],n.curves=[{modifiers:[new OE("cc.SpriteComponent"),"spriteFrame"],data:{keys:0,values:o}}],n}}]),t}(),MI.preventDeferredLoadDependents=!0,MI.WrapMode=uI,TI=de((bI=II).prototype,"sample",[Ko],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return 60}}),SI=de(bI.prototype,"speed",[Ko],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return 1}}),EI=de(bI.prototype,"wrapMode",[Ko],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return uI.Normal}}),wI=de(bI.prototype,"events",[gI],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return[]}}),CI=de(bI.prototype,"_duration",[Ko],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return 0}}),AI=de(bI.prototype,"_keys",[Ko],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return[]}}),OI=de(bI.prototype,"_stepness",[Ko],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return 0}}),kI=de(bI.prototype,"_curves",[Ko],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return[]}}),RI=de(bI.prototype,"_commonTargets",[Ko],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return[]}}),FI=de(bI.prototype,"_hash",[Ko],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return 0}}),xI=bI))||xI),exports.AnimationClip||(exports.AnimationClip={}),cc.AnimationClip=exports.AnimationClip;var NI,zI=((NI=new Map).set(ki,{createBuffer:function(){return new ki},copy:ki.copy}),NI.set(Ii,{createBuffer:function(){return new Ii},copy:Ii.copy}),NI.set(Ni,{createBuffer:function(){return new Ni},copy:Ni.copy}),NI.set(an,{createBuffer:function(){return new an},copy:an.copy}),function(e){return NI.get(null==e?void 0:e.constructor)}),BI=function(){function e(){Z(this,e),this._isPlaying=!1,this._isPaused=!1,this._stepOnce=!1}return J(e,[{key:"play",value:function(){this._isPlaying?this._isPaused?(this._isPaused=!1,this.onResume()):this.onError(w(3912)):(this._isPlaying=!0,this.onPlay())}},{key:"stop",value:function(){this._isPlaying&&(this._isPlaying=!1,this.onStop(),this._isPaused=!1)}},{key:"pause",value:function(){this._isPlaying&&!this._isPaused&&(this._isPaused=!0,this.onPause())}},{key:"resume",value:function(){this._isPlaying&&this._isPaused&&(this._isPaused=!1,this.onResume())}},{key:"step",value:function(){this.pause(),this._stepOnce=!0,this._isPlaying||this.play()}},{key:"update",value:function(e){}},{key:"onPlay",value:function(){}},{key:"onPause",value:function(){}},{key:"onResume",value:function(){}},{key:"onStop",value:function(){}},{key:"onError",value:function(e){}},{key:"isPlaying",get:function(){return this._isPlaying}},{key:"isPaused",get:function(){return this._isPaused}},{key:"isMotionless",get:function(){return!this.isPlaying||this.isPaused}}]),e}(),GI=function(){function e(){Z(this,e),this._nodeBlendStates=new Map}return J(e,[{key:"ref",value:function(e,t){var i=this._nodeBlendStates.get(e);i||(i={dirty:!1,properties:{}},this._nodeBlendStates.set(e,i));var n=i.properties[t];return n||(n=i.properties[t]=new VI(i,UI(t)?new Ii:new Xi)),++n.refCount,n}},{key:"deRef",value:function(e,t){var i=this._nodeBlendStates.get(e);if(i){var n=i.properties[t];n&&(--n.refCount,n.refCount>0||(delete i.properties[t],function(e){return!(e.properties.position||e.properties.rotation||e.properties.eulerAngles||e.properties.scale)}(i)&&this._nodeBlendStates.delete(e)))}}},{key:"apply",value:function(){this._nodeBlendStates.forEach((function(e,t){if(e.dirty){e.dirty=!1;var i,n,r,a=e.properties,o=a.position,s=a.scale,l=a.rotation,u=a.eulerAngles,c=!1;o&&0!==o.weight&&(o.weight=0,i=o.value,c=!0),s&&0!==s.weight&&(s.weight=0,n=s.value,c=!0),l&&0!==l.weight&&(l.weight=0,r=l.value,c=!0),u&&0!==u.weight&&(u.weight=0,r=u.value,c=!0),c&&t.setRTS(r,i,n)}}))}}]),e}();function UI(e){return!function(e){return"rotation"===e}(e)}var XI,VI=function(){function e(t,i){Z(this,e),this.weight=0,this.value=void 0,this.refCount=0,this._node=void 0,this._node=t,this.value=i}return J(e,[{key:"markAsDirty",value:function(){this._node.dirty=!0}}]),e}();function HI(e,t,i){return 0===i.weight&&Ii.zero(i.value),0===t?i.value:1===t?Ii.copy(i.value,e):Ii.scaleAndAdd(i.value,i.value,e,t)}function WI(e,t,i){if(0===i.weight&&Xi.identity(i.value),0===t)return i.value;if(1===t)return Xi.copy(i.value,e);var n=t/(i.weight+t);return Xi.slerp(i.value,i.value,e,n)}!function(e){e.PLAY="play",e.STOP="stop",e.PAUSE="pause",e.RESUME="resume",e.LASTFRAME="lastframe",e.FINISHED="finished"}(XI||(XI={})),bt(XI);var jI=function(){function e(t,i,n){Z(this,e),this.commonTargetIndex=void 0,this._curve=void 0,this._boundTarget=void 0,this._rootTargetProperty=void 0,this._curveDetail=void 0,this._curve=t.curve,this._curveDetail=t,this._boundTarget=n}return J(e,[{key:"applySample",value:function(e,t,i,n,r){var a;this._curve.empty()||(a=this._curve.hasLerp()&&i?this._curve.valueBetween(e,n.from,n.fromRatio,n.to,n.toRatio):this._curve.valueAt(t),this._setValue(a,r))}},{key:"_setValue",value:function(e,t){this._boundTarget.setValue(e)}},{key:"propertyName",get:function(){return this._rootTargetProperty||""}},{key:"curveDetail",get:function(){return this._curveDetail}}]),e}();var qI=function(e){function t(e){var i,n=arguments.length>1&&void 0!==arguments[1]?arguments[1]:"";return Z(this,t),(i=re(this,te(t).call(this))).duration=1,i.speed=1,i.time=0,i.weight=0,i.frameRate=0,i._wrapMode=uI.Normal,i._repeatCount=1,i._currentFramePlayed=!1,i._delay=0,i._delayTime=0,i._wrappedInfo=new hI,i._lastWrapInfo=null,i._lastWrapInfoEvent=null,i._process=i.process,i._target=null,i._targetNode=null,i._clip=void 0,i._name=void 0,i._lastIterations=void 0,i._samplerSharedGroups=[],i._commonTargetStatuses=[],i._curveLoaded=!1,i._ignoreIndex=-1,i._blendStateBuffer=null,i._blendStateWriters=[],i._allowLastFrame=!1,i._clip=e,i._name=n||e&&e.name,i}return ee(t,BI),J(t,[{key:"clip",get:function(){return this._clip}},{key:"name",get:function(){return this._name}},{key:"length",get:function(){return this.duration}},{key:"wrapMode",get:function(){return this._wrapMode},set:function(e){this._wrapMode=e,this.time=0,e&lI.Loop?this.repeatCount=1/0:this.repeatCount=1}},{key:"repeatCount",get:function(){return this._repeatCount},set:function(e){this._repeatCount=e;var t=this._wrapMode&lI.ShouldWrap,i=(this.wrapMode&lI.Reverse)===lI.Reverse;this._process=e!==1/0||t||i?this.process:this.simpleProcess}},{key:"delay",get:function(){return this._delay},set:function(e){this._delayTime=this._delay=e}}]),J(t,[{key:"initialize",value:function(e,t){var i,n,r=this;if(!this._curveLoaded){this._curveLoaded=!0,this._destroyBlendStateWriters(),this._samplerSharedGroups.length=0,this._blendStateBuffer=null!==(i=null===(n=cc.director.getAnimationManager())||void 0===n?void 0:n.blendState)&&void 0!==i?i:null,this._targetNode=e;var a=this._clip;this.duration=a.duration,this.speed=a.speed,this.wrapMode=a.wrapMode,this.frameRate=a.sample,(this.wrapMode&lI.Loop)===lI.Loop?this.repeatCount=1/0:this.repeatCount=1;var o=function(e,t,i,n,a){if(!function(e){var t;if(1===e.length&&"string"==typeof e[0])t=e[0];else if(e.length>1){for(var i=0;i<e.length-1;++i)if(!(e[i]instanceof AE))return!1;t=e[e.length-1]}switch(t){case"position":case"scale":case"rotation":case"eulerAngles":return!0;default:return!1}}(i)||!r._blendStateBuffer)return e(t,i,n);var o=kE.apply(void 0,[t].concat(ce(i.slice(0,i.length-1))));if(null!==o&&o instanceof tg){var s=i[i.length-1],l=function(e,t,i,n,r){var a=UI(i)?HI:WI,o=e.ref(t,i),s=!1,l=-1;return{destroy:function(){o&&(e.deRef(t,i),o=null)},forTarget:function(){return{get:function(){return t[i]},set:function(e){if(o){var t=n.weight;if(r)if(1!==t||t!==l)s=!1;else if(s)return;a(e,t,o),o.weight+=t,o.markAsDirty(),s=!0,l=t}}}}}}(r._blendStateBuffer,o,s,r,a);return r._blendStateWriters.push(l),e(t,[],l)}return null};this._commonTargetStatuses=a.commonTargets.map((function(t,i){var n=o(DI,e,t.modifiers,t.valueAdapter,!1);return null===n?null:{target:n,changed:!1}})),t||(t=a.getPropertyCurves());for(var s=function(i){var n=t[i],a=r._samplerSharedGroups.find((function(e){return e.sampler===n.sampler}));a||(a={sampler:n.sampler,curves:[],samplerResultCache:{from:0,fromRatio:0,to:0,toRatio:0}},r._samplerSharedGroups.push(a));var s=void 0;if(void 0===n.commonTarget)s=e;else{var l=r._commonTargetStatuses[n.commonTarget];if(!l)return"continue";s=l.target.peek()}var u=o(LI,s,n.modifiers,n.valueAdapter,n.curve.constant());if(null===u);else{var c=new jI(n,s,u);c.commonTargetIndex=n.commonTarget,a.curves.push(c)}},l=0;l<t.length;++l)s(l)}}},{key:"destroy",value:function(){this._destroyBlendStateWriters()}},{key:"emit",value:function(){for(var e=arguments.length,t=new Array(e),i=0;i<e;i++)t[i]=arguments[i];cc.director.getAnimationManager().pushDelayEvent(this._emit,this,t)}},{key:"on",value:function(e,t,i){return this._target&&this._target.isValid?this._target.on(e,t,i):null}},{key:"once",value:function(e,t,i){return this._target&&this._target.isValid?this._target.once(e,t,i):null}},{key:"off",value:function(e,t,i){this._target&&this._target.isValid&&this._target.off(e,t,i)}},{key:"allowLastFrameEvent",value:function(e){this._allowLastFrame=e}},{key:"_setEventTarget",value:function(e){this._target=e}},{key:"setTime",value:function(e){this._currentFramePlayed=!1,this.time=e||0,this._lastWrapInfoEvent=null,this._ignoreIndex=-1;var t=this.getWrappedInfo(e,this._wrappedInfo),i=t.direction,n=this._clip.getEventGroupIndexAtRatio(t.ratio);n<0&&(n=~n-1,i<0&&(n+=1),this._ignoreIndex=n)}},{key:"update",value:function(e){this._delayTime>0&&(this._delayTime-=e,this._delayTime>0)||(this._currentFramePlayed?this.time+=e*this.speed:this._currentFramePlayed=!0,this._process())}},{key:"_needReverse",value:function(e){var t=this.wrapMode,i=!1;(t&lI.PingPong)===lI.PingPong&&(e-(0|e)==0&&e>0&&(e-=1),1&e&&(i=!i));return(t&lI.Reverse)===lI.Reverse&&(i=!i),i}},{key:"getWrappedInfo",value:function(e,t){t=t||new hI;var i=!1,n=this.duration,r=this.repeatCount,a=e>0?e/n:-e/n;if(a>=r){a=r,i=!0;var o=r-(0|r);0===o&&(o=1),e=o*n*(e>0?1:-1)}if(e>n){var s=e%n;e=0===s?n:s}else e<0&&0!==(e%=n)&&(e+=n);var l=!1,u=this._wrapMode&lI.ShouldWrap;u&&(l=this._needReverse(a));var c=l?-1:1;return this.speed<0&&(c*=-1),u&&l&&(e=n-e),t.ratio=e/n,t.time=e,t.direction=c,t.stopped=i,t.iterations=a,t}},{key:"sample",value:function(){var e=this.getWrappedInfo(this.time,this._wrappedInfo);return this._sampleCurves(e.ratio),this._sampleEvents(e),e}},{key:"process",value:function(){var e,t=this.sample();this._allowLastFrame&&(e=this._lastWrapInfo?this._lastWrapInfo:this._lastWrapInfo=new hI(t),this.repeatCount>1&&(0|t.iterations)>(0|e.iterations)&&this.emit(XI.LASTFRAME,this),e.set(t));t.stopped&&(this.stop(),this.emit(XI.FINISHED,this))}},{key:"simpleProcess",value:function(){var e=this.duration,t=this.time%e;t<0&&(t+=e);var i=t/e;this._sampleCurves(i),this._clip.hasEvents()&&this._sampleEvents(this.getWrappedInfo(this.time,this._wrappedInfo)),this._allowLastFrame&&(void 0===this._lastIterations&&(this._lastIterations=i),(this.time>0&&this._lastIterations>i||this.time<0&&this._lastIterations<i)&&this.emit(XI.LASTFRAME,this),this._lastIterations=i)}},{key:"cache",value:function(e){}},{key:"onPlay",value:function(){this.setTime(0),this._delayTime=this._delay,this._onReplayOrResume(),this.emit(XI.PLAY,this)}},{key:"onStop",value:function(){this.isPaused||this._onPauseOrStop(),this.emit(XI.STOP,this)}},{key:"onResume",value:function(){this._onReplayOrResume(),this.emit(XI.RESUME,this)}},{key:"onPause",value:function(){this._onPauseOrStop(),this.emit(XI.PAUSE,this)}},{key:"_sampleCurves",value:function(e){for(var t=0;t<this._commonTargetStatuses.length;++t){var i=this._commonTargetStatuses[t];i&&(i.target.pull(),i.changed=!1)}for(var n=0,r=this._samplerSharedGroups.length;n<r;++n){var a=this._samplerSharedGroups[n],o=a.sampler,s=a.samplerResultCache,l=0,u=!1;o?(l=o.sample(e))<0&&((l=~l)<=0?l=0:l>=o.ratios.length?l=o.ratios.length-1:(u=!0,s.from=l-1,s.fromRatio=o.ratios[s.from],s.to=l,s.toRatio=o.ratios[s.to],l=s.from)):l=0;for(var c=0,h=a.curves.length;c<h;++c){var p=a.curves[c];if(p.applySample(e,l,u,s,this.weight),void 0!==p.commonTargetIndex){var _=this._commonTargetStatuses[p.commonTargetIndex];_&&(_.changed=!0)}}}for(var f=0;f<this._commonTargetStatuses.length;++f){var d=this._commonTargetStatuses[f];d&&(d.changed&&d.target.push())}}},{key:"_sampleEvents",value:function(e){var t=this._clip.eventGroups.length,i=e.direction,n=this._clip.getEventGroupIndexAtRatio(e.ratio);if(n<0&&(n=~n-1,i<0&&(n+=1)),this._ignoreIndex!==n&&(this._ignoreIndex=-1),e.frameIndex=n,!this._lastWrapInfoEvent)return this._fireEvent(n),void(this._lastWrapInfoEvent=new hI(e));var r=this.wrapMode,a=YI(e.iterations),o=this._lastWrapInfoEvent,s=YI(o.iterations),l=o.frameIndex,u=o.direction,c=-1!==s&&a!==s;if(l===n&&c&&1===t)this._fireEvent(0);else if(l!==n||c){i=u;do{if(l!==n){if(-1===i&&0===l&&n>0?((r&lI.PingPong)===lI.PingPong?i*=-1:l=t,s++):1===i&&l===t-1&&n<t-1&&((r&lI.PingPong)===lI.PingPong?i*=-1:l=-1,s++),l===n)break;if(s>a)break}l+=i,cc.director.getAnimationManager().pushDelayEvent(this._fireEvent,this,[l])}while(l!==n&&l>-1&&l<t)}this._lastWrapInfoEvent.set(e)}},{key:"_emit",value:function(e,t){this._target&&this._target.isValid&&this._target.emit(e,e,t)}},{key:"_fireEvent",value:function(e){if(this._targetNode&&this._targetNode.isValid){var t=this._clip.eventGroups;if(!(e<0||e>=t.length||this._ignoreIndex===e))for(var i,n=t[e],r=this._targetNode.components,a=_e(n.events);!(i=a()).done;)for(var o,s=i.value,l=s.functionName,u=_e(r);!(o=u()).done;){var c=o.value,h=c[l];"function"==typeof h&&h.apply(c,s.parameters)}}}},{key:"_onReplayOrResume",value:function(){cc.director.getAnimationManager().addAnimation(this)}},{key:"_onPauseOrStop",value:function(){cc.director.getAnimationManager().removeAnimation(this)}},{key:"_destroyBlendStateWriters",value:function(){for(var e=0;e<this._blendStateWriters.length;++e)this._blendStateWriters[e].destroy();this._blendStateWriters.length=0}},{key:"curveLoaded",get:function(){return this._curveLoaded}}]),t}();function YI(e){return e-(0|e)==0&&(e-=1),0|e}cc.AnimationState=qI;var KI,ZI,QI,JI,$I,eP,tP,iP,nP,rP,aP,oP,sP,lP,uP,cP,hP,pP,_P=function(e){function t(){var e;return Z(this,t),(e=re(this,te(t).call(this)))._managedStates=[],e._fadings=[],e}return ee(t,BI),J(t,[{key:"update",value:function(e){if(!this.isMotionless){for(var t=0;t<this._managedStates.length;++t){var i=this._managedStates[t].state;i&&(i.weight=0)}for(var n=1,r=this._fadings.length,a=0;a<this._fadings.length;++a){var o=this._fadings[a];o.easeTime+=e;var s=0===o.easeDuration?1:_i(o.easeTime/o.easeDuration),l=s*n;if(n*=1-s,o.target.state&&(o.target.state.weight+=l),o.easeTime>=o.easeDuration){r=a+1,o.easeTime=o.easeDuration;break}}if(r!==this._fadings.length){for(var u=r;u<this._fadings.length;++u){var c=this._fadings[u];--c.target.reference,c.target.reference<=0&&(c.target.state&&c.target.state.stop(),ye(this._managedStates,c.target))}this._fadings.splice(r)}for(var h=0;h<this._managedStates.length;++h){var p=this._managedStates[h].state;p&&p.isMotionless&&p.sample()}}}},{key:"crossFade",value:function(e,t){var i;0===this._managedStates.length&&(t=0),0===t&&this.clear();var n=this._managedStates.find((function(t){return t.state===e}));n?(null===(i=n.state)||void 0===i?void 0:i.isMotionless)&&n.state.play():(n={state:e,reference:0},e&&e.play(),this._managedStates.push(n)),++n.reference,this._fadings.unshift({easeDuration:t,easeTime:0,target:n})}},{key:"clear",value:function(){for(var e=0;e<this._managedStates.length;++e){var t=this._managedStates[e].state;t&&t.stop()}this._managedStates.length=0,this._fadings.length=0}},{key:"onPlay",value:function(){oe(te(t.prototype),"onPlay",this).call(this),cc.director.getAnimationManager().addCrossFade(this)}},{key:"onPause",value:function(){oe(te(t.prototype),"onPause",this).call(this),cc.director.getAnimationManager().removeCrossFade(this);for(var e=0;e<this._managedStates.length;++e){var i=this._managedStates[e].state;i&&i.pause()}}},{key:"onResume",value:function(){oe(te(t.prototype),"onResume",this).call(this),cc.director.getAnimationManager().addCrossFade(this);for(var e=0;e<this._managedStates.length;++e){var i=this._managedStates[e].state;i&&i.resume()}}},{key:"onStop",value:function(){oe(te(t.prototype),"onStop",this).call(this),cc.director.getAnimationManager().removeCrossFade(this),this.clear()}}]),t}();function fP(e,t){return e===t||!(!e||!t||e.name!==t.name&&e._uuid!==t._uuid)}exports.AnimationComponent=(KI=Yo("cc.AnimationComponent"),ZI=os("i18n:cc.AnimationComponent"),QI=ts(99),JI=es("Components/Animation"),$I=Ko({type:[exports.AnimationClip],tooltip:"此动画组件管理的动画剪辑"}),eP=Ko({type:exports.AnimationClip,tooltip:"默认动画剪辑"}),tP=Ko({tooltip:"是否在动画组件开始运行时自动播放默认动画剪辑"}),iP=Ko({type:[exports.AnimationClip]}),KI(nP=ZI(nP=QI(nP=Jo(nP=JI((uP=lP=function(e){function t(){var e,i;Z(this,t);for(var n=arguments.length,r=new Array(n),a=0;a<n;a++)r[a]=arguments[a];return fe(i=re(this,(e=te(t)).call.apply(e,[this].concat(r))),"playOnLoad",aP,ne(i)),i._crossFade=new _P,i._nameToState=Re(!0),fe(i,"_clips",oP,ne(i)),fe(i,"_defaultClip",sP,ne(i)),i._hasBeenPlayed=!1,i}return ee(t,vl(rp)),J(t,[{key:"onLoad",value:function(){for(var e in this.clips=this._clips,this._nameToState){this._nameToState[e].initialize(this.node)}}},{key:"start",value:function(){this.playOnLoad&&!this._hasBeenPlayed&&this._defaultClip&&this.crossFade(this._defaultClip.name,0)}},{key:"onEnable",value:function(){this._crossFade.resume()}},{key:"onDisable",value:function(){this._crossFade.pause()}},{key:"onDestroy",value:function(){for(var e in this._crossFade.stop(),this._nameToState){this._nameToState[e].destroy()}this._nameToState=Re(!0)}},{key:"play",value:function(e){if(this._hasBeenPlayed=!0,!e){if(!this._defaultClip)return;e=this._defaultClip.name}this.crossFade(e,0)}},{key:"crossFade",value:function(e){var t=arguments.length>1&&void 0!==arguments[1]?arguments[1]:.3;this._hasBeenPlayed=!0;var i=this._nameToState[e];i&&(this._crossFade.play(),this._crossFade.crossFade(i,t))}},{key:"pause",value:function(){this._crossFade.pause()}},{key:"resume",value:function(){this._crossFade.resume()}},{key:"stop",value:function(){this._crossFade.stop()}},{key:"getAnimationState",value:function(e){return this.getState(e)}},{key:"getState",value:function(e){var t=this._nameToState[e];return t&&!t.curveLoaded&&t.initialize(this.node),t||null}},{key:"createState",value:function(e,t){return t=t||e.name,this.removeState(t),this._doCreateState(e,t)}},{key:"removeState",value:function(e){var t=this._nameToState[e];t&&(t.allowLastFrameEvent(!1),t.stop(),delete this._nameToState[e])}},{key:"addClip",value:function(e,t){return ge(this._clips,e)||this._clips.push(e),this.createState(e,t)}},{key:"removeClip",value:function(e,t){var i;for(var n in this._nameToState){var r=this._nameToState[n];if(r.clip===e){i=r;break}}if(e===this._defaultClip){if(!t)return void g(3902);this._defaultClip=null}if(i&&i.isPlaying){if(!t)return void g(3903);i.stop()}this._clips=this._clips.filter((function(t){return t!==e})),i&&delete this._nameToState[i.name]}},{key:"on",value:function(e,i,n,r){var a=oe(te(t.prototype),"on",this).call(this,e,i,n,r);return e===XI.LASTFRAME&&this._syncAllowLastFrameEvent(),a}},{key:"once",value:function(e,i,n){var r=oe(te(t.prototype),"once",this).call(this,e,i,n);return e===XI.LASTFRAME&&this._syncAllowLastFrameEvent(),r}},{key:"off",value:function(e,i,n){oe(te(t.prototype),"off",this).call(this,e,i,n),e===XI.LASTFRAME&&this._syncDisallowLastFrameEvent()}},{key:"_createState",value:function(e,t){return new qI(e,t)}},{key:"_doCreateState",value:function(e,t){var i=this._createState(e,t);return i._setEventTarget(this),i.allowLastFrameEvent(this.hasEventListener(XI.LASTFRAME)),this.node&&i.initialize(this.node),this._nameToState[i.name]=i,i}},{key:"_getStateByNameOrDefaultClip",value:function(e){if(!e){if(!this._defaultClip)return null;e=this._defaultClip.name}var t=this._nameToState[e];return t||null}},{key:"_removeStateOfAutomaticClip",value:function(e){for(var t in this._nameToState){var i=this._nameToState[t];fP(e,i.clip)&&(i.stop(),delete this._nameToState[t])}}},{key:"_syncAllowLastFrameEvent",value:function(){if(this.hasEventListener(XI.LASTFRAME))for(var e in this._nameToState)this._nameToState[e].allowLastFrameEvent(!0)}},{key:"_syncDisallowLastFrameEvent",value:function(){if(!this.hasEventListener(XI.LASTFRAME))for(var e in this._nameToState)this._nameToState[e].allowLastFrameEvent(!1)}},{key:"clips",get:function(){return this._clips},set:function(e){var t=this;this._crossFade&&this._crossFade.clear();for(var i,n=_e(this._clips);!(i=n()).done;){var r=i.value;r&&this._removeStateOfAutomaticClip(r)}for(var a,o=_e(e);!(a=o()).done;){var s=a.value;s&&this.createState(s)}var l=e.find((function(e){return fP(e,t._defaultClip)}));this._defaultClip=l||null,this._clips=e}},{key:"defaultClip",get:function(){return this._defaultClip},set:function(e){(this._defaultClip=e,e)&&(this._clips.findIndex((function(t){return fP(t,e)}))>=0||(this._clips.push(e),this.createState(e)))}}]),t}(),lP.EventType=XI,de((rP=uP).prototype,"clips",[$I],Object.getOwnPropertyDescriptor(rP.prototype,"clips"),rP.prototype),de(rP.prototype,"defaultClip",[eP],Object.getOwnPropertyDescriptor(rP.prototype,"defaultClip"),rP.prototype),aP=de(rP.prototype,"playOnLoad",[tP],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return!1}}),oP=de(rP.prototype,"_clips",[iP],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return[]}}),sP=de(rP.prototype,"_defaultClip",[Ko],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return null}}),nP=rP))||nP)||nP)||nP)||nP)||nP),exports.AnimationComponent||(exports.AnimationComponent={}),cc.AnimationComponent=exports.AnimationComponent,exports.replaceProperty(exports.AnimationComponent.prototype,"AnimationComponent",[{name:"getAnimationState",newName:"getState"},{name:"addClip",newName:"createState"},{name:"removeClip",newName:"removeState",customFunction:function(){var e=arguments.length<=0?void 0:arguments[0];return exports.AnimationComponent.prototype.removeState.call(this,e.name)}}]);var dP=Yo((pP=hP=function(e){function t(){var e,i;Z(this,t);for(var n=arguments.length,r=new Array(n),a=0;a<n;a++)r[a]=arguments[a];return(i=re(this,(e=te(t)).call.apply(e,[this].concat(r))))._anims=new me([]),i._delayEvents=[],i._blendStateBuffer=new GI,i._crossFades=[],i._sockets=[],i}return ee(t,NA),J(t,[{key:"addCrossFade",value:function(e){this._crossFades.push(e)}},{key:"removeCrossFade",value:function(e){ye(this._crossFades,e)}},{key:"update",value:function(e){for(var t=this._delayEvents,i=this._crossFades,n=this._sockets,r=0,a=i.length;r<a;r++)i[r].update(e);var o=this._anims,s=o.array;for(o.i=0;o.i<s.length;++o.i){var l=s[o.i];l.isMotionless||l.update(e)}this._blendStateBuffer.apply();for(var u=cc.director.getTotalFrames(),c=0,h=n.length;c<h;c++){var p=n[c],_=p.target,f=p.transform;_.matrix=QE(f,u)}for(var d=0,m=t.length;d<m;d++){var v=t[d];v.fn.apply(v.thisArg,v.args)}t.length=0}},{key:"destruct",value:function(){}},{key:"addAnimation",value:function(e){-1===this._anims.array.indexOf(e)&&this._anims.push(e)}},{key:"removeAnimation",value:function(e){var t=this._anims.array.indexOf(e);t>=0?this._anims.fastRemoveAt(t):b(3907)}},{key:"pushDelayEvent",value:function(e,t,i){this._delayEvents.push({fn:e,thisArg:t,args:i})}},{key:"addSockets",value:function(e,t){for(var i=this,n=function(n){var r=t[n];if(i._sockets.find((function(e){return e.target===r.target})))return"continue";var a=e.getChildByPath(r.path),o=r.target&&a&&JE(a,e);o&&i._sockets.push({target:r.target,transform:o})},r=0;r<t.length;++r)n(r)}},{key:"removeSockets",value:function(e,t){for(var i=0;i<t.length;++i)for(var n=t[i],r=0;r<this._sockets.length;++r){var a=this._sockets[r];if(a.target===n.target){$E(a.transform.node),this._sockets[r]=this._sockets[this._sockets.length-1],this._sockets.length--;break}}}},{key:"blendState",get:function(){return this._blendStateBuffer}}]),t}(),hP.ID="animation",cP=pP))||cP;_O.on(iO.EVENT_INIT,(function(){var e=new dP;_O.registerSystem(dP.ID,e,VA.PRIORITY_SYSTEM)})),cc.AnimationManager=dP;var mP,vP,yP,gP,xP,bP,TP,SP,EP,wP,CP,AP,OP,kP,RP,FP,MP,IP,PP,LP=new Ki,DP=new Ki,NP=[],zP=function(e){function t(e){var i,n=arguments.length>1&&void 0!==arguments[1]?arguments[1]:"";return Z(this,t),(i=re(this,te(t).call(this,e,n)))._frames=1,i._bakedDuration=0,i._animInfo=null,i._sockets=[],i._animInfoMgr=void 0,i._comps=[],i._parent=null,i._curvesInited=!1,i._animInfoMgr=cc.director.root.dataPoolManager.jointAnimationInfo,i}return ee(t,qI),J(t,[{key:"initialize",value:function(e){if(!this._curveLoaded){this._comps.length=0;for(var i=e.getComponentsInChildren(jR),n=0;n<i.length;++n){var r=i[n];r.skinningRoot===e&&this._comps.push(r)}this._parent=e.getComponent("cc.SkeletalAnimationComponent");var a=this._parent.useBakedAnimation;oe(te(t.prototype),"initialize",this).call(this,e,a?NP:void 0),this._curvesInited=!a;var o=RE.getOrExtract(this.clip).info;this._frames=o.frames-1,this._animInfo=this._animInfoMgr.getData(e.uuid),this._bakedDuration=this._frames/o.sample}}},{key:"onPlay",value:function(){if(oe(te(t.prototype),"onPlay",this).call(this),this._parent.useBakedAnimation){this._sampleCurves=this._sampleCurvesBaked,this.duration=this._bakedDuration,this._animInfoMgr.switchClip(this._animInfo,this._clip);for(var e=0;e<this._comps.length;++e)this._comps[e].uploadAnimation(this.clip)}else this._sampleCurves=oe(te(t.prototype),"_sampleCurves",this),this.duration=this._clip.duration,this._curvesInited||(this._curveLoaded=!1,oe(te(t.prototype),"initialize",this).call(this,this._targetNode),this._curvesInited=!0)}},{key:"rebuildSocketCurves",value:function(e){if(this._sockets.length=0,!this._targetNode)return null;for(var t=this._targetNode,i=0;i<e.length;++i){var n=e[i],r=t.getChildByPath(n.path);if(n.target){for(var a=RE.getOrExtract(this.clip),o=n.path,s=a.data[o],l=r,u=void 0;!s;){var c=o.lastIndexOf("/");if(o=o.substring(0,c),s=a.data[o],l&&(u||(u=Ki.identity(DP)),Ki.fromRTS(LP,l.rotation,l.position,l.scale),Ki.multiply(u,LP,u),l=l.parent),c<0)break}for(var h=s&&s.worldMatrix.values,p=a.info.frames,_=[],f=0;f<p;f++){var d=void 0;d=h&&u?Ki.multiply(LP,h[f],u):h?h[f]:u||Ki.IDENTITY;var m={pos:new Ii,rot:new Xi,scale:new Ii};Ki.toRTS(d,m.rot,m.pos,m.scale),_.push(m)}this._sockets.push({target:n.target,frames:_})}}}},{key:"_sampleCurvesBaked",value:function(e){var t=this._animInfo,i=e*this._frames+.5|0;if(i!==t.data[0]){t.data[0]=i,t.dirty=!0;for(var n=0;n<this._sockets.length;++n){var r=this._sockets[n],a=r.target,o=r.frames[i],s=o.pos,l=o.rot,u=o.scale;a.setRTS(l,s,u)}}}}]),t}(),BP=(mP=Yo("cc.SkeletalAnimationComponent.Socket"),vP=Ko(tg),mP((xP=de((gP=function e(){var t=arguments.length>0&&void 0!==arguments[0]?arguments[0]:"",i=arguments.length>1&&void 0!==arguments[1]?arguments[1]:null;Z(this,e),fe(this,"path",xP,this),fe(this,"target",bP,this),this.path=t,this.target=i}).prototype,"path",[Ko],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return""}}),bP=de(gP.prototype,"target",[vP],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return null}}),yP=gP))||yP),GP=new Ki,UP=new Ki;function XP(e){for(var t=arguments.length>1&&void 0!==arguments[1]?arguments[1]:"",i=arguments.length>2&&void 0!==arguments[2]?arguments[2]:[],n=0;n<e.children.length;n++){var r=e.children[n];if(r){var a=t?"".concat(t,"/").concat(r.name):r.name;i.push(a),XP(r,a,i)}}return i}var VP,HP,WP,jP,qP=(TP=Yo("cc.SkeletalAnimationComponent"),SP=os("i18n:cc.SkeletalAnimationComponent"),EP=ts(99),wP=es("Components/SkeletalAnimation"),CP=Ko({type:[BP],tooltip:"i18n:animation.sockets"}),AP=Ko({tooltip:"i18n:animation.use_baked_animation"}),OP=Ko({type:[BP]}),TP(kP=SP(kP=EP(kP=Jo(kP=wP((PP=IP=function(e){function t(){var e,i;Z(this,t);for(var n=arguments.length,r=new Array(n),a=0;a<n;a++)r[a]=arguments[a];return fe(i=re(this,(e=te(t)).call.apply(e,[this].concat(r))),"_useBakedAnimation",FP,ne(i)),fe(i,"_sockets",MP,ne(i)),i}return ee(t,exports.AnimationComponent),J(t,[{key:"onDestroy",value:function(){oe(te(t.prototype),"onDestroy",this).call(this),cc.director.root.dataPoolManager.jointAnimationInfo.destroy(this.node.uuid),cc.director.getAnimationManager().removeSockets(this.node,this._sockets)}},{key:"start",value:function(){this.sockets=this._sockets,this.useBakedAnimation=this._useBakedAnimation,oe(te(t.prototype),"start",this).call(this)}},{key:"querySockets",value:function(){var e=this._defaultClip&&Object.keys(RE.getOrExtract(this._defaultClip).data).sort().reduce((function(e,t){return t.startsWith(e[e.length-1])||e.push(t),e}),[])||[];if(!e.length)return["please specify a valid default animation clip first"];for(var t=[],i=0;i<e.length;i++){var n=e[i],r=this.node.getChildByPath(n);r&&(t.push(n),XP(r,n,t))}return t}},{key:"rebuildSocketAnimations",value:function(){for(var e,t=_e(this._sockets);!(e=t()).done;){var i=e.value,n=this.node.getChildByPath(i.path),r=i.target;n&&r&&(r.name="".concat(i.path.substring(i.path.lastIndexOf("/")+1)," Socket"),r.parent=this.node,IE(n,this.node,GP),Ki.fromRTS(UP,r.rotation,r.position,r.scale),Ki.equals(UP,GP)||(r.matrix=GP))}for(var a=0,o=Object.keys(this._nameToState);a<o.length;a++){var s=o[a];this._nameToState[s].rebuildSocketCurves(this._sockets)}}},{key:"createSocket",value:function(e){var t=this._sockets.find((function(t){return t.path===e}));if(t)return t.target;if(!this.node.getChildByPath(e))return console.warn("illegal socket path"),null;var i=new tg;return i.parent=this.node,this._sockets.push(new BP(e,i)),this.rebuildSocketAnimations(),i}},{key:"_createState",value:function(e,t){return new zP(e,t)}},{key:"_doCreateState",value:function(e,i){var n=oe(te(t.prototype),"_doCreateState",this).call(this,e,i);return n.rebuildSocketCurves(this._sockets),n}},{key:"sockets",get:function(){return this._sockets},set:function(e){if(!this._useBakedAnimation){var t=cc.director.getAnimationManager();t.removeSockets(this.node,this._sockets),t.addSockets(this.node,e)}this._sockets=e,this.rebuildSocketAnimations()}},{key:"useBakedAnimation",get:function(){return this._useBakedAnimation},set:function(e){this._useBakedAnimation=e;for(var t=this.node.getComponentsInChildren(jR),i=0;i<t.length;++i){var n=t[i];n.skinningRoot===this.node&&n.setUseBakedAnimation(this._useBakedAnimation)}this._useBakedAnimation?cc.director.getAnimationManager().removeSockets(this.node,this._sockets):cc.director.getAnimationManager().addSockets(this.node,this._sockets)}}]),t}(),IP.Socket=BP,de((RP=PP).prototype,"sockets",[CP],Object.getOwnPropertyDescriptor(RP.prototype,"sockets"),RP.prototype),de(RP.prototype,"useBakedAnimation",[AP],Object.getOwnPropertyDescriptor(RP.prototype,"useBakedAnimation"),RP.prototype),FP=de(RP.prototype,"_useBakedAnimation",[Ko],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return!0}}),MP=de(RP.prototype,"_sockets",[OP],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return[]}}),kP=RP))||kP)||kP)||kP)||kP)||kP);cc.SkeletalAnimationComponent=qP,cc.easing=cI;var YP=Yo("cc.HierachyModifier")(VP=function(e){function t(){return Z(this,t),re(this,te(t).apply(this,arguments))}return ee(t,AE),t}())||VP;cc.HierachyModifier=YP;var KP=Yo("cc.ComponentModifier")(HP=function(e){function t(){return Z(this,t),re(this,te(t).apply(this,arguments))}return ee(t,OE),t}())||HP;cc.ComponentModifier=KP;var ZP=Yo("cc.CurveValueAdapter")(WP=function(){function e(){Z(this,e)}return J(e,[{key:"forTarget",value:function(e){return{set:function(){}}}}]),e}())||WP;cc.CurveValueAdapter=ZP;var QP=Yo("cc.UniformCurveValueAdapter")(jP=function(e){function t(){return Z(this,t),re(this,te(t).apply(this,arguments))}return ee(t,sM),t}())||jP;function JP(e){return"string"==typeof e}function $P(e){return"number"==typeof e}function eL(e,t){return e instanceof t}cc.UniformCurveValueAdapter=QP,cc.isPropertyModifier=JP,cc.isElementModifier=$P,cc.isCustomTargetModifier=eL;var tL,iL=function(){function e(t,i,n){Z(this,e),this._id=void 0,this._opts=void 0,this._accumStart=void 0,this._total=0,this._value=0,this._averageValue=0,this._accumValue=0,this._accumSamples=0,this._id=t,this._opts=i,this._accumStart=n}return J(e,[{key:"value",get:function(){return this._value},set:function(e){this._value=e}}]),J(e,[{key:"sample",value:function(e){this._average(this._value,e)}},{key:"human",value:function(){var e=this._opts,t=e.average,i=e.isInteger,n=t?this._averageValue:this._value;return i?Math.round(n):Math.round(100*n)/100}},{key:"alarm",value:function(){return this._opts.below&&this._value<this._opts.below||this._opts.over&&this._value>this._opts.over}},{key:"_average",value:function(e){var t=arguments.length>1&&void 0!==arguments[1]?arguments[1]:0;if(this._opts.average){this._accumValue+=e,++this._accumSamples;var i=t;i-this._accumStart>=this._opts.average&&(this._averageValue=this._accumValue/this._accumSamples,this._accumValue=0,this._accumStart=i,this._accumSamples=0)}}}]),e}(),nL=Yo("cc.PerfCounter")(tL=function(e){function t(e,i,n){var r;return Z(this,t),(r=re(this,te(t).call(this,e,i,n)))._time=void 0,r._time=n,r}return ee(t,iL),J(t,[{key:"start",value:function(){var e=arguments.length>0&&void 0!==arguments[0]?arguments[0]:0;this._time=e}},{key:"end",value:function(){var e=arguments.length>0&&void 0!==arguments[0]?arguments[0]:0;this._value=e-this._time,this._average(this._value)}},{key:"tick",value:function(){this.end(),this.start()}},{key:"frame",value:function(e){var t=e,i=t-this._time;this._total++,i>(this._opts.average||1e3)&&(this._value=1e3*this._total/i,this._total=0,this._time=t,this._average(this._value))}}]),t}())||tL,rL={0:0,1:1,2:2,3:3,4:4,5:5,6:6,7:7,8:8,9:9,".":10},aL={frame:{desc:"Frame time (ms)",min:0,max:50,average:500},fps:{desc:"Framerate (FPS)",below:30,average:500,isInteger:!0},draws:{desc:"Draw call",isInteger:!0},instances:{desc:"Instance Count",isInteger:!0},tricount:{desc:"Triangle",isInteger:!0},logic:{desc:"Game Logic (ms)",min:0,max:50,average:500,color:"#080"},physics:{desc:"Physics (ms)",min:0,max:50,average:500},render:{desc:"Renderer (ms)",min:0,max:50,average:500,color:"#f90"},textureMemory:{desc:"GFX Texture Mem(M)"},bufferMemory:{desc:"GFX Buffer Mem(M)"}},oL=24,sL=.18,lL=8,uL=256,cL=256,hL=function(){function e(){Z(this,e),this._stats=null,this.id="__Profiler__",this._showFPS=!1,this._rootNode=null,this._device=null,this._canvas=null,this._ctx=null,this._texture=null,this._textureView=null,this._region=new vr,this._canvasArr=[],this._regionArr=[this._region],this.digitsData=null,this._canvasDone=!1,this._statsDone=!1,this._inited=!1,this._lineHeight=cL/(Object.keys(aL).length+1),this._wordHeight=0,this._eachNumWidth=0,this._totalLines=0,this.lastTime=0,this._uvOffset=[],this._canvas=document.createElement("canvas"),this._ctx=this._canvas.getContext("2d"),this._region=new vr,this._canvasArr.push(this._canvas)}return J(e,[{key:"isShowingStats",value:function(){return this._showFPS}},{key:"hideStats",value:function(){this._showFPS&&(this._rootNode&&(this._rootNode.active=!1),cc.game.off(cc.Game.EVENT_RESTART,this.generateNode,this),cc.director.off(cc.Director.EVENT_BEFORE_UPDATE,this.beforeUpdate,this),cc.director.off(cc.Director.EVENT_AFTER_UPDATE,this.afterUpdate,this),cc.director.off(cc.Director.EVENT_BEFORE_PHYSICS,this.beforePhysics,this),cc.director.off(cc.Director.EVENT_AFTER_PHYSICS,this.afterPhysics,this),cc.director.off(cc.Director.EVENT_BEFORE_DRAW,this.beforeDraw,this),cc.director.off(cc.Director.EVENT_AFTER_DRAW,this.afterDraw,this),this._showFPS=!1)}},{key:"showStats",value:function(){this._showFPS||(this._device||(this._device=cc.director.root.device),this.generateCanvas(),this.generateStats(),cc.game.once(cc.Game.EVENT_ENGINE_INITED,this.generateNode,this),cc.game.on(cc.Game.EVENT_RESTART,this.generateNode,this),this._rootNode&&(this._rootNode.active=!0),cc.director.on(cc.Director.EVENT_BEFORE_UPDATE,this.beforeUpdate,this),cc.director.on(cc.Director.EVENT_AFTER_UPDATE,this.afterUpdate,this),cc.director.on(cc.Director.EVENT_BEFORE_PHYSICS,this.beforePhysics,this),cc.director.on(cc.Director.EVENT_AFTER_PHYSICS,this.afterPhysics,this),cc.director.on(cc.Director.EVENT_BEFORE_DRAW,this.beforeDraw,this),cc.director.on(cc.Director.EVENT_AFTER_DRAW,this.afterDraw,this),this._showFPS=!0,this._canvasDone=!0,this._statsDone=!0)}},{key:"generateCanvas",value:function(){if(!this._canvasDone){var e=uL,t=cL;this._ctx&&this._canvas&&(this._canvas.width=e,this._canvas.height=t,this._canvas.style.width="".concat(this._canvas.width),this._canvas.style.height="".concat(this._canvas.height),this._ctx.font="".concat(oL,"px Arial"),this._ctx.textBaseline="top",this._ctx.fillStyle="#fff",this._texture=this._device.createTexture({type:exports.GFXTextureType.TEX2D,usage:exports.GFXTextureUsageBit.SAMPLED,format:exports.GFXFormat.RGBA8,width:e,height:t,mipLevel:1}),this._textureView=this._device.createTextureView({texture:this._texture,type:exports.GFXTextureViewType.TV2D,format:exports.GFXFormat.RGBA8}),this._region.texExtent.width=e,this._region.texExtent.height=t)}}},{key:"generateStats",value:function(){if(!this._statsDone&&this._ctx&&this._canvas){this._stats=null;var e=performance.now();this._ctx.textAlign="left";var t=0;for(var i in aL){var n=aL[i];this._ctx.fillText(n.desc,0,t*this._lineHeight),n.counter=new nL(i,n,e),t++}this._totalLines=t,this._wordHeight=this._totalLines*this._lineHeight/this._canvas.height;var r=new Array;r[0]=0;for(var a=0;a<"0123456789. ".length;++a){var o=this._ctx.measureText("0123456789. "[a]).width;this._eachNumWidth=Math.max(this._eachNumWidth,o),r[a+1]=r[a]+o/this._canvas.width}for(var s=0;s<"0123456789. ".length;++s)this._ctx.fillText("0123456789. "[s],s*this._eachNumWidth,this._totalLines*this._lineHeight);this._eachNumWidth/=this._canvas.width;for(var l=Math.ceil(r.length/4),u=0;u<l;u++)this._uvOffset.push(new Ni(r[4*u],r[4*u+1],r[4*u+2],r[4*u+3]));this._stats=aL,this._canvasArr[0]=this._canvas,this._device.copyTexImagesToTexture(this._canvasArr,this._texture,this._regionArr)}}},{key:"generateNode",value:function(){if(!this._rootNode||!this._rootNode.isValid){this._rootNode=new tg("PROFILER_NODE"),cc.game.addPersistRootNode(this._rootNode);var e=new tg("Profiler_Camera");e.setPosition(0,0,1),e.parent=this._rootNode;var t=e.addComponent("cc.CameraComponent");t.projection=exports.CameraComponent.ProjectionType.ORTHO,t.near=0,t.far=0,t.orthoHeight=this._device.height,t.visibility=bu.BitMask.PROFILER,t.clearFlags=exports.GFXClearFlag.NONE,t.priority=4294967295,t.flows=["UIFlow"];var i=new tg("Profiler_Root");i.parent=this._rootNode;for(var n=sL,r=n/this._totalLines,a=n/this._wordHeight,o=r/oL,s=this._eachNumWidth*this._canvas.width*o,l=[0,n,0,a,n,0,a,0,0,0,0,0],u=[0,2,1,0,3,2],c=[0,0,-1,0,1,0,-1,0,1,this._wordHeight,-1,0,0,this._wordHeight,-1,0],h=0,p=0;p<this._totalLines;p++)for(var _=0;_<lL;_++){l.push(a+_*s,n-p*r,0),l.push(a+(_+1)*s,n-p*r,0),l.push(a+(_+1)*s,n-(p+1)*r,0),l.push(a+_*s,n-(p+1)*r,0),h=4*(p*lL+_+1),u.push(0+h,2+h,1+h,0+h,3+h,2+h);var f=p*lL+_,d=Math.floor(f/4),m=f-4*d;c.push(0,this._wordHeight,d,m),c.push(this._eachNumWidth,this._wordHeight,d,m),c.push(this._eachNumWidth,1,d,m),c.push(0,1,d,m)}var v=i.addComponent("cc.ModelComponent");v.mesh=yw({positions:l,indices:u,colors:c});var y=new Bh;y.initialize({effectName:"util/profiler"}),y.setProperty("offset",new Ni(-.9,-.9,this._eachNumWidth,0));var g=y.passes[0],x=g.getBinding("mainTexture"),b=g.getBinding("digits");g.bindTextureView(x,this._textureView),this.digitsData=g.blocks[b],v.material=y,v.node.layer=bu.Enum.PROFILER,this._inited=!0}}},{key:"beforeUpdate",value:function(){if(this._stats){var e=performance.now();this._stats.frame.counter.end(e),this._stats.frame.counter.start(e),this._stats.logic.counter.start(e)}}},{key:"afterUpdate",value:function(){if(this._stats){var e=performance.now();cc.director.isPaused()?this._stats.frame.counter.start(e):this._stats.logic.counter.end(e)}}},{key:"beforePhysics",value:function(){if(this._stats){var e=performance.now();this._stats.physics.counter.start(e)}}},{key:"afterPhysics",value:function(){if(this._stats){var e=performance.now();this._stats.physics.counter.end(e)}}},{key:"beforeDraw",value:function(){if(this._stats){var e=performance.now();this._stats.render.counter.start(e)}}},{key:"afterDraw",value:function(){if(this._stats&&this._inited){var e=performance.now();if(this._stats.fps.counter.frame(e),this._stats.render.counter.end(e),!(e-this.lastTime<500)){this.lastTime=e;var t=this._device;this._stats.draws.counter.value=t.numDrawCalls,this._stats.instances.counter.value=t.numInstances,this._stats.bufferMemory.counter.value=t.memoryStatus.bufferSize/1048576,this._stats.textureMemory.counter.value=t.memoryStatus.textureSize/1048576,this._stats.tricount.counter.value=t.numTris;var i=0,n=this.digitsData.view;for(var r in this._stats){var a=this._stats[r];a.counter.sample(e);for(var o=a.counter.human().toString(),s=lL-1;s>=0;s--){var l=i*lL+s,u=o[o.length-(lL-s)],c=rL[u];void 0===c&&(c=11),n[l]=c}i++}this.digitsData.dirty=!0}}}}]),e}(),pL=new hL;cc.profiler=pL;var _L={};function fL(e,t,i){var n=e.createShader(t);if(n){if(e.shaderSource(n,i),e.compileShader(n),e.getShaderParameter(n,e.COMPILE_STATUS))return n;console.error("compile shader error",n),console.log(e.getShaderInfoLog(n)),e.deleteShader(n)}else console.error("create shader error",i)}exports.replaceProperty(_L,"vmath",[{name:"vec2",newName:"Vec2",target:_n,targetName:"math"},{name:"vec3",newName:"Vec3",target:_n,targetName:"math"},{name:"vec4",newName:"Vec4",target:_n,targetName:"math"},{name:"quat",newName:"Quat",target:_n,targetName:"math"},{name:"mat3",newName:"Mat3",target:_n,targetName:"math"},{name:"mat4",newName:"Mat4",target:_n,targetName:"math"},{name:"color4",newName:"Color",target:_n,targetName:"math"},{name:"rect",newName:"Rect",target:_n,targetName:"math"},{name:"approx",newName:"approx",target:_n,targetName:"math"},{name:"EPSILON",newName:"EPSILON",target:_n,targetName:"math"},{name:"equals",newName:"equals",target:_n,targetName:"math"},{name:"clamp",newName:"clamp",target:_n,targetName:"math"},{name:"clamp01",newName:"clamp01",target:_n,targetName:"math"},{name:"lerp",newName:"lerp",target:_n,targetName:"math"},{name:"toRadian",newName:"toRadian",target:_n,targetName:"math"},{name:"toDegree",newName:"toDegree",target:_n,targetName:"math"},{name:"random",newName:"random",target:_n,targetName:"math"},{name:"randomRange",newName:"randomRange",target:_n,targetName:"math"},{name:"randomRangeInt",newName:"randomRangeInt",target:_n,targetName:"math"},{name:"pseudoRandom",newName:"pseudoRandom",target:_n,targetName:"math"},{name:"pseudoRandomRangeInt",newName:"pseudoRandomRangeInt",target:_n,targetName:"math"},{name:"nextPow2",newName:"nextPow2",target:_n,targetName:"math"},{name:"repeat",newName:"repeat",target:_n,targetName:"math"},{name:"pingPong",newName:"pingPong",target:_n,targetName:"math"},{name:"inverseLerp",newName:"inverseLerp",target:_n,targetName:"math"}]),cc.vmath=_L,exports.replaceProperty(VA.prototype,"Scheduler.prototype",[{name:"enableForTarget",newName:"enableForTarget",target:VA,targetName:"Scheduler"}]),exports.replaceProperty(exports.CameraComponent.prototype,"CameraComponent.prototype",[{name:"color",newName:"clearColor"},{name:"depth",newName:"clearDepth"},{name:"stencil",newName:"clearStencil"}]),exports.replaceProperty(Tv.prototype,"EventTouch.prototype",[{name:"getUILocationInView",newName:"getLocationInView",target:Tv,targetName:"EventTouch"}]);var dL=function(){function e(){Z(this,e),this.logoImage=new Image,this.textImage=document.createElement("canvas"),this.vertices=new Float32Array([-1,-1,-1,1,1,-1,1,-1,-1,1,1,1]),this.texcoords=new Float32Array([0,0,0,1,1,0,1,0,0,1,1,1]),this.logoMat33=new Float32Array([1,0,0,0,1,0,0,0,1]),this.textMat33=new Float32Array([1,0,0,0,1,0,0,0,1]),this.callBack=null,this.cancelAnimate=!1,this.handle=-1,this.startTime=-1,this.orientation="",this.cocosPlayVersion=134,this._isStart=!1,this._directCall=!1,this._splashFinish=!1,this._loadFinish=!1}return J(e,[{key:"_tryToStart",value:function(){this._splashFinish&&this._loadFinish&&this.callBack&&(this.cancelAnimate=!0,cancelAnimationFrame(this.handle),this.destroy(),this.callBack())}},{key:"setOnFinish",value:function(t){if((!this._isStart||this._directCall)&&t)return delete e._ins,t();this.callBack=t}},{key:"main",value:function(e){var t=globalThis._CCSettings;if(t&&t.splashScreen?(this.setting=t.splashScreen,this.setting.totalTime=null!=this.setting.totalTime?this.setting.totalTime:3e3,this.setting.base64src=null!=this.setting.base64src?this.setting.base64src:"",this.setting.effect=null!=this.setting.effect?this.setting.effect:"Fade-InOut",this.setting.clearColor=null!=this.setting.clearColor?this.setting.clearColor:{r:.88,g:.88,b:.88,a:1},this.setting.displayRatio=null!=this.setting.displayRatio?this.setting.displayRatio:.4,this.setting.displayWatermark=null==this.setting.displayWatermark||this.setting.displayWatermark,this.orientation=t.orientation):this.setting={totalTime:3e3,base64src:"",effect:"Fade-InOut",clearColor:{r:.88,g:.88,b:.88,a:1},displayRatio:.4,displayWatermark:!0},null==e||""==this.setting.base64src||this.setting.totalTime<=0)return this.callBack&&this.callBack(),this.callBack=null,this.setting=null,void(this._directCall=!0);cc.view.enableRetina(!0);var i=t.designResolution;i?cc.view.setDesignResolutionSize(i.width,i.height,i.policy):cc.view.setDesignResolutionSize(960,640,4);var n=!!globalThis.WebGL2RenderingContext,r=globalThis.navigator.userAgent.toLowerCase();(-1!==r.indexOf("safari")&&-1===r.indexOf("chrome")||Cs.browserType===Cs.BROWSER_TYPE_UC)&&(n=!1);var a={alpha:cu.ENABLE_TRANSPARENT_CANVAS,antialias:!0,depth:!0,stencil:!0,premultipliedAlpha:!0,preserveDrawingBuffer:!1,powerPreference:"default",failIfMajorPerformanceCaveat:!1},o=null,s=null;if(n&&cc.WebGL2GFXDevice?null==(s=e.getContext("webgl2",a))&&(o=e.getContext("webgl",a)):o=e.getContext("webgl",a),null==o&&null==s)return console.error("this device does not support webgl");null!=o&&(this.gl=o),null!=s&&(this.gl=s);var l=this.textImage;l.width=330,l.height=30,l.style.width="".concat(l.width),l.style.height="".concat(l.height);var u=l.getContext("2d");u.font="".concat(18,"px Arial"),u.textBaseline="top",u.textAlign="left",u.fillStyle="`#424242`";var c="Powered by Cocos Creator 3D",h=u.measureText(c);u.fillText(c,(330-h.width)/2,6),this.logoImage.onload=this.init.bind(this),this.logoImage.src=this.setting.base64src,this._isStart=!0}},{key:"init",value:function(){this.initMatrix(),this.initProgram(),this.initBuffer(),this.initTexture(),this.initState();var e=this;this.handle=requestAnimationFrame((function t(i){e.cancelAnimate||(void 0===i&&(i=performance.now()),e.frame(i),requestAnimationFrame(t))}))}},{key:"initMatrix",value:function(){var e=this.gl.canvas.width,t=this.gl.canvas.height,i=this.setting.displayRatio,n=this.logoImage.width/2,r=this.logoImage.height/2,a=this.textImage.width/2,o=this.textImage.height/2;e<t?(r=(n=e/2*i)/(this.logoImage.width/this.logoImage.height),o=(a=e/2*.5)/(this.textImage.width/this.textImage.height)):(r=(n=t/2*i)/(this.logoImage.width/this.logoImage.height),o=(a=t/2*.5)/(this.textImage.width/this.textImage.height)),this.logoMat33[0]=n,this.logoMat33[4]=r,this.logoMat33[6]=e/2,this.logoMat33[7]=t/2,this.textMat33[0]=a,this.textMat33[4]=o,this.textMat33[6]=e/2,this.textMat33[7]=.9*t}},{key:"initProgram",value:function(){var e=this.gl;this.vertexShader=fL(e,e.VERTEX_SHADER,"precision mediump float;attribute vec2 a_position;attribute vec2 a_texCoord;uniform vec2 u_resolution;uniform mat3 u_worldMat;varying vec2 v_texCoord;void main() {vec3 wpos = u_worldMat * vec3(a_position, 1.0);vec2 clipSpace = wpos.xy / u_resolution * 2.0 - 1.0;gl_Position = vec4(clipSpace * vec2(1, -1), 0, 1);v_texCoord = a_texCoord;}"),this.fragmentShader=fL(e,e.FRAGMENT_SHADER,"precision mediump float;uniform float u_alpha;uniform sampler2D u_image;varying vec2 v_texCoord;void main(){gl_FragColor = texture2D(u_image,v_texCoord);gl_FragColor.xyz *= clamp(u_alpha, 0.0, 1.0);}"),this.program=function(e,t,i){var n=e.createProgram();if(n){e.attachShader(n,t),e.attachShader(n,i),e.linkProgram(n);var r=e.getProgramParameter(n,e.LINK_STATUS);if(r)return n;console.error("link program error",r),console.log(e.getProgramInfoLog(n)),e.deleteProgram(n)}else console.error("create program error")}(e,this.vertexShader,this.fragmentShader)}},{key:"initBuffer",value:function(){var e=this.gl;e.useProgram(this.program),this.positionBuffer=e.createBuffer(),e.bindBuffer(e.ARRAY_BUFFER,this.positionBuffer),e.bufferData(e.ARRAY_BUFFER,this.vertices,e.STATIC_DRAW),this.texcoordBuffer=e.createBuffer(),e.bindBuffer(e.ARRAY_BUFFER,this.texcoordBuffer),e.bufferData(e.ARRAY_BUFFER,this.texcoords,e.STATIC_DRAW);var t=e.getAttribLocation(this.program,"a_position");e.enableVertexAttribArray(t),e.bindBuffer(e.ARRAY_BUFFER,this.positionBuffer);var i=2,n=e.FLOAT,r=!1,a=0,o=0;e.vertexAttribPointer(t,i,n,r,a,o);var s=e.getAttribLocation(this.program,"a_texCoord");e.enableVertexAttribArray(s),e.bindBuffer(e.ARRAY_BUFFER,this.texcoordBuffer);i=2,n=e.FLOAT,r=!1,a=0,o=0;e.vertexAttribPointer(s,i,n,r,a,o)}},{key:"initTexture",value:function(){var e=this.gl;this.textureLogo=e.createTexture(),e.bindTexture(e.TEXTURE_2D,this.textureLogo),e.texParameteri(e.TEXTURE_2D,e.TEXTURE_WRAP_S,e.CLAMP_TO_EDGE),e.texParameteri(e.TEXTURE_2D,e.TEXTURE_WRAP_T,e.CLAMP_TO_EDGE),e.texParameteri(e.TEXTURE_2D,e.TEXTURE_MIN_FILTER,e.LINEAR),e.texParameteri(e.TEXTURE_2D,e.TEXTURE_MAG_FILTER,e.LINEAR),e.texImage2D(e.TEXTURE_2D,0,e.RGBA,e.RGBA,e.UNSIGNED_BYTE,this.logoImage),this.textureText=e.createTexture(),e.bindTexture(e.TEXTURE_2D,this.textureText),e.texParameteri(e.TEXTURE_2D,e.TEXTURE_WRAP_S,e.CLAMP_TO_EDGE),e.texParameteri(e.TEXTURE_2D,e.TEXTURE_WRAP_T,e.CLAMP_TO_EDGE),e.texParameteri(e.TEXTURE_2D,e.TEXTURE_MIN_FILTER,e.LINEAR),e.texParameteri(e.TEXTURE_2D,e.TEXTURE_MAG_FILTER,e.LINEAR),e.texImage2D(e.TEXTURE_2D,0,e.RGBA,e.RGBA,e.UNSIGNED_BYTE,this.textImage)}},{key:"initState",value:function(){var e=this.gl;e.useProgram(this.program);var t=e.getUniformLocation(this.program,"u_resolution");e.uniform2f(t,e.canvas.width,e.canvas.height),e.enable(e.BLEND),e.blendFunc(e.SRC_ALPHA,e.ONE_MINUS_SRC_ALPHA)}},{key:"frame",value:function(e){var t=this.gl,i=this.program,n=this.textureLogo,r=this.textureText,a=this.setting.clearColor,o=this.logoMat33,s=this.textMat33;this.startTime<0&&(this.startTime=e);var l=e-this.startTime,u=PM(_i(l/this.setting.totalTime));t.enable(t.BLEND),t.blendFunc(t.SRC_ALPHA,t.ONE_MINUS_SRC_ALPHA),t.bindFramebuffer(t.FRAMEBUFFER,null),t.viewport(0,0,t.canvas.width,t.canvas.height),t.clearColor(a.r,a.g,a.b,a.a),t.depthMask(!0),t.clearDepth(1),t.clearStencil(0),t.clear(t.COLOR_BUFFER_BIT|t.DEPTH_BUFFER_BIT|t.STENCIL_BUFFER_BIT),t.useProgram(this.program);var c=t.getUniformLocation(this.program,"u_resolution");t.uniform2f(c,t.canvas.width,t.canvas.height);var h=t.getUniformLocation(i,"u_alpha");t.uniform1f(h,u),h=t.getUniformLocation(i,"u_worldMat"),t.uniformMatrix3fv(h,!1,o),t.bindTexture(t.TEXTURE_2D,n),t.drawArrays(t.TRIANGLES,0,6),this.setting.displayWatermark&&(t.uniformMatrix3fv(h,!1,s),t.bindTexture(t.TEXTURE_2D,r),t.drawArrays(t.TRIANGLES,0,6)),l>this.setting.totalTime&&(this.splashFinish=!0)}},{key:"destroy",value:function(){delete e._ins,this.gl.deleteProgram(this.program),this.gl.deleteShader(this.vertexShader),this.gl.deleteShader(this.fragmentShader),this.gl.deleteBuffer(this.positionBuffer),this.gl.deleteBuffer(this.texcoordBuffer),this.gl.deleteTexture(this.textureLogo),this.gl.deleteTexture(this.textureText);var t=QS._gfxDevice;if(t&&t.stateCache)for(var i=t.stateCache.glTexUnits,n=0;n<i.length;n++)null!=i[n]&&(i[n].glTexture=null)}},{key:"loadFinish",set:function(e){this._loadFinish=e,this._tryToStart()}},{key:"splashFinish",set:function(e){this._splashFinish=e,this._tryToStart()}}],[{key:"instance",get:function(){return null==e._ins&&(e._ins=new e),e._ins}}]),e}();dL._ins=void 0,cc.internal.SplashScreenWebgl=dL,cc.math=_n,cc.geometry=bo;var mL,vL,yL,gL,xL,bL,TL,SL,EL,wL=function(){function e(t){Z(this,e),this.poolHandlerComp=void 0,this._pool=void 0,this.poolHandlerComp=t,this._pool=[]}return J(e,[{key:"size",value:function(){return this._pool.length}},{key:"clear",value:function(){for(var e=this._pool.length,t=0;t<e;++t)this._pool[t].destroy();this._pool.length=0}},{key:"put",value:function(e){if(e&&-1===this._pool.indexOf(e)){e.removeFromParent();var t=this.poolHandlerComp?e.getComponent(this.poolHandlerComp):null;t&&t.unuse&&t.unuse(),this._pool.push(e)}}},{key:"get",value:function(){var e=this._pool.length-1;if(e<0)return null;var t=this._pool[e];this._pool.length=e;var i=this.poolHandlerComp?t.getComponent(this.poolHandlerComp):null;if(i&&i.reuse){for(var n,r=arguments.length,a=new Array(r),o=0;o<r;o++)a[o]=arguments[o];(n=i.reuse).apply.apply(n,[i].concat(a))}return t}}]),e}();cc.NodePool=wL,function(e){e[e.BOX=0]="BOX",e[e.SPHERE=1]="SPHERE",e[e.CYLINDER=2]="CYLINDER",e[e.CONE=3]="CONE",e[e.CAPSULE=4]="CAPSULE",e[e.TORUS=5]="TORUS",e[e.PLANE=6]="PLANE",e[e.QUAD=7]="QUAD"}(EL||(EL={})),bt(EL),exports.Primitive=(mL=Yo("cc.Primitive"),vL=Ko({type:EL}),mL((SL=TL=function(e){function t(){var e,i=arguments.length>0&&void 0!==arguments[0]?arguments[0]:EL.BOX;return Z(this,t),fe(e=re(this,te(t).call(this)),"type",xL,ne(e)),fe(e,"info",bL,ne(e)),e.type=i,e}return ee(t,rc),J(t,[{key:"onLoaded",value:function(){yw(jw[EL[this.type].toLowerCase()](this.info),this)}}]),t}(),TL.PrimitiveType=EL,xL=de((gL=SL).prototype,"type",[vL],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return EL.BOX}}),bL=de(gL.prototype,"info",[Ko],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return{}}}),yL=gL))||yL),exports.Primitive||(exports.Primitive={}),cc.Primitive=exports.Primitive,cc.renderer=WC;var CL=cc;cc.primitives=jw;var AL,OL=function(e){function t(){var e,i;Z(this,t);for(var n=arguments.length,r=new Array(n),a=0;a<n;a++)r[a]=arguments[a];return(i=re(this,(e=te(t)).call.apply(e,[this].concat(r))))._gpuBindingLayout=null,i}return ee(t,Yr),J(t,[{key:"initialize",value:function(e){this._bindingUnits=new Array(e.bindings.length);for(var t=0;t<e.bindings.length;++t){var i=e.bindings[t];this._bindingUnits[t]={binding:i.binding,type:i.bindingType,name:i.name,buffer:null,texView:null,sampler:null}}this._gpuBindingLayout={gpuBindings:new Array(e.bindings.length)};for(var n=0;n<e.bindings.length;++n){var r=e.bindings[n];this._gpuBindingLayout.gpuBindings[n]={binding:r.binding,type:r.bindingType,name:r.name,gpuBuffer:null,gpuTexView:null,gpuSampler:null}}return this._status=exports.GFXStatus.SUCCESS,!0}},{key:"destroy",value:function(){this._gpuBindingLayout=null,this._status=exports.GFXStatus.UNREADY}},{key:"update",value:function(){if(this._isDirty&&this._gpuBindingLayout){for(var e=0;e<this._bindingUnits.length;++e){var t=this._bindingUnits[e];switch(t.type){case exports.GFXBindingType.UNIFORM_BUFFER:t.buffer&&(this._gpuBindingLayout.gpuBindings[e].gpuBuffer=t.buffer.gpuBuffer);break;case exports.GFXBindingType.SAMPLER:t.texView&&(this._gpuBindingLayout.gpuBindings[e].gpuTexView=t.texView.gpuTextureView),t.sampler&&(this._gpuBindingLayout.gpuBindings[e].gpuSampler=t.sampler.gpuSampler)}}this._isDirty=!1}}},{key:"gpuBindingLayout",get:function(){return this._gpuBindingLayout}}]),t}();function kL(e,t){switch(e){case exports.GFXFormat.R8:return t.UNSIGNED_BYTE;case exports.GFXFormat.R8SN:return t.BYTE;case exports.GFXFormat.R8UI:return t.UNSIGNED_BYTE;case exports.GFXFormat.R8I:return t.BYTE;case exports.GFXFormat.R16F:return AL.HALF_FLOAT_OES;case exports.GFXFormat.R16UI:return t.UNSIGNED_SHORT;case exports.GFXFormat.R16I:return t.SHORT;case exports.GFXFormat.R32F:return t.FLOAT;case exports.GFXFormat.R32UI:return t.UNSIGNED_INT;case exports.GFXFormat.R32I:return t.INT;case exports.GFXFormat.RG8:return t.UNSIGNED_BYTE;case exports.GFXFormat.RG8SN:return t.BYTE;case exports.GFXFormat.RG8UI:return t.UNSIGNED_BYTE;case exports.GFXFormat.RG8I:return t.BYTE;case exports.GFXFormat.RG16F:return AL.HALF_FLOAT_OES;case exports.GFXFormat.RG16UI:return t.UNSIGNED_SHORT;case exports.GFXFormat.RG16I:return t.SHORT;case exports.GFXFormat.RG32F:return t.FLOAT;case exports.GFXFormat.RG32UI:return t.UNSIGNED_INT;case exports.GFXFormat.RG32I:return t.INT;case exports.GFXFormat.RGB8:case exports.GFXFormat.SRGB8:return t.UNSIGNED_BYTE;case exports.GFXFormat.RGB8SN:return t.BYTE;case exports.GFXFormat.RGB8UI:return t.UNSIGNED_BYTE;case exports.GFXFormat.RGB8I:return t.BYTE;case exports.GFXFormat.RGB16F:return AL.HALF_FLOAT_OES;case exports.GFXFormat.RGB16UI:return t.UNSIGNED_SHORT;case exports.GFXFormat.RGB16I:return t.SHORT;case exports.GFXFormat.RGB32F:return t.FLOAT;case exports.GFXFormat.RGB32UI:return t.UNSIGNED_INT;case exports.GFXFormat.RGB32I:return t.INT;case exports.GFXFormat.RGBA8:case exports.GFXFormat.SRGB8_A8:return t.UNSIGNED_BYTE;case exports.GFXFormat.RGBA8SN:return t.BYTE;case exports.GFXFormat.RGBA8UI:return t.UNSIGNED_BYTE;case exports.GFXFormat.RGBA8I:return t.BYTE;case exports.GFXFormat.RGBA16F:return AL.HALF_FLOAT_OES;case exports.GFXFormat.RGBA16UI:return t.UNSIGNED_SHORT;case exports.GFXFormat.RGBA16I:return t.SHORT;case exports.GFXFormat.RGBA32F:return t.FLOAT;case exports.GFXFormat.RGBA32UI:return t.UNSIGNED_INT;case exports.GFXFormat.RGBA32I:return t.INT;case exports.GFXFormat.R5G6B5:return t.UNSIGNED_SHORT_5_6_5;case exports.GFXFormat.R11G11B10F:return t.FLOAT;case exports.GFXFormat.RGB5A1:return t.UNSIGNED_SHORT_5_5_5_1;case exports.GFXFormat.RGBA4:return t.UNSIGNED_SHORT_4_4_4_4;case exports.GFXFormat.RGB10A2:return t.UNSIGNED_BYTE;case exports.GFXFormat.RGB10A2UI:return t.UNSIGNED_INT;case exports.GFXFormat.RGB9E5:return t.UNSIGNED_BYTE;case exports.GFXFormat.D16:return t.UNSIGNED_SHORT;case exports.GFXFormat.D16S8:return AL.UNSIGNED_INT_24_8_WEBGL;case exports.GFXFormat.D24:return t.UNSIGNED_INT;case exports.GFXFormat.D24S8:return AL.UNSIGNED_INT_24_8_WEBGL;case exports.GFXFormat.D32F:return t.FLOAT;case exports.GFXFormat.D32F_S8:return AL.UNSIGNED_INT_24_8_WEBGL;case exports.GFXFormat.BC1:case exports.GFXFormat.BC1_SRGB:case exports.GFXFormat.BC2:case exports.GFXFormat.BC2_SRGB:case exports.GFXFormat.BC3:case exports.GFXFormat.BC3_SRGB:case exports.GFXFormat.BC4:return t.UNSIGNED_BYTE;case exports.GFXFormat.BC4_SNORM:return t.BYTE;case exports.GFXFormat.BC5:return t.UNSIGNED_BYTE;case exports.GFXFormat.BC5_SNORM:return t.BYTE;case exports.GFXFormat.BC6H_SF16:case exports.GFXFormat.BC6H_UF16:return t.FLOAT;case exports.GFXFormat.BC7:case exports.GFXFormat.BC7_SRGB:case exports.GFXFormat.ETC_RGB8:case exports.GFXFormat.ETC2_RGB8:case exports.GFXFormat.ETC2_SRGB8:case exports.GFXFormat.ETC2_RGB8_A1:case exports.GFXFormat.ETC2_SRGB8_A1:case exports.GFXFormat.ETC2_RGB8:case exports.GFXFormat.ETC2_SRGB8:case exports.GFXFormat.EAC_R11:return t.UNSIGNED_BYTE;case exports.GFXFormat.EAC_R11SN:return t.BYTE;case exports.GFXFormat.EAC_RG11:return t.UNSIGNED_BYTE;case exports.GFXFormat.EAC_RG11SN:return t.BYTE;case exports.GFXFormat.PVRTC_RGB2:case exports.GFXFormat.PVRTC_RGBA2:case exports.GFXFormat.PVRTC_RGB4:case exports.GFXFormat.PVRTC_RGBA4:case exports.GFXFormat.PVRTC2_2BPP:case exports.GFXFormat.PVRTC2_4BPP:default:return t.UNSIGNED_BYTE}}function RL(e,t){switch(e){case exports.GFXFormat.A8:return t.ALPHA;case exports.GFXFormat.L8:return t.LUMINANCE;case exports.GFXFormat.LA8:return t.LUMINANCE_ALPHA;case exports.GFXFormat.RGB8:case exports.GFXFormat.RGB16F:case exports.GFXFormat.RGB32F:return t.RGB;case exports.GFXFormat.RGBA8:case exports.GFXFormat.RGBA16F:case exports.GFXFormat.RGBA32F:return t.RGBA;case exports.GFXFormat.R5G6B5:return t.RGB565;case exports.GFXFormat.RGB5A1:return t.RGB5_A1;case exports.GFXFormat.RGBA4:return t.RGBA4;case exports.GFXFormat.D16:return t.DEPTH_COMPONENT;case exports.GFXFormat.D16S8:return t.DEPTH_STENCIL;case exports.GFXFormat.D24:return t.DEPTH_COMPONENT;case exports.GFXFormat.D24S8:return t.DEPTH_STENCIL;case exports.GFXFormat.D32F:return t.DEPTH_COMPONENT;case exports.GFXFormat.D32F_S8:return t.DEPTH_STENCIL;case exports.GFXFormat.BC1:return AL.COMPRESSED_RGB_S3TC_DXT1_EXT;case exports.GFXFormat.BC1_ALPHA:return AL.COMPRESSED_RGBA_S3TC_DXT1_EXT;case exports.GFXFormat.BC1_SRGB:return AL.COMPRESSED_SRGB_S3TC_DXT1_EXT;case exports.GFXFormat.BC1_SRGB_ALPHA:return AL.COMPRESSED_SRGB_ALPHA_S3TC_DXT1_EXT;case exports.GFXFormat.BC2:return AL.COMPRESSED_RGBA_S3TC_DXT3_EXT;case exports.GFXFormat.BC2_SRGB:return AL.COMPRESSED_SRGB_ALPHA_S3TC_DXT3_EXT;case exports.GFXFormat.BC3:return AL.COMPRESSED_RGBA_S3TC_DXT5_EXT;case exports.GFXFormat.BC3_SRGB:return AL.COMPRESSED_SRGB_ALPHA_S3TC_DXT5_EXT;case exports.GFXFormat.ETC_RGB8:return AL.COMPRESSED_RGB_ETC1_WEBGL;case exports.GFXFormat.ETC2_RGB8:return AL.COMPRESSED_RGB8_ETC2;case exports.GFXFormat.ETC2_SRGB8:return AL.COMPRESSED_SRGB8_ETC2;case exports.GFXFormat.ETC2_RGB8_A1:return AL.COMPRESSED_RGB8_PUNCHTHROUGH_ALPHA1_ETC2;case exports.GFXFormat.ETC2_SRGB8_A1:return AL.COMPRESSED_SRGB8_PUNCHTHROUGH_ALPHA1_ETC2;case exports.GFXFormat.ETC2_RGBA8:return AL.COMPRESSED_RGBA8_ETC2_EAC;case exports.GFXFormat.ETC2_SRGB8_A8:return AL.COMPRESSED_SRGB8_ALPHA8_ETC2_EAC;case exports.GFXFormat.EAC_R11:return AL.COMPRESSED_R11_EAC;case exports.GFXFormat.EAC_R11SN:return AL.COMPRESSED_SIGNED_R11_EAC;case exports.GFXFormat.EAC_RG11:return AL.COMPRESSED_RG11_EAC;case exports.GFXFormat.EAC_RG11SN:return AL.COMPRESSED_SIGNED_RG11_EAC;case exports.GFXFormat.PVRTC_RGB2:return AL.COMPRESSED_RGB_PVRTC_2BPPV1_IMG;case exports.GFXFormat.PVRTC_RGBA2:return AL.COMPRESSED_RGBA_PVRTC_2BPPV1_IMG;case exports.GFXFormat.PVRTC_RGB4:return AL.COMPRESSED_RGB_PVRTC_4BPPV1_IMG;case exports.GFXFormat.PVRTC_RGBA4:return AL.COMPRESSED_RGBA_PVRTC_4BPPV1_IMG;default:return console.error("Unsupported GFXFormat, convert to WebGL internal format failed."),t.RGBA}}function FL(e,t){switch(e){case exports.GFXFormat.A8:return t.ALPHA;case exports.GFXFormat.L8:return t.LUMINANCE;case exports.GFXFormat.LA8:return t.LUMINANCE_ALPHA;case exports.GFXFormat.RGB8:case exports.GFXFormat.RGB16F:case exports.GFXFormat.RGB32F:return t.RGB;case exports.GFXFormat.RGBA8:case exports.GFXFormat.RGBA16F:case exports.GFXFormat.RGBA32F:return t.RGBA;case exports.GFXFormat.R5G6B5:return t.RGB;case exports.GFXFormat.RGB5A1:case exports.GFXFormat.RGBA4:return t.RGBA;case exports.GFXFormat.D16:return t.DEPTH_COMPONENT;case exports.GFXFormat.D16S8:return t.DEPTH_STENCIL;case exports.GFXFormat.D24:return t.DEPTH_COMPONENT;case exports.GFXFormat.D24S8:return t.DEPTH_STENCIL;case exports.GFXFormat.D32F:return t.DEPTH_COMPONENT;case exports.GFXFormat.D32F_S8:return t.DEPTH_STENCIL;case exports.GFXFormat.BC1:return AL.COMPRESSED_RGB_S3TC_DXT1_EXT;case exports.GFXFormat.BC1_ALPHA:return AL.COMPRESSED_RGBA_S3TC_DXT1_EXT;case exports.GFXFormat.BC1_SRGB:return AL.COMPRESSED_SRGB_S3TC_DXT1_EXT;case exports.GFXFormat.BC1_SRGB_ALPHA:return AL.COMPRESSED_SRGB_ALPHA_S3TC_DXT1_EXT;case exports.GFXFormat.BC2:return AL.COMPRESSED_RGBA_S3TC_DXT3_EXT;case exports.GFXFormat.BC2_SRGB:return AL.COMPRESSED_SRGB_ALPHA_S3TC_DXT3_EXT;case exports.GFXFormat.BC3:return AL.COMPRESSED_RGBA_S3TC_DXT5_EXT;case exports.GFXFormat.BC3_SRGB:return AL.COMPRESSED_SRGB_ALPHA_S3TC_DXT5_EXT;case exports.GFXFormat.ETC_RGB8:return AL.COMPRESSED_RGB_ETC1_WEBGL;case exports.GFXFormat.ETC2_RGB8:return AL.COMPRESSED_RGB8_ETC2;case exports.GFXFormat.ETC2_SRGB8:return AL.COMPRESSED_SRGB8_ETC2;case exports.GFXFormat.ETC2_RGB8_A1:return AL.COMPRESSED_RGB8_PUNCHTHROUGH_ALPHA1_ETC2;case exports.GFXFormat.ETC2_SRGB8_A1:return AL.COMPRESSED_SRGB8_PUNCHTHROUGH_ALPHA1_ETC2;case exports.GFXFormat.ETC2_RGBA8:return AL.COMPRESSED_RGBA8_ETC2_EAC;case exports.GFXFormat.ETC2_SRGB8_A8:return AL.COMPRESSED_SRGB8_ALPHA8_ETC2_EAC;case exports.GFXFormat.EAC_R11:return AL.COMPRESSED_R11_EAC;case exports.GFXFormat.EAC_R11SN:return AL.COMPRESSED_SIGNED_R11_EAC;case exports.GFXFormat.EAC_RG11:return AL.COMPRESSED_RG11_EAC;case exports.GFXFormat.EAC_RG11SN:return AL.COMPRESSED_SIGNED_RG11_EAC;case exports.GFXFormat.PVRTC_RGB2:return AL.COMPRESSED_RGB_PVRTC_2BPPV1_IMG;case exports.GFXFormat.PVRTC_RGBA2:return AL.COMPRESSED_RGBA_PVRTC_2BPPV1_IMG;case exports.GFXFormat.PVRTC_RGB4:return AL.COMPRESSED_RGB_PVRTC_4BPPV1_IMG;case exports.GFXFormat.PVRTC_RGBA4:return AL.COMPRESSED_RGBA_PVRTC_4BPPV1_IMG;default:return console.error("Unsupported GFXFormat, convert to WebGL format failed."),t.RGBA}}function ML(e,t){switch(e){case exports.GFXType.BOOL:return t.BOOL;case exports.GFXType.BOOL2:return t.BOOL_VEC2;case exports.GFXType.BOOL3:return t.BOOL_VEC3;case exports.GFXType.BOOL4:return t.BOOL_VEC4;case exports.GFXType.INT:return t.INT;case exports.GFXType.INT2:return t.INT_VEC2;case exports.GFXType.INT3:return t.INT_VEC3;case exports.GFXType.INT4:return t.INT_VEC4;case exports.GFXType.UINT:return t.UNSIGNED_INT;case exports.GFXType.FLOAT:return t.FLOAT;case exports.GFXType.FLOAT2:return t.FLOAT_VEC2;case exports.GFXType.FLOAT3:return t.FLOAT_VEC3;case exports.GFXType.FLOAT4:return t.FLOAT_VEC4;case exports.GFXType.MAT2:return t.FLOAT_MAT2;case exports.GFXType.MAT3:return t.FLOAT_MAT3;case exports.GFXType.MAT4:return t.FLOAT_MAT4;case exports.GFXType.SAMPLER2D:return t.SAMPLER_2D;case exports.GFXType.SAMPLER_CUBE:return t.SAMPLER_CUBE;default:return console.error("Unsupported GLType, convert to GL type failed."),exports.GFXType.UNKNOWN}}function IL(e,t){switch(e){case t.BOOL:return exports.GFXType.BOOL;case t.BOOL_VEC2:return exports.GFXType.BOOL2;case t.BOOL_VEC3:return exports.GFXType.BOOL3;case t.BOOL_VEC4:return exports.GFXType.BOOL4;case t.INT:return exports.GFXType.INT;case t.INT_VEC2:return exports.GFXType.INT2;case t.INT_VEC3:return exports.GFXType.INT3;case t.INT_VEC4:return exports.GFXType.INT4;case t.UNSIGNED_INT:return exports.GFXType.UINT;case t.FLOAT:return exports.GFXType.FLOAT;case t.FLOAT_VEC2:return exports.GFXType.FLOAT2;case t.FLOAT_VEC3:return exports.GFXType.FLOAT3;case t.FLOAT_VEC4:return exports.GFXType.FLOAT4;case t.FLOAT_MAT2:return exports.GFXType.MAT2;case t.FLOAT_MAT3:return exports.GFXType.MAT3;case t.FLOAT_MAT4:return exports.GFXType.MAT4;case t.SAMPLER_2D:return exports.GFXType.SAMPLER2D;case t.SAMPLER_CUBE:return exports.GFXType.SAMPLER_CUBE;default:return console.error("Unsupported GLType, convert to GFXType failed."),exports.GFXType.UNKNOWN}}function PL(e,t){switch(e){case t.BOOL:return 4;case t.BOOL_VEC2:return 8;case t.BOOL_VEC3:return 12;case t.BOOL_VEC4:return 16;case t.INT:return 4;case t.INT_VEC2:return 8;case t.INT_VEC3:return 12;case t.INT_VEC4:return 16;case t.UNSIGNED_INT:case t.FLOAT:return 4;case t.FLOAT_VEC2:return 8;case t.FLOAT_VEC3:return 12;case t.FLOAT_VEC4:case t.FLOAT_MAT2:return 16;case t.FLOAT_MAT3:return 36;case t.FLOAT_MAT4:return 64;case t.SAMPLER_2D:case t.SAMPLER_CUBE:return 4;default:return console.error("Unsupported GLType, get type failed."),0}}function LL(e,t){switch(e){case t.FLOAT_MAT2:return 2;case t.FLOAT_MAT3:return 3;case t.FLOAT_MAT4:return 4;default:return 1}}!function(e){e[e.RGBA16F_EXT=34842]="RGBA16F_EXT",e[e.RGB16F_EXT=34843]="RGB16F_EXT",e[e.RGBA32F_EXT=34836]="RGBA32F_EXT",e[e.FRAMEBUFFER_ATTACHMENT_COMPONENT_TYPE_EXT=33297]="FRAMEBUFFER_ATTACHMENT_COMPONENT_TYPE_EXT",e[e.UNSIGNED_NORMALIZED_EXT=35863]="UNSIGNED_NORMALIZED_EXT",e[e.UNSIGNED_INT_24_8_WEBGL=34042]="UNSIGNED_INT_24_8_WEBGL",e[e.HALF_FLOAT_OES=36193]="HALF_FLOAT_OES",e[e.COMPRESSED_RGB_S3TC_DXT1_EXT=33776]="COMPRESSED_RGB_S3TC_DXT1_EXT",e[e.COMPRESSED_RGBA_S3TC_DXT1_EXT=33777]="COMPRESSED_RGBA_S3TC_DXT1_EXT",e[e.COMPRESSED_RGBA_S3TC_DXT3_EXT=33778]="COMPRESSED_RGBA_S3TC_DXT3_EXT",e[e.COMPRESSED_RGBA_S3TC_DXT5_EXT=33779]="COMPRESSED_RGBA_S3TC_DXT5_EXT",e[e.COMPRESSED_SRGB_S3TC_DXT1_EXT=35916]="COMPRESSED_SRGB_S3TC_DXT1_EXT",e[e.COMPRESSED_SRGB_ALPHA_S3TC_DXT1_EXT=35917]="COMPRESSED_SRGB_ALPHA_S3TC_DXT1_EXT",e[e.COMPRESSED_SRGB_ALPHA_S3TC_DXT3_EXT=35918]="COMPRESSED_SRGB_ALPHA_S3TC_DXT3_EXT",e[e.COMPRESSED_SRGB_ALPHA_S3TC_DXT5_EXT=35919]="COMPRESSED_SRGB_ALPHA_S3TC_DXT5_EXT",e[e.COMPRESSED_RGB_PVRTC_4BPPV1_IMG=35840]="COMPRESSED_RGB_PVRTC_4BPPV1_IMG",e[e.COMPRESSED_RGB_PVRTC_2BPPV1_IMG=35841]="COMPRESSED_RGB_PVRTC_2BPPV1_IMG",e[e.COMPRESSED_RGBA_PVRTC_4BPPV1_IMG=35842]="COMPRESSED_RGBA_PVRTC_4BPPV1_IMG",e[e.COMPRESSED_RGBA_PVRTC_2BPPV1_IMG=35843]="COMPRESSED_RGBA_PVRTC_2BPPV1_IMG",e[e.COMPRESSED_RGB_ETC1_WEBGL=36196]="COMPRESSED_RGB_ETC1_WEBGL",e[e.COMPRESSED_R11_EAC=37488]="COMPRESSED_R11_EAC",e[e.COMPRESSED_SIGNED_R11_EAC=37489]="COMPRESSED_SIGNED_R11_EAC",e[e.COMPRESSED_RG11_EAC=37490]="COMPRESSED_RG11_EAC",e[e.COMPRESSED_SIGNED_RG11_EAC=37491]="COMPRESSED_SIGNED_RG11_EAC",e[e.COMPRESSED_RGB8_ETC2=37492]="COMPRESSED_RGB8_ETC2",e[e.COMPRESSED_SRGB8_ETC2=37493]="COMPRESSED_SRGB8_ETC2",e[e.COMPRESSED_RGB8_PUNCHTHROUGH_ALPHA1_ETC2=37494]="COMPRESSED_RGB8_PUNCHTHROUGH_ALPHA1_ETC2",e[e.COMPRESSED_SRGB8_PUNCHTHROUGH_ALPHA1_ETC2=37495]="COMPRESSED_SRGB8_PUNCHTHROUGH_ALPHA1_ETC2",e[e.COMPRESSED_RGBA8_ETC2_EAC=37496]="COMPRESSED_RGBA8_ETC2_EAC",e[e.COMPRESSED_SRGB8_ALPHA8_ETC2_EAC=37497]="COMPRESSED_SRGB8_ALPHA8_ETC2_EAC"}(AL||(AL={}));var DL,NL=[512,513,514,515,516,517,518,519],zL=[0,7680,7681,7682,7683,5386,34055,34056],BL=[32774,32778,32779,32774,32774],GL=[0,1,770,772,771,773,768,774,769,775,776,32769,32770,32771,32772];!function(e){e[e.BEGIN_RENDER_PASS=0]="BEGIN_RENDER_PASS",e[e.END_RENDER_PASS=1]="END_RENDER_PASS",e[e.BIND_STATES=2]="BIND_STATES",e[e.DRAW=3]="DRAW",e[e.UPDATE_BUFFER=4]="UPDATE_BUFFER",e[e.COPY_BUFFER_TO_TEXTURE=5]="COPY_BUFFER_TO_TEXTURE",e[e.COUNT=6]="COUNT"}(DL||(DL={}));var UL=function e(t){Z(this,e),this.cmdType=void 0,this.refCount=0,this.cmdType=t},XL=function(e){function t(){var e;return Z(this,t),(e=re(this,te(t).call(this,DL.BEGIN_RENDER_PASS))).gpuFramebuffer=null,e.renderArea={x:0,y:0,width:0,height:0},e.clearFlag=exports.GFXClearFlag.NONE,e.clearColors=[],e.clearDepth=1,e.clearStencil=0,e}return ee(t,UL),J(t,[{key:"clear",value:function(){this.gpuFramebuffer=null,this.clearColors.length=0}}]),t}(),VL=function(e){function t(){var e;return Z(this,t),(e=re(this,te(t).call(this,DL.BIND_STATES))).gpuPipelineState=null,e.gpuBindingLayout=null,e.gpuInputAssembler=null,e.viewport=null,e.scissor=null,e.lineWidth=null,e.depthBias=null,e.blendConstants=null,e.depthBounds=null,e.stencilWriteMask=null,e.stencilCompareMask=null,e}return ee(t,UL),J(t,[{key:"clear",value:function(){this.gpuPipelineState=null,this.gpuBindingLayout=null,this.gpuInputAssembler=null,this.viewport=null,this.scissor=null,this.lineWidth=null,this.depthBias=null,this.blendConstants=null,this.depthBounds=null,this.stencilWriteMask=null,this.stencilCompareMask=null}}]),t}(),HL=function(e){function t(){var e;return Z(this,t),(e=re(this,te(t).call(this,DL.DRAW))).drawInfo={vertexCount:0,firstVertex:0,indexCount:0,firstIndex:0,vertexOffset:0,instanceCount:0,firstInstance:0},e}return ee(t,UL),J(t,[{key:"clear",value:function(){}}]),t}(),WL=function(e){function t(){var e;return Z(this,t),(e=re(this,te(t).call(this,DL.UPDATE_BUFFER))).gpuBuffer=null,e.buffer=null,e.offset=0,e.size=0,e}return ee(t,UL),J(t,[{key:"clear",value:function(){this.gpuBuffer=null,this.buffer=null}}]),t}(),jL=function(e){function t(){var e;return Z(this,t),(e=re(this,te(t).call(this,DL.COPY_BUFFER_TO_TEXTURE))).gpuBuffer=null,e.gpuTexture=null,e.dstLayout=null,e.regions=[],e}return ee(t,UL),J(t,[{key:"clear",value:function(){this.gpuBuffer=null,this.gpuTexture=null,this.dstLayout=null,this.regions.length=0}}]),t}(),qL=function(){function e(){Z(this,e),this.cmds=new Eo(1),this.beginRenderPassCmds=new Eo(1),this.bindStatesCmds=new Eo(1),this.drawCmds=new Eo(1),this.updateBufferCmds=new Eo(1),this.copyBufferToTextureCmds=new Eo(1)}return J(e,[{key:"clearCmds",value:function(e){this.beginRenderPassCmds.length&&(e.beginRenderPassCmdPool.freeCmds(this.beginRenderPassCmds),this.beginRenderPassCmds.clear()),this.bindStatesCmds.length&&(e.bindStatesCmdPool.freeCmds(this.bindStatesCmds),this.bindStatesCmds.clear()),this.drawCmds.length&&(e.drawCmdPool.freeCmds(this.drawCmds),this.drawCmds.clear()),this.updateBufferCmds.length&&(e.updateBufferCmdPool.freeCmds(this.updateBufferCmds),this.updateBufferCmds.clear()),this.copyBufferToTextureCmds.length&&(e.copyBufferToTextureCmdPool.freeCmds(this.copyBufferToTextureCmds),this.copyBufferToTextureCmds.clear()),this.cmds.clear()}}]),e}();function YL(e,t,i,n,r){if(t.usage&exports.GFXBufferUsageBit.UNIFORM)ArrayBuffer.isView(i)?t.vf32.set(i,n/Float32Array.BYTES_PER_ELEMENT):t.vf32.set(new Float32Array(i),n/Float32Array.BYTES_PER_ELEMENT);else if(t.usage&exports.GFXBufferUsageBit.INDIRECT)t.indirects=i.drawInfos;else{var a=i,o=e.gl,s=e.stateCache;switch(t.glTarget){case o.ARRAY_BUFFER:e.useVAO&&s.glVAO&&(e.OES_vertex_array_object.bindVertexArrayOES(null),s.glVAO=null),e.stateCache.glArrayBuffer!==t.glBuffer&&(o.bindBuffer(o.ARRAY_BUFFER,t.glBuffer),e.stateCache.glArrayBuffer=t.glBuffer);break;case o.ELEMENT_ARRAY_BUFFER:e.useVAO&&s.glVAO&&(e.OES_vertex_array_object.bindVertexArrayOES(null),s.glVAO=null),e.stateCache.glElementArrayBuffer!==t.glBuffer&&(o.bindBuffer(o.ELEMENT_ARRAY_BUFFER,t.glBuffer),e.stateCache.glElementArrayBuffer=t.glBuffer);break;default:return void console.error("Unsupported GFXBufferType, update buffer failed.")}r===a.byteLength?o.bufferSubData(t.glTarget,n,a):o.bufferSubData(t.glTarget,n,a.slice(0,r))}}var KL={gpuInputAssembler:null,gpuShader:null,glPrimitive:0};function ZL(e,t,i,n,r,a,o){KL.gpuInputAssembler=null,KL.gpuShader=null;var s=e.gl,l=e.stateCache,u=0;if(t){l.glFramebuffer!==t.glFramebuffer&&(s.bindFramebuffer(s.FRAMEBUFFER,t.glFramebuffer),l.glFramebuffer=t.glFramebuffer),l.viewport.left===i.x&&l.viewport.top===i.y&&l.viewport.width===i.width&&l.viewport.height===i.height||(s.viewport(i.x,i.y,i.width,i.height),l.viewport.left=i.x,l.viewport.top=i.y,l.viewport.width=i.width,l.viewport.height=i.height),l.scissorRect.x===i.x&&l.scissorRect.y===i.y&&l.scissorRect.width===i.width&&l.scissorRect.height===i.height||(s.scissor(i.x,i.y,i.width,i.height),l.scissorRect.x=i.x,l.scissorRect.y=i.y,l.scissorRect.width=i.width,l.scissorRect.height=i.height);var c=t.gpuRenderPass,h=r.length;e.WEBGL_draw_buffers||(h=1);for(var p=0;p<h;++p){var _=c.colorAttachments[p];if(_.format!==exports.GFXFormat.UNKNOWN)switch(_.loadOp){case exports.GFXLoadOp.LOAD:break;case exports.GFXLoadOp.CLEAR:if(n&exports.GFXClearFlag.COLOR){l.bs.targets[0].blendColorMask!==exports.GFXColorMask.ALL&&s.colorMask(!0,!0,!0,!0);var f=r[0];s.clearColor(f.r,f.g,f.b,f.a),u|=s.COLOR_BUFFER_BIT}break;case exports.GFXLoadOp.DISCARD:}}if(c.depthStencilAttachment&&c.depthStencilAttachment.format!==exports.GFXFormat.UNKNOWN){switch(c.depthStencilAttachment.depthLoadOp){case exports.GFXLoadOp.LOAD:break;case exports.GFXLoadOp.CLEAR:n&exports.GFXClearFlag.DEPTH&&(l.dss.depthWrite||s.depthMask(!0),s.clearDepth(a),u|=s.DEPTH_BUFFER_BIT);break;case exports.GFXLoadOp.DISCARD:}if(yr[c.depthStencilAttachment.format].hasStencil)switch(c.depthStencilAttachment.stencilLoadOp){case exports.GFXLoadOp.LOAD:break;case exports.GFXLoadOp.CLEAR:n&exports.GFXClearFlag.STENCIL&&(l.dss.stencilWriteMaskFront||s.stencilMaskSeparate(s.FRONT,65535),l.dss.stencilWriteMaskBack||s.stencilMaskSeparate(s.BACK,65535),s.clearStencil(o),u|=s.STENCIL_BUFFER_BIT);break;case exports.GFXLoadOp.DISCARD:}}if(u&&s.clear(u),u&s.COLOR_BUFFER_BIT){var d=l.bs.targets[0].blendColorMask;if(d!==exports.GFXColorMask.ALL){var m=(d&exports.GFXColorMask.R)!==exports.GFXColorMask.NONE,v=(d&exports.GFXColorMask.G)!==exports.GFXColorMask.NONE,y=(d&exports.GFXColorMask.B)!==exports.GFXColorMask.NONE,g=(d&exports.GFXColorMask.A)!==exports.GFXColorMask.NONE;s.colorMask(m,v,y,g)}}u&s.DEPTH_BUFFER_BIT&&!l.dss.depthWrite&&s.depthMask(!1),u&s.STENCIL_BUFFER_BIT&&(l.dss.stencilWriteMaskFront||s.stencilMaskSeparate(s.FRONT,0),l.dss.stencilWriteMaskBack||s.stencilMaskSeparate(s.BACK,0))}}function QL(e,t,i,n,r,a,o,s,l,u,c,p){var _,f,d,m=e.gl,v=e.stateCache,y=!1,g=null;if(t){if(KL.glPrimitive=t.glPrimitive,t.gpuShader){var x=t.gpuShader.glProgram;v.glProgram!==x&&(m.useProgram(x),v.glProgram=x,y=!0),KL.gpuShader=g=t.gpuShader}var b=t.rs;if(b){if(v.rs.cullMode!==b.cullMode){switch(b.cullMode){case exports.GFXCullMode.NONE:m.disable(m.CULL_FACE);break;case exports.GFXCullMode.FRONT:m.enable(m.CULL_FACE),m.cullFace(m.FRONT);break;case exports.GFXCullMode.BACK:m.enable(m.CULL_FACE),m.cullFace(m.BACK)}v.rs.cullMode=b.cullMode}var T=e.reverseCW?!b.isFrontFaceCCW:b.isFrontFaceCCW;v.rs.isFrontFaceCCW!==T&&(m.frontFace(T?m.CCW:m.CW),v.rs.isFrontFaceCCW=T),v.rs.depthBias===b.depthBias&&v.rs.depthBiasSlop===b.depthBiasSlop||(m.polygonOffset(b.depthBias,b.depthBiasSlop),v.rs.depthBias=b.depthBias,v.rs.depthBiasSlop=b.depthBiasSlop),v.rs.lineWidth!==b.lineWidth&&(m.lineWidth(b.lineWidth),v.rs.lineWidth=b.lineWidth)}var S=t.dss;S&&(v.dss.depthTest!==S.depthTest&&(S.depthTest?m.enable(m.DEPTH_TEST):m.disable(m.DEPTH_TEST),v.dss.depthTest=S.depthTest),v.dss.depthWrite!==S.depthWrite&&(m.depthMask(S.depthWrite),v.dss.depthWrite=S.depthWrite),v.dss.depthFunc!==S.depthFunc&&(m.depthFunc(NL[S.depthFunc]),v.dss.depthFunc=S.depthFunc),v.dss.stencilTestFront===S.stencilTestFront&&v.dss.stencilTestBack===S.stencilTestBack||(S.stencilTestFront||S.stencilTestBack?m.enable(m.STENCIL_TEST):m.disable(m.STENCIL_TEST),v.dss.stencilTestFront=S.stencilTestFront,v.dss.stencilTestBack=S.stencilTestBack),v.dss.stencilFuncFront===S.stencilFuncFront&&v.dss.stencilRefFront===S.stencilRefFront&&v.dss.stencilReadMaskFront===S.stencilReadMaskFront||(m.stencilFuncSeparate(m.FRONT,NL[S.stencilFuncFront],S.stencilRefFront,S.stencilReadMaskFront),v.dss.stencilFuncFront=S.stencilFuncFront,v.dss.stencilRefFront=S.stencilRefFront,v.dss.stencilReadMaskFront=S.stencilReadMaskFront),v.dss.stencilFailOpFront===S.stencilFailOpFront&&v.dss.stencilZFailOpFront===S.stencilZFailOpFront&&v.dss.stencilPassOpFront===S.stencilPassOpFront||(m.stencilOpSeparate(m.FRONT,zL[S.stencilFailOpFront],zL[S.stencilZFailOpFront],zL[S.stencilPassOpFront]),v.dss.stencilFailOpFront=S.stencilFailOpFront,v.dss.stencilZFailOpFront=S.stencilZFailOpFront,v.dss.stencilPassOpFront=S.stencilPassOpFront),v.dss.stencilWriteMaskFront!==S.stencilWriteMaskFront&&(m.stencilMaskSeparate(m.FRONT,S.stencilWriteMaskFront),v.dss.stencilWriteMaskFront=S.stencilWriteMaskFront),v.dss.stencilFuncBack===S.stencilFuncBack&&v.dss.stencilRefBack===S.stencilRefBack&&v.dss.stencilReadMaskBack===S.stencilReadMaskBack||(m.stencilFuncSeparate(m.BACK,NL[S.stencilFuncBack],S.stencilRefBack,S.stencilReadMaskBack),v.dss.stencilFuncBack=S.stencilFuncBack,v.dss.stencilRefBack=S.stencilRefBack,v.dss.stencilReadMaskBack=S.stencilReadMaskBack),v.dss.stencilFailOpBack===S.stencilFailOpBack&&v.dss.stencilZFailOpBack===S.stencilZFailOpBack&&v.dss.stencilPassOpBack===S.stencilPassOpBack||(m.stencilOpSeparate(m.BACK,zL[S.stencilFailOpBack],zL[S.stencilZFailOpBack],zL[S.stencilPassOpBack]),v.dss.stencilFailOpBack=S.stencilFailOpBack,v.dss.stencilZFailOpBack=S.stencilZFailOpBack,v.dss.stencilPassOpBack=S.stencilPassOpBack),v.dss.stencilWriteMaskBack!==S.stencilWriteMaskBack&&(m.stencilMaskSeparate(m.BACK,S.stencilWriteMaskBack),v.dss.stencilWriteMaskBack=S.stencilWriteMaskBack));var E=t.bs;if(E){v.bs.isA2C!==E.isA2C&&(E.isA2C?m.enable(m.SAMPLE_ALPHA_TO_COVERAGE):m.disable(m.SAMPLE_ALPHA_TO_COVERAGE),v.bs.isA2C=E.isA2C),v.bs.blendColor[0]===E.blendColor[0]&&v.bs.blendColor[1]===E.blendColor[1]&&v.bs.blendColor[2]===E.blendColor[2]&&v.bs.blendColor[3]===E.blendColor[3]||(m.blendColor(E.blendColor[0],E.blendColor[1],E.blendColor[2],E.blendColor[3]),v.bs.blendColor[0]=E.blendColor[0],v.bs.blendColor[1]=E.blendColor[1],v.bs.blendColor[2]=E.blendColor[2],v.bs.blendColor[3]=E.blendColor[3]);var w=E.targets[0],C=v.bs.targets[0];C.blend!==w.blend&&(w.blend?m.enable(m.BLEND):m.disable(m.BLEND),C.blend=w.blend),C.blendEq===w.blendEq&&C.blendAlphaEq===w.blendAlphaEq||(m.blendEquationSeparate(BL[w.blendEq],BL[w.blendAlphaEq]),C.blendEq=w.blendEq,C.blendAlphaEq=w.blendAlphaEq),C.blendSrc===w.blendSrc&&C.blendDst===w.blendDst&&C.blendSrcAlpha===w.blendSrcAlpha&&C.blendDstAlpha===w.blendDstAlpha||(m.blendFuncSeparate(GL[w.blendSrc],GL[w.blendDst],GL[w.blendSrcAlpha],GL[w.blendDstAlpha]),C.blendSrc=w.blendSrc,C.blendDst=w.blendDst,C.blendSrcAlpha=w.blendSrcAlpha,C.blendDstAlpha=w.blendDstAlpha),C.blendColorMask!==w.blendColorMask&&(m.colorMask((w.blendColorMask&exports.GFXColorMask.R)!==exports.GFXColorMask.NONE,(w.blendColorMask&exports.GFXColorMask.G)!==exports.GFXColorMask.NONE,(w.blendColorMask&exports.GFXColorMask.B)!==exports.GFXColorMask.NONE,(w.blendColorMask&exports.GFXColorMask.A)!==exports.GFXColorMask.NONE),C.blendColorMask=w.blendColorMask)}}if(i&&g)for(var A=i.gpuBindings.length,O=0;O<A;O++){var k=i.gpuBindings[O];switch(k.type){case exports.GFXBindingType.UNIFORM_BUFFER:if(k.gpuBuffer&&k.gpuBuffer.buffer){for(var R=null,F=g.glBlocks.length,M=0;M<F;M++){var I=g.glBlocks[M];if(I.binding===k.binding){R=I;break}}if(R&&k.gpuBuffer.vf32)for(var P=R.glActiveUniforms.length,L=0;L<P;L++){var D=R.glActiveUniforms[L];switch(D.glType){case m.BOOL:case m.INT:for(var N=0;N<D.array.length;++N){var z=D.begin+N;if(k.gpuBuffer.vf32[z]!==D.array[N]){for(var B=N,G=D.begin+N;B<D.array.length;++B,++G)D.array[B]=k.gpuBuffer.vf32[G];m.uniform1iv(D.glLoc,D.array);break}}break;case m.BOOL_VEC2:case m.INT_VEC2:for(var U=0;U<D.array.length;++U){var X=D.begin+U;if(k.gpuBuffer.vf32[X]!==D.array[U]){for(var V=U,H=D.begin+U;V<D.array.length;++V,++H)D.array[V]=k.gpuBuffer.vf32[H];m.uniform2iv(D.glLoc,D.array);break}}break;case m.BOOL_VEC3:case m.INT_VEC3:for(var W=0;W<D.array.length;++W){var j=D.begin+W;if(k.gpuBuffer.vf32[j]!==D.array[W]){for(var q=W,Y=D.begin+W;q<D.array.length;++q,++Y)D.array[q]=k.gpuBuffer.vf32[Y];m.uniform3iv(D.glLoc,D.array);break}}break;case m.BOOL_VEC4:case m.INT_VEC4:for(var K=0;K<D.array.length;++K){var Z=D.begin+K;if(k.gpuBuffer.vf32[Z]!==D.array[K]){for(var Q=K,J=D.begin+K;Q<D.array.length;++Q,++J)D.array[Q]=k.gpuBuffer.vf32[J];m.uniform4iv(D.glLoc,D.array);break}}break;case m.FLOAT:for(var $=0;$<D.array.length;++$){var ee=D.begin+$;if(k.gpuBuffer.vf32[ee]!==D.array[$]){for(var te=$,ie=D.begin+$;te<D.array.length;++te,++ie)D.array[te]=k.gpuBuffer.vf32[ie];m.uniform1fv(D.glLoc,D.array);break}}break;case m.FLOAT_VEC2:for(var ne=0;ne<D.array.length;++ne){var re=D.begin+ne;if(k.gpuBuffer.vf32[re]!==D.array[ne]){for(var ae=ne,oe=D.begin+ne;ae<D.array.length;++ae,++oe)D.array[ae]=k.gpuBuffer.vf32[oe];m.uniform2fv(D.glLoc,D.array);break}}break;case m.FLOAT_VEC3:for(var se=0;se<D.array.length;++se){var le=D.begin+se;if(k.gpuBuffer.vf32[le]!==D.array[se]){for(var ue=se,ce=D.begin+se;ue<D.array.length;++ue,++ce)D.array[ue]=k.gpuBuffer.vf32[ce];m.uniform3fv(D.glLoc,D.array);break}}break;case m.FLOAT_VEC4:for(var he=0;he<D.array.length;++he){var pe=D.begin+he;if(k.gpuBuffer.vf32[pe]!==D.array[he]){for(var _e=he,fe=D.begin+he;_e<D.array.length;++_e,++fe)D.array[_e]=k.gpuBuffer.vf32[fe];m.uniform4fv(D.glLoc,D.array);break}}break;case m.FLOAT_MAT2:for(var de=0;de<D.array.length;++de){var me=D.begin+de;if(k.gpuBuffer.vf32[me]!==D.array[de]){for(var ve=de,ye=D.begin+de;ve<D.array.length;++ve,++ye)D.array[ve]=k.gpuBuffer.vf32[ye];m.uniformMatrix2fv(D.glLoc,!1,D.array);break}}break;case m.FLOAT_MAT3:for(var ge=0;ge<D.array.length;++ge){var xe=D.begin+ge;if(k.gpuBuffer.vf32[xe]!==D.array[ge]){for(var be=ge,Te=D.begin+ge;be<D.array.length;++be,++Te)D.array[be]=k.gpuBuffer.vf32[Te];m.uniformMatrix3fv(D.glLoc,!1,D.array);break}}break;case m.FLOAT_MAT4:for(var Se=0;Se<D.array.length;++Se){var Ee=D.begin+Se;if(k.gpuBuffer.vf32[Ee]!==D.array[Se]){for(var we=Se,Ce=D.begin+Se;we<D.array.length;++we,++Ce)D.array[we]=k.gpuBuffer.vf32[Ce];m.uniformMatrix4fv(D.glLoc,!1,D.array);break}}}}}break;case exports.GFXBindingType.SAMPLER:if(k.gpuSampler){for(var Ae=null,Oe=g.glSamplers.length,ke=0;ke<Oe;ke++){var Re=g.glSamplers[ke];if(Re.binding===k.binding){Ae=Re;break}}if(Ae)for(var Fe=Ae.units.length,Me=0;Me<Fe;Me++){var Ie=Ae.units[Me];if(k.gpuTexView&&k.gpuTexView.gpuTexture.size>0){var Pe=k.gpuTexView.gpuTexture,Le=v.glTexUnits[Ie];Le.glTexture!==Pe.glTexture&&(v.texUnit!==Ie&&(m.activeTexture(m.TEXTURE0+Ie),v.texUnit=Ie),Pe.glTexture?m.bindTexture(Pe.glTarget,Pe.glTexture):m.bindTexture(Pe.glTarget,e.nullTex2D.gpuTexture.glTexture),Le.glTexture=Pe.glTexture);var De=k.gpuSampler;Pe.isPowerOf2?(_=De.glWrapS,f=De.glWrapT):(_=m.CLAMP_TO_EDGE,f=m.CLAMP_TO_EDGE),d=Pe.isPowerOf2?Pe.mipLevel<=1&&(De.glMinFilter===m.LINEAR_MIPMAP_NEAREST||De.glMinFilter===m.LINEAR_MIPMAP_LINEAR)?m.LINEAR:De.glMinFilter:De.glMinFilter===m.LINEAR||De.glMinFilter===m.LINEAR_MIPMAP_NEAREST||De.glMinFilter===m.LINEAR_MIPMAP_LINEAR?m.LINEAR:m.NEAREST,Pe.glWrapS!==_&&(v.texUnit!==Ie&&(m.activeTexture(m.TEXTURE0+Ie),v.texUnit=Ie),m.texParameteri(Pe.glTarget,m.TEXTURE_WRAP_S,_),Pe.glWrapS=_),Pe.glWrapT!==f&&(v.texUnit!==Ie&&(m.activeTexture(m.TEXTURE0+Ie),v.texUnit=Ie),m.texParameteri(Pe.glTarget,m.TEXTURE_WRAP_T,f),Pe.glWrapT=f),Pe.glMinFilter!==d&&(v.texUnit!==Ie&&(m.activeTexture(m.TEXTURE0+Ie),v.texUnit=Ie),m.texParameteri(Pe.glTarget,m.TEXTURE_MIN_FILTER,d),Pe.glMinFilter=d),Pe.glMagFilter!==De.glMagFilter&&(v.texUnit!==Ie&&(m.activeTexture(m.TEXTURE0+Ie),v.texUnit=Ie),m.texParameteri(Pe.glTarget,m.TEXTURE_MAG_FILTER,De.glMagFilter),Pe.glMagFilter=De.glMagFilter)}}}else h("Not found sampler on binding unit ".concat(k.binding,", name ").concat(k.name))}}if(n&&g&&(y||KL.gpuInputAssembler!==n)){KL.gpuInputAssembler=n;var Ne=e.ANGLE_instanced_arrays;if(e.useVAO){var ze=e.OES_vertex_array_object,Be=n.glVAOs.get(g.glProgram);if(!Be){var Ge;Be=ze.createVertexArrayOES(),n.glVAOs.set(g.glProgram,Be),ze.bindVertexArrayOES(Be),m.bindBuffer(m.ARRAY_BUFFER,null),m.bindBuffer(m.ELEMENT_ARRAY_BUFFER,null);for(var Ue=g.glInputs.length,Xe=0;Xe<Ue;Xe++){var Ve=g.glInputs[Xe];Ge=null;for(var He=n.glAttribs.length,We=0;We<He;We++){var je=n.glAttribs[We];if(je.name===Ve.name){Ge=je;break}}if(Ge){m.bindBuffer(m.ARRAY_BUFFER,Ge.glBuffer);for(var qe=0;qe<Ge.componentCount;++qe){var Ye=Ve.glLoc+qe,Ke=Ge.offset+Ge.size*qe;m.enableVertexAttribArray(Ye),v.glCurrentAttribLocs[Ye]=!0,m.vertexAttribPointer(Ye,Ge.count,Ge.glType,Ge.isNormalized,Ge.stride,Ke),Ne&&Ne.vertexAttribDivisorANGLE(Ye,Ge.isInstanced?1:0)}}}var Ze=n.gpuIndexBuffer;Ze&&m.bindBuffer(m.ELEMENT_ARRAY_BUFFER,Ze.glBuffer),ze.bindVertexArrayOES(null),m.bindBuffer(m.ARRAY_BUFFER,null),m.bindBuffer(m.ELEMENT_ARRAY_BUFFER,null),v.glArrayBuffer=null,v.glElementArrayBuffer=null}v.glVAO!==Be&&(ze.bindVertexArrayOES(Be),v.glVAO=Be)}else{for(var Qe=0;Qe<e.maxVertexAttributes;++Qe)v.glCurrentAttribLocs[Qe]=!1;for(var Je=g.glInputs.length,$e=0;$e<Je;$e++){for(var et=g.glInputs[$e],tt=null,it=n.glAttribs.length,nt=0;nt<it;nt++){var rt=n.glAttribs[nt];if(rt.name===et.name){tt=rt;break}}if(tt){v.glArrayBuffer!==tt.glBuffer&&(m.bindBuffer(m.ARRAY_BUFFER,tt.glBuffer),v.glArrayBuffer=tt.glBuffer);for(var at=0;at<tt.componentCount;++at){var ot=et.glLoc+at,st=tt.offset+tt.size*at;!v.glEnabledAttribLocs[ot]&&ot>=0&&(m.enableVertexAttribArray(ot),v.glEnabledAttribLocs[ot]=!0),v.glCurrentAttribLocs[ot]=!0,m.vertexAttribPointer(ot,tt.count,tt.glType,tt.isNormalized,tt.stride,st),Ne&&Ne.vertexAttribDivisorANGLE(ot,tt.isInstanced?1:0)}}}var lt=n.gpuIndexBuffer;lt&&v.glElementArrayBuffer!==lt.glBuffer&&(m.bindBuffer(m.ELEMENT_ARRAY_BUFFER,lt.glBuffer),v.glElementArrayBuffer=lt.glBuffer);for(var ut=0;ut<e.maxVertexAttributes;++ut)v.glEnabledAttribLocs[ut]!==v.glCurrentAttribLocs[ut]&&(m.disableVertexAttribArray(ut),v.glEnabledAttribLocs[ut]=!1)}}if(t)for(var ct=t.dynamicStates.length,ht=0;ht<ct;ht++){switch(t.dynamicStates[ht]){case exports.GFXDynamicState.VIEWPORT:r&&(v.viewport.left===r.left&&v.viewport.top===r.top&&v.viewport.width===r.width&&v.viewport.height===r.height||(m.viewport(r.left,r.top,r.width,r.height),v.viewport.left=r.left,v.viewport.top=r.top,v.viewport.width=r.width,v.viewport.height=r.height));break;case exports.GFXDynamicState.SCISSOR:a&&(v.scissorRect.x===a.x&&v.scissorRect.y===a.y&&v.scissorRect.width===a.width&&v.scissorRect.height===a.height||(m.scissor(a.x,a.y,a.width,a.height),v.scissorRect.x=a.x,v.scissorRect.y=a.y,v.scissorRect.width=a.width,v.scissorRect.height=a.height));break;case exports.GFXDynamicState.LINE_WIDTH:o&&v.rs.lineWidth!==o&&(m.lineWidth(o),v.rs.lineWidth=o);break;case exports.GFXDynamicState.DEPTH_BIAS:s&&(v.rs.depthBias===s.constantFactor&&v.rs.depthBiasSlop===s.slopeFactor||(m.polygonOffset(s.constantFactor,s.slopeFactor),v.rs.depthBias=s.constantFactor,v.rs.depthBiasSlop=s.slopeFactor));break;case exports.GFXDynamicState.BLEND_CONSTANTS:l&&(v.bs.blendColor[0]===l[0]&&v.bs.blendColor[1]===l[1]&&v.bs.blendColor[2]===l[2]&&v.bs.blendColor[3]===l[3]||(m.blendColor(l[0],l[1],l[2],l[3]),v.bs.blendColor[0]=l[0],v.bs.blendColor[1]=l[1],v.bs.blendColor[2]=l[2],v.bs.blendColor[3]=l[3]));break;case exports.GFXDynamicState.STENCIL_WRITE_MASK:if(c)switch(c.face){case exports.GFXStencilFace.FRONT:v.dss.stencilWriteMaskFront!==c.writeMask&&(m.stencilMaskSeparate(m.FRONT,c.writeMask),v.dss.stencilWriteMaskFront=c.writeMask);break;case exports.GFXStencilFace.BACK:v.dss.stencilWriteMaskBack!==c.writeMask&&(m.stencilMaskSeparate(m.BACK,c.writeMask),v.dss.stencilWriteMaskBack=c.writeMask);break;case exports.GFXStencilFace.ALL:v.dss.stencilWriteMaskFront===c.writeMask&&v.dss.stencilWriteMaskBack===c.writeMask||(m.stencilMask(c.writeMask),v.dss.stencilWriteMaskFront=c.writeMask,v.dss.stencilWriteMaskBack=c.writeMask)}break;case exports.GFXDynamicState.STENCIL_COMPARE_MASK:if(p)switch(p.face){case exports.GFXStencilFace.FRONT:v.dss.stencilRefFront===p.reference&&v.dss.stencilReadMaskFront===p.compareMask||(m.stencilFuncSeparate(m.FRONT,NL[v.dss.stencilFuncFront],p.reference,p.compareMask),v.dss.stencilRefFront=p.reference,v.dss.stencilReadMaskFront=p.compareMask);break;case exports.GFXStencilFace.BACK:v.dss.stencilRefBack===p.reference&&v.dss.stencilReadMaskBack===p.compareMask||(m.stencilFuncSeparate(m.BACK,NL[v.dss.stencilFuncBack],p.reference,p.compareMask),v.dss.stencilRefBack=p.reference,v.dss.stencilReadMaskBack=p.compareMask);break;case exports.GFXStencilFace.ALL:v.dss.stencilRefFront===p.reference&&v.dss.stencilReadMaskFront===p.compareMask&&v.dss.stencilRefBack===p.reference&&v.dss.stencilReadMaskBack===p.compareMask||(m.stencilFunc(NL[v.dss.stencilFuncBack],p.reference,p.compareMask),v.dss.stencilRefFront=p.reference,v.dss.stencilReadMaskFront=p.compareMask,v.dss.stencilRefBack=p.reference,v.dss.stencilReadMaskBack=p.compareMask)}}}}function JL(e,t){var i=e.gl,n=e.ANGLE_instanced_arrays,r=KL.gpuInputAssembler,a=KL.gpuShader,o=KL.glPrimitive;if(r&&a)if(r.gpuIndirectBuffer)for(var s=r.gpuIndirectBuffer.indirects.length,l=0;l<s;l++){var u=r.gpuIndirectBuffer.indirects[l],c=r.gpuIndexBuffer;if(u.instanceCount&&n)if(c&&u.indexCount>-1){var h=u.firstIndex*c.stride;n.drawElementsInstancedANGLE(o,u.indexCount,r.glIndexType,h,u.instanceCount)}else n.drawArraysInstancedANGLE(o,u.firstVertex,u.vertexCount,u.instanceCount);else if(c&&u.indexCount>-1){var p=u.firstIndex*c.stride;i.drawElements(o,u.indexCount,r.glIndexType,p)}else i.drawArrays(o,u.firstVertex,u.vertexCount)}else{var _=r.gpuIndexBuffer;if(t.instanceCount&&n)if(_&&t.indexCount>-1){var f=t.firstIndex*_.stride;n.drawElementsInstancedANGLE(o,t.indexCount,r.glIndexType,f,t.instanceCount)}else n.drawArraysInstancedANGLE(o,t.firstVertex,t.vertexCount,t.instanceCount);else if(_&&t.indexCount>-1){var d=t.firstIndex*_.stride;i.drawElements(o,t.indexCount,r.glIndexType,d)}else i.drawArrays(o,t.firstVertex,t.vertexCount)}}var $L=new Array(DL.COUNT);function eD(e,t){$L.fill(0);for(var i=0;i<t.cmds.length;++i){var n=t.cmds.array[i],r=$L[n]++;switch(n){case DL.BEGIN_RENDER_PASS:var a=t.beginRenderPassCmds.array[r];ZL(e,a.gpuFramebuffer,a.renderArea,a.clearFlag,a.clearColors,a.clearDepth,a.clearStencil);break;case DL.BIND_STATES:var o=t.bindStatesCmds.array[r];QL(e,o.gpuPipelineState,o.gpuBindingLayout,o.gpuInputAssembler,o.viewport,o.scissor,o.lineWidth,o.depthBias,o.blendConstants,o.depthBounds,o.stencilWriteMask,o.stencilCompareMask);break;case DL.DRAW:JL(e,t.drawCmds.array[r].drawInfo);break;case DL.UPDATE_BUFFER:var s=t.updateBufferCmds.array[r];YL(e,s.gpuBuffer,s.buffer,s.offset,s.size);break;case DL.COPY_BUFFER_TO_TEXTURE:var l=t.copyBufferToTextureCmds.array[r];tD(e,[l.gpuBuffer.buffer],l.gpuTexture,l.regions)}}}function tD(e,t,i,n){var r=e.gl,a=e.stateCache.glTexUnits[e.stateCache.texUnit];a.glTexture!==i.glTexture&&(r.bindTexture(i.glTarget,i.glTexture),a.glTexture=i.glTexture);var o=0,s=0,l=1,u=1,c=0,h=yr[i.format].isCompressed;switch(i.glTarget){case r.TEXTURE_2D:for(var p=0;p<n.length;p++){var _=n[p];for(l=_.texExtent.width,u=_.texExtent.height,o=_.texSubres.baseMipLevel;o<_.texSubres.levelCount;++o){var f=t[s++];h?i.glInternalFmt===AL.COMPRESSED_RGB_ETC1_WEBGL||e.noCompressedTexSubImage2D?r.compressedTexImage2D(r.TEXTURE_2D,o,i.glInternalFmt,l,u,0,f):r.compressedTexSubImage2D(r.TEXTURE_2D,o,_.texOffset.x,_.texOffset.y,l,u,i.glFormat,f):r.texSubImage2D(r.TEXTURE_2D,o,_.texOffset.x,_.texOffset.y,l,u,i.glFormat,i.glType,f),l=Math.max(1,l>>1),u=Math.max(1,l>>1)}}break;case r.TEXTURE_CUBE_MAP:for(var d=0;d<n.length;d++){var m=n[d],v=m.texSubres.baseArrayLayer+m.texSubres.layerCount;for(c=m.texSubres.baseArrayLayer;c<v;++c){l=m.texExtent.width,u=m.texExtent.height;var y=m.texSubres.baseMipLevel+m.texSubres.levelCount;for(o=m.texSubres.baseMipLevel;o<y;++o){var g=t[s++];h?i.glInternalFmt!==AL.COMPRESSED_RGB_ETC1_WEBGL?r.compressedTexSubImage2D(r.TEXTURE_CUBE_MAP_POSITIVE_X+c,o,m.texOffset.x,m.texOffset.y,l,u,i.glFormat,g):r.compressedTexImage2D(r.TEXTURE_CUBE_MAP_POSITIVE_X+c,o,i.glInternalFmt,l,u,0,g):r.texSubImage2D(r.TEXTURE_CUBE_MAP_POSITIVE_X+c,o,m.texOffset.x,m.texOffset.y,l,u,i.glFormat,i.glType,g),l=Math.max(1,l>>1),u=Math.max(1,l>>1)}}}break;default:console.error("Unsupported GL texture type, copy buffer to texture failed.")}i.flags&exports.GFXTextureFlagBit.GEN_MIPMAP&&r.generateMipmap(i.glTarget)}var iD=function(e){function t(){var e,i;Z(this,t);for(var n=arguments.length,r=new Array(n),a=0;a<n;a++)r[a]=arguments[a];return(i=re(this,(e=te(t)).call.apply(e,[this].concat(r))))._gpuBuffer=null,i._uniformBuffer=null,i}return ee(t,Ar),J(t,[{key:"initialize",value:function(e){return this._usage=e.usage,this._memUsage=e.memUsage,this._size=e.size,this._stride=Math.max(e.stride||this._size,1),this._count=this._size/this._stride,this._flags=void 0!==e.flags?e.flags:exports.GFXBufferFlagBit.NONE,this._usage&exports.GFXBufferUsageBit.INDIRECT&&(this._indirectBuffer={drawInfos:[]}),this._flags&exports.GFXBufferFlagBit.BAKUP_BUFFER&&(this._bufferView=new Uint8Array(this._size),this._device.memoryStatus.bufferSize+=this._size),this._usage&exports.GFXBufferUsageBit.UNIFORM&&this._size>0&&(this._uniformBuffer=new Uint8Array(this._size)),this._gpuBuffer={usage:e.usage,memUsage:e.memUsage,size:e.size,stride:this._stride,buffer:this._bufferView,vf32:null,indirects:[],glTarget:0,glBuffer:null},e.usage&exports.GFXBufferUsageBit.INDIRECT&&(this._gpuBuffer.indirects=this._indirectBuffer.drawInfos),this._usage&exports.GFXBufferUsageBit.UNIFORM&&(this._gpuBuffer.buffer=this._uniformBuffer),function(e,t){var i=e.gl,n=e.stateCache,r=t.memUsage&exports.GFXMemoryUsageBit.HOST?i.DYNAMIC_DRAW:i.STATIC_DRAW;if(t.usage&exports.GFXBufferUsageBit.VERTEX){t.glTarget=i.ARRAY_BUFFER;var a=i.createBuffer();a&&(t.glBuffer=a,t.size>0&&(e.useVAO&&n.glVAO&&(e.OES_vertex_array_object.bindVertexArrayOES(null),n.glVAO=null),e.stateCache.glArrayBuffer!==t.glBuffer&&(i.bindBuffer(i.ARRAY_BUFFER,t.glBuffer),e.stateCache.glArrayBuffer=t.glBuffer),i.bufferData(i.ARRAY_BUFFER,t.size,r),i.bindBuffer(i.ARRAY_BUFFER,null),e.stateCache.glArrayBuffer=null))}else if(t.usage&exports.GFXBufferUsageBit.INDEX){t.glTarget=i.ELEMENT_ARRAY_BUFFER;var o=i.createBuffer();o&&(t.glBuffer=o,t.size>0&&(e.useVAO&&n.glVAO&&(e.OES_vertex_array_object.bindVertexArrayOES(null),n.glVAO=null),e.stateCache.glElementArrayBuffer!==t.glBuffer&&(i.bindBuffer(i.ELEMENT_ARRAY_BUFFER,t.glBuffer),e.stateCache.glElementArrayBuffer=t.glBuffer),i.bufferData(i.ELEMENT_ARRAY_BUFFER,t.size,r),i.bindBuffer(i.ELEMENT_ARRAY_BUFFER,null),e.stateCache.glElementArrayBuffer=null))}else t.usage&exports.GFXBufferUsageBit.UNIFORM?(t.glTarget=i.NONE,t.buffer&&(t.vf32=new Float32Array(t.buffer.buffer))):(t.usage&exports.GFXBufferUsageBit.INDIRECT||t.usage&exports.GFXBufferUsageBit.TRANSFER_DST||t.usage&exports.GFXBufferUsageBit.TRANSFER_SRC||console.error("Unsupported GFXBufferType, create buffer failed."),t.glTarget=i.NONE)}(this._device,this._gpuBuffer),this._device.memoryStatus.bufferSize+=this._size,this._status=exports.GFXStatus.SUCCESS,!0}},{key:"destroy",value:function(){var e,t;this._gpuBuffer&&(e=this._device,(t=this._gpuBuffer).glBuffer&&(e.gl.deleteBuffer(t.glBuffer),t.glBuffer=null),this._device.memoryStatus.bufferSize-=this._size,this._gpuBuffer=null),this._bufferView=null,this._status=exports.GFXStatus.UNREADY}},{key:"resize",value:function(e){var t=this._size;if(t!==e){if(this._size=e,this._count=this._size/this._stride,this._bufferView){var i=this._bufferView;this._bufferView=new Uint8Array(this._size),this._bufferView.set(i),this._device.memoryStatus.bufferSize-=t,this._device.memoryStatus.bufferSize+=e}var n,r,a,o,s;this._uniformBuffer&&(this._uniformBuffer=new Uint8Array(e)),this._gpuBuffer&&(this._uniformBuffer?this._gpuBuffer.buffer=this._uniformBuffer:this._bufferView&&(this._gpuBuffer.buffer=this._bufferView),this._gpuBuffer.size=e,e>0&&(n=this._device,r=this._gpuBuffer,a=n.gl,o=n.stateCache,s=r.memUsage&exports.GFXMemoryUsageBit.HOST?a.DYNAMIC_DRAW:a.STATIC_DRAW,r.usage&exports.GFXBufferUsageBit.VERTEX?(n.useVAO&&o.glVAO&&(n.OES_vertex_array_object.bindVertexArrayOES(null),o.glVAO=null),n.stateCache.glArrayBuffer!==r.glBuffer&&a.bindBuffer(a.ARRAY_BUFFER,r.glBuffer),r.buffer?a.bufferData(a.ARRAY_BUFFER,r.buffer,s):a.bufferData(a.ARRAY_BUFFER,r.size,s),a.bindBuffer(a.ARRAY_BUFFER,null),n.stateCache.glArrayBuffer=null):r.usage&exports.GFXBufferUsageBit.INDEX?(n.useVAO&&o.glVAO&&(n.OES_vertex_array_object.bindVertexArrayOES(null),o.glVAO=null),n.stateCache.glElementArrayBuffer!==r.glBuffer&&a.bindBuffer(a.ELEMENT_ARRAY_BUFFER,r.glBuffer),r.buffer?a.bufferData(a.ELEMENT_ARRAY_BUFFER,r.buffer,s):a.bufferData(a.ELEMENT_ARRAY_BUFFER,r.size,s),a.bindBuffer(a.ELEMENT_ARRAY_BUFFER,null),n.stateCache.glElementArrayBuffer=null):r.usage&exports.GFXBufferUsageBit.UNIFORM?r.buffer&&(r.vf32=new Float32Array(r.buffer.buffer)):(r.usage&exports.GFXBufferUsageBit.INDIRECT||r.usage&exports.GFXBufferUsageBit.TRANSFER_DST||r.usage&exports.GFXBufferUsageBit.TRANSFER_SRC||console.error("Unsupported GFXBufferType, create buffer failed."),r.glTarget=a.NONE),this._device.memoryStatus.bufferSize-=t,this._device.memoryStatus.bufferSize+=e))}}},{key:"update",value:function(e,t,i){var n;if(n=void 0!==i?i:this._usage&exports.GFXBufferUsageBit.INDIRECT?0:e.byteLength,this._bufferView&&e!==this._bufferView.buffer){var r=new Uint8Array(e,0,i);this._bufferView.set(r,t)}YL(this._device,this._gpuBuffer,e,t||0,n)}},{key:"gpuBuffer",get:function(){return this._gpuBuffer}}]),t}(),nD=function(){function e(t,i){Z(this,e),this._frees=void 0,this._freeIdx=0,this._freeCmds=void 0,this._frees=new Array(i),this._freeCmds=new Eo(i);for(var n=0;n<i;++n)this._frees[n]=new t;this._freeIdx=i-1}return J(e,[{key:"alloc",value:function(e){if(this._freeIdx<0){var t=2*this._frees.length,i=this._frees;this._frees=new Array(t);for(var n=t-i.length,r=0;r<n;++r)this._frees[r]=new e;for(var a=n,o=0;a<t;++a,++o)this._frees[a]=i[o];this._freeIdx+=n}var s=this._frees[this._freeIdx];return this._frees[this._freeIdx--]=null,++s.refCount,s}},{key:"free",value:function(e){0==--e.refCount&&this._freeCmds.push(e)}},{key:"freeCmds",value:function(e){for(var t=0;t<e.length;++t)0==--e.array[t].refCount&&this._freeCmds.push(e.array[t])}},{key:"release",value:function(){for(var e=0;e<this._freeCmds.length;++e){var t=this._freeCmds.array[e];t.clear(),this._frees[++this._freeIdx]=t}this._freeCmds.clear()}}]),e}(),rD=function(e){function t(e){var i;return Z(this,t),(i=re(this,te(t).call(this,e))).beginRenderPassCmdPool=void 0,i.bindStatesCmdPool=void 0,i.drawCmdPool=void 0,i.updateBufferCmdPool=void 0,i.copyBufferToTextureCmdPool=void 0,i.beginRenderPassCmdPool=new nD(XL,1),i.bindStatesCmdPool=new nD(VL,1),i.drawCmdPool=new nD(HL,1),i.updateBufferCmdPool=new nD(WL,1),i.copyBufferToTextureCmdPool=new nD(jL,1),i}return ee(t,Kr),J(t,[{key:"initialize",value:function(e){return this._status=exports.GFXStatus.SUCCESS,!0}},{key:"destroy",value:function(){this._status=exports.GFXStatus.UNREADY}},{key:"clearCmds",value:function(e){e.beginRenderPassCmds.length&&(this.beginRenderPassCmdPool.freeCmds(e.beginRenderPassCmds),e.beginRenderPassCmds.clear()),e.bindStatesCmds.length&&(this.bindStatesCmdPool.freeCmds(e.bindStatesCmds),e.bindStatesCmds.clear()),e.drawCmds.length&&(this.drawCmdPool.freeCmds(e.drawCmds),e.drawCmds.clear()),e.updateBufferCmds.length&&(this.updateBufferCmdPool.freeCmds(e.updateBufferCmds),e.updateBufferCmds.clear()),e.copyBufferToTextureCmds.length&&(this.copyBufferToTextureCmdPool.freeCmds(e.copyBufferToTextureCmds),e.copyBufferToTextureCmds.clear()),e.cmds.clear()}},{key:"releaseCmds",value:function(){this.beginRenderPassCmdPool.release(),this.bindStatesCmdPool.release(),this.drawCmdPool.release(),this.updateBufferCmdPool.release(),this.copyBufferToTextureCmdPool.release()}}]),t}(),aD=function(e){function t(){var e,i;Z(this,t);for(var n=arguments.length,r=new Array(n),a=0;a<n;a++)r[a]=arguments[a];return(i=re(this,(e=te(t)).call.apply(e,[this].concat(r)))).cmdPackage=new qL,i._webGLAllocator=null,i._isInRenderPass=!1,i._curGPUPipelineState=null,i._curGPUBindingLayout=null,i._curGPUInputAssembler=null,i._curViewport=null,i._curScissor=null,i._curLineWidth=null,i._curDepthBias=null,i._curBlendConstants=[],i._curDepthBounds=null,i._curStencilWriteMask=null,i._curStencilCompareMask=null,i._isStateInvalied=!1,i}return ee(t,Or),J(t,[{key:"initialize",value:function(e){return this._allocator=e.allocator,this._type=e.type,this._webGLAllocator=this._allocator,this._status=exports.GFXStatus.SUCCESS,!0}},{key:"destroy",value:function(){this._webGLAllocator&&(this._webGLAllocator.clearCmds(this.cmdPackage),this._webGLAllocator=null),this._allocator=null,this._status=exports.GFXStatus.UNREADY}},{key:"begin",value:function(){this._webGLAllocator.clearCmds(this.cmdPackage),this._curGPUPipelineState=null,this._curGPUBindingLayout=null,this._curGPUInputAssembler=null,this._curViewport=null,this._curScissor=null,this._curLineWidth=null,this._curDepthBias=null,this._curBlendConstants=[],this._curDepthBounds=null,this._curStencilWriteMask=null,this._curStencilCompareMask=null,this._numDrawCalls=0,this._numInstances=0,this._numTris=0}},{key:"end",value:function(){this._isStateInvalied&&this.bindStates(),this._isInRenderPass=!1}},{key:"beginRenderPass",value:function(e,t,i,n,r,a){var o=this._webGLAllocator.beginRenderPassCmdPool.alloc(XL);o.gpuFramebuffer=e.gpuFramebuffer,o.renderArea=t,o.clearFlag=i,o.clearColors.length=n.length;for(var s=0;s<n.length;++s)o.clearColors[s]=n[s];o.clearDepth=r,o.clearStencil=a,this.cmdPackage.beginRenderPassCmds.push(o),this.cmdPackage.cmds.push(DL.BEGIN_RENDER_PASS),this._isInRenderPass=!0}},{key:"endRenderPass",value:function(){this._isInRenderPass=!1}},{key:"bindPipelineState",value:function(e){var t=e.gpuPipelineState;this._curGPUPipelineState=t,this._isStateInvalied=!0}},{key:"bindBindingLayout",value:function(e){var t=e.gpuBindingLayout;this._curGPUBindingLayout=t,this._isStateInvalied=!0}},{key:"bindInputAssembler",value:function(e){var t=e.gpuInputAssembler;this._curGPUInputAssembler=t,this._isStateInvalied=!0}},{key:"setViewport",value:function(e){this._curViewport?this._curViewport.left===e.left&&this._curViewport.top===e.top&&this._curViewport.width===e.width&&this._curViewport.height===e.height&&this._curViewport.minDepth===e.minDepth&&this._curViewport.maxDepth===e.maxDepth||(this._curViewport.left=e.left,this._curViewport.top=e.top,this._curViewport.width=e.width,this._curViewport.height=e.height,this._curViewport.minDepth=e.minDepth,this._curViewport.maxDepth=e.maxDepth,this._isStateInvalied=!0):this._curViewport={left:e.left,top:e.top,width:e.width,height:e.height,minDepth:e.minDepth,maxDepth:e.maxDepth}}},{key:"setScissor",value:function(e){this._curScissor?this._curScissor.x===e.x&&this._curScissor.y===e.y&&this._curScissor.width===e.width&&this._curScissor.height===e.height||(this._curScissor.x=e.x,this._curScissor.y=e.y,this._curScissor.width=e.width,this._curScissor.height=e.height,this._isStateInvalied=!0):this._curScissor={x:e.x,y:e.y,width:e.width,height:e.height}}},{key:"setLineWidth",value:function(e){this._curLineWidth!==e&&(this._curLineWidth=e,this._isStateInvalied=!0)}},{key:"setDepthBias",value:function(e,t,i){this._curDepthBias?this._curDepthBias.constantFactor===e&&this._curDepthBias.clamp===t&&this._curDepthBias.slopeFactor===i||(this._curDepthBias.constantFactor=e,this._curDepthBias.clamp=t,this._curDepthBias.slopeFactor=i,this._isStateInvalied=!0):(this._curDepthBias={constantFactor:e,clamp:t,slopeFactor:i},this._isStateInvalied=!0)}},{key:"setBlendConstants",value:function(e){(this._curBlendConstants||4!==e.length)&&(4!==e.length||this._curBlendConstants[0]===e[0]&&this._curBlendConstants[1]===e[1]&&this._curBlendConstants[2]===e[2]&&this._curBlendConstants[3]===e[3])||(this._curBlendConstants=[e[0],e[1],e[2],e[3]],this._isStateInvalied=!0)}},{key:"setDepthBound",value:function(e,t){this._curDepthBounds&&this._curDepthBounds.minBounds===e&&this._curDepthBounds.maxBounds===t||(this._curDepthBounds={minBounds:e,maxBounds:t},this._isStateInvalied=!0)}},{key:"setStencilWriteMask",value:function(e,t){this._curStencilWriteMask?this._curStencilWriteMask.face===e&&this._curStencilWriteMask.writeMask===t||(this._curStencilWriteMask.face=e,this._curStencilWriteMask.writeMask=t,this._isStateInvalied=!0):(this._curStencilWriteMask={face:e,writeMask:t},this._isStateInvalied=!0)}},{key:"setStencilCompareMask",value:function(e,t,i){this._curStencilCompareMask?this._curStencilCompareMask.face===e&&this._curStencilCompareMask.reference===t&&this._curStencilCompareMask.compareMask===i||(this._curStencilCompareMask.face=e,this._curStencilCompareMask.reference=t,this._curStencilCompareMask.compareMask=i,this._isStateInvalied=!0):(this._curStencilCompareMask={face:e,reference:t,compareMask:i},this._isStateInvalied=!0)}},{key:"draw",value:function(e){if(this._type===exports.GFXCommandBufferType.PRIMARY&&this._isInRenderPass||this._type===exports.GFXCommandBufferType.SECONDARY){this._isStateInvalied&&this.bindStates();var t=this._allocator.drawCmdPool.alloc(HL);t.drawInfo.vertexCount=e.vertexCount,t.drawInfo.firstVertex=e.firstVertex,t.drawInfo.indexCount=e.indexCount,t.drawInfo.firstIndex=e.firstIndex,t.drawInfo.vertexOffset=e.vertexOffset,t.drawInfo.instanceCount=e.instanceCount,t.drawInfo.firstInstance=e.firstInstance,this.cmdPackage.drawCmds.push(t),this.cmdPackage.cmds.push(DL.DRAW),++this._numDrawCalls,this._numInstances+=e.instanceCount;var i=e.indexCount||e.vertexCount;if(this._curGPUPipelineState)switch(this._curGPUPipelineState.glPrimitive){case 4:this._numTris+=i/3*Math.max(e.instanceCount,1);break;case 5:case 6:this._numTris+=(i-2)*Math.max(e.instanceCount,1)}}else console.error("Command 'draw' must be recorded inside a render pass.")}},{key:"updateBuffer",value:function(e,t,i,n){if(this._type===exports.GFXCommandBufferType.PRIMARY&&!this._isInRenderPass||this._type===exports.GFXCommandBufferType.SECONDARY){var r=e.gpuBuffer;if(r){var a=this._webGLAllocator.updateBufferCmdPool.alloc(WL);if(a){var o;o=void 0!==n?n:e.usage&exports.GFXBufferUsageBit.INDIRECT?0:t.byteLength;var s=t;a.gpuBuffer=r,a.buffer=s,a.offset=void 0!==i?i:0,a.size=o,this.cmdPackage.updateBufferCmds.push(a),this.cmdPackage.cmds.push(DL.UPDATE_BUFFER)}}}else console.error("Command 'updateBuffer' must be recorded outside a render pass.")}},{key:"copyBufferToTexture",value:function(e,t,i,n){if(this._type===exports.GFXCommandBufferType.PRIMARY&&!this._isInRenderPass||this._type===exports.GFXCommandBufferType.SECONDARY){var r=e.gpuBuffer,a=t.gpuTexture;if(r&&a){var o=this._webGLAllocator.copyBufferToTextureCmdPool.alloc(jL);o&&(o.gpuBuffer=r,o.gpuTexture=a,o.dstLayout=i,o.regions=n,this.cmdPackage.copyBufferToTextureCmds.push(o),this.cmdPackage.cmds.push(DL.COPY_BUFFER_TO_TEXTURE))}}else console.error("Command 'copyBufferToTexture' must be recorded outside a render pass.")}},{key:"execute",value:function(e,t){for(var i=0;i<t;++i){for(var n=e[i],r=0;r<n.cmdPackage.beginRenderPassCmds.length;++r){var a=n.cmdPackage.beginRenderPassCmds.array[r];++a.refCount,this.cmdPackage.beginRenderPassCmds.push(a)}for(var o=0;o<n.cmdPackage.bindStatesCmds.length;++o){var s=n.cmdPackage.bindStatesCmds.array[o];++s.refCount,this.cmdPackage.bindStatesCmds.push(s)}for(var l=0;l<n.cmdPackage.drawCmds.length;++l){var u=n.cmdPackage.drawCmds.array[l];++u.refCount,this.cmdPackage.drawCmds.push(u)}for(var c=0;c<n.cmdPackage.updateBufferCmds.length;++c){var h=n.cmdPackage.updateBufferCmds.array[c];++h.refCount,this.cmdPackage.updateBufferCmds.push(h)}for(var p=0;p<n.cmdPackage.copyBufferToTextureCmds.length;++p){var _=n.cmdPackage.copyBufferToTextureCmds.array[p];++_.refCount,this.cmdPackage.copyBufferToTextureCmds.push(_)}this.cmdPackage.cmds.concat(n.cmdPackage.cmds.array),this._numDrawCalls+=n._numDrawCalls,this._numInstances+=n._numInstances,this._numTris+=n._numTris}}},{key:"bindStates",value:function(){var e=this._webGLAllocator.bindStatesCmdPool.alloc(VL);e&&(e.gpuPipelineState=this._curGPUPipelineState,e.gpuBindingLayout=this._curGPUBindingLayout,e.gpuInputAssembler=this._curGPUInputAssembler,e.viewport=this._curViewport,e.scissor=this._curScissor,e.lineWidth=this._curLineWidth,e.depthBias=this._curDepthBias,e.blendConstants=this._curBlendConstants,e.depthBounds=this._curDepthBounds,e.stencilWriteMask=this._curStencilWriteMask,e.stencilCompareMask=this._curStencilCompareMask,this.cmdPackage.bindStatesCmds.push(e),this.cmdPackage.cmds.push(DL.BIND_STATES),this._isStateInvalied=!1)}},{key:"webGLDevice",get:function(){return this._device}}]),t}(),oD=function(e){function t(){var e,i;Z(this,t);for(var n=arguments.length,r=new Array(n),a=0;a<n;a++)r[a]=arguments[a];return(i=re(this,(e=te(t)).call.apply(e,[this].concat(r))))._gpuFramebuffer=null,i}return ee(t,Rr),J(t,[{key:"initialize",value:function(e){if(this._renderPass=e.renderPass,this._colorViews=e.colorViews||[],this._depthStencilView=e.depthStencilView||null,this._isOffscreen=void 0===e.isOffscreen||e.isOffscreen,this._isOffscreen){var t=[];if(void 0!==e.colorViews)for(var i,n=_e(e.colorViews);!(i=n()).done;){var r=i.value;t.push(r.gpuTextureView)}var a=null;e.depthStencilView&&(a=e.depthStencilView.gpuTextureView),this._gpuFramebuffer={gpuRenderPass:e.renderPass.gpuRenderPass,gpuColorViews:t,gpuDepthStencilView:a,isOffscreen:this._isOffscreen,glFramebuffer:null},function(e,t){if(t.isOffscreen){var i=e.gl,n=[],r=i.createFramebuffer();if(r){t.glFramebuffer=r,e.stateCache.glFramebuffer!==t.glFramebuffer&&(i.bindFramebuffer(i.FRAMEBUFFER,t.glFramebuffer),e.stateCache.glFramebuffer=t.glFramebuffer);for(var a=0;a<t.gpuColorViews.length;++a){var o=t.gpuColorViews[a];o&&(o.gpuTexture.glTexture?i.framebufferTexture2D(i.FRAMEBUFFER,i.COLOR_ATTACHMENT0+a,o.gpuTexture.glTarget,o.gpuTexture.glTexture,o.baseLevel):i.framebufferRenderbuffer(i.FRAMEBUFFER,i.COLOR_ATTACHMENT0+a,i.RENDERBUFFER,o.gpuTexture.glRenderbuffer),n.push(i.COLOR_ATTACHMENT0+a))}var s=t.gpuDepthStencilView;if(s){var l=yr[s.format].hasStencil?i.DEPTH_STENCIL_ATTACHMENT:i.DEPTH_ATTACHMENT;s.gpuTexture.glTexture?i.framebufferTexture2D(i.FRAMEBUFFER,l,s.gpuTexture.glTarget,s.gpuTexture.glTexture,s.baseLevel):i.framebufferRenderbuffer(i.FRAMEBUFFER,l,i.RENDERBUFFER,s.gpuTexture.glRenderbuffer)}e.WEBGL_draw_buffers&&e.WEBGL_draw_buffers.drawBuffersWEBGL(n);var u=i.checkFramebufferStatus(i.FRAMEBUFFER);if(u!==i.FRAMEBUFFER_COMPLETE)switch(u){case i.FRAMEBUFFER_INCOMPLETE_ATTACHMENT:console.error("glCheckFramebufferStatus() - FRAMEBUFFER_INCOMPLETE_ATTACHMENT");break;case i.FRAMEBUFFER_INCOMPLETE_MISSING_ATTACHMENT:console.error("glCheckFramebufferStatus() - FRAMEBUFFER_INCOMPLETE_MISSING_ATTACHMENT");break;case i.FRAMEBUFFER_INCOMPLETE_DIMENSIONS:console.error("glCheckFramebufferStatus() - FRAMEBUFFER_INCOMPLETE_DIMENSIONS");break;case i.FRAMEBUFFER_UNSUPPORTED:console.error("glCheckFramebufferStatus() - FRAMEBUFFER_UNSUPPORTED")}}}}(this._device,this._gpuFramebuffer)}else this._gpuFramebuffer={gpuRenderPass:e.renderPass.gpuRenderPass,gpuColorViews:[],gpuDepthStencilView:null,isOffscreen:!1,glFramebuffer:null};return this._status=exports.GFXStatus.SUCCESS,!0}},{key:"destroy",value:function(){var e,t;this._isOffscreen&&this._gpuFramebuffer&&(e=this._device,(t=this._gpuFramebuffer).glFramebuffer&&(e.gl.deleteFramebuffer(t.glFramebuffer),t.glFramebuffer=null)),this._gpuFramebuffer=null,this._status=exports.GFXStatus.UNREADY}},{key:"gpuFramebuffer",get:function(){return this._gpuFramebuffer}}]),t}(),sD=function(e){function t(){var e,i;Z(this,t);for(var n=arguments.length,r=new Array(n),a=0;a<n;a++)r[a]=arguments[a];return(i=re(this,(e=te(t)).call.apply(e,[this].concat(r))))._gpuInputAssembler=null,i}return ee(t,Fr),J(t,[{key:"initialize",value:function(e){if(0===e.vertexBuffers.length)return console.error("GFXInputAssemblerInfo.vertexBuffers is null."),!1;if(this._attributes=e.attributes,this._vertexBuffers=e.vertexBuffers,void 0!==e.indexBuffer)this._indexBuffer=e.indexBuffer,this._indexCount=this._indexBuffer.size/this._indexBuffer.stride;else{var t=this._vertexBuffers[0];this._vertexCount=t.size/t.stride}this._indirectBuffer=e.indirectBuffer||null;for(var i=new Array(e.vertexBuffers.length),n=0;n<e.vertexBuffers.length;++n){var r=e.vertexBuffers[n];r.gpuBuffer&&(i[n]=r.gpuBuffer)}var a=null,o=0;if(e.indexBuffer&&(a=e.indexBuffer.gpuBuffer))switch(a.stride){case 1:o=5121;break;case 2:o=5123;break;case 4:o=5125;break;default:console.error("Error index buffer stride.")}var s=null;return void 0!==e.indirectBuffer&&(s=e.indirectBuffer.gpuBuffer),this._gpuInputAssembler={attributes:e.attributes,gpuVertexBuffers:i,gpuIndexBuffer:a,gpuIndirectBuffer:s,glAttribs:[],glIndexType:o,glVAOs:new Map},function(e,t){var i=e.gl;t.glAttribs=new Array(t.attributes.length);for(var n=[0,0,0,0,0,0,0,0],r=0;r<t.attributes.length;++r){var a=t.attributes[r],o=void 0!==a.stream?a.stream:0,s=t.gpuVertexBuffers[o],l=kL(a.format,i),u=yr[a.format].size;t.glAttribs[r]={name:a.name,glBuffer:s.glBuffer,glType:l,size:u,count:yr[a.format].count,stride:s.stride,componentCount:LL(l,i),isNormalized:void 0!==a.isNormalized&&a.isNormalized,isInstanced:void 0!==a.isInstanced&&a.isInstanced,offset:n[o]},n[o]+=u}}(this._device,this._gpuInputAssembler),this._status=exports.GFXStatus.SUCCESS,!0}},{key:"destroy",value:function(){var e=this._device;this._gpuInputAssembler&&e.useVAO&&function(e,t){for(var i=t.glVAOs.values(),n=i.next();!n.done;)e.OES_vertex_array_object.deleteVertexArrayOES(n.value),n=i.next();t.glVAOs.clear()}(e,this._gpuInputAssembler),this._gpuInputAssembler=null,this._status=exports.GFXStatus.UNREADY}},{key:"gpuInputAssembler",get:function(){return this._gpuInputAssembler}}]),t}(),lD=function(e){function t(){var e,i;Z(this,t);for(var n=arguments.length,r=new Array(n),a=0;a<n;a++)r[a]=arguments[a];return(i=re(this,(e=te(t)).call.apply(e,[this].concat(r))))._gpuPipelineLayout=null,i}return ee(t,Mr),J(t,[{key:"initialize",value:function(e){return this._layouts=e.layouts,this._pushConstantsRanges=e.pushConstantsRanges||[],this._status=exports.GFXStatus.SUCCESS,!0}},{key:"destroy",value:function(){this._status=exports.GFXStatus.UNREADY}},{key:"gpuPipelineLayout",get:function(){return this._gpuPipelineLayout}}]),t}(),uD=[0,1,3,2,0,0,0,4,5,6,0,0,0,0],cD=function(e){function t(){var e,i;Z(this,t);for(var n=arguments.length,r=new Array(n),a=0;a<n;a++)r[a]=arguments[a];return(i=re(this,(e=te(t)).call.apply(e,[this].concat(r))))._gpuPipelineState=null,i}return ee(t,zr),J(t,[{key:"initialize",value:function(e){return this._primitive=e.primitive,this._shader=e.shader,this._is=e.inputState,this._rs=e.rasterizerState,this._dss=e.depthStencilState,this._bs=e.blendState,this._dynamicStates=e.dynamicStates||[],this._hash=e.hash,this._layout=e.layout,this._renderPass=e.renderPass,this._gpuPipelineState={glPrimitive:uD[e.primitive],gpuShader:e.shader.gpuShader,rs:e.rasterizerState,dss:e.depthStencilState,bs:e.blendState,dynamicStates:void 0!==e.dynamicStates?e.dynamicStates:[],gpuLayout:e.layout.gpuPipelineLayout,gpuRenderPass:e.renderPass.gpuRenderPass},this._status=exports.GFXStatus.SUCCESS,!0}},{key:"destroy",value:function(){this._gpuPipelineState=null,this._status=exports.GFXStatus.UNREADY}},{key:"gpuPipelineState",get:function(){return this._gpuPipelineState}}]),t}(),hD=[],pD=function(e){function t(){return Z(this,t),re(this,te(t).apply(this,arguments))}return ee(t,aD),J(t,[{key:"beginRenderPass",value:function(e,t,i,n,r,a){ZL(this._device,e.gpuFramebuffer,t,i,n,r,a),this._isInRenderPass=!0}},{key:"draw",value:function(e){if(this._isInRenderPass){this._isStateInvalied&&this.bindStates(),JL(this._device,e),++this._numDrawCalls,this._numInstances+=e.instanceCount;var t=e.indexCount||e.vertexCount;if(this._curGPUPipelineState)switch(this._curGPUPipelineState.glPrimitive){case 4:this._numTris+=t/3*Math.max(e.instanceCount,1);break;case 5:case 6:this._numTris+=(t-2)*Math.max(e.instanceCount,1)}}else console.error("Command 'draw' must be recorded inside a render pass.")}},{key:"updateBuffer",value:function(e,t,i,n){if(this._isInRenderPass)console.error("Command 'updateBuffer' must be recorded outside a render pass.");else{var r,a=e.gpuBuffer;if(a)void 0===i&&(i=0),r=void 0!==n?n:e.usage&exports.GFXBufferUsageBit.INDIRECT?0:t.byteLength,YL(this._device,a,t,i,r)}}},{key:"copyBufferToTexture",value:function(e,t,i,n){if(this._isInRenderPass)console.error("Command 'copyBufferToTexture' must be recorded outside a render pass.");else{var r=e.gpuBuffer,a=t.gpuTexture;r&&a&&(hD[0]=r.buffer,tD(this._device,hD,a,n))}}},{key:"execute",value:function(e,t){for(var i=0;i<t;++i){var n=e[i];eD(this._device,n.cmdPackage),this._numDrawCalls+=n._numDrawCalls,this._numInstances+=n._numInstances,this._numTris+=n._numTris}}},{key:"bindStates",value:function(){QL(this._device,this._curGPUPipelineState,this._curGPUBindingLayout,this._curGPUInputAssembler,this._curViewport,this._curScissor,this._curLineWidth,this._curDepthBias,this._curBlendConstants,this._curDepthBounds,this._curStencilWriteMask,this._curStencilCompareMask),this._isStateInvalied=!1}}]),t}(),_D=function(e){function t(){var e,i;Z(this,t);for(var n=arguments.length,r=new Array(n),a=0;a<n;a++)r[a]=arguments[a];return(i=re(this,(e=te(t)).call.apply(e,[this].concat(r)))).numDrawCalls=0,i.numInstances=0,i.numTris=0,i._isAsync=!1,i}return ee(t,Br),J(t,[{key:"initialize",value:function(e){return this._type=e.type,this._status=exports.GFXStatus.SUCCESS,!0}},{key:"destroy",value:function(){this._status=exports.GFXStatus.UNREADY}},{key:"submit",value:function(e,t){if(!this._isAsync)for(var i=e.length,n=0;n<i;n++){var r=e[n];this.numDrawCalls+=r.numDrawCalls,this.numInstances+=r.numInstances,this.numTris+=r.numTris}}},{key:"clear",value:function(){this.numDrawCalls=0,this.numInstances=0,this.numTris=0}}]),t}(),fD=function(e){function t(){var e,i;Z(this,t);for(var n=arguments.length,r=new Array(n),a=0;a<n;a++)r[a]=arguments[a];return(i=re(this,(e=te(t)).call.apply(e,[this].concat(r))))._gpuRenderPass=null,i}return ee(t,Gr),J(t,[{key:"initialize",value:function(e){return this._colorInfos=e.colorAttachments||[],this._depthStencilInfo=e.depthStencilAttachment||null,this._gpuRenderPass={colorAttachments:this._colorInfos,depthStencilAttachment:this._depthStencilInfo},this._status=exports.GFXStatus.SUCCESS,!0}},{key:"destroy",value:function(){this._gpuRenderPass=null,this._status=exports.GFXStatus.UNREADY}},{key:"gpuRenderPass",get:function(){return this._gpuRenderPass}}]),t}(),dD=[10497,33648,33071,33071],mD=function(e){function t(){var e,i;Z(this,t);for(var n=arguments.length,r=new Array(n),a=0;a<n;a++)r[a]=arguments[a];return(i=re(this,(e=te(t)).call.apply(e,[this].concat(r))))._gpuSampler=null,i}return ee(t,Xr),J(t,[{key:"initialize",value:function(e){void 0!==e.name&&(this._state.name=e.name),void 0!==e.minFilter&&(this._state.minFilter=e.minFilter),void 0!==e.magFilter&&(this._state.magFilter=e.magFilter),void 0!==e.mipFilter&&(this._state.mipFilter=e.mipFilter),void 0!==e.addressU&&(this._state.addressU=e.addressU),void 0!==e.addressV&&(this._state.addressV=e.addressV),void 0!==e.addressW&&(this._state.addressW=e.addressW),void 0!==e.maxAnisotropy&&(this._state.maxAnisotropy=e.maxAnisotropy),void 0!==e.cmpFunc&&(this._state.cmpFunc=e.cmpFunc),void 0!==e.borderColor&&(this._state.borderColor=e.borderColor),void 0!==e.minLOD&&(this._state.minLOD=e.minLOD),void 0!==e.maxLOD&&(this._state.maxLOD=e.maxLOD),void 0!==e.mipLODBias&&(this._state.mipLODBias=e.mipLODBias);var t=0,i=0,n=this._state.minFilter,r=this._state.magFilter,a=this._state.mipFilter;t=n===exports.GFXFilter.LINEAR||n===exports.GFXFilter.ANISOTROPIC?a===exports.GFXFilter.LINEAR||a===exports.GFXFilter.ANISOTROPIC?9987:a===exports.GFXFilter.POINT?9985:9729:a===exports.GFXFilter.LINEAR||a===exports.GFXFilter.ANISOTROPIC?9986:a===exports.GFXFilter.POINT?9984:9728,i=r===exports.GFXFilter.LINEAR||r===exports.GFXFilter.ANISOTROPIC?9729:9728;var o=dD[this._state.addressU],s=dD[this._state.addressV],l=dD[this._state.addressW];return this._gpuSampler={glMinFilter:t,glMagFilter:i,glWrapS:o,glWrapT:s,glWrapR:l},this._status=exports.GFXStatus.SUCCESS,!0}},{key:"destroy",value:function(){this._gpuSampler=null,this._status=exports.GFXStatus.UNREADY}},{key:"gpuSampler",get:function(){return this._gpuSampler}}]),t}(),vD=function(e){function t(){var e,i;Z(this,t);for(var n=arguments.length,r=new Array(n),a=0;a<n;a++)r[a]=arguments[a];return(i=re(this,(e=te(t)).call.apply(e,[this].concat(r))))._gpuShader=null,i}return ee(t,Vr),J(t,[{key:"initialize",value:function(e){this._name=e.name,this._stages=e.stages,void 0!==e.blocks&&(this._blocks=e.blocks),void 0!==e.samplers&&(this._samplers=e.samplers),this._gpuShader={name:e.name?e.name:"",blocks:void 0!==e.blocks?e.blocks:[],samplers:void 0!==e.samplers?e.samplers:[],gpuStages:new Array(e.stages.length),glProgram:null,glInputs:[],glUniforms:[],glBlocks:[],glSamplers:[]};for(var t=0;t<e.stages.length;++t){var i=e.stages[t];this._gpuShader.gpuStages[t]={type:i.type,source:i.source,macros:i.macros?i.macros:[],glShader:null}}return function(e,t){for(var i=e.gl,n=function(e){var n=t.gpuStages[e],r=0,a="",o=1;switch(n.type){case exports.GFXShaderType.VERTEX:a="VertexShader",r=i.VERTEX_SHADER;break;case exports.GFXShaderType.FRAGMENT:a="FragmentShader",r=i.FRAGMENT_SHADER;break;default:return console.error("Unsupported GFXShaderType."),{v:void 0}}var s=i.createShader(r);if(s&&(n.glShader=s,i.shaderSource(n.glShader,n.source),i.compileShader(n.glShader),!i.getShaderParameter(n.glShader,i.COMPILE_STATUS))){console.error(a+" in '"+t.name+"' compilation failed."),console.error("Shader source dump:",n.source.replace(/^|\n/g,(function(){return"\n".concat(o++," ")}))),console.error(i.getShaderInfoLog(n.glShader));for(var l=0;l<t.gpuStages.length;l++){var u=t.gpuStages[e];u.glShader&&(i.deleteShader(u.glShader),u.glShader=null)}return{v:void 0}}},r=0;r<t.gpuStages.length;r++){var a=n(r);if("object"===K(a))return a.v}var o=i.createProgram();if(o){t.glProgram=o;for(var s=0;s<t.gpuStages.length;s++){var l=t.gpuStages[s];i.attachShader(t.glProgram,l.glShader)}if(i.linkProgram(t.glProgram),e.destroyShadersImmediately)for(var u=0;u<t.gpuStages.length;u++){var c=t.gpuStages[u];c.glShader&&(i.detachShader(t.glProgram,c.glShader),i.deleteShader(c.glShader),c.glShader=null)}if(!i.getProgramParameter(t.glProgram,i.LINK_STATUS))return console.error("Failed to link shader '"+t.name+"'."),void console.error(i.getProgramInfoLog(t.glProgram));console.info("Shader '"+t.name+"' compilation succeeded.");var h=i.getProgramParameter(t.glProgram,i.ACTIVE_ATTRIBUTES);t.glInputs=new Array(h);for(var p=0;p<h;++p){var _=i.getActiveAttrib(t.glProgram,p);if(_){var f=void 0,d=_.name.indexOf("[");f=-1!==d?_.name.substr(0,d):_.name;var m=i.getAttribLocation(t.glProgram,f),v=IL(_.type,i),y=PL(_.type,i);t.glInputs[p]={binding:m,name:f,type:v,stride:y,count:_.size,size:y*_.size,glType:_.type,glLoc:m}}}if(t.blocks.length>0){t.glBlocks=new Array(t.blocks.length);for(var g=0;g<t.blocks.length;++g){var x=t.blocks[g],b={binding:x.binding,name:x.name,size:0,glUniforms:new Array(x.members.length),glActiveUniforms:[],isUniformPackage:!0};t.glBlocks[g]=b;for(var T=0;T<x.members.length;++T){var S=x.members[T],E=ML(S.type,i),w=PL(E,i),C=w*S.count,A=b.size/4,O=new Array(C/4);O.fill(0),b.glUniforms[T]={binding:-1,name:S.name,type:S.type,stride:w,count:S.count,size:C,offset:b.size,glType:E,glLoc:-1,array:O,begin:A},b.size+=C}}}if(t.samplers.length>0){t.glSamplers=new Array(t.samplers.length);for(var k=0;k<t.samplers.length;++k){var R=t.samplers[k];t.glSamplers[k]={binding:R.binding,name:R.name,type:R.type,units:[],glType:ML(R.type,i),glLoc:-1}}}for(var F=i.getProgramParameter(t.glProgram,i.ACTIVE_UNIFORMS),M=0,I=[],P=0;P<F;++P){var L=i.getActiveUniform(t.glProgram,P);if(L){var D=i.getUniformLocation(t.glProgram,L.name);if(null!==D){var N=void 0,z=L.name.indexOf("[");if(N=-1!==z?L.name.substr(0,z):L.name,L.type===i.SAMPLER_2D||L.type===i.SAMPLER_CUBE)for(var B=0;B<t.glSamplers.length;B++){var G=t.glSamplers[B];if(G.name===N){for(var U=0;U<L.size;++U)G.units.push(M+U);G.glLoc=D,M+=L.size,I.push(G);break}}else for(var X=0;X<t.glBlocks.length;X++)for(var V=t.glBlocks[X],H=0;H<V.glUniforms.length;H++){var W=V.glUniforms[H];if(W.name===N){W.glLoc=D,V.glActiveUniforms.push(W);break}}}}}if(I.length){e.stateCache.glProgram!==t.glProgram&&(i.useProgram(t.glProgram),e.stateCache.glProgram=t.glProgram);for(var j=0;j<I.length;j++){var q=I[j];i.uniform1iv(q.glLoc,q.units)}}}}(this._device,this._gpuShader),this._status=exports.GFXStatus.SUCCESS,!0}},{key:"destroy",value:function(){this._gpuShader&&(!function(e,t){var i=e.gl;if(t.glProgram){if(!e.destroyShadersImmediately)for(var n=0;n<t.gpuStages.length;n++){var r=t.gpuStages[n];r.glShader&&(i.detachShader(t.glProgram,r.glShader),i.deleteShader(r.glShader),r.glShader=null)}i.deleteProgram(t.glProgram),t.glProgram=null}}(this._device,this._gpuShader),this._gpuShader=null),this._status=exports.GFXStatus.UNREADY}},{key:"gpuShader",get:function(){return this._gpuShader}}]),t}(),yD=function e(){Z(this,e),this.glArrayBuffer=null,this.glElementArrayBuffer=null,this.glVAO=null,this.texUnit=0,this.glTexUnits=void 0,this.glRenderbuffer=null,this.glFramebuffer=null,this.viewport=void 0,this.scissorRect=void 0,this.rs=void 0,this.dss=void 0,this.bs=void 0,this.glProgram=null,this.glEnabledAttribLocs=void 0,this.glCurrentAttribLocs=void 0,this.glTexUnits=new Array(16),this.viewport={left:0,top:0,width:0,height:0,minDepth:0,maxDepth:0},this.scissorRect={x:0,y:0,width:0,height:0},this.rs=new Ir,this.dss=new Pr,this.bs=new Dr,this.glEnabledAttribLocs=new Array(16),this.glCurrentAttribLocs=new Array(16),this.glEnabledAttribLocs.fill(!1),this.glCurrentAttribLocs.fill(!1);for(var t=0;t<16;++t)this.glTexUnits[t]={glTexture:null}},gD=function(e){function t(){var e,i;Z(this,t);for(var n=arguments.length,r=new Array(n),a=0;a<n;a++)r[a]=arguments[a];return(i=re(this,(e=te(t)).call.apply(e,[this].concat(r))))._gpuTexture=null,i}return ee(t,jr),J(t,[{key:"initialize",value:function(e){var t;switch(this._type=e.type,this._usage=e.usage,this._format=e.format,this._width=e.width,this._height=e.height,void 0!==e.depth&&(this._depth=e.depth),void 0!==e.arrayLayer&&(this._arrayLayer=e.arrayLayer),void 0!==e.mipLevel&&(this._mipLevel=e.mipLevel),void 0!==e.samples&&(this._samples=e.samples),void 0!==e.flags&&(this._flags=e.flags),this._isPowerOf2=Hr(this._width)&&Hr(this._height),this._size=xr(this._format,this.width,this.height,this.depth,this.mipLevel)*this._arrayLayer,this._flags&exports.GFXTextureFlagBit.BAKUP_BUFFER&&(this._buffer=new ArrayBuffer(this._size)),e.type){case exports.GFXTextureType.TEX1D:t=e.arrayLayer?e.arrayLayer<=1?exports.GFXTextureViewType.TV1D:exports.GFXTextureViewType.TV1D_ARRAY:exports.GFXTextureViewType.TV1D;break;case exports.GFXTextureType.TEX2D:var i=exports.GFXTextureFlagBit.NONE;e.flags&&(i=e.flags),t=e.arrayLayer?e.arrayLayer<=1?exports.GFXTextureViewType.TV2D:i&exports.GFXTextureFlagBit.CUBEMAP?exports.GFXTextureViewType.CUBE:exports.GFXTextureViewType.TV2D_ARRAY:exports.GFXTextureViewType.TV2D;break;case exports.GFXTextureType.TEX3D:t=exports.GFXTextureViewType.TV3D;break;default:t=exports.GFXTextureViewType.TV2D}return this._gpuTexture={type:this._type,viewType:t,format:this._format,usage:this._usage,width:this._width,height:this._height,depth:this._depth,size:this._size,arrayLayer:this._arrayLayer,mipLevel:this._mipLevel,samples:this._samples,flags:this._flags,isPowerOf2:this._isPowerOf2,glTarget:0,glInternalFmt:0,glFormat:0,glType:0,glUsage:0,glTexture:null,glRenderbuffer:null,glWrapS:0,glWrapT:0,glMinFilter:0,glMagFilter:0},function(e,t){var i=e.gl;t.glInternalFmt=RL(t.format,i),t.glFormat=FL(t.format,i),t.glType=kL(t.format,i);var n=t.width,r=t.height;switch(t.viewType){case exports.GFXTextureViewType.TV2D:t.viewType=exports.GFXTextureViewType.TV2D,t.glTarget=i.TEXTURE_2D;var a=Math.max(n,r);if(a>e.maxTextureSize&&b(9100,a,e.maxTextureSize),!e.WEBGL_depth_texture&&yr[t.format].hasDepth){var o=i.createRenderbuffer();o&&t.size>0&&(t.glRenderbuffer=o,e.stateCache.glRenderbuffer!==t.glRenderbuffer&&(i.bindRenderbuffer(i.RENDERBUFFER,t.glRenderbuffer),e.stateCache.glRenderbuffer=t.glRenderbuffer),t.glInternalFmt===i.DEPTH_COMPONENT&&(t.glInternalFmt=i.DEPTH_COMPONENT16),i.renderbufferStorage(i.RENDERBUFFER,t.glInternalFmt,n,r))}else if(t.samples===exports.GFXSampleCount.X1){var s=i.createTexture();if(s&&t.size>0){t.glTexture=s;var l=e.stateCache.glTexUnits[e.stateCache.texUnit];if(l.glTexture!==t.glTexture&&(i.bindTexture(i.TEXTURE_2D,t.glTexture),l.glTexture=t.glTexture),yr[t.format].isCompressed)if(t.glInternalFmt!==AL.COMPRESSED_RGB_ETC1_WEBGL)for(var u=0;u<t.mipLevel;++u){var c=gr(t.format,n,r,1),h=new Uint8Array(c);i.compressedTexImage2D(i.TEXTURE_2D,u,t.glInternalFmt,n,r,0,h),n=Math.max(1,n>>1),r=Math.max(1,r>>1)}else{var p=gr(t.format,2,2,1),_=new Uint8Array(p);i.compressedTexImage2D(i.TEXTURE_2D,0,t.glInternalFmt,2,2,0,_)}else for(var f=0;f<t.mipLevel;++f)i.texImage2D(i.TEXTURE_2D,f,t.glInternalFmt,n,r,0,t.glFormat,t.glType,null),n=Math.max(1,n>>1),r=Math.max(1,r>>1);t.isPowerOf2?(t.glWrapS=i.REPEAT,t.glWrapT=i.REPEAT):(t.glWrapS=i.CLAMP_TO_EDGE,t.glWrapT=i.CLAMP_TO_EDGE),t.glMinFilter=i.LINEAR,t.glMagFilter=i.LINEAR,i.texParameteri(t.glTarget,i.TEXTURE_WRAP_S,t.glWrapS),i.texParameteri(t.glTarget,i.TEXTURE_WRAP_T,t.glWrapT),i.texParameteri(t.glTarget,i.TEXTURE_MIN_FILTER,t.glMinFilter),i.texParameteri(t.glTarget,i.TEXTURE_MAG_FILTER,t.glMagFilter)}else i.deleteTexture(s)}break;case exports.GFXTextureViewType.CUBE:t.viewType=exports.GFXTextureViewType.CUBE,t.glTarget=i.TEXTURE_CUBE_MAP;var d=Math.max(n,r);d>e.maxCubeMapTextureSize&&b(9100,d,e.maxTextureSize);var m=i.createTexture();if(m&&t.size>0){t.glTexture=m;var v=e.stateCache.glTexUnits[e.stateCache.texUnit];if(v.glTexture!==t.glTexture&&(i.bindTexture(i.TEXTURE_CUBE_MAP,t.glTexture),v.glTexture=t.glTexture),yr[t.format].isCompressed)if(t.glInternalFmt!==AL.COMPRESSED_RGB_ETC1_WEBGL)for(var y=0;y<6;++y){n=t.width,r=t.height;for(var g=0;g<t.mipLevel;++g){var x=gr(t.format,n,r,1),T=new Uint8Array(x);i.compressedTexImage2D(i.TEXTURE_CUBE_MAP_POSITIVE_X+y,g,t.glInternalFmt,n,r,0,T),n=Math.max(1,n>>1),r=Math.max(1,r>>1)}}else for(var S=0;S<6;++S){var E=gr(t.format,2,2,1),w=new Uint8Array(E);i.compressedTexImage2D(i.TEXTURE_CUBE_MAP_POSITIVE_X+S,0,t.glInternalFmt,2,2,0,w)}else for(var C=0;C<6;++C){n=t.width,r=t.height;for(var A=0;A<t.mipLevel;++A)i.texImage2D(i.TEXTURE_CUBE_MAP_POSITIVE_X+C,A,t.glInternalFmt,n,r,0,t.glFormat,t.glType,null),n=Math.max(1,n>>1),r=Math.max(1,r>>1)}t.isPowerOf2?(t.glWrapS=i.REPEAT,t.glWrapT=i.REPEAT):(t.glWrapS=i.CLAMP_TO_EDGE,t.glWrapT=i.CLAMP_TO_EDGE),t.glMinFilter=i.LINEAR,t.glMagFilter=i.LINEAR,i.texParameteri(t.glTarget,i.TEXTURE_WRAP_S,t.glWrapS),i.texParameteri(t.glTarget,i.TEXTURE_WRAP_T,t.glWrapT),i.texParameteri(t.glTarget,i.TEXTURE_MIN_FILTER,t.glMinFilter),i.texParameteri(t.glTarget,i.TEXTURE_MAG_FILTER,t.glMagFilter)}break;default:console.error("Unsupported GFXTextureType, create texture failed."),t.viewType=exports.GFXTextureViewType.TV2D,t.glTarget=i.TEXTURE_2D}}(this._device,this._gpuTexture),this._device.memoryStatus.textureSize+=this._size,this._status=exports.GFXStatus.SUCCESS,!0}},{key:"destroy",value:function(){var e,t;this._gpuTexture&&(e=this._device,(t=this._gpuTexture).glTexture&&(e.gl.deleteTexture(t.glTexture),t.glTexture=null),t.glRenderbuffer&&(e.gl.deleteRenderbuffer(t.glRenderbuffer),t.glRenderbuffer=null),this._device.memoryStatus.textureSize-=this._size,this._gpuTexture=null),this._buffer=null,this._status=exports.GFXStatus.UNREADY}},{key:"resize",value:function(e,t){var i=this._size;this._width=e,this._height=t,this._size=xr(this._format,this.width,this.height,this.depth,this.mipLevel)*this._arrayLayer,this._gpuTexture&&(this._gpuTexture.width=e,this._gpuTexture.height=t,this._gpuTexture.size=this._size,function(e,t){var i=e.gl;t.glInternalFmt=RL(t.format,i),t.glFormat=FL(t.format,i),t.glType=kL(t.format,i);var n=t.width,r=t.height;switch(t.viewType){case exports.GFXTextureViewType.TV2D:t.viewType=exports.GFXTextureViewType.TV2D,t.glTarget=i.TEXTURE_2D;var a=Math.max(n,r);if(a>e.maxTextureSize&&b(9100,a,e.maxTextureSize),t.samples===exports.GFXSampleCount.X1){var o=e.stateCache.glTexUnits[e.stateCache.texUnit];if(o.glTexture!==t.glTexture&&(i.bindTexture(i.TEXTURE_2D,t.glTexture),o.glTexture=t.glTexture),yr[t.format].isCompressed){if(t.glInternalFmt!==AL.COMPRESSED_RGB_ETC1_WEBGL)for(var s=0;s<t.mipLevel;++s){var l=gr(t.format,n,r,1),u=new Uint8Array(l);i.compressedTexImage2D(i.TEXTURE_2D,s,t.glInternalFmt,n,r,0,u),n=Math.max(1,n>>1),r=Math.max(1,r>>1)}}else for(var c=0;c<t.mipLevel;++c)i.texImage2D(i.TEXTURE_2D,c,t.glInternalFmt,n,r,0,t.glFormat,t.glType,null),n=Math.max(1,n>>1),r=Math.max(1,r>>1)}break;case exports.GFXTextureViewType.CUBE:t.viewType=exports.GFXTextureViewType.CUBE,t.glTarget=i.TEXTURE_CUBE_MAP;var h=Math.max(n,r);h>e.maxCubeMapTextureSize&&b(9100,h,e.maxTextureSize);var p=e.stateCache.glTexUnits[e.stateCache.texUnit];if(p.glTexture!==t.glTexture&&(i.bindTexture(i.TEXTURE_CUBE_MAP,t.glTexture),p.glTexture=t.glTexture),yr[t.format].isCompressed){if(t.glInternalFmt!==AL.COMPRESSED_RGB_ETC1_WEBGL)for(var _=0;_<6;++_){n=t.width,r=t.height;for(var f=0;f<t.mipLevel;++f){var d=gr(t.format,n,r,1),m=new Uint8Array(d);i.compressedTexImage2D(i.TEXTURE_CUBE_MAP_POSITIVE_X+_,f,t.glInternalFmt,n,r,0,m),n=Math.max(1,n>>1),r=Math.max(1,r>>1)}}}else for(var v=0;v<6;++v){n=t.width,r=t.height;for(var y=0;y<t.mipLevel;++y)i.texImage2D(i.TEXTURE_CUBE_MAP_POSITIVE_X+v,y,t.glInternalFmt,n,r,0,t.glFormat,t.glType,null),n=Math.max(1,n>>1),r=Math.max(1,r>>1)}break;default:console.error("Unsupported GFXTextureType, create texture failed."),t.viewType=exports.GFXTextureViewType.TV2D,t.glTarget=i.TEXTURE_2D}}(this._device,this._gpuTexture),this._device.memoryStatus.textureSize-=i,this._device.memoryStatus.textureSize+=this._size)}},{key:"gpuTexture",get:function(){return this._gpuTexture}}]),t}(),xD=function(e){function t(){var e,i;Z(this,t);for(var n=arguments.length,r=new Array(n),a=0;a<n;a++)r[a]=arguments[a];return(i=re(this,(e=te(t)).call.apply(e,[this].concat(r))))._gpuTextureView=null,i}return ee(t,qr),J(t,[{key:"initialize",value:function(e){return this._texture=e.texture,this._type=e.type,this._format=e.format,void 0!==e.baseLevel&&(this._baseLevel=e.baseLevel),void 0!==e.levelCount&&(this._levelCount=e.levelCount),void 0!==e.baseLayer&&(this._baseLayer=e.baseLayer),void 0!==e.layerCount&&(this._layerCount=e.layerCount),this._gpuTextureView={gpuTexture:e.texture.gpuTexture,type:e.type,format:e.format,baseLevel:e.baseLevel?e.baseLevel:0,levelCount:e.levelCount?e.levelCount:1},this._status=exports.GFXStatus.SUCCESS,!0}},{key:"destroy",value:function(){this._gpuTextureView=null,this._texture=null,this._status=exports.GFXStatus.UNREADY}},{key:"gpuTextureView",get:function(){return this._gpuTextureView}}]),t}(),bD=function(e){function t(){return Z(this,t),re(this,te(t).apply(this,arguments))}return ee(t,Zr),J(t,[{key:"initialize",value:function(e){void 0!==e.title&&(this._title=e.title),void 0!==e.left&&(this._left=e.left),void 0!==e.top&&(this._top=e.top),void 0!==e.isOffscreen&&(this._isOffscreen=e.isOffscreen),this._width=e.width,this._height=e.height,this._nativeWidth=this._width,this._nativeHeight=this._height,this._colorFmt=e.colorFmt,this._depthStencilFmt=e.depthStencilFmt,this._renderPass=this._device.createRenderPass({colorAttachments:[{format:this._colorFmt,loadOp:exports.GFXLoadOp.CLEAR,storeOp:exports.GFXStoreOp.STORE,sampleCount:1,beginLayout:exports.GFXTextureLayout.COLOR_ATTACHMENT_OPTIMAL,endLayout:exports.GFXTextureLayout.PRESENT_SRC}],depthStencilAttachment:{format:this._depthStencilFmt,depthLoadOp:exports.GFXLoadOp.CLEAR,depthStoreOp:exports.GFXStoreOp.STORE,stencilLoadOp:exports.GFXLoadOp.CLEAR,stencilStoreOp:exports.GFXStoreOp.STORE,sampleCount:1,beginLayout:exports.GFXTextureLayout.DEPTH_STENCIL_ATTACHMENT_OPTIMAL,endLayout:exports.GFXTextureLayout.PRESENT_SRC}});var t=[];return this._isOffscreen&&(this._colorFmt!==exports.GFXFormat.UNKNOWN&&(this._colorTex=this._device.createTexture({type:exports.GFXTextureType.TEX2D,usage:exports.GFXTextureUsageBit.COLOR_ATTACHMENT|exports.GFXTextureUsageBit.SAMPLED,format:this._colorFmt,width:this._width,height:this._height,depth:1,arrayLayer:1,mipLevel:1,flags:exports.GFXTextureFlagBit.NONE}),this._colorTexView=this._device.createTextureView({texture:this._colorTex,type:exports.GFXTextureViewType.TV2D,format:this._colorFmt,baseLevel:0,levelCount:1,baseLayer:0,layerCount:1}),t.push(this._colorTexView)),this._depthStencilFmt!==exports.GFXFormat.UNKNOWN&&(this._depthStencilTex=this._device.createTexture({type:exports.GFXTextureType.TEX2D,usage:exports.GFXTextureUsageBit.DEPTH_STENCIL_ATTACHMENT,format:this._depthStencilFmt,width:this._width,height:this._height,depth:1,arrayLayer:1,mipLevel:1,flags:exports.GFXTextureFlagBit.NONE}),this._depthStencilTexView=this._device.createTextureView({texture:this._depthStencilTex,type:exports.GFXTextureViewType.TV2D,format:this._depthStencilFmt,baseLevel:0,levelCount:1,baseLayer:0,layerCount:1}))),this._framebuffer=this._device.createFramebuffer({renderPass:this._renderPass,colorViews:t,depthStencilView:this._depthStencilTexView,isOffscreen:this._isOffscreen}),this._status=exports.GFXStatus.SUCCESS,!0}},{key:"destroy",value:function(){this._depthStencilTexView&&(this._depthStencilTexView.destroy(),this._depthStencilTexView=null),this._depthStencilTex&&(this._depthStencilTex.destroy(),this._depthStencilTex=null),this._colorTexView&&(this._colorTexView.destroy(),this._colorTexView=null),this._colorTex&&(this._colorTex.destroy(),this._colorTex=null),this._framebuffer&&(this._framebuffer.destroy(),this._framebuffer=null),this._renderPass&&(this._renderPass.destroy(),this._renderPass=null),this._status=exports.GFXStatus.UNREADY}},{key:"resize",value:function(e,t){this._width=e,this._height=t,(e>this._nativeWidth||t>this._nativeHeight)&&(this._nativeWidth=e,this._nativeHeight=t,this._depthStencilTex&&(this._depthStencilTex.resize(e,t),this._depthStencilTexView.destroy(),this._depthStencilTexView.initialize({texture:this._depthStencilTex,type:exports.GFXTextureViewType.TV2D,format:this._depthStencilFmt})),this._colorTex&&(this._colorTex.resize(e,t),this._colorTexView.destroy(),this._colorTexView.initialize({texture:this._colorTex,type:exports.GFXTextureViewType.TV2D,format:this._colorFmt})),this._framebuffer&&this._framebuffer.isOffscreen&&(this._framebuffer.destroy(),this._framebuffer.initialize({renderPass:this._renderPass,colorViews:[this._colorTexView],depthStencilView:this._depthStencilTexView})))}}]),t}(),TD=function(e){function t(){var e;return Z(this,t),(e=re(this,te(t).call(this))).stateCache=new yD,e.nullTex2D=null,e.nullTexCube=null,e._webGLRC=null,e._isAntialias=!0,e._isPremultipliedAlpha=!0,e._useVAO=!1,e._destroyShadersImmediately=!0,e._noCompressedTexSubImage2D=!1,e._extensions=null,e._EXT_texture_filter_anisotropic=null,e._EXT_frag_depth=null,e._EXT_shader_texture_lod=null,e._EXT_sRGB=null,e._OES_vertex_array_object=null,e._EXT_color_buffer_half_float=null,e._WEBGL_color_buffer_float=null,e._WEBGL_compressed_texture_etc1=null,e._WEBGL_compressed_texture_etc=null,e._WEBGL_compressed_texture_pvrtc=null,e._WEBGL_compressed_texture_astc=null,e._WEBGL_compressed_texture_s3tc=null,e._WEBGL_compressed_texture_s3tc_srgb=null,e._WEBGL_debug_shaders=null,e._WEBGL_draw_buffers=null,e._WEBGL_lose_context=null,e._WEBGL_depth_texture=null,e._WEBGL_debug_renderer_info=null,e._OES_texture_half_float=null,e._OES_texture_half_float_linear=null,e._OES_texture_float=null,e._OES_texture_float_linear=null,e._OES_standard_derivatives=null,e._OES_element_index_uint=null,e._ANGLE_instanced_arrays=null,e}return ee(t,kr),J(t,[{key:"gl",get:function(){return this._webGLRC}},{key:"webGLQueue",get:function(){return this._queue}},{key:"isAntialias",get:function(){return this._isAntialias}},{key:"isPremultipliedAlpha",get:function(){return this._isPremultipliedAlpha}},{key:"useVAO",get:function(){return this._useVAO}},{key:"destroyShadersImmediately",get:function(){return this._destroyShadersImmediately}},{key:"noCompressedTexSubImage2D",get:function(){return this._noCompressedTexSubImage2D}},{key:"EXT_texture_filter_anisotropic",get:function(){return this._EXT_texture_filter_anisotropic}},{key:"EXT_frag_depth",get:function(){return this._EXT_frag_depth}},{key:"EXT_shader_texture_lod",get:function(){return this._EXT_shader_texture_lod}},{key:"EXT_sRGB",get:function(){return this._EXT_sRGB}},{key:"OES_vertex_array_object",get:function(){return this._OES_vertex_array_object}},{key:"WEBGL_color_buffer_float",get:function(){return this._WEBGL_color_buffer_float}},{key:"WEBGL_compressed_texture_etc1",get:function(){return this._WEBGL_compressed_texture_etc1}},{key:"WEBGL_compressed_texture_pvrtc",get:function(){return this._WEBGL_compressed_texture_pvrtc}},{key:"WEBGL_compressed_texture_astc",get:function(){return this._WEBGL_compressed_texture_astc}},{key:"WEBGL_compressed_texture_s3tc",get:function(){return this._WEBGL_compressed_texture_s3tc}},{key:"WEBGL_compressed_texture_s3tc_srgb",get:function(){return this._WEBGL_compressed_texture_s3tc_srgb}},{key:"WEBGL_debug_shaders",get:function(){return this._WEBGL_debug_shaders}},{key:"WEBGL_draw_buffers",get:function(){return this._WEBGL_draw_buffers}},{key:"WEBGL_lose_context",get:function(){return this._WEBGL_lose_context}},{key:"WEBGL_depth_texture",get:function(){return this._WEBGL_depth_texture}},{key:"WEBGL_debug_renderer_info",get:function(){return this._WEBGL_debug_renderer_info}},{key:"OES_texture_half_float",get:function(){return this._OES_texture_half_float}},{key:"OES_texture_half_float_linear",get:function(){return this._OES_texture_half_float_linear}},{key:"OES_texture_float",get:function(){return this._OES_texture_float}},{key:"OES_standard_derivatives",get:function(){return this._OES_standard_derivatives}},{key:"OES_element_index_uint",get:function(){return this._OES_element_index_uint}},{key:"ANGLE_instanced_arrays",get:function(){return this._ANGLE_instanced_arrays}}]),J(t,[{key:"initialize",value:function(e){this._canvas=e.canvasElm,this._isAntialias=void 0===e.isAntialias||e.isAntialias,this._isPremultipliedAlpha=void 0===e.isPremultipliedAlpha||e.isPremultipliedAlpha;try{var t={alpha:cu.ENABLE_TRANSPARENT_CANVAS,antialias:this._isAntialias,depth:!0,stencil:!0,premultipliedAlpha:this._isPremultipliedAlpha,preserveDrawingBuffer:!1,powerPreference:"default",failIfMajorPerformanceCaveat:!1};this._webGLRC=this._canvas.getContext("webgl",t)}catch(e){return console.error(e),!1}if(!this._webGLRC)return console.error("This device does not support WebGL."),!1;this._canvas2D=document.createElement("canvas"),console.info("WebGL device initialized."),this._gfxAPI=exports.GFXAPI.WEBGL,this._deviceName="WebGL";var i=this._webGLRC;this._WEBGL_debug_renderer_info=this.getExtension("WEBGL_debug_renderer_info"),this._WEBGL_debug_renderer_info?(this._renderer=i.getParameter(this._WEBGL_debug_renderer_info.UNMASKED_RENDERER_WEBGL),this._vendor=i.getParameter(this._WEBGL_debug_renderer_info.UNMASKED_VENDOR_WEBGL)):(this._renderer=i.getParameter(i.RENDERER),this._vendor=i.getParameter(i.VENDOR)),this._version=i.getParameter(i.VERSION),this._maxVertexAttributes=i.getParameter(i.MAX_VERTEX_ATTRIBS),this._maxVertexUniformVectors=i.getParameter(i.MAX_VERTEX_UNIFORM_VECTORS),this._maxFragmentUniformVectors=i.getParameter(i.MAX_FRAGMENT_UNIFORM_VECTORS),this._maxTextureUnits=i.getParameter(i.MAX_TEXTURE_IMAGE_UNITS),this._maxVertexTextureUnits=i.getParameter(i.MAX_VERTEX_TEXTURE_IMAGE_UNITS),this._maxTextureSize=i.getParameter(i.MAX_TEXTURE_SIZE),this._maxCubeMapTextureSize=i.getParameter(i.MAX_CUBE_MAP_TEXTURE_SIZE),this._depthBits=i.getParameter(i.DEPTH_BITS),this._stencilBits=i.getParameter(i.STENCIL_BITS),this._devicePixelRatio=e.devicePixelRatio||1,this._width=this._canvas.width,this._height=this._canvas.height,this._nativeWidth=Math.max(e.nativeWidth||this._width,0),this._nativeHeight=Math.max(e.nativeHeight||this._height,0),this._colorFmt=exports.GFXFormat.RGBA8,24===this._depthBits?8===this._stencilBits?this._depthStencilFmt=exports.GFXFormat.D24S8:this._depthStencilFmt=exports.GFXFormat.D24:8===this._stencilBits?this._depthStencilFmt=exports.GFXFormat.D16S8:this._depthStencilFmt=exports.GFXFormat.D16,this._extensions=i.getSupportedExtensions();var n="";if(this._extensions){for(var r,a=_e(this._extensions);!(r=a()).done;){n+=r.value+" "}console.debug("EXTENSIONS: "+n)}this._EXT_texture_filter_anisotropic=this.getExtension("EXT_texture_filter_anisotropic"),this._EXT_frag_depth=this.getExtension("EXT_frag_depth"),this._EXT_shader_texture_lod=this.getExtension("EXT_shader_texture_lod"),this._EXT_sRGB=this.getExtension("EXT_sRGB"),this._OES_vertex_array_object=this.getExtension("OES_vertex_array_object"),this._EXT_color_buffer_half_float=this.getExtension("EXT_color_buffer_half_float"),this._WEBGL_color_buffer_float=this.getExtension("WEBGL_color_buffer_float"),this._WEBGL_compressed_texture_etc1=this.getExtension("WEBGL_compressed_texture_etc1"),this._WEBGL_compressed_texture_etc=this.getExtension("WEBGL_compressed_texture_etc"),this._WEBGL_compressed_texture_pvrtc=this.getExtension("WEBGL_compressed_texture_pvrtc"),this._WEBGL_compressed_texture_astc=this.getExtension("WEBGL_compressed_texture_astc"),this._WEBGL_compressed_texture_s3tc=this.getExtension("WEBGL_compressed_texture_s3tc"),this._WEBGL_compressed_texture_s3tc_srgb=this.getExtension("WEBGL_compressed_texture_s3tc_srgb"),this._WEBGL_debug_shaders=this.getExtension("WEBGL_debug_shaders"),this._WEBGL_draw_buffers=this.getExtension("WEBGL_draw_buffers"),this._WEBGL_lose_context=this.getExtension("WEBGL_lose_context"),this._WEBGL_depth_texture=this.getExtension("WEBGL_depth_texture"),this._OES_texture_half_float=this.getExtension("OES_texture_half_float"),this._OES_texture_half_float_linear=this.getExtension("OES_texture_half_float_linear"),this._OES_texture_float=this.getExtension("OES_texture_float"),this._OES_texture_float_linear=this.getExtension("OES_texture_float_linear"),this._OES_standard_derivatives=this.getExtension("OES_standard_derivatives"),this._OES_element_index_uint=this.getExtension("OES_element_index_uint"),this._ANGLE_instanced_arrays=this.getExtension("ANGLE_instanced_arrays"),Cs.browserType===Cs.BROWSER_TYPE_UC&&(this._ANGLE_instanced_arrays=null),(Cs.os===Cs.OS_IOS&&Cs.osMainVersion<=10||Cs.platform===Cs.WECHAT_GAME&&Cs.os===Cs.OS_ANDROID)&&(this._destroyShadersImmediately=!1),this._noCompressedTexSubImage2D=!0,this._features.fill(!1),this._WEBGL_color_buffer_float&&(this._features[exports.GFXFeature.COLOR_FLOAT]=!0),this._EXT_color_buffer_half_float&&(this._features[exports.GFXFeature.COLOR_HALF_FLOAT]=!0),this._OES_texture_float&&(this._features[exports.GFXFeature.TEXTURE_FLOAT]=!0),this._OES_texture_half_float&&(this._features[exports.GFXFeature.TEXTURE_HALF_FLOAT]=!0),this._OES_texture_float_linear&&(this._features[exports.GFXFeature.TEXTURE_FLOAT_LINEAR]=!0),this._OES_texture_half_float_linear&&(this._features[exports.GFXFeature.TEXTURE_HALF_FLOAT_LINEAR]=!0),this._WEBGL_depth_texture&&(this._features[exports.GFXFeature.FORMAT_D24S8]=!0),this._OES_element_index_uint&&(this._features[exports.GFXFeature.ELEMENT_INDEX_UINT]=!0),this._ANGLE_instanced_arrays&&(this._features[exports.GFXFeature.INSTANCED_ARRAYS]=!0);var o="";this._WEBGL_compressed_texture_etc1&&(this._features[exports.GFXFeature.FORMAT_ETC1]=!0,o+="etc1 "),this._WEBGL_compressed_texture_etc&&(this._features[exports.GFXFeature.FORMAT_ETC2]=!0,o+="etc2 "),this._WEBGL_compressed_texture_s3tc&&(this._features[exports.GFXFeature.FORMAT_DXT]=!0,o+="dxt "),this._WEBGL_compressed_texture_pvrtc&&(this._features[exports.GFXFeature.FORMAT_PVRTC]=!0,o+="pvrtc "),this._WEBGL_compressed_texture_astc&&(this._features[exports.GFXFeature.FORMAT_ASTC]=!0,o+="astc "),this._features[exports.GFXFeature.MSAA]=!1,this._OES_vertex_array_object&&(this._useVAO=!0),console.info("RENDERER: "+this._renderer),console.info("VENDOR: "+this._vendor),console.info("VERSION: "+this._version),console.info("DPR: "+this._devicePixelRatio),console.info("SCREEN_SIZE: "+this._width+" x "+this._height),console.info("NATIVE_SIZE: "+this._nativeWidth+" x "+this._nativeHeight),console.info("MAX_VERTEX_UNIFORM_VECTORS: "+this._maxVertexUniformVectors),console.info("DEPTH_BITS: "+this._depthBits),console.info("STENCIL_BITS: "+this._stencilBits),this._EXT_texture_filter_anisotropic&&console.info("MAX_TEXTURE_MAX_ANISOTROPY_EXT: "+this._EXT_texture_filter_anisotropic.MAX_TEXTURE_MAX_ANISOTROPY_EXT),console.info("USE_VAO: "+this._useVAO),console.info("COMPRESSED_FORMAT: "+o),this.initStates(i),this._queue=this.createQueue({type:exports.GFXQueueType.GRAPHICS});var s=this._webGLRC.canvas;this._mainWindow=this.createWindow({title:s.title||"",left:s.offsetLeft||0,top:s.offsetTop||0,width:this._webGLRC.drawingBufferWidth,height:this._webGLRC.drawingBufferHeight,colorFmt:this._colorFmt,depthStencilFmt:this._depthStencilFmt}),this._cmdAllocator=this.createCommandAllocator({}),this.nullTex2D=new gD(this),this.nullTex2D.initialize({type:exports.GFXTextureType.TEX2D,usage:exports.GFXTextureUsageBit.SAMPLED,format:exports.GFXFormat.RGBA8,width:2,height:2,flags:exports.GFXTextureFlagBit.GEN_MIPMAP}),this.nullTexCube=new gD(this),this.nullTexCube.initialize({type:exports.GFXTextureType.TEX2D,usage:exports.GFXTextureUsageBit.SAMPLED,format:exports.GFXFormat.RGBA8,width:2,height:2,arrayLayer:6,flags:exports.GFXTextureFlagBit.CUBEMAP|exports.GFXTextureFlagBit.GEN_MIPMAP});var l={buffOffset:0,buffStride:0,buffTexHeight:0,texOffset:{x:0,y:0,z:0},texExtent:{width:2,height:2,depth:1},texSubres:{baseMipLevel:0,levelCount:1,baseArrayLayer:0,layerCount:1}},u=new Uint8Array(this.nullTex2D.size);return u.fill(0),this.copyBuffersToTexture([u],this.nullTex2D,[l]),l.texSubres.layerCount=6,this.copyBuffersToTexture([u,u,u,u,u,u],this.nullTexCube,[l]),!0}},{key:"destroy",value:function(){this.nullTex2D&&(this.nullTex2D.destroy(),this.nullTex2D=null),this.nullTexCube&&(this.nullTexCube.destroy(),this.nullTexCube=null),this._mainWindow&&(this._mainWindow.destroy(),this._mainWindow=null),this._cmdAllocator&&(this._cmdAllocator.destroy(),this._cmdAllocator=null),this._queue&&(this._queue.destroy(),this._queue=null),this._webGLRC=null}},{key:"resize",value:function(e,t){this._width===e&&this._height===t||(console.info("Resizing device: "+e+"x"+t),this._canvas.width=e,this._canvas.height=t,this._width=e,this._height=t)}},{key:"createBuffer",value:function(e){var t=new iD(this);return t.initialize(e),t}},{key:"createTexture",value:function(e){var t=new gD(this);return t.initialize(e),t}},{key:"createTextureView",value:function(e){var t=new xD(this);return t.initialize(e),t}},{key:"createSampler",value:function(e){var t=new mD(this);return t.initialize(e),t}},{key:"createBindingLayout",value:function(e){var t=new OL(this);return t.initialize(e),t}},{key:"createShader",value:function(e){var t=new vD(this);return t.initialize(e),t}},{key:"createInputAssembler",value:function(e){var t=new sD(this);return t.initialize(e),t}},{key:"createRenderPass",value:function(e){var t=new fD(this);return t.initialize(e),t}},{key:"createFramebuffer",value:function(e){var t=new oD(this);return t.initialize(e),t}},{key:"createPipelineLayout",value:function(e){var t=new lD(this);return t.initialize(e),t}},{key:"createPipelineState",value:function(e){var t=new cD(this);return t.initialize(e),t}},{key:"createCommandAllocator",value:function(e){var t=new rD(this);return t.initialize(e),t}},{key:"createCommandBuffer",value:function(e){var t=new(e.type===exports.GFXCommandBufferType.PRIMARY?pD:aD)(this);return t.initialize(e),t}},{key:"createQueue",value:function(e){var t=new _D(this);return t.initialize(e),t}},{key:"createWindow",value:function(e){var t=new bD(this);return t.initialize(e),t}},{key:"present",value:function(){this._cmdAllocator.releaseCmds();var e=this._queue;this._numDrawCalls=e.numDrawCalls,this._numInstances=e.numInstances,this._numTris=e.numTris,e.clear()}},{key:"copyBuffersToTexture",value:function(e,t,i){tD(this,e,t.gpuTexture,i)}},{key:"copyTexImagesToTexture",value:function(e,t,i){!function(e,t,i,n){var r=e.gl,a=e.stateCache.glTexUnits[e.stateCache.texUnit];a.glTexture!==i.glTexture&&(r.bindTexture(i.glTarget,i.glTexture),a.glTexture=i.glTexture);var o=0,s=0,l=0;switch(i.glTarget){case r.TEXTURE_2D:for(var u=0;u<n.length;u++){var c=n[u];for(o=c.texSubres.baseMipLevel;o<c.texSubres.levelCount;++o)r.texSubImage2D(r.TEXTURE_2D,o,c.texOffset.x,c.texOffset.y,i.glFormat,i.glType,t[s++])}break;case r.TEXTURE_CUBE_MAP:for(var h=0;h<n.length;h++){var p=n[h],_=p.texSubres.baseArrayLayer+p.texSubres.layerCount;for(l=p.texSubres.baseArrayLayer;l<_;++l){var f=p.texSubres.baseMipLevel+p.texSubres.levelCount;for(o=p.texSubres.baseMipLevel;o<f;++o)r.texSubImage2D(r.TEXTURE_CUBE_MAP_POSITIVE_X+l,o,p.texOffset.x,p.texOffset.y,i.glFormat,i.glType,t[s++])}}break;default:console.error("Unsupported GL texture type, copy buffer to texture failed.")}i.flags&exports.GFXTextureFlagBit.GEN_MIPMAP&&i.isPowerOf2&&r.generateMipmap(i.glTarget)}(this,e,t.gpuTexture,i)}},{key:"copyFramebufferToBuffer",value:function(e,t,i){var n=this._webGLRC,r=e.gpuFramebuffer,a=r.gpuColorViews[0].format,o=FL(a,n),s=kL(a,n),l=Sr(yr[a]),u=this.stateCache.glFramebuffer;this.stateCache.glFramebuffer!==r.glFramebuffer&&(n.bindFramebuffer(n.FRAMEBUFFER,r.glFramebuffer),this.stateCache.glFramebuffer=r.glFramebuffer);for(var c,h=new l(t),p=_e(i);!(c=p()).done;){var _=c.value,f=_.buffOffset+_.buffTexHeight*_.buffStride,d=_.texExtent.width,m=_.texExtent.height,v=gr(a,d,m,1),y=h.subarray(f,f+v);n.readPixels(_.texOffset.x,_.texOffset.y,d,m,o,s,y)}this.stateCache.glFramebuffer!==u&&(n.bindFramebuffer(n.FRAMEBUFFER,u),this.stateCache.glFramebuffer=u)}},{key:"blitFramebuffer",value:function(e,t,i,n,r){}},{key:"getExtension",value:function(e){for(var t=["","WEBKIT_","MOZ_"],i=0;i<t.length;++i){var n=this._webGLRC.getExtension(t[i]+e);if(n)return n}return null}},{key:"initStates",value:function(e){e.activeTexture(e.TEXTURE0),e.pixelStorei(e.PACK_ALIGNMENT,1),e.pixelStorei(e.UNPACK_ALIGNMENT,1),e.pixelStorei(e.UNPACK_FLIP_Y_WEBGL,0),e.bindFramebuffer(e.FRAMEBUFFER,null),e.disable(e.SCISSOR_TEST),e.enable(e.CULL_FACE),e.cullFace(e.BACK),e.frontFace(e.CCW),e.disable(e.POLYGON_OFFSET_FILL),e.polygonOffset(0,0),e.enable(e.DEPTH_TEST),e.depthMask(!0),e.depthFunc(e.LESS),e.depthRange(0,1),e.stencilFuncSeparate(e.FRONT,e.ALWAYS,1,65535),e.stencilOpSeparate(e.FRONT,e.KEEP,e.KEEP,e.KEEP),e.stencilMaskSeparate(e.FRONT,65535),e.stencilFuncSeparate(e.BACK,e.ALWAYS,1,65535),e.stencilOpSeparate(e.BACK,e.KEEP,e.KEEP,e.KEEP),e.stencilMaskSeparate(e.BACK,65535),e.disable(e.STENCIL_TEST),e.disable(e.SAMPLE_ALPHA_TO_COVERAGE),e.disable(e.BLEND),e.blendEquationSeparate(e.FUNC_ADD,e.FUNC_ADD),e.blendFuncSeparate(e.ONE,e.ZERO,e.ONE,e.ZERO),e.colorMask(!0,!0,!0,!0),e.blendColor(0,0,0,0)}}]),t}();cc.WebGLGFXDevice=TD;var SD,ED,wD,CD,AD,OD,kD,RD,FD,MD,ID,PD,LD,DD,ND,zD,BD,GD,UD,XD,VD,HD,WD,jD,qD,YD,KD,ZD,QD,JD,$D,eN,tN,iN,nN,rN,aN,oN=new Ii,sN=new Ki;function lN(e,t,i,n){var r=i.datas,a=t.currBufferBatch,o=a.byteOffset>>2,s=i.vertexCount,l=a.indiceOffset,u=a.vertexOffset;a.request(s,i.indiceCount)||(a=t.currBufferBatch,s=0,l=0,u=0);var c=a.vData,h=a.iData;e.getWorldMatrix(sN);for(var p=0;p<s;p++){var _=r[p];Ii.set(oN,_.x,_.y,0),Ii.transformMat4(oN,oN,sN),c[o++]=oN.x,c[o++]=oN.y,c[o++]=oN.z,c[o++]=_.u,c[o++]=_.v,an.toArray(c,n,o),o+=4}for(var f=0,d=s/4;f<d;f++){var m=u+4*f;h[l++]=m,h[l++]=m+1,h[l++]=m+2,h[l++]=m+1,h[l++]=m+3,h[l++]=m+2}}var uN,cN,hN,pN=new an;!function(e){e[e.NONE=0]="NONE",e[e.COLOR=1]="COLOR",e[e.SPRITE=2]="SPRITE",e[e.SCALE=3]="SCALE"}(uN||(uN={})),bt(uN),function(e){e.NORMAL="normal",e.HOVER="hover",e.PRESSED="pressed",e.DISABLED="disabled"}(cN||(cN={})),(hN||(hN={})).CLICK="click";var _N=(SD=Yo("cc.ButtonComponent"),ED=os("i18n:cc.ButtonComponent"),wD=ts(110),CD=es("UI/Button"),AD=$o(Iy),OD=Ko({type:tg,displayOrder:0,tooltip:"指定 Button 背景节点，Button 状态改变时会修改此节点的 Color 或 Sprite 属性"}),kD=Ko({displayOrder:1,tooltip:"按钮是否可交互，这一项未选中时，按钮处在禁用状态"}),RD=Ko({type:uN,displayOrder:2,tooltip:"按钮状态变化时的过渡类型"}),FD=Ko({tooltip:"普通状态的按钮背景颜色"}),MD=Ko({tooltip:"按下状态的按钮背景颜色"}),ID=Ko({tooltip:"悬停状态的按钮背景颜色"}),PD=Ko({tooltip:"禁用状态的按钮背景颜色"}),LD=Ko({min:0,max:10,tooltip:"按钮颜色变化或者缩放变化的过渡时间"}),DD=Ko({tooltip:"当用户点击按钮后，按钮会缩放到一个值，这个值等于 Button 原始 scale * zoomScale。"}),ND=Ko({type:Ac,tooltip:"普通状态的按钮背景图资源"}),zD=Ko({type:Ac,tooltip:"按下状态的按钮背景图资源"}),BD=Ko({type:Ac,tooltip:"悬停状态的按钮背景图资源"}),GD=Ko({type:Ac,tooltip:"禁用状态的按钮背景图资源"}),UD=Ko({type:[fO],displayOrder:20,tooltip:"按钮点击事件的列表。先将数量改为1或更多，就可以为每个点击事件设置接受者和处理方法"}),SD(XD=ED(XD=wD(XD=CD(XD=AD((aN=rN=function(e){function t(){var e,i;Z(this,t);for(var n=arguments.length,r=new Array(n),a=0;a<n;a++)r[a]=arguments[a];return fe(i=re(this,(e=te(t)).call.apply(e,[this].concat(r))),"clickEvents",HD,ne(i)),fe(i,"_interactable",WD,ne(i)),fe(i,"_transition",jD,ne(i)),fe(i,"_normalColor",qD,ne(i)),fe(i,"_hoverColor",YD,ne(i)),fe(i,"_pressColor",KD,ne(i)),fe(i,"_disabledColor",ZD,ne(i)),fe(i,"_normalSprite",QD,ne(i)),fe(i,"_hoverSprite",JD,ne(i)),fe(i,"_pressedSprite",$D,ne(i)),fe(i,"_disabledSprite",eN,ne(i)),fe(i,"_duration",tN,ne(i)),fe(i,"_zoomScale",iN,ne(i)),fe(i,"_target",nN,ne(i)),i._pressed=!1,i._hovered=!1,i._fromColor=new an,i._toColor=new an,i._time=0,i._transitionFinished=!0,i._fromScale=new Ii,i._toScale=new Ii,i._originalScale=new Ii,i._sprite=null,i._targetScale=new Ii,i}return ee(t,rp),J(t,[{key:"__preload",value:function(){this.target||(this.target=this.node);var e=this.node.getComponent(LA);e&&(this._normalSprite=e.spriteFrame),this._applyTarget(),this._updateState()}},{key:"onEnable",value:function(){this._registerEvent()}},{key:"onDisable",value:function(){this._resetState(),this.node.off(exports.SystemEventType.TOUCH_START,this._onTouchBegan,this),this.node.off(exports.SystemEventType.TOUCH_MOVE,this._onTouchMove,this),this.node.off(exports.SystemEventType.TOUCH_END,this._onTouchEnded,this),this.node.off(exports.SystemEventType.TOUCH_CANCEL,this._onTouchCancel,this),this.node.off(exports.SystemEventType.MOUSE_ENTER,this._onMouseMoveIn,this),this.node.off(exports.SystemEventType.MOUSE_LEAVE,this._onMouseMoveOut,this)}},{key:"update",value:function(e){var t=this._target?this._target:this.node;if(!this._transitionFinished&&(this._transition===uN.COLOR||this._transition===uN.SCALE)){this._time+=e;var i=1;this._duration>0&&(i=this._time/this._duration),i>=1&&(i=1,this._transitionFinished=!0);var n=t.getComponent(wA);n&&(this._transition===uN.COLOR?(an.lerp(pN,this._fromColor,this._toColor,i),n.color=pN):this.transition===uN.SCALE&&(t.getScale(this._targetScale),this._targetScale.x=fi(this._fromScale.x,this._toScale.x,i),this._targetScale.y=fi(this._fromScale.y,this._toScale.y,i),t.setScale(this._targetScale)))}}},{key:"_resizeNodeToTargetNode",value:function(){}},{key:"_resetState",value:function(){this._pressed=!1,this._hovered=!1;var e=this._target;if(e){var t=e.getComponent(wA);if(t){var i=this._transition;i===uN.COLOR&&this._interactable?t.color=this._normalColor:i===uN.SCALE&&e.setScale(this._originalScale),this._transitionFinished=!0}}}},{key:"_registerEvent",value:function(){this.node.on(exports.SystemEventType.TOUCH_START,this._onTouchBegan,this),this.node.on(exports.SystemEventType.TOUCH_MOVE,this._onTouchMove,this),this.node.on(exports.SystemEventType.TOUCH_END,this._onTouchEnded,this),this.node.on(exports.SystemEventType.TOUCH_CANCEL,this._onTouchCancel,this),this.node.on(exports.SystemEventType.MOUSE_ENTER,this._onMouseMoveIn,this),this.node.on(exports.SystemEventType.MOUSE_LEAVE,this._onMouseMoveOut,this)}},{key:"_getTargetSprite",value:function(e){var t=null;return e&&(t=e.getComponent(LA)),t}},{key:"_applyTarget",value:function(){this._sprite=this._getTargetSprite(this._target),this._target&&Ii.copy(this._originalScale,this._target.getScale())}},{key:"_onTouchBegan",value:function(e){this._interactable&&this.enabledInHierarchy&&(this._pressed=!0,this._updateState(),e&&(e.propagationStopped=!0))}},{key:"_onTouchMove",value:function(e){if(this._interactable&&this.enabledInHierarchy&&this._pressed){if(!e)return!1;var t=e.touch;if(!t)return!1;var i,n=this.node._uiProps.uiTransformComp.isHit(t.getUILocation());if(this._transition===uN.SCALE&&this._target)n?(Ii.copy(this._fromScale,this._originalScale),Ii.multiplyScalar(this._toScale,this._originalScale,this._zoomScale),this._transitionFinished=!1):(this._time=0,this._transitionFinished=!0,this._target&&this._target.setScale(this._originalScale));else i=n?cN.PRESSED:cN.NORMAL,this._applyTransition(i);e&&(e.propagationStopped=!0)}}},{key:"_onTouchEnded",value:function(e){this._interactable&&this.enabledInHierarchy&&(this._pressed&&(fO.emitEvents(this.clickEvents,e),this.node.emit(hN.CLICK,this)),this._pressed=!1,this._updateState(),e&&(e.propagationStopped=!0))}},{key:"_onTouchCancel",value:function(e){this._interactable&&this.enabledInHierarchy&&(this._pressed=!1,this._updateState())}},{key:"_onMouseMoveIn",value:function(e){!this._pressed&&this.interactable&&this.enabledInHierarchy&&(this._transition!==uN.SPRITE||this._hoverSprite)&&(this._hovered||(this._hovered=!0,this._updateState()))}},{key:"_onMouseMoveOut",value:function(e){this._hovered&&(this._hovered=!1,this._updateState())}},{key:"_updateState",value:function(){var e=this._getButtonState();this._applyTransition(e)}},{key:"_getButtonState",value:function(){var e=cN.NORMAL;return this._interactable?this._pressed?e=cN.PRESSED:this._hovered&&(e=cN.HOVER):e=cN.DISABLED,e.toString()}},{key:"_updateColorTransition",value:function(e){var t=this[e+"Color"],i=this._target;if(i){var n=i.getComponent(wA);n&&(e===cN.DISABLED?n.color=t:(this._fromColor=n.color.clone(),this._toColor=t,this._time=0,this._transitionFinished=!1))}}},{key:"_updateSpriteTransition",value:function(e){var t=this[e+"Sprite"];this._sprite&&t&&(this._sprite.spriteFrame=t)}},{key:"_updateScaleTransition",value:function(e){this._interactable&&(e===cN.PRESSED?this._zoomUp():this._zoomBack())}},{key:"_zoomUp",value:function(){Ii.copy(this._fromScale,this._originalScale),Ii.multiplyScalar(this._toScale,this._originalScale,this._zoomScale),this._time=0,this._transitionFinished=!1}},{key:"_zoomBack",value:function(){this._target&&(Ii.copy(this._fromScale,this._target.getScale()),Ii.copy(this._toScale,this._originalScale),this._time=0,this._transitionFinished=!1)}},{key:"_applyTransition",value:function(e){var t=this._transition;t===uN.COLOR?this._updateColorTransition(e):t===uN.SPRITE?this._updateSpriteTransition(e):t===uN.SCALE&&this._updateScaleTransition(e)}},{key:"target",get:function(){return this._target},set:function(e){this._target!==e&&(this._target=e,this._applyTarget())}},{key:"interactable",get:function(){return this._interactable},set:function(e){this._interactable=e,this._updateState(),this._interactable||this._resetState()}},{key:"_resizeToTarget",set:function(e){e&&this._resizeNodeToTargetNode()}},{key:"transition",get:function(){return this._transition},set:function(e){this._transition!==e&&(this._transition=e)}},{key:"normalColor",get:function(){return this._normalColor},set:function(e){this._normalColor!==e&&(this._normalColor.set(e),this._updateState())}},{key:"pressedColor",get:function(){return this._pressColor},set:function(e){this._pressColor!==e&&this._pressColor.set(e)}},{key:"hoverColor",get:function(){return this._hoverColor},set:function(e){this._hoverColor!==e&&this._hoverColor.set(e)}},{key:"disabledColor",get:function(){return this._disabledColor},set:function(e){this._disabledColor!==e&&(this._disabledColor.set(e),this._updateState())}},{key:"duration",get:function(){return this._duration},set:function(e){this._duration!==e&&(this._duration=e)}},{key:"zoomScale",get:function(){return this._zoomScale},set:function(e){this._zoomScale!==e&&(this._zoomScale=e)}},{key:"normalSprite",get:function(){return this._normalSprite},set:function(e){if(this._normalSprite!==e){this._normalSprite=e;var t=this.node.getComponent(LA);t&&(t.spriteFrame=e),this._updateState()}}},{key:"pressedSprite",get:function(){return this._pressedSprite},set:function(e){this._pressedSprite!==e&&(this._pressedSprite=e,this._updateState())}},{key:"hoverSprite",get:function(){return this._hoverSprite},set:function(e){this._hoverSprite!==e&&(this._hoverSprite=e,this._updateState())}},{key:"disabledSprite",get:function(){return this._disabledSprite},set:function(e){this._disabledSprite!==e&&(this._disabledSprite=e,this._updateState())}}]),t}(),rN.Transition=uN,rN.EventType=hN,de((VD=aN).prototype,"target",[OD],Object.getOwnPropertyDescriptor(VD.prototype,"target"),VD.prototype),de(VD.prototype,"interactable",[kD],Object.getOwnPropertyDescriptor(VD.prototype,"interactable"),VD.prototype),de(VD.prototype,"transition",[RD],Object.getOwnPropertyDescriptor(VD.prototype,"transition"),VD.prototype),de(VD.prototype,"normalColor",[FD],Object.getOwnPropertyDescriptor(VD.prototype,"normalColor"),VD.prototype),de(VD.prototype,"pressedColor",[MD],Object.getOwnPropertyDescriptor(VD.prototype,"pressedColor"),VD.prototype),de(VD.prototype,"hoverColor",[ID],Object.getOwnPropertyDescriptor(VD.prototype,"hoverColor"),VD.prototype),de(VD.prototype,"disabledColor",[PD],Object.getOwnPropertyDescriptor(VD.prototype,"disabledColor"),VD.prototype),de(VD.prototype,"duration",[LD],Object.getOwnPropertyDescriptor(VD.prototype,"duration"),VD.prototype),de(VD.prototype,"zoomScale",[DD],Object.getOwnPropertyDescriptor(VD.prototype,"zoomScale"),VD.prototype),de(VD.prototype,"normalSprite",[ND],Object.getOwnPropertyDescriptor(VD.prototype,"normalSprite"),VD.prototype),de(VD.prototype,"pressedSprite",[zD],Object.getOwnPropertyDescriptor(VD.prototype,"pressedSprite"),VD.prototype),de(VD.prototype,"hoverSprite",[BD],Object.getOwnPropertyDescriptor(VD.prototype,"hoverSprite"),VD.prototype),de(VD.prototype,"disabledSprite",[GD],Object.getOwnPropertyDescriptor(VD.prototype,"disabledSprite"),VD.prototype),HD=de(VD.prototype,"clickEvents",[UD],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return[]}}),WD=de(VD.prototype,"_interactable",[Ko],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return!0}}),jD=de(VD.prototype,"_transition",[Ko],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return uN.NONE}}),qD=de(VD.prototype,"_normalColor",[Ko],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return new an(214,214,214,255)}}),YD=de(VD.prototype,"_hoverColor",[Ko],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return new an(211,211,211,255)}}),KD=de(VD.prototype,"_pressColor",[Ko],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return an.WHITE.clone()}}),ZD=de(VD.prototype,"_disabledColor",[Ko],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return new an(124,124,124,255)}}),QD=de(VD.prototype,"_normalSprite",[Ko],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return null}}),JD=de(VD.prototype,"_hoverSprite",[Ko],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return null}}),$D=de(VD.prototype,"_pressedSprite",[Ko],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return null}}),eN=de(VD.prototype,"_disabledSprite",[Ko],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return null}}),tN=de(VD.prototype,"_duration",[Ko],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return.1}}),iN=de(VD.prototype,"_zoomScale",[Ko],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return 1.2}}),nN=de(VD.prototype,"_target",[Ko],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return null}}),XD=VD))||XD)||XD)||XD)||XD)||XD);cc.ButtonComponent=_N;var fN,dN,mN,vN,yN,gN,xN,bN,TN,SN,EN,wN,CN,AN,ON,kN,RN,FN,MN,IN,PN,LN,DN,NN,zN,BN,GN,UN,XN,VN,HN,WN,jN,qN,YN,KN,ZN,QN,JN,$N,ez,tz=function(){function e(){Z(this,e),this.pool=[]}return J(e,[{key:"get",value:function(){var e=this.pool.pop();if(!e){var t=document.createElement("canvas"),i=t.getContext("2d");e={canvas:t,context:i}}return e}},{key:"put",value:function(e){this.pool.length>=32||this.pool.push(e)}}]),e}();($N=exports.HorizontalTextAlignment||(exports.HorizontalTextAlignment={}))[$N.LEFT=0]="LEFT",$N[$N.CENTER=1]="CENTER",$N[$N.RIGHT=2]="RIGHT",bt(exports.HorizontalTextAlignment),function(e){e[e.TOP=0]="TOP",e[e.CENTER=1]="CENTER",e[e.BOTTOM=2]="BOTTOM"}(exports.VerticalTextAlignment||(exports.VerticalTextAlignment={})),bt(exports.VerticalTextAlignment),function(e){e[e.NONE=0]="NONE",e[e.CLAMP=1]="CLAMP",e[e.SHRINK=2]="SHRINK",e[e.RESIZE_HEIGHT=3]="RESIZE_HEIGHT"}(exports.Overflow||(exports.Overflow={})),bt(exports.Overflow),function(e){e[e.NONE=0]="NONE",e[e.BITMAP=1]="BITMAP",e[e.CHAR=2]="CHAR"}(ez||(ez={})),bt(ez);var iz=(fN=Yo("cc.LabelComponent"),dN=os("i18n:cc.LabelComponent"),mN=ts(110),vN=es("UI/Render/Label"),yN=Ko({displayOrder:4,multiline:!0,tooltip:"Label 显示的文本内容字符串"}),gN=Ko({type:exports.HorizontalTextAlignment,displayOrder:5,tooltip:"文字水平对齐模式"}),xN=Ko({type:exports.VerticalTextAlignment,displayOrder:6,tooltip:"文字垂直对齐模式"}),bN=Ko({readonly:!0,displayName:"Actual Font Size",visible:!1}),TN=Ko({displayOrder:7,tooltip:"文字尺寸，以 point 为单位"}),SN=Ko({displayOrder:8,tooltip:"文字字体名字"}),EN=Ko({displayOrder:8,tooltip:"文字行高，以 point 为单位"}),wN=Ko({type:exports.Overflow,displayOrder:9,tooltip:"文字排版模式，包括以下三种：\n 1. CLAMP: 节点约束框之外的文字会被截断 \n 2. SHRINK: 自动根据节点约束框缩小文字\n 3. RESIZE_HEIGHT: 根据文本内容自动更新节点的 height 属性."}),CN=Ko({displayOrder:10,tooltip:"自动换行"}),AN=Ko({type:Ld,displayOrder:11,tooltip:"Label 使用的字体资源"}),ON=Ko({displayOrder:12,tooltip:"是否使用系统默认字体"}),kN=Ko({type:ez,displayOrder:13,tooltip:"文本缓存模式，包括以下三种：\n 1. NONE: 不做任何缓存，文本内容进行一次绘制 \n 2. BITMAP: 将文本作为静态图像加入动态图集进行批次合并，但是不能频繁动态修改文本内容 \n 3. CHAR: 将文本拆分为字符并且把字符纹理缓存到一张字符图集中进行复用，适用于字符内容重复并且频繁更新的文本内容"}),RN=Ko({displayOrder:15,tooltip:"字体加粗"}),FN=Ko({displayOrder:16,tooltip:"字体倾斜"}),MN=Ko({displayOrder:17,tooltip:"字体加下划线"}),fN(IN=dN(IN=mN(IN=vN((JN=QN=function(e){function t(){var e;return Z(this,t),fe(e=re(this,te(t).call(this)),"_useOriginalSize",LN,ne(e)),fe(e,"_string",DN,ne(e)),fe(e,"_horizontalAlign",NN,ne(e)),fe(e,"_verticalAlign",zN,ne(e)),fe(e,"_actualFontSize",BN,ne(e)),fe(e,"_fontSize",GN,ne(e)),fe(e,"_fontFamily",UN,ne(e)),fe(e,"_lineHeight",XN,ne(e)),fe(e,"_overflow",VN,ne(e)),fe(e,"_enableWrapText",HN,ne(e)),fe(e,"_font",WN,ne(e)),fe(e,"_isSystemFontUsed",jN,ne(e)),e._spacingX=0,fe(e,"_isItalic",qN,ne(e)),fe(e,"_isBold",YN,ne(e)),fe(e,"_isUnderline",KN,ne(e)),fe(e,"_cacheMode",ZN,ne(e)),e._N$file=null,e._texture=null,e._ttfSpriteFrame=null,e._userDefinedFont=null,e._assemblerData=null,e._fontAtlas=null,e._letterTexture=null,e._ttfSpriteFrame=null,e}return ee(t,wA),J(t,[{key:"string",get:function(){return this._string},set:function(e){e=e.toString(),this._string!==e&&(this._string=e,this.updateRenderData())}},{key:"horizontalAlign",get:function(){return this._horizontalAlign},set:function(e){this._horizontalAlign!==e&&(this._horizontalAlign=e,this.updateRenderData())}},{key:"verticalAlign",get:function(){return this._verticalAlign},set:function(e){this._verticalAlign!==e&&(this._verticalAlign=e,this.updateRenderData())}},{key:"actualFontSize",get:function(){return this._actualFontSize},set:function(e){this._actualFontSize=e}},{key:"fontSize",get:function(){return this._fontSize},set:function(e){this._fontSize!==e&&(this._fontSize=e,this.updateRenderData())}},{key:"fontFamily",get:function(){return this._fontFamily},set:function(e){this._fontFamily!==e&&(this._fontFamily=e,this.updateRenderData())}},{key:"lineHeight",get:function(){return this._lineHeight},set:function(e){this._lineHeight!==e&&(this._lineHeight=e,this.updateRenderData())}},{key:"overflow",get:function(){return this._overflow},set:function(e){this._overflow!==e&&(this._overflow=e,this.updateRenderData())}},{key:"enableWrapText",get:function(){return this._enableWrapText},set:function(e){this._enableWrapText!==e&&(this._enableWrapText=e,this.updateRenderData())}},{key:"font",get:function(){return this._font},set:function(e){this._font!==e&&(this._isSystemFontUsed=!e,this._font=e,"string"==typeof e&&g(4e3),this._renderData&&(this.destroyRenderData(),this._renderData=null),this._fontAtlas=null,this.updateRenderData(!0))}},{key:"useSystemFont",get:function(){return this._isSystemFontUsed},set:function(e){this._isSystemFontUsed!==e&&(this.destroyRenderData(),this._renderData=null,this._isSystemFontUsed=!!e,e&&(this.font=null,this._flushAssembler(),this.updateRenderData()))}},{key:"cacheMode",get:function(){return this._cacheMode},set:function(e){this._cacheMode!==e&&(this._cacheMode===ez.CHAR&&(this._ttfSpriteFrame=null),this._cacheMode=e,this.updateRenderData(!0))}},{key:"spriteFrame",get:function(){return this._texture}},{key:"isBold",get:function(){return this._isBold},set:function(e){this._isBold!==e&&(this._isBold=e,this.updateRenderData())}},{key:"isItalic",get:function(){return this._isItalic},set:function(e){this._isItalic!==e&&(this._isItalic=e,this.updateRenderData())}},{key:"isUnderline",get:function(){return this._isUnderline},set:function(e){this._isUnderline!==e&&(this._isUnderline=e,this.updateRenderData())}},{key:"assemblerData",get:function(){return this._assemblerData}},{key:"fontAtlas",get:function(){return this._fontAtlas},set:function(e){this._fontAtlas=e}},{key:"spacingX",get:function(){return this._spacingX},set:function(e){this._spacingX!==e&&(this._spacingX=e,this.updateRenderData())}},{key:"_bmFontOriginalSize",get:function(){return this._font instanceof jd?this._font.fontSize:-1}}]),J(t,[{key:"onEnable",value:function(){oe(te(t.prototype),"onEnable",this).call(this),this._font||this._isSystemFontUsed||(this.useSystemFont=!0),this._isSystemFontUsed&&!this._fontFamily&&(this.fontFamily="Arial"),this.updateRenderData(!0)}},{key:"onDisable",value:function(){oe(te(t.prototype),"onDisable",this).call(this)}},{key:"onDestroy",value:function(){if(this._assembler&&this._assembler.resetAssemblerData&&this._assembler.resetAssemblerData(this._assemblerData),this._assemblerData=null,this._ttfSpriteFrame){var e=this._ttfSpriteFrame.texture;if(e){var i=e;i.image&&i.image.destroy(),e.destroy()}this._ttfSpriteFrame=null}this._letterTexture=null,oe(te(t.prototype),"onDestroy",this).call(this)}},{key:"updateRenderData",value:function(){var e=arguments.length>0&&void 0!==arguments[0]&&arguments[0];this.markForUpdateRenderData(),e&&(this._flushAssembler(),this._applyFontTexture())}},{key:"_render",value:function(e){e.commitComp(this,this._texture.getGFXTextureView(),this._assembler,this._texture.getGFXSampler())}},{key:"_updateColor",value:function(){this._font instanceof jd?oe(te(t.prototype),"_updateColor",this).call(this):this.updateRenderData(!1)}},{key:"_canRender",value:function(){if(!oe(te(t.prototype),"_canRender",this).call(this)||!this._string)return!1;var e=this._font;if(e&&e instanceof jd){var i=e.spriteFrame;if(!i||!i.textureLoaded())return!1}return!0}},{key:"_flushAssembler",value:function(){var e=t.Assembler.getAssembler(this);this._assembler!==e&&(this.destroyRenderData(),this._assembler=e),this._renderData||this._assembler&&this._assembler.createData&&(this._renderData=this._assembler.createData(this),this._renderData.material=this._material)}},{key:"_flushMaterial",value:function(){this._updateMaterial(this._material)}},{key:"_applyFontTexture",value:function(){var e=this,t=this._font;if(t instanceof jd){var i=t.spriteFrame,n=function(){e._texture=i,e._flushMaterial(),e._assembler&&e._assembler.updateRenderData(e)};i&&(i.loaded||i.textureLoaded?n():i.once("load",n,this))}else{if(this.cacheMode===ez.CHAR)this._letterTexture=this._assembler.getAssemblerData(),this._texture=this._letterTexture;else if(!this._ttfSpriteFrame){this._ttfSpriteFrame=new Ac,this._assemblerData=this._assembler.getAssemblerData();var r=new Gl(this._assemblerData.canvas)._texture;this._ttfSpriteFrame.texture=r}this.cacheMode!==ez.CHAR&&(this._texture=this._ttfSpriteFrame),this._flushMaterial(),this._assembler&&this._assembler.updateRenderData(this)}}}]),t}(),QN.HorizontalAlign=exports.HorizontalTextAlignment,QN.VerticalAlign=exports.VerticalTextAlignment,QN.Overflow=exports.Overflow,QN.CacheMode=ez,QN._canvasPool=new tz,de((PN=JN).prototype,"string",[yN],Object.getOwnPropertyDescriptor(PN.prototype,"string"),PN.prototype),de(PN.prototype,"horizontalAlign",[gN],Object.getOwnPropertyDescriptor(PN.prototype,"horizontalAlign"),PN.prototype),de(PN.prototype,"verticalAlign",[xN],Object.getOwnPropertyDescriptor(PN.prototype,"verticalAlign"),PN.prototype),de(PN.prototype,"actualFontSize",[bN],Object.getOwnPropertyDescriptor(PN.prototype,"actualFontSize"),PN.prototype),de(PN.prototype,"fontSize",[TN],Object.getOwnPropertyDescriptor(PN.prototype,"fontSize"),PN.prototype),de(PN.prototype,"fontFamily",[SN],Object.getOwnPropertyDescriptor(PN.prototype,"fontFamily"),PN.prototype),de(PN.prototype,"lineHeight",[EN],Object.getOwnPropertyDescriptor(PN.prototype,"lineHeight"),PN.prototype),de(PN.prototype,"overflow",[wN],Object.getOwnPropertyDescriptor(PN.prototype,"overflow"),PN.prototype),de(PN.prototype,"enableWrapText",[CN],Object.getOwnPropertyDescriptor(PN.prototype,"enableWrapText"),PN.prototype),de(PN.prototype,"font",[AN],Object.getOwnPropertyDescriptor(PN.prototype,"font"),PN.prototype),de(PN.prototype,"useSystemFont",[ON],Object.getOwnPropertyDescriptor(PN.prototype,"useSystemFont"),PN.prototype),de(PN.prototype,"cacheMode",[kN],Object.getOwnPropertyDescriptor(PN.prototype,"cacheMode"),PN.prototype),de(PN.prototype,"isBold",[RN],Object.getOwnPropertyDescriptor(PN.prototype,"isBold"),PN.prototype),de(PN.prototype,"isItalic",[FN],Object.getOwnPropertyDescriptor(PN.prototype,"isItalic"),PN.prototype),de(PN.prototype,"isUnderline",[MN],Object.getOwnPropertyDescriptor(PN.prototype,"isUnderline"),PN.prototype),LN=de(PN.prototype,"_useOriginalSize",[Ko],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return!0}}),DN=de(PN.prototype,"_string",[Ko],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return"label"}}),NN=de(PN.prototype,"_horizontalAlign",[Ko],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return exports.HorizontalTextAlignment.CENTER}}),zN=de(PN.prototype,"_verticalAlign",[Ko],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return exports.VerticalTextAlignment.CENTER}}),BN=de(PN.prototype,"_actualFontSize",[Ko],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return 0}}),GN=de(PN.prototype,"_fontSize",[Ko],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return 40}}),UN=de(PN.prototype,"_fontFamily",[Ko],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return"Arial"}}),XN=de(PN.prototype,"_lineHeight",[Ko],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return 40}}),VN=de(PN.prototype,"_overflow",[Ko],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return exports.Overflow.NONE}}),HN=de(PN.prototype,"_enableWrapText",[Ko],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return!0}}),WN=de(PN.prototype,"_font",[Ko],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return null}}),jN=de(PN.prototype,"_isSystemFontUsed",[Ko],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return!0}}),qN=de(PN.prototype,"_isItalic",[Ko],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return!1}}),YN=de(PN.prototype,"_isBold",[Ko],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return!1}}),KN=de(PN.prototype,"_isUnderline",[Ko],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return!1}}),ZN=de(PN.prototype,"_cacheMode",[Ko],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return ez.NONE}}),IN=PN))||IN)||IN)||IN)||IN);cc.LabelComponent=iz;var nz,rz,az,oz=function(){function e(){Z(this,e)}return J(e,null,[{key:"add",value:function(e){var t=this._tabIndexList;-1===t.indexOf(e)&&t.push(e)}},{key:"remove",value:function(e){var t=this._tabIndexList,i=t.indexOf(e);-1!==i&&t.splice(i,1)}},{key:"resort",value:function(){this._tabIndexList.sort((function(e,t){return e._delegate.tabIndex-t._delegate.tabIndex}))}},{key:"next",value:function(e){var t=this._tabIndexList,i=t.indexOf(e);if(e.setFocus(!1),-1!==i){var n=t[i+1];n&&n._delegate.tabIndex>=0&&n.setFocus(!0)}}}]),e}();oz._tabIndexList=[],function(e){e[e.DEFAULT=0]="DEFAULT",e[e.DONE=1]="DONE",e[e.SEND=2]="SEND",e[e.SEARCH=3]="SEARCH",e[e.GO=4]="GO",e[e.NEXT=5]="NEXT"}(nz||(nz={})),xt(nz),function(e){e[e.ANY=0]="ANY",e[e.EMAIL_ADDR=1]="EMAIL_ADDR",e[e.NUMERIC=2]="NUMERIC",e[e.PHONE_NUMBER=3]="PHONE_NUMBER",e[e.URL=4]="URL",e[e.DECIMAL=5]="DECIMAL",e[e.SINGLE_LINE=6]="SINGLE_LINE"}(rz||(rz={})),xt(rz),function(e){e[e.PASSWORD=0]="PASSWORD",e[e.SENSITIVE=1]="SENSITIVE",e[e.INITIAL_CAPS_WORD=2]="INITIAL_CAPS_WORD",e[e.INITIAL_CAPS_SENTENCE=3]="INITIAL_CAPS_SENTENCE",e[e.INITIAL_CAPS_ALL_CHARACTERS=4]="INITIAL_CAPS_ALL_CHARACTERS",e[e.DEFAULT=5]="DEFAULT"}(az||(az={})),xt(az);var sz=function(){function e(){Z(this,e),this._editing=!1,this._delegate=null}return J(e,[{key:"init",value:function(e){}},{key:"onEnable",value:function(){}},{key:"update",value:function(){}},{key:"onDisable",value:function(){this._editing&&this.endEditing()}},{key:"clear",value:function(){this._delegate=null}},{key:"setTabIndex",value:function(e){}},{key:"setSize",value:function(e,t){}},{key:"setFocus",value:function(e){e?this.beginEditing():this.endEditing()}},{key:"isFocused",value:function(){return this._editing}},{key:"beginEditing",value:function(){}},{key:"endEditing",value:function(){}}]),e}(),lz=new Ki,uz=new Ki,cz=new Ii,hz=null,pz=0,_z={zoomInvalid:!1};Cs.OS_ANDROID!==Cs.os||Cs.browserType!==Cs.BROWSER_TYPE_SOUGOU&&Cs.browserType!==Cs.BROWSER_TYPE_360||(_z.zoomInvalid=!0);var fz,dz,mz,vz,yz,gz,xz,bz,Tz,Sz,Ez,wz,Cz,Az,Oz,kz,Rz,Fz,Mz,Iz,Pz,Lz,Dz,Nz,zz,Bz,Gz,Uz,Xz,Vz,Hz,Wz,jz,qz,Yz,Kz,Zz,Qz,Jz,$z,eB,tB,iB,nB=function(e){function t(){var e,i;Z(this,t);for(var n=arguments.length,r=new Array(n),a=0;a<n;a++)r[a]=arguments[a];return(i=re(this,(e=te(t)).call.apply(e,[this].concat(r))))._delegate=null,i._inputMode=rz.ANY,i._inputFlag=az.DEFAULT,i._returnType=nz.DEFAULT,i._maxLength=50,i._placeholderText="",i._alwaysOnTop=!1,i._size=new en,i._node=null,i._editing=!1,i.__eventListeners={},i.__fullscreen=!1,i.__autoResize=!1,i.__rotateScreen=!1,i.__orientationChanged=void 0,i._edTxt=null,i._textColor=an.WHITE.clone(),i._edFontSize=14,i._isTextArea=!1,i._textLabelFont=null,i._textLabelFontSize=null,i._textLabelFontColor=null,i._textLabelAlign=null,i._placeholderLabelFont=null,i._placeholderLabelFontSize=null,i._placeholderLabelFontColor=null,i._placeholderLabelAlign=null,i._placeholderLineHeight=null,i._placeholderStyleSheet=null,i._domId="EditBoxId_".concat(++pz),i}return ee(t,sz),J(t,[{key:"init",value:function(e){e&&(this._delegate=e,e.inputMode===rz.ANY?this._createTextArea():this._createInput(),oz.add(this),this.setTabIndex(e.tabIndex),this._initStyleSheet(),this._registerEventListeners(),this._addDomToGameContainer(),this.__fullscreen=nE.isAutoFullScreenEnabled(),this.__autoResize=nE._resizeWithBrowserSize)}},{key:"onEnable",value:function(){}},{key:"onDisable",value:function(){this._editing&&this._edTxt&&this._edTxt.blur()}},{key:"clear",value:function(){this._removeEventListeners(),this._removeDomFromGameContainer(),oz.remove(this),hz===this&&(hz=null),this._delegate=null}},{key:"update",value:function(){this._updateMatrix()}},{key:"setTabIndex",value:function(e){this._edTxt.tabIndex=e,oz.resort()}},{key:"setSize",value:function(e,t){var i=this._edTxt;i&&(i.style.width=e+"px",i.style.height=t+"px")}},{key:"setFocus",value:function(e){e?this.beginEditing():this._edTxt.blur()}},{key:"isFocused",value:function(){return this._editing}},{key:"beginEditing",value:function(){hz&&hz!==this&&hz.setFocus(!1),this._editing=!0,hz=this,this._showDom(),this._edTxt&&this._delegate&&(this._edTxt.focus(),this._delegate._editBoxEditingDidBegan())}},{key:"endEditing",value:function(){}},{key:"_createInput",value:function(){this._isTextArea=!1,this._edTxt=document.createElement("input")}},{key:"_createTextArea",value:function(){this._isTextArea=!0,this._edTxt=document.createElement("textarea")}},{key:"_addDomToGameContainer",value:function(){QS.container&&this._edTxt&&(QS.container.appendChild(this._edTxt),document.head.appendChild(this._placeholderStyleSheet))}},{key:"_removeDomFromGameContainer",value:function(){pt(QS.container,this._edTxt)&&this._edTxt&&QS.container.removeChild(this._edTxt),pt(document.head,this._placeholderStyleSheet)&&document.head.removeChild(this._placeholderStyleSheet),delete this._edTxt,delete this._placeholderStyleSheet}},{key:"_showDom",value:function(){this._updateMaxLength(),this._updateInputType(),this._updateStyleSheet(),this._edTxt&&this._delegate&&(this._edTxt.style.display="",this._delegate._hideLabels()),Cs.isMobile&&this._showDomOnMobile()}},{key:"_hideDom",value:function(){var e=this._edTxt;e&&this._delegate&&(e.style.display="none",this._delegate._showLabels()),Cs.isMobile&&this._hideDomOnMobile()}},{key:"_showDomOnMobile",value:function(){Cs.os===Cs.OS_ANDROID&&(this.__fullscreen&&(nE.enableAutoFullScreen(!1),cE.exitFullScreen()),this.__autoResize&&nE.resizeWithBrowserSize(!1),this._adjustWindowScroll())}},{key:"_hideDomOnMobile",value:function(){var e=this;Cs.os===Cs.OS_ANDROID&&setTimeout((function(){hz||(e.__fullscreen&&nE.enableAutoFullScreen(!0),e.__autoResize&&nE.resizeWithBrowserSize(!0))}),400),this._scrollBackWindow()}},{key:"_adjustWindowScroll",value:function(){var e=this;setTimeout((function(){window.scrollY<40&&e._edTxt.scrollIntoView({block:"start",inline:"nearest",behavior:"smooth"})}),400)}},{key:"_scrollBackWindow",value:function(){setTimeout((function(){Cs.browserType!==Cs.BROWSER_TYPE_WECHAT||Cs.os!==Cs.OS_IOS?window.scrollTo(0,0):window.top&&window.top.scrollTo(0,0)}),400)}},{key:"_updateMatrix",value:function(){if(this._edTxt){var e=this._delegate.node,t=nE.getScaleX(),i=nE.getScaleY(),n=nE.getViewportRect(),r=nE.getDevicePixelRatio();e.getWorldMatrix(lz);var a=e._uiProps.uiTransformComp;if(a&&Ii.set(cz,-a.anchorX*a.width,-a.anchorY*a.height,cz.z),Ki.transform(lz,lz,cz),!e._uiProps.uiTransformComp)return!1;var o=_O.root.ui.getScreen(e._uiProps.uiTransformComp.visibility);if(o){o.node.getWorldRT(uz);var s=uz.m12,l=uz.m13,u=KT.center;uz.m12=u.x-(uz.m00*s+uz.m04*l),uz.m13=u.y-(uz.m01*s+uz.m05*l),Ki.multiply(uz,uz,lz),t/=r,i/=r;var c=QS.container,h=uz.m00*t,p=lz.m01,_=lz.m04,f=uz.m05*i,d=parseInt(c&&c.style.paddingLeft||"0");d+=n.x/r;var m=parseInt(c&&c.style.paddingBottom||"0");m+=n.y/r;var v=uz.m12*t+d,y=uz.m13*i+m;_z.zoomInvalid&&(this.setSize(this._size.width*h,this._size.height*f),h=1,f=1);var g="matrix("+h+","+-p+","+-_+","+f+","+v+","+-y+")";this._edTxt.style.transform=g,this._edTxt.style["-webkit-transform"]=g,this._edTxt.style["transform-origin"]="0px 100% 0px",this._edTxt.style["-webkit-transform-origin"]="0px 100% 0px"}}}},{key:"_updateInputType",value:function(){var e=this._delegate,t=e.inputMode,i=e.inputFlag,n=e.returnType,r=this._edTxt;if(this._inputMode!==t||this._inputFlag!==i||this._returnType!==n){if(this._inputMode=t,this._inputFlag=i,this._returnType=n,this._isTextArea){var a="none";return i===az.INITIAL_CAPS_ALL_CHARACTERS?a="uppercase":i===az.INITIAL_CAPS_WORD&&(a="capitalize"),void(r.style.textTransform=a)}if(r=r,i!==az.PASSWORD){var o=r.type;t===rz.EMAIL_ADDR?o="email":t===rz.NUMERIC||t===rz.DECIMAL?o="number":t===rz.PHONE_NUMBER?(o="number",r.pattern="[0-9]*"):t===rz.URL?o="url":(o="text",n===nz.SEARCH&&(o="search")),r.type=o;var s="none";i===az.INITIAL_CAPS_ALL_CHARACTERS?s="uppercase":i===az.INITIAL_CAPS_WORD&&(s="capitalize"),r.style.textTransform=s}else r.type="password"}}},{key:"_updateMaxLength",value:function(){var e=this._delegate.maxLength;e<0&&(e=65535),this._edTxt.maxLength=e}},{key:"_initStyleSheet",value:function(){if(this._edTxt){var e=this._edTxt;e.style.fontSize=this._edFontSize+"px",e.style.color="#000000",e.style.border="0px",e.style.background="transparent",e.style.width="100%",e.style.height="100%",e.style.outline="medium",e.style.padding="0",e.style.textTransform="uppercase",e.style.display="none",e.style.position="absolute",e.style.bottom="0px",e.style.left="2px",e.className="cocosEditBox",e.style.fontFamily="Arial",e.id=this._domId,this._isTextArea?(e.style.resize="none",e.style.overflowY="scroll"):((e=e).type="text",e.style["-moz-appearance"]="textfield"),this._placeholderStyleSheet=document.createElement("style")}}},{key:"_updateStyleSheet",value:function(){var e=this._delegate,t=this._edTxt;t&&e&&(t.value=e.string,t.placeholder=e.placeholder,this._updateTextLabel(e.textLabel),this._updatePlaceholderLabel(e.placeholderLabel))}},{key:"_updateTextLabel",value:function(e){if(e){var t=e.font;if(t=!t||t instanceof jd?e.fontFamily:t._fontFamily,(this._textLabelFont!==t||this._textLabelFontSize!==e.fontSize||this._textLabelFontColor!==e.fontColor||this._textLabelAlign!==e.horizontalAlign)&&(this._textLabelFont=t,this._textLabelFontSize=e.fontSize,this._textLabelFontColor=e.fontColor,this._textLabelAlign=e.horizontalAlign,this._edTxt)){var i=this._edTxt;switch(i.style.fontSize="".concat(e.fontSize,"px"),i.style.color=e.color.toCSS("rgba"),i.style.fontFamily=t,e.horizontalAlign){case iz.HorizontalAlign.LEFT:i.style.textAlign="left";break;case iz.HorizontalAlign.CENTER:i.style.textAlign="center";break;case iz.HorizontalAlign.RIGHT:i.style.textAlign="right"}}}}},{key:"_updatePlaceholderLabel",value:function(e){if(e){var t=e.font;if(t=!t||t instanceof jd?e.fontFamily:e.font._fontFamily,this._placeholderLabelFont!==t||this._placeholderLabelFontSize!==e.fontSize||this._placeholderLabelFontColor!==e.fontColor||this._placeholderLabelAlign!==e.horizontalAlign||this._placeholderLineHeight!==e.fontSize){this._placeholderLabelFont=t,this._placeholderLabelFontSize=e.fontSize,this._placeholderLabelFontColor=e.fontColor,this._placeholderLabelAlign=e.horizontalAlign,this._placeholderLineHeight=e.fontSize;var i=this._placeholderStyleSheet,n=e.fontSize,r=e.color.toCSS("rgba"),a=e.fontSize,o="";switch(e.horizontalAlign){case iz.HorizontalAlign.LEFT:o="left";break;case iz.HorizontalAlign.CENTER:o="center";break;case iz.HorizontalAlign.RIGHT:o="right"}i.innerHTML="\n            #".concat(this._domId,"::-webkit-input-placeholder {\n                text-transform: initial;\n                font-family: ").concat(t,";\n                font-size: ").concat(n,"px;\n                color: ").concat(r,";\n                line-height: ").concat(a,"px;\n                text-align: ").concat(o,";\n            }\n            #").concat(this._domId,"::-moz-placeholder {\n                text-transform: initial;\n                font-family: ").concat(t,";\n                font-size: ").concat(n,"px;\n                color: ").concat(r,";\n                line-height: ").concat(a,"px;\n                text-align: ").concat(o,";\n            }\n            #").concat(this._domId,":-ms-input-placeholder {\n                text-transform: initial;\n                font-family: ").concat(t,";\n                font-size: ").concat(n,"px;\n                color: ").concat(r,";\n                line-height: ").concat(a,"px;\n                text-align: ").concat(o,";\n            }\n        ")}}}},{key:"_registerEventListeners",value:function(){if(this._edTxt){var e=this,t=this._edTxt,i=!1,n=this.__eventListeners;n.compositionStart=function(){i=!0},n.compositionEnd=function(){i=!1,e._delegate._editBoxTextChanged(t.value)},n.onInput=function(){i||e._delegate._editBoxTextChanged(t.value)},n.onClick=function(){e._editing&&Cs.isMobile&&e._adjustWindowScroll()},n.onKeydown=function(i){i.keyCode===cu.KEY.enter?(i.propagationStopped=!0,e._delegate._editBoxEditingReturn(),e._isTextArea||t.blur()):i.keyCode===cu.KEY.tab&&(i.propagationStopped=!0,i.preventDefault(),oz.next(e))},n.onBlur=function(){e._editing=!1,hz=null,e._hideDom(),e._delegate._editBoxEditingDidEnded()},t.addEventListener("compositionstart",n.compositionStart),t.addEventListener("compositionend",n.compositionEnd),t.addEventListener("input",n.onInput),t.addEventListener("keydown",n.onKeydown),t.addEventListener("blur",n.onBlur),t.addEventListener("touchstart",n.onClick)}}},{key:"_removeEventListeners",value:function(){if(this._edTxt){var e=this._edTxt,t=this.__eventListeners;e.removeEventListener("compositionstart",t.compositionStart),e.removeEventListener("compositionend",t.compositionEnd),e.removeEventListener("input",t.onInput),e.removeEventListener("keydown",t.onKeydown),e.removeEventListener("blur",t.onBlur),e.removeEventListener("touchstart",t.onClick),t.compositionStart=null,t.compositionEnd=null,t.onInput=null,t.onKeydown=null,t.onBlur=null,t.onClick=null}}}]),t}();function rB(e){return e.replace(/(?:^|\s)\S/g,(function(e){return e.toUpperCase()}))}function aB(e){return e.charAt(0).toUpperCase()+e.slice(1)}!function(e){e.EDITING_DID_BEGAN="editing-did-began",e.EDITING_DID_ENDED="editing-did-ended",e.TEXT_CHANGED="text-changed",e.EDITING_RETURN="editing-return"}(iB||(iB={}));var oB,sB,lB,uB,cB,hB,pB,_B,fB,dB,mB,vB,yB,gB,xB,bB,TB,SB,EB,wB,CB,AB,OB,kB,RB,FB,MB,IB,PB,LB,DB,NB,zB,BB,GB,UB,XB,VB=(fz=Yo("cc.EditBoxComponent"),dz=os("i18n:cc.EditBoxComponent"),mz=ts(100),vz=es("UI/EditBox"),yz=Ko({tooltip:"输入框的初始输入内容，如果为空则会显示占位符的文本",displayOrder:1}),gz=Ko({tooltip:"输入框文本的字体大小",displayOrder:2}),xz=Ko({type:an,tooltip:"输入框文本的颜色",displayOrder:3}),bz=Ko({type:az,tooltip:"指定输入标志位，可以指定输入方式为密码或者单词首字母大写",displayOrder:4}),Tz=Ko({type:rz,tooltip:"指定输入模式: ANY 表示多行输入，其它都是单行输入，移动平台上还可以指定键盘样式",displayOrder:5}),Sz=Ko({type:nz,tooltip:"指定移动设备上面回车按钮的样式",displayOrder:6}),Ez=Ko({tooltip:"输入框最大允许输入的字符个数",displayOrder:7}),wz=Ko({tooltip:"输入框文本的行高",displayOrder:8}),Cz=Ko({type:Ac,tooltip:"输入框的背景图片",displayOrder:10}),Az=Ko({tooltip:"输入框输入文本节点上挂载的 Label 组件对象",type:iz,displayOrder:11}),Oz=Ko({tooltip:"输入框占位符节点上挂载的 Label 组件对象",type:iz,displayOrder:12}),kz=Ko({tooltip:"输入框占位符的文本内容",displayOrder:13}),Rz=Ko({tooltip:"输入框占位符的字体大小",displayOrder:14}),Fz=Ko({tooltip:"输入框占位符的字体颜色",displayOrder:15}),Mz=Ko({tooltip:"输入框总是可见，并且永远在游戏视图的上面（这个属性只有在 Web 上面修改有意义）",displayOrder:21}),Iz=Ko({tooltip:"修改 DOM 输入元素的 tabIndex（这个属性只有在 Web 上面修改有意义）",displayOrder:22}),Pz=Ko({type:[fO],tooltip:"该事件在用户点击输入框获取焦点的时候被触发",displayOrder:31}),Lz=Ko({type:[fO],tooltip:"编辑文本输入框时触发的事件回调",displayOrder:32}),Dz=Ko({type:[fO],tooltip:"在单行模式下面，一般是在用户按下回车或者点击屏幕输入框以外的地方调用该函数。 如果是多行输入，一般是在用户点击屏幕输入框以外的地方调用该函数",displayOrder:33}),Nz=Ko({type:[fO],tooltip:"该事件在用户按下回车键的时候被触发, 如果是单行输入框，按回车键还会使输入框失去焦点",displayOrder:34}),fz(zz=dz(zz=mz(zz=vz(zz=Jo((tB=eB=function(e){function t(){var e,i;Z(this,t);for(var n=arguments.length,r=new Array(n),a=0;a<n;a++)r[a]=arguments[a];return fe(i=re(this,(e=te(t)).call.apply(e,[this].concat(r))),"editingDidBegan",Gz,ne(i)),fe(i,"textChanged",Uz,ne(i)),fe(i,"editingDidEnded",Xz,ne(i)),fe(i,"editingReturn",Vz,ne(i)),i._impl=null,i._background=null,fe(i,"_textLabel",Hz,ne(i)),fe(i,"_placeholderLabel",Wz,ne(i)),fe(i,"_returnType",jz,ne(i)),fe(i,"_useOriginalSize",qz,ne(i)),fe(i,"_string",Yz,ne(i)),fe(i,"_tabIndex",Kz,ne(i)),fe(i,"_backgroundImage",Zz,ne(i)),fe(i,"_inputFlag",Qz,ne(i)),fe(i,"_inputMode",Jz,ne(i)),fe(i,"_maxLength",$z,ne(i)),i._isLabelVisible=!1,i}return ee(t,rp),J(t,[{key:"__preload",value:function(){this._init()}},{key:"onEnable",value:function(){this._registerEvent(),this._impl&&this._impl.onEnable()}},{key:"update",value:function(){this._impl&&this._impl.update()}},{key:"onDisable",value:function(){this._unregisterEvent(),this._impl&&this._impl.onDisable()}},{key:"onDestroy",value:function(){this._impl&&this._impl.clear()}},{key:"setFocus",value:function(){this._impl&&this._impl.setFocus(!0)}},{key:"focus",value:function(){this._impl&&this._impl.setFocus(!0)}},{key:"blur",value:function(){this._impl&&this._impl.setFocus(!1)}},{key:"isFocused",value:function(){return!!this._impl&&this._impl.isFocused()}},{key:"_editBoxEditingDidBegan",value:function(){fO.emitEvents(this.editingDidBegan,this),this.node.emit(iB.EDITING_DID_BEGAN,this)}},{key:"_editBoxEditingDidEnded",value:function(){fO.emitEvents(this.editingDidEnded,this),this.node.emit(iB.EDITING_DID_ENDED,this)}},{key:"_editBoxTextChanged",value:function(e){e=this._updateLabelStringStyle(e,!0),this.string=e,fO.emitEvents(this.textChanged,e,this),this.node.emit(iB.TEXT_CHANGED,this)}},{key:"_editBoxEditingReturn",value:function(){fO.emitEvents(this.editingReturn,this),this.node.emit(iB.EDITING_RETURN,this)}},{key:"_showLabels",value:function(){this._isLabelVisible=!0,this._updateLabels()}},{key:"_hideLabels",value:function(){this._isLabelVisible=!1,this._textLabel&&(this._textLabel.node.active=!1),this._placeholderLabel&&(this._placeholderLabel.node.active=!1)}},{key:"_onTouchBegan",value:function(e){e.propagationStopped=!0}},{key:"_onTouchCancel",value:function(e){e.propagationStopped=!0}},{key:"_onTouchEnded",value:function(e){this._impl&&this._impl.beginEditing(),e.propagationStopped=!0}},{key:"_init",value:function(){this._createBackgroundSprite(),this._updatePlaceholderLabel(),this._updateTextLabel(),this._isLabelVisible=!0,this.node.on(exports.SystemEventType.SIZE_CHANGED,this._resizeChildNodes,this),(this._impl=new t._EditBoxImpl).init(this),this._updateString(this._string),this._syncSize()}},{key:"_createBackgroundSprite",value:function(){this._background||(this._background=this.node.getComponent(LA),this._background||(this._background=this.node.addComponent(LA))),this._background.type=LA.Type.SLICED,this._background.spriteFrame=this._backgroundImage}},{key:"_updateTextLabel",value:function(){var e=this._textLabel;if(!e){var t=this.node.getChildByName("TEXT_LABEL");t||(t=new tg("TEXT_LABEL")),(e=t.getComponent(iz))||(e=t.addComponent(iz)),t.parent=this.node,this._textLabel=e}this._textLabel.node._uiProps.uiTransformComp.setAnchorPoint(0,1),e.overflow=iz.Overflow.CLAMP,this._inputMode===rz.ANY?(e.verticalAlign=exports.VerticalTextAlignment.TOP,e.enableWrapText=!0):(e.verticalAlign=exports.VerticalTextAlignment.CENTER,e.enableWrapText=!1),e.string=this._updateLabelStringStyle(this._string)}},{key:"_updatePlaceholderLabel",value:function(){var e=this._placeholderLabel;if(!e){var t=this.node.getChildByName("PLACEHOLDER_LABEL");t||(t=new tg("PLACEHOLDER_LABEL")),(e=t.getComponent(iz))||(e=t.addComponent(iz)),t.parent=this.node,this._placeholderLabel=e}this._placeholderLabel.node._uiProps.uiTransformComp.setAnchorPoint(0,1),e.overflow=iz.Overflow.CLAMP,this._inputMode===rz.ANY?(e.verticalAlign=exports.VerticalTextAlignment.TOP,e.enableWrapText=!0):(e.verticalAlign=exports.VerticalTextAlignment.CENTER,e.enableWrapText=!1),e.string=this.placeholder}},{key:"_syncSize",value:function(){var e=this.node.getContentSize();this._background&&(this._background.node._uiProps.uiTransformComp.anchorPoint=this.node._uiProps.uiTransformComp.anchorPoint,this._background.node.setContentSize(e)),this._updateLabelPosition(e),this._impl&&this._impl.setSize(e.width,e.height)}},{key:"_updateLabels",value:function(){if(this._isLabelVisible){var e=this._string;this._textLabel&&(this._textLabel.node.active=""!==e),this._placeholderLabel&&(this._placeholderLabel.node.active=""===e)}}},{key:"_updateString",value:function(e){var t=this._textLabel;if(t){var i=e;i&&(i=this._updateLabelStringStyle(i)),t.string=i,this._updateLabels()}}},{key:"_updateLabelStringStyle",value:function(e){var t=arguments.length>1&&void 0!==arguments[1]&&arguments[1],i=this._inputFlag;if(t||i!==az.PASSWORD)i===az.INITIAL_CAPS_ALL_CHARACTERS?e=e.toUpperCase():i===az.INITIAL_CAPS_WORD?e=rB(e):i===az.INITIAL_CAPS_SENTENCE&&(e=aB(e));else{for(var n="",r=e.length,a=0;a<r;++a)n+="●";e=n}return e}},{key:"_registerEvent",value:function(){this.node.on(exports.SystemEventType.TOUCH_START,this._onTouchBegan,this),this.node.on(exports.SystemEventType.TOUCH_END,this._onTouchEnded,this)}},{key:"_unregisterEvent",value:function(){this.node.off(exports.SystemEventType.TOUCH_START,this._onTouchBegan,this),this.node.off(exports.SystemEventType.TOUCH_END,this._onTouchEnded,this)}},{key:"_updateLabelPosition",value:function(e){var t=this.node,i=-t.anchorX*t.width,n=-t.anchorY*t.height,r=this._placeholderLabel,a=this._textLabel;a&&(a.node.setContentSize(e.width-2,e.height),a.node.position=new Ii(i+2,n+e.height,a.node.position.z),a.verticalAlign=this._inputMode===rz.ANY?exports.VerticalTextAlignment.TOP:exports.VerticalTextAlignment.CENTER,a.enableWrapText=this._inputMode===rz.ANY),r&&(r.node.setContentSize(e.width-2,e.height),r.lineHeight=e.height,r.node.position=new Ii(i+2,n+e.height,r.node.position.z),r.verticalAlign=this._inputMode===rz.ANY?exports.VerticalTextAlignment.TOP:exports.VerticalTextAlignment.CENTER,r.enableWrapText=this._inputMode===rz.ANY)}},{key:"_resizeChildNodes",value:function(){var e=this._textLabel&&this._textLabel.node;e&&(e.position=new Ii(-this.node.width/2,this.node.height/2,e.position.z),e.width=this.node.width,e.height=this.node.height);var t=this._placeholderLabel&&this._placeholderLabel.node;t&&(t.position=new Ii(-this.node.width/2,this.node.height/2,t.position.z),t.width=this.node.width,t.height=this.node.height);var i=this._background&&this._background.node;i&&(i.width=this.node.width,i.height=this.node.height)}},{key:"string",get:function(){return this._string},set:function(e){this._maxLength>=0&&e.length>=this._maxLength&&(e=e.slice(0,this._maxLength)),this._string=e,this._updateString(e)}},{key:"fontSize",get:function(){return this._textLabel?this._textLabel.fontSize:20},set:function(e){this._textLabel&&(this._textLabel.fontSize=e)}},{key:"fontColor",get:function(){return this._textLabel?this._textLabel.color:an.WHITE.clone()},set:function(e){this._textLabel&&(this._textLabel.color=e)}},{key:"inputFlag",get:function(){return this._inputFlag},set:function(e){this._inputFlag=e,this._updateString(this._string)}},{key:"inputMode",get:function(){return this._inputMode},set:function(e){this._inputMode!==e&&(this._inputMode=e,this._updateTextLabel(),this._updatePlaceholderLabel())}},{key:"returnType",get:function(){return this._returnType},set:function(e){this._returnType=e}},{key:"maxLength",get:function(){return this._maxLength},set:function(e){this._maxLength=e}},{key:"lineHeight",get:function(){return this._textLabel?this._textLabel.lineHeight:40},set:function(e){this._textLabel&&(this._textLabel.lineHeight=e)}},{key:"backgroundImage",get:function(){return this._backgroundImage},set:function(e){this._backgroundImage!==e&&(this._backgroundImage=e,this._createBackgroundSprite())}},{key:"textLabel",get:function(){return this._textLabel},set:function(e){this._textLabel!==e&&(this._textLabel=e,this._textLabel&&(this._updateTextLabel(),this._updateLabels()))}},{key:"placeholderLabel",get:function(){return this._placeholderLabel},set:function(e){this._placeholderLabel!==e&&(this._placeholderLabel=e,this._placeholderLabel&&(this._updatePlaceholderLabel(),this._updateLabels()))}},{key:"placeholder",get:function(){return this._placeholderLabel?this._placeholderLabel.string:""},set:function(e){this._placeholderLabel&&(this._placeholderLabel.string=e)}},{key:"placeholderFontSize",get:function(){return this._placeholderLabel?this._placeholderLabel.fontSize:20},set:function(e){this._placeholderLabel&&(this._placeholderLabel.fontSize=e)}},{key:"placeholderFontColor",get:function(){return this._placeholderLabel?this._placeholderLabel.color:an.GRAY.clone()},set:function(e){this._placeholderLabel&&(this._placeholderLabel.color=e)}},{key:"stayOnTop",get:function(){},set:function(e){console.warn("stayOnTop is removed.")}},{key:"tabIndex",get:function(){return this._tabIndex},set:function(e){this._tabIndex!==e&&(this._tabIndex=e,this._impl&&this._impl.setTabIndex(e))}}]),t}(),eB._EditBoxImpl=sz,eB.KeyboardReturnType=nz,eB.InputFlag=az,eB.InputMode=rz,eB.EventType=iB,de((Bz=tB).prototype,"string",[yz],Object.getOwnPropertyDescriptor(Bz.prototype,"string"),Bz.prototype),de(Bz.prototype,"fontSize",[gz],Object.getOwnPropertyDescriptor(Bz.prototype,"fontSize"),Bz.prototype),de(Bz.prototype,"fontColor",[xz],Object.getOwnPropertyDescriptor(Bz.prototype,"fontColor"),Bz.prototype),de(Bz.prototype,"inputFlag",[bz],Object.getOwnPropertyDescriptor(Bz.prototype,"inputFlag"),Bz.prototype),de(Bz.prototype,"inputMode",[Tz],Object.getOwnPropertyDescriptor(Bz.prototype,"inputMode"),Bz.prototype),de(Bz.prototype,"returnType",[Sz],Object.getOwnPropertyDescriptor(Bz.prototype,"returnType"),Bz.prototype),de(Bz.prototype,"maxLength",[Ez],Object.getOwnPropertyDescriptor(Bz.prototype,"maxLength"),Bz.prototype),de(Bz.prototype,"lineHeight",[wz],Object.getOwnPropertyDescriptor(Bz.prototype,"lineHeight"),Bz.prototype),de(Bz.prototype,"backgroundImage",[Cz],Object.getOwnPropertyDescriptor(Bz.prototype,"backgroundImage"),Bz.prototype),de(Bz.prototype,"textLabel",[Az],Object.getOwnPropertyDescriptor(Bz.prototype,"textLabel"),Bz.prototype),de(Bz.prototype,"placeholderLabel",[Oz],Object.getOwnPropertyDescriptor(Bz.prototype,"placeholderLabel"),Bz.prototype),de(Bz.prototype,"placeholder",[kz],Object.getOwnPropertyDescriptor(Bz.prototype,"placeholder"),Bz.prototype),de(Bz.prototype,"placeholderFontSize",[Rz],Object.getOwnPropertyDescriptor(Bz.prototype,"placeholderFontSize"),Bz.prototype),de(Bz.prototype,"placeholderFontColor",[Fz],Object.getOwnPropertyDescriptor(Bz.prototype,"placeholderFontColor"),Bz.prototype),de(Bz.prototype,"stayOnTop",[Mz],Object.getOwnPropertyDescriptor(Bz.prototype,"stayOnTop"),Bz.prototype),de(Bz.prototype,"tabIndex",[Iz],Object.getOwnPropertyDescriptor(Bz.prototype,"tabIndex"),Bz.prototype),Gz=de(Bz.prototype,"editingDidBegan",[Pz],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return[]}}),Uz=de(Bz.prototype,"textChanged",[Lz],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return[]}}),Xz=de(Bz.prototype,"editingDidEnded",[Dz],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return[]}}),Vz=de(Bz.prototype,"editingReturn",[Nz],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return[]}}),Hz=de(Bz.prototype,"_textLabel",[Ko],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return null}}),Wz=de(Bz.prototype,"_placeholderLabel",[Ko],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return null}}),jz=de(Bz.prototype,"_returnType",[Ko],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return nz.DEFAULT}}),qz=de(Bz.prototype,"_useOriginalSize",[Ko],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return!0}}),Yz=de(Bz.prototype,"_string",[Ko],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return""}}),Kz=de(Bz.prototype,"_tabIndex",[Ko],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return 0}}),Zz=de(Bz.prototype,"_backgroundImage",[Ko],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return null}}),Qz=de(Bz.prototype,"_inputFlag",[Ko],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return az.DEFAULT}}),Jz=de(Bz.prototype,"_inputMode",[Ko],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return rz.ANY}}),$z=de(Bz.prototype,"_maxLength",[Ko],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return 20}}),zz=Bz))||zz)||zz)||zz)||zz)||zz);Cs.isBrowser&&(VB._EditBoxImpl=nB),cc.EditBoxComponent=VB;var HB,WB,jB,qB,YB,KB=exports.SystemEventType;!function(e){e[e.NONE=0]="NONE",e[e.HORIZONTAL=1]="HORIZONTAL",e[e.VERTICAL=2]="VERTICAL",e[e.GRID=3]="GRID"}(HB||(HB={})),bt(HB),function(e){e[e.NONE=0]="NONE",e[e.CONTAINER=1]="CONTAINER",e[e.CHILDREN=2]="CHILDREN"}(WB||(WB={})),bt(WB),function(e){e[e.HORIZONTAL=0]="HORIZONTAL",e[e.VERTICAL=1]="VERTICAL"}(jB||(jB={})),bt(jB),function(e){e[e.BOTTOM_TO_TOP=0]="BOTTOM_TO_TOP",e[e.TOP_TO_BOTTOM=1]="TOP_TO_BOTTOM"}(qB||(qB={})),bt(qB),function(e){e[e.LEFT_TO_RIGHT=0]="LEFT_TO_RIGHT",e[e.RIGHT_TO_LEFT=1]="RIGHT_TO_LEFT"}(YB||(YB={})),bt(YB);var ZB,QB,JB,$B,eG,tG,iG,nG,rG,aG,oG,sG,lG,uG,cG,hG,pG,_G,fG,dG,mG,vG,yG,gG=new Ii,xG=new Ii,bG=(oB=Yo("cc.LayoutComponent"),sB=os("i18n:cc.LayoutComponent"),lB=ts(110),uB=es("UI/Layout"),cB=$o(Iy),hB=Ko({type:HB,tooltip:"自动布局模式，包括：\n 1. NONE，不会对子节点进行自动布局 \n 2. HORIZONTAL，横向自动排布子物体 \n 3. VERTICAL，垂直自动排布子物体\n 4. GRID, 采用网格方式对子物体自动进行布局"}),pB=Ko({type:WB,tooltip:"缩放模式，包括：\n 1. NONE，不会对子节点和容器进行大小缩放 \n 2. CONTAINER, 对容器的大小进行缩放 \n 3. CHILDREN, 对子节点的大小进行缩放"}),_B=Ko({tooltip:"每个格子的大小，只有布局类型为 GRID 的时候才有效"}),fB=Ko({type:jB,tooltip:"起始轴方向类型，可进行水平和垂直布局排列，只有布局类型为 GRID 的时候才有效"}),dB=Ko({tooltip:"容器内左边距，只会在一个布局方向上生效"}),mB=Ko({tooltip:"容器内右边距，只会在一个布局方向上生效"}),vB=Ko({tooltip:"容器内上边距，只会在一个布局方向上生效"}),yB=Ko({tooltip:"容器内下边距，只会在一个布局方向上生效"}),gB=Ko({tooltip:"子节点之间的水平间距"}),xB=Ko({tooltip:"子节点之间的垂直间距"}),bB=Ko({type:qB,tooltip:"垂直排列子节点的方向"}),TB=Ko({type:YB,tooltip:"水平排列子节点的方向"}),SB=Ko({tooltip:"容器内边距，该属性会在四个布局方向上生效"}),EB=Ko({tooltip:"子节点缩放比例是否影响布局"}),oB(wB=sB(wB=lB(wB=uB(wB=cB(wB=Jo((XB=UB=function(e){function t(){var e,i;Z(this,t);for(var n=arguments.length,r=new Array(n),a=0;a<n;a++)r[a]=arguments[a];return fe(i=re(this,(e=te(t)).call.apply(e,[this].concat(r))),"_resizeMode",AB,ne(i)),fe(i,"_N$layoutType",OB,ne(i)),fe(i,"_N$padding",kB,ne(i)),fe(i,"_cellSize",RB,ne(i)),fe(i,"_startAxis",FB,ne(i)),fe(i,"_paddingLeft",MB,ne(i)),fe(i,"_paddingRight",IB,ne(i)),fe(i,"_paddingTop",PB,ne(i)),fe(i,"_paddingBottom",LB,ne(i)),fe(i,"_spacingX",DB,ne(i)),fe(i,"_spacingY",NB,ne(i)),fe(i,"_verticalDirection",zB,ne(i)),fe(i,"_horizontalDirection",BB,ne(i)),fe(i,"_affectedByScale",GB,ne(i)),i._layoutSize=new en(300,200),i._layoutDirty=!0,i._isAlign=!1,i}return ee(t,rp),J(t,[{key:"updateLayout",value:function(){this._layoutDirty&&this.node.children.length>0&&(this._doLayout(),this._layoutDirty=!1)}},{key:"onEnable",value:function(){this._addEventListeners(),this.node.getContentSize().equals(new en)&&this.node.setContentSize(this._layoutSize),0!==this._N$padding&&this._migratePaddingData(),this._doLayoutDirty()}},{key:"onDisable",value:function(){this._removeEventListeners()}},{key:"_migratePaddingData",value:function(){this._paddingLeft=this._N$padding,this._paddingRight=this._N$padding,this._paddingTop=this._N$padding,this._paddingBottom=this._N$padding,this._N$padding=0}},{key:"_addEventListeners",value:function(){_O.on(iO.EVENT_AFTER_UPDATE,this.updateLayout,this),this.node.on(KB.SIZE_CHANGED,this._resized,this),this.node.on(KB.ANCHOR_CHANGED,this._doLayoutDirty,this),this.node.on(KB.CHILD_ADDED,this._childAdded,this),this.node.on(KB.CHILD_REMOVED,this._childRemoved,this),this._addChildrenEventListeners()}},{key:"_removeEventListeners",value:function(){_O.off(iO.EVENT_AFTER_UPDATE,this.updateLayout,this),this.node.off(KB.SIZE_CHANGED,this._resized,this),this.node.off(KB.ANCHOR_CHANGED,this._doLayoutDirty,this),this.node.off(KB.CHILD_ADDED,this._childAdded,this),this.node.off(KB.CHILD_REMOVED,this._childRemoved,this),this._removeChildrenEventListeners()}},{key:"_addChildrenEventListeners",value:function(){for(var e,t=_e(this.node.children);!(e=t()).done;){var i=e.value;i.on(KB.TRANSFORM_CHANGED,this._doScaleDirty,this),i.on(KB.SIZE_CHANGED,this._doLayoutDirty,this),i.on(KB.TRANSFORM_CHANGED,this._transformDirty,this),i.on(KB.ANCHOR_CHANGED,this._doLayoutDirty,this),i.on("active-in-hierarchy-changed",this._doLayoutDirty,this)}}},{key:"_removeChildrenEventListeners",value:function(){for(var e,t=_e(this.node.children);!(e=t()).done;){var i=e.value;i.off(KB.TRANSFORM_CHANGED,this._doScaleDirty,this),i.off(KB.SIZE_CHANGED,this._doLayoutDirty,this),i.off(KB.TRANSFORM_CHANGED,this._transformDirty,this),i.off(KB.ANCHOR_CHANGED,this._doLayoutDirty,this),i.off("active-in-hierarchy-changed",this._doLayoutDirty,this)}}},{key:"_childAdded",value:function(e){e.on(KB.TRANSFORM_CHANGED,this._doScaleDirty,this),e.on(KB.SIZE_CHANGED,this._doLayoutDirty,this),e.on(KB.TRANSFORM_CHANGED,this._transformDirty,this),e.on(KB.ANCHOR_CHANGED,this._doLayoutDirty,this),e.on("active-in-hierarchy-changed",this._doLayoutDirty,this),this._doLayoutDirty()}},{key:"_childRemoved",value:function(e){e.off(KB.TRANSFORM_CHANGED,this._doScaleDirty,this),e.off(KB.SIZE_CHANGED,this._doLayoutDirty,this),e.off(KB.TRANSFORM_CHANGED,this._transformDirty,this),e.off(KB.ANCHOR_CHANGED,this._doLayoutDirty,this),e.off("active-in-hierarchy-changed",this._doLayoutDirty,this),this._doLayoutDirty()}},{key:"_resized",value:function(){this._layoutSize=this.node.getContentSize(),this._doLayoutDirty()}},{key:"_doLayoutHorizontally",value:function(e,t,i,n){var r=this.node.getAnchorPoint(),a=this.node.children,o=1,s=this._paddingLeft,l=-r.x*e;this._horizontalDirection===YB.RIGHT_TO_LEFT&&(o=-1,l=(1-r.x)*e,s=this._paddingRight);for(var u,c=l+o*s-o*this._spacingX,h=0,p=0,_=0,f=0,d=0,m=0,v=0,y=_e(a);!(u=y()).done;){u.value.activeInHierarchy&&v++}var g=this._cellSize.width;this._N$layoutType!==HB.GRID&&this._resizeMode===WB.CHILDREN&&(g=(e-(this._paddingLeft+this._paddingRight)-(v-1)*this._spacingX)/v);for(var x,b=_e(a);!(x=b()).done;){var T=x.value;if(T.activeInHierarchy){T.getScale(xG);var S=this._getUsedScaleValue(xG.x),E=this._getUsedScaleValue(xG.y);this._resizeMode===WB.CHILDREN&&(T.width=g/S,this._N$layoutType===HB.GRID&&(T.height=this._cellSize.height/E));var w=T.anchorX,C=T.width*S,A=T.height*E;_>p&&(p=_),A>=p&&(_=p,p=A,m=T.getAnchorPoint().y),this._horizontalDirection===YB.RIGHT_TO_LEFT&&(w=1-T.anchorX),c=c+o*w*C+o*this._spacingX;var O=o*(1-w)*C;if(t){var k=c+O+o*(o>0?this._paddingRight:this._paddingLeft),R=!1;this._horizontalDirection===YB.LEFT_TO_RIGHT&&k>(1-r.x)*e&&(R=!0);var F=!1;this._horizontalDirection===YB.RIGHT_TO_LEFT&&k<-r.x*e&&(F=!0),(R||F)&&(A>=p?(0===_&&(_=p),h+=_,_=p):(h+=p,_=A,p=0),c=l+o*(s+w*C),f++)}var M=i(T,h,f);e>=C+this._paddingLeft+this._paddingRight&&n&&(T.getPosition(gG),T.setPosition(c,M,gG.z));var I=1,P=void 0,L=0===p?A:p;this._verticalDirection===qB.TOP_TO_BOTTOM?(d=d||this.node.getContentSize().height,(P=M+(I=-1)*(L*m+this._paddingBottom))<d&&(d=P)):(d=d||-this.node.getContentSize().height,(P=M+I*(L*m+this._paddingTop))>d&&(d=P)),c+=O}}return d}},{key:"_doLayoutVertically",value:function(e,t,i,n){var r=this.node.getAnchorPoint(),a=this.node.children,o=1,s=this._paddingBottom,l=-r.y*e;this._verticalDirection===qB.TOP_TO_BOTTOM&&(o=-1,l=(1-r.y)*e,s=this._paddingTop);for(var u,c=l+o*s-o*this._spacingY,h=0,p=0,_=0,f=0,d=0,m=0,v=0,y=_e(a);!(u=y()).done;){u.value.activeInHierarchy&&v++}var g=this._cellSize.height;this._N$layoutType!==HB.GRID&&this._resizeMode===WB.CHILDREN&&(g=(e-(this._paddingTop+this._paddingBottom)-(v-1)*this._spacingY)/v);for(var x,b=_e(a);!(x=b()).done;){var T=x.value;if(T){var S=T.getScale(),E=this._getUsedScaleValue(S.x),w=this._getUsedScaleValue(S.y);if(T.activeInHierarchy){this._resizeMode===WB.CHILDREN&&(T.height=g/w,this._N$layoutType===HB.GRID&&(T.width=this._cellSize.width/E));var C=T.anchorY,A=T.width*E,O=T.height*w;_>p&&(p=_),A>=p&&(_=p,p=A,m=T.getAnchorPoint().x),this._verticalDirection===qB.TOP_TO_BOTTOM&&(C=1-T.anchorY),c=c+o*C*O+o*this._spacingY;var k=o*(1-C)*O;if(t){var R=c+k+o*(o>0?this._paddingTop:this._paddingBottom),F=!1;this._verticalDirection===qB.BOTTOM_TO_TOP&&R>(1-r.y)*e&&(F=!0);var M=!1;this._verticalDirection===qB.TOP_TO_BOTTOM&&R<-r.y*e&&(M=!0),(F||M)&&(A>=p?(0===_&&(_=p),h+=_,_=p):(h+=p,_=A,p=0),c=l+o*(s+C*O),f++)}var I=i(T,h,f);e>=O+(this._paddingTop+this._paddingBottom)&&n&&(T.getPosition(gG),T.setPosition(I,c,gG.z));var P=1,L=void 0,D=0===p?A:p;this._horizontalDirection===YB.RIGHT_TO_LEFT?(P=-1,d=d||this.node.getContentSize().width,(L=I+P*(D*m+this._paddingLeft))<d&&(d=L)):(d=d||-this.node.getContentSize().width,(L=I+P*(D*m+this._paddingRight))>d&&(d=L)),c+=k}}}return d}},{key:"_doLayoutBasic",value:function(){for(var e,t=null,i=_e(this.node.children);!(e=i()).done;){var n=e.value,r=n.getComponent(Iy);r&&(n.activeInHierarchy&&(t?nn.union(t,t,r.getBoundingBoxToWorld()):t=r.getBoundingBoxToWorld()))}if(t){var a=this.node.parent.getComponent(Iy);if(!a)return;Ii.set(gG,t.x,t.y,0);var o=new Ii;a.convertToNodeSpaceAR(gG,o),Ii.set(o,o.x-this._paddingLeft,o.y-this._paddingBottom,o.z),Ii.set(gG,t.x+t.width,t.y+t.height,0);var s=new Ii;a.convertToNodeSpaceAR(gG,s),Ii.set(s,s.x+this._paddingRight,s.y+this._paddingTop,s.z);var l=cc.size(parseFloat((s.x-o.x).toFixed(2)),parseFloat((s.y-o.y).toFixed(2)));if(this.node.getPosition(gG),0!==l.width){var u=(gG.x-o.x)/l.width;this.node.anchorX=parseFloat(u.toFixed(2))}if(0!==l.height){var c=(gG.y-o.y)/l.height;this.node.anchorY=parseFloat(c.toFixed(2))}this.node.setContentSize(l)}}},{key:"_doLayoutGridAxisHorizontal",value:function(e,t){var i=this,n=t.width,r=1,a=-e.y*t.height,o=this._paddingBottom;this._verticalDirection===qB.TOP_TO_BOTTOM&&(r=-1,a=(1-e.y)*t.height,o=this._paddingTop);var s=this,l=function(e,t,n){return a+r*(t+e.anchorY*e.height*s._getUsedScaleValue(e.getScale().y)+o+n*i._spacingY)},u=0;if(this._resizeMode===WB.CONTAINER){var c=this._doLayoutHorizontally(n,!0,l,!1);(u=a-c)<0&&(u*=-1),a=-e.y*u,this._verticalDirection===qB.TOP_TO_BOTTOM&&(r=-1,a=(1-e.y)*u)}this._doLayoutHorizontally(n,!0,l,!0),this._resizeMode===WB.CONTAINER&&this.node.setContentSize(n,u)}},{key:"_doLayoutGridAxisVertical",value:function(e,t){var i=this,n=t.height,r=1,a=-e.x*t.width,o=this._paddingLeft;this._horizontalDirection===YB.RIGHT_TO_LEFT&&(r=-1,a=(1-e.x)*t.width,o=this._paddingRight);var s=this,l=function(e,t,n){return a+r*(t+e.anchorX*e.width*s._getUsedScaleValue(e.getScale().x)+o+n*i._spacingX)},u=0;if(this._resizeMode===WB.CONTAINER){var c=this._doLayoutVertically(n,!0,l,!1);(u=a-c)<0&&(u*=-1),a=-e.x*u,this._horizontalDirection===YB.RIGHT_TO_LEFT&&(r=-1,a=(1-e.x)*u)}this._doLayoutVertically(n,!0,l,!0),this._resizeMode===WB.CONTAINER&&this.node.setContentSize(u,n)}},{key:"_doLayoutGrid",value:function(){var e=this.node.getAnchorPoint(),t=this.node.getContentSize();this.startAxis===jB.HORIZONTAL?this._doLayoutGridAxisHorizontal(e,t):this.startAxis===jB.VERTICAL&&this._doLayoutGridAxisVertical(e,t)}},{key:"_getHorizontalBaseWidth",value:function(e){var t=0,i=0;if(this._resizeMode===WB.CONTAINER){for(var n,r=_e(e);!(n=r()).done;){var a=n.value;a.getScale(xG),a.activeInHierarchy&&(i++,t+=a.width*this._getUsedScaleValue(xG.x))}t+=(i-1)*this._spacingX+this._paddingLeft+this._paddingRight}else t=this.node.getContentSize().width;return t}},{key:"_getVerticalBaseHeight",value:function(e){var t=0,i=0;if(this._resizeMode===WB.CONTAINER){for(var n,r=_e(e);!(n=r()).done;){var a=n.value;a.getScale(xG),a.activeInHierarchy&&(i++,t+=a.height*this._getUsedScaleValue(xG.y))}t+=(i-1)*this._spacingY+this._paddingBottom+this._paddingTop}else t=this.node.getContentSize().height;return t}},{key:"_doLayout",value:function(){var e=this;if(this._N$layoutType===HB.HORIZONTAL){var t=this._getHorizontalBaseWidth(this.node.children);this._doLayoutHorizontally(t,!1,(function(t){return(e._isAlign?Ii.ZERO:t.position).y}),!0),this._isAlign=!1,this.node.width=t}else if(this._N$layoutType===HB.VERTICAL){var i=this._getVerticalBaseHeight(this.node.children);this._doLayoutVertically(i,!1,(function(t){return(e._isAlign?Ii.ZERO:t.position).x}),!0),this._isAlign=!1,this.node.height=i}else this._N$layoutType===HB.NONE?this._resizeMode===WB.CONTAINER&&this._doLayoutBasic():this._N$layoutType===HB.GRID&&this._doLayoutGrid()}},{key:"_getUsedScaleValue",value:function(e){return this._affectedByScale?Math.abs(e):1}},{key:"_transformDirty",value:function(e){e&rh.POSITION&&this._doLayoutDirty()}},{key:"_doLayoutDirty",value:function(){this._layoutDirty=!0}},{key:"_doScaleDirty",value:function(e){e&rh.SCALE&&(this._layoutDirty=this._layoutDirty||this._affectedByScale)}},{key:"type",get:function(){return this._N$layoutType},set:function(e){this._N$layoutType=e,this._isAlign=!0,this._doLayoutDirty()}},{key:"resizeMode",get:function(){return this._resizeMode},set:function(e){this._N$layoutType===HB.NONE&&e===WB.CHILDREN||(this._resizeMode=e,this._doLayoutDirty())}},{key:"cellSize",get:function(){return this._cellSize},set:function(e){this._cellSize!==e&&(this._cellSize.set(e),this._doLayoutDirty())}},{key:"startAxis",get:function(){return this._startAxis},set:function(e){this._startAxis!==e&&(this._startAxis=e,this._doLayoutDirty())}},{key:"paddingLeft",get:function(){return this._paddingLeft},set:function(e){this._paddingLeft!==e&&(this._paddingLeft=e,this._doLayoutDirty())}},{key:"paddingRight",get:function(){return this._paddingRight},set:function(e){this._paddingRight!==e&&(this._paddingRight=e,this._doLayoutDirty())}},{key:"paddingTop",get:function(){return this._paddingTop},set:function(e){this._paddingTop!==e&&(this._paddingTop=e,this._doLayoutDirty())}},{key:"paddingBottom",get:function(){return this._paddingBottom},set:function(e){this._paddingBottom!==e&&(this._paddingBottom=e,this._doLayoutDirty())}},{key:"spacingX",get:function(){return this._spacingX},set:function(e){this._spacingX!==e&&(this._spacingX=e,this._doLayoutDirty())}},{key:"spacingY",get:function(){return this._spacingY},set:function(e){this._spacingY!==e&&(this._spacingY=e,this._doLayoutDirty())}},{key:"verticalDirection",get:function(){return this._verticalDirection},set:function(e){this._verticalDirection!==e&&(this._verticalDirection=e,this._doLayoutDirty())}},{key:"horizontalDirection",get:function(){return this._horizontalDirection},set:function(e){this._horizontalDirection!==e&&(this._horizontalDirection=e,this._doLayoutDirty())}},{key:"padding",get:function(){return this._paddingLeft},set:function(e){this._N$padding=e,this._migratePaddingData(),this._doLayoutDirty()}},{key:"affectedByScale",get:function(){return this._affectedByScale},set:function(e){this._affectedByScale=e,this._doLayoutDirty()}}]),t}(),UB.Type=HB,UB.VerticalDirection=qB,UB.HorizontalDirection=YB,UB.ResizeMode=WB,UB.AxisDirection=jB,de((CB=XB).prototype,"type",[hB],Object.getOwnPropertyDescriptor(CB.prototype,"type"),CB.prototype),de(CB.prototype,"resizeMode",[pB],Object.getOwnPropertyDescriptor(CB.prototype,"resizeMode"),CB.prototype),de(CB.prototype,"cellSize",[_B],Object.getOwnPropertyDescriptor(CB.prototype,"cellSize"),CB.prototype),de(CB.prototype,"startAxis",[fB],Object.getOwnPropertyDescriptor(CB.prototype,"startAxis"),CB.prototype),de(CB.prototype,"paddingLeft",[dB],Object.getOwnPropertyDescriptor(CB.prototype,"paddingLeft"),CB.prototype),de(CB.prototype,"paddingRight",[mB],Object.getOwnPropertyDescriptor(CB.prototype,"paddingRight"),CB.prototype),de(CB.prototype,"paddingTop",[vB],Object.getOwnPropertyDescriptor(CB.prototype,"paddingTop"),CB.prototype),de(CB.prototype,"paddingBottom",[yB],Object.getOwnPropertyDescriptor(CB.prototype,"paddingBottom"),CB.prototype),de(CB.prototype,"spacingX",[gB],Object.getOwnPropertyDescriptor(CB.prototype,"spacingX"),CB.prototype),de(CB.prototype,"spacingY",[xB],Object.getOwnPropertyDescriptor(CB.prototype,"spacingY"),CB.prototype),de(CB.prototype,"verticalDirection",[bB],Object.getOwnPropertyDescriptor(CB.prototype,"verticalDirection"),CB.prototype),de(CB.prototype,"horizontalDirection",[TB],Object.getOwnPropertyDescriptor(CB.prototype,"horizontalDirection"),CB.prototype),de(CB.prototype,"padding",[SB],Object.getOwnPropertyDescriptor(CB.prototype,"padding"),CB.prototype),de(CB.prototype,"affectedByScale",[EB],Object.getOwnPropertyDescriptor(CB.prototype,"affectedByScale"),CB.prototype),AB=de(CB.prototype,"_resizeMode",[Ko],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return WB.NONE}}),OB=de(CB.prototype,"_N$layoutType",[Ko],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return HB.NONE}}),kB=de(CB.prototype,"_N$padding",[Ko],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return 0}}),RB=de(CB.prototype,"_cellSize",[Ko],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return new en(40,40)}}),FB=de(CB.prototype,"_startAxis",[Ko],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return jB.HORIZONTAL}}),MB=de(CB.prototype,"_paddingLeft",[Ko],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return 0}}),IB=de(CB.prototype,"_paddingRight",[Ko],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return 0}}),PB=de(CB.prototype,"_paddingTop",[Ko],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return 0}}),LB=de(CB.prototype,"_paddingBottom",[Ko],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return 0}}),DB=de(CB.prototype,"_spacingX",[Ko],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return 0}}),NB=de(CB.prototype,"_spacingY",[Ko],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return 0}}),zB=de(CB.prototype,"_verticalDirection",[Ko],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return qB.TOP_TO_BOTTOM}}),BB=de(CB.prototype,"_horizontalDirection",[Ko],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return YB.LEFT_TO_RIGHT}}),GB=de(CB.prototype,"_affectedByScale",[Ko],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return!1}}),wB=CB))||wB)||wB)||wB)||wB)||wB)||wB);cc.LayoutComponent=bG,function(e){e[e.BUTT=0]="BUTT",e[e.ROUND=1]="ROUND",e[e.SQUARE=2]="SQUARE"}(ZB||(ZB={})),bt(ZB),function(e){e[e.BEVEL=0]="BEVEL",e[e.ROUND=1]="ROUND",e[e.MITER=2]="MITER"}(QB||(QB={})),bt(QB),function(e){e[e.PT_CORNER=1]="PT_CORNER",e[e.PT_LEFT=2]="PT_LEFT",e[e.PT_BEVEL=4]="PT_BEVEL",e[e.PT_INNERBEVEL=8]="PT_INNERBEVEL"}(JB||(JB={})),bt(JB);var TG,SG,EG,wG,CG,AG,OG,kG,RG,FG,MG,IG,PG,LG,DG,NG,zG={parent:null,owner:null,subModelIdx:0},BG=($B=Yo("cc.GraphicsComponent"),eG=os("i18n:cc.GraphicsComponent"),tG=ts(110),iG=es("UI/Render/Graphics"),nG=Ko({type:QB,tooltip:"两条线相交时，所创建的拐角类型"}),rG=Ko({type:ZB,tooltip:"线条的结束端点样式"}),aG=Ko({tooltip:"笔触的颜色"}),oG=Ko({tooltip:"填充绘画的颜色"}),sG=Ko({tooltip:"最大斜接长度"}),lG=Ko({override:!0,visible:!1}),$B(uG=eG(uG=tG(uG=iG((yG=vG=function(e){function t(){var e;return Z(this,t),(e=re(this,te(t).call(this))).impl=null,e.model=null,fe(e,"_lineWidth",hG,ne(e)),fe(e,"_strokeColor",pG,ne(e)),fe(e,"_lineJoin",_G,ne(e)),fe(e,"_lineCap",fG,ne(e)),fe(e,"_fillColor",dG,ne(e)),fe(e,"_miterLimit",mG,ne(e)),e._instanceMaterialType=exports.InstanceMaterialType.ADDCOLOR,e}return ee(t,wA),J(t,[{key:"lineWidth",get:function(){return this._lineWidth},set:function(e){this._lineWidth=e,this.impl&&(this.impl.lineWidth=e)}},{key:"lineJoin",get:function(){return this._lineJoin},set:function(e){this._lineJoin=e,this.impl&&(this.impl.lineJoin=e)}},{key:"lineCap",get:function(){return this._lineCap},set:function(e){this._lineCap=e,this.impl&&(this.impl.lineCap=e)}},{key:"strokeColor",get:function(){return this._strokeColor},set:function(e){this.impl&&(this._strokeColor.set(e),this.impl.strokeColor=this._strokeColor)}},{key:"fillColor",get:function(){return this._fillColor},set:function(e){this.impl&&(this._fillColor.set(e),this.impl.fillColor=this._fillColor)}},{key:"miterLimit",get:function(){return this._miterLimit},set:function(e){this._miterLimit=e}},{key:"color",get:function(){return this._color},set:function(e){this._color!==e&&(this._color.set(e),this._updateColor(),this.markForUpdateRenderData())}}]),J(t,[{key:"onRestore",value:function(){this.impl||this._flushAssembler()}},{key:"__preload",value:function(){oe(te(t.prototype),"__preload",this)&&oe(te(t.prototype),"__preload",this).call(this),this.impl=this._assembler&&this._assembler.createImpl(this)}},{key:"onLoad",value:function(){this._sceneGetter=_O.root.ui.getRenderSceneGetter(),this.model||(this.model=_O.root.createModel(ah))}},{key:"onEnable",value:function(){oe(te(t.prototype),"onEnable",this).call(this),this._activateMaterial()}},{key:"onDisable",value:function(){this._detachFromScene()}},{key:"onDestroy",value:function(){oe(te(t.prototype),"onDestroy",this).call(this),this._sceneGetter=null,this.model&&(this.model.destroy(),_O.root.destroyModel(this.model),this.model=null),this.impl&&(this.impl.clear(),this.impl=null)}},{key:"_activateMaterial",value:function(){this._material&&this._updateMaterial(this._material)}},{key:"moveTo",value:function(e,t){this.impl&&this.impl.moveTo(e,t)}},{key:"lineTo",value:function(e,t){this.impl&&this.impl.lineTo(e,t)}},{key:"bezierCurveTo",value:function(e,t,i,n,r,a){this.impl&&this.impl.bezierCurveTo(e,t,i,n,r,a)}},{key:"quadraticCurveTo",value:function(e,t,i,n){this.impl&&this.impl.quadraticCurveTo(e,t,i,n)}},{key:"arc",value:function(e,t,i,n,r,a){this.impl&&this.impl.arc(e,t,i,n,r,a)}},{key:"ellipse",value:function(e,t,i,n){this.impl&&this.impl.ellipse(e,t,i,n)}},{key:"circle",value:function(e,t,i){this.impl&&this.impl.circle(e,t,i)}},{key:"rect",value:function(e,t,i,n){this.impl&&this.impl.rect(e,t,i,n)}},{key:"roundRect",value:function(e,t,i,n,r){this.impl&&this.impl.roundRect(e,t,i,n,r)}},{key:"fillRect",value:function(e,t,i,n){this.rect(e,t,i,n),this.fill()}},{key:"clear",value:function(){var e=arguments.length>0&&void 0!==arguments[0]&&arguments[0];this.impl&&(this.impl.clear(e),this._detachFromScene(),this.model&&this.model.destroy(),this.markForUpdateRenderData())}},{key:"close",value:function(){this.impl&&this.impl.close()}},{key:"stroke",value:function(){this._assembler.stroke(this),this._attachToScene()}},{key:"fill",value:function(){this._assembler.fill(this),this._attachToScene()}},{key:"helpInstanceMaterial",value:function(){var e=null;zG.owner=new Hp,this._sharedMaterial?(zG.parent=this._sharedMaterial,e=new Xp(zG)):(zG.parent=Pc.get("ui-base-material"),(e=new Xp(zG)).recompileShaders({USE_LOCAL:!0})),this._updateMaterial(e),this.impl||(this._flushAssembler(),this.impl=this._assembler&&this._assembler.createImpl(this))}},{key:"_render",value:function(e){e.commitModel(this,this.model,this._material)}},{key:"_instanceMaterial",value:function(){this.helpInstanceMaterial()}},{key:"_flushAssembler",value:function(){var e=t.Assembler.getAssembler(this);this._assembler!==e&&(this._assembler=e)}},{key:"_canRender",value:function(){return!!oe(te(t.prototype),"_canRender",this).call(this)&&(!!this.model&&this.model.inited)}},{key:"_attachToScene",value:function(){var e=_O.root.ui.renderScene;this.model&&this.model.scene!==e&&(null!==this.model.scene&&this._detachFromScene(),e.addModel(this.model))}},{key:"_detachFromScene",value:function(){this.model&&this.model.scene&&(this.model.scene.removeModel(this.model),this.model.scene=null)}}]),t}(),vG.LineJoin=QB,vG.LineCap=ZB,de((cG=yG).prototype,"lineWidth",[Ko],Object.getOwnPropertyDescriptor(cG.prototype,"lineWidth"),cG.prototype),de(cG.prototype,"lineJoin",[nG],Object.getOwnPropertyDescriptor(cG.prototype,"lineJoin"),cG.prototype),de(cG.prototype,"lineCap",[rG],Object.getOwnPropertyDescriptor(cG.prototype,"lineCap"),cG.prototype),de(cG.prototype,"strokeColor",[aG],Object.getOwnPropertyDescriptor(cG.prototype,"strokeColor"),cG.prototype),de(cG.prototype,"fillColor",[oG],Object.getOwnPropertyDescriptor(cG.prototype,"fillColor"),cG.prototype),de(cG.prototype,"miterLimit",[sG],Object.getOwnPropertyDescriptor(cG.prototype,"miterLimit"),cG.prototype),de(cG.prototype,"color",[lG],Object.getOwnPropertyDescriptor(cG.prototype,"color"),cG.prototype),hG=de(cG.prototype,"_lineWidth",[Ko],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return 1}}),pG=de(cG.prototype,"_strokeColor",[Ko],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return an.BLACK.clone()}}),_G=de(cG.prototype,"_lineJoin",[Ko],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return QB.MITER}}),fG=de(cG.prototype,"_lineCap",[Ko],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return ZB.BUTT}}),dG=de(cG.prototype,"_fillColor",[Ko],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return an.WHITE.clone()}}),mG=de(cG.prototype,"_miterLimit",[Ko],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return 10}}),uG=cG))||uG)||uG)||uG)||uG);cc.GraphicsComponent=BG;var GG,UG=new Ki,XG=new ki,VG=new Ki,HG=[];!function(e){e[e.RECT=0]="RECT",e[e.ELLIPSE=1]="ELLIPSE",e[e.GRAPHICS_STENCIL=2]="GRAPHICS_STENCIL"}(GG||(GG={})),bt(GG);var WG,jG,qG,YG,KG,ZG,QG,JG,$G,eU,tU,iU,nU,rU,aU,oU,sU,lU,uU,cU=(TG=Yo("cc.MaskComponent"),SG=os("i18n:cc.MaskComponent"),EG=ts(110),wG=es("UI/Render/Mask"),CG=Ko({type:GG,displayOrder:4,tooltip:"遮罩类型"}),AG=Ko({tooltip:"反向遮罩"}),OG=Ko({visible:!1,override:!0}),kG=Ko({visible:!1,override:!0}),RG=Ko({visible:!1,override:!0}),TG(FG=SG(FG=EG(FG=wG((NG=DG=function(e){function t(){var e;return Z(this,t),fe(e=re(this,te(t).call(this)),"_type",IG,ne(e)),fe(e,"_inverted",PG,ne(e)),fe(e,"_segments",LG,ne(e)),e._graphics=null,e._clearGraphics=null,e._instanceMaterialType=exports.InstanceMaterialType.ADDCOLOR,e}return ee(t,wA),J(t,[{key:"type",get:function(){return this._type},set:function(e){this._type!==e&&(this._type=e,this._updateGraphics(),this._renderData&&(this.destroyRenderData(),this._renderData=null))}},{key:"inverted",get:function(){return this._inverted},set:function(e){cc.game.renderType!==ZS.RENDER_TYPE_CANVAS?this._inverted=e:cc.warnID(4202)}},{key:"segments",get:function(){return this._segments},set:function(e){this._segments!==e&&(this._segments=pi(e,3,1e4),this._updateGraphics())}},{key:"graphics",get:function(){return this._graphics}},{key:"clearGraphics",get:function(){return this._clearGraphics}},{key:"dstBlendFactor",get:function(){return this._dstBlendFactor},set:function(e){this._dstBlendFactor!==e&&(this._dstBlendFactor=e,this._updateBlendFunc())}},{key:"srcBlendFactor",get:function(){return this._srcBlendFactor},set:function(e){this._srcBlendFactor!==e&&(this._srcBlendFactor=e,this._updateBlendFunc())}},{key:"color",get:function(){return this._color},set:function(e){this._color!==e&&(this._color.set(e),this.markForUpdateRenderData())}}]),J(t,[{key:"onLoad",value:function(){this._createGraphics(),this._clearGraphics&&this._clearGraphics.onLoad(),this._graphics&&this._graphics.onLoad()}},{key:"onRestore",value:function(){this._createGraphics(),this._updateGraphics()}},{key:"onEnable",value:function(){oe(te(t.prototype),"onEnable",this).call(this),this._enableGraphics(),nE.on("design-resolution-changed",this._updateClearGraphics,this)}},{key:"onDisable",value:function(){oe(te(t.prototype),"onDisable",this).call(this),this._disableGraphics(),nE.off("design-resolution-changed",this._updateClearGraphics)}},{key:"onDestroy",value:function(){oe(te(t.prototype),"onDestroy",this).call(this),this._removeGraphics()}},{key:"isHit",value:function(e){var t=this.node,i=t.getContentSize(),n=i.width,r=i.height,a=XG;this.node.getWorldMatrix(UG),Ki.invert(VG,UG),ki.transformMat4(a,e,VG);var o=t.getAnchorPoint();a.x+=o.x*n,a.y+=o.y*r;var s=!1;if(this.type===GG.RECT||this.type===GG.GRAPHICS_STENCIL)s=a.x>=0&&a.y>=0&&a.x<=n&&a.y<=r;else if(this.type===GG.ELLIPSE){var l=n/2,u=r/2,c=a.x-.5*n,h=a.y-.5*r;s=c*c/(l*l)+h*h/(u*u)<1}return this._inverted&&(s=!s),s}},{key:"_render",value:function(e){e.commitComp(this,null,this._assembler)}},{key:"_postRender",value:function(e){this._postAssembler&&e.commitComp(this,null,this._postAssembler)}},{key:"_nodeStateChange",value:function(e){oe(te(t.prototype),"_nodeStateChange",this).call(this,e),this._updateGraphics()}},{key:"_resolutionChanged",value:function(){this._updateClearGraphics()}},{key:"_canRender",value:function(){return!!oe(te(t.prototype),"_canRender",this).call(this)&&(null!==this._clearGraphics&&null!==this._graphics)}},{key:"_flushAssembler",value:function(){var e=t.Assembler.getAssembler(this),i=t.PostAssembler.getAssembler(this);this._assembler!==e&&(this.destroyRenderData(),this._assembler=e),this._postAssembler!==i&&(this._postAssembler=i),this._renderData||this._assembler&&this._assembler.createData&&(this._renderData=this._assembler.createData(this),this._renderData.material=this.sharedMaterial,this.markForUpdateRenderData())}},{key:"_createGraphics",value:function(){if(!this._clearGraphics){var e=new tg("clear-graphics"),t=this._clearGraphics=e.addComponent(BG);t.delegateSrc=this.node,t.helpInstanceMaterial(),t.lineWidth=0;var i=an.WHITE.clone();i.a=0,t.fillColor=i}if(!this._graphics){var n=this._graphics=new BG;n.node=this.node,n.node.getWorldMatrix(),n.helpInstanceMaterial(),n.lineWidth=0;var r=an.WHITE.clone();r.a=0,n.fillColor=r}}},{key:"_updateClearGraphics",value:function(){if(this._clearGraphics){var e=KT;this._clearGraphics.node.setWorldPosition(e.width/2,e.height/2,0),this._clearGraphics.clear(),this._clearGraphics.rect(-e.width/2,-e.height/2,e.width,e.height),this._clearGraphics.fill()}}},{key:"_updateGraphics",value:function(){if(this._graphics){var e=this.node,t=this._graphics;t.clear();var i=e.getContentSize(),n=i.width,r=i.height,a=e.getAnchorPoint(),o=-n*a.x,s=-r*a.y;if(this._type===GG.RECT)t.rect(o,s,n,r);else if(this._type===GG.ELLIPSE){for(var l=function(e,t,i){HG.length=0;for(var n=2*Math.PI/i,r=0;r<i;++r)HG.push(new Ii(t.x*Math.cos(n*r)+e.x,t.y*Math.sin(n*r)+e.y,0));return HG}(new Ii(o+n/2,s+r/2,0),new Ii(n/2,r/2,0),this._segments),u=0;u<l.length;++u){var c=l[u];0===u?t.moveTo(c.x,c.y):t.lineTo(c.x,c.y)}t.close()}t.fill()}}},{key:"_enableGraphics",value:function(){this._clearGraphics&&(this._clearGraphics.onEnable(),this._updateClearGraphics()),this._graphics&&(this._graphics.onEnable(),this._updateGraphics())}},{key:"_disableGraphics",value:function(){this._graphics&&this._graphics.onDisable(),this._clearGraphics&&this._clearGraphics.onDisable()}},{key:"_removeGraphics",value:function(){this._graphics&&this._graphics.destroy(),this._clearGraphics&&this._clearGraphics.destroy()}}]),t}(),DG.Type=GG,de((MG=NG).prototype,"type",[CG],Object.getOwnPropertyDescriptor(MG.prototype,"type"),MG.prototype),de(MG.prototype,"inverted",[AG],Object.getOwnPropertyDescriptor(MG.prototype,"inverted"),MG.prototype),de(MG.prototype,"segments",[Ko],Object.getOwnPropertyDescriptor(MG.prototype,"segments"),MG.prototype),de(MG.prototype,"dstBlendFactor",[OG],Object.getOwnPropertyDescriptor(MG.prototype,"dstBlendFactor"),MG.prototype),de(MG.prototype,"srcBlendFactor",[kG],Object.getOwnPropertyDescriptor(MG.prototype,"srcBlendFactor"),MG.prototype),de(MG.prototype,"color",[RG],Object.getOwnPropertyDescriptor(MG.prototype,"color"),MG.prototype),IG=de(MG.prototype,"_type",[Ko],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return GG.RECT}}),PG=de(MG.prototype,"_inverted",[Ko],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return!1}}),LG=de(MG.prototype,"_segments",[Ko],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return 64}}),FG=MG))||FG)||FG)||FG)||FG);cc.MaskComponent=cU,function(e){e[e.HORIZONTAL=0]="HORIZONTAL",e[e.VERTICAL=1]="VERTICAL",e[e.FILLED=2]="FILLED"}(uU||(uU={})),xt(uU);var hU,pU,_U,fU,dU,mU,vU,yU,gU,xU,bU=(WG=Yo("cc.ProgressBarComponent"),jG=os("i18n:cc.ProgressBarComponent"),qG=ts(110),YG=es("UI/ProgressBar"),KG=Ko({type:LA,tooltip:"进度条显示用的 Sprite 节点，可以动态改变尺寸"}),ZG=Ko({type:uU,tooltip:"进度条显示模式，目前支持水平和垂直两种"}),QG=Ko({tooltip:"进度条在 progress 为 1 时的最大长度"}),JG=Ko({range:[0,1,.1],slide:!0,tooltip:"当前进度指示，范围从 0 到 1"}),$G=Ko({tooltip:"是否反向驱动进度条"}),WG(eU=jG(eU=qG(eU=YG((lU=sU=function(e){function t(){var e,i;Z(this,t);for(var n=arguments.length,r=new Array(n),a=0;a<n;a++)r[a]=arguments[a];return fe(i=re(this,(e=te(t)).call.apply(e,[this].concat(r))),"_barSprite",iU,ne(i)),fe(i,"_mode",nU,ne(i)),fe(i,"_totalLength",rU,ne(i)),fe(i,"_progress",aU,ne(i)),fe(i,"_reverse",oU,ne(i)),i}return ee(t,rp),J(t,[{key:"_initBarSprite",value:function(){if(this._barSprite){var e=this._barSprite.node;if(!e)return;var t=this.node.getContentSize(),i=this.node.getAnchorPoint(),n=e.getContentSize();if(this._barSprite.fillType===LA.FillType.RADIAL&&(this._mode=uU.FILLED),this._mode===uU.HORIZONTAL?this.totalLength=n.width:this._mode===uU.VERTICAL?this.totalLength=n.height:this.totalLength=this._barSprite.fillRange,e.parent===this.node){var r=-t.width*i.x;e.setPosition(r,0,0)}}}},{key:"_updateBarStatus",value:function(){if(this._barSprite){var e=this._barSprite.node;if(!e)return;var t=e.getAnchorPoint(),i=e.getContentSize(),n=e.getPosition(),r=new ki(0,.5),a=_i(this._progress),o=this._totalLength*a,s=i,l=0,u=0;switch(this._mode){case uU.HORIZONTAL:this._reverse&&(r=new ki(1,.5)),s=new en(o,i.height),l=this._totalLength,u=i.height;break;case uU.VERTICAL:r=this._reverse?new ki(.5,1):new ki(.5,0),s=new en(i.width,o),l=i.width,u=this._totalLength}if(this._mode===uU.FILLED)this._barSprite.type!==LA.Type.FILLED?c("ProgressBar FILLED mode only works when barSprite's Type is FILLED!"):(this._reverse&&(o*=-1),this._barSprite.fillRange=o);else if(this._barSprite.type!==LA.Type.FILLED){var h=r.x-t.x,p=r.y-t.y,_=new Ii(l*h,u*p,0);e.setPosition(n.x+_.x,n.y+_.y,n.z),e.setAnchorPoint(r),e.setContentSize(s)}else c("ProgressBar non-FILLED mode only works when barSprite's Type is non-FILLED!")}}},{key:"barSprite",get:function(){return this._barSprite},set:function(e){this._barSprite!==e&&(this._barSprite=e,this._initBarSprite())}},{key:"mode",get:function(){return this._mode},set:function(e){if(this._mode!==e&&(this._mode=e,this._barSprite)){var t=this._barSprite.node;if(!t)return;var i=t.getContentSize();this._mode===uU.HORIZONTAL?this.totalLength=i.width:this._mode===uU.VERTICAL?this.totalLength=i.height:this._mode===uU.FILLED&&(this.totalLength=this._barSprite.fillRange)}}},{key:"totalLength",get:function(){return this._totalLength},set:function(e){this._mode===uU.FILLED&&(e=_i(e)),this._totalLength=e,this._updateBarStatus()}},{key:"progress",get:function(){return this._progress},set:function(e){this._progress!==e&&(this._progress=e,this._updateBarStatus())}},{key:"reverse",get:function(){return this._reverse},set:function(e){this._reverse!==e&&(this._reverse=e,this._barSprite&&(this._barSprite.fillStart=1-this._barSprite.fillStart),this._updateBarStatus())}}]),t}(),sU.Mode=uU,de((tU=lU).prototype,"barSprite",[KG],Object.getOwnPropertyDescriptor(tU.prototype,"barSprite"),tU.prototype),de(tU.prototype,"mode",[ZG],Object.getOwnPropertyDescriptor(tU.prototype,"mode"),tU.prototype),de(tU.prototype,"totalLength",[QG],Object.getOwnPropertyDescriptor(tU.prototype,"totalLength"),tU.prototype),de(tU.prototype,"progress",[JG],Object.getOwnPropertyDescriptor(tU.prototype,"progress"),tU.prototype),de(tU.prototype,"reverse",[$G],Object.getOwnPropertyDescriptor(tU.prototype,"reverse"),tU.prototype),iU=de(tU.prototype,"_barSprite",[Ko],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return null}}),nU=de(tU.prototype,"_mode",[Ko],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return uU.HORIZONTAL}}),rU=de(tU.prototype,"_totalLength",[Ko],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return 1}}),aU=de(tU.prototype,"_progress",[Ko],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return.1}}),oU=de(tU.prototype,"_reverse",[Ko],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return!1}}),eU=tU))||eU)||eU)||eU)||eU);cc.ProgressBarComponent=bU;var TU,SU,EU,wU,CU,AU,OU,kU,RU,FU,MU,IU,PU,LU,DU,NU,zU,BU,GU,UU,XU,VU,HU,WU,jU=(hU=Yo("cc.LabelOutlineComponent"),pU=os("i18n:cc.LabelOutlineComponent"),_U=ts(110),fU=es("UI/LabelOutline"),dU=Ko({tooltip:"描边的颜色"}),mU=Ko({tooltip:"描边的宽度"}),hU(vU=pU(vU=_U(vU=fU((gU=de((yU=function(e){function t(){var e,i;Z(this,t);for(var n=arguments.length,r=new Array(n),a=0;a<n;a++)r[a]=arguments[a];return fe(i=re(this,(e=te(t)).call.apply(e,[this].concat(r))),"_color",gU,ne(i)),fe(i,"_width",xU,ne(i)),i}return ee(t,rp),J(t,[{key:"_updateRenderData",value:function(){var e=this.node.getComponent(iz);e&&e.updateRenderData(!0)}},{key:"color",get:function(){return this._color},set:function(e){this._color!==e&&(this._color.set(e),this._updateRenderData())}},{key:"width",get:function(){return this._width},set:function(e){this._width!==e&&(this._width=e,this._updateRenderData())}}]),t}()).prototype,"_color",[Ko],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return new an(255,255,255,255)}}),xU=de(yU.prototype,"_width",[Ko],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return 1}}),de(yU.prototype,"color",[dU],Object.getOwnPropertyDescriptor(yU.prototype,"color"),yU.prototype),de(yU.prototype,"width",[mU],Object.getOwnPropertyDescriptor(yU.prototype,"width"),yU.prototype),vU=yU))||vU)||vU)||vU)||vU);cc.LabelOutlineComponent=jU;var qU=new No,YU=new et((function(e){return!!cc.isValid(e.node)&&!e.node.getComponent(jU)}),20);YU.get=function(e,t){var i=this._get();i||(i={node:new ix("RICHTEXT_CHILD"),comp:null,lineCount:0,styleIndex:0,clickHandler:""});var n=i.node;n||(n=new ix("RICHTEXT_CHILD"));var r=n.getComponent(iz);return r||(r=n.addComponent(iz)),r=r,n.setPosition(0,0,0),n.setAnchorPoint(.5,.5),n.setContentSize(128,128),"string"!=typeof e&&(e=""+e),t.font instanceof Ld?r.font=t.font:r.fontFamily="Arial",r.string=e,r.horizontalAlign=exports.HorizontalTextAlignment.LEFT,r.verticalAlign=exports.VerticalTextAlignment.TOP,r.fontSize=t.fontSize||40,r.overflow=0,r.enableWrapText=!0,r.lineHeight=40,r.isBold=!1,r.isItalic=!1,r.isUnderline=!1,{node:n,comp:r,lineCount:0,clickHandler:"",styleIndex:0}};var KU,ZU,QU,JU,$U,eX,tX,iX,nX,rX,aX,oX,sX,lX,uX,cX,hX,pX=(TU=Yo("cc.RichTextComponent"),SU=os("i18n:cc.RichTextComponent"),EU=ts(110),wU=es("UI/Render/RichText"),CU=Ko({multiline:!0,tooltip:"富文本显示的文本内容"}),AU=Ko({type:exports.HorizontalTextAlignment,tooltip:"文本内容的水平对齐方式"}),OU=Ko({tooltip:"富文本字体大小"}),kU=Ko({type:Ld,tooltip:"富文本定制字体"}),RU=Ko({tooltip:"富文本的最大宽度"}),FU=Ko({tooltip:"富文本行高"}),MU=Ko({type:bf,tooltip:"对于 img 标签里面的 src 属性名称，都需要在 imageAtlas 里面找到一个有效的 spriteFrame，否则 img tag 会判定为无效"}),IU=Ko({tooltip:"选中此选项后，RichText 将阻止节点边界框中的所有输入事件（鼠标和触摸），从而防止输入事件穿透到底层节点"}),TU(PU=SU(PU=EU(PU=wU(PU=Jo((WU=HU=function(e){function t(){var e;return Z(this,t),fe(e=re(this,te(t).call(this)),"_lineHeight",DU,ne(e)),fe(e,"_string",NU,ne(e)),fe(e,"_horizontalAlign",zU,ne(e)),fe(e,"_fontSize",BU,ne(e)),fe(e,"_maxWidth",GU,ne(e)),fe(e,"_font",UU,ne(e)),fe(e,"_imageAtlas",XU,ne(e)),fe(e,"_handleTouchEvent",VU,ne(e)),e._textArray=[],e._labelSegments=[],e._labelSegmentsCache=[],e._linesWidth=[],e._lineCount=1,e._labelWidth=0,e._labelHeight=0,e._layoutDirty=!0,e._lineOffsetX=0,e._updateRichTextStatus=void 0,e._updateRichTextStatus=e._updateRichText,e}return ee(t,jC),J(t,[{key:"string",get:function(){return this._string},set:function(e){this._string!==e&&(this._string=e,this._updateRichTextStatus())}},{key:"horizontalAlign",get:function(){return this._horizontalAlign},set:function(e){this.horizontalAlign!==e&&(this._horizontalAlign=e,this._layoutDirty=!0,this._updateRichTextStatus())}},{key:"fontSize",get:function(){return this._fontSize},set:function(e){this._fontSize!==e&&(this._fontSize=e,this._layoutDirty=!0,this._updateRichTextStatus())}},{key:"font",get:function(){return this._font},set:function(e){this._font!==e&&(e instanceof jd?console.warn("RichText only accepts TTF fonts, but you are trying to use a bitmap font."):(this._font=e,this._layoutDirty=!0,this._font&&this._onTTFLoaded(),this._updateRichTextStatus()))}},{key:"maxWidth",get:function(){return this._maxWidth},set:function(e){this._maxWidth!==e&&(this._maxWidth=e,this._layoutDirty=!0,this._updateRichTextStatus())}},{key:"lineHeight",get:function(){return this._lineHeight},set:function(e){this._lineHeight!==e&&(this._lineHeight=e,this._layoutDirty=!0,this._updateRichTextStatus())}},{key:"imageAtlas",get:function(){return this._imageAtlas},set:function(e){this._imageAtlas!==e&&(this._imageAtlas=e,this._layoutDirty=!0,this._updateRichTextStatus())}},{key:"handleTouchEvent",get:function(){return this._handleTouchEvent},set:function(e){this._handleTouchEvent!==e&&(this._handleTouchEvent=e,this.enabledInHierarchy&&(this.handleTouchEvent?this._addEventListeners():this._removeEventListeners()))}}]),J(t,[{key:"onEnable",value:function(){this.handleTouchEvent&&this._addEventListeners(),this._updateRichText(),this._activateChildren(!0)}},{key:"onDisable",value:function(){this.handleTouchEvent&&this._removeEventListeners(),this._activateChildren(!1)}},{key:"start",value:function(){this._onTTFLoaded(),this.node.on(tg.EventType.ANCHOR_CHANGED,this._anchorChanged,this)}},{key:"onRestore",value:function(){}},{key:"onDestroy",value:function(){for(var e,t=_e(this._labelSegments);!(e=t()).done;){var i=e.value;i.node.removeFromParent(),YU.put(i)}this.node.off(tg.EventType.ANCHOR_CHANGED,this._anchorChanged)}},{key:"_addEventListeners",value:function(){this.node.on(tg.EventType.TOUCH_END,this._onTouchEnded,this)}},{key:"_removeEventListeners",value:function(){this.node.off(tg.EventType.TOUCH_END,this._onTouchEnded,this)}},{key:"_updateLabelSegmentTextAttributes",value:function(){var e=this;this._labelSegments.forEach((function(t){e._applyTextAttribute(t)}))}},{key:"_createFontLabel",value:function(e){return YU.get(e,this)}},{key:"_onTTFLoaded",value:function(){if(this._font instanceof Hd)if(this._font._nativeAsset)this._layoutDirty=!0,this._updateRichText();else{var e=this;Ym.load(this._font.nativeUrl,(function(t,i){e._layoutDirty=!0,e._updateRichText()}))}else this._layoutDirty=!0,this._updateRichText()}},{key:"_measureText",value:function(e,t){var i=this,n=function(t){var n;return 0===i._labelSegmentsCache.length?(n=i._createFontLabel(t),i._labelSegmentsCache.push(n)):(n=i._labelSegmentsCache[0]).node.getComponent(iz).string=t,n.styleIndex=e,i._applyTextAttribute(n),n.node.getContentSize().width};return t?n(t):n}},{key:"_onTouchEnded",value:function(e){for(var t,i=this,n=this.node.getComponents(jC),r=this,a=function(){var a=t.value,o=a.clickHandler;o&&i._containsTouchLocation(a,e.touch.getUILocation())&&(n.forEach((function(t){var i=t[o];t.enabledInHierarchy&&i&&i.call(r,e)})),e.propagationStopped=!0)},o=_e(this._labelSegments);!(t=o()).done;)a()}},{key:"_containsTouchLocation",value:function(e,t){var i=e.node.getComponent(Iy);return!!i&&i.getBoundingBoxToWorld().contains(t)}},{key:"_resetState",value:function(){for(var e=this,t=this.node.children,i=function(i){var n=t[i];if(("RICHTEXT_CHILD"===n.name||"RICHTEXT_Image_CHILD"===n.name)&&(n.parent===e.node?n.parent=null:t.splice(i,1),"RICHTEXT_CHILD"===n.name)){var r=e._labelSegments.findIndex((function(e){return e.node===n}));-1!==r&&YU.put(e._labelSegments[r])}},n=t.length-1;n>=0;n--)i(n);this._labelSegments.length=0,this._labelSegmentsCache.length=0,this._linesWidth.length=0,this._lineOffsetX=0,this._lineCount=1,this._labelWidth=0,this._labelHeight=0,this._layoutDirty=!0}},{key:"_activateChildren",value:function(e){for(var t=this.node.children.length-1;t>=0;t--){var i=this.node.children[t];"RICHTEXT_CHILD"!==i.name&&"RICHTEXT_Image_CHILD"!==i.name||(i.active=e)}}},{key:"_addLabelSegment",value:function(e,t){var i;if(0===this._labelSegmentsCache.length)i=this._createFontLabel(e);else{var n=(i=this._labelSegmentsCache.pop()).node.getComponent(iz);n&&(n.string=e)}return i.styleIndex=t,i.lineCount=this._lineCount,i.node.setAnchorPoint(0,0),this._applyTextAttribute(i),this.node.addChild(i.node),this._labelSegments.push(i),i}},{key:"_updateRichTextWithMaxWidth",value:function(e,t,i){var n=t;if(this._lineOffsetX>0&&n+this._lineOffsetX>this.maxWidth)for(var r=0;this._lineOffsetX<=this.maxWidth;){var a=this._getFirstWordLen(e,r,e.length),o=e.substr(r,a),s=this._measureText(i,o);if(!(this._lineOffsetX+s<=this.maxWidth)){if(r>0){var l=e.substr(0,r);this._addLabelSegment(l,i),e=e.substr(r,e.length),n=this._measureText(i,e)}this._updateLineInfo();break}this._lineOffsetX+=s,r+=a}if(n>this.maxWidth)for(var u=Po(e,n,this.maxWidth,this._measureText(i)),c=0;c<u.length;++c){var h=u[c],p=this._addLabelSegment(h,i).node.getContentSize();this._lineOffsetX+=p.width,u.length>1&&c<u.length-1&&this._updateLineInfo()}else this._lineOffsetX+=n,this._addLabelSegment(e,i)}},{key:"_isLastComponentCR",value:function(e){return e.length-1===e.lastIndexOf("\n")}},{key:"_updateLineInfo",value:function(){this._linesWidth.push(this._lineOffsetX),this._lineOffsetX=0,this._lineCount++}},{key:"_needsUpdateTextLayout",value:function(e){if(this._layoutDirty||!this._textArray||!e)return!0;if(this._textArray.length!==e.length)return!0;for(var t=0;t<this._textArray.length;t++){var i=this._textArray[t],n=e[t];if(i.text!==n.text)return!0;if(i.style){if(n.style){if(!!n.style.outline!=!!i.style.outline)return!0;if(i.style.size!==n.style.size||i.style.italic!==n.style.italic||i.style.isImage!==n.style.isImage)return!0;if(i.style.isImage===n.style.isImage&&i.style.src!==n.style.src)return!0}else if(i.style.size||i.style.italic||i.style.isImage||i.style.outline)return!0}else if(n.style&&(n.style.size||n.style.italic||n.style.isImage||n.style.outline))return!0}return!1}},{key:"_addRichTextImageElement",value:function(e){if(e.style){var t=e.style.src,i=this._imageAtlas&&t&&this._imageAtlas.getSpriteFrame(t);if(i){var n=new ix("RICHTEXT_Image_CHILD"),r=n.addComponent(LA);n.setAnchorPoint(0,0),r.type=LA.Type.SLICED,r.sizeMode=LA.SizeMode.CUSTOM,this.node.addChild(n);var a={node:n,comp:r,lineCount:0,clickHandler:"",styleIndex:0};this._labelSegments.push(a);var o=i.getRect(),s=1,l=o.width,u=o.height,c=e.style.imageWidth,h=e.style.imageHeight;if(void 0!==h&&h>0&&h<this.lineHeight?(l*=s=h/u,u*=s):(l*=s=this.lineHeight/u,u*=s),void 0!==c&&c>0&&(l=c),this.maxWidth>0?(this._lineOffsetX+l>this.maxWidth&&this._updateLineInfo(),this._lineOffsetX+=l):(this._lineOffsetX+=l,this._lineOffsetX>this._labelWidth&&(this._labelWidth=this._lineOffsetX)),r.spriteFrame=i,n.setContentSize(l,u),a.lineCount=this._lineCount,e.style.event){var p="click";e.style.event[p]&&(a.clickHandler=e.style.event[p])}}else g(4400)}}},{key:"_updateRichText",value:function(){if(this.enabled){var e=qU.parse(this._string);if(!this._needsUpdateTextLayout(e))return this._textArray=e.slice(),void this._updateLabelSegmentTextAttributes();this._textArray=e.slice(),this._resetState();for(var t,i=!1,n=0;n<this._textArray.length;++n){var r=this._textArray[n],a=r.text;if(void 0!==a){if(""===a){if(r.style&&r.style.isNewLine){this._updateLineInfo();continue}if(r.style&&r.style.isImage&&this.imageAtlas){this._addRichTextImageElement(r);continue}}for(var o=a.split("\n"),s=0;s<o.length;++s){var l=o[s];if(""!==l)if(i=!1,this.maxWidth>0){var u=this._measureText(n,l);this._updateRichTextWithMaxWidth(l,u,n),o.length>1&&s<o.length-1&&this._updateLineInfo()}else t=this._addLabelSegment(l,n).node.getContentSize(),this._lineOffsetX+=t.width,this._lineOffsetX>this._labelWidth&&(this._labelWidth=this._lineOffsetX),o.length>1&&s<o.length-1&&this._updateLineInfo();else{if(this._isLastComponentCR(a)&&s===o.length-1)continue;this._updateLineInfo(),i=!0}}}}i||this._linesWidth.push(this._lineOffsetX),this.maxWidth>0&&(this._labelWidth=this.maxWidth),this._labelHeight=(this._lineCount+.26)*this.lineHeight,this.node.setContentSize(this._labelWidth,this._labelHeight),this._updateRichTextPosition(),this._layoutDirty=!1}}},{key:"_getFirstWordLen",value:function(e,t,i){var n=e.charAt(t);if(Fo(n)||Mo(n))return 1;for(var r=1,a=t+1;a<i&&(!Mo(n=e.charAt(a))&&!Fo(n));++a)r++;return r}},{key:"_updateRichTextPosition",value:function(){for(var e,t=0,i=1,n=this._lineCount,r=_e(this._labelSegments);!(e=r()).done;){var a=e.value,o=a.lineCount;o>i&&(t=0,i=o);var s=this.node.anchorX,l=this._labelWidth*(.5*this.horizontalAlign-s);switch(this.horizontalAlign){case exports.HorizontalTextAlignment.LEFT:break;case exports.HorizontalTextAlignment.CENTER:l-=this._linesWidth[o-1]/2;break;case exports.HorizontalTextAlignment.RIGHT:l-=this._linesWidth[o-1]}var u=a.node.position,c=this.node.anchorY;a.node.setPosition(t+l,this.lineHeight*(n-o)-this._labelHeight*c,u.z),o===i&&(t+=a.node.width)}}},{key:"_convertLiteralColorValue",value:function(e){var t=e.toUpperCase();return an[t]?an[t]:(new an).fromHEX(e)}},{key:"_applyTextAttribute",value:function(e){var t=e.node.getComponent(iz);if(t){var i,n=e.styleIndex;t.lineHeight=this.lineHeight,t.horizontalAlign=exports.HorizontalTextAlignment.LEFT,t.verticalAlign=exports.VerticalTextAlignment.CENTER,this._textArray[n]&&(i=this._textArray[n].style);var r=e.node.getComponent(iz);if(r&&(i&&i.color?r.color=this._convertLiteralColorValue(i.color):r.color=this._convertLiteralColorValue("white")),t.isBold=!(!i||!i.bold),t.isItalic=!(!i||!i.italic),t.isUnderline=!(!i||!i.underline),i&&i.outline){var a=e.node.getComponent(jU);a||(a=e.node.addComponent(jU)),a.color=this._convertLiteralColorValue(i.outline.color),a.width=i.outline.width}if(i&&i.size?t.fontSize=i.size:t.fontSize=this._fontSize,t.updateRenderData(!0),i&&i.event){var o="click";i.event[o]&&(e.clickHandler=i.event[o])}}}},{key:"_anchorChanged",value:function(){this._updateRichTextPosition()}}]),t}(),HU.HorizontalAlign=exports.HorizontalTextAlignment,HU.VerticalAlign=exports.VerticalTextAlignment,de((LU=WU).prototype,"string",[CU],Object.getOwnPropertyDescriptor(LU.prototype,"string"),LU.prototype),de(LU.prototype,"horizontalAlign",[AU],Object.getOwnPropertyDescriptor(LU.prototype,"horizontalAlign"),LU.prototype),de(LU.prototype,"fontSize",[OU],Object.getOwnPropertyDescriptor(LU.prototype,"fontSize"),LU.prototype),de(LU.prototype,"font",[kU],Object.getOwnPropertyDescriptor(LU.prototype,"font"),LU.prototype),de(LU.prototype,"maxWidth",[RU],Object.getOwnPropertyDescriptor(LU.prototype,"maxWidth"),LU.prototype),de(LU.prototype,"lineHeight",[FU],Object.getOwnPropertyDescriptor(LU.prototype,"lineHeight"),LU.prototype),de(LU.prototype,"imageAtlas",[MU],Object.getOwnPropertyDescriptor(LU.prototype,"imageAtlas"),LU.prototype),de(LU.prototype,"handleTouchEvent",[IU],Object.getOwnPropertyDescriptor(LU.prototype,"handleTouchEvent"),LU.prototype),DU=de(LU.prototype,"_lineHeight",[Ko],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return 40}}),NU=de(LU.prototype,"_string",[Ko],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return"<color=#00ff00>Rich</c><color=#0fffff>Text</color>"}}),zU=de(LU.prototype,"_horizontalAlign",[Ko],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return exports.HorizontalTextAlignment.LEFT}}),BU=de(LU.prototype,"_fontSize",[Ko],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return 40}}),GU=de(LU.prototype,"_maxWidth",[Ko],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return 0}}),UU=de(LU.prototype,"_font",[Ko],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return null}}),XU=de(LU.prototype,"_imageAtlas",[Ko],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return null}}),VU=de(LU.prototype,"_handleTouchEvent",[Ko],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return!0}}),PU=LU))||PU)||PU)||PU)||PU)||PU);cc.RichTextComponent=pX;var _X,fX=new Ii,dX=new Ii,mX=new Ii,vX=(new en,new ki,new ki),yX=new an;!function(e){e[e.HORIZONTAL=0]="HORIZONTAL",e[e.VERTICAL=1]="VERTICAL"}(_X||(_X={})),bt(_X);var gX,xX=(KU=Yo("cc.ScrollBarComponent"),ZU=os("i18n:cc.ScrollBarComponent"),QU=ts(110),JU=es("UI/ScrollBar"),$U=Ko({type:LA,tooltip:"作为当前滚动区域位置显示的滑块 Sprite",displayOrder:0}),eX=Ko({type:_X,tooltip:"ScrollBar 的滚动方向",displayOrder:1}),tX=Ko({tooltip:"是否在没有滚动动作时自动隐藏 ScrollBar",displayOrder:2}),iX=Ko({tooltip:"没有滚动动作后经过多久会自动隐藏。\n注意：只要当 “enableAutoHide” 为 true 时，才有效。",displayOrder:3}),KU(nX=ZU(nX=QU(nX=JU((hX=cX=function(e){function t(){var e,i;Z(this,t);for(var n=arguments.length,r=new Array(n),a=0;a<n;a++)r[a]=arguments[a];return fe(i=re(this,(e=te(t)).call.apply(e,[this].concat(r))),"_scrollView",aX,ne(i)),fe(i,"_handle",oX,ne(i)),fe(i,"_direction",sX,ne(i)),fe(i,"_enableAutoHide",lX,ne(i)),fe(i,"_autoHideTime",uX,ne(i)),i._touching=!1,i._opacity=255,i._autoHideRemainingTime=0,i}return ee(t,rp),J(t,[{key:"hide",value:function(){this._autoHideRemainingTime=0,this._setOpacity(0)}},{key:"show",value:function(){this._autoHideRemainingTime=this._autoHideTime,this._setOpacity(this._opacity)}},{key:"onScroll",value:function(e){if(this._scrollView){var t=this._scrollView.content;if(t){var i=t.getContentSize(),n=this._scrollView.node.getContentSize(),r=this.node.getContentSize();if(!this._conditionalDisableScrollBar(i,n)){this._enableAutoHide&&(this._autoHideRemainingTime=this._autoHideTime,this._setOpacity(this._opacity));var a=0,o=0,s=0,l=0,u=0;this._direction===_X.HORIZONTAL?(a=i.width,o=n.width,u=r.width,s=e.x,l=-this._convertToScrollViewSpace(t).x):this._direction===_X.VERTICAL&&(a=i.height,o=n.height,u=r.height,s=e.y,l=-this._convertToScrollViewSpace(t).y);var c=this._calculateLength(a,o,u,s),h=this._calculatePosition(a,o,u,l,s,c);this._updateLength(c),this._updateHandlerPosition(h)}}}}},{key:"setScrollView",value:function(e){this._scrollView=e}},{key:"onTouchBegan",value:function(){this._enableAutoHide&&(this._touching=!0)}},{key:"onTouchEnded",value:function(){if(this._enableAutoHide&&(this._touching=!1,!(this._autoHideTime<=0))){if(this._scrollView){var e=this._scrollView.content;if(e){var t=e.getContentSize(),i=this._scrollView.node.getContentSize();if(this._conditionalDisableScrollBar(t,i))return}}this._autoHideRemainingTime=this._autoHideTime}}},{key:"onEnable",value:function(){var e=this.node.getComponent(LA);e&&(this._opacity=e.color.a)}},{key:"start",value:function(){this._enableAutoHide&&this._setOpacity(0)}},{key:"update",value:function(e){this._processAutoHide(e)}},{key:"_convertToScrollViewSpace",value:function(e){if(!this._scrollView)return fX;var t=this._scrollView.node._uiProps.uiTransformComp,i=e._uiProps.uiTransformComp;if(!t||!i)return fX;dX.set(-e.anchorX*e.width,-e.anchorY*e.height,0),i.convertToWorldSpaceAR(dX,mX);var n=t.convertToNodeSpaceAR(mX);return n.x+=t.anchorX*t.width,n.y+=t.anchorY*t.height,n}},{key:"_setOpacity",value:function(e){if(this._handle){var t=this.node.getComponent(LA);t&&(yX.set(t.color),yX.a=e,t.color=yX),(t=this._handle.getComponent(LA))&&(yX.set(t.color),yX.a=e,t.color=yX)}}},{key:"_updateHandlerPosition",value:function(e){if(this._handle){var t=this._fixupHandlerPosition();this._handle.node.setPosition(e.x+t.x,e.y+t.y,t.z)}}},{key:"_fixupHandlerPosition",value:function(){var e=this.node.getContentSize(),t=this.node.getAnchorPoint(),i=this.handle.node.getContentSize(),n=this.handle.node.parent;Ii.set(dX,-e.width*t.x,-e.height*t.y,0);var r=this.node._uiProps.uiTransformComp.convertToWorldSpaceAR(dX,mX),a=new Ii;return n._uiProps.uiTransformComp.convertToNodeSpaceAR(r,a),this.direction===_X.HORIZONTAL?a=new Ii(a.x,a.y+(e.height-i.height)/2,0):this.direction===_X.VERTICAL&&(a=new Ii(a.x+(e.width-i.width)/2,a.y,0)),this.handle.node.setPosition(a),a}},{key:"_conditionalDisableScrollBar",value:function(e,t){return e.width<=t.width&&this._direction===_X.HORIZONTAL||e.height<=t.height&&this._direction===_X.VERTICAL}},{key:"_calculateLength",value:function(e,t,i,n){var r=e;return n&&(r+=20*(n>0?n:-n)),i*(t/r)}},{key:"_calculatePosition",value:function(e,t,i,n,r,a){var o=e-t;r&&(o+=Math.abs(r));var s=0;o&&(s=_i(s=n/o));var l=(i-a)*s;return this._direction===_X.VERTICAL?new Ii(0,l,0):new Ii(l,0,0)}},{key:"_updateLength",value:function(e){if(this._handle){var t=this._handle.node,i=t.getContentSize(),n=t.getAnchorPoint();n.x===vX.x&&n.y===vX.y||t.setAnchorPoint(vX),this._direction===_X.HORIZONTAL?t.setContentSize(e,i.height):t.setContentSize(i.width,e)}}},{key:"_processAutoHide",value:function(e){if(this._enableAutoHide&&!(this._autoHideRemainingTime<=0)&&!this._touching&&(this._autoHideRemainingTime-=e,this._autoHideRemainingTime<=this._autoHideTime)){this._autoHideRemainingTime=Math.max(0,this._autoHideRemainingTime);var t=this._opacity*(this._autoHideRemainingTime/this._autoHideTime);this._setOpacity(t)}}},{key:"handle",get:function(){return this._handle},set:function(e){this._handle!==e&&(this._handle=e,this.onScroll(new Ii(0,0,0)))}},{key:"direction",get:function(){return this._direction},set:function(e){this._direction!==e&&(this._direction=e,this.onScroll(new Ii))}},{key:"enableAutoHide",get:function(){return this._enableAutoHide},set:function(e){this._enableAutoHide!==e&&(this._enableAutoHide=e,this._enableAutoHide&&this._setOpacity(0))}},{key:"autoHideTime",get:function(){return this._autoHideTime},set:function(e){this._autoHideTime!==e&&(this._autoHideTime=e)}}]),t}(),cX.Direction=_X,de((rX=hX).prototype,"handle",[$U],Object.getOwnPropertyDescriptor(rX.prototype,"handle"),rX.prototype),de(rX.prototype,"direction",[eX],Object.getOwnPropertyDescriptor(rX.prototype,"direction"),rX.prototype),de(rX.prototype,"enableAutoHide",[tX],Object.getOwnPropertyDescriptor(rX.prototype,"enableAutoHide"),rX.prototype),de(rX.prototype,"autoHideTime",[iX],Object.getOwnPropertyDescriptor(rX.prototype,"autoHideTime"),rX.prototype),aX=de(rX.prototype,"_scrollView",[Ko],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return null}}),oX=de(rX.prototype,"_handle",[Ko],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return null}}),sX=de(rX.prototype,"_direction",[Ko],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return _X.HORIZONTAL}}),lX=de(rX.prototype,"_enableAutoHide",[Ko],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return!1}}),uX=de(rX.prototype,"_autoHideTime",[Ko],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return 1}}),nX=rX))||nX)||nX)||nX)||nX);cc.ScrollBarComponent=xX;var bX,TX,SX,EX,wX,CX,AX,OX,kX,RX,FX,MX,IX,PX,LX,DX,NX,zX,BX,GX,UX,XX,VX,HX,WX,jX,qX,YX,KX,ZX,QX=Yo("cc.ViewGroupComponent")(gX=ts(110)(gX=function(e){function t(){return Z(this,t),re(this,te(t).apply(this,arguments))}return ee(t,rp),t}())||gX)||gX;cc.ViewGroupComponent=QX;var JX,$X=new Ii,eV=new Ii,tV=new Ii,iV=new ki,nV=new ki,rV=function(){return(new Date).getMilliseconds()},aV={"scroll-to-top":0,"scroll-to-bottom":1,"scroll-to-left":2,"scroll-to-right":3,scrolling:4,"bounce-bottom":6,"bounce-left":7,"bounce-right":8,"bounce-top":5,"scroll-ended":9,"touch-up":10,"scroll-ended-with-threshold":11,"scroll-began":12};!function(e){e.SCROLL_TO_TOP="scroll-to-top",e.SCROLL_TO_BOTTOM="scroll-to-bottom",e.SCROLL_TO_LEFT="scroll-to-left",e.SCROLL_TO_RIGHT="scroll-to-right",e.SCROLL_BEGAN="scroll-began",e.SCROLL_ENDED="scroll-ended",e.BOUNCE_TOP="bounce-top",e.BOUNCE_BOTTOM="bounce-bottom",e.BOUNCE_LEFT="bounce-left",e.BOUNCE_RIGHT="bounce-right",e.SCROLLING="scrolling",e.SCROLL_ENG_WITH_THRESHOLD="scroll-ended-with-threshold",e.TOUCH_UP="touch-up"}(JX||(JX={}));var oV,sV,lV,uV,cV,hV,pV,_V,fV,dV,mV,vV,yV,gV,xV,bV,TV=(bX=Yo("cc.ScrollViewComponent"),TX=os("i18n:cc.ScrollViewComponent"),SX=ts(110),EX=es("UI/ScrollView"),wX=Ko({range:[0,10],tooltip:"回弹持续的时间，0 表示将立即反弹",displayOrder:0}),CX=Ko({range:[0,1,.1],tooltip:"开启惯性后，在用户停止触摸后滚动多快停止，0 表示永不停止，1 表示立刻停止",displayOrder:1}),AX=Ko({tooltip:"是否允许滚动内容超过边界，并在停止触摸后回弹",displayOrder:2}),OX=Ko({tooltip:"是否开启滚动惯性",displayOrder:3}),kX=Ko({type:tg,tooltip:"可滚动展示内容的节点",displayOrder:4}),RX=Ko({tooltip:"是否开启水平滚动",displayOrder:5}),FX=Ko({type:xX,tooltip:"水平滚动的 ScrollBar",displayOrder:6}),MX=Ko({tooltip:"是否开启垂直滚动",displayOrder:7}),IX=Ko({type:xX,tooltip:"垂直滚动的 ScrollBar",displayOrder:8}),PX=Ko({tooltip:"滚动行为是否会取消子节点上注册的触摸事件",displayOrder:9}),LX=Ko({type:[fO],tooltip:"滚动视图的事件回调函数",displayOrder:10}),bX(DX=TX(DX=SX(DX=EX((ZX=KX=function(e){function t(){var e,i;Z(this,t);for(var n=arguments.length,r=new Array(n),a=0;a<n;a++)r[a]=arguments[a];return fe(i=re(this,(e=te(t)).call.apply(e,[this].concat(r))),"bounceDuration",zX,ne(i)),fe(i,"brake",BX,ne(i)),fe(i,"elastic",GX,ne(i)),fe(i,"inertia",UX,ne(i)),fe(i,"horizontal",XX,ne(i)),fe(i,"vertical",VX,ne(i)),fe(i,"cancelInnerEvents",HX,ne(i)),fe(i,"scrollEvents",WX,ne(i)),i._autoScrolling=!1,i._scrolling=!1,fe(i,"_content",jX,ne(i)),fe(i,"_horizontalScrollBar",qX,ne(i)),fe(i,"_verticalScrollBar",YX,ne(i)),i._topBoundary=0,i._bottomBoundary=0,i._leftBoundary=0,i._rightBoundary=0,i._touchMoveDisplacements=[],i._touchMoveTimeDeltas=[],i._touchMovePreviousTimestamp=0,i._touchMoved=!1,i._autoScrollAttenuate=!1,i._autoScrollStartPosition=new Ii,i._autoScrollTargetDelta=new Ii,i._autoScrollTotalTime=0,i._autoScrollAccumulatedTime=0,i._autoScrollCurrentlyOutOfBoundary=!1,i._autoScrollBraking=!1,i._autoScrollBrakingStartPosition=new Ii,i._outOfBoundaryAmount=new Ii,i._outOfBoundaryAmountDirty=!0,i._stopMouseWheel=!1,i._mouseWheelEventElapsedTime=0,i._isScrollEndedWithThresholdEventFired=!1,i._scrollEventEmitMask=0,i._isBouncing=!1,i._contentPos=new Ii,i._deltaPos=new Ii,i}return ee(t,QX),J(t,[{key:"scrollToBottom",value:function(e){var t=!(arguments.length>1&&void 0!==arguments[1])||arguments[1],i=this._calculateMovePercentDelta({anchor:new ki(0,0),applyToHorizontal:!1,applyToVertical:!0});e?this._startAutoScroll(i,e,!1!==t):this._moveContent(i,!0)}},{key:"scrollToTop",value:function(e){var t=!(arguments.length>1&&void 0!==arguments[1])||arguments[1],i=this._calculateMovePercentDelta({anchor:new ki(0,1),applyToHorizontal:!1,applyToVertical:!0});e?this._startAutoScroll(i,e,!1!==t):this._moveContent(i)}},{key:"scrollToLeft",value:function(e){var t=!(arguments.length>1&&void 0!==arguments[1])||arguments[1],i=this._calculateMovePercentDelta({anchor:new ki(0,0),applyToHorizontal:!0,applyToVertical:!1});e?this._startAutoScroll(i,e,!1!==t):this._moveContent(i)}},{key:"scrollToRight",value:function(e){var t=!(arguments.length>1&&void 0!==arguments[1])||arguments[1],i=this._calculateMovePercentDelta({anchor:new ki(1,0),applyToHorizontal:!0,applyToVertical:!1});e?this._startAutoScroll(i,e,!1!==t):this._moveContent(i)}},{key:"scrollToTopLeft",value:function(e){var t=!(arguments.length>1&&void 0!==arguments[1])||arguments[1],i=this._calculateMovePercentDelta({anchor:new ki(0,1),applyToHorizontal:!0,applyToVertical:!0});e?this._startAutoScroll(i,e,!1!==t):this._moveContent(i)}},{key:"scrollToTopRight",value:function(e){var t=!(arguments.length>1&&void 0!==arguments[1])||arguments[1],i=this._calculateMovePercentDelta({anchor:new ki(1,1),applyToHorizontal:!0,applyToVertical:!0});e?this._startAutoScroll(i,e,!1!==t):this._moveContent(i)}},{key:"scrollToBottomLeft",value:function(e){var t=!(arguments.length>1&&void 0!==arguments[1])||arguments[1],i=this._calculateMovePercentDelta({anchor:new ki(0,0),applyToHorizontal:!0,applyToVertical:!0});e?this._startAutoScroll(i,e,!1!==t):this._moveContent(i)}},{key:"scrollToBottomRight",value:function(e){var t=!(arguments.length>1&&void 0!==arguments[1])||arguments[1],i=this._calculateMovePercentDelta({anchor:new ki(1,0),applyToHorizontal:!0,applyToVertical:!0});e?this._startAutoScroll(i,e,!1!==t):this._moveContent(i)}},{key:"scrollToOffset",value:function(e,t){var i=!(arguments.length>2&&void 0!==arguments[2])||arguments[2],n=this.getMaxScrollOffset(),r=new ki(0,0);0===n.x?r.x=0:r.x=e.x/n.x,0===n.y?r.y=1:r.y=(n.y-e.y)/n.y,this.scrollTo(r,t,i)}},{key:"getScrollOffset",value:function(){var e=this._getContentTopBoundary()-this._topBoundary,t=this._getContentLeftBoundary()-this._leftBoundary;return new Ii(t,e,0)}},{key:"getMaxScrollOffset",value:function(){var e=this.node._uiProps.uiTransformComp.contentSize,t=this._content._uiProps.uiTransformComp.contentSize,i=t.width-e.width,n=t.height-e.height;return new Ii(i=i>=0?i:0,n=n>=0?n:0,0)}},{key:"scrollToPercentHorizontal",value:function(e,t,i){var n=this._calculateMovePercentDelta({anchor:new ki(e,0),applyToHorizontal:!0,applyToVertical:!1});t?this._startAutoScroll(n,t,!1!==i):this._moveContent(n)}},{key:"scrollTo",value:function(e,t,i){var n=this._calculateMovePercentDelta({anchor:new ki(e),applyToHorizontal:!0,applyToVertical:!0});t?this._startAutoScroll(n,t,i):this._moveContent(n)}},{key:"scrollToPercentVertical",value:function(e,t,i){var n=this._calculateMovePercentDelta({anchor:new ki(0,e),applyToHorizontal:!1,applyToVertical:!0});t?this._startAutoScroll(n,t,i):this._moveContent(n)}},{key:"stopAutoScroll",value:function(){this._autoScrolling=!1,this._autoScrollAccumulatedTime=this._autoScrollTotalTime}},{key:"setContentPosition",value:function(e){var t=this.getContentPosition();Math.abs(e.x-t.x)<1e-4&&Math.abs(e.y-t.y)<1e-4||(this._content.setPosition(e),this._outOfBoundaryAmountDirty=!0)}},{key:"getContentPosition",value:function(){return this._content?(this._contentPos.set(this._content.position),this._contentPos):$X}},{key:"isScrolling",value:function(){return this._scrolling}},{key:"isAutoScrolling",value:function(){return this._autoScrolling}},{key:"getScrollEndedEventTiming",value:function(){return 1e-4}},{key:"start",value:function(){this._calculateBoundary(),this._content&&_O.once(iO.EVENT_BEFORE_DRAW,this._adjustContentOutOfBoundary,this)}},{key:"onEnable",value:function(){this._registerEvent(),this.content&&(this.content.on(tg.EventType.SIZE_CHANGED,this._calculateBoundary,this),this.content.on(tg.EventType.TRANSFORM_CHANGED,this._scaleChanged,this),this.view&&(this.view.on(tg.EventType.TRANSFORM_CHANGED,this._scaleChanged,this),this.view.on(tg.EventType.SIZE_CHANGED,this._calculateBoundary,this))),this._calculateBoundary(),this._showScrollBar()}},{key:"update",value:function(e){this._autoScrolling&&this._processAutoScrolling(e)}},{key:"onDisable",value:function(){this._unregisterEvent(),this.content&&(this.content.off(tg.EventType.SIZE_CHANGED,this._calculateBoundary,this),this.content.off(tg.EventType.TRANSFORM_CHANGED,this._scaleChanged,this),this.view&&(this.view.off(tg.EventType.TRANSFORM_CHANGED,this._scaleChanged,this),this.view.off(tg.EventType.SIZE_CHANGED,this._calculateBoundary,this))),this._hideScrollBar(),this.stopAutoScroll()}},{key:"_registerEvent",value:function(){this.node.on(tg.EventType.TOUCH_START,this._onTouchBegan,this,!0),this.node.on(tg.EventType.TOUCH_MOVE,this._onTouchMoved,this,!0),this.node.on(tg.EventType.TOUCH_END,this._onTouchEnded,this,!0),this.node.on(tg.EventType.TOUCH_CANCEL,this._onTouchCancelled,this,!0),this.node.on(tg.EventType.MOUSE_WHEEL,this._onMouseWheel,this,!0)}},{key:"_unregisterEvent",value:function(){this.node.off(tg.EventType.TOUCH_START,this._onTouchBegan,this,!0),this.node.off(tg.EventType.TOUCH_MOVE,this._onTouchMoved,this,!0),this.node.off(tg.EventType.TOUCH_END,this._onTouchEnded,this,!0),this.node.off(tg.EventType.TOUCH_CANCEL,this._onTouchCancelled,this,!0),this.node.off(tg.EventType.MOUSE_WHEEL,this._onMouseWheel,this,!0)}},{key:"_onMouseWheel",value:function(e,t){if(this.enabledInHierarchy&&!this._hasNestedViewGroup(e,t)){var i=new Ii,n=e.getScrollY();this.vertical?i.set(0,-.1*n,0):this.horizontal&&i.set(-.1*n,0,0),this._mouseWheelEventElapsedTime=0,this._processDeltaMove(i),this._stopMouseWheel||(this._handlePressLogic(),this.schedule(this._checkMouseWheel,1/60,NaN,0),this._stopMouseWheel=!0),this._stopPropagationIfTargetIsMe(e)}}},{key:"_onTouchBegan",value:function(e,t){this.enabledInHierarchy&&this._content&&(this._hasNestedViewGroup(e,t)||(this._content&&this._handlePressLogic(),this._touchMoved=!1,this._stopPropagationIfTargetIsMe(e)))}},{key:"_onTouchMoved",value:function(e,t){if(this.enabledInHierarchy&&this._content&&!this._hasNestedViewGroup(e,t)){var i=e.touch;if(this._content&&this._handleMoveLogic(i),this.cancelInnerEvents){var n=i.getUILocation(iV);if(n.subtract(i.getUIStartLocation(nV)),n.length()>7&&!this._touchMoved&&e.target!==this.node){var r=new Tv(e.getTouches(),e.bubbles);r.type=tg.EventType.TOUCH_CANCEL,r.touch=e.touch,r.simulate=!0,e.target.dispatchEvent(r),this._touchMoved=!0}this._stopPropagationIfTargetIsMe(e)}}}},{key:"_onTouchEnded",value:function(e,t){if(this.enabledInHierarchy&&this._content&&e&&!this._hasNestedViewGroup(e,t)){this._dispatchEvent(JX.TOUCH_UP);var i=e.touch;this._content&&this._handleReleaseLogic(i),this._touchMoved?e.propagationStopped=!0:this._stopPropagationIfTargetIsMe(e)}}},{key:"_onTouchCancelled",value:function(e,t){if(this.enabledInHierarchy&&this._content&&!this._hasNestedViewGroup(e,t)){if(e&&!e.simulate){var i=e.touch;this._content&&this._handleReleaseLogic(i)}this._stopPropagationIfTargetIsMe(e)}}},{key:"_calculateBoundary",value:function(){if(this.content){var e=this.content.getComponent(bG);e&&e.enabledInHierarchy&&e.updateLayout();var t=this.view._uiProps.uiTransformComp.contentSize,i=t.width*this.view.anchorX,n=t.height*this.view.anchorY;this._leftBoundary=-i,this._bottomBoundary=-n,this._rightBoundary=this._leftBoundary+t.width,this._topBoundary=this._bottomBoundary+t.height,this._moveContentToTopLeft(t)}}},{key:"_hasNestedViewGroup",value:function(e,t){if(e&&e.eventPhase===al.CAPTURING_PHASE){if(t)for(var i,n=_e(t);!(i=n()).done;){var r=i.value;if(this.node===r)return!(!e.target||!e.target.getComponent(QX));if(r.getComponent(QX))return!0}return!1}}},{key:"_startInertiaScroll",value:function(e){var t=new Ii(e);t.multiplyScalar(.7),this._startAttenuatingAutoScroll(t,e)}},{key:"_calculateAttenuatedFactor",value:function(e){return this.brake<=0?1-this.brake:(1-this.brake)*(1/(1+14e-6*e+e*e*8e-9))}},{key:"_startAttenuatingAutoScroll",value:function(e,t){var i=this._calculateAutoScrollTimeByInitialSpeed(t.length()),n=new Ii(e);n.normalize();var r=this._content._uiProps.uiTransformComp.contentSize,a=this.node._uiProps.uiTransformComp.contentSize,o=r.width-a.width,s=r.height-a.height,l=this._calculateAttenuatedFactor(o),u=this._calculateAttenuatedFactor(s);n.x=n.x*o*(1-this.brake)*l,n.y=n.y*s*u*(1-this.brake),n.z=0;var c=e.length(),h=n.length()/c;if(n.add(e),this.brake>0&&h>7){h=Math.sqrt(h);var p=new Ii(e);p.multiplyScalar(h),n.set(p),n.add(e)}this.brake>0&&h>3&&(i*=h=3),0===this.brake&&h>1&&(i*=h),this._startAutoScroll(n,i,!0)}},{key:"_calculateAutoScrollTimeByInitialSpeed",value:function(e){return Math.sqrt(Math.sqrt(e/5))}},{key:"_startAutoScroll",value:function(e,t){var i=arguments.length>2&&void 0!==arguments[2]&&arguments[2],n=this._flattenVectorByDirection(e);this._autoScrolling=!0,this._autoScrollTargetDelta=n,this._autoScrollAttenuate=i,Ii.copy(this._autoScrollStartPosition,this.getContentPosition()),this._autoScrollTotalTime=t,this._autoScrollAccumulatedTime=0,this._autoScrollBraking=!1,this._isScrollEndedWithThresholdEventFired=!1,this._autoScrollBrakingStartPosition=new Ii;var r=this._getHowMuchOutOfBoundary();r.equals($X,1e-4)||(this._autoScrollCurrentlyOutOfBoundary=!0)}},{key:"_calculateTouchMoveVelocity",value:function(){var e=0;if((e=this._touchMoveTimeDeltas.reduce((function(e,t){return e+t}),e))<=0||e>=.5)return new Ii;var t=new Ii;return t=this._touchMoveDisplacements.reduce((function(e,t){return e.add(t),e}),t),new Ii(t.x*(1-this.brake)/e,t.y*(1-this.brake)/e,0)}},{key:"_flattenVectorByDirection",value:function(e){var t=e;return t.x=this.horizontal?t.x:0,t.y=this.vertical?t.y:0,t}},{key:"_moveContent",value:function(e,t){var i=this._flattenVectorByDirection(e);eV.set(this.getContentPosition()),eV.add(i),eV.set(1e-4*Math.floor(1e4*eV.x),1e-4*Math.floor(1e4*eV.y),eV.z),this.setContentPosition(eV);var n=this._getHowMuchOutOfBoundary();this._updateScrollBar(n),this.elastic&&t&&this._startBounceBackIfNeeded()}},{key:"_getContentLeftBoundary",value:function(){return this.getContentPosition().x-this._content.anchorX*this._content.width}},{key:"_getContentRightBoundary",value:function(){return this._getContentLeftBoundary()+this._content.width}},{key:"_getContentTopBoundary",value:function(){return this._getContentBottomBoundary()+this._content.height}},{key:"_getContentBottomBoundary",value:function(){return this.getContentPosition().y-this._content.anchorY*this._content.height}},{key:"_getHowMuchOutOfBoundary",value:function(e){if((e=e||new Ii).equals($X,1e-4)&&!this._outOfBoundaryAmountDirty)return this._outOfBoundaryAmount;var t=new Ii;return this._getContentLeftBoundary()+e.x>this._leftBoundary?t.x=this._leftBoundary-(this._getContentLeftBoundary()+e.x):this._getContentRightBoundary()+e.x<this._rightBoundary&&(t.x=this._rightBoundary-(this._getContentRightBoundary()+e.x)),this._getContentTopBoundary()+e.y<this._topBoundary?t.y=this._topBoundary-(this._getContentTopBoundary()+e.y):this._getContentBottomBoundary()+e.y>this._bottomBoundary&&(t.y=this._bottomBoundary-(this._getContentBottomBoundary()+e.y)),e.equals($X,1e-4)&&(this._outOfBoundaryAmount=t,this._outOfBoundaryAmountDirty=!1),t=this._clampDelta(t)}},{key:"_updateScrollBar",value:function(e){this._horizontalScrollBar&&this._horizontalScrollBar.onScroll(e),this.verticalScrollBar&&this.verticalScrollBar.onScroll(e)}},{key:"_onScrollBarTouchBegan",value:function(){this._horizontalScrollBar&&this._horizontalScrollBar.onTouchBegan(),this.verticalScrollBar&&this.verticalScrollBar.onTouchBegan()}},{key:"_onScrollBarTouchEnded",value:function(){this._horizontalScrollBar&&this._horizontalScrollBar.onTouchEnded(),this.verticalScrollBar&&this.verticalScrollBar.onTouchEnded()}},{key:"_dispatchEvent",value:function(e){if(e===JX.SCROLL_ENDED)this._scrollEventEmitMask=0;else if(e===JX.SCROLL_TO_TOP||e===JX.SCROLL_TO_BOTTOM||e===JX.SCROLL_TO_LEFT||e===JX.SCROLL_TO_RIGHT){var t=1<<aV[e];if(this._scrollEventEmitMask&t)return;this._scrollEventEmitMask|=t}fO.emitEvents(this.scrollEvents,this,aV[e]),this.node.emit(e,this)}},{key:"_adjustContentOutOfBoundary",value:function(){if(this._content&&(this._outOfBoundaryAmountDirty=!0,this._isOutOfBoundary())){var e=this._getHowMuchOutOfBoundary();eV.set(this.getContentPosition()),eV.add(e),this._content&&(this._content.setPosition(eV),this._updateScrollBar($X))}}},{key:"_hideScrollBar",value:function(){this._horizontalScrollBar&&this._horizontalScrollBar.hide(),this._verticalScrollBar&&this._verticalScrollBar.hide()}},{key:"_showScrollBar",value:function(){this._horizontalScrollBar&&this._horizontalScrollBar.show(),this._verticalScrollBar&&this._verticalScrollBar.show()}},{key:"_stopPropagationIfTargetIsMe",value:function(e){e.eventPhase===al.AT_TARGET&&e.target===this.node&&(e.propagationStopped=!0)}},{key:"_processDeltaMove",value:function(e){this._scrollChildren(e),this._gatherTouchMove(e)}},{key:"_handleMoveLogic",value:function(e){this._deltaPos.set(this._getLocalAxisAlignDelta(e)),this._processDeltaMove(this._deltaPos)}},{key:"_handleReleaseLogic",value:function(e){this._deltaPos.set(this._getLocalAxisAlignDelta(e)),this._gatherTouchMove(this._deltaPos),this._processInertiaScroll(),this._scrolling&&(this._scrolling=!1,this._autoScrolling||this._dispatchEvent(JX.SCROLL_ENDED))}},{key:"_getLocalAxisAlignDelta",value:function(e){var t=this.node._uiProps.uiTransformComp,i=new Ii;return t&&(e.getUILocation(iV),e.getUIPreviousLocation(nV),eV.set(iV.x,iV.y,0),tV.set(nV.x,nV.y,0),t.convertToNodeSpaceAR(eV,eV),t.convertToNodeSpaceAR(tV,tV),Ii.subtract(i,eV,tV)),i}},{key:"_scrollChildren",value:function(e){var t,i,n=e=this._clampDelta(e);this.elastic&&(t=this._getHowMuchOutOfBoundary(),n.x*=0===t.x?1:.5,n.y*=0===t.y?1:.5),this.elastic||(t=this._getHowMuchOutOfBoundary(n),n.add(t));var r=this._content.position;if(n.y>0)r.y-this._content.anchorY*this._content.height+n.y>=this._bottomBoundary&&(i=JX.SCROLL_TO_BOTTOM);else if(n.y<0){r.y-this._content.anchorY*this._content.height+this._content.height+n.y<=this._topBoundary&&(i=JX.SCROLL_TO_TOP)}else if(n.x<0){r.x-this._content.anchorX*this._content.width+this._content.width+n.x<=this._rightBoundary&&(i=JX.SCROLL_TO_RIGHT)}else if(n.x>0){r.x-this._content.anchorX*this._content.width+n.x>=this._leftBoundary&&(i=JX.SCROLL_TO_LEFT)}this._moveContent(n,!1),0===n.x&&0===n.y||(this._scrolling||(this._scrolling=!0,this._dispatchEvent(JX.SCROLL_BEGAN)),this._dispatchEvent(JX.SCROLLING)),i&&i.length>0&&this._dispatchEvent(i)}},{key:"_handlePressLogic",value:function(){this._autoScrolling&&this._dispatchEvent(JX.SCROLL_ENDED),this._autoScrolling=!1,this._isBouncing=!1,this._touchMovePreviousTimestamp=rV(),this._touchMoveDisplacements.length=0,this._touchMoveTimeDeltas.length=0,this._onScrollBarTouchBegan()}},{key:"_clampDelta",value:function(e){var t=this._content._uiProps.uiTransformComp.contentSize,i=this.node._uiProps.uiTransformComp.contentSize;return t.width<i.width&&(e.x=0),t.height<i.height&&(e.y=0),e}},{key:"_gatherTouchMove",value:function(e){var t=e.clone();for(this._clampDelta(t);this._touchMoveDisplacements.length>=5;)this._touchMoveDisplacements.shift(),this._touchMoveTimeDeltas.shift();this._touchMoveDisplacements.push(t);var i=rV();this._touchMoveTimeDeltas.push((i-this._touchMovePreviousTimestamp)/1e3),this._touchMovePreviousTimestamp=i}},{key:"_startBounceBackIfNeeded",value:function(){if(!this.elastic)return!1;var e=this._getHowMuchOutOfBoundary();if((e=this._clampDelta(e)).equals($X,1e-4))return!1;var t=Math.max(this.bounceDuration,0);return this._startAutoScroll(e,t,!0),this._isBouncing||(e.y>0&&this._dispatchEvent(JX.BOUNCE_TOP),e.y<0&&this._dispatchEvent(JX.BOUNCE_BOTTOM),e.x>0&&this._dispatchEvent(JX.BOUNCE_RIGHT),e.x<0&&this._dispatchEvent(JX.BOUNCE_LEFT),this._isBouncing=!0),!0}},{key:"_processInertiaScroll",value:function(){if(!this._startBounceBackIfNeeded()&&this.inertia){var e=this._calculateTouchMoveVelocity();!e.equals(eV,1e-4)&&this.brake<1&&this._startInertiaScroll(e)}this._onScrollBarTouchEnded()}},{key:"_isOutOfBoundary",value:function(){return!this._getHowMuchOutOfBoundary().equals($X,1e-4)}},{key:"_isNecessaryAutoScrollBrake",value:function(){if(this._autoScrollBraking)return!0;if(this._isOutOfBoundary()){if(!this._autoScrollCurrentlyOutOfBoundary)return this._autoScrollCurrentlyOutOfBoundary=!0,this._autoScrollBraking=!0,this._autoScrollBrakingStartPosition=this.getContentPosition(),!0}else this._autoScrollCurrentlyOutOfBoundary=!1;return!1}},{key:"_processAutoScrolling",value:function(e){var t=this._isNecessaryAutoScrollBrake(),i=t?.05:1;this._autoScrollAccumulatedTime+=e*(1/i);var n,r=Math.min(1,this._autoScrollAccumulatedTime/this._autoScrollTotalTime);this._autoScrollAttenuate&&(n=r,r=(n-=1)*n*n*n*n+1);var a=new Ii(this._autoScrollTargetDelta);a.multiplyScalar(r);var o=new Ii(this._autoScrollStartPosition);o.add(a);var s=Math.abs(r-1)<=1e-4;if(Math.abs(r-1)<=this.getScrollEndedEventTiming()&&!this._isScrollEndedWithThresholdEventFired&&(this._dispatchEvent(JX.SCROLL_ENG_WITH_THRESHOLD),this._isScrollEndedWithThresholdEventFired=!0),this.elastic){var l=new Ii(o);l.subtract(this._autoScrollBrakingStartPosition),t&&l.multiplyScalar(i),o.set(this._autoScrollBrakingStartPosition),o.add(l)}else{var u=new Ii(o);u.subtract(this.getContentPosition());var c=this._getHowMuchOutOfBoundary(u);c.equals($X,1e-4)||(o.add(c),s=!0)}s&&(this._autoScrolling=!1);var h=new Ii(o);h.subtract(this.getContentPosition()),this._moveContent(this._clampDelta(h),s),this._dispatchEvent(JX.SCROLLING),this._autoScrolling||(this._isBouncing=!1,this._scrolling=!1,this._dispatchEvent(JX.SCROLL_ENDED))}},{key:"_checkMouseWheel",value:function(e){if(!this._getHowMuchOutOfBoundary().equals($X,1e-4))return this._processInertiaScroll(),this.unschedule(this._checkMouseWheel),void(this._stopMouseWheel=!1);this._mouseWheelEventElapsedTime+=e,this._mouseWheelEventElapsedTime>.1&&(this._onScrollBarTouchEnded(),this.unschedule(this._checkMouseWheel),this._stopMouseWheel=!1)}},{key:"_calculateMovePercentDelta",value:function(e){var t=e.anchor,i=e.applyToHorizontal,n=e.applyToVertical;this._calculateBoundary(),t.clampf(new ki(0,0),new ki(1,1));var r=this.node._uiProps.uiTransformComp.contentSize,a=this._content._uiProps.uiTransformComp.contentSize,o=this._getContentBottomBoundary()-this._bottomBoundary;o=-o;var s=this._getContentLeftBoundary()-this._leftBoundary;s=-s;var l=new Ii,u=0;return i&&(u=a.width-r.width,l.x=s-u*t.x),n&&(u=a.height-r.height,l.y=o-u*t.y),l}},{key:"_moveContentToTopLeft",value:function(e){var t=this._content._uiProps.uiTransformComp.contentSize,i=this._getContentBottomBoundary()-this._bottomBoundary;i=-i;var n=new Ii,r=0,a=this._getContentLeftBoundary()-this._leftBoundary;a=-a,t.height<e.height?(r=t.height-e.height,n.y=i-r,this.verticalScrollBar&&this.verticalScrollBar.hide()):this.verticalScrollBar&&this.verticalScrollBar.show(),t.width<e.width?(r=t.width-e.width,n.x=a,this._horizontalScrollBar&&this._horizontalScrollBar.hide()):this._horizontalScrollBar&&this._horizontalScrollBar.show(),this._moveContent(n),this._adjustContentOutOfBoundary()}},{key:"_scaleChanged",value:function(e){e===rh.SCALE&&this._calculateBoundary()}},{key:"content",get:function(){return this._content},set:function(e){this._content!==e&&(this._content=e,this._calculateBoundary())}},{key:"horizontalScrollBar",get:function(){return this._horizontalScrollBar},set:function(e){this._horizontalScrollBar!==e&&(this._horizontalScrollBar=e,this._horizontalScrollBar&&(this._horizontalScrollBar.setScrollView(this),this._updateScrollBar($X)))}},{key:"verticalScrollBar",get:function(){return this._verticalScrollBar},set:function(e){this._verticalScrollBar!==e&&(this._verticalScrollBar=e,this._verticalScrollBar&&(this._verticalScrollBar.setScrollView(this),this._updateScrollBar($X)))}},{key:"view",get:function(){return this._content?this._content.parent:null}}]),t}(),KX.EventType=JX,zX=de((NX=ZX).prototype,"bounceDuration",[wX],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return 1}}),BX=de(NX.prototype,"brake",[CX],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return.5}}),GX=de(NX.prototype,"elastic",[AX],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return!0}}),UX=de(NX.prototype,"inertia",[OX],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return!0}}),de(NX.prototype,"content",[kX],Object.getOwnPropertyDescriptor(NX.prototype,"content"),NX.prototype),XX=de(NX.prototype,"horizontal",[RX],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return!0}}),de(NX.prototype,"horizontalScrollBar",[FX],Object.getOwnPropertyDescriptor(NX.prototype,"horizontalScrollBar"),NX.prototype),VX=de(NX.prototype,"vertical",[MX],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return!0}}),de(NX.prototype,"verticalScrollBar",[IX],Object.getOwnPropertyDescriptor(NX.prototype,"verticalScrollBar"),NX.prototype),HX=de(NX.prototype,"cancelInnerEvents",[PX],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return!0}}),WX=de(NX.prototype,"scrollEvents",[LX],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return[]}}),jX=de(NX.prototype,"_content",[Ko],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return null}}),qX=de(NX.prototype,"_horizontalScrollBar",[Ko],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return null}}),YX=de(NX.prototype,"_verticalScrollBar",[Ko],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return null}}),DX=NX))||DX)||DX)||DX)||DX);cc.ScrollViewComponent=TV;var SV,EV=new Ii;!function(e){e[e.Horizontal=0]="Horizontal",e[e.Vertical=1]="Vertical"}(SV||(SV={})),bt(SV);var wV,CV,AV,OV,kV,RV,FV,MV,IV,PV,LV=(oV=Yo("cc.SliderComponent"),sV=os("i18n:cc.SliderComponent"),lV=ts(110),uV=es("UI/Slider"),cV=Ko({type:LA,tooltip:"滑块按钮部件"}),hV=Ko({type:SV,tooltip:"滑动方向"}),pV=Ko({slide:!0,range:[0,1,.01],tooltip:"当前进度值，该数值的区间是 0 - 1 之间。"}),_V=Ko({type:fO,tooltip:"滑动器组件事件回调函数"}),oV(fV=sV(fV=lV(fV=uV((bV=xV=function(e){function t(){var e,i;Z(this,t);for(var n=arguments.length,r=new Array(n),a=0;a<n;a++)r[a]=arguments[a];return fe(i=re(this,(e=te(t)).call.apply(e,[this].concat(r))),"slideEvents",mV,ne(i)),fe(i,"_handle",vV,ne(i)),fe(i,"_direction",yV,ne(i)),fe(i,"_progress",gV,ne(i)),i._offset=new Ii,i._dragging=!1,i._touchHandle=!1,i._handlelocalPos=new Ii,i._touchPos=new Ii,i}return ee(t,rp),J(t,[{key:"__preload",value:function(){this._updateHandlePosition()}},{key:"onEnable",value:function(){this._updateHandlePosition(),this.node.on(exports.SystemEventType.TOUCH_START,this._onTouchBegan,this),this.node.on(exports.SystemEventType.TOUCH_MOVE,this._onTouchMoved,this),this.node.on(exports.SystemEventType.TOUCH_END,this._onTouchEnded,this),this.node.on(exports.SystemEventType.TOUCH_CANCEL,this._onTouchCancelled,this),this._handle&&this._handle.isValid&&(this._handle.node.on(exports.SystemEventType.TOUCH_START,this._onHandleDragStart,this),this._handle.node.on(exports.SystemEventType.TOUCH_MOVE,this._onTouchMoved,this),this._handle.node.on(exports.SystemEventType.TOUCH_END,this._onTouchEnded,this))}},{key:"onDisable",value:function(){this.node.off(exports.SystemEventType.TOUCH_START,this._onTouchBegan,this),this.node.off(exports.SystemEventType.TOUCH_MOVE,this._onTouchMoved,this),this.node.off(exports.SystemEventType.TOUCH_END,this._onTouchEnded,this),this.node.off(exports.SystemEventType.TOUCH_CANCEL,this._onTouchCancelled,this),this._handle&&this._handle.isValid&&(this._handle.node.off(exports.SystemEventType.TOUCH_START,this._onHandleDragStart,this),this._handle.node.off(exports.SystemEventType.TOUCH_MOVE,this._onTouchMoved,this),this._handle.node.off(exports.SystemEventType.TOUCH_END,this._onTouchEnded,this))}},{key:"_onHandleDragStart",value:function(e){if(e&&this._handle&&this._handle.node._uiProps.uiTransformComp){this._dragging=!0,this._touchHandle=!0;var t=e.touch.getUILocation();Ii.set(this._touchPos,t.x,t.y,0),this._handle.node._uiProps.uiTransformComp.convertToNodeSpaceAR(this._touchPos,this._offset),e.propagationStopped=!0}}},{key:"_onTouchBegan",value:function(e){this._handle&&e&&(this._dragging=!0,this._touchHandle||this._handleSliderLogic(e.touch),e.propagationStopped=!0)}},{key:"_onTouchMoved",value:function(e){this._dragging&&e&&(this._handleSliderLogic(e.touch),e.propagationStopped=!0)}},{key:"_onTouchEnded",value:function(e){this._dragging=!1,this._touchHandle=!1,this._offset=new Ii,e&&(e.propagationStopped=!0)}},{key:"_onTouchCancelled",value:function(e){this._dragging=!1,e&&(e.propagationStopped=!0)}},{key:"_handleSliderLogic",value:function(e){this._updateProgress(e),this._emitSlideEvent()}},{key:"_emitSlideEvent",value:function(){fO.emitEvents(this.slideEvents,this),this.node.emit("slide",this)}},{key:"_updateProgress",value:function(e){if(this._handle&&e){var t=e.getUILocation();Ii.set(this._touchPos,t.x,t.y,0);var i=this.node._uiProps.uiTransformComp.convertToNodeSpaceAR(this._touchPos,EV);this.direction===SV.Horizontal?this.progress=_i(.5+(i.x-this._offset.x)/this.node.width):this.progress=_i(.5+(i.y-this._offset.y)/this.node.height)}}},{key:"_updateHandlePosition",value:function(){this._handle&&(this._handlelocalPos.set(this._handle.node.getPosition()),this._direction===SV.Horizontal?this._handlelocalPos.x=-this.node.width*this.node.anchorX+this.progress*this.node.width:this._handlelocalPos.y=-this.node.height*this.node.anchorY+this.progress*this.node.height,this._handle.node.setPosition(this._handlelocalPos))}},{key:"_changeLayout",value:function(){var e=this.node.getContentSize();if(this.node.setContentSize(e.height,e.width),this._handle){var t=this._handle.node.position;this._direction===SV.Horizontal?this._handle.node.setPosition(t.x,0,t.z):this._handle.node.setPosition(0,t.y,t.z),this._updateHandlePosition()}}},{key:"handle",get:function(){return this._handle},set:function(e){this._handle!==e&&(this._handle=e)}},{key:"direction",get:function(){return this._direction},set:function(e){this._direction!==e&&(this._direction=e,this._changeLayout())}},{key:"progress",get:function(){return this._progress},set:function(e){this._progress!==e&&(this._progress=e,this._updateHandlePosition())}}]),t}(),xV.Direction=SV,de((dV=bV).prototype,"handle",[cV],Object.getOwnPropertyDescriptor(dV.prototype,"handle"),dV.prototype),de(dV.prototype,"direction",[hV],Object.getOwnPropertyDescriptor(dV.prototype,"direction"),dV.prototype),de(dV.prototype,"progress",[pV],Object.getOwnPropertyDescriptor(dV.prototype,"progress"),dV.prototype),mV=de(dV.prototype,"slideEvents",[_V],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return[]}}),vV=de(dV.prototype,"_handle",[Ko],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return null}}),yV=de(dV.prototype,"_direction",[Ko],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return SV.Horizontal}}),gV=de(dV.prototype,"_progress",[Ko],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return.1}}),fV=dV))||fV)||fV)||fV)||fV);cc.SliderComponent=LV;var DV,NV,zV,BV,GV,UV,XV,VV,HV,WV,jV,qV,YV,KV,ZV,QV,JV,$V,eH=(wV=Yo("cc.ToggleContainerComponent"),CV=os("i18n:cc.ToggleContainerComponent"),AV=ts(110),OV=es("UI/ToggleContainer"),kV=Ko({type:[fO],tooltip:"选中事件。列表类型，默认为空，用户添加的每一个事件由节点引用，组件名称和一个响应函数组成。"}),RV=Ko({tooltip:"如果这个设置为 true， 那么 toggle 按钮在被点击的时候可以反复地被选中和未选中。"}),wV(FV=CV(FV=AV(FV=OV(FV=Jo((IV=de((MV=function(e){function t(){var e,i;Z(this,t);for(var n=arguments.length,r=new Array(n),a=0;a<n;a++)r[a]=arguments[a];return fe(i=re(this,(e=te(t)).call.apply(e,[this].concat(r))),"checkEvents",IV,ne(i)),fe(i,"_allowSwitchOff",PV,ne(i)),i._toggleItems=[],i}return ee(t,rp),J(t,[{key:"start",value:function(){this._makeAtLeastOneToggleChecked()}},{key:"updateToggles",value:function(e){this.enabledInHierarchy&&e.isChecked&&(this.toggleItems.forEach((function(t){t!==e&&t.isChecked&&t.enabled&&(t.isChecked=!1)})),this.checkEvents&&fO.emitEvents(this.checkEvents,e))}},{key:"addToggle",value:function(e){-1===this._toggleItems.indexOf(e)&&this._toggleItems.push(e),this._allowOnlyOneToggleChecked()}},{key:"removeToggle",value:function(e){var t=this._toggleItems.indexOf(e);t>-1&&this._toggleItems.splice(t,1),this._makeAtLeastOneToggleChecked()}},{key:"_allowOnlyOneToggleChecked",value:function(){var e=!1;return this._toggleItems.forEach((function(t){e&&t.enabled&&(t.isChecked=!1),t.isChecked&&t.enabled&&(e=!0)})),e}},{key:"_makeAtLeastOneToggleChecked",value:function(){this._allowOnlyOneToggleChecked()||this._allowSwitchOff||this._toggleItems.length>0&&(this._toggleItems[0].isChecked=!0)}},{key:"allowSwitchOff",get:function(){return this._allowSwitchOff},set:function(e){this._allowSwitchOff=e}},{key:"toggleItems",get:function(){return this._toggleItems}}]),t}()).prototype,"checkEvents",[kV],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return[]}}),PV=de(MV.prototype,"_allowSwitchOff",[Ko],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return!1}}),de(MV.prototype,"allowSwitchOff",[RV],Object.getOwnPropertyDescriptor(MV.prototype,"allowSwitchOff"),MV.prototype),FV=MV))||FV)||FV)||FV)||FV)||FV);function tH(){for(var e=arguments.length,t=new Array(e),i=0;i<e;i++)t[i]=arguments[i];return Object.assign.apply(Object,[{}].concat(t))}cc.ToggleContainerComponent=eH,($V||($V={})).TOGGLE="toggle";var iH,nH=(DV=Yo("cc.ToggleComponent"),NV=os("i18n:cc.ToggleComponent"),zV=ts(110),BV=es("UI/Toggle"),GV=$o(Iy),UV=Ko({tooltip:"如果这个设置为 true，则 check mark 组件会处于 enabled 状态，否则处于 disabled 状态。",displayOrder:2}),XV=Ko({type:LA,tooltip:"Toggle 处于选中状态时显示的精灵图片",displayOrder:3}),VV=Ko({type:eH,tooltip:"Toggle 所属的 ToggleGroup，这个属性是可选的。如果这个属性为 null，则 Toggle 是一个 CheckBox，否则，Toggle 是一个 RadioButton。",displayOrder:4}),HV=Ko({type:[fO],tooltip:"列表类型，默认为空，用户添加的每一个事件由节点引用，组件名称和一个响应函数组成"}),DV(WV=NV(WV=zV(WV=BV(WV=GV((JV=QV=function(e){function t(){var e,i;Z(this,t);for(var n=arguments.length,r=new Array(n),a=0;a<n;a++)r[a]=arguments[a];return fe(i=re(this,(e=te(t)).call.apply(e,[this].concat(r))),"checkEvents",qV,ne(i)),fe(i,"_isChecked",YV,ne(i)),fe(i,"_toggleGroup",KV,ne(i)),fe(i,"_checkMark",ZV,ne(i)),i}return ee(t,_N),J(t,[{key:"onEnable",value:function(){oe(te(t.prototype),"onEnable",this).call(this),this._registerToggleEvent(),this._toggleGroup&&this._toggleGroup.enabled&&this._toggleGroup.addToggle(this)}},{key:"onDisable",value:function(){oe(te(t.prototype),"onDisable",this).call(this),this._unregisterToggleEvent(),this._toggleGroup&&this._toggleGroup.enabled&&this._toggleGroup.removeToggle(this)}},{key:"toggle",value:function(){var e=this.toggleGroup||this._toggleContainer;e&&e.enabled&&this.isChecked&&!e.allowSwitchOff||(this.isChecked=!this.isChecked,e&&e.enabled&&e.updateToggles(this),this._emitToggleEvents())}},{key:"check",value:function(){var e=this.toggleGroup||this._toggleContainer;e&&e.enabled&&this.isChecked&&!e.allowSwitchOff||(this.isChecked=!0,e&&e.enabled&&e.updateToggles(this),this._emitToggleEvents())}},{key:"uncheck",value:function(){var e=this.toggleGroup||this._toggleContainer;e&&e.enabled&&this.isChecked&&!e.allowSwitchOff||(this.isChecked=!1,this._emitToggleEvents())}},{key:"_updateCheckMark",value:function(){this._checkMark&&(this._checkMark.node.active=!!this.isChecked)}},{key:"_registerToggleEvent",value:function(){this.node.on(t.EventType.CLICK,this.toggle,this)}},{key:"_unregisterToggleEvent",value:function(){this.node.off(t.EventType.CLICK,this.toggle,this)}},{key:"_emitToggleEvents",value:function(){this.node.emit(t.EventType.TOGGLE,this),this.checkEvents&&fO.emitEvents(this.checkEvents,this)}},{key:"isChecked",get:function(){return this._isChecked},set:function(e){this._isChecked!==e&&(this._isChecked=e,this._updateCheckMark())}},{key:"checkMark",get:function(){return this._checkMark},set:function(e){this._checkMark!==e&&(this._checkMark=e)}},{key:"toggleGroup",get:function(){return this._toggleGroup},set:function(e){this._toggleGroup!==e&&(this._toggleGroup&&this._toggleGroup.removeToggle(this),this._toggleGroup=e,this._toggleGroup&&this._toggleGroup.enabled&&this._toggleGroup.addToggle(this))}},{key:"_resizeToTarget",set:function(e){e&&this._resizeNodeToTargetNode()}},{key:"_toggleContainer",get:function(){this.node.parent;return null}}]),t}(),QV.EventType=tH($V,hN),de((jV=JV).prototype,"isChecked",[UV],Object.getOwnPropertyDescriptor(jV.prototype,"isChecked"),jV.prototype),de(jV.prototype,"checkMark",[XV],Object.getOwnPropertyDescriptor(jV.prototype,"checkMark"),jV.prototype),de(jV.prototype,"toggleGroup",[VV],Object.getOwnPropertyDescriptor(jV.prototype,"toggleGroup"),jV.prototype),qV=de(jV.prototype,"checkEvents",[HV],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return[]}}),YV=de(jV.prototype,"_isChecked",[Ko],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return!0}}),KV=de(jV.prototype,"_toggleGroup",[Ko],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return null}}),ZV=de(jV.prototype,"_checkMark",[Ko],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return null}}),WV=jV))||WV)||WV)||WV)||WV)||WV);cc.ToggleComponent=nH;var rH,aH,oH,sH=Yo("cc.UIModelComponent")(iH=os("i18n:cc.UIModelComponent")(iH=ts(110)(iH=es("UI/Model")(iH=function(e){function t(){var e,i;Z(this,t);for(var n=arguments.length,r=new Array(n),a=0;a<n;a++)r[a]=arguments[a];return(i=re(this,(e=te(t)).call.apply(e,[this].concat(r))))._models=null,i._modelComponent=null,i}return ee(t,jC),J(t,[{key:"onLoad",value:function(){this.node._uiProps.uiTransformComp||this.node.addComponent("cc.UITransformComponent"),this._modelComponent=this.getComponent("cc.RenderableComponent"),this._modelComponent?(this._modelComponent._sceneGetter=_O.root.ui.getRenderSceneGetter(),this._models=this._modelComponent._collectModels()):console.warn("node '".concat(this.node&&this.node.name,"' doesn't have any renderable component"))}},{key:"onEnable",value:function(){oe(te(t.prototype),"onEnable",this).call(this),this._modelComponent&&this._modelComponent._attachToScene()}},{key:"onDisable",value:function(){oe(te(t.prototype),"onDisable",this).call(this),this._modelComponent&&this._modelComponent._detachFromScene()}},{key:"onDestroy",value:function(){oe(te(t.prototype),"onDestroy",this).call(this),this._modelComponent=this.getComponent("cc.RenderableComponent"),this._modelComponent&&(this._modelComponent._sceneGetter=null,cc.isValid(this._modelComponent,!0)&&this._modelComponent._attachToScene(),this._models=null)}},{key:"updateAssembler",value:function(e){if(this._models){for(var t,i=_e(this._models);!(t=i()).done;){var n=t.value;e.commitModel.call(e,this,n,this._modelComponent.material)}return!0}return!1}},{key:"update",value:function(){this._fitUIRenderQueue()}},{key:"_fitUIRenderQueue",value:function(){if(this._modelComponent){for(var e=this._modelComponent.sharedMaterials.length,t=0;t<e;t++){var i=this._modelComponent.getMaterialInstance(t);if(null!=i)for(var n=i.passes,r=i.effectAsset,a=i.technique,o=n.length,s=0;s<o;s++){if(!n[s].blendState.targets[0].blend)n[s].blendState.targets[0].blend=!0,n[s].overridePipelineStates(r.techniques[a].passes[s],{blendState:n[s].blendState})}}for(var l=0;l<e;l++){var u=this._modelComponent.getMaterialInstance(l);if(null!=u)for(var c,h=_e(u.passes);!(c=h()).done;){c.value._priority=Su.MAX-11}}}}},{key:"modelComponent",get:function(){return this._modelComponent}}]),t}())||iH)||iH)||iH)||iH;cc.UIModelComponent=sH;var lH,uH=new Ki;!function(e){e[e.LOADING=0]="LOADING",e[e.LOADED=1]="LOADED",e[e.ERROR=2]="ERROR",e[e.JS_EVALUATED=3]="JS_EVALUATED"}(lH||(lH={}));var cH={devicePixelRatio:!1,enableDiv:!1};Cs.os===Cs.OS_IOS&&(cH.enableDiv=!0),Cs.isMobile?Cs.browserType===Cs.BROWSER_TYPE_FIREFOX&&(cH.enableBG=!0):Cs.browserType===Cs.BROWSER_TYPE_IE&&(cH.closeHistory=!0);var hH,pH,_H,fH,dH,mH,vH,yH,gH,xH,bH,TH,SH=Yo("cc.WebviewImpl")((oH=aH=function(){function e(){Z(this,e),this._EventList=new Map,this._visible=!1,this._div=null,this._iframe=null,this._forceUpdate=!0,this._m00=0,this._m01=0,this._m04=0,this._m05=0,this._m12=0,this._m13=0,this._w=0,this._h=0,this._eventListeners={load:function(){},error:function(){}}}return J(e,[{key:"createDomElementIfNeeded",value:function(e,t){this._div?this._updateSize(e,t):this._createNativeControl(e,t)}},{key:"removeDom",value:function(){var e=this._div;e&&(pt(cc.game.container,e)&&cc.game.container.removeChild(e),this._div=null);var t=this._iframe;if(t){var i=this._eventListeners;t.removeEventListener("load",i.load),t.removeEventListener("error",i.error),i.load=null,i.error=null,this._iframe=null}}},{key:"loadURL",value:function(t){var i=this._iframe;if(i){i.src=t;var n=this;i.addEventListener("load",(function e(){n._updateVisibility(),i.removeEventListener("load",e)})),this._dispatchEvent(e.EventType.LOADING)}}},{key:"stopLoading",value:function(){v(7800)}},{key:"reload",value:function(){var e=this._iframe;if(e){var t=e.contentWindow;t&&t.location&&t.location.reload()}}},{key:"canGoBack",value:function(){return v(7801),!0}},{key:"canGoForward",value:function(){return v(7802),!0}},{key:"goBack",value:function(){try{if(e.Polyfill.closeHistory)return v(7803);var t=this._iframe;if(t){var i=t.contentWindow;i&&i.location&&i.history.back.call(i)}}catch(e){u(e)}}},{key:"goForward",value:function(){try{if(e.Polyfill.closeHistory)return v(7804);var t=this._iframe;if(t){var i=t.contentWindow;i&&i.location&&i.history.forward.call(i)}}catch(e){u(e)}}},{key:"evaluateJS",value:function(e){var t=this._iframe;if(t)t.contentWindow}},{key:"setScalesPageToFit",value:function(){v(7805)}},{key:"setEventListener",value:function(e,t){this._EventList[e]=t}},{key:"removeEventListener",value:function(e){this._EventList[e]=null}},{key:"_dispatchEvent",value:function(e){var t=this._EventList[e];t&&this._iframe&&t.call(this,this,this._iframe.src)}},{key:"destroy",value:function(){this.removeDom()}},{key:"setVisible",value:function(e){this._visible!==e&&(this._visible=!!e,this._updateVisibility())}},{key:"updateMatrix",value:function(e){if(this._div&&this._visible){e.getWorldMatrix(uH);var t=e.getContentSize();if(this._forceUpdate||this._m00!==uH.m00||this._m01!==uH.m01||this._m04!==uH.m04||this._m05!==uH.m05||this._m12!==uH.m12||this._m13!==uH.m13||this._w!==t.width||this._h!==t.height){this._m00=uH.m00,this._m01=uH.m01,this._m04=uH.m04,this._m05=uH.m05,this._m12=uH.m12,this._m13=uH.m13,this._w=t.width,this._h=t.height;var i=nE.getScaleX(),n=nE.getScaleY(),r=nE.getDevicePixelRatio();i/=r,n/=r;var a=cc.game.container,o=uH.m00*i,s=uH.m01,l=uH.m04,u=uH.m05*n,c=a&&a.style.paddingLeft?parseInt(a.style.paddingLeft):0,h=a&&a.style.paddingBottom?parseInt(a.style.paddingBottom):0;this._updateSize(this._w,this._h);var p=this._div.clientWidth*i,_=this._div.clientHeight*n,f=e.getAnchorPoint(),d=p*uH.m00*f.x,m=_*uH.m05*f.y,v="matrix("+o+","+-s+","+-l+","+u+","+(uH.m12*i-d+c)+","+-(uH.m13*n-m+h)+")";this._div.style.transform=v,this._div.style["-webkit-transform"]=v,this._div.style["transform-origin"]="0px 100% 0px",this._div.style["-webkit-transform-origin"]="0px 100% 0px";var y=e.getComponent(wA);y&&this._setOpacity(y.color.a)}}}},{key:"setOnJSCallback",value:function(e){}},{key:"setJavascriptInterfaceScheme",value:function(e){}},{key:"loadData",value:function(e,t,i,n){}},{key:"loadHTMLString",value:function(e,t){}},{key:"_updateVisibility",value:function(){if(this._div){var e=this._div;this._visible?e.style.visibility="visible":e.style.visibility="hidden",this._forceUpdate=!0}}},{key:"_updateSize",value:function(e,t){var i=this._div;i&&(i.style.width=e+"px",i.style.height=t+"px")}},{key:"_initEvent",value:function(){var t=this._iframe;if(t){var i=this._eventListeners,n=this;i.load=function(){n._dispatchEvent(e.EventType.LOADED)},i.error=function(){n._dispatchEvent(e.EventType.ERROR)},t.addEventListener("load",i.load),t.addEventListener("error",i.error)}}},{key:"_initStyle",value:function(){if(this._div){var e=this._div;e.style.position="absolute",e.style.bottom="0px",e.style.left="0px"}}},{key:"_setOpacity",value:function(e){var t=this._iframe;t&&t.style&&(t.style.opacity=(e/255).toString())}},{key:"_createDom",value:function(t,i){e.Polyfill.enableDiv?(this._div=document.createElement("div"),this._div.style["-webkit-overflow"]="auto",this._div.style["-webkit-overflow-scrolling"]="touch",this._iframe=document.createElement("iframe"),this._div.appendChild(this._iframe),this._iframe.style.width="100%",this._iframe.style.height="100%"):this._div=this._iframe=document.createElement("iframe"),e.Polyfill.enableBG&&(this._div.style.background="#FFF"),this._div.style.background="#FFF",this._div.style.height=i+"px",this._div.style.width=t+"px",this._div.style.overflow="scroll",this._iframe.style.border="none",cc.game.container.appendChild(this._div),this._updateVisibility()}},{key:"_createNativeControl",value:function(e,t){this._createDom(e,t),this._initStyle(),this._initEvent()}}]),e}(),aH.Polyfill=cH,aH.EventType=lH,rH=oH))||rH,EH=lH;function wH(){}var CH,AH,OH,kH,RH,FH,MH,IH,PH,LH,DH,NH,zH,BH,GH,UH,XH,VH,HH,WH,jH,qH,YH,KH,ZH,QH,JH,$H,eW,tW,iW,nW,rW,aW,oW,sW,lW,uW,cW=(hH=Yo("cc.WebviewComponent"),pH=os("i18n:cc.WebviewComponent"),_H=es("UI/WebView"),fH=ts(100),dH=Ko({tooltip:"指定 WebView 加载的网址，它应该是一个 http 或者 https 开头的字符串"}),mH=Ko({type:fO,tooltip:"WebView 的回调事件，当网页加载过程中，加载完成后或者加载出错时都会回调此函数"}),hH(vH=pH(vH=_H(vH=fH((TH=bH=function(e){function t(){var e;return Z(this,t),fe(e=re(this,te(t).call(this)),"webviewEvents",gH,ne(e)),fe(e,"_url",xH,ne(e)),e._impl=null,e._impl=new SH,e}return ee(t,jC),J(t,[{key:"url",get:function(){return this._url},set:function(e){this._url=e;var t=this._impl;t&&t.loadURL(e)}}]),J(t,[{key:"onRestore",value:function(){this._impl||(this._impl=new SH)}},{key:"onEnable",value:function(){if(this._impl){var e=this._impl;e.createDomElementIfNeeded(this.node.width,this.node.height),e.loadURL(this._url),e.setVisible(!0),e.setEventListener(EH.LOADED,this._onWebViewLoaded.bind(this)),e.setEventListener(EH.LOADING,this._onWebViewLoading.bind(this)),e.setEventListener(EH.ERROR,this._onWebViewLoadError.bind(this))}}},{key:"onDisable",value:function(){if(this._impl){var e=this._impl;e.setVisible(!1),e.setEventListener(EH.LOADED,wH),e.setEventListener(EH.LOADING,wH),e.setEventListener(EH.ERROR,wH)}}},{key:"onDestroy",value:function(){this._impl&&(this._impl.destroy(),this._impl=null)}},{key:"update",value:function(e){this._impl&&this._impl.updateMatrix(this.node)}},{key:"setJavascriptInterfaceScheme",value:function(e){this._impl&&this._impl.setJavascriptInterfaceScheme(e)}},{key:"setOnJSCallback",value:function(e){this._impl&&this._impl.setOnJSCallback(e)}},{key:"evaluateJS",value:function(e){this._impl&&this._impl.evaluateJS(e)}},{key:"_onWebViewLoaded",value:function(){fO.emitEvents(this.webviewEvents,this,EH.LOADED),this.node.emit("loaded",this)}},{key:"_onWebViewLoading",value:function(){return fO.emitEvents(this.webviewEvents,this,EH.LOADING),this.node.emit("loading",this),!0}},{key:"_onWebViewLoadError",value:function(){fO.emitEvents(this.webviewEvents,this,EH.ERROR),this.node.emit("error",this)}}]),t}(),bH.EventType=EH,de((yH=TH).prototype,"url",[dH],Object.getOwnPropertyDescriptor(yH.prototype,"url"),yH.prototype),gH=de(yH.prototype,"webviewEvents",[mH],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return[]}}),xH=de(yH.prototype,"_url",[Ko],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return""}}),vH=yH))||vH)||vH)||vH)||vH);cc.WebviewComponent=cW;var hW,pW,_W=new Ii;function fW(e){return e instanceof $g?KT:e.getContentSize()}function dW(e,t,i,n){for(var r=e.parent?e.parent.getScale():_W,a=r.x,o=r.y,s=0,l=0,u=e.parent;;){if(!u)return i.x=i.y=0,void(n.x=n.y=1);var c=u.getPosition();if(s+=c.x,l+=c.y,(u=u.parent)===t)break;var h=(r=u?u.getScale():_W).x,p=r.y;s*=h,l*=p,a*=h,o*=p}n.x=0!==a?1/a:1,n.y=0!==o?1/o:1,i.x=-s,i.y=-l}!function(e){e[e.ONCE=0]="ONCE",e[e.ALWAYS=1]="ALWAYS",e[e.ON_WINDOW_RESIZE=2]="ON_WINDOW_RESIZE"}(hW||(hW={})),bt(hW),function(e){e[e.TOP=1]="TOP",e[e.MID=2]="MID",e[e.BOT=4]="BOT",e[e.LEFT=8]="LEFT",e[e.CENTER=16]="CENTER",e[e.RIGHT=32]="RIGHT",e[e.HORIZONTAL=56]="HORIZONTAL",e[e.VERTICAL=7]="VERTICAL"}(pW||(pW={}));var mW,vW=pW.TOP|pW.BOT,yW=pW.LEFT|pW.RIGHT;exports.WidgetComponent=(CH=Yo("cc.WidgetComponent"),AH=os("i18n:cc.WidgetComponent"),OH=ts(110),kH=es("UI/Widget"),RH=$o(Iy),FH=Ko({type:tg,tooltip:"对齐目标"}),MH=Ko({tooltip:"是否对齐上边"}),IH=Ko({tooltip:"是否对齐下边"}),PH=Ko({tooltip:"是否对齐左边"}),LH=Ko({tooltip:"是否对齐右边"}),DH=Ko({tooltip:"是否垂直方向对齐中点，开启此项会将垂直方向其他对齐选项取消"}),NH=Ko({tooltip:"是否水平方向对齐中点，开启此选项会将水平方向其他对齐选项取消"}),zH=Ko({visible:!1}),BH=Ko({visible:!1}),GH=Ko({type:hW,tooltip:"指定 widget 的对齐方式，用于决定运行时 widget 应何时更新"}),UH=Ko({editorOnly:!0}),CH(XH=AH(XH=OH(XH=kH(XH=RH(XH=Jo((uW=lW=function(e){function t(){var e,i;Z(this,t);for(var n=arguments.length,r=new Array(n),a=0;a<n;a++)r[a]=arguments[a];return(i=re(this,(e=te(t)).call.apply(e,[this].concat(r))))._lastPos=new Ii,i._lastSize=new en,i._dirty=!0,fe(i,"_alignFlags",HH,ne(i)),fe(i,"_target",WH,ne(i)),fe(i,"_left",jH,ne(i)),fe(i,"_right",qH,ne(i)),fe(i,"_top",YH,ne(i)),fe(i,"_bottom",KH,ne(i)),fe(i,"_horizontalCenter",ZH,ne(i)),fe(i,"_verticalCenter",QH,ne(i)),fe(i,"_isAbsLeft",JH,ne(i)),fe(i,"_isAbsRight",$H,ne(i)),fe(i,"_isAbsTop",eW,ne(i)),fe(i,"_isAbsBottom",tW,ne(i)),fe(i,"_isAbsHorizontalCenter",iW,ne(i)),fe(i,"_isAbsVerticalCenter",nW,ne(i)),fe(i,"_originalWidth",rW,ne(i)),fe(i,"_originalHeight",aW,ne(i)),fe(i,"_alignMode",oW,ne(i)),fe(i,"_lockFlags",sW,ne(i)),i}return ee(t,rp),J(t,[{key:"updateAlignment",value:function(){cc._widgetManager.updateAlignment(this.node)}},{key:"_validateTargetInDEV",value:function(){}},{key:"setDirty",value:function(){this._recursiveDirty()}},{key:"onEnable",value:function(){this.node.getPosition(this._lastPos),this.node.getContentSize(this._lastSize),cc._widgetManager.add(this),this._registerEvent(),this._registerTargetEvents()}},{key:"onDisable",value:function(){cc._widgetManager.remove(this),this._unregisterEvent(),this._unregisterTargetEvents()}},{key:"onDestroy",value:function(){this._removeParentEvent()}},{key:"_adjustWidgetToAllowMovingInEditor",value:function(e){if(e&rh.POSITION&&!cc._widgetManager.isAligning){var t=this.node.getPosition(),i=this._lastPos,n=new Ii(t);n.subtract(i);var r=this.node.parent,a=new Ii(1,1,1);if(this.target&&(r=this.target,dW(this.node,r,new Ii,a)),r){var o=fW(r),s=new Ii;0!==o.width&&0!==o.height&&Ii.set(s,n.x/o.width,n.y/o.height,s.z),this.isAlignTop&&(this._top-=(this._isAbsTop?n.y:s.y)*a.y),this.isAlignBottom&&(this._bottom+=(this._isAbsBottom?n.y:s.y)*a.y),this.isAlignLeft&&(this._left+=(this._isAbsLeft?n.x:s.x)*a.x),this.isAlignRight&&(this._right-=(this._isAbsRight?n.x:s.x)*a.x),this.isAlignHorizontalCenter&&(this._horizontalCenter+=(this._isAbsHorizontalCenter?n.x:s.x)*a.x),this.isAlignVerticalCenter&&(this._verticalCenter+=(this._isAbsVerticalCenter?n.y:s.y)*a.y),this._recursiveDirty()}}}},{key:"_adjustWidgetToAllowResizingInEditor",value:function(){if(!cc._widgetManager.isAligning){this.setDirty();var e=this.node.getContentSize(),t=this._lastSize,i=new Ii(e.width-t.width,e.height-t.height,0),n=this.node.parent,r=new Ii(1,1,1);if(this.target&&(n=this.target,dW(this.node,n,new Ii,r)),n){var a=fW(n),o=new Ii;0!==a.width&&0!==a.height&&Ii.set(o,i.x/a.width,i.y/a.height,o.z);var s=this.node.getAnchorPoint();this.isAlignTop&&(this._top-=(this._isAbsTop?i.y:o.y)*(1-s.y)*r.y),this.isAlignBottom&&(this._bottom-=(this._isAbsBottom?i.y:o.y)*s.y*r.y),this.isAlignLeft&&(this._left-=(this._isAbsLeft?i.x:o.x)*s.x*r.x),this.isAlignRight&&(this._right-=(this._isAbsRight?i.x:o.x)*(1-s.x)*r.x),this._recursiveDirty()}}}},{key:"_adjustWidgetToAnchorChanged",value:function(){this.setDirty()}},{key:"_adjustTargetToParentChanged",value:function(e){e&&this._unregisterOldParentEvents(e),this.node.getParent()&&this._registerTargetEvents()}},{key:"_registerEvent",value:function(){this.node.on(exports.SystemEventType.TRANSFORM_CHANGED,this._adjustWidgetToAllowMovingInEditor,this),this.node.on(exports.SystemEventType.SIZE_CHANGED,this._adjustWidgetToAllowResizingInEditor,this),this.node.on(exports.SystemEventType.ANCHOR_CHANGED,this._adjustWidgetToAnchorChanged,this),this.node.on(exports.SystemEventType.PARENT_CHANGED,this._adjustTargetToParentChanged,this)}},{key:"_unregisterEvent",value:function(){this.node.off(exports.SystemEventType.TRANSFORM_CHANGED,this._adjustWidgetToAllowMovingInEditor,this),this.node.off(exports.SystemEventType.SIZE_CHANGED,this._adjustWidgetToAllowResizingInEditor,this),this.node.off(exports.SystemEventType.ANCHOR_CHANGED,this._adjustWidgetToAnchorChanged,this)}},{key:"_removeParentEvent",value:function(){this.node.off(exports.SystemEventType.PARENT_CHANGED,this._adjustTargetToParentChanged,this)}},{key:"_autoChangedValue",value:function(e,t){if((this._alignFlags&e)>0&&this.node.parent&&this.node.parent._uiProps.uiTransformComp){var i=this.node.parent.getContentSize();this.isAlignLeft&&e===pW.LEFT?this._left=t?this._left*i.width:this._left/i.width:this.isAlignRight&&e===pW.RIGHT?this._right=t?this._right*i.width:this._right/i.width:this.isAlignHorizontalCenter&&e===pW.CENTER?this._horizontalCenter=t?this._horizontalCenter*i.width:this._horizontalCenter/i.width:this.isAlignTop&&e===pW.TOP?this._top=t?this._top*i.height:this._top/i.height:this.isAlignBottom&&e===pW.BOT?this._bottom=t?this._bottom*i.height:this._bottom/i.height:this.isAbsoluteVerticalCenter&&e===pW.MID&&(this._verticalCenter=this._verticalCenter/i.height),this._recursiveDirty()}}},{key:"_registerTargetEvents",value:function(){var e=this._target||this.node.parent;e&&(e.getComponent(Iy)?(e.on(exports.SystemEventType.TRANSFORM_CHANGED,this._targetChangedOperation,this),e.on(exports.SystemEventType.SIZE_CHANGED,this._targetChangedOperation,this)):cc.warnID(6501,this.node.name))}},{key:"_unregisterTargetEvents",value:function(){var e=this._target||this.node.parent;e&&(e.off(exports.SystemEventType.TRANSFORM_CHANGED,this._targetChangedOperation,this),e.off(exports.SystemEventType.SIZE_CHANGED,this._targetChangedOperation,this))}},{key:"_unregisterOldParentEvents",value:function(e){var t=this._target||e;t&&(t.off(exports.SystemEventType.TRANSFORM_CHANGED,this._targetChangedOperation,this),t.off(exports.SystemEventType.SIZE_CHANGED,this._targetChangedOperation,this))}},{key:"_targetChangedOperation",value:function(){this._recursiveDirty()}},{key:"_setAlign",value:function(e,t){if(t!==(this._alignFlags&e)>0){var i=(e&yW)>0;t?(this._alignFlags|=e,i?(this.isAlignHorizontalCenter=!1,this.isStretchWidth&&(this._originalWidth=this.node.width)):(this.isAlignVerticalCenter=!1,this.isStretchHeight&&(this._originalHeight=this.node.height))):(i?this.isStretchWidth&&(this.node.width=this._originalWidth):this.isStretchHeight&&(this.node.height=this._originalHeight),this._alignFlags&=~e)}}},{key:"_recursiveDirty",value:function(){this._dirty||(this._dirty=!0)}},{key:"target",get:function(){return this._target},set:function(e){this._target!==e&&(this._unregisterTargetEvents(),this._target=e,this._registerTargetEvents(),this._validateTargetInDEV(),this._recursiveDirty())}},{key:"isAlignTop",get:function(){return(this._alignFlags&pW.TOP)>0},set:function(e){this._setAlign(pW.TOP,e),this._recursiveDirty()}},{key:"isAlignBottom",get:function(){return(this._alignFlags&pW.BOT)>0},set:function(e){this._setAlign(pW.BOT,e),this._recursiveDirty()}},{key:"isAlignLeft",get:function(){return(this._alignFlags&pW.LEFT)>0},set:function(e){this._setAlign(pW.LEFT,e),this._recursiveDirty()}},{key:"isAlignRight",get:function(){return(this._alignFlags&pW.RIGHT)>0},set:function(e){this._setAlign(pW.RIGHT,e),this._recursiveDirty()}},{key:"isAlignVerticalCenter",get:function(){return(this._alignFlags&pW.MID)>0},set:function(e){e?(this.isAlignTop=!1,this.isAlignBottom=!1,this._alignFlags|=pW.MID):this._alignFlags&=~pW.MID,this._recursiveDirty()}},{key:"isAlignHorizontalCenter",get:function(){return(this._alignFlags&pW.CENTER)>0},set:function(e){e?(this.isAlignLeft=!1,this.isAlignRight=!1,this._alignFlags|=pW.CENTER):this._alignFlags&=~pW.CENTER,this._recursiveDirty()}},{key:"isStretchWidth",get:function(){return(this._alignFlags&yW)===yW}},{key:"isStretchHeight",get:function(){return(this._alignFlags&vW)===vW}},{key:"top",get:function(){return this._top},set:function(e){this._top=e,this._recursiveDirty()}},{key:"editorTop",get:function(){return this._isAbsTop?this._top:100*this._top},set:function(e){this._top=this._isAbsTop?e:e/100,this._recursiveDirty()}},{key:"bottom",get:function(){return this._bottom},set:function(e){this._bottom=e,this._recursiveDirty()}},{key:"editorBottom",get:function(){return this._isAbsBottom?this._bottom:100*this._bottom},set:function(e){this._bottom=this._isAbsBottom?e:e/100,this._recursiveDirty()}},{key:"left",get:function(){return this._left},set:function(e){this._left=e,this._recursiveDirty()}},{key:"editorLeft",get:function(){return this._isAbsLeft?this._left:100*this._left},set:function(e){this._left=this._isAbsLeft?e:e/100,this._recursiveDirty()}},{key:"right",get:function(){return this._right},set:function(e){this._right=e,this._recursiveDirty()}},{key:"editorRight",get:function(){return this._isAbsRight?this._right:100*this._right},set:function(e){this._right=this._isAbsRight?e:e/100,this._recursiveDirty()}},{key:"horizontalCenter",get:function(){return this._horizontalCenter},set:function(e){this._horizontalCenter=e,this._recursiveDirty()}},{key:"editorHorizontalCenter",get:function(){return this._isAbsHorizontalCenter?this._horizontalCenter:100*this._horizontalCenter},set:function(e){this._horizontalCenter=this._isAbsHorizontalCenter?e:e/100,this._recursiveDirty()}},{key:"verticalCenter",get:function(){return this._verticalCenter},set:function(e){this._verticalCenter=e,this._recursiveDirty()}},{key:"editorVerticalCenter",get:function(){return this._isAbsVerticalCenter?this._verticalCenter:100*this._verticalCenter},set:function(e){this._verticalCenter=this._isAbsVerticalCenter?e:e/100,this._recursiveDirty()}},{key:"isAbsoluteTop",get:function(){return this._isAbsTop},set:function(e){this._isAbsTop!==e&&(this._isAbsTop=e,this._autoChangedValue(pW.TOP,this._isAbsTop))}},{key:"isAbsoluteBottom",get:function(){return this._isAbsBottom},set:function(e){this._isAbsBottom!==e&&(this._isAbsBottom=e,this._autoChangedValue(pW.BOT,this._isAbsBottom))}},{key:"isAbsoluteLeft",get:function(){return this._isAbsLeft},set:function(e){this._isAbsLeft!==e&&(this._isAbsLeft=e,this._autoChangedValue(pW.LEFT,this._isAbsLeft))}},{key:"isAbsoluteRight",get:function(){return this._isAbsRight},set:function(e){this._isAbsRight!==e&&(this._isAbsRight=e,this._autoChangedValue(pW.RIGHT,this._isAbsRight))}},{key:"isAbsoluteHorizontalCenter",get:function(){return this._isAbsHorizontalCenter},set:function(e){this._isAbsHorizontalCenter!==e&&(this._isAbsHorizontalCenter=e,this._autoChangedValue(pW.CENTER,this._isAbsHorizontalCenter))}},{key:"isAbsoluteVerticalCenter",get:function(){return this._isAbsVerticalCenter},set:function(e){this._isAbsVerticalCenter!==e&&(this._isAbsVerticalCenter=e,this._autoChangedValue(pW.MID,this._isAbsVerticalCenter))}},{key:"alignMode",get:function(){return this._alignMode},set:function(e){this._alignMode=e,this._recursiveDirty()}},{key:"alignFlags",get:function(){return this._alignFlags},set:function(e){this._alignFlags!==e&&(this._alignFlags=e,this._recursiveDirty())}}]),t}(),lW.AlignMode=hW,de((VH=uW).prototype,"target",[FH],Object.getOwnPropertyDescriptor(VH.prototype,"target"),VH.prototype),de(VH.prototype,"isAlignTop",[MH],Object.getOwnPropertyDescriptor(VH.prototype,"isAlignTop"),VH.prototype),de(VH.prototype,"isAlignBottom",[IH],Object.getOwnPropertyDescriptor(VH.prototype,"isAlignBottom"),VH.prototype),de(VH.prototype,"isAlignLeft",[PH],Object.getOwnPropertyDescriptor(VH.prototype,"isAlignLeft"),VH.prototype),de(VH.prototype,"isAlignRight",[LH],Object.getOwnPropertyDescriptor(VH.prototype,"isAlignRight"),VH.prototype),de(VH.prototype,"isAlignVerticalCenter",[DH],Object.getOwnPropertyDescriptor(VH.prototype,"isAlignVerticalCenter"),VH.prototype),de(VH.prototype,"isAlignHorizontalCenter",[NH],Object.getOwnPropertyDescriptor(VH.prototype,"isAlignHorizontalCenter"),VH.prototype),de(VH.prototype,"isStretchWidth",[zH],Object.getOwnPropertyDescriptor(VH.prototype,"isStretchWidth"),VH.prototype),de(VH.prototype,"isStretchHeight",[BH],Object.getOwnPropertyDescriptor(VH.prototype,"isStretchHeight"),VH.prototype),de(VH.prototype,"editorTop",[Ko],Object.getOwnPropertyDescriptor(VH.prototype,"editorTop"),VH.prototype),de(VH.prototype,"editorBottom",[Ko],Object.getOwnPropertyDescriptor(VH.prototype,"editorBottom"),VH.prototype),de(VH.prototype,"editorLeft",[Ko],Object.getOwnPropertyDescriptor(VH.prototype,"editorLeft"),VH.prototype),de(VH.prototype,"editorRight",[Ko],Object.getOwnPropertyDescriptor(VH.prototype,"editorRight"),VH.prototype),de(VH.prototype,"editorHorizontalCenter",[Ko],Object.getOwnPropertyDescriptor(VH.prototype,"editorHorizontalCenter"),VH.prototype),de(VH.prototype,"editorVerticalCenter",[Ko],Object.getOwnPropertyDescriptor(VH.prototype,"editorVerticalCenter"),VH.prototype),de(VH.prototype,"isAbsoluteTop",[Ko],Object.getOwnPropertyDescriptor(VH.prototype,"isAbsoluteTop"),VH.prototype),de(VH.prototype,"isAbsoluteBottom",[Ko],Object.getOwnPropertyDescriptor(VH.prototype,"isAbsoluteBottom"),VH.prototype),de(VH.prototype,"isAbsoluteLeft",[Ko],Object.getOwnPropertyDescriptor(VH.prototype,"isAbsoluteLeft"),VH.prototype),de(VH.prototype,"isAbsoluteRight",[Ko],Object.getOwnPropertyDescriptor(VH.prototype,"isAbsoluteRight"),VH.prototype),de(VH.prototype,"isAbsoluteHorizontalCenter",[Ko],Object.getOwnPropertyDescriptor(VH.prototype,"isAbsoluteHorizontalCenter"),VH.prototype),de(VH.prototype,"isAbsoluteVerticalCenter",[Ko],Object.getOwnPropertyDescriptor(VH.prototype,"isAbsoluteVerticalCenter"),VH.prototype),de(VH.prototype,"alignMode",[GH],Object.getOwnPropertyDescriptor(VH.prototype,"alignMode"),VH.prototype),de(VH.prototype,"alignFlags",[Ko],Object.getOwnPropertyDescriptor(VH.prototype,"alignFlags"),VH.prototype),HH=de(VH.prototype,"_alignFlags",[Ko],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return 0}}),WH=de(VH.prototype,"_target",[Ko],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return null}}),jH=de(VH.prototype,"_left",[Ko],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return 0}}),qH=de(VH.prototype,"_right",[Ko],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return 0}}),YH=de(VH.prototype,"_top",[Ko],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return 0}}),KH=de(VH.prototype,"_bottom",[Ko],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return 0}}),ZH=de(VH.prototype,"_horizontalCenter",[Ko],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return 0}}),QH=de(VH.prototype,"_verticalCenter",[Ko],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return 0}}),JH=de(VH.prototype,"_isAbsLeft",[Ko],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return!0}}),$H=de(VH.prototype,"_isAbsRight",[Ko],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return!0}}),eW=de(VH.prototype,"_isAbsTop",[Ko],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return!0}}),tW=de(VH.prototype,"_isAbsBottom",[Ko],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return!0}}),iW=de(VH.prototype,"_isAbsHorizontalCenter",[Ko],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return!0}}),nW=de(VH.prototype,"_isAbsVerticalCenter",[Ko],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return!0}}),rW=de(VH.prototype,"_originalWidth",[Ko],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return 0}}),aW=de(VH.prototype,"_originalHeight",[Ko],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return 0}}),oW=de(VH.prototype,"_alignMode",[Ko],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return hW.ON_WINDOW_RESIZE}}),sW=de(VH.prototype,"_lockFlags",[UH],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return 0}}),XH=VH))||XH)||XH)||XH)||XH)||XH)||XH),exports.WidgetComponent||(exports.WidgetComponent={}),cc.WidgetComponent=exports.WidgetComponent,cc.internal.computeInverseTransForTarget=dW,cc.internal.getReadonlyNodeSize=fW;var gW,xW,bW,TW,SW,EW,wW,CW,AW,OW,kW,RW,FW,MW,IW,PW,LW=Yo("cc.UIReorderComponent")(mW=os("i18n:cc.UIReorderComponent")(mW=es("UI/Reorder")(mW=ts(110)(mW=is(mW=Jo(mW=function(e){function t(){return Z(this,t),re(this,te(t).apply(this,arguments))}return ee(t,jC),t}())||mW)||mW)||mW)||mW)||mW)||mW;cc.UIReorderComponent=LW;var DW,NW=new an;!function(e){e[e.HORIZONTAL=0]="HORIZONTAL",e[e.VERTICAL=1]="VERTICAL"}(DW||(DW={})),bt(DW);var zW,BW,GW,UW,XW,VW,HW,WW,jW,qW,YW,KW,ZW,QW,JW,$W,ej,tj,ij,nj,rj,aj,oj,sj,lj,uj,cj,hj,pj,_j,fj,dj,mj,vj=(gW=Yo("cc.PageViewIndicatorComponent"),xW=os("i18n:cc.PageViewIndicatorComponent"),bW=ts(110),TW=es("UI/PageViewIndicator"),SW=Ko({type:Ac,tooltip:"每个页面标记显示的图片"}),EW=Ko({type:DW,tooltip:"页面标记摆放方向"}),wW=Ko({type:en,tooltip:"每个页面标记的大小"}),CW=Ko({tooltip:"每个页面标记之间的边距"}),gW(AW=xW(AW=bW(AW=TW((PW=IW=function(e){function t(){var e,i;Z(this,t);for(var n=arguments.length,r=new Array(n),a=0;a<n;a++)r[a]=arguments[a];return fe(i=re(this,(e=te(t)).call.apply(e,[this].concat(r))),"spacing",kW,ne(i)),fe(i,"_spriteFrame",RW,ne(i)),fe(i,"_direction",FW,ne(i)),fe(i,"_cellSize",MW,ne(i)),i._layout=null,i._pageView=null,i._indicators=[],i}return ee(t,rp),J(t,[{key:"onLoad",value:function(){this._updateLayout()}},{key:"setPageView",value:function(e){this._pageView=e,this._refresh()}},{key:"_updateLayout",value:function(){this._layout=this.getComponent(bG),this._layout||(this._layout=this.addComponent(bG));var e=this._layout;this.direction===DW.HORIZONTAL?(e.type=bG.Type.HORIZONTAL,e.spacingX=this.spacing):this.direction===DW.VERTICAL&&(e.type=bG.Type.VERTICAL,e.spacingY=this.spacing),e.resizeMode=bG.ResizeMode.CONTAINER}},{key:"_createIndicator",value:function(){var e=new tg;return e.addComponent(LA).spriteFrame=this.spriteFrame,e.parent=this.node,e.width=this.cellSize.width,e.height=this.cellSize.height,e}},{key:"_changedState",value:function(){var e=this._indicators;if(0!==e.length&&this._pageView){var t=this._pageView.curPageIdx;if(!(t>=e.length)){for(var i=0;i<e.length;++i){var n=e[i];if(n._uiProps.uiComp){var r=n._uiProps.uiComp;NW.set(r.color),NW.a=127.5,r.color=NW}}if(e[t]._uiProps.uiComp){var a=e[t]._uiProps.uiComp;NW.set(a.color),NW.a=255,a.color=NW}}}}},{key:"_refresh",value:function(){if(this._pageView){var e=this._indicators,t=this._pageView.getPages();if(t.length!==e.length){var i=0;if(t.length>e.length)for(i=0;i<t.length;++i)e[i]||(e[i]=this._createIndicator());else for(i=e.length-t.length;i>0;--i){var n=e[i-1];this.node.removeChild(n),e.splice(i-1,1)}this._layout&&this._layout.enabledInHierarchy&&this._layout.updateLayout(),this._changedState()}}}},{key:"spriteFrame",get:function(){return this._spriteFrame},set:function(e){this._spriteFrame!==e&&(this._spriteFrame=e)}},{key:"direction",get:function(){return this._direction},set:function(e){this._direction!==e&&(this._direction=e)}},{key:"cellSize",get:function(){return this._cellSize},set:function(e){this._cellSize!==e&&(this._cellSize=e)}}]),t}(),IW.Direction=DW,de((OW=PW).prototype,"spriteFrame",[SW],Object.getOwnPropertyDescriptor(OW.prototype,"spriteFrame"),OW.prototype),de(OW.prototype,"direction",[EW],Object.getOwnPropertyDescriptor(OW.prototype,"direction"),OW.prototype),de(OW.prototype,"cellSize",[wW],Object.getOwnPropertyDescriptor(OW.prototype,"cellSize"),OW.prototype),kW=de(OW.prototype,"spacing",[CW],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return 0}}),RW=de(OW.prototype,"_spriteFrame",[Ko],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return null}}),FW=de(OW.prototype,"_direction",[Ko],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return DW.HORIZONTAL}}),MW=de(OW.prototype,"_cellSize",[Ko],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return new en(20,20)}}),AW=OW))||AW)||AW)||AW)||AW);cc.PageViewIndicatorComponent=vj;var yj,gj,xj,bj=new ki;!function(e){e[e.Unified=0]="Unified",e[e.Free=1]="Free"}(yj||(yj={})),bt(yj),function(e){e[e.Horizontal=0]="Horizontal",e[e.Vertical=1]="Vertical"}(gj||(gj={})),bt(gj),(xj||(xj={})).PAGE_TURNING="page-turning";var Tj,Sj,Ej,wj,Cj,Aj,Oj,kj,Rj,Fj,Mj=(zW=Yo("cc.PageViewComponent"),BW=os("i18n:cc.PageViewComponent"),GW=ts(110),UW=es("UI/PageView"),XW=Ko({type:yj,tooltip:"页面视图中每个页面大小类型"}),VW=Ko({type:gj,tooltip:"页面视图滚动类型"}),HW=Ko({slide:!0,range:[0,1,.01],tooltip:"滚动临界值，默认单位百分比，当拖拽超出该数值时，松开会自动滚动下一页，小于时则还原"}),WW=Ko({slide:!0,range:[0,1,.01],tooltip:"设置 PageView PageTurning 事件的发送时机"}),jW=Ko({type:vj,tooltip:"页面视图指示器组件"}),qW=Ko({tooltip:"快速滑动翻页临界值\n当用户快速滑动时，会根据滑动开始和结束的距离与时间计算出一个速度值\n该值与此临界值相比较，如果大于临界值，则进行自动翻页"}),YW=Ko({type:xX,visible:!1,override:!0}),KW=Ko({type:xX,visible:!1,override:!0}),ZW=Ko({visible:!1,override:!0}),QW=Ko({visible:!1,override:!0}),JW=Ko({visible:!1,override:!0}),$W=Ko({visible:!1,override:!0,type:[fO]}),ej=Ko({type:[fO],tooltip:"滚动视图的事件回调函数"}),zW(tj=BW(tj=GW(tj=UW((mj=dj=function(e){function t(){var e,i;Z(this,t);for(var n=arguments.length,r=new Array(n),a=0;a<n;a++)r[a]=arguments[a];return fe(i=re(this,(e=te(t)).call.apply(e,[this].concat(r))),"autoPageTurningThreshold",nj,ne(i)),fe(i,"horizontal",rj,ne(i)),fe(i,"vertical",aj,ne(i)),fe(i,"cancelInnerEvents",oj,ne(i)),fe(i,"scrollEvents",sj,ne(i)),fe(i,"pageTurningSpeed",lj,ne(i)),fe(i,"pageEvents",uj,ne(i)),fe(i,"_sizeMode",cj,ne(i)),fe(i,"_direction",hj,ne(i)),fe(i,"_scrollThreshold",pj,ne(i)),fe(i,"_pageTurningEventTiming",_j,ne(i)),fe(i,"_indicator",fj,ne(i)),i._curPageIdx=0,i._lastPageIdx=0,i._pages=[],i._initContentPos=new Ii,i._scrollCenterOffsetX=[],i._scrollCenterOffsetY=[],i._touchBeganPosition=new Ii,i._touchEndPosition=new Ii,i}return ee(t,TV),J(t,[{key:"__preload",value:function(){this.node.on(exports.SystemEventType.SIZE_CHANGED,this._updateAllPagesSize,this)}},{key:"onEnable",value:function(){oe(te(t.prototype),"onEnable",this).call(this),this.node.on(t.EventType.SCROLL_ENG_WITH_THRESHOLD,this._dispatchPageTurningEvent,this)}},{key:"onDisable",value:function(){oe(te(t.prototype),"onDisable",this).call(this),this.node.off(t.EventType.SCROLL_ENG_WITH_THRESHOLD,this._dispatchPageTurningEvent,this)}},{key:"onLoad",value:function(){this._initPages(),this.indicator&&this.indicator.setPageView(this)}},{key:"onDestroy",value:function(){this.node.off(exports.SystemEventType.SIZE_CHANGED,this._updateAllPagesSize,this)}},{key:"getCurrentPageIndex",value:function(){return this._curPageIdx}},{key:"setCurrentPageIndex",value:function(e){this.scrollToPage(e,1)}},{key:"getPages",value:function(){return this._pages}},{key:"addPage",value:function(e){e&&-1===this._pages.indexOf(e)&&this.content&&(this.content.addChild(e),this._pages.push(e),this._updatePageView())}},{key:"insertPage",value:function(e,t){t<0||!e||-1!==this._pages.indexOf(e)||!this.content||(t>=this._pages.length?this.addPage(e):(this._pages.splice(t,0,e),this.content.insertChild(e,t),this._updatePageView()))}},{key:"removePage",value:function(e){if(e&&this.content){var t=this._pages.indexOf(e);-1!==t?this.removePageAtIndex(t):g(4300,e.name)}}},{key:"removePageAtIndex",value:function(e){var t=this._pages;if(!(e<0||e>=t.length)){var i=t[e];i&&this.content&&(this.content.removeChild(i),t.splice(e,1),this._updatePageView())}}},{key:"removeAllPages",value:function(){if(this.content){for(var e=this._pages,t=0,i=e.length;t<i;t++)this.content.removeChild(e[t]);this._pages.length=0,this._updatePageView()}}},{key:"scrollToPage",value:function(e){var t=arguments.length>1&&void 0!==arguments[1]?arguments[1]:.3;e<0||e>=this._pages.length||(this._curPageIdx=e,this.scrollToOffset(this._moveOffsetValue(e),t,!0),this.indicator&&this.indicator._changedState())}},{key:"getScrollEndedEventTiming",value:function(){return this.pageTurningEventTiming}},{key:"_updatePageView",value:function(){var e=this.content.getComponent(bG);e&&e.enabled&&e.updateLayout();var t=this._pages.length;this._curPageIdx>=t&&(this._curPageIdx=0===t?0:t-1,this._lastPageIdx=this._curPageIdx);for(var i=this._initContentPos,n=0;n<t;++n){var r=this._pages[n].position;this.direction===gj.Horizontal?this._scrollCenterOffsetX[n]=Math.abs(i.x+r.x):this._scrollCenterOffsetY[n]=Math.abs(i.y+r.y)}this.indicator&&this.indicator._refresh()}},{key:"_updateAllPagesSize",value:function(){if(this.content&&this.view&&this._sizeMode===yj.Unified)for(var e=this._pages,t=this.view.getContentSize(),i=0,n=e.length;i<n;i++)e[i].setContentSize(t)}},{key:"_handleReleaseLogic",value:function(){this._autoScrollToPage(),this._scrolling&&(this._scrolling=!1,this._autoScrolling||this._dispatchEvent(t.EventType.SCROLL_ENDED))}},{key:"_onTouchBegan",value:function(e,i){e.touch.getUILocation(bj),Ii.set(this._touchBeganPosition,bj.x,bj.y,0),oe(te(t.prototype),"_onTouchBegan",this).call(this,e,i)}},{key:"_onTouchMoved",value:function(e,i){oe(te(t.prototype),"_onTouchMoved",this).call(this,e,i)}},{key:"_onTouchEnded",value:function(e,i){e.touch.getUILocation(bj),Ii.set(this._touchEndPosition,bj.x,bj.y,0),oe(te(t.prototype),"_onTouchEnded",this).call(this,e,i)}},{key:"_onTouchCancelled",value:function(e,i){e.touch.getUILocation(bj),Ii.set(this._touchEndPosition,bj.x,bj.y,0),oe(te(t.prototype),"_onTouchCancelled",this).call(this,e,i)}},{key:"_onMouseWheel",value:function(){}},{key:"_syncScrollDirection",value:function(){this.horizontal=this.direction===gj.Horizontal,this.vertical=this.direction===gj.Vertical}},{key:"_syncSizeMode",value:function(){var e=this.view;if(this.content&&e){var t=this.content.getComponent(bG);if(t){if(this._sizeMode===yj.Free&&this._pages.length>0){var i=this._pages[this._pages.length-1];this.direction===gj.Horizontal?(t.paddingLeft=(e.width-this._pages[0].width)/2,t.paddingRight=(e.width-i.width)/2):this.direction===gj.Vertical&&(t.paddingTop=(e.height-this._pages[0].height)/2,t.paddingBottom=(e.height-i.height)/2)}t.updateLayout()}}}},{key:"_initPages",value:function(){if(this.content){this._initContentPos=this.content.position;for(var e=this.content.children,t=0;t<e.length;++t){var i=e[t];this._pages.indexOf(i)>=0||this._pages.push(i)}this._syncScrollDirection(),this._syncSizeMode(),this._updatePageView()}}},{key:"_dispatchPageTurningEvent",value:function(){this._lastPageIdx!==this._curPageIdx&&(this._lastPageIdx=this._curPageIdx,fO.emitEvents(this.pageEvents,this),this.node.emit(xj.PAGE_TURNING,this))}},{key:"_isQuicklyScrollable",value:function(e){if(this.direction===gj.Horizontal){if(Math.abs(e.x)>this.autoPageTurningThreshold)return!0}else if(this.direction===gj.Vertical&&Math.abs(e.y)>this.autoPageTurningThreshold)return!0;return!1}},{key:"_moveOffsetValue",value:function(e){var t=new Ii;if(this._sizeMode===yj.Free)this.direction===gj.Horizontal?t.x=this._scrollCenterOffsetX[e]:this.direction===gj.Vertical&&(t.y=this._scrollCenterOffsetY[e]);else{var i=this.view;if(!i)return t;this.direction===gj.Horizontal?t.x=e*i.width:this.direction===gj.Vertical&&(t.y=e*i.height)}return t}},{key:"_getDragDirection",value:function(e){return this._direction===gj.Horizontal?0===e.x?0:e.x>0?1:-1:0===e.y?0:e.y<0?1:-1}},{key:"_isScrollable",value:function(e,t,i){if(this._sizeMode===yj.Free){var n=0,r=0;if(this.direction===gj.Horizontal)return n=this._scrollCenterOffsetX[t],r=this._scrollCenterOffsetX[i],Math.abs(e.x)>=Math.abs(n-r)*this.scrollThreshold;if(this.direction===gj.Vertical)return n=this._scrollCenterOffsetY[t],r=this._scrollCenterOffsetY[i],Math.abs(e.y)>=Math.abs(n-r)*this.scrollThreshold}else{var a=this.view;if(!a)return;if(this.direction===gj.Horizontal)return Math.abs(e.x)>=a.width*this.scrollThreshold;if(this.direction===gj.Vertical)return Math.abs(e.y)>=a.height*this.scrollThreshold}}},{key:"_autoScrollToPage",value:function(){var e=this._startBounceBackIfNeeded(),t=new Ii;if(Ii.subtract(t,this._touchBeganPosition,this._touchEndPosition),e){var i=this._getDragDirection(t);if(0===i)return;this._curPageIdx=i>0?this._pages.length-1:0,this.indicator&&this.indicator._changedState()}else{var n=this._curPageIdx,r=n+this._getDragDirection(t),a=this.pageTurningSpeed*Math.abs(n-r);if(r<this._pages.length){if(this._isScrollable(t,n,r))return void this.scrollToPage(r,a);var o=this._calculateTouchMoveVelocity();if(this._isQuicklyScrollable(o))return void this.scrollToPage(r,a)}this.scrollToPage(n,a)}}},{key:"sizeMode",get:function(){return this._sizeMode},set:function(e){this._sizeMode!==e&&(this._sizeMode=e,this._syncSizeMode())}},{key:"direction",get:function(){return this._direction},set:function(e){this._direction!==e&&(this._direction=e,this._syncScrollDirection())}},{key:"scrollThreshold",get:function(){return this._scrollThreshold},set:function(e){this._scrollThreshold!==e&&(this._scrollThreshold=e)}},{key:"pageTurningEventTiming",get:function(){return this._pageTurningEventTiming},set:function(e){this._pageTurningEventTiming!==e&&(this._pageTurningEventTiming=e)}},{key:"indicator",get:function(){return this._indicator},set:function(e){this._indicator!==e&&(this._indicator=e,this.indicator&&this.indicator.setPageView(this))}},{key:"curPageIdx",get:function(){return this._curPageIdx}},{key:"verticalScrollBar",get:function(){return oe(te(t.prototype),"verticalScrollBar",this)},set:function(e){le(te(t.prototype),"verticalScrollBar",e,this,!0)}},{key:"horizontalScrollBar",get:function(){return oe(te(t.prototype),"horizontalScrollBar",this)},set:function(e){le(te(t.prototype),"horizontalScrollBar",e,this,!0)}}]),t}(),dj.SizeMode=yj,dj.Direction=gj,dj.EventType=tH(xj,JX),de((ij=mj).prototype,"sizeMode",[XW],Object.getOwnPropertyDescriptor(ij.prototype,"sizeMode"),ij.prototype),de(ij.prototype,"direction",[VW],Object.getOwnPropertyDescriptor(ij.prototype,"direction"),ij.prototype),de(ij.prototype,"scrollThreshold",[HW],Object.getOwnPropertyDescriptor(ij.prototype,"scrollThreshold"),ij.prototype),de(ij.prototype,"pageTurningEventTiming",[WW],Object.getOwnPropertyDescriptor(ij.prototype,"pageTurningEventTiming"),ij.prototype),de(ij.prototype,"indicator",[jW],Object.getOwnPropertyDescriptor(ij.prototype,"indicator"),ij.prototype),nj=de(ij.prototype,"autoPageTurningThreshold",[qW],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return 100}}),de(ij.prototype,"verticalScrollBar",[YW],Object.getOwnPropertyDescriptor(ij.prototype,"verticalScrollBar"),ij.prototype),de(ij.prototype,"horizontalScrollBar",[KW],Object.getOwnPropertyDescriptor(ij.prototype,"horizontalScrollBar"),ij.prototype),rj=de(ij.prototype,"horizontal",[ZW],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return!0}}),aj=de(ij.prototype,"vertical",[QW],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return!0}}),oj=de(ij.prototype,"cancelInnerEvents",[JW],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return!0}}),sj=de(ij.prototype,"scrollEvents",[$W],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return[]}}),lj=de(ij.prototype,"pageTurningSpeed",[Ko],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return.3}}),uj=de(ij.prototype,"pageEvents",[ej],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return[]}}),cj=de(ij.prototype,"_sizeMode",[Ko],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return yj.Unified}}),hj=de(ij.prototype,"_direction",[Ko],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return gj.Horizontal}}),pj=de(ij.prototype,"_scrollThreshold",[Ko],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return.5}}),_j=de(ij.prototype,"_pageTurningEventTiming",[Ko],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return.1}}),fj=de(ij.prototype,"_indicator",[Ko],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return null}}),tj=ij))||tj)||tj)||tj)||tj);cc.PageViewComponent=Mj;var Ij,Pj,Lj,Dj=(Tj=Yo("cc.UIStaticBatchComponent"),Sj=os("i18n:cc.UIStaticBatchComponent"),Ej=es("UI/Render/UIStaticBatch"),wj=ts(110),Cj=Ko({visible:!1,override:!0}),Aj=Ko({visible:!1,override:!0}),Oj=Ko({visible:!1,override:!0}),kj=Ko({type:Bh,displayOrder:3,visible:!1,override:!0}),Tj(Rj=Sj(Rj=Ej(Rj=wj((de((Fj=function(e){function t(){var e,i;Z(this,t);for(var n=arguments.length,r=new Array(n),a=0;a<n;a++)r[a]=arguments[a];return(i=re(this,(e=te(t)).call.apply(e,[this].concat(r))))._init=!1,i._meshBuffer=null,i._dirty=!0,i._lastMeshBuffer=null,i._uiDrawBatchList=[],i}return ee(t,wA),J(t,[{key:"onLoad",value:function(){var e=this._getUI();if(e){var t=JA,i=new jA(e);i.initialize(t,this._arrivalMaxBuffer),this._meshBuffer=i}}},{key:"onDestroy",value:function(){oe(te(t.prototype),"onDestroy",this).call(this),this._clearData(),this._meshBuffer&&(this._meshBuffer.destroy(),this._meshBuffer=null)}},{key:"updateAssembler",value:function(e){this._dirty&&(e.finishMergeBatches(),this._lastMeshBuffer=e.currBufferBatch,e.currBufferBatch=this._meshBuffer,e.currStaticRoot=this),this._init&&(e.finishMergeBatches(),e.commitStaticBatch(this))}},{key:"postUpdateAssembler",value:function(e){this._dirty&&(e.finishMergeBatches(),e.currBufferBatch=this._lastMeshBuffer,e.currStaticRoot=null,this._dirty=!1,this._init=!0,this.node._static=!0,this._meshBuffer.uploadData())}},{key:"markAsDirty",value:function(){this._getUI()&&(this.node._static=!1,this._dirty=!0,this._init=!1,this._clearData())}},{key:"_requireDrawBatch",value:function(){var e=new ZA;return e.isStatic=!0,this._uiDrawBatchList.push(e),e}},{key:"_clearData",value:function(){if(this._meshBuffer){this._meshBuffer.reset();for(var e=this._getUI(),t=0;t<this._uiDrawBatchList.length;t++){this._uiDrawBatchList[t].destroy(e)}}this._uiDrawBatchList.length=0,this._init=!1}},{key:"_getUI",value:function(){return _O.root&&_O.root.ui?_O.root.ui:(g(9301),null)}},{key:"_arrivalMaxBuffer",value:function(){g(9300)}},{key:"dstBlendFactor",get:function(){return this._dstBlendFactor},set:function(e){this._dstBlendFactor!==e&&(this._dstBlendFactor=e,this._updateBlendFunc())}},{key:"srcBlendFactor",get:function(){return this._srcBlendFactor},set:function(e){this._srcBlendFactor!==e&&(this._srcBlendFactor=e,this._updateBlendFunc())}},{key:"color",get:function(){return this._color},set:function(e){this._color!==e&&(this._color.set(e),this._updateColor(),this.markForUpdateRenderData())}},{key:"sharedMaterial",get:function(){return this._sharedMaterial},set:function(e){this._sharedMaterial!==e&&(this._sharedMaterial=e,this._instanceMaterial&&this._instanceMaterial())}},{key:"drawBatchList",get:function(){return this._uiDrawBatchList}}]),t}()).prototype,"dstBlendFactor",[Cj],Object.getOwnPropertyDescriptor(Fj.prototype,"dstBlendFactor"),Fj.prototype),de(Fj.prototype,"srcBlendFactor",[Aj],Object.getOwnPropertyDescriptor(Fj.prototype,"srcBlendFactor"),Fj.prototype),de(Fj.prototype,"color",[Oj],Object.getOwnPropertyDescriptor(Fj.prototype,"color"),Fj.prototype),de(Fj.prototype,"sharedMaterial",[kj],Object.getOwnPropertyDescriptor(Fj.prototype,"sharedMaterial"),Fj.prototype),Rj=Fj))||Rj)||Rj)||Rj)||Rj),Nj=Yo("cc.UIOpacityComponent")(Ij=os("i18n:cc.UIOpacityComponent")(Ij=ts(110)(Ij=es("UI/UIOpacity")(Ij=Jo((de((Pj=function(e){function t(){var e,i;Z(this,t);for(var n=arguments.length,r=new Array(n),a=0;a<n;a++)r[a]=arguments[a];return fe(i=re(this,(e=te(t)).call.apply(e,[this].concat(r))),"_opacity",Lj,ne(i)),i}return ee(t,rp),J(t,[{key:"onEnable",value:function(){this.node._uiProps.opacity=this._opacity/255}},{key:"onDisable",value:function(){this.node._uiProps.opacity=1}},{key:"opacity",get:function(){return this._opacity},set:function(e){this._opacity!==e&&(this._opacity=e,this.node._uiProps.opacity=e/255)}}]),t}()).prototype,"opacity",[Ko],Object.getOwnPropertyDescriptor(Pj.prototype,"opacity"),Pj.prototype),Lj=de(Pj.prototype,"_opacity",[Ko],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return 255}}),Ij=Pj))||Ij)||Ij)||Ij)||Ij)||Ij,zj=new Ii,Bj=new ki,Gj=new Ii,Uj=new Ii(1,1,1);function Xj(e,t){var i,n=t.target,r=Gj,a=Uj;if(n?dW(e,i=n,r,a):i=e.parent,i.getComponent(Iy)){var o=fW(i),s=i instanceof $g,l=s?Bj:i.getAnchorPoint(),u=s;e.getPosition(zj);var c=zj.x,h=zj.y,p=e.getAnchorPoint(),_=e.getScale();if(t.alignFlags&pW.HORIZONTAL){var f=0,d=0,m=o.width;u?(f=KT.left.x,d=KT.right.x):d=(f=-l.x*m)+m,f+=t.isAbsoluteLeft?t.left:t.left*m,d-=t.isAbsoluteRight?t.right:t.right*m,n&&(f+=r.x,f*=a.x,d+=r.x,d*=a.x);var v=0,y=p.x,g=_.x;if(g<0&&(y=1-y,g=-g),t.isStretchWidth)v=d-f,0!==g&&(e.width=v/g),c=f+y*v;else if(v=e.width*g,t.isAlignHorizontalCenter){var x=t.isAbsoluteHorizontalCenter?t.horizontalCenter:t.horizontalCenter*m,b=(.5-l.x)*o.width;n&&(x*=a.x,b+=r.x,b*=a.x),c=b+(y-.5)*v+x}else c=t.isAlignLeft?f+y*v:d+(y-1)*v;t._lastSize.width=v}if(t.alignFlags&pW.VERTICAL){var T=0,S=0,E=o.height;u?(S=KT.bottom.y,T=KT.top.y):T=(S=-l.y*E)+E,S+=t.isAbsoluteBottom?t.bottom:t.bottom*E,T-=t.isAbsoluteTop?t.top:t.top*E,n&&(S+=r.y,S*=a.y,T+=r.y,T*=a.y);var w=0,C=p.y,A=_.y;if(A<0&&(C=1-C,A=-A),t.isStretchHeight)w=T-S,0!==A&&(e.height=w/A),h=S+C*w;else if(w=e.height*A,t.isAlignVerticalCenter){var O=t.isAbsoluteVerticalCenter?t.verticalCenter:t.verticalCenter*E,k=(.5-l.y)*o.height;n&&(O*=a.y,k+=r.y,k*=a.y),h=k+(C-.5)*w+O}else h=t.isAlignBottom?S+C*w:T+(C-1)*w;t._lastSize.height=w}e.setPosition(c,h,zj.z),Ii.set(t._lastPos,c,h,zj.z)}}function Vj(){var e=_O.getScene();if(e){if(jj.isAligning=!0,jj._nodesOrderDirty)Hj.length=0,function e(t){var i=t.getComponent(exports.WidgetComponent);if(i)if(Xj(t,i),i.alignMode!==hW.ALWAYS)i.enabled=!1;else{if(!cc.isValid(t,!0))return;Hj.push(i)}for(var n,r=_e(t.children);!(n=r()).done;){var a=n.value;a.active&&e(a)}}(e),jj._nodesOrderDirty=!1;else{var t=null,i=jj._activeWidgetsIterator;for(i.i=0;i.i<Hj.length;++i.i)(t=Hj[i.i])._dirty&&(Xj(t.node,t),t._dirty=!1)}jj.isAligning=!1}}var Hj=[];var Wj=[],jj=cc._widgetManager={isAligning:!1,_nodesOrderDirty:!1,_activeWidgetsIterator:new tt.MutableForwardIterator(Hj),animationState:null,init:function(e){e.on(iO.EVENT_AFTER_UPDATE,Vj),Cs.isMobile?window.addEventListener("resize",this.onResized.bind(this)):$S.instance.on("design-resolution-changed",this.onResized,this)},add:function(e){this._nodesOrderDirty=!0;var t=_O.root.ui.getScreen(e.node._uiProps.uiTransformComp.visibility);t&&-1===Wj.indexOf(t)&&(Wj.push(t),t.node.on("design-resolution-changed",this.onResized,this))},remove:function(e){this._activeWidgetsIterator.remove(e)},onResized:function(){var e=_O.getScene();e&&this.refreshWidgetOnResized(e)},refreshWidgetOnResized:function(e){if(tg.isNode(e)){var t=e.getComponent(exports.WidgetComponent);t&&t.alignMode===hW.ON_WINDOW_RESIZE&&(t.enabled=!0)}for(var i,n=_e(e.children);!(i=n()).done;){var r=i.value;this.refreshWidgetOnResized(r)}},updateOffsetsToStayPut:function(e,t){function i(e,t){return Math.abs(e-t)>1e-10?t:e}var n=e.node,r=n.parent;if(r){var a=new Ii,o=new Ii(1,1,1);if(e.target&&dW(n,r=e.target,a,o),!t)return;if(!r.getComponent(Iy))return void cc.warnID(6501,e.node.name);var s=r.getAnchorPoint(),l=fW(r),u=n.getAnchorPoint(),c=n.getPosition(),h=pW,p=n.getScale(),_=0;if(t&h.LEFT){var f=-s.x*l.width;f+=a.x,f*=o.x,_=c.x-u.x*n.width*p.x-f,e.isAbsoluteLeft||(_/=l.width),_/=o.x,e.left=i(e.left,_)}if(t&h.RIGHT){var d=(1-s.x)*l.width;d+=a.x,_=(d*=o.x)-(c.x+(1-u.x)*n.width*p.x),e.isAbsoluteRight||(_/=l.width),_/=o.x,e.right=i(e.right,_)}if(t&h.TOP){var m=(1-s.y)*l.height;m+=a.y,_=(m*=o.y)-(c.y+(1-u.y)*n.height*p.y),e.isAbsoluteTop||(_/=l.height),_/=o.y,e.top=i(e.top,_)}if(t&h.BOT){var v=-s.y*l.height;v+=a.y,v*=o.y,_=c.y-u.y*n.height*p.y-v,e.isAbsoluteBottom||(_/=l.height),_/=o.y,e.bottom=i(e.bottom,_)}}},updateAlignment:function e(t){var i=t.parent;i&&tg.isNode(i)&&e(i);var n=t.getComponent(exports.WidgetComponent);n&&i&&Xj(t,n)},AlignMode:hW,AlignFlags:pW};_O.on(iO.EVENT_INIT,(function(){jj.init(_O)}));var qj=function e(t,i,n){Z(this,e),this.i=void 0,this.x=void 0,this.y=void 0,this.prev=null,this.next=null,this.z=0,this.prevZ=null,this.nextZ=null,this.steiner=!1,this.i=t,this.x=i,this.y=n};function Yj(e,t,i,n,r){var a=0,o=null;if(r===function(e,t,i,n){for(var r=0,a=t,o=i-n;a<i;a+=n)r+=(e[o]-e[a])*(e[a+1]+e[o+1]),o=a;return r}(e,t,i,n)>0)for(a=t;a<i;a+=n)o=_q(a,e[a],e[a+1],o);else for(a=i-n;a>=t;a-=n)o=_q(a,e[a],e[a+1],o);return o&&uq(o,o.next)&&(fq(o),o=o.next),o}function Kj(e){var t=arguments.length>1&&void 0!==arguments[1]?arguments[1]:null;if(!e)return e;t||(t=e);var i=e,n=!1;do{if(n=!1,i.steiner||!uq(i,i.next)&&0!==lq(i.prev,i,i.next))i=i.next;else{if(fq(i),(i=t=i.prev)===i.next)return null;n=!0}}while(n||i!==t);return t}function Zj(e,t,i,n,r,a){var o=arguments.length>6&&void 0!==arguments[6]?arguments[6]:0;if(e){!o&&a&&nq(e,n,r,a);for(var s=e,l=null,u=null;e.prev!==e.next;)if(l=e.prev,u=e.next,a?Jj(e,n,r,a):Qj(e))t.push(l.i/i),t.push(e.i/i),t.push(u.i/i),fq(e),e=u.next,s=u.next;else if((e=u)===s){o?1===o?Zj(e=$j(e,t,i),t,i,n,r,a,2):2===o&&eq(e,t,i,n,r,a):Zj(Kj(e),t,i,n,r,a,1);break}}}function Qj(e){var t=e.prev,i=e,n=e.next;if(lq(t,i,n)>=0)return!1;for(var r=e.next.next;r!==e.prev;){if(oq(t.x,t.y,i.x,i.y,n.x,n.y,r.x,r.y)&&lq(r.prev,r,r.next)>=0)return!1;r=r.next}return!0}function Jj(e,t,i,n){var r=e.prev,a=e,o=e.next;if(lq(r,a,o)>=0)return!1;for(var s=r.x<a.x?r.x<o.x?r.x:o.x:a.x<o.x?a.x:o.x,l=r.y<a.y?r.y<o.y?r.y:o.y:a.y<o.y?a.y:o.y,u=r.x>a.x?r.x>o.x?r.x:o.x:a.x>o.x?a.x:o.x,c=r.y>a.y?r.y>o.y?r.y:o.y:a.y>o.y?a.y:o.y,h=rq(s,l,t,i,n),p=rq(u,c,t,i,n),_=e.nextZ;_&&_.z<=p;){if(_!==e.prev&&_!==e.next&&oq(r.x,r.y,a.x,a.y,o.x,o.y,_.x,_.y)&&lq(_.prev,_,_.next)>=0)return!1;_=_.nextZ}for(_=e.prevZ;_&&_.z>=h;){if(_!==e.prev&&_!==e.next&&oq(r.x,r.y,a.x,a.y,o.x,o.y,_.x,_.y)&&lq(_.prev,_,_.next)>=0)return!1;_=_.prevZ}return!0}function $j(e,t,i){var n=e;do{var r=n.prev,a=n.next.next;!uq(r,a)&&cq(r,n,n.next,a)&&hq(r,a)&&hq(a,r)&&(t.push(r.i/i),t.push(n.i/i),t.push(a.i/i),fq(n),fq(n.next),n=e=a),n=n.next}while(n!==e);return n}function eq(e,t,i,n,r,a){var o=e;do{for(var s=o.next.next;s!==o.prev;){if(o.i!==s.i&&sq(o,s)){var l=pq(o,s);return o=Kj(o,o.next),l=Kj(l,l.next),Zj(o,t,i,n,r,a),void Zj(l,t,i,n,r,a)}s=s.next}o=o.next}while(o!==e)}function tq(e,t){return e.x-t.x}function iq(e,t){if(t=function(e,t){var i=t,n=e.x,r=e.y,a=-1/0,o=null;do{if(r<=i.y&&r>=i.next.y){var s=i.x+(r-i.y)*(i.next.x-i.x)/(i.next.y-i.y);if(s<=n&&s>a){if(a=s,s===n){if(r===i.y)return i;if(r===i.next.y)return i.next}o=i.x<i.next.x?i:i.next}}i=i.next}while(i!==t);if(!o)return null;if(n===a)return o.prev;var l,u=o,c=o.x,h=o.y,p=1/0;i=o.next;for(;i!==u;)n>=i.x&&i.x>=c&&oq(r<h?n:a,r,c,h,r<h?a:n,r,i.x,i.y)&&((l=Math.abs(r-i.y)/(n-i.x))<p||l===p&&i.x>o.x)&&hq(i,e)&&(o=i,p=l),i=i.next;return o}(e,t)){var i=pq(t,e);Kj(i,i.next)}}function nq(e,t,i,n){var r=e;do{null===r.z&&(r.z=rq(r.x,r.y,t,i,n)),r.prevZ=r.prev,r.nextZ=r.next,r=r.next}while(r!==e);r.prevZ.nextZ=null,r.prevZ=null,function(e){var t=0,i=null,n=null,r=null,a=null,o=0,s=0,l=0,u=1;do{for(i=e,e=null,a=null,o=0;i;){for(o++,n=i,s=0,t=0;t<u&&(s++,n=n.nextZ);t++);for(l=u;s>0||l>0&&n;)0===s?(r=n,n=n.nextZ,l--):0!==l&&n?i.z<=n.z?(r=i,i=i.nextZ,s--):(r=n,n=n.nextZ,l--):(r=i,i=i.nextZ,s--),a?a.nextZ=r:e=r,r.prevZ=a,a=r;i=n}a.nextZ=null,u*=2}while(o>1)}(r)}function rq(e,t,i,n,r){return(e=1431655765&((e=858993459&((e=252645135&((e=16711935&((e=32767*(e-i)/r)|e<<8))|e<<4))|e<<2))|e<<1))|(t=1431655765&((t=858993459&((t=252645135&((t=16711935&((t=32767*(t-n)/r)|t<<8))|t<<4))|t<<2))|t<<1))<<1}function aq(e){var t=e,i=e;do{t.x<i.x&&(i=t),t=t.next}while(t!==e);return i}function oq(e,t,i,n,r,a,o,s){return(r-o)*(t-s)-(e-o)*(a-s)>=0&&(e-o)*(n-s)-(i-o)*(t-s)>=0&&(i-o)*(a-s)-(r-o)*(n-s)>=0}function sq(e,t){return e.next.i!==t.i&&e.prev.i!==t.i&&!function(e,t){var i=e;do{if(i.i!==e.i&&i.next.i!==e.i&&i.i!==t.i&&i.next.i!==t.i&&cq(i,i.next,e,t))return!0;i=i.next}while(i!==e);return!1}(e,t)&&hq(e,t)&&hq(t,e)&&function(e,t){var i=e,n=!1,r=(e.x+t.x)/2,a=(e.y+t.y)/2;do{i.y>a!=i.next.y>a&&r<(i.next.x-i.x)*(a-i.y)/(i.next.y-i.y)+i.x&&(n=!n),i=i.next}while(i!==e);return n}(e,t)}function lq(e,t,i){return(t.y-e.y)*(i.x-t.x)-(t.x-e.x)*(i.y-t.y)}function uq(e,t){return e.x===t.x&&e.y===t.y}function cq(e,t,i,n){return!!(uq(e,t)&&uq(i,n)||uq(e,n)&&uq(i,t))||lq(e,t,i)>0!=lq(e,t,n)>0&&lq(i,n,e)>0!=lq(i,n,t)>0}function hq(e,t){return lq(e.prev,e,e.next)<0?lq(e,t,e.next)>=0&&lq(e,e.prev,t)>=0:lq(e,t,e.prev)<0||lq(e,e.next,t)<0}function pq(e,t){var i=new qj(e.i,e.x,e.y),n=new qj(t.i,t.x,t.y),r=e.next,a=t.prev;return e.next=t,t.prev=e,i.next=r,r.prev=i,n.next=i,i.prev=n,a.next=n,n.prev=a,n}function _q(e,t,i,n){var r=new qj(e,t,i);return n?(r.next=n.next,r.prev=n,n.next.prev=r,n.next=r):(r.prev=r,r.next=r),r}function fq(e){e.next.prev=e.prev,e.prev.next=e.next,e.prevZ&&(e.prevZ.nextZ=e.nextZ),e.nextZ&&(e.nextZ.prevZ=e.prevZ)}function dq(e,t,i){i=i||3;var n=t?t.length:0,r=n?t[0]*i:e.length,a=Yj(e,0,r,i,!0),o=[];if(!a)return o;var s=0,l=0,u=0,c=0,h=0,p=0,_=0;if(n&&(a=function(e,t,i,n){var r,a=[],o=0,s=null;for(o=0,r=t.length;o<r;o++)(s=Yj(e,t[o]*n,o<r-1?t[o+1]*n:e.length,n,!1))&&(s===s.next&&(s.steiner=!0),a.push(aq(s)));if(a.sort(tq),!i)return i;for(o=0;o<a.length;o++)iq(a[o],i),i=Kj(i,i.next);return i}(e,t,a,i)),e.length>80*i){s=u=e[0],l=c=e[1];for(var f=i;f<r;f+=i)(h=e[f])<s&&(s=h),(p=e[f+1])<l&&(l=p),h>u&&(u=h),p>c&&(c=p);_=Math.max(u-s,c-l)}return Zj(a,o,i,s,l,_),o}var mq=Math.PI,vq=Math.min,yq=Math.max,gq=Math.cos,xq=Math.sin,bq=Math.abs,Tq=Math.sign,Sq=.5522847493;function Eq(e,t,i,n,r){e.moveTo(t-n,i),e.bezierCurveTo(t-n,i+r*Sq,t-n*Sq,i+r,t,i+r),e.bezierCurveTo(t+n*Sq,i+r,t+n,i+r*Sq,t+n,i),e.bezierCurveTo(t+n,i-r*Sq,t+n*Sq,i-r,t,i-r),e.bezierCurveTo(t-n*Sq,i-r,t-n,i-r*Sq,t-n,i),e.close()}for(var wq=function(e){function t(e,i){var n;return Z(this,t),(n=re(this,te(t).call(this,e,i))).dx=0,n.dy=0,n.dmx=0,n.dmy=0,n.flags=0,n.len=0,n.reset(),n}return ee(t,ki),J(t,[{key:"reset",value:function(){this.dx=0,this.dy=0,this.dmx=0,this.dmy=0,this.flags=0,this.len=0}}]),t}(),Cq=function(){function e(){Z(this,e),this.closed=!1,this.nbevel=0,this.complex=!0,this.points=[],this.reset()}return J(e,[{key:"reset",value:function(){this.closed=!1,this.nbevel=0,this.complex=!0,this.points?this.points.length=0:this.points=[]}}]),e}(),Aq=function(){function e(){Z(this,e),this.dataOffset=0,this.updatePathOffset=!1,this.pathLength=0,this.pathOffset=0,this.paths=[],this.tessTol=.25,this.distTol=.01,this.fillColor=an.WHITE.clone(),this.lineCap=ZB.BUTT,this.strokeColor=an.BLACK.clone(),this.lineJoin=QB.MITER,this.lineWidth=0,this.pointsOffset=0,this._commandx=0,this._commandy=0,this._points=[],this._renderDatasPool=new So((function(){return new UC}),16),this._renderDatas=[],this._curPath=null}return J(e,[{key:"moveTo",value:function(e,t){this.updatePathOffset&&(this.pathOffset=this.pathLength,this.updatePathOffset=!1),this._addPath(),this.addPoint(e,t,JB.PT_CORNER),this._commandx=e,this._commandy=t}},{key:"lineTo",value:function(e,t){this.addPoint(e,t,JB.PT_CORNER),this._commandx=e,this._commandy=t}},{key:"bezierCurveTo",value:function(e,t,i,n,r,a){var o=this._curPath,s=o.points[o.points.length-1];s&&(s.x!==e||s.y!==t||i!==r||n!==a?(!function e(t,i,n,r,a,o,s,l,u,c,h){var p,_,f,d,m,v,y,g,x,b,T,S,E,w,C,A;c>10||(m=.5*(o+l),v=.5*(s+u),y=.5*((p=.5*(i+r))+(f=.5*(r+o))),g=.5*((_=.5*(n+a))+(d=.5*(a+s))),((C=bq((r-l)*(w=u-n)-(a-u)*(E=l-i)))+(A=bq((o-l)*w-(s-u)*E)))*(C+A)<t.tessTol*(E*E+w*w)?t.addPoint(l,u,0===h?h|JB.PT_BEVEL:h):(e(t,i,n,p,_,y,g,T=.5*(y+(x=.5*(f+m))),S=.5*(g+(b=.5*(d+v))),c+1,0),e(t,T,S,x,b,m,v,l,u,c+1,h)))}(this,s.x,s.y,e,t,i,n,r,a,0,JB.PT_CORNER),this._commandx=r,this._commandy=a):this.lineTo(r,a))}},{key:"quadraticCurveTo",value:function(e,t,i,n){var r=this._commandx,a=this._commandy;this.bezierCurveTo(r+2/3*(e-r),a+2/3*(t-a),i+2/3*(e-i),n+2/3*(t-n),i,n)}},{key:"arc",value:function(e,t,i,n,r,a){!function(e,t,i,n,r,a,o){var s,l,u=0,c=0,h=0,p=0,_=0,f=0,d=0,m=0,v=0,y=0,g=0,x=0,b=0,T=0;if(c=a-r,o=o||!1)if(bq(c)>=2*mq)c=2*mq;else for(;c<0;)c+=2*mq;else if(bq(c)>=2*mq)c=2*-mq;else for(;c>0;)c-=2*mq;for(l=0|yq(1,vq(bq(c)/(.5*mq)+.5,5)),h=bq(4/3*(1-gq(s=c/l/2))/xq(s)),o||(h=-h),T=0;T<=l;T++)f=t+(p=gq(u=r+c*(T/l)))*n,d=i+(_=xq(u))*n,m=-_*n*h,v=p*n*h,0===T?e.moveTo(f,d):e.bezierCurveTo(y+x,g+b,f-m,d-v,f,d),y=f,g=d,x=m,b=v}(this,e,t,i,n,r,a)}},{key:"ellipse",value:function(e,t,i,n){Eq(this,e,t,i,n),this._curPath.complex=!1}},{key:"circle",value:function(e,t,i){Eq(this,e,t,i,i),this._curPath.complex=!1}},{key:"rect",value:function(e,t,i,n){this.moveTo(e,t),this.lineTo(e+i,t),this.lineTo(e+i,t+n),this.lineTo(e,t+n),this.close(),this._curPath.complex=!1}},{key:"roundRect",value:function(e,t,i,n,r){!function(e,t,i,n,r,a){if(a<.1)e.rect(t,i,n,r);else{var o=vq(a,.5*bq(n))*Tq(n),s=vq(a,.5*bq(r))*Tq(r);e.moveTo(t,i+s),e.lineTo(t,i+r-s),e.bezierCurveTo(t,i+r-s*(1-Sq),t+o*(1-Sq),i+r,t+o,i+r),e.lineTo(t+n-o,i+r),e.bezierCurveTo(t+n-o*(1-Sq),i+r,t+n,i+r-s*(1-Sq),t+n,i+r-s),e.lineTo(t+n,i+s),e.bezierCurveTo(t+n,i+s*(1-Sq),t+n-o*(1-Sq),i,t+n-o,i),e.lineTo(t+o,i),e.bezierCurveTo(t+o*(1-Sq),i,t,i+s*(1-Sq),t,i+s),e.close()}}(this,e,t,i,n,r),this._curPath.complex=!1}},{key:"clear",value:function(){var e=arguments.length>0&&void 0!==arguments[0]&&arguments[0];this.pathLength=0,this.pathOffset=0,this.pointsOffset=0,this.dataOffset=0,this._curPath=null,this.paths.length=0,this._points.length=0;for(var t=this._renderDatas,i=0,n=t.length;i<n;i++){var r=t[i];r&&r.reset()}this._renderDatas.length=0,e&&this._renderDatasPool.reset()}},{key:"close",value:function(){this._curPath.closed=!0}},{key:"requestRenderData",value:function(){var e=this._renderDatasPool.add();return this._renderDatas.push(e),e}},{key:"getRenderDatas",value:function(){return 0===this._renderDatas.length&&this.requestRenderData(),this._renderDatas}},{key:"addPoint",value:function(e,t,i){var n=this._curPath;if(n){var r=this._points,a=n.points,o=r[this.pointsOffset++];o?(o.x=e,o.y=t):(o=new wq(e,t),r.push(o)),o.flags=i,a.push(o)}}},{key:"_addPath",value:function(){var e=this.pathLength,t=this.paths[e];return t?t.reset():(t=new Cq,this.paths.push(t)),this.pathLength++,this._curPath=t,t}}]),e}(),Oq=Math.PI,kq=Math.min,Rq=Math.max,Fq=Math.ceil,Mq=Math.acos,Iq=Math.cos,Pq=Math.sin,Lq=Math.atan2,Dq=JA,Nq=[],zq=[],Bq=[],Gq=[],Uq=null,Xq=null,Vq=new an,Hq=[],Wq=0;Wq<4;Wq++)Hq.push(new Ii);function jq(e,t,i){return e<t?t:e>i?i:e}var qq={useModel:!0,createImpl:function(e){return new Aq},updateRenderData:function(e){for(var t=e.impl?e.impl.getRenderDatas():[],i=0,n=t.length;i<n;i++)t[i].material=e.material},fillBuffers:function(e,t){},renderIA:function(e,t){},getRenderData:function(e,t){if(!Xq)return null;var i=Xq.getRenderDatas(),n=i[Xq.dataOffset];if(!n)return null;var r=n,a=r?r.vertexCount+t:0;return(a>65535||3*a>131070)&&(++Xq.dataOffset,Xq.dataOffset<i.length?n=i[Xq.dataOffset]:(n=Xq.requestRenderData(),i[Xq.dataOffset]=n),n.material=e.material,r=n),r&&r.vertexCount<a&&r.request(t,3*t),n},stroke:function(e){an.copy(Vq,e.strokeColor),e.impl&&(this._flattenPaths(e.impl),this._expandStroke(e),e.impl.updatePathOffset=!0,this.end(e))},fill:function(e){an.copy(Vq,e.fillColor),this._expandFill(e),e.impl&&(e.impl.updatePathOffset=!0),this.end(e)},end:function(e){e.model&&e.model.inited&&e.model.destroy();var t=e.impl,i=exports.GFXPrimitiveMode.TRIANGLE_LIST,n=t&&t.getRenderDatas();if(n){var r=0;Nq.length=0,zq.length=0,Bq.length=0,Gq.length=0;for(var a,o=_e(n);!(a=o()).done;){var s=a.value,l=s.byteCount>>2,u=s.vData;for(r=0;r<l;)Nq.push(u[r++]),Nq.push(u[r++]),Nq.push(u[r++]),zq.push(u[r++]),zq.push(u[r++]),Bq.push(u[r++]),Bq.push(u[r++]),Bq.push(u[r++]),Bq.push(u[r++]);l=s.indiceCount;var c=s.iData;for(r=0;r<l;)Gq.push(c[r++])}var h=yw({primitiveMode:i,positions:Nq,uvs:zq,colors:Bq,attributes:Dq,indices:Gq},void 0,{calculateBounds:!1});e.model.initialize(e.node),e.model.initSubModel(0,h.renderingSubMeshes[0],e.material),e.markForUpdateRenderData()}},_expandStroke:function(e){var t=.5*e.lineWidth,i=e.lineCap,n=e.lineJoin,r=e.miterLimit;if(Xq=e.impl){var a=function(e,t,i){var n=2*Mq(e/(e+i));return Rq(2,Fq(t/n))}(t,Oq,Xq.tessTol);this._calculateJoins(Xq,t,n,r);for(var o=Xq.paths,s=0,l=Xq.pathOffset,u=Xq.pathLength;l<u;l++){var c=o[l],h=c.points.length;n===QB.ROUND?s+=2*(h+c.nbevel*(a+2)+1):s+=2*(h+5*c.nbevel+1),c.closed||(i===ZB.ROUND?s+=2*(2*a+2):s+=12)}var p=Uq=this.getRenderData(e,s);if(p){for(var _=p.vData,f=p.iData,d=Xq.pathOffset,m=Xq.pathLength;d<m;d++){var v=o[d],y=v.points,g=y.length,x=p.vertexStart,b=void 0,T=void 0,S=0,E=0,w=v.closed;if(w?(b=y[g-1],T=y[0],S=0,E=g):(b=y[0],T=y[1],S=1,E=g-1),!w){var C=new wq(T.x,T.y);C.subtract(b),C.normalize();var A=C.x,O=C.y;i===ZB.BUTT?this._buttCap(b,A,O,t,0):i===ZB.SQUARE?this._buttCap(b,A,O,t,t):i===ZB.ROUND&&this._roundCapStart(b,A,O,t,a)}for(var k=S;k<E;++k)n===QB.ROUND?this._roundJoin(b,T,t,t,a):0!=(T.flags&(JB.PT_BEVEL|JB.PT_INNERBEVEL))?this._bevelJoin(b,T,t,t):(this._vset(T.x+T.dmx*t,T.y+T.dmy*t),this._vset(T.x-T.dmx*t,T.y-T.dmy*t)),b=T,T=y[k+1];if(w){var R=9*x,F=_.slice(R,R+9);_.set(F,9*p.vertexStart),R+=9,p.vertexStart++,F=_.slice(R,R+9),_.set(F,9*p.vertexStart),p.vertexStart++}else{var M=new wq(T.x,T.y);M.subtract(b),M.normalize();var I=M.x,P=M.y;i===ZB.BUTT?this._buttCap(T,I,P,t,0):i===ZB.SQUARE?this._buttCap(T,I,P,t,t):i===ZB.ROUND&&this._roundCapEnd(T,I,P,t,a)}for(var L=p.indiceStart,D=x+2,N=p.vertexStart;D<N;D++)f[L++]=D-2,f[L++]=D-1,f[L++]=D;if(p.indiceStart=L,L!==p.indiceCount){var z=new Array(p.indiceCount-L);p.iData.set(z,L)}}Uq=null,Xq=null}}},_expandFill:function(e){if(Xq=e.impl){for(var t=Xq.paths,i=0,n=Xq.pathOffset,r=Xq.pathLength;n<r;n++){i+=t[n].points.length}var a=Uq=this.getRenderData(e,i);if(a){for(var o=a,s=o.vData,l=o.iData,u=Xq.pathOffset,c=Xq.pathLength;u<c;u++){var h=t[u],p=h.points,_=p.length;if(0!==_){for(var f=a.vertexStart,d=0;d<_;++d)this._vset(p[d].x,p[d].y);var m=a.indiceStart;if(h.complex){for(var v=[],y=f,g=a.vertexStart;y<g;y++){var x=9*y;v.push(s[x++]),v.push(s[x++]),v.push(s[x++])}var b=dq(v,null,3);if(!b||0===b.length)continue;for(var T=0,S=b.length;T<S;T++)l[m++]=b[T]+f}else for(var E=f,w=f+2,C=o.vertexStart;w<C;w++)l[m++]=E,l[m++]=w-1,l[m++]=w;if(o.indiceStart=m,m!==o.indiceCount){var A=new Array(o.indiceCount-m);o.iData.set(A,m)}}}Uq=null,Xq=null}}},_calculateJoins:function(e,t,i,n){var r=0;t>0&&(r=1/t);for(var a=e.paths,o=e.pathOffset,s=e.pathLength;o<s;o++){var l=a[o],u=l.points,c=u.length,h=u[c-1],p=u[0];l.nbevel=0;for(var _=0;_<c;_++){var f,d,m=h.dy,v=-h.dx,y=p.dy,g=-p.dx;if(p.dmx=.5*(m+y),p.dmy=.5*(v+g),(f=p.dmx*p.dmx+p.dmy*p.dmy)>1e-6){var x=1/f;x>600&&(x=600),p.dmx*=x,p.dmy*=x}p.dx*h.dy-h.dx*p.dy>0&&(p.flags|=JB.PT_LEFT),f*(d=Rq(11,kq(h.len,p.len)*r))*d<1&&(p.flags|=JB.PT_INNERBEVEL),p.flags&JB.PT_CORNER&&(f*n*n<1||i===QB.BEVEL||i===QB.ROUND)&&(p.flags|=JB.PT_BEVEL),0!=(p.flags&(JB.PT_BEVEL|JB.PT_INNERBEVEL))&&l.nbevel++,h=p,p=u[_+1]}}},_flattenPaths:function(e){for(var t=e.paths,i=e.pathOffset,n=e.pathLength;i<n;i++){var r=t[i],a=r.points,o=a[a.length-1],s=a[0];o.equals(s)&&(r.closed=!0,a.pop(),o=a[a.length-1]);for(var l=0,u=a.length;l<u;l++){var c=new wq(s.x,s.y);c.subtract(o),o.len=c.length(),(c.x||c.y)&&c.normalize(),o.dx=c.x,o.dy=c.y,o=s,s=a[l+1]}}},_chooseBevel:function(e,t,i,n){var r=i.x,a=i.y,o=0,s=0,l=0,u=0;return 0!==e?(o=r+t.dy*n,s=a-t.dx*n,l=r+i.dy*n,u=a-i.dx*n):(o=l=r+i.dmx*n,s=u=a+i.dmy*n),[o,s,l,u]},_buttCap:function(e,t,i,n,r){var a=e.x-t*r,o=e.y-i*r,s=i,l=-t;this._vset(a+s*n,o+l*n),this._vset(a-s*n,o-l*n)},_roundCapStart:function(e,t,i,n,r){for(var a=e.x,o=e.y,s=i,l=-t,u=0;u<r;u++){var c=u/(r-1)*Oq,h=Iq(c)*n,p=Pq(c)*n;this._vset(a-s*h-t*p,o-l*h-i*p),this._vset(a,o)}this._vset(a+s*n,o+l*n),this._vset(a-s*n,o-l*n)},_roundCapEnd:function(e,t,i,n,r){var a=e.x,o=e.y,s=i,l=-t;this._vset(a+s*n,o+l*n),this._vset(a-s*n,o-l*n);for(var u=0;u<r;u++){var c=u/(r-1)*Oq,h=Iq(c)*n,p=Pq(c)*n;this._vset(a,o),this._vset(a-s*h+t*p,o-l*h+i*p)}},_roundJoin:function(e,t,i,n,r){var a=e.dy,o=-e.dx,s=t.dy,l=-t.dx,u=t.x,c=t.y;if(0!=(t.flags&JB.PT_LEFT)){var h=this._chooseBevel(t.flags&JB.PT_INNERBEVEL,e,t,i),p=h[0],_=h[1],f=h[2],d=h[3],m=Lq(-o,-a),v=Lq(-l,-s);v>m&&(v-=2*Oq),this._vset(p,_),this._vset(u-a*n,t.y-o*n);for(var y=jq(Fq((m-v)/Oq)*r,2,r),g=0;g<y;g++){var x=m+g/(y-1)*(v-m),b=u+Iq(x)*n,T=c+Pq(x)*n;this._vset(u,c),this._vset(b,T)}this._vset(f,d),this._vset(u-s*n,c-l*n)}else{var S=this._chooseBevel(t.flags&JB.PT_INNERBEVEL,e,t,-n),E=S[0],w=S[1],C=S[2],A=S[3],O=Lq(o,a),k=Lq(l,s);k<O&&(k+=2*Oq),this._vset(u+a*n,c+o*n,0),this._vset(E,w,0);for(var R=jq(Fq((k-O)/Oq)*r,2,r),F=0;F<R;F++){var M=O+F/(R-1)*(k-O),I=u+Iq(M)*i,P=c+Pq(M)*i;this._vset(I,P,0),this._vset(u,c,0)}this._vset(u+s*n,c+l*n),this._vset(C,A)}},_bevelJoin:function(e,t,i,n){var r=0,a=0,o=0,s=0,l=0,u=0,c=0,h=0,p=e.dy,_=-e.dx,f=t.dy,d=-t.dx;if(t.flags&JB.PT_LEFT){var m=this._chooseBevel(t.flags&JB.PT_INNERBEVEL,e,t,i);l=m[0],u=m[1],c=m[2],h=m[3],this._vset(l,u,0),this._vset(t.x-p*n,t.y-_*n,0),this._vset(c,h,0),this._vset(t.x-f*n,t.y-d*n,0)}else{var v=this._chooseBevel(t.flags&JB.PT_INNERBEVEL,e,t,-n);r=v[0],a=v[1],o=v[2],s=v[3],this._vset(t.x+p*i,t.y+_*i,0),this._vset(r,a),this._vset(t.x+f*i,t.y+d*i,0),this._vset(o,s)}},_vset:function(e,t){if(Uq){var i=Uq,n=9*i.vertexStart,r=i.vData;r[n++]=e,r[n++]=t,r[n++]=0,r[n++]=1,r[n++]=1,an.toArray(r,Vq,n),i.vertexStart++}}},Yq={getAssembler:function(e){return qq}};BG.Assembler=Yq;var Kq=function e(){Z(this,e),this.u=0,this.v=0,this.width=0,this.height=0,this.offsetX=0,this.offsetY=0,this.textureID=0,this.validDefinition=!1,this.xAdvance=0},Zq=function(){function e(){Z(this,e),this._letterDefinitions={}}return J(e,[{key:"addLetterDefinitions",value:function(e,t){this._letterDefinitions[e]=t}},{key:"cloneLetterDefinition",value:function(){for(var e={},t=0,i=Object.keys(this._letterDefinitions);t<i.length;t++){var n=i[t],r=new Kq;Ue(r,this._letterDefinitions[n]),e[n]=r}return e}},{key:"assignLetterDefinitions",value:function(e){for(var t=0,i=Object.keys(this._letterDefinitions);t<i.length;t++){var n=i[t],r=e[n];Ue(this._letterDefinitions[n],r)}}},{key:"scaleFontLetterDefinition",value:function(e){for(var t=0,i=Object.keys(this._letterDefinitions);t<i.length;t++){var n=i[t],r=this._letterDefinitions[n];r.width*=e,r.height*=e,r.offsetX*=e,r.offsetY*=e,r.xAdvance*=e}}},{key:"getLetterDefinitionForChar",value:function(e){return this._letterDefinitions[e.charCodeAt(0)]}},{key:"letterDefinitions",get:function(){return this._letterDefinitions}}]),e}();cc.FontAtlas=Zq;var Qq=function e(){Z(this,e),this.char="",this.valid=!0,this.positionX=0,this.positionY=0,this.lineIndex=0},Jq=new nn,$q=null,eY=[],tY=[],iY=[],nY=[],rY=new en,aY=null,oY=null,sY=0,lY=0,uY=0,cY=0,hY=0,pY=1,_Y=null,fY="",dY=0,mY=0,vY=new en,yY=0,gY=0,xY=0,bY=0,TY=0,SY=!1,EY=0,wY=0,CY=0,AY={createData:function(e){return e.requestRenderData()},fillBuffers:function(e,t){lN(e.node,t,e.renderData,e.color)},appendQuad:function(e,t,i,n,r,a,o){var s=e.renderData;if(s){var l=s.dataLength;s.dataLength+=4,s.vertexCount=s.dataLength,s.indiceCount=s.dataLength/2*3;var u=s.datas,c=t.width,h=t.height,p=i.width,_=i.height,f=0,d=0,m=0,v=0;n?(f=i.x/c,v=(i.x+_)/c,d=(i.y+p)/h,m=i.y/h,u[l].u=f,u[l].v=m,u[l+1].u=f,u[l+1].v=d,u[l+2].u=v,u[l+2].v=m,u[l+3].u=v,u[l+3].v=d):(f=i.x/c,v=(i.x+p)/c,d=(i.y+_)/h,m=i.y/h,u[l].u=f,u[l].v=d,u[l+1].u=v,u[l+1].v=d,u[l+2].u=f,u[l+2].v=m,u[l+3].u=v,u[l+3].v=m),u[l].x=r,u[l].y=a-_*o,u[l+1].x=r+p*o,u[l+1].y=a-_*o,u[l+2].x=r,u[l+2].y=a,u[l+3].x=r+p*o,u[l+3].y=a}}};Ge(AY,{updateRenderData:function(e){e.renderData&&e.renderData.vertDirty&&$q!==e&&($q=e,this._updateProperties(),this._updateContent(),$q.actualFontSize=dY,$q.node.setContentSize(vY),$q.renderData.vertDirty=$q.renderData.uvDirty=!1,$q=null,this._resetProperties())},_updateFontScale:function(){pY=dY/mY},_updateProperties:function(){if($q){var e=$q.font;if(e){if(_Y=e.spriteFrame,oY=e.fntConfig,!(aY=$q.fontAtlas)){aY=new Zq;for(var t=oY.fontDefDictionary,i=0,n=Object.keys(t);i<n.length;i++){var r=n[i],a=new Kq,o=t[r].rect;a.offsetX=t[r].xOffset,a.offsetY=t[r].yOffset,a.width=o.width,a.height=o.height,a.u=o.x,a.v=o.y,a.textureID=0,a.validDefinition=!0,a.xAdvance=t[r].xAdvance,aY.addLetterDefinitions(r,a)}$q.fontAtlas=aY}fY=$q.string.toString(),dY=$q.fontSize,mY=oY.fontSize;var s=$q.node.getContentSize();vY.width=s.width,vY.height=s.height,yY=$q.horizontalAlign,gY=$q.verticalAlign,xY=$q.spacingX,TY=$q.overflow,bY=$q.lineHeight,SY=TY!==exports.Overflow.NONE&&(TY===exports.Overflow.RESIZE_HEIGHT||$q.enableWrapText),this._setupBMFontOverflowMetrics()}}},_resetProperties:function(){aY=null,oY=null,_Y=null},_updateContent:function(){this._updateFontScale(),this._computeHorizontalKerningForText(),this._alignText()},_computeHorizontalKerningForText:function(){for(var e=fY,t=e.length,i=oY.kerningDict,n=eY,r=-1,a=0;a<t;++a){var o=e.charCodeAt(a),s=i[r<<16|65535&o]||0;n[a]=a<t-1?s:0,r=o}},_multilineTextWrap:function(e){var t=fY.length,i=0,n=0,r=0,a=0,o=0,s=0,l=0,u=null,c=new ki;this._updateFontScale();for(var h=aY.letterDefinitions,p=0;p<t;){var _=fY.charAt(p);if("\n"!==_){for(var f=e(fY,p,t),d=s,m=l,v=o,y=n,g=!1,x=0;x<f;++x){var b=p+x;if("\r"!==(_=fY.charAt(b)))if(u=aY&&aY.getLetterDefinitionForChar(_)){var T=y+u.offsetX*pY;if(SY&&CY>0&&n>0&&T+u.width*pY>CY&&!Mo(_)){iY.push(o),o=0,i++,n=0,r-=bY*pY+0,g=!0;break}c.x=T,c.y=r-u.offsetY*pY,this._recordLetterInfo(h,c,_,b,i),b+1<eY.length&&b<t-1&&(y+=eY[b+1]),y+=u.xAdvance*pY+xY,v=c.x+u.width*pY,d<c.y&&(d=c.y),m>c.y-u.height*pY&&(m=c.y-u.height*pY)}else this._recordPlaceholderInfo(b,_),console.log("Can't find letter definition in texture atlas "+oY.atlasName+" for letter:"+_);else this._recordPlaceholderInfo(b,_)}g||(n=y,s<d&&(s=d),l>m&&(l=m),a<(o=v)&&(a=o),p+=f)}else iY.push(o),o=0,i++,n=0,r-=bY*pY+0,this._recordPlaceholderInfo(p,_),p++}return iY.push(o),lY=(sY=i+1)*bY*pY,sY>1&&(lY+=0*(sY-1)),vY.width=EY,vY.height=wY,EY<=0&&(vY.width=parseFloat(a.toFixed(2))),wY<=0&&(vY.height=parseFloat(lY.toFixed(2))),cY=vY.height,hY=0,s>0&&(cY=vY.height+s),l<-lY&&(hY=lY+l),!0},_getFirstCharLen:function(){return 1},_getFirstWordLen:function(e,t,i){var n=e.charAt(t);if(Fo(n)||"\n"===n||Mo(n))return 1;var r=1,a=aY&&aY.getLetterDefinitionForChar(n);if(!a)return r;for(var o=a.xAdvance*pY+xY,s=t+1;s<i&&(n=e.charAt(s),a=aY&&aY.getLetterDefinitionForChar(n));++s){if(o+a.offsetX*pY+a.width*pY>CY&&!Mo(n)&&CY>0)return r;if(o+=a.xAdvance*pY+xY,"\n"===n||Mo(n)||Fo(n))break;r++}return r},_multilineTextWrapByWord:function(){return this._multilineTextWrap(this._getFirstWordLen)},_multilineTextWrapByChar:function(){return this._multilineTextWrap(this._getFirstCharLen)},_recordPlaceholderInfo:function(e,t){if(e>=tY.length){var i=new Qq;tY.push(i)}tY[e].char=t,tY[e].valid=!1},_recordLetterInfo:function(e,t,i,n,r){if(n>=tY.length){var a=new Qq;tY.push(a)}var o=i.charCodeAt(0);tY[n].lineIndex=r,tY[n].char=i,tY[n].valid=e[o].validDefinition,tY[n].positionX=t.x,tY[n].positionY=t.y},_alignText:function(){lY=0,iY.length=0,this._multilineTextWrapByWord(),this._computeAlignmentOffset(),TY===exports.Overflow.SHRINK&&dY>0&&this._isVerticalClamp()&&this._shrinkLabelToContentSize(this._isVerticalClamp),this._updateQuads()||TY===exports.Overflow.SHRINK&&this._shrinkLabelToContentSize(this._isHorizontalClamp)},_scaleFontSizeDown:function(e){var t=!0;e||(e=.1,t=!1),dY=e,t&&this._updateContent()},_shrinkLabelToContentSize:function(e){for(var t=dY,i=bY,n=aY,r=0,a=n?n.cloneLetterDefinition():{},o=!0;e();){var s=t-++r;if(o=!1,s<=0)break;var l=s/t;n&&(n.assignLetterDefinitions(a),n.scaleFontLetterDefinition(l)),bY=i*l,this._multilineTextWrapByWord(),this._computeAlignmentOffset()}bY=i,n&&n.assignLetterDefinitions(a),o||t-r>=0&&this._scaleFontSizeDown(t-r)},_isVerticalClamp:function(){return lY>vY.height},_isHorizontalClamp:function(){if(aY){for(var e=!1,t=0,i=fY.length;t<i;++t){var n=tY[t];if(n.valid){var r=aY.getLetterDefinitionForChar(n.char);if(!r)continue;var a=n.positionX+r.width/2*pY,o=n.lineIndex;if(EY>0)if(SY){if(iY[o]>vY.width&&(a>vY.width||a<0)){e=!0;break}}else if(a>vY.width){e=!0;break}}}return e}},_isHorizontalClamped:function(e,t){var i=iY[t],n=e>vY.width||e<0;return SY?i>vY.width&&n:n},_updateQuads:function(){if(!$q)return!1;var e=aY?aY.letterDefinitions:{},t=_Y,i=$q.node,n=$q.renderData;n.dataLength=n.vertexCount=n.indiceCount=0;for(var r=i.getAnchorPoint(),a=vY,o=r.x*a.width,s=r.y*a.height,l=!0,u=0,c=fY.length;u<c;++u){var h=tY[u];if(h.valid){var p=e[h.char.charCodeAt(0)];if(p){Jq.height=p.height,Jq.width=p.width,Jq.x=p.u,Jq.y=p.v;var _=h.positionY+uY;if(wY>0){if(_>cY){var f=_-cY;Jq.y+=f,Jq.height-=f,_-=f}_-p.height*pY<hY&&(Jq.height=_<hY?0:_-hY)}var d=h.lineIndex,m=h.positionX+p.width/2*pY+nY[d];if(EY>0&&this._isHorizontalClamped(m,d))if(TY===exports.Overflow.CLAMP)Jq.width=0;else if(TY===exports.Overflow.SHRINK){if(vY.width>p.width){l=!1;break}Jq.width=0}if(_Y&&Jq.height>0&&Jq.width>0){var v=_Y.isRotated(),y=_Y.getOriginalSize(),g=_Y.getRect(),x=_Y.getOffset(),b=x.x+(y.width-g.width)/2,T=x.y-(y.height-g.height)/2;if(v){var S=Jq.x;Jq.x=g.x+g.height-Jq.y-Jq.height-T,Jq.y=S+g.y-b,Jq.y<0&&(Jq.height=Jq.height+T)}else Jq.x+=g.x-b,Jq.y+=g.y+T;var E=h.positionX+nY[h.lineIndex];this.appendQuad($q,t,Jq,v,E-o,_-s,pY)}}else console.warn("Can't find letter in this bitmap-font")}}return l},appendQuad:function(e,t,i,n,r,a,o){},_computeAlignmentOffset:function(){switch(nY.length=0,yY){case exports.HorizontalTextAlignment.LEFT:for(var e=0;e<sY;++e)nY.push(0);break;case exports.HorizontalTextAlignment.CENTER:for(var t=0,i=iY.length;t<i;t++)nY.push((vY.width-iY[t])/2);break;case exports.HorizontalTextAlignment.RIGHT:for(var n=0,r=iY.length;n<r;n++)nY.push(vY.width-iY[n])}switch(gY){case exports.VerticalTextAlignment.TOP:uY=vY.height;break;case exports.VerticalTextAlignment.CENTER:uY=(vY.height+lY)/2;break;case exports.VerticalTextAlignment.BOTTOM:uY=lY}},_setupBMFontOverflowMetrics:function(){var e=vY.width,t=vY.height;TY===exports.Overflow.RESIZE_HEIGHT&&(t=0),TY===exports.Overflow.NONE&&(e=0,t=0),EY=e,wY=t,rY.width=e,rY.height=t,CY=e}});var OY=iz.Overflow,kY=an.WHITE.clone(),RY=iz.HorizontalAlign,FY=iz.VerticalAlign,MY=function e(){Z(this,e),this.char="",this.valid=!0,this.x=0,this.y=0,this.line=0,this.hash=""},IY=function e(){Z(this,e),this.u=0,this.v=0,this.w=0,this.h=0,this.texture=null,this.offsetX=0,this.offsetY=0,this.valid=!1,this.xAdvance=0},PY=function(){function e(t,i){Z(this,e),this.image=null,this.labelInfo=void 0,this.char=void 0,this.data=null,this.canvas=null,this.context=null,this.width=0,this.height=0,this.hash=void 0,this.char=t,this.labelInfo=i,this.hash=t.charCodeAt(0)+i.hash}return J(e,[{key:"updateRenderData",value:function(){this._updateProperties(),this._updateTexture()}},{key:"destroy",value:function(){this.image=null}},{key:"_updateProperties",value:function(){if(this.data=iz._canvasPool.get(),this.canvas=this.data.canvas,this.context=this.data.context,this.context){this.context.font=this.labelInfo.fontDesc;var e=Io(this.context,this.char);this.width=parseFloat(e.toFixed(2)),this.height=this.labelInfo.fontSize}this.canvas.width!==this.width&&(this.canvas.width=this.width),this.canvas.height!==this.height&&(this.canvas.height=this.height),this.image||(this.image=new Gl),this.image.reset(this.canvas)}},{key:"_updateTexture",value:function(){if(this.context&&this.canvas){var e=this.context,t=this.labelInfo,i=this.canvas.width,n=this.canvas.height;e.textAlign="center",e.textBaseline="middle",e.clearRect(0,0,i,n),e.fillStyle="rgba(255, 255, 255, 0.005)",e.fillRect(0,0,i,n),e.font=t.fontDesc;var r=i/2,a=n/2,o=t.color;if(e.lineJoin="round",e.fillStyle="rgba(".concat(o.r,", ").concat(o.g,", ").concat(o.b,", ",1,")"),t.isOutlined){var s=t.out||kY;e.strokeStyle="rgba(".concat(s.r,", ").concat(s.g,", ").concat(s.b,", ").concat(s.a/255,")"),e.lineWidth=2*t.margin,e.strokeText(this.char,r,a)}e.fillText(this.char,r,a)}}}]),e}(),LY=function(e){function t(){return Z(this,t),re(this,te(t).apply(this,arguments))}return ee(t,gu),J(t,[{key:"initWithSize",value:function(e,t){var i=arguments.length>2&&void 0!==arguments[2]?arguments[2]:Ol.RGBA8888;this.reset({width:e,height:t,format:i}),this.loaded=!0,this.emit("load")}},{key:"drawTextureAt",value:function(e,t,i){var n=this.getGFXTexture();if(e&&n){var r=this._getGFXDevice();if(r){var a={buffOffset:0,buffStride:0,buffTexHeight:0,texOffset:{x:t,y:i,z:0},texExtent:{width:e.width,height:e.height,depth:1},texSubres:{baseMipLevel:0,levelCount:1,baseArrayLayer:0,layerCount:1}};r.copyTexImagesToTexture([e.data],n,[a])}else console.warn("Unable to get device")}}}]),t}(),DY=function(){function e(t,i){Z(this,e),this.texture=void 0,this._x=2,this._y=2,this._nextY=2,this._width=0,this._height=0,this._letterDefinitions=new Map,this._dirty=!1,this.texture=new LY,this.texture.initWithSize(t,i),this._width=t,this._height=i,_O.on(iO.EVENT_BEFORE_SCENE_LAUNCH,this.beforeSceneLoad,this)}return J(e,[{key:"width",get:function(){return this._width}},{key:"height",get:function(){return this._height}}]),J(e,[{key:"insertLetterTexture",value:function(e){var t=e.image,i=_O.root.device;if(!t||!this.texture||!i)return null;var n=t.width,r=t.height;if(this._x+n+2>this._width&&(this._x=2,this._y=this._nextY),this._y+r>this._nextY&&(this._nextY=this._y+r+2),this._nextY>this._height)return null;this.texture.drawTextureAt(t,this._x,this._y),this._dirty=!0;var a=new IY;return a.u=this._x,a.v=this._y,a.texture=this.texture,a.valid=!0,a.w=e.width,a.h=e.height,a.xAdvance=e.width,this._x+=n+2,this._letterDefinitions.set(e.hash,a),a}},{key:"update",value:function(){this._dirty&&(this._dirty=!1)}},{key:"reset",value:function(){this._x=2,this._y=2,this._nextY=2,this._letterDefinitions.clear()}},{key:"destroy",value:function(){this.reset(),this.texture&&this.texture.destroy()}},{key:"beforeSceneLoad",value:function(){this.destroy();var e=new LY;e.initWithSize(this._width,this._height),this.texture=e}},{key:"getLetter",value:function(e){return this._letterDefinitions.get(e)}},{key:"addLetterDefinitions",value:function(e,t){this._letterDefinitions[e]=t}},{key:"cloneLetterDefinition",value:function(){for(var e={},t=0,i=Object.keys(this._letterDefinitions);t<i.length;t++){var n=i[t],r=new IY;Ue(r,this._letterDefinitions[n]),e[n]=r}return e}},{key:"assignLetterDefinitions",value:function(e){var t=this;e.forEach((function(e,i){Ue(t._letterDefinitions[i],e)}))}},{key:"scaleFontLetterDefinition",value:function(e){for(var t=0,i=Object.keys(this._letterDefinitions);t<i.length;t++){var n=i[t],r=this._letterDefinitions[n];r.w*=e,r.h*=e,r.offsetX*=e,r.offsetY*=e,r.xAdvance*=e}}},{key:"getLetterDefinitionForChar",value:function(e,t){var i=e.charCodeAt(0)+t.hash,n=this._letterDefinitions.get(i);if(!n){var r=new PY(e,t);r.updateRenderData(),n=this.insertLetterTexture(r),r.destroy()}return n}}]),e}(),NY=new nn,zY=null,BY=[],GY=[],UY=[],XY=[],VY=new en,HY=null,WY=0,jY=0,qY=0,YY=0,KY=0,ZY=1,QY="",JY=0,$Y=0,eK=new en,tK=0,iK=0,nK=0,rK=0,aK=0,oK=!1,sK=0,lK=0,uK=0,cK="",hK=!1,pK={fontSize:0,lineHeight:0,hash:"",fontFamily:"",fontDesc:"Arial",hAlign:0,vAlign:0,color:kY,isOutlined:!1,out:kY,margin:0},_K={getAssemblerData:function(){return HY||(HY=new DY(1024,1024)),HY.texture},updateRenderData:function(e){e.renderData&&e.renderData.vertDirty&&zY!==e&&(zY=e,this._updateFontFamily(e),pK.fontFamily=cK,this._updateProperties(),pK.fontDesc=this._getFontDesc(),this._updateContent(),zY.actualFontSize=JY,zY.node.setContentSize(eK),zY.renderData.vertDirty=zY.renderData.uvDirty=!1,zY=null,this._resetProperties())},_updateFontScale:function(){ZY=JY/$Y},_updateProperties:function(){if(zY){QY=zY.string.toString(),JY=zY.fontSize,$Y=JY;var e=zY.node.getContentSize();eK.width=e.width,eK.height=e.height,tK=zY.horizontalAlign,iK=zY.verticalAlign,nK=zY.spacingX,aK=zY.overflow,rK=zY.lineHeight,hK=zY.isBold,oK=aK!==OY.NONE&&(aK===OY.RESIZE_HEIGHT||zY.enableWrapText);var t=zY.getComponent(jU);t&&t.enabled?(pK.isOutlined=!0,pK.margin=t.width,pK.out=t.color,pK.out.a=t.color.a*zY.color.a/255):(pK.isOutlined=!1,pK.margin=0),pK.lineHeight=rK,pK.fontSize=JY,pK.fontFamily=cK,pK.color=zY.color,pK.hash=this._computeHash(pK),this._setupBMFontOverflowMetrics()}},_updateFontFamily:function(e){e.useSystemFont?cK=e.fontFamily:e.font?e.font._nativeAsset?cK=e.font._nativeAsset:(cK=Ym.getRes(e.font.nativeUrl)||"")||Ym.load(e.font.nativeUrl,(function(t,i){cK=i||"Arial",e.font&&(e.font._nativeAsset=i),e.updateRenderData(!0)})):cK="Arial"},_computeHash:function(e){var t=e.color.toHEX("#rrggbb"),i="";return e.isOutlined&&(i=e.out.toHEX("#rrggbb")),""+e.fontSize+e.fontFamily+t+i},_getFontDesc:function(){var e=JY.toString()+"px ";return e+=cK,hK&&(e="bold "+e),e},_resetProperties:function(){},_updateContent:function(){this._updateFontScale(),this._alignText()},_computeHorizontalKerningForText:function(){},_multilineTextWrap:function(e){var t=QY.length,i=0,n=0,r=0,a=0,o=0,s=0,l=0,u=null,c=new ki(0,0);this._updateFontScale();for(var h=0;h<t;){var p=QY.charAt(h);if("\n"!==p){for(var _=e(QY,h,t),f=s,d=l,m=o,v=n,y=!1,g=0;g<_;++g){var x=h+g;if("\r"!==(p=QY.charAt(x)))if(u=HY&&HY.getLetterDefinitionForChar(p,pK)){var b=v+u.offsetX*ZY;if(oK&&uK>0&&n>0&&b+u.w*ZY>uK&&!Mo(p)){UY.push(o),o=0,i++,n=0,r-=rK*ZY+0,y=!0;break}c.x=b,c.y=r-u.offsetY*ZY,this._recordLetterInfo(c,p,x,i),x+1<BY.length&&x<t-1&&(v+=BY[x+1]),v+=u.xAdvance*ZY+nK,m=c.x+u.w*ZY,f<c.y&&(f=c.y),d>c.y-u.h*ZY&&(d=c.y-u.h*ZY)}else this._recordPlaceholderInfo(x,p);else this._recordPlaceholderInfo(x,p)}y||(n=v,s<f&&(s=f),l>d&&(l=d),a<(o=m)&&(a=o),h+=_)}else UY.push(o),o=0,i++,n=0,r-=rK*ZY+0,this._recordPlaceholderInfo(h,p),h++}return UY.push(o),jY=(WY=i+1)*rK*ZY,WY>1&&(jY+=0*(WY-1)),eK.width=sK,eK.height=lK,sK<=0&&(eK.width=parseFloat(a.toFixed(2))),lK<=0&&(eK.height=parseFloat(jY.toFixed(2))),YY=eK.height,KY=0,s>0&&(YY=eK.height+s),l<-jY&&(KY=jY+l),!0},_getFirstCharLen:function(){return 1},_getFirstWordLen:function(e,t,i){var n=e.charAt(t);if(Fo(n)||"\n"===n||Mo(n))return 1;if(HY){var r=1,a=HY.getLetterDefinitionForChar(n,pK);if(!a)return r;for(var o=a.xAdvance*ZY+nK,s=t+1;s<i&&(n=e.charAt(s),a=HY.getLetterDefinitionForChar(n,pK));++s){if(o+a.offsetX*ZY+a.w*ZY>uK&&!Mo(n)&&uK>0)return r;if(o+=a.xAdvance*ZY+nK,"\n"===n||Mo(n)||Fo(n))break;r++}return r}},_multilineTextWrapByWord:function(){return this._multilineTextWrap(this._getFirstWordLen)},_multilineTextWrapByChar:function(){return this._multilineTextWrap(this._getFirstCharLen)},_recordPlaceholderInfo:function(e,t){if(e>=GY.length){var i=new MY;GY.push(i)}GY[e].char=t,GY[e].hash=t.charCodeAt(0)+pK.hash,GY[e].valid=!1},_recordLetterInfo:function(e,t,i,n){if(i>=GY.length){var r=new MY;GY.push(r)}var a=t.charCodeAt(0)+pK.hash;GY[i].line=n,GY[i].char=t,GY[i].hash=a;var o=HY&&HY.getLetter(a);GY[i].valid=!!o&&!!o.valid,GY[i].x=e.x,GY[i].y=e.y},_alignText:function(){jY=0,UY.length=0,this._multilineTextWrapByWord(),this._computeAlignmentOffset(),this._updateQuads()},_scaleFontSizeDown:function(e){var t=!0;e||(e=.1,t=!1),JY=e,t&&this._updateContent()},_isVerticalClamp:function(){return jY>eK.height},_isHorizontalClamp:function(){for(var e=!1,t=0,i=QY.length;t<i;++t){var n=GY[t];if(n.valid){var r=HY.getLetter(n.hash);if(!r)continue;var a=n.x+r.w*ZY,o=n.line;if(sK>0)if(oK){if(UY[o]>eK.width&&(a>eK.width||a<0)){e=!0;break}}else if(a>eK.width){e=!0;break}}}return e},_isHorizontalClamped:function(e,t){var i=UY[t],n=e>eK.width||e<0;return oK?i>eK.width&&n:n},_updateQuads:function(){if(zY&&HY){var e=HY.texture,t=zY.node,i=zY.renderData;i.dataLength=i.vertexCount=i.indiceCount=0;for(var n=eK,r=t.getAnchorPoint(),a=r.x*n.width,o=r.y*n.height,s=!0,l=0,u=QY.length;l<u;++l){var c=GY[l];if(c.valid){var h=HY.getLetter(c.hash);if(h){NY.height=h.h,NY.width=h.w,NY.x=h.u,NY.y=h.v;var p=c.y+qY;if(lK>0){if(p>YY){var _=p-YY;NY.y+=_,NY.height-=_,p-=_}p-h.h*ZY<KY&&(NY.height=p<KY?0:p-KY)}var f=c.line,d=c.x+h.w/2*ZY+XY[f];if(sK>0&&this._isHorizontalClamped(d,f))if(aK===OY.CLAMP)NY.width=0;else if(aK===OY.SHRINK){if(eK.width>h.w){s=!1;break}NY.width=0}if(NY.height>0&&NY.width>0){var m=c.x+XY[c.line];this.appendQuad(zY,e,NY,!1,m-a,p-o,ZY)}}}}return s}},appendQuad:function(e,t,i,n,r,a,o){},_computeAlignmentOffset:function(){switch(XY.length=0,tK){case RY.LEFT:for(var e=0;e<WY;++e)XY.push(0);break;case RY.CENTER:for(var t=0,i=UY.length;t<i;t++)XY.push((eK.width-UY[t])/2);break;case RY.RIGHT:for(var n=0,r=UY.length;n<r;n++)XY.push(eK.width-UY[n])}switch(iK){case FY.TOP:qY=eK.height;break;case FY.CENTER:qY=(eK.height+jY)/2-(rK-JY)/2;break;case FY.BOTTOM:qY=(eK.height+jY)/2-(rK-JY)}},_setupBMFontOverflowMetrics:function(){var e=eK.width,t=eK.height;aK===OY.RESIZE_HEIGHT&&(t=0),aK===OY.NONE&&(e=0,t=0),sK=e,lK=t,VY.width=e,VY.height=t,uK=e}},fK=new an(255,255,255,255),dK={createData:function(e){return e.requestRenderData()},fillBuffers:function(e,t){if(e.renderData){var i=e.node;fK.a=e.color.a,lN(i,t,e.renderData,fK)}},appendQuad:AY.appendQuad};Ge(dK,_K);var mK=iz.Overflow,vK=an.WHITE.clone(),yK=He(jU,rp),gK=null,xK=null,bK=null,TK="",SK="",EK=0,wK=0,CK=[],AK=new en,OK=0,kK=0,RK=0,FK=new an,MK="",IK=mK.NONE,PK=!1,LK=!1,DK=new an,NK=0,zK=0,BK=!1,GK=!1,UK=!1,XK={getAssemblerData:function(){var e=iz._canvasPool.get();return e.canvas.width=e.canvas.height=1,e},resetAssemblerData:function(e){e&&iz._canvasPool.put(e)},updateRenderData:function(e){e.renderData&&e.renderData.vertDirty&&(this._updateFontFamly(e),this._updateProperties(e),this._calculateLabelFont(),this._calculateSplitedStrings(),this._updateLabelDimensions(),this._calculateTextBaseline(),this._updateTexture(),e.actualFontSize=EK,e.node.setContentSize(AK),this.updateVerts(e),e.markForUpdateRenderData(!1),gK=null,xK=null,bK=null)},updateVerts:function(e){},_updateFontFamly:function(e){e.useSystemFont?MK=e.fontFamily:e.font?e.font._nativeAsset?MK=e.font._nativeAsset:Ym.load(e.font.nativeUrl,(function(t,i){MK=i||"Arial",e.updateRenderData(!0)})):MK="Arial"},_updateProperties:function(e){var t=e.assemblerData;if(t){gK=t.context,xK=t.canvas,bK=e.spriteFrame,SK=e.string.toString(),EK=e.fontSize,wK=EK,IK=e.overflow,AK.width=e.node.width,AK.height=e.node.height,OK=e.lineHeight,kK=e.horizontalAlign,RK=e.verticalAlign,FK=e.color,BK=e.isBold,GK=e.isItalic,UK=e.isUnderline,PK=IK!==mK.NONE&&(IK===mK.RESIZE_HEIGHT||e.enableWrapText);var i=yK&&e.getComponent(jU);i&&i.enabled?(LK=!0,zK=NK=i.width,DK.set(i.color),DK.a=DK.a*e.color.a/255):(LK=!1,zK=0)}},_calculateFillTextStartPosition:function(){var e,t,i=this._getLineHeight(),n=CK.length;return e=kK===exports.HorizontalTextAlignment.RIGHT?AK.width-zK:kK===exports.HorizontalTextAlignment.CENTER?AK.width/2:0+zK,RK===exports.VerticalTextAlignment.TOP?(t=.13*EK,t=0):t=RK===exports.VerticalTextAlignment.CENTER?AK.height/2-i*(n-1)/2:AK.height-i*(n-1),new ki(e,t)},_updateTexture:function(){if(gK&&xK){gK.clearRect(0,0,xK.width,xK.height),gK.font=TK;var e,t=this._calculateFillTextStartPosition(),i=this._getLineHeight();gK.lineJoin="round",gK.fillStyle="rgba(".concat(FK.r,", ").concat(FK.g,", ").concat(FK.b,", ").concat(FK.a/255,")");for(var n=0;n<CK.length;++n){if(LK){var r=DK||vK;gK.strokeStyle="rgba(".concat(r.r,", ").concat(r.g,", ").concat(r.b,", ").concat(r.a/255,")"),gK.lineWidth=2*NK,gK.strokeText(CK[n],t.x,t.y+n*i)}gK.fillText(CK[n],t.x,t.y+n*i),UK&&(e=this._calculateUnderlineStartPosition(),gK.save(),gK.beginPath(),gK.lineWidth=EK/8,gK.strokeStyle="rgba(".concat(FK.r,", ").concat(FK.g,", ").concat(FK.b,", ").concat(FK.a/255,")"),gK.moveTo(e.x,e.y+n*i-1),gK.lineTo(e.x+xK.width,e.y+n*i-1),gK.stroke(),gK.restore())}if(bK){var a;a=bK instanceof Ac?bK.texture:bK;var o=0===xK.width||0===xK.height;a.reset({width:xK.width,height:xK.height,mipmapLevel:o?0:1}),o||a.uploadData(xK)}}},_calculateUnderlineStartPosition:function(){var e,t,i=this._getLineHeight(),n=CK.length;return e=0+zK,t=RK===exports.VerticalTextAlignment.TOP?EK:RK===exports.VerticalTextAlignment.CENTER?AK.height/2-i*(n-1)/2+EK/2:AK.height-i*(n-1),new ki(e,t)},_updateLabelDimensions:function(){if(gK){var e=SK.split("\n");if(IK===mK.RESIZE_HEIGHT)AK.height=(CK.length+.26)*this._getLineHeight();else if(IK===mK.NONE){CK=e;for(var t,i=0,n=0,r=_e(e);!(t=r()).done;){var a=t.value,o=Io(gK,a);i=i>o?i:o}n=(CK.length+.26)*this._getLineHeight(),AK.width=parseFloat(i.toFixed(2))+2*zK,AK.height=parseFloat(n.toFixed(2)),GK&&(AK.width+=wK*Math.tan(.20943951))}xK&&(xK.width=AK.width,xK.height=AK.height)}},_calculateTextBaseline:function(){var e,t;e=kK===exports.HorizontalTextAlignment.RIGHT?"right":kK===exports.HorizontalTextAlignment.CENTER?"center":"left",t=RK===exports.VerticalTextAlignment.TOP?"top":RK===exports.VerticalTextAlignment.CENTER?"middle":"bottom",gK&&(gK.textAlign=e,gK.textBaseline=t)},_calculateSplitedStrings:function(){if(gK){var e=SK.split("\n");if(PK){CK=[];for(var t,i=AK.width-2*zK,n=_e(e);!(t=n()).done;){var r=t.value,a=Po(r,Io(gK,r),i,this._measureText(gK));CK=CK.concat(a)}}else CK=e}},_getFontDesc:function(){var e=EK.toString()+"px ";return e+=MK,BK&&(e="bold "+e),GK&&(e="italic "+e),e},_getLineHeight:function(){var e=OK;return 0|(e=0===e?EK:e*EK/wK)},_calculateParagraphLength:function(e,t){for(var i,n=[],r=_e(e);!(i=r()).done;){var a=Io(t,i.value);n.push(a)}return n},_measureText:function(e){return function(t){return Io(e,t)}},_calculateLabelFont:function(){if(gK&&(TK=this._getFontDesc(),gK.font=TK,IK===mK.SHRINK)){var e=SK.split("\n"),t=this._calculateParagraphLength(e,gK);CK=e;var i=0,n=0,r=0;if(PK){var a=AK.width-2*zK,o=AK.height-2*zK;if(a<0||o<0)return TK=this._getFontDesc(),void(gK.font=TK);n=o+1,r=a+1;for(var s=EK+1,l=[],u=!0,c=0|s;n>o||r>a;){if(u?s=c/2|0:c=s=c-1,s<=0){v(4003);break}for(EK=s,TK=this._getFontDesc(),gK.font=TK,CK=[],n=0,i=0;i<e.length;++i){var h=0,p=Io(gK,e[i]);for(l=Po(e[i],p,a,this._measureText(gK));h<l.length;){r=Io(gK,l[h]),n+=this._getLineHeight(),++h}CK=CK.concat(l)}u&&(n>o?c=0|s:(u=!1,n=o+1))}}else{for(n=e.length*this._getLineHeight(),i=0;i<e.length;++i)r<t[i]&&(r=t[i]);var _=(AK.width-2*zK)/r,f=AK.height/n;EK=wK*Math.min(1,_,f)|0,TK=this._getFontDesc(),gK.font=TK}}}},VK=an.WHITE.clone(),HK={createData:function(e){var t=e.requestRenderData();t.dataLength=4,t.vertexCount=4,t.indiceCount=6;var i=t.vData=new Float32Array(36);i[3]=i[21]=i[22]=i[31]=0,i[4]=i[12]=i[13]=i[30]=1;for(var n=5,r=0;r<4;r++)an.toArray(i,VK,n),n+=9;return t},fillBuffers:function(e,t){var i=e.renderData,n=i.datas,r=e.node,a=t.currBufferBatch,o=a.byteOffset>>2,s=a.indiceOffset,l=a.vertexOffset;a.request()||(a=t.currBufferBatch,s=0,l=0);var u=a.vData,c=a.iData,h=i.vData,p=n[0],_=n[3];r.updateWorldTransform();var f=r._pos,d=r._rot,m=r._scale,v=p.x*m.x,y=_.x*m.x,g=p.y*m.y,x=_.y*m.y,b=d.x,T=d.y,S=d.z,E=d.w,w=b*T,C=S*E,A=b*b-T*T,O=E*E-S*S,k=O+A,R=2*(w-C),F=O-A,M=2*(w+C),I=f.x,P=f.y;h[0]=k*v+R*g+I,h[1]=F*g+M*v+P,h[9]=k*y+R*g+I,h[10]=F*g+M*y+P,h[18]=k*v+R*x+I,h[19]=F*x+M*v+P,h[27]=k*y+R*x+I,h[28]=F*x+M*y+P,u.set(h,o),c[s++]=l,c[s++]=l+1,c[s++]=l+2,c[s++]=l+2,c[s++]=l+1,c[s++]=l+3},updateVerts:function(e){var t=e.renderData;if(t){var i=e.node,n=i.width,r=i.height,a=i.anchorX*n,o=i.anchorY*r,s=t.datas;s[0].x=-a,s[0].y=-o,s[3].x=n-a,s[3].y=r-o}}};Ge(HK,XK);var WK={getAssembler:function(e){var t=HK;return e.font instanceof jd?t=AY:e.cacheMode===iz.CacheMode.CHAR&&(t=dK),t}};iz.Assembler=WK;var jK=qA.sharedManager,qK={createData:function(e){var t=e.requestRenderData();return t.dataLength=4,t.vertexCount=4,t.indiceCount=6,t},updateRenderData:function(e){var t=e.renderData;t&&t.vertDirty&&this.updateVerts&&this.updateVerts(e)},updateVerts:function(e){var t=e.renderData;if(t){var i,n,r,a,o=e.node,s=t.datas,l=o.width,u=o.height,c=o.anchorX*l,h=o.anchorY*u;i=-c,n=-h,r=l-c,a=u-h,s[0].x=i,s[0].y=n,s[3].x=r,s[3].y=a,t.vertDirty=!1}},fillBuffers:function(e,t){jK.pushMask(e),jK.clear(),e.clearGraphics.updateAssembler(t),jK.enterLevel(),e.graphics.updateAssembler(t),jK.enableMask()}},YK={fillBuffers:function(e,t){jK.exitMask()}},KK={getAssembler:function(){return qK}},ZK={getAssembler:function(){return YK}};cU.Assembler=KK,cU.PostAssembler=ZK;var QK=LA.FillType,JK=new Ki,$K={useModel:!1,updateRenderData:function(e){var t=e.spriteFrame,i=e.renderData;if(i&&t){var n=i.uvDirty,r=i.vertDirty;if(!n&&!r)return;var a=e.fillStart,o=e.fillRange;o<0&&(a+=o,o=-o),o=(o=(o=a+o)>1?1:o)<0?0:o;var s=(a=(a=a>1?1:a)<0?0:a)+(o=(o-=a)<0?0:o);s=s>1?1:s,n&&this.updateUVs(e,a,s),r&&(this.updateVerts&&this.updateVerts(e,a,s),this.updateWorldVerts(e))}},updateUVs:function(e,t,i){var n=e.spriteFrame,r=e.renderData,a=r.datas,o=n.width,s=n.height,l=n.getRect(),u=0,c=0,h=0,p=0,_=0,f=0,d=0,m=0,v=0,y=0;switch(n.isRotated()?(u=l.x/o,c=(l.y+l.width)/s,h=_=u,d=v=(l.x+l.height)/o,f=y=c,p=m=l.y/s):(u=l.x/o,c=(l.y+l.height)/s,h=d=u,_=v=(l.x+l.width)/o,p=f=c,m=y=l.y/s),e.fillType){case QK.HORIZONTAL:a[0].u=h+(_-h)*t,a[0].v=p+(f-p)*t,a[1].u=h+(_-h)*i,a[1].v=p+(f-p)*i,a[2].u=d+(v-d)*t,a[2].v=m+(y-m)*t,a[3].u=d+(v-d)*i,a[3].v=m+(y-m)*i;break;case QK.VERTICAL:a[0].u=h+(d-h)*t,a[0].v=p+(m-p)*t,a[1].u=_+(v-_)*t,a[1].v=f+(y-f)*t,a[2].u=h+(d-h)*i,a[2].v=p+(m-p)*i,a[3].u=_+(v-_)*i,a[3].v=f+(y-f)*i;break;default:b(2626)}r.uvDirty=!1},updateVerts:function(e,t,i){var n=e.renderData,r=n.datas,a=e.node,o=a.width,s=a.height,l=a.anchorX*o,u=a.anchorY*s,c=-l,h=-u,p=o-l,_=s-u,f=0;switch(e.fillType){case QK.HORIZONTAL:f=c+(p-c)*i,c=c+(p-c)*t,p=f;break;case QK.VERTICAL:f=h+(_-h)*i,h=h+(_-h)*t,_=f;break;default:b(2626)}r[4].x=c,r[4].y=h,r[5].x=p,r[5].y=h,r[6].x=c,r[6].y=_,r[7].x=p,r[7].y=_,n.vertDirty=!1},createData:function(e){var t=e.requestRenderData();t.dataLength=8,t.vertexCount=4,t.indiceCount=6;for(var i,n=_e(t.datas);!(i=n()).done;){i.value.z=0}return t},updateWorldVerts:function(e){var t=e.node,i=e.renderData.datas;t.getWorldMatrix(JK);for(var n=0;n<4;n++){var r=i[n+4],a=i[n];Ii.transformMat4(a,r,JK)}},fillBuffers:function(e,t){e.node.hasChangedFlags&&this.updateWorldVerts(e);e.node;!function(e,t,i,n){var r=i.datas,a=t.currBufferBatch,o=a.byteOffset>>2,s=i.vertexCount,l=a.indiceOffset,u=a.vertexOffset;a.request(s,i.indiceCount)||(a=t.currBufferBatch,s=0,l=0,u=0);for(var c=a.vData,h=0;h<s;h++){var p=r[h];c[o++]=p.x,c[o++]=p.y,c[o++]=p.z,c[o++]=p.u,c[o++]=p.v,an.toArray(c,n,o),o+=4}var _=a.iData;_[l++]=u,_[l++]=u+1,_[l++]=u+2,_[l++]=u+1,_[l++]=u+3,_[l++]=u+2}(0,t,e.renderData,e.color)}},eZ=2*Math.PI,tZ=[new ki,new ki,new ki,new ki],iZ=new Array(4),nZ=new Array(8),rZ=[new ki,new ki,new ki,new ki],aZ=[new ki,new ki,new ki,new ki],oZ=new ki,sZ=[new ki,new ki,new ki,new ki];function lZ(e,t,i,n,r,a,o){var s=Math.sin(a);s=Math.abs(s)>1e-6?s:0;var l=Math.cos(a),u=0,c=0;if(0!==(l=Math.abs(l)>1e-6?l:0)){if(u=s/l,(e-r.x)*l>0){var h=r.y+u*(e-r.x);o[0].x=e,o[0].y=h}if((t-r.x)*l>0){var p=r.y+u*(t-r.x);o[2].x=t,o[2].y=p}}if(0!==s){if(c=l/s,(n-r.y)*s>0){var _=r.x+c*(n-r.y);o[3].x=_,o[3].y=n}if((i-r.y)*s>0){var f=r.x+c*(i-r.y);o[1].x=f,o[1].y=i}}}function uZ(e,t){var i=t.x-e.x,n=t.y-e.y;if(0===i&&0===n)return 0;if(0===i)return n>0?.5*Math.PI:1.5*Math.PI;var r=Math.atan(n/i);return i<0&&(r+=Math.PI),r}function cZ(e,t,i,n,r){var a=iZ,o=a[0],s=a[1],l=a[2],u=a[3];e[t].x=i.x,e[t].y=i.y,e[t+1].x=n.x,e[t+1].y=n.y,e[t+2].x=r.x,e[t+2].y=r.y;hZ((i.x-o)/(l-o),(i.y-s)/(u-s),e,t),hZ((n.x-o)/(l-o),(n.y-s)/(u-s),e,t+1),hZ((r.x-o)/(l-o),(r.y-s)/(u-s),e,t+2)}function hZ(e,t,i,n){var r=nZ,a=r[0]+(r[2]-r[0])*e,o=r[4]+(r[6]-r[4])*e,s=r[1]+(r[3]-r[1])*e,l=r[5]+(r[7]-r[5])*e,u=i[n];u.u=a+(o-a)*t,u.v=s+(l-s)*t}for(var pZ={useModel:!1,createData:function(e){return e.requestRenderData()},updateRenderData:function(e){var t=e.spriteFrame,i=e.renderData;if(i&&t&&(i.vertDirty||i.uvDirty)){var n=i.datas,r=e.fillStart,a=e.fillRange;for(a<0&&(r+=a,a=-a);r>=1;)r-=1;for(;r<0;)r+=1;var o=(r*=eZ)+(a*=eZ);!function(e){var t=e.node,i=t.width,n=t.height,r=t.anchorX*i,a=t.anchorY*n,o=-r,s=-a,l=i-r,u=n-a,c=iZ;c[0]=o,c[1]=s,c[2]=l,c[3]=u;var h=e.fillCenter,p=oZ.x=Math.min(Math.max(0,h.x),1)*(l-o)+o,_=oZ.y=Math.min(Math.max(0,h.y),1)*(u-s)+s;tZ[0].x=tZ[3].x=o,tZ[1].x=tZ[2].x=l,tZ[0].y=tZ[1].y=s,tZ[2].y=tZ[3].y=u;for(var f,d=_e(sZ);!(f=d()).done;){var m=f.value;ki.set(m,0,0)}p!==c[0]&&ki.set(sZ[0],3,0),p!==c[2]&&ki.set(sZ[2],1,2),_!==c[1]&&ki.set(sZ[1],0,1),_!==c[3]&&ki.set(sZ[3],2,3)}(e),function(e){var t=e.width,i=e.height,n=e.getRect(),r=0,a=0,o=0,s=0,l=nZ;e.isRotated()?(r=n.x/t,a=(n.x+n.height)/t,o=n.y/i,s=(n.y+n.width)/i,l[0]=l[2]=r,l[4]=l[6]=a,l[3]=l[7]=s,l[1]=l[5]=o):(r=n.x/t,a=(n.x+n.width)/t,o=n.y/i,s=(n.y+n.height)/i,l[0]=l[4]=r,l[2]=l[6]=a,l[1]=l[3]=s,l[5]=l[7]=o)}(t),lZ(iZ[0],iZ[2],iZ[1],iZ[3],oZ,r,rZ),lZ(iZ[0],iZ[2],iZ[1],iZ[3],oZ,r+a,aZ);for(var s=0,l=0;l<4;++l){var u=sZ[l];if(u)if(a>=eZ)i.dataLength=s+3,cZ(n,s,oZ,tZ[u.x],tZ[u.y]),s+=3;else{var c=uZ(oZ,tZ[u.x]),h=uZ(oZ,tZ[u.y]);h<c&&(h+=eZ),c-=eZ,h-=eZ;for(var p=0;p<3;++p)c>=o||(c>=r?(i.dataLength=s+3,cZ(n,s,oZ,tZ[u.x],h>=o?aZ[l]:tZ[u.y]),s+=3):h<=r||(h<=o?(i.dataLength=s+3,cZ(n,s,oZ,rZ[l],tZ[u.y]),s+=3):(i.dataLength=s+3,cZ(n,s,oZ,rZ[l],aZ[l]),s+=3))),c+=eZ,h+=eZ}}i.indiceCount=i.vertexCount=s,i.vertDirty=i.uvDirty=!1}},fillBuffers:function(e,t){!function(e,t,i,n){var r=i.datas,a=t.currBufferBatch,o=a.byteOffset>>2,s=i.vertexCount,l=a.indiceOffset,u=a.vertexOffset;a.request(s,i.indiceCount)||(a=t.currBufferBatch,s=0,l=0,u=0);var c=a.vData;e.getWorldMatrix(sN);for(var h=0;h<s;h++){var p=r[h];Ii.set(oN,p.x,p.y,0),Ii.transformMat4(oN,oN,sN),c[o++]=oN.x,c[o++]=oN.y,c[o++]=oN.z,c[o++]=p.u,c[o++]=p.v,an.toArray(c,n,o),o+=4}for(var _=a.iData,f=0;f<i.dataLength;f++)_[l+f]=u+f}(e.node,t,e.renderData,e.color)}},_Z=[],fZ=0;fZ<4;fZ++)_Z.push(new Ii);for(var dZ={createData:function(e){var t=e.requestRenderData();return t.dataLength=4,t.vertexCount=4,t.indiceCount=6,t.vData=new Float32Array(36),t},updateRenderData:function(e){var t=e.spriteFrame,i=e.renderData;i&&t&&(i.vertDirty&&this.updateVerts(e),i.uvDirty&&this.updateUvs(e))},fillBuffers:function(e,t){if(null!==e){var i=e.renderData.datas,n=e.node,r=t.currBufferBatch,a=r.byteOffset>>2,o=r.indiceOffset,s=r.vertexOffset;r.request()||(r=t.currBufferBatch,a=0,o=0,s=0);var l=r.vData,u=r.iData,c=e.renderData.vData,h=i[0],p=i[3],_=n.worldMatrix,f=_.m00,d=_.m01,m=_.m04,v=_.m05,y=_.m12,g=_.m13,x=h.x,b=p.x,T=h.y,S=p.y,E=f*x,w=f*b,C=d*x,A=d*b,O=m*T,k=m*S,R=v*T,F=v*S;c[0]=E+O+y,c[1]=C+R+g,c[9]=w+O+y,c[10]=A+R+g,c[18]=E+k+y,c[19]=C+F+g,c[27]=w+k+y,c[28]=A+F+g,l.set(c,a),u[o++]=s,u[o++]=s+1,u[o++]=s+2,u[o++]=s+2,u[o++]=s+1,u[o++]=s+3}},updateVerts:function(e){var t=e.renderData;if(t){var i=e.node,n=t.datas,r=i.width,a=i.height,o=i.anchorX*r,s=i.anchorY*a,l=0,u=0,c=0,h=0;if(e.trim)l=-o,u=-s,c=r-o,h=a-s;else{var p=e.spriteFrame,_=p.getOriginalSize(),f=p.getRect(),d=_.width,m=_.height,v=f.width,y=f.height,g=p.getOffset(),x=r/d,b=a/m,T=g.x+(d-v)/2,S=g.x-(d-v)/2;l=T*x-o,u=(g.y+(m-y)/2)*b-s,c=r+S*x-o,h=a+(g.y-(m-y)/2)*b-s}n[0].x=l,n[0].y=u,n[0].z=0,n[3].x=c,n[3].y=h,n[3].z=0,t.vertDirty=!1}},updateUvs:function(e){var t=e.renderData,i=t.vData,n=e.spriteFrame.uv;i[3]=n[0],i[4]=n[1],i[12]=n[2],i[13]=n[3],i[21]=n[4],i[22]=n[5],i[30]=n[6],i[31]=n[7],t.uvDirty=!1},updateColor:function(e){for(var t=e.renderData.vData,i=5,n=e.color,r=n.r/255,a=n.g/255,o=n.b/255,s=n.a/255,l=0;l<4;l++)t[i]=r,t[i+1]=a,t[i+2]=o,t[i+3]=s,i+=9}},mZ=new Ii,vZ=new Ki,yZ={useModel:!1,createData:function(e){var t=e.requestRenderData();return t.dataLength=20,t.vertexCount=16,t.indiceCount=54,t},updateRenderData:function(e){var t=e.spriteFrame,i=e.renderData;i&&t&&(i.vertDirty&&(this.updateVerts(e),this.updateWorldVerts(e)))},updateVerts:function(e){var t=e.renderData,i=t.datas,n=e.node,r=n.width,a=n.height,o=n.anchorX*r,s=n.anchorY*a,l=e.spriteFrame,u=l.insetLeft,c=l.insetRight,h=l.insetTop,p=l.insetBottom,_=r-u-c,f=a-h-p,d=r/(u+c),m=a/(h+p);d=isNaN(d)||d>1?1:d,m=isNaN(m)||m>1?1:m,_=_<0?0:_,f=f<0?0:f,i[0].x=-o,i[0].y=-s,i[1].x=u*d-o,i[1].y=p*m-s,i[2].x=i[1].x+_,i[2].y=i[1].y+f,i[3].x=r-o,i[3].y=a-s,t.vertDirty=!1},fillBuffers:function(e,t){e.node.hasChangedFlags&&this.updateWorldVerts(e);var i=t.currBufferBatch,n=e.renderData,r=n.datas,a=i.byteOffset>>2,o=n.vertexCount,s=i.indiceOffset,l=i.vertexOffset,u=e.spriteFrame.uvSliced;i.request(o,n.indiceCount)||(i=t.currBufferBatch,a=0,s=0,l=0);for(var c=i.vData,h=i.iData,p=4;p<20;++p){var _=r[p],f=u[p-4];c[a++]=_.x,c[a++]=_.y,c[a++]=_.z,c[a++]=f.u,c[a++]=f.v,an.toArray(c,e.color,a),a+=4}for(var d=0;d<3;++d)for(var m=0;m<3;++m){var v=l+4*d+m;h[s++]=v,h[s++]=v+1,h[s++]=v+4,h[s++]=v+1,h[s++]=v+5,h[s++]=v+4}},updateWorldVerts:function(e){var t=e.node,i=e.renderData.datas;t.getWorldMatrix(vZ);for(var n=0;n<4;++n)for(var r=i[n],a=0;a<4;++a){var o=i[a],s=i[4+4*n+a];Ii.set(mZ,o.x,r.y,0),Ii.transformMat4(s,mZ,vZ)}}},gZ=[],xZ=0;xZ<4;xZ++)gZ.push(new Ii);var bZ,TZ,SZ,EZ,wZ,CZ,AZ,OZ,kZ,RZ,FZ,MZ,IZ,PZ,LZ={useModel:!1,createData:function(e){return e.requestRenderData()},updateRenderData:function(e){var t=e.renderData,i=e.spriteFrame;if(i&&t&&(t.uvDirty||t.vertDirty)){var n=e.node,r=Math.abs(n.width),a=Math.abs(n.height),o=n.anchorX*r,s=n.anchorY*a,l=i.getRect(),u=l.width,c=l.height,h=r/u,p=a/c,_=Math.ceil(p),f=Math.ceil(h),d=t.datas;t.dataLength=Math.max(8,_+1,f+1);for(var m=0;m<=f;++m)d[m].x=Math.min(u*m,r)-o;for(var v=0;v<=_;++v)d[v].y=Math.min(c*v,a)-s;t.vertexCount=_*f*4,t.indiceCount=_*f*6,t.uvDirty=!1,t.vertDirty=!1}},fillBuffers:function(e,t){var i=e.node,n=e.renderData,r=t.currBufferBatch,a=r.indiceOffset,o=r.byteOffset>>2,s=r.vertexOffset,l=n.vertexCount,u=n.indiceCount,c=r.vData,h=r.iData;r.request(l,u)||(r=t.currBufferBatch,o=0,a=0,s=0);var p=e.spriteFrame,_=p.isRotated(),f=p.uv,d=p.getRect(),m=Math.abs(i.width),v=Math.abs(i.height),y=m/d.width,g=v/d.height,x=Math.ceil(g),b=Math.ceil(y),T=i.worldMatrix;this.fillVertices(c,o,T,x,b,n.datas);for(var S=0,E=0,w=0,C=x;w<C;++w){E=Math.min(1,g-w);for(var A=0,O=b;A<O;++A){S=Math.min(1,y-A);var k=o+3,R=k+1;_?(c[k]=f[0],c[R]=f[1],c[k+9]=f[0],c[R+9]=f[1]+(f[7]-f[1])*S,c[k+18]=f[0]+(f[6]-f[0])*E,c[R+18]=f[1],c[k+27]=c[k+18],c[R+27]=c[R+9]):(c[k]=f[0],c[R]=f[1],c[k+9]=f[0]+(f[6]-f[0])*S,c[R+9]=f[1],c[k+18]=f[0],c[R+18]=f[1]+(f[7]-f[1])*E,c[k+27]=c[k+9],c[R+27]=c[R+18]),an.toArray(c,e.color,R+1),an.toArray(c,e.color,R+9+1),an.toArray(c,e.color,R+18+1),an.toArray(c,e.color,R+27+1),o+=36}}for(var F=0;F<u;F+=6)h[a++]=s,h[a++]=s+1,h[a++]=s+2,h[a++]=s+1,h[a++]=s+3,h[a++]=s+2,s+=4},fillVertices:function(e,t,i,n,r,a){for(var o=0,s=0,l=0,u=0,c=0,h=n;c<h;++c){l=a[c].y,u=a[c+1].y;for(var p=0,_=r;p<_;++p){o=a[p].x,s=a[p+1].x,Ii.set(gZ[0],o,l,0),Ii.set(gZ[1],s,l,0),Ii.set(gZ[2],o,u,0),Ii.set(gZ[3],s,u,0);for(var f=0;f<4;f++){var d=gZ[f];Ii.transformMat4(d,d,i);var m=9*f;e[t+m]=d.x,e[t+m+1]=d.y,e[t+m+2]=d.z}t+=36}}}},DZ=LA.Type,NZ=LA.FillType,zZ={getAssembler:function(e){var t=dZ,i=e;switch(i.type){case DZ.SLICED:t=yZ;break;case DZ.TILED:t=LZ;break;case DZ.FILLED:t=i.fillType===NZ.RADIAL?pZ:$K}return t}};LA.Assembler=zZ,cc.UI={MeshBuffer:jA,UIVertexFormat:$A,barFilled:$K,radialFilled:pZ,simple:dZ,sliced:yZ,ttf:HK,bmfont:AY,letter:dK,mask:qK,maskEnd:YK,graphics:qq,spriteAssembler:zZ,graphicsAssembler:Yq,labelAssembler:WK};var BZ,GZ,UZ,XZ,VZ,HZ,WZ,jZ,qZ,YZ,KZ,ZZ,QZ,JZ,$Z,eQ,tQ,iQ,nQ,rQ,aQ,oQ,sQ,lQ,uQ,cQ,hQ,pQ,_Q,fQ,dQ,mQ,vQ=(bZ=Yo("cc.BillboardComponent"),TZ=os("i18n:cc.BillboardComponent"),SZ=es("Components/Billboard"),EZ=Ko({type:gu}),wZ=Ko({type:gu,tooltip:"billboard显示的贴图"}),CZ=Ko({tooltip:"billboard的高度"}),AZ=Ko({tooltip:"billboard的宽度"}),OZ=Ko({tooltip:"billboard绕中心点旋转的角度"}),bZ(kZ=TZ(kZ=SZ(kZ=Jo((FZ=de((RZ=function(e){function t(){var e;return Z(this,t),fe(e=re(this,te(t).call(this)),"_texture",FZ,ne(e)),fe(e,"_height",MZ,ne(e)),fe(e,"_width",IZ,ne(e)),fe(e,"_rotation",PZ,ne(e)),e._model=null,e._mesh=null,e._material=null,e._uniform=new Ni(1,1,0,0),e}return ee(t,rp),J(t,[{key:"texture",get:function(){return this._texture},set:function(e){this._texture=e,this._material&&this._material.setProperty("mainTexture",e)}},{key:"height",get:function(){return this._height},set:function(e){this._height=e,this._material&&(this._uniform.y=e,this._material.setProperty("cc_size_rotation",this._uniform))}},{key:"width",get:function(){return this._width},set:function(e){this._width=e,this._material&&(this._uniform.x=e,this._material.setProperty("cc_size_rotation",this._uniform))}},{key:"rotation",get:function(){return Math.round(100*mi(this._rotation))/100},set:function(e){this._rotation=di(e),this._material&&(this._uniform.z=this._rotation,this._material.setProperty("cc_size_rotation",this._uniform))}}]),J(t,[{key:"onLoad",value:function(){this.createModel()}},{key:"onEnable",value:function(){this.attachToScene(),this._model.enabled=!0,this.width=this._width,this.height=this._height,this.rotation=this.rotation,this.texture=this.texture}},{key:"onDisable",value:function(){this.detachFromScene()}},{key:"attachToScene",value:function(){this._model&&this.node&&this.node.scene&&(this._model.scene&&this.detachFromScene(),this._getRenderScene().addModel(this._model))}},{key:"detachFromScene",value:function(){this._model&&this._model.scene&&this._model.scene.removeModel(this._model)}},{key:"createModel",value:function(){this._mesh=yw({primitiveMode:exports.GFXPrimitiveMode.TRIANGLE_LIST,positions:[0,0,0,0,0,0,0,0,0,0,0,0],uvs:[0,0,1,0,0,1,1,1],colors:[an.WHITE.r,an.WHITE.g,an.WHITE.b,an.WHITE.a,an.WHITE.r,an.WHITE.g,an.WHITE.b,an.WHITE.a,an.WHITE.r,an.WHITE.g,an.WHITE.b,an.WHITE.a,an.WHITE.r,an.WHITE.g,an.WHITE.b,an.WHITE.a],attributes:[{name:exports.GFXAttributeName.ATTR_POSITION,format:exports.GFXFormat.RGB32F},{name:exports.GFXAttributeName.ATTR_TEX_COORD,format:exports.GFXFormat.RG32F},{name:exports.GFXAttributeName.ATTR_COLOR,format:exports.GFXFormat.RGBA8UI,isNormalized:!0}],indices:[0,1,2,1,2,3]},void 0,{calculateBounds:!1}),this._model=cc.director.root.createModel(ah,this.node),this._model.initialize(this.node),null==this._material&&(this._material=new Bh,this._material.copy(Pc.get("default-billboard-material"))),this._model.initSubModel(0,this._mesh.renderingSubMeshes[0],this._material)}}]),t}()).prototype,"_texture",[EZ],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return null}}),de(RZ.prototype,"texture",[wZ],Object.getOwnPropertyDescriptor(RZ.prototype,"texture"),RZ.prototype),MZ=de(RZ.prototype,"_height",[Ko],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return 0}}),de(RZ.prototype,"height",[CZ],Object.getOwnPropertyDescriptor(RZ.prototype,"height"),RZ.prototype),IZ=de(RZ.prototype,"_width",[Ko],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return 0}}),de(RZ.prototype,"width",[AZ],Object.getOwnPropertyDescriptor(RZ.prototype,"width"),RZ.prototype),PZ=de(RZ.prototype,"_rotation",[Ko],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return 0}}),de(RZ.prototype,"rotation",[OZ],Object.getOwnPropertyDescriptor(RZ.prototype,"rotation"),RZ.prototype),kZ=RZ))||kZ)||kZ)||kZ)||kZ),yQ=[{name:exports.GFXAttributeName.ATTR_POSITION,format:exports.GFXFormat.RGB32F},{name:exports.GFXAttributeName.ATTR_TEX_COORD,format:exports.GFXFormat.RGBA32F},{name:exports.GFXAttributeName.ATTR_TEX_COORD1,format:exports.GFXFormat.RGB32F},{name:exports.GFXAttributeName.ATTR_COLOR,format:exports.GFXFormat.RGBA8,isNormalized:!0}],gQ=new Ii,xQ=new Ii,bQ=function(e){function t(){var e;return Z(this,t),(e=re(this,te(t).call(this)))._capacity=void 0,e._vertSize=0,e._vBuffer=null,e._vertAttrsFloatCount=0,e._vdataF32=null,e._vdataUint32=null,e._iaInfo=void 0,e._iaInfoBuffer=void 0,e._subMeshData=null,e._vertCount=0,e._indexCount=0,e.type=eh.LINE,e._capacity=100,e._iaInfo={drawInfos:[{vertexCount:0,firstVertex:0,indexCount:0,firstIndex:0,vertexOffset:0,instanceCount:0,firstInstance:0}]},e._iaInfoBuffer=e._device.createBuffer({usage:exports.GFXBufferUsageBit.INDIRECT,memUsage:exports.GFXMemoryUsageBit.HOST|exports.GFXMemoryUsageBit.DEVICE,size:56,stride:1}),e}return ee(t,ah),J(t,[{key:"setCapacity",value:function(e){this._capacity=e,this.createBuffer()}},{key:"createBuffer",value:function(){this._vertSize=0;for(var e,t=_e(yQ);!(e=t()).done;){var i=e.value;i.offset=this._vertSize,this._vertSize+=yr[i.format].size}this._vertAttrsFloatCount=this._vertSize/4,this._vBuffer=this._createSubMeshData(),this._vdataF32=new Float32Array(this._vBuffer),this._vdataUint32=new Uint32Array(this._vBuffer)}},{key:"_createSubMeshData",value:function(){this._subMeshData&&this.destroySubMeshData(),this._vertCount=2,this._indexCount=6;var e=this._device.createBuffer({usage:exports.GFXBufferUsageBit.VERTEX|exports.GFXBufferUsageBit.TRANSFER_DST,memUsage:exports.GFXMemoryUsageBit.HOST|exports.GFXMemoryUsageBit.DEVICE,size:this._vertSize*this._capacity*this._vertCount,stride:this._vertSize}),t=new ArrayBuffer(this._vertSize*this._capacity*this._vertCount);e.update(t);for(var i=new Uint16Array((this._capacity-1)*this._indexCount),n=0,r=0;r<this._capacity-1;++r){var a=2*r;i[n++]=a,i[n++]=a+1,i[n++]=a+2,i[n++]=a+3,i[n++]=a+2,i[n++]=a+1}var o=this._device.createBuffer({usage:exports.GFXBufferUsageBit.INDEX|exports.GFXBufferUsageBit.TRANSFER_DST,memUsage:exports.GFXMemoryUsageBit.HOST|exports.GFXMemoryUsageBit.DEVICE,size:(this._capacity-1)*this._indexCount*Uint16Array.BYTES_PER_ELEMENT,stride:Uint16Array.BYTES_PER_ELEMENT});return o.update(i),this._iaInfo.drawInfos[0].vertexCount=this._capacity*this._vertCount,this._iaInfo.drawInfos[0].indexCount=(this._capacity-1)*this._indexCount,this._iaInfoBuffer.update(this._iaInfo),this._subMeshData=new tc([e],yQ,exports.GFXPrimitiveMode.TRIANGLE_LIST),this._subMeshData.indexBuffer=o,this._subMeshData.indirectBuffer=this._iaInfoBuffer,this.setSubModelMesh(0,this._subMeshData),t}},{key:"addLineVertexData",value:function(e,t,i){if(e.length>1){var n=0;Ii.subtract(gQ,e[1],e[0]),this._vdataF32[n++]=e[0].x,this._vdataF32[n++]=e[0].y,this._vdataF32[n++]=e[0].z,this._vdataF32[n++]=0,this._vdataF32[n++]=t.evaluate(0,1),this._vdataF32[n++]=0,this._vdataF32[n++]=0,this._vdataF32[n++]=gQ.x,this._vdataF32[n++]=gQ.y,this._vdataF32[n++]=gQ.z,this._vdataUint32[n++]=i.evaluate(0,1)._val,this._vdataF32[n++]=e[0].x,this._vdataF32[n++]=e[0].y,this._vdataF32[n++]=e[0].z,this._vdataF32[n++]=1,this._vdataF32[n++]=t.evaluate(0,1),this._vdataF32[n++]=0,this._vdataF32[n++]=1,this._vdataF32[n++]=gQ.x,this._vdataF32[n++]=gQ.y,this._vdataF32[n++]=gQ.z,this._vdataUint32[n++]=i.evaluate(0,1)._val;for(var r=1;r<e.length-1;r++){Ii.subtract(gQ,e[r-1],e[r]),Ii.subtract(xQ,e[r+1],e[r]),Ii.subtract(xQ,xQ,gQ);var a=r/e.length;this._vdataF32[n++]=e[r].x,this._vdataF32[n++]=e[r].y,this._vdataF32[n++]=e[r].z,this._vdataF32[n++]=0,this._vdataF32[n++]=t.evaluate(a,1),this._vdataF32[n++]=a,this._vdataF32[n++]=0,this._vdataF32[n++]=xQ.x,this._vdataF32[n++]=xQ.y,this._vdataF32[n++]=xQ.z,this._vdataUint32[n++]=i.evaluate(a,1)._val,this._vdataF32[n++]=e[r].x,this._vdataF32[n++]=e[r].y,this._vdataF32[n++]=e[r].z,this._vdataF32[n++]=1,this._vdataF32[n++]=t.evaluate(a,1),this._vdataF32[n++]=a,this._vdataF32[n++]=1,this._vdataF32[n++]=xQ.x,this._vdataF32[n++]=xQ.y,this._vdataF32[n++]=xQ.z,this._vdataUint32[n++]=i.evaluate(a,1)._val}Ii.subtract(gQ,e[e.length-1],e[e.length-2]),this._vdataF32[n++]=e[e.length-1].x,this._vdataF32[n++]=e[e.length-1].y,this._vdataF32[n++]=e[e.length-1].z,this._vdataF32[n++]=0,this._vdataF32[n++]=t.evaluate(1,1),this._vdataF32[n++]=1,this._vdataF32[n++]=0,this._vdataF32[n++]=gQ.x,this._vdataF32[n++]=gQ.y,this._vdataF32[n++]=gQ.z,this._vdataUint32[n++]=i.evaluate(1,1)._val,this._vdataF32[n++]=e[e.length-1].x,this._vdataF32[n++]=e[e.length-1].y,this._vdataF32[n++]=e[e.length-1].z,this._vdataF32[n++]=1,this._vdataF32[n++]=t.evaluate(1,1),this._vdataF32[n++]=1,this._vdataF32[n++]=1,this._vdataF32[n++]=gQ.x,this._vdataF32[n++]=gQ.y,this._vdataF32[n++]=gQ.z,this._vdataUint32[n++]=i.evaluate(1,1)._val}this.updateIA(Math.max(0,e.length-1))}},{key:"updateIA",value:function(e){var t=this.getSubModel(0).inputAssembler;t.vertexBuffers[0].update(this._vdataF32),t.indexCount=this._indexCount*e,this._iaInfo.drawInfos[0]=t,this._iaInfoBuffer.update(this._iaInfo)}},{key:"destroySubMeshData",value:function(){this._subMeshData&&(this._subMeshData.destroy(),this._subMeshData=null)}}]),t}(),TQ=xt({Constant:0,Curve:1,TwoCurves:2,TwoConstants:3}),SQ=(BZ=Yo("cc.CurveRange"),GZ=Ko({type:TQ}),UZ=Ko({type:xo}),XZ=Ko({type:xo}),VZ=Ko({type:xo}),BZ((tQ=eQ=function(){function e(){Z(this,e),fe(this,"mode",jZ,this),fe(this,"curve",qZ,this),fe(this,"curveMin",YZ,this),fe(this,"curveMax",KZ,this),fe(this,"constant",ZZ,this),fe(this,"constantMin",QZ,this),fe(this,"constantMax",JZ,this),fe(this,"multiplier",$Z,this)}return J(e,[{key:"evaluate",value:function(e,t){switch(this.mode){case TQ.Constant:return this.constant;case TQ.Curve:return this.curve.evaluate(e)*this.multiplier;case TQ.TwoCurves:return fi(this.curveMin.evaluate(e),this.curveMax.evaluate(e),t)*this.multiplier;case TQ.TwoConstants:return fi(this.constantMin,this.constantMax,t)}}},{key:"getMax",value:function(){switch(this.mode){case TQ.Constant:return this.constant;case TQ.Curve:return this.multiplier;case TQ.TwoConstants:return this.constantMax;case TQ.TwoCurves:return this.multiplier}return 0}},{key:"_onBeforeSerialize",value:function(e){return(!1)[this.mode]}}]),e}(),eQ.Mode=TQ,jZ=de((WZ=tQ).prototype,"mode",[GZ],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return TQ.Constant}}),qZ=de(WZ.prototype,"curve",[UZ],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return new xo}}),YZ=de(WZ.prototype,"curveMin",[XZ],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return new xo}}),KZ=de(WZ.prototype,"curveMax",[VZ],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return new xo}}),ZZ=de(WZ.prototype,"constant",[Ko],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return 0}}),QZ=de(WZ.prototype,"constantMin",[Ko],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return 0}}),JZ=de(WZ.prototype,"constantMax",[Ko],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return 0}}),$Z=de(WZ.prototype,"multiplier",[Ko],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return 1}}),HZ=WZ))||HZ);function EQ(e,t,i){switch(e.mode){case TQ.Constant:return e.constant;case TQ.Curve:return e.curve.evaluate(t)*e.multiplier;case TQ.TwoCurves:return 0===i?e.curveMin.evaluate(t)*e.multiplier:e.curveMax.evaluate(t)*e.multiplier;case TQ.TwoConstants:return 0===i?e.constantMin:e.constantMax;default:return 0}}function wQ(e){switch(e.mode){case TQ.TwoConstants:case TQ.TwoCurves:return 2;default:return 1}}function CQ(e,t,i){var n=new Gl({width:t,height:i,_data:e,_compressed:!1,format:Ol.RGBA32F}),r=new gu;return r.setFilters(Rl.NEAREST,Rl.NEAREST),r.setMipFilter(Rl.NONE),r.setWrapMode(kl.CLAMP_TO_EDGE,kl.CLAMP_TO_EDGE,kl.CLAMP_TO_EDGE),r.image=n,r}function AQ(e,t,i,n,r){for(var a=Math.max(wQ(t),wQ(i),wQ(n)),o=new Float32Array(e*a*4),s=[t,i,n],l=1/(e-1),u=0;u<a;u++)for(var c=0;c<3;c++)for(var h=s[c],p=0,_=0,f=0;f<e;f++){var d=EQ(h,l*f,u);_=r?d:(p+=d)/(f+1),o[4*f+c]=_}return CQ(o,e,a)}var OQ,kQ,RQ,FQ,MQ,IQ,PQ,LQ,DQ,NQ,zQ,BQ,GQ,UQ,XQ,VQ,HQ,WQ,jQ,qQ,YQ,KQ,ZQ,QQ,JQ,$Q,eJ,tJ,iJ,nJ,rJ,aJ,oJ,sJ,lJ,uJ,cJ,hJ,pJ,_J,fJ=xt({Blend:0,Fixed:1}),dJ=(Yo("cc.ColorKey")((rQ=de((nQ=function e(){Z(this,e),fe(this,"color",rQ,this),fe(this,"time",aQ,this)}).prototype,"color",[Ko],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return an.WHITE.clone()}}),aQ=de(nQ.prototype,"time",[Ko],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return 0}}),iQ=nQ)),Yo("cc.AlphaKey")((lQ=de((sQ=function e(){Z(this,e),fe(this,"alpha",lQ,this),fe(this,"time",uQ,this)}).prototype,"alpha",[Ko],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return 1}}),uQ=de(sQ.prototype,"time",[Ko],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return 0}}),oQ=sQ)),Yo("cc.Gradient")((mQ=dQ=function(){function e(){Z(this,e),fe(this,"colorKeys",pQ,this),fe(this,"alphaKeys",_Q,this),fe(this,"mode",fQ,this),this._color=void 0,this._color=an.WHITE.clone()}return J(e,[{key:"setKeys",value:function(e,t){this.colorKeys=e,this.alphaKeys=t}},{key:"sortKeys",value:function(){this.colorKeys.length>1&&this.colorKeys.sort((function(e,t){return e.time-t.time})),this.alphaKeys.length>1&&this.alphaKeys.sort((function(e,t){return e.time-t.time}))}},{key:"evaluate",value:function(e){return this.getRGB(e),this._color._set_a_unsafe(this.getAlpha(e)),this._color}},{key:"randomColor",value:function(){var e=this.colorKeys[Math.trunc(Math.random()*this.colorKeys.length)],t=this.alphaKeys[Math.trunc(Math.random()*this.alphaKeys.length)];return this._color.set(e.color),this._color._set_a_unsafe(t.alpha),this._color}},{key:"getRGB",value:function(e){if(!(this.colorKeys.length>1))return 1===this.colorKeys.length?(this._color.set(this.colorKeys[0].color),this._color):(this._color.set(an.WHITE),this._color);e=Ei(e,1);for(var t=1;t<this.colorKeys.length;++t){var i=this.colorKeys[t-1].time,n=this.colorKeys[t].time;if(e>=i&&e<n){if(this.mode===fJ.Fixed)return this.colorKeys[t].color;var r=(e-i)/(n-i);return an.lerp(this._color,this.colorKeys[t-1].color,this.colorKeys[t].color,r),this._color}}var a=this.colorKeys.length-1;e<this.colorKeys[0].time?an.lerp(this._color,an.BLACK,this.colorKeys[0].color,e/this.colorKeys[0].time):e>this.colorKeys[a].time&&an.lerp(this._color,this.colorKeys[a].color,an.BLACK,(e-this.colorKeys[a].time)/(1-this.colorKeys[a].time))}},{key:"getAlpha",value:function(e){if(!(this.alphaKeys.length>1))return 1===this.alphaKeys.length?this.alphaKeys[0].alpha:255;e=Ei(e,1);for(var t=1;t<this.alphaKeys.length;++t){var i=this.alphaKeys[t-1].time,n=this.alphaKeys[t].time;if(e>=i&&e<n){if(this.mode===fJ.Fixed)return this.alphaKeys[t].alpha;var r=(e-i)/(n-i);return fi(this.alphaKeys[t-1].alpha,this.alphaKeys[t].alpha,r)}}var a=this.alphaKeys.length-1;return e<this.alphaKeys[0].time?fi(255,this.alphaKeys[0].alpha,e/this.alphaKeys[0].time):e>this.alphaKeys[a].time?fi(this.alphaKeys[a].alpha,255,(e-this.alphaKeys[a].time)/(1-this.alphaKeys[a].time)):void 0}}]),e}(),dQ.Mode=fJ,pQ=de((hQ=mQ).prototype,"colorKeys",[Ko],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return new Array}}),_Q=de(hQ.prototype,"alphaKeys",[Ko],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return new Array}}),fQ=de(hQ.prototype,"mode",[Ko],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return fJ.Blend}}),cQ=hQ))||cQ),mJ=xt({Color:0,Gradient:1,TwoColors:2,TwoGradients:3,RandomColor:4}),vJ=(OQ=Yo("cc.GradientRange"),kQ=Ko({type:mJ}),RQ=Ko({type:dJ}),FQ=Ko({type:dJ}),MQ=Ko({type:dJ}),IQ=Ko({type:mJ}),OQ((HQ=VQ=function(){function e(){Z(this,e),fe(this,"color",DQ,this),fe(this,"colorMin",NQ,this),fe(this,"colorMax",zQ,this),fe(this,"gradient",BQ,this),fe(this,"gradientMin",GQ,this),fe(this,"gradientMax",UQ,this),fe(this,"_mode",XQ,this),this._color=an.WHITE.clone()}return J(e,[{key:"evaluate",value:function(e,t){switch(this._mode){case mJ.Color:return this.color;case mJ.TwoColors:return an.lerp(this._color,this.colorMin,this.colorMax,t),this._color;case mJ.RandomColor:return this.gradient.randomColor();case mJ.Gradient:return this.gradient.evaluate(e);case mJ.TwoGradients:return an.lerp(this._color,this.gradientMin.evaluate(e),this.gradientMax.evaluate(e),t),this._color;default:return this.color}}},{key:"_onBeforeSerialize",value:function(e){return(!1)[this._mode]}},{key:"mode",get:function(){return this._mode},set:function(e){this._mode=e}}]),e}(),VQ.Mode=mJ,de((LQ=HQ).prototype,"mode",[kQ],Object.getOwnPropertyDescriptor(LQ.prototype,"mode"),LQ.prototype),DQ=de(LQ.prototype,"color",[Ko],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return an.WHITE.clone()}}),NQ=de(LQ.prototype,"colorMin",[Ko],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return an.WHITE.clone()}}),zQ=de(LQ.prototype,"colorMax",[Ko],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return an.WHITE.clone()}}),BQ=de(LQ.prototype,"gradient",[RQ],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return new dJ}}),GQ=de(LQ.prototype,"gradientMin",[FQ],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return new dJ}}),UQ=de(LQ.prototype,"gradientMax",[MQ],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return new dJ}}),XQ=de(LQ.prototype,"_mode",[IQ],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return mJ.Color}}),PQ=LQ))||PQ);function yJ(e,t,i){switch(e.mode){case mJ.Color:return e.color;case mJ.TwoColors:return 0===i?e.colorMin:e.colorMax;case mJ.RandomColor:return e.gradient.randomColor();case mJ.Gradient:return e.gradient.evaluate(t);case mJ.TwoGradients:return 0===i?e.gradientMin.evaluate(t):e.gradientMax.evaluate(t);default:return e.color}}function gJ(e,t){for(var i=function(e){switch(e.mode){case mJ.TwoColors:case mJ.TwoGradients:return 2;default:return 1}}(t),n=new Uint8Array(e*i*4),r=1/(e-1),a=0,o=0;o<i;o++)for(var s=0;s<e;s++){var l=yJ(t,r*s,o);n[a]=l.r,n[a+1]=l.g,n[a+2]=l.b,n[a+3]=l.a,a+=4}var u=new gu;return u.create(e,i,Ol.RGBA8888),u.setFilters(Rl.LINEAR,Rl.LINEAR),u.setWrapMode(kl.CLAMP_TO_EDGE,kl.CLAMP_TO_EDGE),u.uploadData(n),u}var xJ,bJ,TJ,SJ,EJ,wJ,CJ,AJ,OJ,kJ,RJ,FJ,MJ,IJ,PJ,LJ,DJ,NJ,zJ,BJ,GJ={CC_USE_WORLD_SPACE:!1},UJ=(WQ=Yo("cc.LineComponent"),jQ=os("i18n:cc.LineComponent"),qQ=es("Components/Line"),YQ=Ko({type:gu}),KQ=Ko({type:gu,displayOrder:0,tooltip:"线段中显示的贴图"}),ZQ=Ko({displayOrder:1,tooltip:"线段中各个点的坐标采用哪个坐标系，勾选使用世界坐标系，不选使用本地坐标系"}),QQ=Ko({type:[Ii]}),JQ=Ko({type:[Ii],displayOrder:2,tooltip:"每个线段端点的坐标"}),$Q=Ko({type:SQ}),eJ=Ko({type:SQ,displayOrder:3,tooltip:"线段宽度，如果采用曲线，则表示沿着线段方向上的曲线变化"}),tJ=Ko({type:ki,displayOrder:4,tooltip:"贴图平铺次数"}),iJ=Ko({type:ki,displayOrder:5,tooltip:"贴图坐标的偏移"}),nJ=Ko({type:vJ}),rJ=Ko({type:vJ,displayOrder:6,tooltip:"线段颜色，如果采用渐变色，则表示沿着线段方向上的颜色渐变"}),WQ(aJ=jQ(aJ=qQ(aJ=Jo((sJ=de((oJ=function(e){function t(){var e;return Z(this,t),fe(e=re(this,te(t).call(this)),"_texture",sJ,ne(e)),e._material=null,fe(e,"_worldSpace",lJ,ne(e)),fe(e,"_positions",uJ,ne(e)),fe(e,"_width",cJ,ne(e)),fe(e,"_tile",hJ,ne(e)),fe(e,"_offset",pJ,ne(e)),fe(e,"_color",_J,ne(e)),e._model=null,e._tile_offset=new Ni,e}return ee(t,rp),J(t,[{key:"texture",get:function(){return this._texture},set:function(e){this._texture=e,this._material&&this._material.setProperty("mainTexture",e)}},{key:"worldSpace",get:function(){return this._worldSpace},set:function(e){this._worldSpace=e,this._material&&(GJ.CC_USE_WORLD_SPACE=this.worldSpace,this._material.recompileShaders(GJ),this._model&&this._model.setSubModelMaterial(0,this._material))}},{key:"positions",get:function(){return this._positions},set:function(e){this._positions=e,this._model&&this._model.addLineVertexData(this._positions,this._width,this._color)}},{key:"width",get:function(){return this._width},set:function(e){this._width=e,this._model&&this._model.addLineVertexData(this._positions,this._width,this._color)}},{key:"tile",get:function(){return this._tile},set:function(e){this._tile.set(e),this._material&&(this._tile_offset.x=this._tile.x,this._tile_offset.y=this._tile.y,this._material.setProperty("mainTiling_Offset",this._tile_offset))}},{key:"offset",get:function(){return this._offset},set:function(e){this._offset.set(e),this._material&&(this._tile_offset.z=this._offset.x,this._tile_offset.w=this._offset.y,this._material.setProperty("mainTiling_Offset",this._tile_offset))}},{key:"color",get:function(){return this._color},set:function(e){this._color=e,this._model&&this._model.addLineVertexData(this._positions,this._width,this._color)}}]),J(t,[{key:"onLoad",value:function(){this._model=cc.director.root.createModel(bQ),this._model.initialize(this.node),this._model.setCapacity(100),null==this._material&&(this._material=new Bh,this._material.copy(Pc.get("default-trail-material")),GJ.CC_USE_WORLD_SPACE=this.worldSpace,this._material.recompileShaders(GJ)),this._model.setSubModelMaterial(0,this._material)}},{key:"onEnable",value:function(){this._model&&(this.attachToScene(),this.texture=this.texture,this.tile=this._tile,this.offset=this._offset,this._model.addLineVertexData(this._positions,this._width,this._color))}},{key:"onDisable",value:function(){this._model&&this.detachFromScene()}},{key:"attachToScene",value:function(){this._model&&this.node&&this.node.scene&&(this._model.scene&&this.detachFromScene(),this._getRenderScene().addModel(this._model))}},{key:"detachFromScene",value:function(){this._model&&this._model.scene&&this._model.scene.removeModel(this._model)}}]),t}()).prototype,"_texture",[YQ],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return null}}),de(oJ.prototype,"texture",[KQ],Object.getOwnPropertyDescriptor(oJ.prototype,"texture"),oJ.prototype),lJ=de(oJ.prototype,"_worldSpace",[Ko],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return!1}}),de(oJ.prototype,"worldSpace",[ZQ],Object.getOwnPropertyDescriptor(oJ.prototype,"worldSpace"),oJ.prototype),uJ=de(oJ.prototype,"_positions",[QQ],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return[]}}),de(oJ.prototype,"positions",[JQ],Object.getOwnPropertyDescriptor(oJ.prototype,"positions"),oJ.prototype),cJ=de(oJ.prototype,"_width",[$Q],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return new SQ}}),de(oJ.prototype,"width",[eJ],Object.getOwnPropertyDescriptor(oJ.prototype,"width"),oJ.prototype),hJ=de(oJ.prototype,"_tile",[Ko],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return new ki(1,1)}}),de(oJ.prototype,"tile",[tJ],Object.getOwnPropertyDescriptor(oJ.prototype,"tile"),oJ.prototype),pJ=de(oJ.prototype,"_offset",[Ko],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return new ki(0,0)}}),de(oJ.prototype,"offset",[iJ],Object.getOwnPropertyDescriptor(oJ.prototype,"offset"),oJ.prototype),_J=de(oJ.prototype,"_color",[nJ],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return new vJ}}),de(oJ.prototype,"color",[rJ],Object.getOwnPropertyDescriptor(oJ.prototype,"color"),oJ.prototype),aJ=oJ))||aJ)||aJ)||aJ)||aJ),XJ=function e(t){Z(this,e),this.particleSystem=void 0,this.position=void 0,this.velocity=void 0,this.animatedVelocity=void 0,this.ultimateVelocity=void 0,this.angularVelocity=void 0,this.axisOfRotation=void 0,this.rotation=void 0,this.startSize=void 0,this.size=void 0,this.startColor=void 0,this.color=void 0,this.randomSeed=void 0,this.remainingLifetime=void 0,this.startLifetime=void 0,this.emitAccumulator0=void 0,this.emitAccumulator1=void 0,this.frameIndex=void 0,this.startRow=void 0,this.particleSystem=t,this.position=new Ii(0,0,0),this.velocity=new Ii(0,0,0),this.animatedVelocity=new Ii(0,0,0),this.ultimateVelocity=new Ii(0,0,0),this.angularVelocity=new Ii(0,0,0),this.axisOfRotation=new Ii(0,0,0),this.rotation=new Ii(0,0,0),this.startSize=new Ii(0,0,0),this.size=new Ii(0,0,0),this.startColor=an.WHITE.clone(),this.color=an.WHITE.clone(),this.randomSeed=0,this.remainingLifetime=0,this.startLifetime=0,this.emitAccumulator0=0,this.emitAccumulator1=0,this.frameIndex=0,this.startRow=0},VJ="colorModule",HJ="forceModule",WJ="limitModule",jJ="rotationModule",qJ="sizeModule",YJ="velocityModule",KJ="textureModule",ZJ=["sizeModule","colorModule","forceModule","velocityModule","limitModule","rotationModule","textureModule"],QJ=["_colorOverLifetimeModule","_shapeModule","_sizeOvertimeModule","_velocityOvertimeModule","_forceOvertimeModule","_limitVelocityOvertimeModule","_rotationOvertimeModule","_textureAnimationModule","_trailModule"],JJ=function(){function e(){Z(this,e),this.target=null,this.needUpdate=!1,this.needAnimate=!0,this.name=void 0}return J(e,[{key:"bindTarget",value:function(e){this.target=e}},{key:"update",value:function(e,t){}}]),e}(),$J=xt({World:0,Local:1,Custom:2}),e$=xt({Billboard:0,StrecthedBillboard:1,HorizontalBillboard:2,VerticalBillboard:3,Mesh:4}),t$=xt({Box:0,Circle:1,Cone:2,Sphere:3,Hemisphere:4}),i$=xt({Base:0,Edge:1,Shell:2,Volume:3}),n$=xt({Random:0,Loop:1,PingPong:2}),r$=xt({Particles:0}),a$=xt({Stretch:0}),o$=23541,s$=39825,l$=90794,u$=212165,c$=125292,h$=197866,p$=156497,_$=984136,f$=91041,d$=(xJ=Yo("cc.ColorOvertimeModule"),bJ=Ko({displayOrder:0}),TJ=Ko({type:vJ,displayOrder:1}),xJ((wJ=de((EJ=function(e){function t(){var e,i;Z(this,t);for(var n=arguments.length,r=new Array(n),a=0;a<n;a++)r[a]=arguments[a];return fe(i=re(this,(e=te(t)).call.apply(e,[this].concat(r))),"_enable",wJ,ne(i)),fe(i,"color",CJ,ne(i)),i.name=VJ,i}return ee(t,JJ),J(t,[{key:"animate",value:function(e){e.color.set(e.startColor),e.color.multiply(this.color.evaluate(1-e.remainingLifetime/e.startLifetime,xi(e.randomSeed+f$)))}},{key:"enable",get:function(){return this._enable},set:function(e){this._enable!==e&&(this._enable=e,this.target&&this.target.enableModule(this.name,e,this))}}]),t}()).prototype,"_enable",[Ko],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return!1}}),de(EJ.prototype,"enable",[bJ],Object.getOwnPropertyDescriptor(EJ.prototype,"enable"),EJ.prototype),CJ=de(EJ.prototype,"color",[TJ],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return new vJ}}),SJ=EJ))||SJ),m$=new Ii(0,0,-1);function v$(e,t,i,n){return t!==e?(e===$J.World||Ki.invert(i,i),Ki.getRotation(n,i),!0):(Xi.set(n,0,0,0,1),!1)}function y$(e,t){ki.set(e,Math.cos(t),Math.sin(t))}function g$(e){var t=yi(-1,1),i=yi(0,2*Math.PI),n=Math.sqrt(1-t*t),r=n*Math.cos(i),a=n*Math.sin(i);Ii.set(e,r,a,t)}function x$(e,t,i){g$(e),Ii.multiplyScalar(e,e,t+(i-t)*vi())}function b$(e,t,i,n){y$(e,n),e.z=0,Ii.multiplyScalar(e,e,t+(i-t)*vi())}function T$(e){for(var t=0;t<e.length;t++){var i=t+gi(0,e.length-t),n=e[i];e[i]=e[t],e[t]=n}}function S$(){var e=yi(-1,1);return 0===e&&e++,H(e)}var E$,w$,C$,A$,O$,k$,R$,F$,M$,I$,P$,L$,D$,N$,z$,B$,G$,U$,X$,V$,H$,W$,j$,q$,Y$,K$,Z$,Q$,J$,$$,e0,t0,i0=u$,n0=new Ii,r0=(AJ=Yo("cc.ForceOvertimeModule"),OJ=Ko({displayOrder:0}),kJ=Ko({type:SQ,range:[-1,1],displayOrder:2,tooltip:"X 轴方向上的加速度分量"}),RJ=Ko({type:SQ,range:[-1,1],displayOrder:3,tooltip:"Y 轴方向上的加速度分量"}),FJ=Ko({type:SQ,range:[-1,1],displayOrder:4,tooltip:"Z 轴方向上的加速度分量"}),MJ=Ko({type:$J,displayOrder:1,tooltip:"加速度计算时采用的坐标"}),AJ((LJ=de((PJ=function(e){function t(){var e;return Z(this,t),fe(e=re(this,te(t).call(this)),"_enable",LJ,ne(e)),fe(e,"x",DJ,ne(e)),fe(e,"y",NJ,ne(e)),fe(e,"z",zJ,ne(e)),fe(e,"space",BJ,ne(e)),e.randomized=!1,e.rotation=void 0,e.needTransform=void 0,e.name=HJ,e.rotation=new Xi,e.needTransform=!1,e.needUpdate=!0,e}return ee(t,JJ),J(t,[{key:"enable",get:function(){return this._enable},set:function(e){this._enable!==e&&(this._enable=e,this.target&&this.target.enableModule(this.name,e,this))}}]),J(t,[{key:"update",value:function(e,t){this.needTransform=v$(e,this.space,t,this.rotation)}},{key:"animate",value:function(e,t){var i=1-e.remainingLifetime/e.startLifetime,n=Ii.set(n0,this.x.evaluate(i,xi(e.randomSeed+i0)),this.y.evaluate(i,xi(e.randomSeed+i0)),this.z.evaluate(i,xi(e.randomSeed+i0)));this.needTransform&&Ii.transformQuat(n,n,this.rotation),Ii.scaleAndAdd(e.velocity,e.velocity,n,t),Ii.copy(e.ultimateVelocity,e.velocity)}}]),t}()).prototype,"_enable",[Ko],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return!1}}),de(PJ.prototype,"enable",[OJ],Object.getOwnPropertyDescriptor(PJ.prototype,"enable"),PJ.prototype),DJ=de(PJ.prototype,"x",[kJ],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return new SQ}}),NJ=de(PJ.prototype,"y",[RJ],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return new SQ}}),zJ=de(PJ.prototype,"z",[FJ],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return new SQ}}),BJ=de(PJ.prototype,"space",[MJ],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return $J.Local}}),IJ=PJ))||IJ),a0=o$,o0=new Ii,s0=new Ii,l0=(E$=Yo("cc.LimitVelocityOvertimeModule"),w$=Ko({displayOrder:0}),C$=Ko({type:SQ,range:[-1,1],displayOrder:4,tooltip:"X 轴方向上的速度下限"}),A$=Ko({type:SQ,range:[-1,1],displayOrder:5,tooltip:"Y 轴方向上的速度下限"}),O$=Ko({type:SQ,range:[-1,1],displayOrder:6,tooltip:"Z 轴方向上的速度下限"}),k$=Ko({type:SQ,range:[-1,1],displayOrder:3,tooltip:"速度下限"}),R$=Ko({displayOrder:7,tooltip:"当前速度与速度下限的插值"}),F$=Ko({displayOrder:2,tooltip:"是否三个轴分开限制"}),M$=Ko({type:$J,displayOrder:1,tooltip:"计算速度下限时采用的坐标系"}),E$((L$=de((P$=function(e){function t(){var e;return Z(this,t),fe(e=re(this,te(t).call(this)),"_enable",L$,ne(e)),fe(e,"limitX",D$,ne(e)),fe(e,"limitY",N$,ne(e)),fe(e,"limitZ",z$,ne(e)),fe(e,"limit",B$,ne(e)),fe(e,"dampen",G$,ne(e)),fe(e,"separateAxes",U$,ne(e)),fe(e,"space",X$,ne(e)),e.drag=null,e.multiplyDragByParticleSize=!1,e.multiplyDragByParticleVelocity=!1,e.name=WJ,e.rotation=void 0,e.needTransform=void 0,e.rotation=new Xi,e.needTransform=!1,e.needUpdate=!0,e}return ee(t,JJ),J(t,[{key:"enable",get:function(){return this._enable},set:function(e){this._enable!==e&&(this._enable=e,this.target&&this.target.enableModule(this.name,e,this))}}]),J(t,[{key:"update",value:function(e,t){this.needTransform=v$(e,this.space,t,this.rotation)}},{key:"animate",value:function(e,t){var i=1-e.remainingLifetime/e.startLifetime,n=o0;this.separateAxes?(Ii.set(s0,this.limitX.evaluate(i,xi(e.randomSeed+a0)),this.limitY.evaluate(i,xi(e.randomSeed+a0)),this.limitZ.evaluate(i,xi(e.randomSeed+a0))),this.needTransform&&Ii.transformQuat(s0,s0,this.rotation),Ii.set(n,u0(e.ultimateVelocity.x,s0.x,this.dampen),u0(e.ultimateVelocity.y,s0.y,this.dampen),u0(e.ultimateVelocity.z,s0.z,this.dampen))):(Ii.normalize(n,e.ultimateVelocity),Ii.multiplyScalar(n,n,u0(e.ultimateVelocity.length(),this.limit.evaluate(i,xi(e.randomSeed+a0)),this.dampen))),Ii.copy(e.ultimateVelocity,n)}}]),t}()).prototype,"_enable",[Ko],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return!1}}),de(P$.prototype,"enable",[w$],Object.getOwnPropertyDescriptor(P$.prototype,"enable"),P$.prototype),D$=de(P$.prototype,"limitX",[C$],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return new SQ}}),N$=de(P$.prototype,"limitY",[A$],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return new SQ}}),z$=de(P$.prototype,"limitZ",[O$],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return new SQ}}),B$=de(P$.prototype,"limit",[k$],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return new SQ}}),G$=de(P$.prototype,"dampen",[R$],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return 3}}),U$=de(P$.prototype,"separateAxes",[F$],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return!1}}),X$=de(P$.prototype,"space",[M$],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return $J.Local}}),I$=P$))||I$);function u0(e,t,i){var n=Math.sign(e),r=Math.abs(e);return r>t&&(r=fi(r,t,i)),r*n}var c0,h0,p0,_0,f0,d0,m0,v0,y0,g0,x0,b0,T0,S0,E0,w0,C0,A0,O0,k0,R0,F0,M0,I0,P0,L0,D0,N0,z0,B0,G0,U0,X0,V0,H0,W0,j0,q0,Y0,K0,Z0,Q0,J0,$0,e1,t1,i1,n1,r1,a1,o1,s1,l1,u1,c1,h1,p1,_1,f1,d1,m1,v1,y1,g1,x1,b1,T1,S1,E1,w1,C1,A1,O1,k1,R1,F1,M1,I1,P1,L1,D1,N1,z1,B1,G1,U1,X1,V1,H1,W1,j1,q1,Y1,K1,Z1,Q1,J1,$1,e2,t2,i2,n2,r2,a2,o2,s2,l2,u2,c2,h2=c$,p2=(V$=Yo("cc.RotationOvertimeModule"),H$=Ko({displayOrder:0}),W$=Ko({displayOrder:1,tooltip:"是否三个轴分开设定旋转（暂不支持）"}),j$=Ko({type:SQ,range:[-1,1],radian:!0,displayOrder:2,tooltip:"绕 X 轴设定旋转"}),q$=Ko({type:SQ,range:[-1,1],radian:!0,displayOrder:3,tooltip:"绕 Y 轴设定旋转"}),Y$=Ko({type:SQ,range:[-1,1],radian:!0,displayOrder:4,tooltip:"绕 Z 轴设定旋转"}),V$((Q$=de((Z$=function(e){function t(){var e,i;Z(this,t);for(var n=arguments.length,r=new Array(n),a=0;a<n;a++)r[a]=arguments[a];return fe(i=re(this,(e=te(t)).call.apply(e,[this].concat(r))),"_enable",Q$,ne(i)),fe(i,"_separateAxes",J$,ne(i)),fe(i,"x",$$,ne(i)),fe(i,"y",e0,ne(i)),fe(i,"z",t0,ne(i)),i.name=jJ,i}return ee(t,JJ),J(t,[{key:"animate",value:function(e,t){var i=1-e.remainingLifetime/e.startLifetime;if(this._separateAxes){var n=xi(e.randomSeed+h2);e.rotation.x+=this.x.evaluate(i,n)*t,e.rotation.y+=this.y.evaluate(i,n)*t,e.rotation.z+=this.z.evaluate(i,n)*t}else e.rotation.z+=this.z.evaluate(i,xi(e.randomSeed+h2))*t}},{key:"enable",get:function(){return this._enable},set:function(e){this._enable!==e&&(this._enable=e,this.target&&this.target.enableModule(this.name,e,this))}},{key:"separateAxes",get:function(){return this._separateAxes},set:function(e){this._separateAxes=e}}]),t}()).prototype,"_enable",[Ko],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return!1}}),de(Z$.prototype,"enable",[H$],Object.getOwnPropertyDescriptor(Z$.prototype,"enable"),Z$.prototype),J$=de(Z$.prototype,"_separateAxes",[Ko],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return!1}}),de(Z$.prototype,"separateAxes",[W$],Object.getOwnPropertyDescriptor(Z$.prototype,"separateAxes"),Z$.prototype),$$=de(Z$.prototype,"x",[j$],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return new SQ}}),e0=de(Z$.prototype,"y",[q$],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return new SQ}}),t0=de(Z$.prototype,"z",[Y$],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return new SQ}}),K$=Z$))||K$),_2=s$,f2=(c0=Yo("cc.SizeOvertimeModule"),h0=Ko({displayOrder:0}),p0=Ko({displayOrder:1,tooltip:"决定是否在每个轴上独立控制粒子大小"}),_0=Ko({type:SQ,displayOrder:2,tooltip:"定义一条曲线来决定粒子在其生命周期中的大小变化"}),f0=Ko({type:SQ,displayOrder:3,tooltip:"定义一条曲线来决定粒子在其生命周期中 X 轴方向上的大小变化"}),d0=Ko({type:SQ,displayOrder:4,tooltip:"定义一条曲线来决定粒子在其生命周期中 Y 轴方向上的大小变化"}),m0=Ko({type:SQ,displayOrder:5,tooltip:"定义一条曲线来决定粒子在其生命周期中 Z 轴方向上的大小变化"}),c0((g0=de((y0=function(e){function t(){var e,i;Z(this,t);for(var n=arguments.length,r=new Array(n),a=0;a<n;a++)r[a]=arguments[a];return fe(i=re(this,(e=te(t)).call.apply(e,[this].concat(r))),"_enable",g0,ne(i)),fe(i,"separateAxes",x0,ne(i)),fe(i,"size",b0,ne(i)),fe(i,"x",T0,ne(i)),fe(i,"y",S0,ne(i)),fe(i,"z",E0,ne(i)),i.name=qJ,i}return ee(t,JJ),J(t,[{key:"animate",value:function(e,t){if(this.separateAxes){var i=1-e.remainingLifetime/e.startLifetime,n=xi(e.randomSeed+_2);e.size.x=e.startSize.x*this.x.evaluate(i,n),e.size.y=e.startSize.y*this.y.evaluate(i,n),e.size.z=e.startSize.z*this.z.evaluate(i,n)}else Ii.multiplyScalar(e.size,e.startSize,this.size.evaluate(1-e.remainingLifetime/e.startLifetime,xi(e.randomSeed+_2)))}},{key:"enable",get:function(){return this._enable},set:function(e){this._enable!==e&&(this._enable=e,this.target&&this.target.enableModule(this.name,e,this))}}]),t}()).prototype,"_enable",[Ko],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return!1}}),de(y0.prototype,"enable",[h0],Object.getOwnPropertyDescriptor(y0.prototype,"enable"),y0.prototype),x0=de(y0.prototype,"separateAxes",[p0],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return!1}}),b0=de(y0.prototype,"size",[_0],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return new SQ}}),T0=de(y0.prototype,"x",[f0],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return new SQ}}),S0=de(y0.prototype,"y",[d0],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return new SQ}}),E0=de(y0.prototype,"z",[m0],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return new SQ}}),v0=y0))||v0),d2=l$,m2=xt({Grid:0}),v2=xt({WholeSheet:0,SingleRow:1}),y2=(w0=Yo("cc.TextureAnimationModule"),C0=Ko({formerlySerializedAs:"numTilesX"}),A0=Ko({formerlySerializedAs:"numTilesY"}),O0=Ko({displayOrder:0}),k0=Ko({type:m2}),R0=Ko({type:m2,displayOrder:1,tooltip:"设定粒子贴图动画的类型（暂只支持 Grid 模式）"}),F0=Ko({displayOrder:2,tooltip:"X 方向动画帧数"}),M0=Ko({displayOrder:3,tooltip:"Y 方向动画帧数"}),I0=Ko({type:v2,displayOrder:4,tooltip:"动画播放方式"}),P0=Ko({type:SQ,displayOrder:7,tooltip:"一个周期内动画播放的帧与时间变化曲线"}),L0=Ko({type:SQ,displayOrder:8,tooltip:"从第几帧开始播放，时间为整个粒子系统的生命周期"}),D0=Ko({displayOrder:9,tooltip:"一个生命周期内播放循环的次数"}),N0=Ko({displayOrder:5,tooltip:"随机从动画贴图中选择一行以生成动画。\n此选项仅在动画播放方式为 SingleRow 时生效"}),z0=Ko({displayOrder:6,tooltip:"从动画贴图中选择特定行以生成动画。\n此选项仅在动画播放方式为 SingleRow 时且禁用 randomRow 时可用"}),w0((U0=de((G0=function(e){function t(){var e,i;Z(this,t);for(var n=arguments.length,r=new Array(n),a=0;a<n;a++)r[a]=arguments[a];return fe(i=re(this,(e=te(t)).call.apply(e,[this].concat(r))),"_enable",U0,ne(i)),fe(i,"_numTilesX",X0,ne(i)),fe(i,"_numTilesY",V0,ne(i)),fe(i,"_mode",H0,ne(i)),fe(i,"animation",W0,ne(i)),fe(i,"frameOverTime",j0,ne(i)),fe(i,"startFrame",q0,ne(i)),fe(i,"cycleCount",Y0,ne(i)),fe(i,"_flipU",K0,ne(i)),fe(i,"_flipV",Z0,ne(i)),fe(i,"_uvChannelMask",Q0,ne(i)),fe(i,"randomRow",J0,ne(i)),fe(i,"rowIndex",$0,ne(i)),i.name=KJ,i}return ee(t,JJ),J(t,[{key:"init",value:function(e){e.startRow=Math.floor(Math.random()*this.numTilesY)}},{key:"animate",value:function(e,t){var i=1-e.remainingLifetime/e.startLifetime,n=this.startFrame.evaluate(i,xi(e.randomSeed+d2))/(this.numTilesX*this.numTilesY);if(this.animation===v2.WholeSheet)e.frameIndex=Ei(this.cycleCount*(this.frameOverTime.evaluate(i,xi(e.randomSeed+d2))+n),1);else if(this.animation===v2.SingleRow){var r=1/this.numTilesY;if(this.randomRow){var a=Ei(this.cycleCount*(this.frameOverTime.evaluate(i,xi(e.randomSeed+d2))+n),1),o=e.startRow*r,s=o+r;e.frameIndex=fi(o,s,a)}else{var l=this.rowIndex*r,u=l+r;e.frameIndex=fi(l,u,Ei(this.cycleCount*(this.frameOverTime.evaluate(i,xi(e.randomSeed+d2))+n),1))}}}},{key:"enable",get:function(){return this._enable},set:function(e){this._enable!==e&&(this._enable=e,this.target&&(this.target.updateMaterialParams(),this.target.enableModule(this.name,e,this)))}},{key:"mode",get:function(){return this._mode},set:function(e){e===m2.Grid||console.error("particle texture animation's sprites is not supported!")}},{key:"numTilesX",get:function(){return this._numTilesX},set:function(e){this._numTilesX!==e&&(this._numTilesX=e,this.target.updateMaterialParams())}},{key:"numTilesY",get:function(){return this._numTilesY},set:function(e){this._numTilesY!==e&&(this._numTilesY=e,this.target.updateMaterialParams())}},{key:"flipU",get:function(){return this._flipU},set:function(e){console.error("particle texture animation's flipU is not supported!")}},{key:"flipV",get:function(){return this._flipV},set:function(e){console.error("particle texture animation's flipV is not supported!")}},{key:"uvChannelMask",get:function(){return this._uvChannelMask},set:function(e){console.error("particle texture animation's uvChannelMask is not supported!")}}]),t}()).prototype,"_enable",[Ko],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return!1}}),X0=de(G0.prototype,"_numTilesX",[C0],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return 0}}),V0=de(G0.prototype,"_numTilesY",[A0],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return 0}}),de(G0.prototype,"enable",[O0],Object.getOwnPropertyDescriptor(G0.prototype,"enable"),G0.prototype),H0=de(G0.prototype,"_mode",[k0],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return m2.Grid}}),de(G0.prototype,"mode",[R0],Object.getOwnPropertyDescriptor(G0.prototype,"mode"),G0.prototype),de(G0.prototype,"numTilesX",[F0],Object.getOwnPropertyDescriptor(G0.prototype,"numTilesX"),G0.prototype),de(G0.prototype,"numTilesY",[M0],Object.getOwnPropertyDescriptor(G0.prototype,"numTilesY"),G0.prototype),W0=de(G0.prototype,"animation",[I0],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return v2.WholeSheet}}),j0=de(G0.prototype,"frameOverTime",[P0],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return new SQ}}),q0=de(G0.prototype,"startFrame",[L0],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return new SQ}}),Y0=de(G0.prototype,"cycleCount",[D0],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return 0}}),K0=de(G0.prototype,"_flipU",[Ko],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return 0}}),Z0=de(G0.prototype,"_flipV",[Ko],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return 0}}),Q0=de(G0.prototype,"_uvChannelMask",[Ko],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return-1}}),J0=de(G0.prototype,"randomRow",[N0],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return!1}}),$0=de(G0.prototype,"rowIndex",[z0],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return 0}}),B0=G0))||B0),g2=h$,x2=p$,b2=_$,T2=new Ii,S2=(e1=Yo("cc.VelocityOvertimeModule"),t1=Ko({displayOrder:0}),i1=Ko({type:SQ,range:[-1,1],displayOrder:2,tooltip:"X 轴方向上的速度分量"}),n1=Ko({type:SQ,range:[-1,1],displayOrder:3,tooltip:"Y 轴方向上的速度分量"}),r1=Ko({type:SQ,range:[-1,1],displayOrder:4,tooltip:"Z 轴方向上的速度分量"}),a1=Ko({type:SQ,range:[-1,1],displayOrder:5,tooltip:"速度修正系数（只支持 CPU 粒子）"}),o1=Ko({type:$J,displayOrder:1,tooltip:"速度计算时采用的坐标系"}),e1((u1=de((l1=function(e){function t(){var e;return Z(this,t),fe(e=re(this,te(t).call(this)),"_enable",u1,ne(e)),fe(e,"x",c1,ne(e)),fe(e,"y",h1,ne(e)),fe(e,"z",p1,ne(e)),fe(e,"speedModifier",_1,ne(e)),fe(e,"space",f1,ne(e)),e.rotation=void 0,e.needTransform=void 0,e.name=YJ,e.rotation=new Xi,e.speedModifier.constant=1,e.needTransform=!1,e.needUpdate=!0,e}return ee(t,JJ),J(t,[{key:"enable",get:function(){return this._enable},set:function(e){this._enable!==e&&(this._enable=e,this.target&&this.target.enableModule(this.name,e,this))}}]),J(t,[{key:"update",value:function(e,t){this.needTransform=v$(e,this.space,t,this.rotation)}},{key:"animate",value:function(e,t){var i=1-e.remainingLifetime/e.startLifetime,n=Ii.set(T2,this.x.evaluate(i,xi(e.randomSeed^g2)),this.y.evaluate(i,xi(e.randomSeed^x2)),this.z.evaluate(i,xi(e.randomSeed^b2)));this.needTransform&&Ii.transformQuat(n,n,this.rotation),Ii.add(e.animatedVelocity,e.animatedVelocity,n),Ii.add(e.ultimateVelocity,e.velocity,e.animatedVelocity),Ii.multiplyScalar(e.ultimateVelocity,e.ultimateVelocity,this.speedModifier.evaluate(1-e.remainingLifetime/e.startLifetime,xi(e.randomSeed+g2)))}}]),t}()).prototype,"_enable",[Ko],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return!1}}),de(l1.prototype,"enable",[t1],Object.getOwnPropertyDescriptor(l1.prototype,"enable"),l1.prototype),c1=de(l1.prototype,"x",[i1],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return new SQ}}),h1=de(l1.prototype,"y",[n1],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return new SQ}}),p1=de(l1.prototype,"z",[r1],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return new SQ}}),_1=de(l1.prototype,"speedModifier",[a1],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return new SQ}}),f1=de(l1.prototype,"space",[o1],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return $J.Local}}),s1=l1))||s1),E2=(d1=Yo("cc.Burst"),m1=Ko({type:SQ}),d1((g1=de((y1=function(){function e(){Z(this,e),fe(this,"_time",g1,this),fe(this,"_repeatCount",x1,this),fe(this,"repeatInterval",b1,this),fe(this,"count",T1,this),this._remainingCount=void 0,this._curTime=void 0,this._remainingCount=0,this._curTime=0}return J(e,[{key:"time",get:function(){return this._time},set:function(e){this._time=e,this._curTime=e}},{key:"repeatCount",get:function(){return this._repeatCount},set:function(e){this._repeatCount=e,this._remainingCount=e}}]),J(e,[{key:"update",value:function(e,t){if(0===this._remainingCount&&(this._remainingCount=this._repeatCount,this._curTime=this._time),this._remainingCount>0){var i=Ei(e._time-e.startDelay.evaluate(0,1),e.duration)-t;i=i>0?i:0;var n=Ei(e.time-e.startDelay.evaluate(0,1),e.duration);this._curTime>=i&&this._curTime<n&&(e.emit(this.count.evaluate(this._curTime/e.duration,1),t-(n-this._curTime)),this._curTime+=this.repeatInterval,--this._remainingCount)}}},{key:"getMaxCount",value:function(e){return this.count.getMax()*Math.min(Math.ceil(e.duration/this.repeatInterval),this.repeatCount)}}]),e}()).prototype,"_time",[Ko],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return 0}}),de(y1.prototype,"time",[Ko],Object.getOwnPropertyDescriptor(y1.prototype,"time"),y1.prototype),x1=de(y1.prototype,"_repeatCount",[Ko],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return 1}}),de(y1.prototype,"repeatCount",[Ko],Object.getOwnPropertyDescriptor(y1.prototype,"repeatCount"),y1.prototype),b1=de(y1.prototype,"repeatInterval",[Ko],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return 1}}),T1=de(y1.prototype,"count",[m1],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return new SQ}}),v1=y1))||v1),w2=new Ii(0,0,0),C2=new Array,A2=new Ii(.5,.5,.5),O2=(S1=Yo("cc.ShapeModule"),E1=Ko({displayOrder:13,tooltip:"粒子发射器位置"}),w1=Ko({displayOrder:14,tooltip:"粒子发射器旋转角度"}),C1=Ko({displayOrder:15,tooltip:"粒子发射器缩放比例"}),A1=Ko({displayOrder:6,tooltip:"粒子发射器在一个扇形范围内发射"}),O1=Ko({displayOrder:5,tooltip:"圆锥的轴与母线的夹角\n决定圆锥发射器的开合程度"}),k1=Ko({displayOrder:0}),R1=Ko({type:t$,displayOrder:1,formerlySerializedAs:"shapeType"}),F1=Ko({type:t$,tooltip:"粒子发射器类型"}),M1=Ko({type:i$,displayOrder:2,tooltip:"粒子从发射器哪个部位发射"}),I1=Ko({displayOrder:16,tooltip:"根据粒子的初始方向决定粒子的移动方向"}),P1=Ko({displayOrder:17,tooltip:"粒子生成方向随机设定"}),L1=Ko({displayOrder:18,tooltip:"表示当前发射方向与当前位置到结点中心连线方向的插值"}),D1=Ko({displayOrder:19,tooltip:"粒子生成位置随机设定（设定此值为非 0 会使粒子生成位置超出生成器大小范围）"}),N1=Ko({displayOrder:3,tooltip:"粒子发射器半径"}),z1=Ko({displayOrder:4,tooltip:"粒子发射器发射位置（对 Box 类型的发射器无效）:\n - 0 表示从表面发射；\n - 1 表示从中心发射；\n - 0 ~ 1 之间表示在中心到表面之间发射。"}),B1=Ko({type:n$,displayOrder:7,tooltip:"粒子在扇形范围内的发射方式"}),G1=Ko({displayOrder:9,tooltip:"控制可能产生粒子的弧周围的离散间隔"}),U1=Ko({type:SQ,displayOrder:10,tooltip:"粒子沿圆周发射的速度"}),X1=Ko({displayOrder:11,tooltip:"圆锥顶部截面距离底部的轴长\n决定圆锥发射器的高度"}),V1=Ko({displayOrder:12,tooltip:"粒子发射器发射位置（针对 Box 类型的粒子发射器）"}),S1((de((W1=function(){function e(){Z(this,e),fe(this,"_enable",j1,this),fe(this,"_shapeType",q1,this),fe(this,"emitFrom",Y1,this),fe(this,"alignToDirection",K1,this),fe(this,"randomDirectionAmount",Z1,this),fe(this,"sphericalDirectionAmount",Q1,this),fe(this,"randomPositionAmount",J1,this),fe(this,"radius",$1,this),fe(this,"radiusThickness",e2,this),fe(this,"arcMode",t2,this),fe(this,"arcSpread",i2,this),fe(this,"arcSpeed",n2,this),fe(this,"length",r2,this),fe(this,"boxThickness",a2,this),fe(this,"_position",o2,this),fe(this,"_rotation",s2,this),fe(this,"_scale",l2,this),fe(this,"_arc",u2,this),fe(this,"_angle",c2,this),this.mat=void 0,this.quat=void 0,this.particleSystem=void 0,this.lastTime=void 0,this.totalAngle=void 0,this.mat=new Ki,this.quat=new Xi,this.particleSystem=null,this.lastTime=0,this.totalAngle=0}return J(e,[{key:"position",get:function(){return this._position},set:function(e){this._position=e,this.constructMat()}},{key:"rotation",get:function(){return this._rotation},set:function(e){this._rotation=e,this.constructMat()}},{key:"scale",get:function(){return this._scale},set:function(e){this._scale=e,this.constructMat()}},{key:"arc",get:function(){return mi(this._arc)},set:function(e){this._arc=di(e)}},{key:"angle",get:function(){return Math.round(100*mi(this._angle))/100},set:function(e){this._angle=di(e)}},{key:"enable",get:function(){return this._enable},set:function(e){this._enable=e}},{key:"shapeType",get:function(){return this._shapeType},set:function(e){switch(this._shapeType=e,this._shapeType){case t$.Box:this.emitFrom===i$.Base&&(this.emitFrom=i$.Volume);break;case t$.Cone:this.emitFrom===i$.Edge&&(this.emitFrom=i$.Base);break;case t$.Sphere:case t$.Hemisphere:this.emitFrom!==i$.Base&&this.emitFrom!==i$.Edge||(this.emitFrom=i$.Volume)}}}]),J(e,[{key:"onInit",value:function(e){this.particleSystem=e,this.constructMat(),this.lastTime=this.particleSystem._time}},{key:"emit",value:function(e){switch(this.shapeType){case t$.Box:!function(e,t,i,n){switch(e){case i$.Volume:r=i,a=A2,Ii.set(r,yi(-a.x,a.x),yi(-a.y,a.y),yi(-a.z,a.z));break;case i$.Shell:C2.splice(0,C2.length),C2.push(yi(-.5,.5)),C2.push(yi(-.5,.5)),C2.push(.5*S$()),T$(C2),k2(C2,t),Ii.set(i,C2[0],C2[1],C2[2]);break;case i$.Edge:C2.splice(0,C2.length),C2.push(yi(-.5,.5)),C2.push(.5*S$()),C2.push(.5*S$()),T$(C2),k2(C2,t),Ii.set(i,C2[0],C2[1],C2[2]);break;default:console.warn(e+" is not supported for box emitter.")}var r,a;Ii.copy(n,m$)}(this.emitFrom,this.boxThickness,e.position,e.velocity);break;case t$.Circle:!function(e,t,i,n,r){b$(n,e*(1-t),e,i),Ii.normalize(r,n)}(this.radius,this.radiusThickness,this.generateArcAngle(),e.position,e.velocity);break;case t$.Cone:!function(e,t,i,n,r,a,o,s){switch(e){case i$.Base:b$(o,t*(1-i),t,n),ki.multiplyScalar(s,o,Math.sin(r)),s.z=-Math.cos(r)*t,Ii.normalize(s,s),o.z=0;break;case i$.Shell:y$(o,n),ki.multiplyScalar(s,o,Math.sin(r)),s.z=-Math.cos(r),Ii.normalize(s,s),ki.multiplyScalar(o,o,t),o.z=0;break;case i$.Volume:b$(o,t*(1-i),t,n),ki.multiplyScalar(s,o,Math.sin(r)),s.z=-Math.cos(r)*t,Ii.normalize(s,s),o.z=0,Ii.add(o,o,Ii.multiplyScalar(w2,s,a*vi()/-s.z));break;default:console.warn(e+" is not supported for cone emitter.")}}(this.emitFrom,this.radius,this.radiusThickness,this.generateArcAngle(),this._angle,this.length,e.position,e.velocity);break;case t$.Sphere:!function(e,t,i,n,r){switch(e){case i$.Volume:x$(n,t*(1-i),t),Ii.normalize(r,n);break;case i$.Shell:g$(n),Ii.multiplyScalar(n,n,t),Ii.normalize(r,n);break;default:console.warn(e+" is not supported for sphere emitter.")}}(this.emitFrom,this.radius,this.radiusThickness,e.position,e.velocity);break;case t$.Hemisphere:!function(e,t,i,n,r){switch(e){case i$.Volume:x$(n,t*(1-i),t),n.z>0&&(n.z*=-1),Ii.normalize(r,n);break;case i$.Shell:g$(n),Ii.multiplyScalar(n,n,t),n.z>0&&(n.z*=-1),Ii.normalize(r,n);break;default:console.warn(e+" is not supported for hemisphere emitter.")}}(this.emitFrom,this.radius,this.radiusThickness,e.position,e.velocity);break;default:console.warn(this.shapeType+" shapeType is not supported by ShapeModule.")}if(this.randomPositionAmount>0&&(e.position.x+=yi(-this.randomPositionAmount,this.randomPositionAmount),e.position.y+=yi(-this.randomPositionAmount,this.randomPositionAmount),e.position.z+=yi(-this.randomPositionAmount,this.randomPositionAmount)),Ii.transformQuat(e.velocity,e.velocity,this.quat),Ii.transformMat4(e.position,e.position,this.mat),this.sphericalDirectionAmount>0){var t=Ii.normalize(w2,e.position);Ii.lerp(e.velocity,e.velocity,t,this.sphericalDirectionAmount)}this.lastTime=this.particleSystem._time}},{key:"constructMat",value:function(){Xi.fromEuler(this.quat,this._rotation.x,this._rotation.y,this._rotation.z),Ki.fromRTS(this.mat,this.quat,this._position,this._scale)}},{key:"generateArcAngle",value:function(){if(this.arcMode===n$.Random)return yi(0,this._arc);var e=this.totalAngle+2*Math.PI*this.arcSpeed.evaluate(this.particleSystem._time,1)*(this.particleSystem._time-this.lastTime);switch(this.totalAngle=e,0!==this.arcSpread&&(e=Math.floor(e/(this._arc*this.arcSpread))*this._arc*this.arcSpread),this.arcMode){case n$.Loop:return Ei(e,this._arc);case n$.PingPong:return wi(e,this._arc)}}}]),e}()).prototype,"position",[E1],Object.getOwnPropertyDescriptor(W1.prototype,"position"),W1.prototype),de(W1.prototype,"rotation",[w1],Object.getOwnPropertyDescriptor(W1.prototype,"rotation"),W1.prototype),de(W1.prototype,"scale",[C1],Object.getOwnPropertyDescriptor(W1.prototype,"scale"),W1.prototype),de(W1.prototype,"arc",[A1],Object.getOwnPropertyDescriptor(W1.prototype,"arc"),W1.prototype),de(W1.prototype,"angle",[O1],Object.getOwnPropertyDescriptor(W1.prototype,"angle"),W1.prototype),j1=de(W1.prototype,"_enable",[Ko],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return!1}}),de(W1.prototype,"enable",[k1],Object.getOwnPropertyDescriptor(W1.prototype,"enable"),W1.prototype),q1=de(W1.prototype,"_shapeType",[R1],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return t$.Cone}}),de(W1.prototype,"shapeType",[F1],Object.getOwnPropertyDescriptor(W1.prototype,"shapeType"),W1.prototype),Y1=de(W1.prototype,"emitFrom",[M1],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return i$.Volume}}),K1=de(W1.prototype,"alignToDirection",[I1],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return!1}}),Z1=de(W1.prototype,"randomDirectionAmount",[P1],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return 0}}),Q1=de(W1.prototype,"sphericalDirectionAmount",[L1],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return 0}}),J1=de(W1.prototype,"randomPositionAmount",[D1],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return 0}}),$1=de(W1.prototype,"radius",[N1],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return 1}}),e2=de(W1.prototype,"radiusThickness",[z1],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return 1}}),t2=de(W1.prototype,"arcMode",[B1],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return n$.Random}}),i2=de(W1.prototype,"arcSpread",[G1],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return 0}}),n2=de(W1.prototype,"arcSpeed",[U1],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return new SQ}}),r2=de(W1.prototype,"length",[X1],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return 5}}),a2=de(W1.prototype,"boxThickness",[V1],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return new Ii(0,0,0)}}),o2=de(W1.prototype,"_position",[Ko],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return new Ii(0,0,0)}}),s2=de(W1.prototype,"_rotation",[Ko],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return new Ii(0,0,0)}}),l2=de(W1.prototype,"_scale",[Ko],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return new Ii(1,1,1)}}),u2=de(W1.prototype,"_arc",[Ko],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return di(360)}}),c2=de(W1.prototype,"_angle",[Ko],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return di(25)}}),H1=W1))||H1);function k2(e,t){t.x>0&&(e[0]+=.5*yi(-t.x,t.x),e[0]=pi(e[0],-.5,.5)),t.y>0&&(e[1]+=.5*yi(-t.y,t.y),e[1]=pi(e[1],-.5,.5)),t.z>0&&(e[2]+=.5*yi(-t.z,t.z),e[2]=pi(e[2],-.5,.5))}var R2,F2,M2,I2,P2,L2,D2,N2,z2,B2,G2,U2,X2,V2,H2,W2,j2,q2,Y2,K2,Z2=[0,0,1,0,0,1,1,1],Q2=function(e){function t(){var e;return Z(this,t),(e=re(this,te(t).call(this)))._capacity=void 0,e._vertAttrs=void 0,e._vertSize=void 0,e._vBuffer=void 0,e._vertAttrsFloatCount=void 0,e._vdataF32=void 0,e._vdataUint32=void 0,e._iaInfo=void 0,e._iaInfoBuffer=void 0,e._subMeshData=void 0,e._mesh=void 0,e._vertCount=0,e._indexCount=0,e._startTimeOffset=0,e._lifeTimeOffset=0,e.type=eh.PARTICLE_BATCH,e._capacity=0,e._vertAttrs=null,e._vertSize=0,e._vBuffer=null,e._vertAttrsFloatCount=0,e._vdataF32=null,e._vdataUint32=null,e._iaInfo={drawInfos:[{vertexCount:0,firstVertex:0,indexCount:0,firstIndex:0,vertexOffset:0,instanceCount:0,firstInstance:0}]},e._iaInfoBuffer=e._device.createBuffer({usage:exports.GFXBufferUsageBit.INDIRECT,memUsage:exports.GFXMemoryUsageBit.HOST|exports.GFXMemoryUsageBit.DEVICE,size:56,stride:1}),e._subMeshData=null,e._mesh=null,e}return ee(t,ah),J(t,[{key:"setCapacity",value:function(e){var t=this._capacity!==e;this._capacity=e,this._inited&&t&&this._recreateBuffer()}},{key:"setVertexAttributes",value:function(e,t){if(this._mesh!==e||this._vertAttrs!==t){this._mesh=e,this._vertAttrs=t,this._vertSize=0;for(var i,n=_e(this._vertAttrs);!(i=n()).done;){var r=i.value;r.offset=this._vertSize,this._vertSize+=yr[r.format].size}this._vertAttrsFloatCount=this._vertSize/4,this._vBuffer=this._createSubMeshData(),this._vdataF32=new Float32Array(this._vBuffer),this._vdataUint32=new Uint32Array(this._vBuffer),this._inited=!0}}},{key:"_createSubMeshData",value:function(){this.destroySubMeshData(),this._vertCount=4,this._indexCount=6,this._mesh&&(this._vertCount=this._mesh.struct.vertexBundles[this._mesh.struct.primitives[0].vertexBundelIndices[0]].view.count,this._indexCount=this._mesh.struct.primitives[0].indexView.count);var e=this._device.createBuffer({usage:exports.GFXBufferUsageBit.VERTEX|exports.GFXBufferUsageBit.TRANSFER_DST,memUsage:exports.GFXMemoryUsageBit.HOST|exports.GFXMemoryUsageBit.DEVICE,size:this._vertSize*this._capacity*this._vertCount,stride:this._vertSize}),t=new ArrayBuffer(this._vertSize*this._capacity*this._vertCount);if(this._mesh){var i=this._vertAttrs.findIndex((function(e){return e.name===exports.GFXAttributeName.ATTR_TEX_COORD3})),n=this._vertAttrs[i++].offset;if(this._mesh.copyAttribute(0,exports.GFXAttributeName.ATTR_POSITION,t,this._vertSize,n),n=this._vertAttrs[i++].offset,this._mesh.copyAttribute(0,exports.GFXAttributeName.ATTR_NORMAL,t,this._vertSize,n),n=this._vertAttrs[this._vertAttrs.findIndex((function(e){return e.name===exports.GFXAttributeName.ATTR_TEX_COORD}))].offset,this._mesh.copyAttribute(0,exports.GFXAttributeName.ATTR_TEX_COORD,t,this._vertSize,n),n=this._vertAttrs[i++].offset,!this._mesh.copyAttribute(0,exports.GFXAttributeName.ATTR_COLOR,t,this._vertSize,n))for(var r=new Uint32Array(t),a=0;a<this._vertCount;++a)r[a*this._vertAttrsFloatCount+n/4]=an.WHITE._val;for(var o=new Float32Array(t),s=1;s<this._capacity;s++)o.copyWithin(s*this._vertSize*this._vertCount/4,0,this._vertSize*this._vertCount/4)}e.update(t);var l=new Uint16Array(this._capacity*this._indexCount);if(this._mesh){this._mesh.copyIndices(0,l);for(var u=1;u<this._capacity;u++)for(var c=0;c<this._indexCount;c++)l[u*this._indexCount+c]=l[c]+u*this._vertCount}else for(var h=0,p=0;p<this._capacity;++p){var _=4*p;l[h++]=_,l[h++]=_+1,l[h++]=_+2,l[h++]=_+3,l[h++]=_+2,l[h++]=_+1}var f=this._device.createBuffer({usage:exports.GFXBufferUsageBit.INDEX|exports.GFXBufferUsageBit.TRANSFER_DST,memUsage:exports.GFXMemoryUsageBit.HOST|exports.GFXMemoryUsageBit.DEVICE,size:this._capacity*this._indexCount*Uint16Array.BYTES_PER_ELEMENT,stride:Uint16Array.BYTES_PER_ELEMENT});return f.update(l),this._iaInfo.drawInfos[0].vertexCount=this._capacity*this._vertCount,this._iaInfo.drawInfos[0].indexCount=this._capacity*this._indexCount,this._iaInfoBuffer.status===exports.GFXStatus.UNREADY&&this._iaInfoBuffer.initialize({usage:exports.GFXBufferUsageBit.INDIRECT,memUsage:exports.GFXMemoryUsageBit.HOST|exports.GFXMemoryUsageBit.DEVICE,size:56,stride:1}),this._iaInfoBuffer.update(this._iaInfo),this._subMeshData=new tc([e],this._vertAttrs,exports.GFXPrimitiveMode.TRIANGLE_LIST),this._subMeshData.indexBuffer=f,this._subMeshData.indirectBuffer=this._iaInfoBuffer,this.setSubModelMesh(0,this._subMeshData),t}},{key:"setSubModelMaterial",value:function(e,i){this.initLocalBindings(i),oe(te(t.prototype),"setSubModelMaterial",this).call(this,e,i)}},{key:"addParticleVertexData",value:function(e,t){if(this._mesh)for(var i=0;i<this._vertCount;i++){var n=(e*this._vertCount+i)*this._vertAttrsFloatCount;this._vdataF32[n++]=t[0].x,this._vdataF32[n++]=t[0].y,this._vdataF32[n++]=t[0].z,n+=2,this._vdataF32[n++]=t[1].z,this._vdataF32[n++]=t[2].x,this._vdataF32[n++]=t[2].y,this._vdataF32[n++]=t[2].z,this._vdataF32[n++]=t[3].x,this._vdataF32[n++]=t[3].y,this._vdataF32[n++]=t[3].z,this._vdataUint32[n++]=t[4]}else{var r=e*this._vertAttrsFloatCount;this._vdataF32[r++]=t[0].x,this._vdataF32[r++]=t[0].y,this._vdataF32[r++]=t[0].z,this._vdataF32[r++]=t[1].x,this._vdataF32[r++]=t[1].y,this._vdataF32[r++]=t[1].z,this._vdataF32[r++]=t[2].x,this._vdataF32[r++]=t[2].y,this._vdataF32[r++]=t[2].z,this._vdataF32[r++]=t[3].x,this._vdataF32[r++]=t[3].y,this._vdataF32[r++]=t[3].z,this._vdataUint32[r++]=t[4],t[5]&&(this._vdataF32[r++]=t[5].x,this._vdataF32[r++]=t[5].y,this._vdataF32[r++]=t[5].z)}}},{key:"addGPUParticleVertexData",value:function(e,t,i){for(var n=t*this._vertAttrsFloatCount*this._vertCount,r=0;r<this._vertCount;r++){var a=n;this._vdataF32[a++]=e.position.x,this._vdataF32[a++]=e.position.y,this._vdataF32[a++]=e.position.z,this._vdataF32[a++]=i,this._vdataF32[a++]=e.startSize.x,this._vdataF32[a++]=e.startSize.y,this._vdataF32[a++]=e.startSize.z,this._vdataF32[a++]=Z2[2*r],this._vdataF32[a++]=e.rotation.x,this._vdataF32[a++]=e.rotation.y,this._vdataF32[a++]=e.rotation.z,this._vdataF32[a++]=Z2[2*r+1],this._vdataF32[a++]=e.startColor.r/255,this._vdataF32[a++]=e.startColor.g/255,this._vdataF32[a++]=e.startColor.b/255,this._vdataF32[a++]=e.startColor.a/255,this._vdataF32[a++]=e.velocity.x,this._vdataF32[a++]=e.velocity.y,this._vdataF32[a++]=e.velocity.z,this._vdataF32[a++]=e.startLifetime,this._vdataF32[a++]=e.randomSeed,n+=this._vertAttrsFloatCount}}},{key:"updateGPUParticles",value:function(e,t,i){for(var n=this._vertAttrsFloatCount*this._vertCount,r=0,a=0,o=0,s=0;s<e;++s)r=s*n,a=this._vdataF32[r+this._startTimeOffset],this._vdataF32[r+this._lifeTimeOffset]-(t-a)<i&&(o=--e*n,this._vdataF32.copyWithin(r,o,o+n),s--);return e}},{key:"constructAttributeIndex",value:function(){if(this._vertAttrs){var e=this._vertAttrs.findIndex((function(e){return"a_position_starttime"===e.name})),t=this._vertAttrs[e].offset;this._startTimeOffset=t/4+3,e=this._vertAttrs.findIndex((function(e){return"a_dir_life"===e.name})),t=this._vertAttrs[e].offset,this._lifeTimeOffset=t/4+3}}},{key:"updateIA",value:function(e){var t=this.getSubModel(0).inputAssembler;t.vertexBuffers[0].update(this._vdataF32),t.indexCount=this._indexCount*e,this._iaInfo.drawInfos[0]=t,this._iaInfoBuffer.update(this._iaInfo)}},{key:"clear",value:function(){this.getSubModel(0).inputAssembler.indexCount=0}},{key:"destroy",value:function(){oe(te(t.prototype),"destroy",this).call(this),this._vBuffer=null,this._vdataF32=null,this.destroySubMeshData(),this._iaInfoBuffer.destroy()}},{key:"_recreateBuffer",value:function(){this._vBuffer=this._createSubMeshData(),this.getSubModel(0).updateCommandBuffer(),this._vdataF32=new Float32Array(this._vBuffer),this._vdataUint32=new Uint32Array(this._vBuffer)}},{key:"destroySubMeshData",value:function(){this._subMeshData&&(this._subMeshData.destroy(),this._subMeshData=null)}}]),t}(),J2=function(){function e(t){Z(this,e),this._particleSystem=null,this._model=null,this._renderInfo=null,this._vertAttrs=[],this._renderInfo=t}return J(e,[{key:"onInit",value:function(e){this._particleSystem=e}},{key:"onEnable",value:function(){this._particleSystem&&(this.attachToScene(),this._model.initialize(this._particleSystem.node),this._model.enabled=this._particleSystem.enabledInHierarchy)}},{key:"onDisable",value:function(){this.detachFromScene()}},{key:"onDestroy",value:function(){this._model&&(cc.director.root.destroyModel(this._model),this._model=null)}},{key:"attachToScene",value:function(){this._model&&(this._model.scene&&this.detachFromScene(),this._particleSystem._getRenderScene().addModel(this._model))}},{key:"detachFromScene",value:function(){this._model&&this._model.scene&&this._model.scene.removeModel(this._model)}},{key:"setVertexAttributes",value:function(){this._model&&this._model.setVertexAttributes(this._renderInfo.renderMode===e$.Mesh?this._renderInfo.mesh:null,this._vertAttrs)}},{key:"_updateModel",value:function(){this._model||(this._model=cc.director.root.createModel(Q2),this._model.setCapacity(this._particleSystem.capacity),this._model.visFlags=this._particleSystem.visibility),this._model.setVertexAttributes(this._renderInfo.renderMode===e$.Mesh?this._renderInfo.mesh:null,this._vertAttrs)}},{key:"updateTrailMaterial",value:function(){}},{key:"getDefaultTrailMaterial",value:function(){return null}}]),e}(),$2=new Ii,e3=new Ki,t3=["_colorOverLifetimeModule","_sizeOvertimeModule","_velocityOvertimeModule","_forceOvertimeModule","_limitVelocityOvertimeModule","_rotationOvertimeModule","_textureAnimationModule"],i3=[0,0,1,0,0,1,1,1],n3=[{name:exports.GFXAttributeName.ATTR_POSITION,format:exports.GFXFormat.RGB32F},{name:exports.GFXAttributeName.ATTR_TEX_COORD,format:exports.GFXFormat.RGB32F},{name:exports.GFXAttributeName.ATTR_TEX_COORD1,format:exports.GFXFormat.RGB32F},{name:exports.GFXAttributeName.ATTR_TEX_COORD2,format:exports.GFXFormat.RGB32F},{name:exports.GFXAttributeName.ATTR_COLOR,format:exports.GFXFormat.RGBA8,isNormalized:!0}],r3=[{name:exports.GFXAttributeName.ATTR_POSITION,format:exports.GFXFormat.RGB32F},{name:exports.GFXAttributeName.ATTR_TEX_COORD,format:exports.GFXFormat.RGB32F},{name:exports.GFXAttributeName.ATTR_TEX_COORD1,format:exports.GFXFormat.RGB32F},{name:exports.GFXAttributeName.ATTR_TEX_COORD2,format:exports.GFXFormat.RGB32F},{name:exports.GFXAttributeName.ATTR_COLOR,format:exports.GFXFormat.RGBA8,isNormalized:!0},{name:exports.GFXAttributeName.ATTR_COLOR1,format:exports.GFXFormat.RGB32F}],a3=[{name:exports.GFXAttributeName.ATTR_POSITION,format:exports.GFXFormat.RGB32F},{name:exports.GFXAttributeName.ATTR_TEX_COORD,format:exports.GFXFormat.RGB32F},{name:exports.GFXAttributeName.ATTR_TEX_COORD1,format:exports.GFXFormat.RGB32F},{name:exports.GFXAttributeName.ATTR_TEX_COORD2,format:exports.GFXFormat.RGB32F},{name:exports.GFXAttributeName.ATTR_COLOR,format:exports.GFXFormat.RGBA8,isNormalized:!0},{name:exports.GFXAttributeName.ATTR_TEX_COORD3,format:exports.GFXFormat.RGB32F},{name:exports.GFXAttributeName.ATTR_NORMAL,format:exports.GFXFormat.RGB32F},{name:exports.GFXAttributeName.ATTR_COLOR1,format:exports.GFXFormat.RGBA8,isNormalized:!0}],o3={parent:null,owner:null,subModelIdx:0},s3=function(e){function t(e){var i;return Z(this,t),(i=re(this,te(t).call(this,e)))._defines=void 0,i._trailDefines=void 0,i._frameTile_velLenScale=void 0,i._defaultMat=null,i._node_scale=void 0,i._attrs=void 0,i._particles=null,i._defaultTrailMat=null,i._updateList=new Map,i._animateList=new Map,i._runAnimateList=new Array,i._fillDataFunc=null,i._uScaleHandle=0,i._uLenHandle=0,i._model=null,i._frameTile_velLenScale=new Ni(1,1,0,0),i._node_scale=new Ni,i._attrs=new Array(5),i._defines={CC_USE_WORLD_SPACE:!0,CC_USE_BILLBOARD:!0,CC_USE_STRETCHED_BILLBOARD:!1,CC_USE_HORIZONTAL_BILLBOARD:!1,CC_USE_VERTICAL_BILLBOARD:!1},i._trailDefines={CC_USE_WORLD_SPACE:!0},i}return ee(t,J2),J(t,[{key:"onInit",value:function(e){var i=this;oe(te(t.prototype),"onInit",this).call(this,e),this._particles=new So((function(){return new XJ(i)}),16),this._setVertexAttrib(),this._updateModel(),this._setFillFunc(),this._initModuleList(),this.updateMaterialParams(),this.updateTrailMaterial()}},{key:"clear",value:function(){this._particles.reset(),this._particleSystem._trailModule&&this._particleSystem._trailModule.clear(),this.updateRenderData()}},{key:"updateRenderMode",value:function(){this._setVertexAttrib(),this._updateModel(),this._setFillFunc(),this.updateMaterialParams()}},{key:"getFreeParticle",value:function(){return this._particles.length>=this._particleSystem.capacity?null:this._particles.add()}},{key:"getDefaultTrailMaterial",value:function(){return this._defaultTrailMat}},{key:"setNewParticle",value:function(e){}},{key:"_initModuleList",value:function(){var e=this;t3.forEach((function(t){var i=e._particleSystem[t];i&&i.enable&&(i.needUpdate&&(e._updateList[i.name]=i),i.needAnimate&&(e._animateList[i.name]=i))})),this._runAnimateList.length=0;for(var t=0,i=ZJ.length;t<i;t++){var n=this._animateList[ZJ[t]];n&&this._runAnimateList.push(n)}}},{key:"enableModule",value:function(e,t,i){t?(i.needUpdate&&(this._updateList[i.name]=i),i.needAnimate&&(this._animateList[i.name]=i)):(delete this._animateList[e],delete this._updateList[e]),this._runAnimateList.length=0;for(var n=0,r=ZJ.length;n<r;n++){var a=this._animateList[ZJ[n]];a&&this._runAnimateList.push(a)}}},{key:"updateParticles",value:function(e){var t=this,i=this._particleSystem;if(!i)return this._particles.length;switch(i.node.getWorldMatrix(e3),i.scaleSpace){case $J.Local:i.node.getScale(this._node_scale);break;case $J.World:i.node.getWorldScale(this._node_scale)}(i.getMaterialInstance(0)||this._defaultMat).passes[0].setUniform(this._uScaleHandle,this._node_scale),this._updateList.forEach((function(e,t){e.update(i._simulationSpace,e3)}));var n=i._trailModule,r=n&&n.enable;r&&n.update();for(var a=function(a){var s=t._particles.data[a];if(s.remainingLifetime-=e,Ii.set(s.animatedVelocity,0,0,0),s.remainingLifetime<0)return r&&n.removeParticle(s),t._particles.removeAt(a),--a,o=a,"continue";s.velocity.y-=9.8*i.gravityModifier.evaluate(1-s.remainingLifetime/s.startLifetime,xi(s.randomSeed))*e,Ii.copy(s.ultimateVelocity,s.velocity),t._runAnimateList.forEach((function(t){t.animate(s,e)})),Ii.scaleAndAdd(s.position,s.position,s.ultimateVelocity,e),r&&n.animate(s,e),o=a},o=0;o<this._particles.length;++o)a(o);return this._particles.length}},{key:"updateRenderData",value:function(){for(var e=0,t=0;t<this._particles.length;++t){var i=this._particles.data[t],n=0,r=this._particleSystem._textureAnimationModule;r&&r.enable&&(n=i.frameIndex),e=4*t,this._fillDataFunc(i,e,n)}this._model.updateIA(this._particles.length)}},{key:"getParticleCount",value:function(){return this._particles.length}},{key:"onMaterialModified",value:function(e,t){0===e?(this._updateModel(),this.updateMaterialParams()):this.updateTrailMaterial()}},{key:"onRebuildPSO",value:function(e,t){this._model&&0===e&&this._model.setSubModelMaterial(0,t);var i=this._particleSystem._trailModule;i&&i._trailModel&&1===e&&i._trailModel.setSubModelMaterial(0,t)}},{key:"_setFillFunc",value:function(){this._renderInfo.renderMode===e$.Mesh?this._fillDataFunc=this._fillMeshData:this._renderInfo.renderMode===e$.StrecthedBillboard?this._fillDataFunc=this._fillStrecthedData:this._fillDataFunc=this._fillNormalData}},{key:"_fillMeshData",value:function(e,t,i){var n=t/4,r=0;this._attrs[r++]=e.position,$2.z=i,this._attrs[r++]=$2,this._attrs[r++]=e.size,this._attrs[r++]=e.rotation,this._attrs[r++]=e.color._val,this._model.addParticleVertexData(n,this._attrs)}},{key:"_fillStrecthedData",value:function(e,t,i){for(var n=0,r=0;r<4;++r)n=0,this._attrs[n++]=e.position,$2.x=i3[2*r],$2.y=i3[2*r+1],$2.z=i,this._attrs[n++]=$2,this._attrs[n++]=e.size,this._attrs[n++]=e.rotation,this._attrs[n++]=e.color._val,this._attrs[n++]=e.ultimateVelocity,this._attrs[n++]=e.ultimateVelocity,this._model.addParticleVertexData(t++,this._attrs)}},{key:"_fillNormalData",value:function(e,t,i){for(var n=0,r=0;r<4;++r)n=0,this._attrs[n++]=e.position,$2.x=i3[2*r],$2.y=i3[2*r+1],$2.z=i,this._attrs[n++]=$2,this._attrs[n++]=e.size,this._attrs[n++]=e.rotation,this._attrs[n++]=e.color._val,this._attrs[n++]=null,this._model.addParticleVertexData(t++,this._attrs)}},{key:"_setVertexAttrib",value:function(){switch(this._renderInfo.renderMode){case e$.StrecthedBillboard:this._vertAttrs=r3.slice();break;case e$.Mesh:this._vertAttrs=a3.slice();break;default:this._vertAttrs=n3.slice()}}},{key:"updateMaterialParams",value:function(){if(this._particleSystem){var e=this._particleSystem,t=e.sharedMaterial;if(null!=t){var i=t._effectAsset._name;this._renderInfo.mainTexture=t.getProperty("mainTexture",0),-1!==i.indexOf("particle")&&-1===i.indexOf("particle-gpu")||e.setMaterial(null,0)}null==e.sharedMaterial&&null==this._defaultMat&&(o3.parent=Pc.get("default-particle-material"),o3.owner=this._particleSystem,o3.subModelIdx=0,this._defaultMat=new Xp(o3),null!==this._renderInfo.mainTexture&&this._defaultMat.setProperty("mainTexture",this._renderInfo.mainTexture));var n=e.getMaterialInstance(0)||this._defaultMat;e._simulationSpace===$J.World?this._defines.CC_USE_WORLD_SPACE=!0:this._defines.CC_USE_WORLD_SPACE=!1;var r=n.passes[0];this._uScaleHandle=r.getHandle("scale"),this._uLenHandle=r.getHandle("frameTile_velLenScale");var a=this._renderInfo.renderMode,o=this._frameTile_velLenScale;a===e$.Billboard?this._defines.CC_RENDER_MODE=0:a===e$.StrecthedBillboard?(this._defines.CC_RENDER_MODE=1,o.z=this._renderInfo.velocityScale,o.w=this._renderInfo.lengthScale):a===e$.HorizontalBillboard?this._defines.CC_RENDER_MODE=2:a===e$.VerticalBillboard?this._defines.CC_RENDER_MODE=3:a===e$.Mesh?this._defines.CC_RENDER_MODE=4:console.warn("particle system renderMode ".concat(a," not support."));var s=e._textureAnimationModule;s&&s.enable?(ki.set(o,s.numTilesX,s.numTilesY),r.setUniform(this._uLenHandle,o)):r.setUniform(this._uLenHandle,o),n.recompileShaders(this._defines),this._model&&this._model.setSubModelMaterial(0,n)}}},{key:"updateTrailMaterial",value:function(){if(this._particleSystem){var e=this._particleSystem,t=e._trailModule;if(t&&t.enable){e.simulationSpace===$J.World||t.space===$J.World?this._trailDefines.CC_USE_WORLD_SPACE=!0:this._trailDefines.CC_USE_WORLD_SPACE=!1;var i=e.getMaterialInstance(1);null===i&&null===this._defaultTrailMat&&(o3.parent=Pc.get("default-trail-material"),o3.owner=this._particleSystem,o3.subModelIdx=1,this._defaultTrailMat=new Xp(o3)),(i=i||this._defaultTrailMat).recompileShaders(this._trailDefines),t._updateMaterial()}}}}]),t}(),l3=new Ki,u3=new Ni,c3=new Xi,h3="a_position_starttime",p3="a_size_uv",_3="a_rotation_uv",f3="a_color",d3="a_dir_life",m3="a_rndSeed",v3=[{name:h3,format:exports.GFXFormat.RGBA32F},{name:p3,format:exports.GFXFormat.RGBA32F},{name:_3,format:exports.GFXFormat.RGBA32F},{name:f3,format:exports.GFXFormat.RGBA32F},{name:d3,format:exports.GFXFormat.RGBA32F},{name:m3,format:exports.GFXFormat.R32F}],y3=[{name:h3,format:exports.GFXFormat.RGBA32F},{name:p3,format:exports.GFXFormat.RGBA32F},{name:_3,format:exports.GFXFormat.RGBA32F},{name:f3,format:exports.GFXFormat.RGBA32F},{name:d3,format:exports.GFXFormat.RGBA32F},{name:m3,format:exports.GFXFormat.R32F},{name:exports.GFXAttributeName.ATTR_TEX_COORD,format:exports.GFXFormat.RGB32F},{name:exports.GFXAttributeName.ATTR_TEX_COORD3,format:exports.GFXFormat.RGB32F},{name:exports.GFXAttributeName.ATTR_NORMAL,format:exports.GFXFormat.RGB32F},{name:exports.GFXAttributeName.ATTR_COLOR1,format:exports.GFXFormat.RGBA8,isNormalized:!0}],g3={parent:null,owner:null,subModelIdx:0},x3=function(e){function t(e){var i;return Z(this,t),(i=re(this,te(t).call(this,e)))._defines=void 0,i._frameTile_velLenScale=void 0,i._node_scale=void 0,i._vertAttrs=[],i._defaultMat=null,i._particleNum=0,i._tempParticle=null,i._colorTexture=null,i._forceTexture=null,i._velocityTexture=null,i._rotationTexture=null,i._sizeTexture=null,i._animTexture=null,i._uTimeHandle=0,i._uRotHandle=0,i._frameTile_velLenScale=new Ni(1,1,0,0),i._node_scale=new Ni,i._defines={CC_USE_WORLD_SPACE:!0,CC_USE_BILLBOARD:!0,CC_USE_STRETCHED_BILLBOARD:!1,CC_USE_HORIZONTAL_BILLBOARD:!1,CC_USE_VERTICAL_BILLBOARD:!1,COLOR_OVER_TIME_MODULE_ENABLE:!1},i._tempParticle=new XJ(null),i._particleNum=0,i}return ee(t,J2),J(t,[{key:"onInit",value:function(e){oe(te(t.prototype),"onInit",this).call(this,e),this._setVertexAttrib(),this._updateModel(),this._model.constructAttributeIndex(),this.updateMaterialParams()}},{key:"updateRenderMode",value:function(){this._setVertexAttrib(),this._updateModel(),this.updateMaterialParams()}},{key:"clear",value:function(){this._particleNum=0,this.updateRenderData()}},{key:"onDestroy",value:function(){oe(te(t.prototype),"onDestroy",this).call(this),this._forceTexture&&this._forceTexture.destroy(),this._velocityTexture&&this._velocityTexture.destroy(),this._colorTexture&&this._colorTexture.destroy(),this._sizeTexture&&this._sizeTexture.destroy(),this._rotationTexture&&this._rotationTexture.destroy(),this._animTexture&&this._animTexture.destroy()}},{key:"enableModule",value:function(e,t,i){var n=this._particleSystem.getMaterialInstance(0)||this._defaultMat;n&&(this.initShaderUniform(n),n.recompileShaders(this._defines),this._model&&this._model.setSubModelMaterial(0,n))}},{key:"getFreeParticle",value:function(){return this._particleNum>=this._particleSystem._capacity?null:this._tempParticle}},{key:"setNewParticle",value:function(e){this._model.addGPUParticleVertexData(e,this._particleNum,this._particleSystem._time),this._particleNum++}},{key:"updateParticles",value:function(e){return this._particleNum=this._model.updateGPUParticles(this._particleNum,this._particleSystem._time,e),this.updateShaderUniform(e),this._particleNum}},{key:"updateRenderData",value:function(){this._model.updateIA(this._particleNum)}},{key:"updateShaderUniform",value:function(e){var t=this._particleSystem.getMaterialInstance(0)||this._defaultMat;if(t){var i=t.passes[0];u3.x=this._particleSystem._time,u3.y=e,i.setUniform(this._uTimeHandle,u3),this._particleSystem.node.getWorldRotation(c3),i.setUniform(this._uRotHandle,c3)}}},{key:"initShaderUniform",value:function(e){var t=e.passes[0];this._uTimeHandle=t.getHandle("u_timeDelta"),this._uRotHandle=t.getHandle("u_worldRot"),t.setUniform(t.getHandle("scale"),this._node_scale),t.setUniform(t.getHandle("frameTile_velLenScale"),this._frameTile_velLenScale),u3.x=32,u3.y=1/32,t.setUniform(t.getHandle("u_sampleInfo"),u3);var i=!1,n=this._particleSystem._forceOvertimeModule;if(i=n&&n.enable,this._defines.FORCE_OVER_TIME_MODULE_ENABLE=i,i){this._forceTexture&&this._forceTexture.destroy(),this._forceTexture=AQ(32,n.x,n.y,n.z);var r=t.getHandle("force_over_time_tex0"),a=Eh.getBindingFromHandle(r);t.bindSampler(a,this._forceTexture.getGFXSampler()),t.bindTextureView(a,this._forceTexture.getGFXTextureView());var o=t.getHandle("u_force_space");t.setUniform(o,n.space);var s=t.getHandle("u_force_mode");t.setUniform(s,this._forceTexture.height)}var l=this._particleSystem._velocityOvertimeModule;if(i=l&&l.enable,this._defines.VELOCITY_OVER_TIME_MODULE_ENABLE=i,i){this._velocityTexture&&this._velocityTexture.destroy(),this._velocityTexture=function(e,t,i,n,r,a){for(var o=Math.max(wQ(t),wQ(i),wQ(n),wQ(r)),s=new Float32Array(e*o*4),l=[t,i,n,r],u=1/(e-1),c=0;c<o;c++)for(var h=0;h<4;h++)for(var p=l[h],_=0,f=0,d=0;d<e;d++){var m=EQ(p,u*d,c);f=a?m:(_+=m)/(d+1),s[4*d+h]=f}return CQ(s,e,o)}(32,l.x,l.y,l.z,l.speedModifier);var u=t.getHandle("velocity_over_time_tex0"),c=Eh.getBindingFromHandle(u);t.bindSampler(c,this._velocityTexture.getGFXSampler()),t.bindTextureView(c,this._velocityTexture.getGFXTextureView());var h=t.getHandle("u_velocity_space");t.setUniform(h,l.space);var p=t.getHandle("u_velocity_mode");t.setUniform(p,this._velocityTexture.height)}var _=this._particleSystem._colorOverLifetimeModule;if(i=_&&_.enable,this._defines.COLOR_OVER_TIME_MODULE_ENABLE=i,i){this._colorTexture&&this._colorTexture.destroy(),this._colorTexture=gJ(32,_.color);var f=t.getHandle("color_over_time_tex0"),d=Eh.getBindingFromHandle(f);t.bindSampler(d,this._colorTexture.getGFXSampler()),t.bindTextureView(d,this._colorTexture.getGFXTextureView());var m=t.getHandle("u_color_mode");t.setUniform(m,this._colorTexture.height)}var v=this._particleSystem._rotationOvertimeModule;if(i=v&&v.enable,this._defines.ROTATION_OVER_TIME_MODULE_ENABLE=i,i){this._rotationTexture&&this._rotationTexture.destroy(),v.separateAxes?this._rotationTexture=AQ(32,v.x,v.y,v.z):this._rotationTexture=function(e,t,i){for(var n=wQ(t),r=new Float32Array(e*n*4),a=1/(e-1),o=0,s=0;s<n;s++)for(var l=0;l<e;l++){var u=EQ(t,a*l,s);r[o+2]=u,o+=4}return CQ(r,e,n)}(32,v.z);var y=t.getHandle("rotation_over_time_tex0"),g=Eh.getBindingFromHandle(y);t.bindSampler(g,this._rotationTexture.getGFXSampler()),t.bindTextureView(g,this._rotationTexture.getGFXTextureView());var x=t.getHandle("u_rotation_mode");t.setUniform(x,this._rotationTexture.height)}var b=this._particleSystem._sizeOvertimeModule;if(i=b&&b.enable,this._defines.SIZE_OVER_TIME_MODULE_ENABLE=i,i){this._sizeTexture&&this._sizeTexture.destroy(),b.separateAxes?this._sizeTexture=AQ(32,b.x,b.y,b.z,!0):this._sizeTexture=function(e,t,i){for(var n=wQ(t),r=new Float32Array(e*n*4),a=1/(e-1),o=0,s=0,l=0,u=0;u<n;u++){o=0;for(var c=0;c<e;c++){var h=EQ(t,a*c,u);s=i?h:(o+=h)/(c+1),r[l]=s,r[l+1]=s,r[l+2]=s,l+=4}}return CQ(r,e,n)}(32,b.size,!0);var T=t.getHandle("size_over_time_tex0"),S=Eh.getBindingFromHandle(T);t.bindSampler(S,this._sizeTexture.getGFXSampler()),t.bindTextureView(S,this._sizeTexture.getGFXTextureView());var E=t.getHandle("u_size_mode");t.setUniform(E,this._sizeTexture.height)}var w=this._particleSystem._textureAnimationModule;if(i=w&&w.enable,this._defines.TEXTURE_ANIMATION_MODULE_ENABLE=i,i){this._animTexture&&this._animTexture.destroy(),this._animTexture=function(e,t,i,n){for(var r=Math.max(wQ(t),wQ(i)),a=new Float32Array(e*r*4),o=[t,i],s=1/(e-1),l=0;l<r;l++)for(var u=0;u<2;u++)for(var c=o[u],h=0,p=0,_=0;_<e;_++){var f=EQ(c,s*_,l);p=n?f:(h+=f)/(_+1),a[4*_+u]=p}return CQ(a,e,r)}(32,w.startFrame,w.frameOverTime);var C=t.getHandle("texture_animation_tex0"),A=Eh.getBindingFromHandle(C);t.bindSampler(A,this._animTexture.getGFXSampler()),t.bindTextureView(A,this._animTexture.getGFXTextureView());var O=t.getHandle("u_anim_info");u3.x=this._animTexture.height,u3.y=w.numTilesX*w.numTilesY,u3.z=w.cycleCount,t.setUniform(O,u3)}}},{key:"getParticleCount",value:function(){return this._particleNum}},{key:"onMaterialModified",value:function(e,t){this._updateModel(),this.updateMaterialParams()}},{key:"onRebuildPSO",value:function(e,t){this._model&&0===e&&this._model.setSubModelMaterial(0,t)}},{key:"_setVertexAttrib",value:function(){switch(this._renderInfo.renderMode){case e$.StrecthedBillboard:this._vertAttrs=v3.slice();break;case e$.Mesh:this._vertAttrs=y3.slice();break;default:this._vertAttrs=v3.slice()}}},{key:"updateMaterialParams",value:function(){if(this._particleSystem){var e=this._particleSystem,t=e.sharedMaterial;if(null!==t){var i=t._effectAsset._name;this._renderInfo.mainTexture=t.getProperty("mainTexture",0),-1===i.indexOf("particle-gpu")&&(this._renderInfo.mainTexture=t.getProperty("mainTexture",0),this._particleSystem.setMaterial(null,0))}null==t&&null==this._defaultMat&&(g3.parent=Pc.get("default-particle-gpu-material"),g3.owner=e,g3.subModelIdx=0,this._defaultMat=new Xp(g3),null!==this._renderInfo.mainTexture&&this._defaultMat.setProperty("mainTexture",this._renderInfo.mainTexture));var n=e.getMaterialInstance(0)||this._defaultMat;switch(e.node.getWorldMatrix(l3),e.scaleSpace){case $J.Local:e.node.getScale(this._node_scale);break;case $J.World:e.node.getWorldScale(this._node_scale)}e._simulationSpace===$J.World?this._defines.CC_USE_WORLD_SPACE=!0:this._defines.CC_USE_WORLD_SPACE=!1;var r=this._renderInfo.renderMode;r===e$.Billboard?this._defines.CC_RENDER_MODE=0:r===e$.StrecthedBillboard?(this._defines.CC_RENDER_MODE=1,this._frameTile_velLenScale.z=this._renderInfo.velocityScale,this._frameTile_velLenScale.w=this._renderInfo.lengthScale):r===e$.HorizontalBillboard?this._defines.CC_RENDER_MODE=2:r===e$.VerticalBillboard?this._defines.CC_RENDER_MODE=3:r===e$.Mesh?this._defines.CC_RENDER_MODE=4:console.warn("particle system renderMode ".concat(r," not support."));var a=e._textureAnimationModule;a&&a.enable&&ki.set(this._frameTile_velLenScale,a.numTilesX,a.numTilesY),this.initShaderUniform(n),n.recompileShaders(this._defines),this._model&&this._model.setSubModelMaterial(0,n)}}}]),t}();function b3(){var e=_O.root.device;return!!(e.maxVertexTextureUnits>=8&&e.hasFeature(exports.GFXFeature.TEXTURE_FLOAT))||(cc.warn("Maybe the device has restrictions on vertex textures or does not support float textures."),!1)}var T3,S3,E3,w3,C3,A3,O3,k3,R3,F3,M3,I3,P3,L3,D3,N3,z3,B3,G3,U3,X3,V3,H3,W3,j3,q3,Y3,K3,Z3,Q3,J3,$3,e4,t4,i4,n4,r4,a4,o4,s4,l4,u4,c4,h4,p4,_4,f4,d4,m4,v4,y4,g4,x4,b4,T4,S4,E4,w4,C4,A4,O4,k4,R4,F4,M4,I4,P4,L4,D4,N4,z4,B4,G4,U4,X4,V4,H4,W4,j4,q4,Y4,K4,Z4,Q4,J4,$4,e5,t5,i5,n5,r5,a5,o5,s5,l5,u5,c5,h5,p5,_5,f5,d5,m5,v5,y5,g5,x5,b5,T5,S5,E5,w5,C5,A5,O5,k5,R5,F5,M5,I5=(R2=Yo("cc.ParticleSystemRenderer"),F2=Ko({type:e$,displayOrder:0,tooltip:"设定粒子生成模式"}),M2=Ko({displayOrder:1,tooltip:"在粒子生成方式为 StrecthedBillboard 时,对粒子在运动方向上按速度大小进行拉伸"}),I2=Ko({displayOrder:2,tooltip:"在粒子生成方式为 StrecthedBillboard 时,对粒子在运动方向上按粒子大小进行拉伸"}),P2=Ko({type:e$,displayOrder:3}),L2=Ko({displayOrder:4}),D2=Ko({displayOrder:5}),N2=Ko({displayOrder:6}),z2=Ko({type:rc,displayOrder:7,tooltip:"粒子发射的模型"}),B2=Ko({type:Bh,displayOrder:8,tooltip:"粒子使用的材质"}),G2=Ko({type:Bh,displayOrder:9,tooltip:"拖尾使用的材质"}),U2=Ko({displayOrder:10,tooltip:"是否启用GPU粒子"}),R2((de((V2=function(){function e(){Z(this,e),fe(this,"_renderMode",H2,this),fe(this,"_velocityScale",W2,this),fe(this,"_lengthScale",j2,this),fe(this,"_mesh",q2,this),fe(this,"_mainTexture",Y2,this),fe(this,"_useGPU",K2,this),this._particleSystem=null}return J(e,[{key:"onInit",value:function(e){this._particleSystem=e;var t=this._useGPU&&b3();this._particleSystem.processor=t?new x3(this):new s3(this),this._particleSystem.processor.onInit(e)}},{key:"_switchProcessor",value:function(){this._particleSystem.processor&&(this._particleSystem.processor.detachFromScene(),this._particleSystem.processor.clear(),this._particleSystem.processor=null),this._particleSystem.processor=this._useGPU?new x3(this):new s3(this),this._particleSystem.processor.onInit(this._particleSystem),this._particleSystem.processor.onEnable(),this._particleSystem.bindModule()}},{key:"renderMode",get:function(){return this._renderMode},set:function(e){this._renderMode!==e&&(this._renderMode=e,this._particleSystem.processor.updateRenderMode())}},{key:"velocityScale",get:function(){return this._velocityScale},set:function(e){this._velocityScale=e,this._particleSystem.processor.updateMaterialParams()}},{key:"lengthScale",get:function(){return this._lengthScale},set:function(e){this._lengthScale=e,this._particleSystem.processor.updateMaterialParams()}},{key:"mesh",get:function(){return this._mesh},set:function(e){this._mesh=e,this._particleSystem.processor.setVertexAttributes()}},{key:"particleMaterial",get:function(){return this._particleSystem?this._particleSystem.getMaterial(0):null},set:function(e){this._particleSystem.setMaterial(e,0)}},{key:"trailMaterial",get:function(){return this._particleSystem?this._particleSystem.getMaterial(1):null},set:function(e){this._particleSystem.setMaterial(e,1)}},{key:"mainTexture",get:function(){return this._mainTexture},set:function(e){this._mainTexture=e}},{key:"useGPU",get:function(){return this._useGPU},set:function(e){this._useGPU!==e&&(b3()?this._useGPU=e:this._useGPU=!1,this._switchProcessor())}}]),e}()).prototype,"renderMode",[F2],Object.getOwnPropertyDescriptor(V2.prototype,"renderMode"),V2.prototype),de(V2.prototype,"velocityScale",[M2],Object.getOwnPropertyDescriptor(V2.prototype,"velocityScale"),V2.prototype),de(V2.prototype,"lengthScale",[I2],Object.getOwnPropertyDescriptor(V2.prototype,"lengthScale"),V2.prototype),H2=de(V2.prototype,"_renderMode",[P2],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return e$.Billboard}}),W2=de(V2.prototype,"_velocityScale",[L2],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return 1}}),j2=de(V2.prototype,"_lengthScale",[D2],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return 1}}),q2=de(V2.prototype,"_mesh",[N2],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return null}}),de(V2.prototype,"mesh",[z2],Object.getOwnPropertyDescriptor(V2.prototype,"mesh"),V2.prototype),de(V2.prototype,"particleMaterial",[B2],Object.getOwnPropertyDescriptor(V2.prototype,"particleMaterial"),V2.prototype),de(V2.prototype,"trailMaterial",[G2],Object.getOwnPropertyDescriptor(V2.prototype,"trailMaterial"),V2.prototype),Y2=de(V2.prototype,"_mainTexture",[Ko],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return null}}),K2=de(V2.prototype,"_useGPU",[Ko],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return!1}}),de(V2.prototype,"useGPU",[U2],Object.getOwnPropertyDescriptor(V2.prototype,"useGPU"),V2.prototype),X2=V2))||X2),P5=Math.cos(di(100)),L5={position:new Ii,velocity:new Ii},D5=new Xi,N5=new Ki,z5=new Ii,B5=new Ii,G5=new an,U5=function(){function e(t){for(Z(this,e),this.start=void 0,this.end=void 0,this.trailElements=void 0,this.start=-1,this.end=-1,this.trailElements=[];t--;)this.trailElements.push({position:new Ii,lifetime:0,width:0,velocity:new Ii,direction:0,color:new an})}return J(e,[{key:"getElement",value:function(e){return-1===this.start?null:(e<0&&(e=(e+this.trailElements.length)%this.trailElements.length),e>=this.trailElements.length&&(e%=this.trailElements.length),this.trailElements[e])}},{key:"addElement",value:function(){if(0===this.trailElements.length)return null;if(-1===this.start)return this.start=0,this.end=1,this.trailElements[0];this.start===this.end&&(this.trailElements.splice(this.end,0,{position:new Ii,lifetime:0,width:0,velocity:new Ii,direction:0,color:new an}),this.start++,this.start%=this.trailElements.length);var e=this.end++;return this.end%=this.trailElements.length,this.trailElements[e]}},{key:"iterateElement",value:function(e,t,i,n){for(var r=this.start>=this.end?this.end+this.trailElements.length:this.end,a=this.start;a<r;a++)t(e,this.trailElements[a%this.trailElements.length],i,n)&&(this.start++,this.start%=this.trailElements.length);this.start===r&&(this.start=-1,this.end=-1)}},{key:"count",value:function(){return this.start<this.end?this.end-this.start:this.trailElements.length+this.end-this.start}},{key:"clear",value:function(){this.start=-1,this.end=-1}}]),e}(),X5=(T3=Yo("cc.TrailModule"),S3=Ko({displayOrder:0}),E3=Ko({type:r$,displayOrder:1,tooltip:"Particle在每个粒子的运动轨迹上形成拖尾效果"}),w3=Ko({type:SQ,displayOrder:3,tooltip:"拖尾的生命周期"}),C3=Ko({displayOrder:5,tooltip:"粒子每生成一个拖尾节点所运行的最短距离"}),A3=Ko({type:$J,displayOrder:6,tooltip:"拖尾所在的坐标系，World在世界坐标系中运行，Local在本地坐标系中运行"}),O3=Ko({displayOrder:7,tooltip:"拖尾是否跟随粒子一起消失",visible:!1}),k3=Ko({type:a$,displayOrder:8,tooltip:"贴图在拖尾上的展开形式，Stretch贴图覆盖在整条拖尾上，Repeat贴图覆盖在一段拖尾上"}),R3=Ko({displayOrder:9,tooltip:"拖尾宽度继承自粒子大小"}),F3=Ko({type:SQ,displayOrder:10,tooltip:"拖尾宽度，如果继承自粒子则是粒子大小的比例"}),M3=Ko({displayOrder:11,tooltip:"拖尾颜色是否继承自粒子"}),I3=Ko({type:vJ,displayOrder:12,tooltip:"拖尾颜色随拖尾自身长度的颜色渐变"}),P3=Ko({type:vJ,displayOrder:13,tooltip:"拖尾颜色随时间的颜色渐变"}),L3=Ko({type:$J}),T3((de((N3=function(){function e(){Z(this,e),fe(this,"_enable",z3,this),fe(this,"mode",B3,this),fe(this,"lifeTime",G3,this),fe(this,"_minParticleDistance",U3,this),fe(this,"existWithParticles",X3,this),fe(this,"textureMode",V3,this),fe(this,"widthFromParticle",H3,this),fe(this,"widthRatio",W3,this),fe(this,"colorFromParticle",j3,this),fe(this,"colorOverTrail",q3,this),fe(this,"colorOvertime",Y3,this),fe(this,"_space",K3,this),fe(this,"_particleSystem",Z3,this),this._minSquaredDistance=0,this._vertSize=void 0,this._trailNum=0,this._trailLifetime=0,this.vbOffset=0,this.ibOffset=0,this._trailSegments=null,this._particleTrail=void 0,this._trailModel=null,this._iaInfo=void 0,this._iaInfoBuffer=null,this._subMeshData=null,this._vertAttrs=void 0,this._vbF32=null,this._vbUint32=null,this._iBuffer=null,this._needTransform=!1,this._defaultMat=null,this._iaInfo={drawInfos:[{vertexCount:0,firstVertex:0,indexCount:0,firstIndex:0,vertexOffset:0,instanceCount:0,firstInstance:0}]},this._vertAttrs=[{name:exports.GFXAttributeName.ATTR_POSITION,format:exports.GFXFormat.RGB32F},{name:exports.GFXAttributeName.ATTR_TEX_COORD,format:exports.GFXFormat.RGBA32F},{name:exports.GFXAttributeName.ATTR_TEX_COORD1,format:exports.GFXFormat.RGB32F},{name:exports.GFXAttributeName.ATTR_COLOR,format:exports.GFXFormat.RGBA8,isNormalized:!0}],this._vertSize=0;for(var t,i=_e(this._vertAttrs);!(t=i()).done;){var n=t.value;this._vertSize+=yr[n.format].size}this._particleTrail=new Map}return J(e,[{key:"enable",get:function(){return this._enable},set:function(e){e===this._enable&&this._trailModel||(e&&!this._trailModel&&this._createModel(),e&&!this._enable&&(this._enable=e,this._particleSystem.processor.updateTrailMaterial()),this._enable=e,this._trailModel&&(this._trailModel.enabled=e),e?this.onEnable():this.onDisable())}},{key:"minParticleDistance",get:function(){return this._minParticleDistance},set:function(e){this._minParticleDistance=e,this._minSquaredDistance=e*e}},{key:"space",get:function(){return this._space},set:function(e){this._space=e,this._particleSystem&&this._particleSystem.processor.updateTrailMaterial()}}]),J(e,[{key:"onInit",value:function(e){this._particleSystem=e,this.minParticleDistance=this._minParticleDistance;for(var t=0,i=e.startLifetime.getMax(),n=e.rateOverTime.getMax(),r=e.duration,a=0,o=e.bursts.length;a<o;a++){t+=e.bursts[a].getMaxCount(e)*Math.ceil(i/r)}this._trailNum=Math.ceil(i*this.lifeTime.getMax()*60*(n*r+t)),this._trailSegments=new To((function(){return new U5(10)}),Math.ceil(n*r)),this._enable&&(this.enable=this._enable,this._updateMaterial())}},{key:"onEnable",value:function(){this._attachToScene()}},{key:"onDisable",value:function(){this._particleTrail.clear(),this._detachFromScene()}},{key:"_attachToScene",value:function(){this._trailModel&&(this._trailModel.scene&&this._detachFromScene(),this._particleSystem._getRenderScene().addModel(this._trailModel))}},{key:"_detachFromScene",value:function(){this._trailModel&&this._trailModel.scene&&this._trailModel.scene.removeModel(this._trailModel)}},{key:"destroy",value:function(){this.destroySubMeshData(),this._trailModel&&(_O.root.destroyModel(this._trailModel),this._trailModel=null),this._trailSegments&&(this._trailSegments.clear((function(e){e.trailElements.length=0})),this._trailSegments=null)}},{key:"clear",value:function(){if(this.enable){for(var e=this._particleTrail.values(),t=e.next();!t.done;)t.value.clear(),t=e.next();this._particleTrail.clear(),this.updateRenderData()}}},{key:"_updateMaterial",value:function(){if(this._particleSystem&&this._trailModel){var e=this._particleSystem.getMaterialInstance(1);e?this._trailModel.setSubModelMaterial(0,e):this._trailModel.setSubModelMaterial(0,this._particleSystem.processor._defaultTrailMat)}}},{key:"update",value:function(){this._trailLifetime=this.lifeTime.evaluate(this._particleSystem._time,1),this.space===$J.World&&this._particleSystem._simulationSpace===$J.Local?(this._needTransform=!0,this._particleSystem.node.getWorldMatrix(N5),this._particleSystem.node.getWorldRotation(D5)):this._needTransform=!1}},{key:"animate",value:function(e,t){if(this._trailSegments){var i=this._particleTrail.get(e);if(!i)return i=this._trailSegments.alloc(),void this._particleTrail.set(e,i);var n=i.getElement(i.end-1);if(this._needTransform?Ii.transformMat4(z5,e.position,N5):Ii.copy(z5,e.position),!(n&&(i.iterateElement(this,this._updateTrailElement,e,t),Ii.squaredDistance(n.position,z5)<this._minSquaredDistance))&&(n=i.addElement())){Ii.copy(n.position,z5),n.lifetime=0,this.widthFromParticle?n.width=e.size.x*this.widthRatio.evaluate(0,1):n.width=this.widthRatio.evaluate(0,1);var r=i.count();if(2===r){var a=i.getElement(i.end-2);Ii.subtract(a.velocity,n.position,a.position)}else if(r>2){var o=i.getElement(i.end-2),s=i.getElement(i.end-3);Ii.subtract(z5,s.position,o.position),Ii.subtract(B5,n.position,o.position),Ii.subtract(o.velocity,B5,z5),Ii.equals(Ii.ZERO,o.velocity)&&Ii.copy(o.velocity,z5),Ii.normalize(o.velocity,o.velocity),this._checkDirectionReverse(o,s)}this.colorFromParticle?n.color.set(e.color):n.color.set(this.colorOvertime.evaluate(0,1))}}}},{key:"removeParticle",value:function(e){var t=this._particleTrail.get(e);t&&this._trailSegments&&(t.clear(),this._trailSegments.free(t),this._particleTrail.delete(e))}},{key:"updateRenderData",value:function(){this.vbOffset=0,this.ibOffset=0;for(var e,t=_e(this._particleTrail.keys());!(e=t()).done;){var i=e.value,n=this._particleTrail.get(i);if(-1!==n.start){var r=4*this.vbOffset/this._vertSize,a=n.start>=n.end?n.end+n.trailElements.length:n.end,o=a-n.start,s=1/o,l=n.trailElements[n.start];this._fillVertexBuffer(l,this.colorOverTrail.evaluate(1,1),r,1,0,4);for(var u=n.start+1;u<a;u++){var c=n.trailElements[u%n.trailElements.length],h=u-n.start;this._fillVertexBuffer(c,this.colorOverTrail.evaluate(1-h/o,1),r,1-h*s,h,5)}if(this._needTransform?Ii.transformMat4(L5.position,i.position,N5):Ii.copy(L5.position,i.position),1===o||2===o){var p=n.getElement(n.end-1);Ii.subtract(p.velocity,L5.position,p.position),this._vbF32[this.vbOffset-this._vertSize/4-4]=p.velocity.x,this._vbF32[this.vbOffset-this._vertSize/4-3]=p.velocity.y,this._vbF32[this.vbOffset-this._vertSize/4-2]=p.velocity.z,this._vbF32[this.vbOffset-4]=p.velocity.x,this._vbF32[this.vbOffset-3]=p.velocity.y,this._vbF32[this.vbOffset-2]=p.velocity.z,Ii.subtract(L5.velocity,L5.position,p.position),this._checkDirectionReverse(L5,p)}else if(o>2){var _=n.getElement(n.end-1),f=n.getElement(n.end-2);Ii.subtract(z5,f.position,_.position),Ii.subtract(B5,L5.position,_.position),Ii.normalize(z5,z5),Ii.normalize(B5,B5),Ii.subtract(_.velocity,B5,z5),Ii.normalize(_.velocity,_.velocity),this._checkDirectionReverse(_,f),this.vbOffset-=this._vertSize/4*2,this.ibOffset-=6,this._fillVertexBuffer(_,this.colorOverTrail.evaluate(s,1),r,s,o-1,5),Ii.subtract(L5.velocity,L5.position,_.position),Ii.normalize(L5.velocity,L5.velocity),this._checkDirectionReverse(L5,_)}this.widthFromParticle?L5.width=i.size.x*this.widthRatio.evaluate(0,1):L5.width=this.widthRatio.evaluate(0,1),L5.color=i.color,Ii.equals(L5.velocity,Ii.ZERO)?this.ibOffset-=3:this._fillVertexBuffer(L5,this.colorOverTrail.evaluate(0,1),r,0,o,1)}}this.updateIA(this.ibOffset)}},{key:"updateIA",value:function(e){if(this._trailModel&&this._trailModel.subModelNum>0){var t=this._trailModel.getSubModel(0);t.inputAssembler.vertexBuffers[0].update(this._vbF32),t.inputAssembler.indexBuffer.update(this._iBuffer),t.inputAssembler.indexCount=e,this._iaInfo.drawInfos[0]=t.inputAssembler,this._iaInfoBuffer.update(this._iaInfo)}}},{key:"_createModel",value:function(){if(!this._trailModel){var e=_O.root.device,t=e.createBuffer({usage:exports.GFXBufferUsageBit.VERTEX|exports.GFXBufferUsageBit.TRANSFER_DST,memUsage:exports.GFXMemoryUsageBit.HOST|exports.GFXMemoryUsageBit.DEVICE,size:this._vertSize*(this._trailNum+1)*2,stride:this._vertSize}),i=new ArrayBuffer(this._vertSize*(this._trailNum+1)*2);this._vbF32=new Float32Array(i),this._vbUint32=new Uint32Array(i),t.update(i);var n=e.createBuffer({usage:exports.GFXBufferUsageBit.INDEX|exports.GFXBufferUsageBit.TRANSFER_DST,memUsage:exports.GFXMemoryUsageBit.HOST|exports.GFXMemoryUsageBit.DEVICE,size:6*this._trailNum*Uint16Array.BYTES_PER_ELEMENT,stride:Uint16Array.BYTES_PER_ELEMENT});this._iBuffer=new Uint16Array(6*this._trailNum),n.update(this._iBuffer),this._iaInfoBuffer=e.createBuffer({usage:exports.GFXBufferUsageBit.INDIRECT,memUsage:exports.GFXMemoryUsageBit.HOST|exports.GFXMemoryUsageBit.DEVICE,size:56,stride:1}),this._iaInfo.drawInfos[0].vertexCount=2*(this._trailNum+1),this._iaInfo.drawInfos[0].indexCount=6*this._trailNum,this._iaInfoBuffer.update(this._iaInfo),this._subMeshData=new tc([t],this._vertAttrs,exports.GFXPrimitiveMode.TRIANGLE_LIST),this._subMeshData.indexBuffer=n,this._subMeshData.indirectBuffer=this._iaInfoBuffer,this._trailModel=_O.root.createModel(ah),this._trailModel.initialize(this._particleSystem.node),this._trailModel.visFlags=this._particleSystem.visibility,this._trailModel.setSubModelMesh(0,this._subMeshData),this._trailModel.enabled=!0}}},{key:"_updateTrailElement",value:function(e,t,i,n){return t.lifetime+=n,e.colorFromParticle?(t.color.set(i.color),t.color.multiply(e.colorOvertime.evaluate(1-i.remainingLifetime/i.startLifetime,1))):t.color.set(e.colorOvertime.evaluate(1-i.remainingLifetime/i.startLifetime,1)),e.widthFromParticle?t.width=i.size.x*e.widthRatio.evaluate(t.lifetime/e._trailLifetime,1):t.width=e.widthRatio.evaluate(t.lifetime/e._trailLifetime,1),t.lifetime>e._trailLifetime}},{key:"_fillVertexBuffer",value:function(e,t,i,n,r,a){this._vbF32[this.vbOffset++]=e.position.x,this._vbF32[this.vbOffset++]=e.position.y,this._vbF32[this.vbOffset++]=e.position.z,this._vbF32[this.vbOffset++]=e.direction,this._vbF32[this.vbOffset++]=e.width,this._vbF32[this.vbOffset++]=n,this._vbF32[this.vbOffset++]=0,this._vbF32[this.vbOffset++]=e.velocity.x,this._vbF32[this.vbOffset++]=e.velocity.y,this._vbF32[this.vbOffset++]=e.velocity.z,G5.set(e.color),G5.multiply(t),this._vbUint32[this.vbOffset++]=G5._val,this._vbF32[this.vbOffset++]=e.position.x,this._vbF32[this.vbOffset++]=e.position.y,this._vbF32[this.vbOffset++]=e.position.z,this._vbF32[this.vbOffset++]=1-e.direction,this._vbF32[this.vbOffset++]=e.width,this._vbF32[this.vbOffset++]=n,this._vbF32[this.vbOffset++]=1,this._vbF32[this.vbOffset++]=e.velocity.x,this._vbF32[this.vbOffset++]=e.velocity.y,this._vbF32[this.vbOffset++]=e.velocity.z,this._vbUint32[this.vbOffset++]=G5._val,1&a&&(this._iBuffer[this.ibOffset++]=i+2*r,this._iBuffer[this.ibOffset++]=i+2*r-1,this._iBuffer[this.ibOffset++]=i+2*r+1),4&a&&(this._iBuffer[this.ibOffset++]=i+2*r,this._iBuffer[this.ibOffset++]=i+2*r+1,this._iBuffer[this.ibOffset++]=i+2*r+2)}},{key:"_checkDirectionReverse",value:function(e,t){Ii.dot(e.velocity,t.velocity)<P5?e.direction=1-t.direction:e.direction=t.direction}},{key:"destroySubMeshData",value:function(){this._subMeshData&&(this._subMeshData.destroy(),this._subMeshData=null)}}]),e}()).prototype,"enable",[S3],Object.getOwnPropertyDescriptor(N3.prototype,"enable"),N3.prototype),z3=de(N3.prototype,"_enable",[Ko],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return!1}}),B3=de(N3.prototype,"mode",[E3],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return r$.Particles}}),G3=de(N3.prototype,"lifeTime",[w3],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return new SQ}}),U3=de(N3.prototype,"_minParticleDistance",[Ko],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return.1}}),de(N3.prototype,"minParticleDistance",[C3],Object.getOwnPropertyDescriptor(N3.prototype,"minParticleDistance"),N3.prototype),de(N3.prototype,"space",[A3],Object.getOwnPropertyDescriptor(N3.prototype,"space"),N3.prototype),X3=de(N3.prototype,"existWithParticles",[O3],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return!0}}),V3=de(N3.prototype,"textureMode",[k3],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return a$.Stretch}}),H3=de(N3.prototype,"widthFromParticle",[R3],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return!0}}),W3=de(N3.prototype,"widthRatio",[F3],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return new SQ}}),j3=de(N3.prototype,"colorFromParticle",[M3],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return!1}}),q3=de(N3.prototype,"colorOverTrail",[I3],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return new vJ}}),Y3=de(N3.prototype,"colorOvertime",[P3],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return new vJ}}),K3=de(N3.prototype,"_space",[L3],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return $J.World}}),Z3=de(N3.prototype,"_particleSystem",[Ko],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return null}}),D3=N3))||D3),V5=new Ki,H5=new Xi,W5=(Q3=Yo("cc.ParticleSystemComponent"),J3=os("i18n:cc.ParticleSystemComponent"),$3=es("Components/ParticleSystem"),e4=ts(99),t4=Ko({displayOrder:1,tooltip:"粒子系统能生成的最大粒子数量"}),i4=Ko({type:vJ,displayOrder:8,tooltip:"粒子初始颜色"}),n4=Ko({type:$J,displayOrder:9,tooltip:"选择缩放坐标系"}),r4=Ko({displayOrder:10,tooltip:"粒子初始大小"}),a4=Ko({type:SQ,displayOrder:10,formerlySerializedAs:"startSize",tooltip:"粒子初始大小"}),o4=Ko({type:SQ,displayOrder:10,tooltip:"粒子初始大小"}),s4=Ko({type:SQ,displayOrder:10,tooltip:"粒子初始大小"}),l4=Ko({type:SQ,range:[-1,1],displayOrder:11,tooltip:"粒子初始速度"}),u4=Ko({displayOrder:12,tooltip:"粒子初始旋转角度"}),c4=Ko({type:SQ,range:[-1,1],radian:!0,displayOrder:12,tooltip:"粒子初始旋转角度"}),h4=Ko({type:SQ,range:[-1,1],radian:!0,displayOrder:12,tooltip:"粒子初始旋转角度"}),p4=Ko({type:SQ,range:[-1,1],radian:!0,displayOrder:12,formerlySerializedAs:"startRotation",tooltip:"粒子初始旋转角度"}),_4=Ko({type:SQ,displayOrder:6,tooltip:"粒子系统开始运行后，延迟粒子发射的时间"}),f4=Ko({type:SQ,displayOrder:7,tooltip:"粒子生命周期"}),d4=Ko({displayOrder:0,tooltip:"粒子系统运行时间"}),m4=Ko({displayOrder:2,tooltip:"粒子系统是否循环播放"}),v4=Ko({displayOrder:3,tooltip:"选中之后，粒子系统会以已播放完一轮之后的状态开始播放（仅当循环播放启用时有效）"}),y4=Ko({type:$J,displayOrder:4,tooltip:"控制粒子坐标计算所在的坐标系"}),g4=Ko({displayOrder:5,tooltip:"控制整个粒子系统的更新速度"}),x4=Ko({displayOrder:2,tooltip:"粒子系统加载后是否自动开始播放"}),b4=Ko({type:SQ,range:[-1,1],displayOrder:13,tooltip:"粒子受重力影响的重力系数"}),T4=Ko({type:SQ,displayOrder:14,tooltip:"每秒发射的粒子数"}),S4=Ko({type:SQ,displayOrder:15,tooltip:"每移动单位距离发射的粒子数"}),E4=Ko({type:[E2],displayOrder:16,tooltip:"在某个时间点发射给定数量的粒子"}),w4=Ko({type:Bh,displayName:"Materials",visible:!1,override:!0}),C4=Ko({type:d$}),A4=Ko({type:d$,displayOrder:23,tooltip:"颜色模块"}),O4=Ko({type:O2}),k4=Ko({type:O2,displayOrder:17,tooltip:"发射器模块"}),R4=Ko({type:f2}),F4=Ko({type:f2,displayOrder:21,tooltip:"大小模块"}),M4=Ko({type:S2}),I4=Ko({type:S2,displayOrder:18,tooltip:"速度模块"}),P4=Ko({type:r0}),L4=Ko({type:r0,displayOrder:19,tooltip:"加速度模块"}),D4=Ko({type:l0}),N4=Ko({type:l0,displayOrder:20,tooltip:"限速模块"}),z4=Ko({type:p2}),B4=Ko({type:p2,displayOrder:22,tooltip:"旋转模块"}),G4=Ko({type:y2}),U4=Ko({type:y2,displayOrder:24,tooltip:"贴图动画模块"}),X4=Ko({type:X5}),V4=Ko({type:X5,displayOrder:25,tooltip:"拖尾模块"}),H4=Ko({type:I5,displayOrder:26,tooltip:"渲染模块"}),W4=Ko({displayOrder:27,tooltip:"是否剔除非 enable 的模块数据"}),Q3(j4=J3(j4=$3(j4=e4(j4=Jo((de((q4=function(e){function t(){var e;return Z(this,t),fe(e=re(this,te(t).call(this)),"startColor",Y4,ne(e)),fe(e,"scaleSpace",K4,ne(e)),fe(e,"startSize3D",Z4,ne(e)),fe(e,"startSizeX",Q4,ne(e)),fe(e,"startSizeY",J4,ne(e)),fe(e,"startSizeZ",$4,ne(e)),fe(e,"startSpeed",e5,ne(e)),fe(e,"startRotation3D",t5,ne(e)),fe(e,"startRotationX",i5,ne(e)),fe(e,"startRotationY",n5,ne(e)),fe(e,"startRotationZ",r5,ne(e)),fe(e,"startDelay",a5,ne(e)),fe(e,"startLifetime",o5,ne(e)),fe(e,"duration",s5,ne(e)),fe(e,"loop",l5,ne(e)),fe(e,"simulationSpeed",u5,ne(e)),fe(e,"playOnAwake",c5,ne(e)),fe(e,"gravityModifier",h5,ne(e)),fe(e,"rateOverTime",p5,ne(e)),fe(e,"rateOverDistance",_5,ne(e)),fe(e,"bursts",f5,ne(e)),fe(e,"_colorOverLifetimeModule",d5,ne(e)),fe(e,"_shapeModule",m5,ne(e)),fe(e,"_sizeOvertimeModule",v5,ne(e)),fe(e,"_velocityOvertimeModule",y5,ne(e)),fe(e,"_forceOvertimeModule",g5,ne(e)),fe(e,"_limitVelocityOvertimeModule",x5,ne(e)),fe(e,"_rotationOvertimeModule",b5,ne(e)),fe(e,"_textureAnimationModule",T5,ne(e)),fe(e,"_trailModule",S5,ne(e)),fe(e,"renderer",E5,ne(e)),fe(e,"enableCulling",w5,ne(e)),e._isPlaying=void 0,e._isPaused=void 0,e._isStopped=void 0,e._isEmitting=void 0,e._time=void 0,e._emitRateTimeCounter=void 0,e._emitRateDistanceCounter=void 0,e._oldWPos=void 0,e._curWPos=void 0,e._customData1=void 0,e._customData2=void 0,e._subEmitters=void 0,fe(e,"_prewarm",C5,ne(e)),fe(e,"_capacity",A5,ne(e)),fe(e,"_simulationSpace",O5,ne(e)),e.processor=null,e.rateOverTime.constant=10,e.startLifetime.constant=5,e.startSizeX.constant=1,e.startSpeed.constant=5,e._isPlaying=!1,e._isPaused=!1,e._isStopped=!0,e._isEmitting=!1,e._time=0,e._emitRateTimeCounter=0,e._emitRateDistanceCounter=0,e._oldWPos=new Ii,e._curWPos=new Ii,e._customData1=new ki,e._customData2=new ki,e._subEmitters=[],e}return ee(t,Hp),J(t,[{key:"capacity",get:function(){return this._capacity},set:function(e){this._capacity=Math.floor(e),this.processor&&this.processor._model&&this.processor._model.setCapacity(this._capacity)}},{key:"prewarm",get:function(){return this._prewarm},set:function(e){!0===e&&this.loop,this._prewarm=e}},{key:"simulationSpace",get:function(){return this._simulationSpace},set:function(e){e!==this._simulationSpace&&(this._simulationSpace=e,this.processor&&(this.processor.updateMaterialParams(),this.processor.updateTrailMaterial()))}},{key:"sharedMaterials",get:function(){return oe(te(t.prototype),"sharedMaterials",this)},set:function(e){le(te(t.prototype),"sharedMaterials",e,this,!0)}},{key:"colorOverLifetimeModule",get:function(){return this._colorOverLifetimeModule},set:function(e){e&&(this._colorOverLifetimeModule=e)}},{key:"shapeModule",get:function(){return this._shapeModule},set:function(e){e&&(this._shapeModule=e)}},{key:"sizeOvertimeModule",get:function(){return this._sizeOvertimeModule},set:function(e){e&&(this._sizeOvertimeModule=e)}},{key:"velocityOvertimeModule",get:function(){return this._velocityOvertimeModule},set:function(e){e&&(this._velocityOvertimeModule=e)}},{key:"forceOvertimeModule",get:function(){return this._forceOvertimeModule},set:function(e){e&&(this._forceOvertimeModule=e)}},{key:"limitVelocityOvertimeModule",get:function(){return this._limitVelocityOvertimeModule},set:function(e){e&&(this._limitVelocityOvertimeModule=e)}},{key:"rotationOvertimeModule",get:function(){return this._rotationOvertimeModule},set:function(e){e&&(this._rotationOvertimeModule=e)}},{key:"textureAnimationModule",get:function(){return this._textureAnimationModule},set:function(e){e&&(this._textureAnimationModule=e)}},{key:"trailModule",get:function(){return this._trailModule},set:function(e){e&&(this._trailModule=e)}}]),J(t,[{key:"onLoad",value:function(){this.renderer.onInit(this),this._shapeModule&&this._shapeModule.onInit(this),this._trailModule&&this._trailModule.onInit(this),this.bindModule(),this._resetPosition()}},{key:"_onMaterialModified",value:function(e,t){this.processor.onMaterialModified(e,t)}},{key:"_onRebuildPSO",value:function(e,t){this.processor.onRebuildPSO(e,t)}},{key:"_collectModels",value:function(){return this._models.length=0,this._models.push(this.processor._model),this._trailModule&&this._trailModule.enable&&this._trailModule._trailModel&&this._models.push(this._trailModule._trailModel),this._models}},{key:"_attachToScene",value:function(){this.processor.attachToScene(),this._trailModule&&this._trailModule.enable&&this._trailModule._attachToScene()}},{key:"_detachFromScene",value:function(){this.processor.detachFromScene(),this._trailModule&&this._trailModule.enable&&this._trailModule._detachFromScene()}},{key:"bindModule",value:function(){this._colorOverLifetimeModule&&this._colorOverLifetimeModule.bindTarget(this.processor),this._sizeOvertimeModule&&this._sizeOvertimeModule.bindTarget(this.processor),this._rotationOvertimeModule&&this._rotationOvertimeModule.bindTarget(this.processor),this._forceOvertimeModule&&this._forceOvertimeModule.bindTarget(this.processor),this._limitVelocityOvertimeModule&&this._limitVelocityOvertimeModule.bindTarget(this.processor),this._velocityOvertimeModule&&this._velocityOvertimeModule.bindTarget(this.processor),this._textureAnimationModule&&this._textureAnimationModule.bindTarget(this.processor)}},{key:"play",value:function(){this._isPaused&&(this._isPaused=!1),this._isStopped&&(this._isStopped=!1),this._isPlaying=!0,this._isEmitting=!0,this._resetPosition(),this._prewarm&&this._prewarmSystem()}},{key:"pause",value:function(){this._isStopped?console.warn("pause(): particle system is already stopped."):(this._isPlaying&&(this._isPlaying=!1),this._isPaused=!0)}},{key:"stop",value:function(){(this._isPlaying||this._isPaused)&&this.clear(),this._isPlaying&&(this._isPlaying=!1),this._isPaused&&(this._isPaused=!1),this._time=0,this._emitRateTimeCounter=0,this._emitRateDistanceCounter=0,this._isStopped=!0}},{key:"clear",value:function(){this.enabledInHierarchy&&(this.processor.clear(),this._trailModule&&this._trailModule.clear())}},{key:"getParticleCount",value:function(){return this.processor.getParticleCount()}},{key:"setCustomData1",value:function(e,t){ki.set(this._customData1,e,t)}},{key:"setCustomData2",value:function(e,t){ki.set(this._customData2,e,t)}},{key:"onDestroy",value:function(){this.processor.onDestroy(),this._trailModule&&this._trailModule.destroy()}},{key:"onEnable",value:function(){this.playOnAwake&&this.play(),this.processor.onEnable(),this._trailModule&&this._trailModule.onEnable()}},{key:"onDisable",value:function(){this.processor.onDisable(),this._trailModule&&this._trailModule.onDisable()}},{key:"update",value:function(e){var t=e*this.simulationSpeed;this._isPlaying&&(this._time+=t,this._emit(t),0!==this.processor.updateParticles(t)||this._isEmitting||this.stop(),this.processor.updateRenderData(),this._trailModule&&this._trailModule.enable&&this._trailModule.updateRenderData())}},{key:"_onVisibilityChange",value:function(e){this.processor._model&&(this.processor._model.visFlags=e)}},{key:"emit",value:function(e,t){var i=this._time/this.duration;this._simulationSpace===$J.World&&(this.node.getWorldMatrix(V5),this.node.getWorldRotation(H5));for(var n=0;n<e;++n){var r=this.processor.getFreeParticle();if(null===r)return;var a=xi(gi(0,2147483647));this._shapeModule&&this._shapeModule.enable?this._shapeModule.emit(r):(Ii.set(r.position,0,0,0),Ii.copy(r.velocity,m$)),this._textureAnimationModule&&this._textureAnimationModule.enable&&this._textureAnimationModule.init(r),Ii.multiplyScalar(r.velocity,r.velocity,this.startSpeed.evaluate(i,a)),this._simulationSpace===$J.World&&(Ii.transformMat4(r.position,r.position,V5),Ii.transformQuat(r.velocity,r.velocity,H5)),Ii.copy(r.ultimateVelocity,r.velocity),this.startRotation3D?Ii.set(r.rotation,this.startRotationX.evaluate(i,a),this.startRotationY.evaluate(i,a),this.startRotationZ.evaluate(i,a)):Ii.set(r.rotation,0,0,this.startRotationZ.evaluate(i,a)),this.startSize3D?Ii.set(r.startSize,this.startSizeX.evaluate(i,a),this.startSizeY.evaluate(i,a),this.startSizeZ.evaluate(i,a)):(Ii.set(r.startSize,this.startSizeX.evaluate(i,a),1,1),r.startSize.y=r.startSize.x),Ii.copy(r.size,r.startSize),r.startColor.set(this.startColor.evaluate(i,a)),r.color.set(r.startColor),r.startLifetime=this.startLifetime.evaluate(i,a)+t,r.remainingLifetime=r.startLifetime,r.randomSeed=gi(0,233280),this.processor.setNewParticle(r)}}},{key:"_prewarmSystem",value:function(){this.startDelay.mode=TQ.Constant,this.startDelay.constant=0;for(var e=this.duration/1,t=0;t<e;++t)this._time+=1,this._emit(1),this.processor.updateParticles(1)}},{key:"_emit",value:function(e){var t=this.startDelay.evaluate(0,1);if(this._time>t){if(this._time>this.duration+t&&!this.loop)return void(this._isEmitting=!1);if(this._emitRateTimeCounter+=this.rateOverTime.evaluate(this._time/this.duration,1)*e,this._emitRateTimeCounter>1&&this._isEmitting){var i=Math.floor(this._emitRateTimeCounter);this._emitRateTimeCounter-=i,this.emit(i,e)}this.node.getWorldPosition(this._curWPos);var n=Ii.distance(this._curWPos,this._oldWPos);if(Ii.copy(this._oldWPos,this._curWPos),this._emitRateDistanceCounter+=n*this.rateOverDistance.evaluate(this._time/this.duration,1),this._emitRateDistanceCounter>1&&this._isEmitting){var r=Math.floor(this._emitRateDistanceCounter);this._emitRateDistanceCounter-=r,this.emit(r,e)}for(var a,o=_e(this.bursts);!(a=o()).done;){a.value.update(this,e)}}}},{key:"_resetPosition",value:function(){this.node.getWorldPosition(this._oldWPos),Ii.copy(this._curWPos,this._oldWPos)}},{key:"addSubEmitter",value:function(e){this._subEmitters.push(e)}},{key:"removeSubEmitter",value:function(e){this._subEmitters.splice(this._subEmitters.indexOf(e),1)}},{key:"addBurst",value:function(e){this.bursts.push(e)}},{key:"removeBurst",value:function(e){this.bursts.splice(this.bursts.indexOf(e),1)}},{key:"_onBeforeSerialize",value:function(e){var t=this;return this.enableCulling?e.filter((function(e){return!QJ.includes(e)||t[e]&&t[e].enable})):e}},{key:"isPlaying",get:function(){return this._isPlaying}},{key:"isPaused",get:function(){return this._isPaused}},{key:"isStopped",get:function(){return this._isStopped}},{key:"isEmitting",get:function(){return this._isEmitting}},{key:"time",get:function(){return this._time}}]),t}()).prototype,"capacity",[t4],Object.getOwnPropertyDescriptor(q4.prototype,"capacity"),q4.prototype),Y4=de(q4.prototype,"startColor",[i4],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return new vJ}}),K4=de(q4.prototype,"scaleSpace",[n4],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return $J.Local}}),Z4=de(q4.prototype,"startSize3D",[r4],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return!1}}),Q4=de(q4.prototype,"startSizeX",[a4],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return new SQ}}),J4=de(q4.prototype,"startSizeY",[o4],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return new SQ}}),$4=de(q4.prototype,"startSizeZ",[s4],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return new SQ}}),e5=de(q4.prototype,"startSpeed",[l4],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return new SQ}}),t5=de(q4.prototype,"startRotation3D",[u4],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return!1}}),i5=de(q4.prototype,"startRotationX",[c4],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return new SQ}}),n5=de(q4.prototype,"startRotationY",[h4],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return new SQ}}),r5=de(q4.prototype,"startRotationZ",[p4],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return new SQ}}),a5=de(q4.prototype,"startDelay",[_4],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return new SQ}}),o5=de(q4.prototype,"startLifetime",[f4],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return new SQ}}),s5=de(q4.prototype,"duration",[d4],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return 5}}),l5=de(q4.prototype,"loop",[m4],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return!0}}),de(q4.prototype,"prewarm",[v4],Object.getOwnPropertyDescriptor(q4.prototype,"prewarm"),q4.prototype),de(q4.prototype,"simulationSpace",[y4],Object.getOwnPropertyDescriptor(q4.prototype,"simulationSpace"),q4.prototype),u5=de(q4.prototype,"simulationSpeed",[g4],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return 1}}),c5=de(q4.prototype,"playOnAwake",[x4],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return!0}}),h5=de(q4.prototype,"gravityModifier",[b4],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return new SQ}}),p5=de(q4.prototype,"rateOverTime",[T4],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return new SQ}}),_5=de(q4.prototype,"rateOverDistance",[S4],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return new SQ}}),f5=de(q4.prototype,"bursts",[E4],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return new Array}}),de(q4.prototype,"sharedMaterials",[w4],Object.getOwnPropertyDescriptor(q4.prototype,"sharedMaterials"),q4.prototype),d5=de(q4.prototype,"_colorOverLifetimeModule",[C4],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return null}}),de(q4.prototype,"colorOverLifetimeModule",[A4],Object.getOwnPropertyDescriptor(q4.prototype,"colorOverLifetimeModule"),q4.prototype),m5=de(q4.prototype,"_shapeModule",[O4],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return null}}),de(q4.prototype,"shapeModule",[k4],Object.getOwnPropertyDescriptor(q4.prototype,"shapeModule"),q4.prototype),v5=de(q4.prototype,"_sizeOvertimeModule",[R4],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return null}}),de(q4.prototype,"sizeOvertimeModule",[F4],Object.getOwnPropertyDescriptor(q4.prototype,"sizeOvertimeModule"),q4.prototype),y5=de(q4.prototype,"_velocityOvertimeModule",[M4],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return null}}),de(q4.prototype,"velocityOvertimeModule",[I4],Object.getOwnPropertyDescriptor(q4.prototype,"velocityOvertimeModule"),q4.prototype),g5=de(q4.prototype,"_forceOvertimeModule",[P4],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return null}}),de(q4.prototype,"forceOvertimeModule",[L4],Object.getOwnPropertyDescriptor(q4.prototype,"forceOvertimeModule"),q4.prototype),x5=de(q4.prototype,"_limitVelocityOvertimeModule",[D4],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return null}}),de(q4.prototype,"limitVelocityOvertimeModule",[N4],Object.getOwnPropertyDescriptor(q4.prototype,"limitVelocityOvertimeModule"),q4.prototype),b5=de(q4.prototype,"_rotationOvertimeModule",[z4],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return null}}),de(q4.prototype,"rotationOvertimeModule",[B4],Object.getOwnPropertyDescriptor(q4.prototype,"rotationOvertimeModule"),q4.prototype),T5=de(q4.prototype,"_textureAnimationModule",[G4],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return null}}),de(q4.prototype,"textureAnimationModule",[U4],Object.getOwnPropertyDescriptor(q4.prototype,"textureAnimationModule"),q4.prototype),S5=de(q4.prototype,"_trailModule",[X4],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return null}}),de(q4.prototype,"trailModule",[V4],Object.getOwnPropertyDescriptor(q4.prototype,"trailModule"),q4.prototype),E5=de(q4.prototype,"renderer",[H4],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return new I5}}),w5=de(q4.prototype,"enableCulling",[W4],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return!1}}),C5=de(q4.prototype,"_prewarm",[Ko],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return!1}}),A5=de(q4.prototype,"_capacity",[Ko],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return 100}}),O5=de(q4.prototype,"_simulationSpace",[Ko],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return $J.Local}}),j4=q4))||j4)||j4)||j4)||j4)||j4),j5=function(){function e(){Z(this,e)}return J(e,null,[{key:"instantiate",value:function(e){return this.registeredSceneEvent||(_O.on(iO.EVENT_BEFORE_SCENE_LAUNCH,this.onSceneUnload,this),this.registeredSceneEvent=!0),this.particleSystemPool.has(e._uuid)||this.particleSystemPool.set(e._uuid,new To((function(){return M_(e)||new tg}),1)),this.particleSystemPool.get(e._uuid).alloc()}},{key:"destroy",value:function(e){this.particleSystemPool.has(e._prefab.asset._uuid)&&(this.stop(e),this.particleSystemPool.get(e._prefab.asset._uuid).free(e))}},{key:"play",value:function(e){for(var t,i=_e(e.getComponentsInChildren(W5));!(t=i()).done;){t.value.play()}}},{key:"stop",value:function(e){for(var t,i=_e(e.getComponentsInChildren(W5));!(t=i()).done;){t.value.stop()}}},{key:"onSceneUnload",value:function(){this.particleSystemPool.forEach((function(e){e.clear((function(e){e.destroy()}))})),this.particleSystemPool.clear()}}]),e}();j5.particleSystemPool=new Map,j5.registeredSceneEvent=!1,exports.removeProperty(E2.prototype,"Burst.prototype",[{name:"minCount"},{name:"maxCount"}]),cc.ParticleSystemComponent=W5,cc.BillboardComponent=vQ,cc.LineComponent=UJ,cc.ParticleUtils=j5;var q5=function(){function e(){Z(this,e),this.collisionFilterGroup=1,this.collisionFilterMask=1}return J(e,[{key:"getGroup",value:function(){return this.collisionFilterGroup}},{key:"setGroup",value:function(e){this.collisionFilterGroup=e}},{key:"addGroup",value:function(e){this.collisionFilterGroup|=e}},{key:"removeGroup",value:function(e){this.collisionFilterGroup&=~e}},{key:"getMask",value:function(){return this.collisionFilterMask}},{key:"setMask",value:function(e){this.collisionFilterMask=e}},{key:"addMask",value:function(e){this.collisionFilterMask|=e}},{key:"removeMask",value:function(e){this.collisionFilterMask&=~e}}]),e}(),Y5=new Ki,K5=new Ii,Z5=new Ii,Q5=new Xi,J5=function(e){function t(e,i){var n;return Z(this,t),(n=re(this,te(t).call(this)))._id=void 0,n.index=-1,n.ref=0,n.node=void 0,n.world=void 0,n.shapes=[],n._id=t.idCounter++,n.node=e,n.world=i,n}return ee(t,q5),J(t,[{key:"id",get:function(){return this._id}},{key:"enabled",set:function(e){e?this.index<0&&(this.index=this.world.bodies.length,this.world.addSharedBody(this),this.syncInitial()):this.index>=0&&0==this.shapes.length&&(this.index=-1,this.world.removeSharedBody(this))}},{key:"reference",set:function(e){e?this.ref++:this.ref--,0==this.ref&&this.destroy()}}],[{key:"getSharedBody",value:function(e,i){var n=e.uuid;if(t.sharedBodesMap.has(n))return t.sharedBodesMap.get(n);var r=new t(e,i);return t.sharedBodesMap.set(e.uuid,r),r}}]),J(t,[{key:"intersects",value:function(e){for(var t=0;t<this.shapes.length;t++)for(var i=this.shapes[t],n=0;n<e.shapes.length;n++){var r=e.shapes[n];Ka.resolve(i.worldShape,r.worldShape)&&(this.world.shapeArr.push(i),this.world.shapeArr.push(r))}}},{key:"addShape",value:function(e){this.shapes.indexOf(e)<0&&this.shapes.push(e)}},{key:"removeShape",value:function(e){var t=this.shapes.indexOf(e);t>=0&&this.shapes.splice(t,1)}},{key:"syncSceneToPhysics",value:function(){if(this.node.hasChangedFlags){this.node.getWorldMatrix(Y5),K5.set(this.node.worldPosition),Q5.set(this.node.worldRotation),Z5.set(this.node.worldScale);for(var e=0;e<this.shapes.length;e++)this.shapes[e].transform(Y5,K5,Q5,Z5)}}},{key:"syncInitial",value:function(){this.node.getWorldMatrix(Y5),K5.set(this.node.worldPosition),Q5.set(this.node.worldRotation),Z5.set(this.node.worldScale);for(var e=0;e<this.shapes.length;e++)this.shapes[e].transform(Y5,K5,Q5,Z5)}},{key:"destroy",value:function(){t.sharedBodesMap.delete(this.node.uuid),this.node=null,this.world=null,this.shapes=null}}]),t}();J5.sharedBodesMap=new Map,J5.idCounter=0;var $5,e8,t8,i8,n8,r8,a8=function(){function e(){Z(this,e),this.matrix=[]}return J(e,[{key:"get",value:function(e,t){if(t>e){var i=t;t=e,e=i}return this.matrix[(e*(e+1)>>1)+t-1]}},{key:"set",value:function(e,t,i){if(t>e){var n=t;t=e,e=n}this.matrix[(e*(e+1)>>1)+t-1]=i?1:0}},{key:"reset",value:function(){this.matrix.length=0}},{key:"setNumObjects",value:function(e){this.matrix.length=e*(e-1)>>1}}]),e}(),o8=new Ii,s8={type:"onTriggerEnter",selfCollider:null,otherCollider:null},l8=function(){function e(){Z(this,e),this.shapeArr=[],this.bodies=[],this._shapeArrPrev=[],this._collisionMatrix=new a8,this._collisionMatrixPrev=new a8}return J(e,[{key:"setGravity",value:function(e){}},{key:"setAllowSleep",value:function(e){}},{key:"setDefaultMaterial",value:function(e){}},{key:"step",value:function(e){var t=this._shapeArrPrev;this._shapeArrPrev=this.shapeArr,this.shapeArr=t,this.shapeArr.length=0;for(var i=0;i<this.bodies.length;i++)for(var n=this.bodies[i],r=i+1;r<this.bodies.length;r++){var a=this.bodies[r];0!=(n.collisionFilterGroup&a.collisionFilterMask)&&0!=(a.collisionFilterGroup&n.collisionFilterMask)&&n.intersects(a)}}},{key:"syncSceneToPhysics",value:function(){for(var e=0;e<this.bodies.length;e++)this.bodies[e].syncSceneToPhysics()}},{key:"emitEvents",value:function(){this.emitTriggerEvent()}},{key:"raycastClosest",value:function(e,t,i){for(var n=1/0,r=t.maxDistance,a=t.mask,o=0;o<this.bodies.length;o++){var s=this.bodies[o];if(s.collisionFilterGroup&a)for(var l=0;l<s.shapes.length;l++){var u=s.shapes[l],c=Ka.resolve(e,u.worldShape);0==c||c>r||n>c&&(n=c,Ii.normalize(o8,e.d),Ii.scaleAndAdd(o8,e.o,o8,c),i._assign(o8,c,u.collider,Ii.ZERO))}}return!(n==1/0)}},{key:"raycast",value:function(e,t,i,n){for(var r=t.maxDistance,a=t.mask,o=0;o<this.bodies.length;o++){var s=this.bodies[o];if(s.collisionFilterGroup&a)for(var l=0;l<s.shapes.length;l++){var u=s.shapes[l],c=Ka.resolve(e,u.worldShape);if(!(0==c||c>r)){var h=i.add();e.computeHit(o8,c),h._assign(o8,c,u.collider,Ii.ZERO),n.push(h)}}}return n.length>0}},{key:"getSharedBody",value:function(e){return J5.getSharedBody(e,this)}},{key:"addSharedBody",value:function(e){this.bodies.indexOf(e)<0&&this.bodies.push(e)}},{key:"removeSharedBody",value:function(e){var t=this.bodies.indexOf(e);t>=0&&this.bodies.splice(t,1)}},{key:"emitTriggerEvent",value:function(){for(var e,t,i=0;i<this.shapeArr.length;i+=2)e=this.shapeArr[i],t=this.shapeArr[i+1],s8.selfCollider=e.collider,s8.otherCollider=t.collider,this._collisionMatrix.set(e.id,t.id,!0),this._collisionMatrixPrev.get(e.id,t.id)?s8.type="onTriggerStay":s8.type="onTriggerEnter",e.collider&&e.collider.emit(s8.type,s8),s8.selfCollider=t.collider,s8.otherCollider=e.collider,t.collider&&t.collider.emit(s8.type,s8);for(var n=0;n<this._shapeArrPrev.length;n+=2)e=this._shapeArrPrev[n],t=this._shapeArrPrev[n+1],this._collisionMatrixPrev.get(e.id,t.id)&&(this._collisionMatrix.get(e.id,t.id)||(s8.type="onTriggerExit",s8.selfCollider=e.collider,s8.otherCollider=t.collider,e.collider&&e.collider.emit(s8.type,s8),s8.selfCollider=t.collider,s8.otherCollider=e.collider,t.collider&&t.collider.emit(s8.type,s8),this._collisionMatrix.set(e.id,t.id,!1)));var r=this._collisionMatrixPrev.matrix;this._collisionMatrixPrev.matrix=this._collisionMatrix.matrix,this._collisionMatrix.matrix=r,this._collisionMatrix.reset()}},{key:"impl",get:function(){return this}}]),e}();var u8,c8,h8,p8,_8,f8,d8,m8,v8,y8,g8=Yo("cc.PhysicMaterial")((r8=n8=function(e){function t(){var e;return Z(this,t),fe(e=re(this,te(t).call(this)),"_friction",t8,ne(e)),fe(e,"_restitution",i8,ne(e)),t.allMaterials.push(ne(e)),""==e._uuid&&(e._uuid="pm_"+t._idCounter++),e}return ee(t,zl),J(t,[{key:"friction",get:function(){return this._friction},set:function(e){ci(this._friction,e)||(this._friction=e,this.emit("physics_material_update"))}},{key:"restitution",get:function(){return this._restitution},set:function(e){ci(this._restitution,e)||(this._restitution=e,this.emit("physics_material_update"))}}]),J(t,[{key:"clone",value:function(){var e=new t;return e._friction=this._friction,e._restitution=this._restitution,e}},{key:"destroy",value:function(){if(oe(te(t.prototype),"destroy",this).call(this)){var e=t.allMaterials.indexOf(this);return e>=0&&t.allMaterials.splice(e,1),!0}return!1}}]),t}(),n8.allMaterials=[],n8._idCounter=0,de((e8=r8).prototype,"friction",[Ko],Object.getOwnPropertyDescriptor(e8.prototype,"friction"),e8.prototype),de(e8.prototype,"restitution",[Ko],Object.getOwnPropertyDescriptor(e8.prototype,"restitution"),e8.prototype),t8=de(e8.prototype,"_friction",[Ko],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return.1}}),i8=de(e8.prototype,"_restitution",[Ko],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return.1}}),$5=e8))||$5,x8=function(){function e(){Z(this,e),this._hitPoint=new Ii,this._hitNormal=new Ii,this._distance=0,this._collider=null}return J(e,[{key:"_assign",value:function(e,t,i,n){Ii.copy(this._hitPoint,e),Ii.copy(this._hitNormal,n),this._distance=t,this._collider=i}},{key:"clone",value:function(){var t=new e;return Ii.copy(t._hitPoint,this._hitPoint),Ii.copy(t._hitNormal,this._hitNormal),t._distance=this._distance,t._collider=this._collider,t}},{key:"hitPoint",get:function(){return this._hitPoint}},{key:"distance",get:function(){return this._distance}},{key:"collider",get:function(){return this._collider}},{key:"hitNormal",get:function(){return this._hitNormal}}]),e}(),b8=function(e){function t(){var e;return Z(this,t),(e=re(this,te(t).call(this))).physicsWorld=void 0,e.raycastClosestResult=new x8,e.raycastResults=[],e._enable=!0,e._allowSleep=!0,e._gravity=new Ii(0,-10,0),e._maxSubStep=1,e._deltaTime=1/60,e._useFixedTime=!0,e._timeSinceLastUpdate=0,e._timeReset=!0,e.raycastOptions={group:-1,mask:-1,queryTrigger:!0,maxDistance:1e7},e.raycastResultPool=new So((function(){return new x8}),1),e.physicsWorld=new k5,e.gravity=e._gravity,e.allowSleep=e._allowSleep,e._material=new g8,e._material.friction=.5,e._material.restitution=.1,e._material.on("physics_material_update",e._updateMaterial,ne(e)),e.physicsWorld.setDefaultMaterial(e._material),e}return ee(t,NA),J(t,[{key:"enable",get:function(){return this._enable},set:function(e){e||(this._timeReset=!0),this._enable=e}},{key:"allowSleep",get:function(){return this._allowSleep},set:function(e){this._allowSleep=e}},{key:"maxSubStep",get:function(){return this._maxSubStep},set:function(e){this._maxSubStep=e}},{key:"deltaTime",get:function(){return this._deltaTime},set:function(e){this._deltaTime=e}},{key:"useFixedTime",get:function(){return this._useFixedTime},set:function(e){this._useFixedTime=e}},{key:"gravity",get:function(){return this._gravity},set:function(e){this._gravity.set(e)}},{key:"defaultMaterial",get:function(){return this._material}}],[{key:"instance",get:function(){return t._instance}}]),J(t,[{key:"postUpdate",value:function(e){this._enable?(this._timeReset?(this._timeSinceLastUpdate=0,this._timeReset=!1):this._timeSinceLastUpdate=e,this.physicsWorld.emitEvents(),_O.emit(iO.EVENT_BEFORE_PHYSICS),this.physicsWorld.syncSceneToPhysics(),this._useFixedTime?this.physicsWorld.step(this._deltaTime):this.physicsWorld.step(this._deltaTime,this._timeSinceLastUpdate,this._maxSubStep),this.physicsWorld.syncSceneToPhysics(),_O.emit(iO.EVENT_AFTER_PHYSICS)):this.physicsWorld.syncSceneToPhysics()}},{key:"raycast",value:function(e){var t=arguments.length>1&&void 0!==arguments[1]?arguments[1]:4294967295,i=arguments.length>2&&void 0!==arguments[2]?arguments[2]:1e7,n=!(arguments.length>3&&void 0!==arguments[3])||arguments[3];return this.raycastResultPool.reset(),this.raycastResults.length=0,this.raycastOptions.mask=t,this.raycastOptions.maxDistance=i,this.raycastOptions.queryTrigger=n,this.physicsWorld.raycast(e,this.raycastOptions,this.raycastResultPool,this.raycastResults)}},{key:"raycastClosest",value:function(e){var t=arguments.length>1&&void 0!==arguments[1]?arguments[1]:4294967295,i=arguments.length>2&&void 0!==arguments[2]?arguments[2]:1e7,n=!(arguments.length>3&&void 0!==arguments[3])||arguments[3];return this.raycastOptions.mask=t,this.raycastOptions.maxDistance=i,this.raycastOptions.queryTrigger=n,this.physicsWorld.raycastClosest(e,this.raycastOptions,this.raycastClosestResult)}},{key:"_updateMaterial",value:function(){}}]),t}();b8.ID="PHYSICS",b8._instance=void 0,_O.on(iO.EVENT_INIT,(function(){var e=new cc.PhysicsSystem;cc.PhysicsSystem._instance=e,_O.registerSystem(b8.ID,e,0)}));var T8,S8,E8,w8,C8,A8,O8,k8,R8,F8,M8,I8,P8,L8,D8,N8,z8,B8,G8,U8,X8,V8,H8,W8,j8,q8,Y8,K8,Z8,Q8,J8=(u8=Yo("cc.ColliderComponent"),c8=Ko({type:g8,displayName:"Material",displayOrder:-1,tooltip:"源材质"}),h8=Ko({displayOrder:0,tooltip:"是否与其它碰撞器产生碰撞，并产生物理行为"}),p8=Ko({type:Ii,displayOrder:1,tooltip:"形状的中心点（与所在 Node 中心点的相对位置）"}),_8=Ko({type:g8}),u8((de((d8=function(e){function t(){var e;return Z(this,t),(e=re(this,te(t).call(this)))._isSharedMaterial=!0,fe(e,"_material",m8,ne(e)),fe(e,"_isTrigger",v8,ne(e)),fe(e,"_center",y8,ne(e)),e}return ee(t,vl(rp)),J(t,[{key:"sharedMaterial",get:function(){return this._material},set:function(e){this.material=e}},{key:"material",get:function(){return this._material},set:function(e){this._material=e}},{key:"isTrigger",get:function(){return this._isTrigger},set:function(e){this._isTrigger=e,this._shape.setAsTrigger(this._isTrigger)}},{key:"center",get:function(){return this._center},set:function(e){Ii.copy(this._center,e),this._shape.setCenter(this._center)}},{key:"attachedRigidBody",get:function(){return this.shape.attachedRigidBody}},{key:"shape",get:function(){return this._shape}},{key:"_assertOnload",get:function(){var e=0==this._isOnLoadCalled;return e&&h("Physics Error: Please make sure that the node has been added to the scene"),!e}}]),J(t,[{key:"on",value:function(e,i,n,r){oe(te(t.prototype),"on",this).call(this,e,i,n,r)}},{key:"off",value:function(e,i,n){oe(te(t.prototype),"off",this).call(this,e,i,n)}},{key:"once",value:function(e,i,n){oe(te(t.prototype),"once",this).call(this,e,i,n)}},{key:"setGroup",value:function(e){this._shape.setGroup(e)}},{key:"getGroup",value:function(){return this._shape.getGroup()}},{key:"addGroup",value:function(e){this._shape.addGroup(e)}},{key:"removeGroup",value:function(e){this._shape.removeGroup(e)}},{key:"getMask",value:function(){return this._shape.getMask()}},{key:"setMask",value:function(e){this._shape.setMask(e)}},{key:"addMask",value:function(e){this._shape.addMask(e)}},{key:"removeMask",value:function(e){this._shape.removeMask(e)}},{key:"__preload",value:function(){this._shape.initialize(this)}},{key:"onLoad",value:function(){this._shape.onLoad()}},{key:"onEnable",value:function(){this._shape.onEnable()}},{key:"onDisable",value:function(){this._shape.onDisable()}},{key:"onDestroy",value:function(){this._material&&this._material.off("physics_material_update",this._updateMaterial,this),this._shape.onDestroy()}},{key:"_updateMaterial",value:function(){this._shape.setMaterial(this._material)}}]),t}()).prototype,"sharedMaterial",[c8],Object.getOwnPropertyDescriptor(d8.prototype,"sharedMaterial"),d8.prototype),de(d8.prototype,"isTrigger",[h8],Object.getOwnPropertyDescriptor(d8.prototype,"isTrigger"),d8.prototype),de(d8.prototype,"center",[p8],Object.getOwnPropertyDescriptor(d8.prototype,"center"),d8.prototype),m8=de(d8.prototype,"_material",[_8],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return null}}),v8=de(d8.prototype,"_isTrigger",[Ko],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return!1}}),y8=de(d8.prototype,"_center",[Ko],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return new Ii}}),f8=d8))||f8),$8=(T8=Yo("cc.BoxColliderComponent"),S8=os("i18n:cc.BoxColliderComponent"),E8=ts(98),w8=es("Physics/BoxCollider"),C8=Ko({type:Ii,tooltip:"盒的大小，即长、宽、高"}),T8(A8=S8(A8=E8(A8=w8(A8=Jo((de((O8=function(e){function t(){var e;return Z(this,t),fe(e=re(this,te(t).call(this)),"_size",k8,ne(e)),e._shape=function(e){return new R5(e)}(e._size),e}return ee(t,J8),J(t,[{key:"size",get:function(){return this._size},set:function(e){Ii.copy(this._size,e),this.shape.setSize(this._size)}},{key:"shape",get:function(){return this._shape}}]),t}()).prototype,"size",[C8],Object.getOwnPropertyDescriptor(O8.prototype,"size"),O8.prototype),k8=de(O8.prototype,"_size",[Ko],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return new Ii(1,1,1)}}),A8=O8))||A8)||A8)||A8)||A8)||A8),e6=(R8=Yo("cc.SphereColliderComponent"),F8=os("i18n:cc.SphereColliderComponent"),M8=ts(98),I8=es("Physics/SphereCollider"),P8=Ko({tooltip:"球的半径"}),R8(L8=F8(L8=M8(L8=I8(L8=Jo((de((D8=function(e){function t(){var e,i;return Z(this,t),fe(e=re(this,te(t).call(this)),"_radius",N8,ne(e)),e._shape=(i=e._radius,new F5(i)),e}return ee(t,J8),J(t,[{key:"radius",get:function(){return this._radius},set:function(e){this._radius=e,this.shape.setRadius(this._radius)}},{key:"shape",get:function(){return this._shape}}]),t}()).prototype,"radius",[P8],Object.getOwnPropertyDescriptor(D8.prototype,"radius"),D8.prototype),N8=de(D8.prototype,"_radius",[Ko],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return 1}}),L8=D8))||L8)||L8)||L8)||L8)||L8);(z8=exports.ERigidBodyType||(exports.ERigidBodyType={}))[z8.DYNAMIC=1]="DYNAMIC",z8[z8.STATIC=2]="STATIC",z8[z8.KINEMATIC=4]="KINEMATIC",(B8=exports.EAxisDirection||(exports.EAxisDirection={}))[B8.X_AXIS=0]="X_AXIS",B8[B8.Y_AXIS=1]="Y_AXIS",B8[B8.Z_AXIS=2]="Z_AXIS",xt(exports.EAxisDirection);var t6,i6,n6,r6,a6,o6,s6,l6,u6,c6,h6,p6,_6,f6,d6,m6,v6,y6,g6,x6,b6,T6,S6,E6,w6,C6,A6,O6,k6,R6,F6,M6,I6,P6,L6,D6,N6,z6,B6,G6,U6,X6,V6,H6,W6,j6,q6,Y6,K6,Z6,Q6,J6,$6,e7,t7,i7,n7,r7=(G8=Yo("cc.CapsuleColliderComponent"),U8=os("i18n:cc.CapsuleColliderComponent"),X8=ts(98),V8=es("Physics/CapsuleCollider"),H8=Ko({tooltip:"本地坐标系下胶囊体上的球的半径"}),W8=Ko({tooltip:"本地坐标系下胶囊体上的圆柱体的高度"}),j8=Ko({type:exports.EAxisDirection,tooltip:"本地坐标系下胶囊体的朝向"}),G8(q8=U8(q8=X8(q8=V8(q8=Jo((de((Y8=function(e){function t(){var e;return Z(this,t),fe(e=re(this,te(t).call(this)),"_radius",K8,ne(e)),fe(e,"_cylinderHeight",Z8,ne(e)),fe(e,"_direction",Q8,ne(e)),e._shape=function(){var e=arguments.length>0&&void 0!==arguments[0]?arguments[0]:.5,t=arguments.length>1&&void 0!==arguments[1]?arguments[1]:2,i=arguments.length>2&&void 0!==arguments[2]?arguments[2]:1;return new M5(e,t,i)}(),e}return ee(t,J8),J(t,[{key:"radius",get:function(){return this._radius},set:function(e){e<0&&(e=0),this._radius=e,this.shape.setRadius(e)}},{key:"cylinderHeight",get:function(){return this._cylinderHeight},set:function(e){e<0&&(e=0),this._cylinderHeight=e,this.shape.setCylinderHeight(e)}},{key:"direction",get:function(){return this._direction},set:function(e){(e=Math.floor(e))<exports.EAxisDirection.X_AXIS||e>exports.EAxisDirection.Z_AXIS||(this._direction=e,this.shape.setDirection(e))}},{key:"height",get:function(){return 2*this._radius+this._cylinderHeight},set:function(e){var t=e-2*this._radius;t<0&&(t=0),this.cylinderHeight=t}},{key:"worldHeight",get:function(){return 2*this._radius*this._getRadiusScale()+this._cylinderHeight*this._getHeightScale()}},{key:"shape",get:function(){return this._shape}}]),J(t,[{key:"_getRadiusScale",value:function(){if(null==this.node)return 1;var e=this.node.worldScale;return this._direction==exports.EAxisDirection.Y_AXIS?Math.abs(Oi(e.x,e.z)):this._direction==exports.EAxisDirection.X_AXIS?Math.abs(Oi(e.y,e.z)):Math.abs(Oi(e.x,e.y))}},{key:"_getHeightScale",value:function(){if(null==this.node)return 1;var e=this.node.worldScale;return this._direction==exports.EAxisDirection.Y_AXIS?Math.abs(e.y):this._direction==exports.EAxisDirection.X_AXIS?Math.abs(e.x):Math.abs(e.z)}}]),t}()).prototype,"radius",[H8],Object.getOwnPropertyDescriptor(Y8.prototype,"radius"),Y8.prototype),de(Y8.prototype,"cylinderHeight",[W8],Object.getOwnPropertyDescriptor(Y8.prototype,"cylinderHeight"),Y8.prototype),de(Y8.prototype,"direction",[j8],Object.getOwnPropertyDescriptor(Y8.prototype,"direction"),Y8.prototype),K8=de(Y8.prototype,"_radius",[Ko],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return.5}}),Z8=de(Y8.prototype,"_cylinderHeight",[Ko],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return 1}}),Q8=de(Y8.prototype,"_direction",[Ko],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return exports.EAxisDirection.Y_AXIS}}),q8=Y8))||q8)||q8)||q8)||q8)||q8),a7=(t6=Yo("cc.CylinderColliderComponent"),i6=os("i18n:cc.CylinderColliderComponent"),n6=ts(98),r6=es("Physics/CylinderCollider(beta)"),a6=Ko({tooltip:"圆柱体上圆面的半径"}),o6=Ko({tooltip:"圆柱体在相应轴向的高度"}),s6=Ko({type:exports.EAxisDirection}),t6(l6=i6(l6=n6(l6=r6(l6=Jo((de((u6=function(e){function t(){var e;return Z(this,t),fe(e=re(this,te(t).call(this)),"_radius",c6,ne(e)),fe(e,"_height",h6,ne(e)),fe(e,"_direction",p6,ne(e)),e._shape=function(){g(9612);var e=function(){};return{setRadius:e,setHeight:e,setDirection:e,setMaterial:e,setIsTrigger:e,setCenter:e,initialize:e,onLoad:e,onEnable:e,onDisable:e,onDestroy:e}}(),e}return ee(t,J8),J(t,[{key:"radius",get:function(){return this._radius},set:function(e){this._radius!=e&&(e<0&&(e=0),this._radius=e,this.shape.setRadius(e))}},{key:"height",get:function(){return this._height},set:function(e){this._height!=e&&(e<0&&(e=0),this._height=e,this.shape.setHeight(e))}},{key:"direction",get:function(){return this._direction},set:function(e){this._direction!=e&&(e<exports.EAxisDirection.X_AXIS||e>exports.EAxisDirection.Z_AXIS||(this._direction=e,this.shape.setDirection(e)))}},{key:"shape",get:function(){return this._shape}}]),t}()).prototype,"radius",[a6],Object.getOwnPropertyDescriptor(u6.prototype,"radius"),u6.prototype),de(u6.prototype,"height",[o6],Object.getOwnPropertyDescriptor(u6.prototype,"height"),u6.prototype),de(u6.prototype,"direction",[s6],Object.getOwnPropertyDescriptor(u6.prototype,"direction"),u6.prototype),c6=de(u6.prototype,"_radius",[Ko],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return.5}}),h6=de(u6.prototype,"_height",[Ko],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return 2}}),p6=de(u6.prototype,"_direction",[Ko],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return exports.EAxisDirection.Y_AXIS}}),l6=u6))||l6)||l6)||l6)||l6)||l6),o7=(_6=Yo("cc.MeshColliderComponent"),f6=os("i18n:cc.MeshColliderComponent"),d6=ts(98),m6=es("Physics/MeshCollider"),v6=Ko({type:rc}),_6(y6=f6(y6=d6(y6=m6(y6=Jo((de((g6=function(e){function t(){var e;return Z(this,t),fe(e=re(this,te(t).call(this)),"_mesh",x6,ne(e)),e._shape=function(){g(9611);var e=function(){};return{setMesh:e,setMaterial:e,setIsTrigger:e,setCenter:e,initialize:e,onLoad:e,onEnable:e,onDisable:e,onDestroy:e}}(),e}return ee(t,J8),J(t,[{key:"mesh",get:function(){return this._mesh},set:function(e){this._mesh=e,this.shape.setMesh(this._mesh)}},{key:"shape",get:function(){return this._shape}}]),t}()).prototype,"mesh",[v6],Object.getOwnPropertyDescriptor(g6.prototype,"mesh"),g6.prototype),x6=de(g6.prototype,"_mesh",[Ko],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return null}}),y6=g6))||y6)||y6)||y6)||y6)||y6),s7=(b6=Yo("cc.RigidBodyComponent"),T6=os("i18n:cc.RigidBodyComponent"),S6=ts(99),E6=es("Physics/RigidBody"),w6=Ko({displayOrder:0,tooltip:"刚体的质量"}),C6=Ko({displayOrder:1,tooltip:"线性阻尼"}),A6=Ko({displayOrder:2,tooltip:"旋转阻尼"}),O6=Ko({displayOrder:3,tooltip:"刚体是否由物理系统控制运动"}),k6=Ko({displayOrder:4,tooltip:"刚体是否使用重力"}),R6=Ko({displayOrder:5,tooltip:"刚体是否固定旋转"}),F6=Ko({displayOrder:6,tooltip:"线性速度的因子，可以用来控制每个轴方向上的速度的缩放"}),M6=Ko({displayOrder:7,tooltip:"旋转速度的因子，可以用来控制每个轴方向上的旋转速度的缩放"}),b6(I6=T6(I6=S6(I6=E6(I6=Jo(I6=is((de((P6=function(e){function t(){var e;return Z(this,t),(e=re(this,te(t).call(this)))._allowSleep=!0,fe(e,"_mass",L6,ne(e)),fe(e,"_linearDamping",D6,ne(e)),fe(e,"_angularDamping",N6,ne(e)),fe(e,"_fixedRotation",z6,ne(e)),fe(e,"_isKinematic",B6,ne(e)),fe(e,"_useGravity",G6,ne(e)),fe(e,"_linearFactor",U6,ne(e)),fe(e,"_angularFactor",X6,ne(e)),e}return ee(t,rp),J(t,[{key:"allowSleep",get:function(){return this._allowSleep},set:function(e){this._allowSleep=e}},{key:"mass",get:function(){return this._mass},set:function(e){this._mass=e}},{key:"linearDamping",get:function(){return this._linearDamping},set:function(e){this._linearDamping=e}},{key:"angularDamping",get:function(){return this._angularDamping},set:function(e){this._angularDamping=e}},{key:"isKinematic",get:function(){return this._isKinematic},set:function(e){this._isKinematic=e}},{key:"useGravity",get:function(){return this._useGravity},set:function(e){this._useGravity=e}},{key:"fixedRotation",get:function(){return this._fixedRotation},set:function(e){this._fixedRotation=e}},{key:"linearFactor",get:function(){return this._linearFactor},set:function(e){Ii.copy(this._linearFactor,e)}},{key:"angularFactor",get:function(){return this._angularFactor},set:function(e){Ii.copy(this._angularFactor,e)}},{key:"isAwake",get:function(){return!1}},{key:"isSleepy",get:function(){return!1}},{key:"isSleeping",get:function(){return!1}},{key:"body",get:function(){return this._body}},{key:"_assertOnload",get:function(){var e=0==this._isOnLoadCalled;return e&&h("[Physics]: Please make sure that the node has been added to the scene"),!e}}]),J(t,[{key:"__preload",value:function(){}},{key:"onEnable",value:function(){}},{key:"onDisable",value:function(){}},{key:"onDestroy",value:function(){}},{key:"applyForce",value:function(e,t){}},{key:"applyLocalForce",value:function(e,t){}},{key:"applyImpulse",value:function(e,t){}},{key:"applyLocalImpulse",value:function(e,t){}},{key:"applyTorque",value:function(e){}},{key:"applyLocalTorque",value:function(e){}},{key:"wakeUp",value:function(){}},{key:"sleep",value:function(){}},{key:"getLinearVelocity",value:function(e){}},{key:"setLinearVelocity",value:function(e){}},{key:"getAngularVelocity",value:function(e){}},{key:"setAngularVelocity",value:function(e){}},{key:"setGroup",value:function(e){}},{key:"getGroup",value:function(){return 0}},{key:"addGroup",value:function(e){}},{key:"removeGroup",value:function(e){}},{key:"getMask",value:function(){return 0}},{key:"setMask",value:function(e){}},{key:"addMask",value:function(e){}},{key:"removeMask",value:function(e){}}]),t}()).prototype,"mass",[w6],Object.getOwnPropertyDescriptor(P6.prototype,"mass"),P6.prototype),de(P6.prototype,"linearDamping",[C6],Object.getOwnPropertyDescriptor(P6.prototype,"linearDamping"),P6.prototype),de(P6.prototype,"angularDamping",[A6],Object.getOwnPropertyDescriptor(P6.prototype,"angularDamping"),P6.prototype),de(P6.prototype,"isKinematic",[O6],Object.getOwnPropertyDescriptor(P6.prototype,"isKinematic"),P6.prototype),de(P6.prototype,"useGravity",[k6],Object.getOwnPropertyDescriptor(P6.prototype,"useGravity"),P6.prototype),de(P6.prototype,"fixedRotation",[R6],Object.getOwnPropertyDescriptor(P6.prototype,"fixedRotation"),P6.prototype),de(P6.prototype,"linearFactor",[F6],Object.getOwnPropertyDescriptor(P6.prototype,"linearFactor"),P6.prototype),de(P6.prototype,"angularFactor",[M6],Object.getOwnPropertyDescriptor(P6.prototype,"angularFactor"),P6.prototype),L6=de(P6.prototype,"_mass",[Ko],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return 1}}),D6=de(P6.prototype,"_linearDamping",[Ko],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return.1}}),N6=de(P6.prototype,"_angularDamping",[Ko],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return.1}}),z6=de(P6.prototype,"_fixedRotation",[Ko],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return!1}}),B6=de(P6.prototype,"_isKinematic",[Ko],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return!1}}),G6=de(P6.prototype,"_useGravity",[Ko],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return!0}}),U6=de(P6.prototype,"_linearFactor",[Ko],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return new Ii(1,1,1)}}),X6=de(P6.prototype,"_angularFactor",[Ko],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return new Ii(1,1,1)}}),I6=P6))||I6)||I6)||I6)||I6)||I6)||I6),l7=(V6=Yo("cc.ConstantForce"),H6=os("i18n:cc.ConstantForce"),W6=ts(98),j6=$o(s7),q6=es("Physics/ConstantForce"),Y6=Ko({displayOrder:0,tooltip:"世界坐标系下的力"}),K6=Ko({displayOrder:1,tooltip:"本地坐标系下的力"}),Z6=Ko({displayOrder:2,tooltip:"世界坐标系下的扭转力"}),Q6=Ko({displayOrder:3,tooltip:"本地坐标系下的扭转力"}),V6(J6=H6(J6=W6(J6=j6(J6=q6(J6=is(J6=Jo((e7=de(($6=function(e){function t(){var e,i;Z(this,t);for(var n=arguments.length,r=new Array(n),a=0;a<n;a++)r[a]=arguments[a];return(i=re(this,(e=te(t)).call.apply(e,[this].concat(r))))._rigidBody=null,fe(i,"_force",e7,ne(i)),fe(i,"_localForce",t7,ne(i)),fe(i,"_torque",i7,ne(i)),fe(i,"_localTorque",n7,ne(i)),i._mask=0,i}return ee(t,rp),J(t,[{key:"onLoad",value:function(){}},{key:"lateUpdate",value:function(e){}},{key:"_maskUpdate",value:function(e,t){e.strictEquals(Ii.ZERO)?this._mask&=~t:this._mask|=t}},{key:"force",get:function(){return this._force},set:function(e){Ii.copy(this._force,e),this._maskUpdate(this._force,1)}},{key:"localForce",get:function(){return this._localForce},set:function(e){Ii.copy(this._localForce,e),this._maskUpdate(this.localForce,2)}},{key:"torque",get:function(){return this._torque},set:function(e){Ii.copy(this._torque,e),this._maskUpdate(this._torque,4)}},{key:"localTorque",get:function(){return this._localTorque},set:function(e){Ii.copy(this._localTorque,e),this._maskUpdate(this._localTorque,8)}}]),t}()).prototype,"_force",[Ko],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return new Ii}}),t7=de($6.prototype,"_localForce",[Ko],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return new Ii}}),i7=de($6.prototype,"_torque",[Ko],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return new Ii}}),n7=de($6.prototype,"_localTorque",[Ko],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return new Ii}}),de($6.prototype,"force",[Y6],Object.getOwnPropertyDescriptor($6.prototype,"force"),$6.prototype),de($6.prototype,"localForce",[K6],Object.getOwnPropertyDescriptor($6.prototype,"localForce"),$6.prototype),de($6.prototype,"torque",[Z6],Object.getOwnPropertyDescriptor($6.prototype,"torque"),$6.prototype),de($6.prototype,"localTorque",[Q6],Object.getOwnPropertyDescriptor($6.prototype,"localTorque"),$6.prototype),J6=$6))||J6)||J6)||J6)||J6)||J6)||J6)||J6);exports.replaceProperty(b8,"PhysicsSystem",[{name:"ins",newName:"instance"}]),exports.replaceProperty(J8.prototype,"ColliderComponent.prototype",[{name:"attachedRigidbody",newName:"attachedRigidBody"}]),exports.replaceProperty($8.prototype,"BoxColliderComponent.prototype",[{name:"boxShape",newName:"shape"}]),exports.replaceProperty(e6.prototype,"SphereColliderComponent.prototype",[{name:"sphereShape",newName:"shape"}]),exports.replaceProperty(r7.prototype,"CapsuleColliderComponent.prototype",[{name:"capsuleShape",newName:"shape"}]),exports.replaceProperty(s7.prototype,"RigidBodyComponent.prototype",[{name:"rigidBody",newName:"body"}]),cc.PhysicsSystem=b8,cc.ColliderComponent=J8,cc.BoxColliderComponent=$8,cc.SphereColliderComponent=e6,cc.RigidBodyComponent=s7,cc.PhysicMaterial=g8,cc.PhysicsRayResult=x8,cc.ConstantForce=l7;var u7=function(){function e(){Z(this,e),this.id=e.idCounter++}return J(e,[{key:"setMaterial",value:function(e){}},{key:"setAsTrigger",value:function(e){}},{key:"setCenter",value:function(e){Ii.copy(this._localShape.center,e)}},{key:"initialize",value:function(e){this._collider=e,this._sharedBody=b8.instance.physicsWorld.getSharedBody(this._collider.node),this._sharedBody.reference=!0}},{key:"onLoad",value:function(){this.setCenter(this._collider.center)}},{key:"onEnable",value:function(){this._sharedBody.addShape(this),this._sharedBody.enabled=!0}},{key:"onDisable",value:function(){this._sharedBody.removeShape(this),this._sharedBody.enabled=!1}},{key:"onDestroy",value:function(){this._sharedBody.reference=!1,this._collider=null,this._localShape=null,this._worldShape=null}},{key:"transform",value:function(e,t,i,n){this._localShape.transform(e,t,i,n,this._worldShape)}},{key:"getGroup",value:function(){return this._sharedBody.getGroup()}},{key:"setGroup",value:function(e){this._sharedBody.setGroup(e)}},{key:"addGroup",value:function(e){this._sharedBody.addGroup(e)}},{key:"removeGroup",value:function(e){this._sharedBody.removeGroup(e)}},{key:"getMask",value:function(){return this._sharedBody.getMask()}},{key:"setMask",value:function(e){this._sharedBody.setMask(e)}},{key:"addMask",value:function(e){this._sharedBody.addMask(e)}},{key:"removeMask",value:function(e){this._sharedBody.removeMask(e)}},{key:"attachedRigidBody",get:function(){return null}},{key:"localShape",get:function(){return this._localShape}},{key:"worldShape",get:function(){return this._worldShape}},{key:"impl",get:function(){return this._worldShape}},{key:"sharedBody",get:function(){return this._sharedBody}},{key:"collider",get:function(){return this._collider}}]),e}();u7.idCounter=0;var c7=function(e){function t(e){var i;return Z(this,t),(i=re(this,te(t).call(this)))._localShape=new po,i._worldShape=new po,Ii.multiplyScalar(i.localObb.halfExtents,e,.5),Ii.copy(i.worldObb.halfExtents,i.localObb.halfExtents),i}return ee(t,u7),J(t,[{key:"localObb",get:function(){return this._localShape}},{key:"worldObb",get:function(){return this._worldShape}},{key:"collider",get:function(){return this._collider}}]),J(t,[{key:"setSize",value:function(e){Ii.multiplyScalar(this.localObb.halfExtents,e,.5),Ii.multiply(this.worldObb.halfExtents,this.localObb.halfExtents,this.collider.node.worldScale)}},{key:"onLoad",value:function(){oe(te(t.prototype),"onLoad",this).call(this),this.setSize(this.collider.size)}}]),t}();var h7,p7,_7,f7,d7,m7,v7,y7,g7,x7,b7,T7,S7,E7,w7,C7=function(e){function t(e){var i;return Z(this,t),(i=re(this,te(t).call(this)))._localShape=new Fn(0,0,0,e),i._worldShape=new Fn(0,0,0,e),i}return ee(t,u7),J(t,[{key:"setRadius",value:function(e){this.localSphere.radius=e;var t,i=(t=this.collider.node.worldScale,Math.max(t.x,Math.max(t.y,t.z)));this.worldSphere.radius=this.localSphere.radius*i}},{key:"localSphere",get:function(){return this._localShape}},{key:"worldSphere",get:function(){return this._worldShape}},{key:"collider",get:function(){return this._collider}}]),J(t,[{key:"onLoad",value:function(){oe(te(t.prototype),"onLoad",this).call(this),this.setRadius(this.collider.radius)}}]),t}(),A7=function(e){function t(){var e,i=arguments.length>0&&void 0!==arguments[0]?arguments[0]:.5,n=arguments.length>1&&void 0!==arguments[1]?arguments[1]:2,r=arguments.length>2&&void 0!==arguments[2]?arguments[2]:exports.EAxisDirection.Y_AXIS;Z(this,t);var a=(n-2*i)/2,o=a<0?0:a;return(e=re(this,te(t).call(this)))._localShape=new _o(i,o,r),e._worldShape=new _o(i,o,r),e}return ee(t,u7),J(t,[{key:"localCapsule",get:function(){return this._localShape}},{key:"worldCapsule",get:function(){return this._worldShape}},{key:"collider",get:function(){return this._collider}}]),J(t,[{key:"setRadius",value:function(e){this.localCapsule.radius=e,this.transform(this._sharedBody.node.worldMatrix,this._sharedBody.node.worldPosition,this._sharedBody.node.worldRotation,this._sharedBody.node.worldScale)}},{key:"setCylinderHeight",value:function(e){this.localCapsule.halfHeight=e/2,this.localCapsule.updateCache(),this.transform(this._sharedBody.node.worldMatrix,this._sharedBody.node.worldPosition,this._sharedBody.node.worldRotation,this._sharedBody.node.worldScale)}},{key:"setDirection",value:function(e){this.localCapsule.axis=e,this.localCapsule.updateCache(),this.worldCapsule.axis=e,this.worldCapsule.updateCache(),this.transform(this._sharedBody.node.worldMatrix,this._sharedBody.node.worldPosition,this._sharedBody.node.worldRotation,this._sharedBody.node.worldScale)}},{key:"onLoad",value:function(){oe(te(t.prototype),"onLoad",this).call(this),this.setRadius(this.collider.radius),this.setDirection(this.collider.direction)}}]),t}();exports.removeProperty(A7.prototype,"shape.prototype",[{name:"setHeight",suggest:"You should use the interface provided by the component."}]),R5=(h7={box:c7,sphere:C7,world:l8,capsule:A7}).box,F5=h7.sphere,h7.body,k5=h7.world,h7.capsule&&(M5=h7.capsule),h7.trimesh&&h7.trimesh,h7.cylinder&&h7.cylinder;var O7=(p7=Yo("cc.AudioSourceComponent"),_7=os("i18n:cc.AudioSourceComponent"),f7=es("Components/AudioSource"),d7=Ko(exports.AudioClip),m7=Ko({type:exports.AudioClip,tooltip:"i18n:audio.clip"}),v7=Ko({tooltip:"i18n:audio.loop"}),y7=Ko({tooltip:"i18n:audio.playOnAwake"}),g7=Ko({range:[0,1],tooltip:"i18n:audio.volume"}),p7(x7=_7(x7=f7((T7=de((b7=function(e){function t(){var e,i;Z(this,t);for(var n=arguments.length,r=new Array(n),a=0;a<n;a++)r[a]=arguments[a];return fe(i=re(this,(e=te(t)).call.apply(e,[this].concat(r))),"_clip",T7,ne(i)),fe(i,"_loop",S7,ne(i)),fe(i,"_playOnAwake",E7,ne(i)),fe(i,"_volume",w7,ne(i)),i._cachedCurrentTime=0,i}return ee(t,rp),J(t,[{key:"onLoad",value:function(){this._syncStates(),this._playOnAwake&&this.play()}},{key:"onDisable",value:function(){this.pause()}},{key:"onDestroy",value:function(){this.stop()}},{key:"play",value:function(){this._clip&&(this.playing?this.currentTime=0:this._clip.play())}},{key:"pause",value:function(){this._clip&&this._clip.pause()}},{key:"stop",value:function(){this._clip&&this._clip.stop()}},{key:"playOneShot",value:function(e){var t=arguments.length>1&&void 0!==arguments[1]?arguments[1]:1;e.playOneShot(this._volume*t)}},{key:"_syncStates",value:function(){this._clip&&(this._clip.setCurrentTime(this._cachedCurrentTime),this._clip.setLoop(this._loop),this._clip.setVolume(this._volume,!0),this._volume=this._clip.getVolume())}},{key:"clip",set:function(e){this._clip=e,this._syncStates()},get:function(){return this._clip}},{key:"loop",set:function(e){this._loop=e,this._clip&&this._clip.setLoop(e)},get:function(){return this._loop}},{key:"playOnAwake",set:function(e){this._playOnAwake=e},get:function(){return this._playOnAwake}},{key:"volume",set:function(e){isNaN(e)?console.warn("illegal audio volume!"):(e=pi(e,0,1),this._clip?(this._clip.setVolume(e),this._volume=this._clip.getVolume()):this._volume=e)},get:function(){return this._volume}},{key:"currentTime",set:function(e){isNaN(e)?console.warn("illegal audio time!"):(e=pi(e,0,this.duration),this._cachedCurrentTime=e,this._clip&&this._clip.setCurrentTime(this._cachedCurrentTime))},get:function(){return this._clip?this._clip.getCurrentTime():this._cachedCurrentTime}},{key:"duration",get:function(){return this._clip?this._clip.getDuration():0}},{key:"state",get:function(){return this._clip?this._clip.state:exports.AudioClip.PlayingState.INITIALIZING}},{key:"playing",get:function(){return this.state===exports.AudioClip.PlayingState.PLAYING}}]),t}()).prototype,"_clip",[d7],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return null}}),S7=de(b7.prototype,"_loop",[Ko],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return!1}}),E7=de(b7.prototype,"_playOnAwake",[Ko],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return!0}}),w7=de(b7.prototype,"_volume",[Ko],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return 1}}),de(b7.prototype,"clip",[m7],Object.getOwnPropertyDescriptor(b7.prototype,"clip"),b7.prototype),de(b7.prototype,"loop",[v7],Object.getOwnPropertyDescriptor(b7.prototype,"loop"),b7.prototype),de(b7.prototype,"playOnAwake",[y7],Object.getOwnPropertyDescriptor(b7.prototype,"playOnAwake"),b7.prototype),de(b7.prototype,"volume",[g7],Object.getOwnPropertyDescriptor(b7.prototype,"volume"),b7.prototype),x7=b7))||x7)||x7)||x7);cc.AudioSourceComponent=O7;var k7=0,R7=function e(){Z(this,e),this.actions=[],this.target=null,this.actionIndex=0,this.currentAction=null,this.paused=!1,this.lock=!1},F7=function(){function e(){Z(this,e),this._hashTargets=Re(!0),this._arrayTargets=[],this._elementPool=[]}return J(e,[{key:"_searchElementByTarget",value:function(e,t){for(var i=0;i<e.length;i++)if(t===e[i].target)return e[i];return null}},{key:"_getElement",value:function(e,t){var i=this._elementPool.pop();return i||(i=new R7),i.target=e,i.paused=!!t,i}},{key:"_putElement",value:function(e){e.actions.length=0,e.actionIndex=0,e.currentAction=null,e.paused=!1,e.target=null,e.lock=!1,this._elementPool.push(e)}},{key:"addAction",value:function(e,t,i){if(e&&t){null==t.uuid&&(t.uuid="_TWEEN_UUID_"+k7++);var n=this._hashTargets[t.uuid];n?n.actions||(n.actions=[]):(n=this._getElement(t,i),this._hashTargets[t.uuid]=n,this._arrayTargets.push(n)),n.actions.push(e),e.startWithTarget(t)}else b(1e3)}},{key:"removeAllActions",value:function(){for(var e=this._arrayTargets,t=0;t<e.length;t++){var i=e[t];i&&this._putElement(i)}this._arrayTargets.length=0,this._hashTargets=Re(!0)}},{key:"removeAllActionsFromTarget",value:function(e,t){if(null!=e){var i=this._hashTargets[e.uuid];i&&(i.actions.length=0,this._deleteHashElement(i))}}},{key:"removeAction",value:function(e){if(null!=e){var t=e.getOriginalTarget(),i=this._hashTargets[t.uuid];if(i)for(var n=0;n<i.actions.length;n++)if(i.actions[n]===e){i.actions.splice(n,1),i.actionIndex>=n&&i.actionIndex--;break}}}},{key:"removeActionByTag",value:function(e,t){e===cc.Action.TAG_INVALID&&cc.logID(1002),cc.assertID(t,1003);var i=this._hashTargets[t.uuid];if(i)for(var n=i.actions.length,r=0;r<n;++r){var a=i.actions[r];if(a&&a.getTag()===e&&a.getOriginalTarget()===t){this._removeActionAtIndex(r,i);break}}}},{key:"getActionByTag",value:function(e,t){e===cc.Action.TAG_INVALID&&cc.logID(1004);var i=this._hashTargets[t.uuid];if(i){if(null!=i.actions)for(var n=0;n<i.actions.length;++n){var r=i.actions[n];if(r&&r.getTag()===e)return r}cc.logID(1005,e)}return null}},{key:"getNumberOfRunningActionsInTarget",value:function(e){var t=this._hashTargets[e.uuid];return t&&t.actions?t.actions.length:0}},{key:"pauseTarget",value:function(e){var t=this._hashTargets[e.uuid];t&&(t.paused=!0)}},{key:"resumeTarget",value:function(e){var t=this._hashTargets[e.uuid];t&&(t.paused=!1)}},{key:"pauseAllRunningActions",value:function(){for(var e=[],t=this._arrayTargets,i=0;i<t.length;i++){var n=t[i];n&&!n.paused&&(n.paused=!0,e.push(n.target))}return e}},{key:"resumeTargets",value:function(e){if(e)for(var t=0;t<e.length;t++)e[t]&&this.resumeTarget(e[t])}},{key:"pauseTargets",value:function(e){if(e)for(var t=0;t<e.length;t++)e[t]&&this.pauseTarget(e[t])}},{key:"purgeSharedManager",value:function(){cc.director.getScheduler().unscheduleUpdate(this)}},{key:"_removeActionAtIndex",value:function(e,t){t.actions[e];t.actions.splice(e,1),t.actionIndex>=e&&t.actionIndex--,0===t.actions.length&&this._deleteHashElement(t)}},{key:"_deleteHashElement",value:function(e){var t=!1;if(e&&!e.lock&&this._hashTargets[e.target.uuid]){delete this._hashTargets[e.target.uuid];for(var i=this._arrayTargets,n=0,r=i.length;n<r;n++)if(i[n]===e){i.splice(n,1);break}this._putElement(e),t=!0}return t}},{key:"update",value:function(e){for(var t,i=this._arrayTargets,n=0;n<i.length;n++){if(this._currentTarget=i[n],!(t=this._currentTarget).paused&&t.actions){for(t.lock=!0,t.actionIndex=0;t.actionIndex<t.actions.length;t.actionIndex++)if(t.currentAction=t.actions[t.actionIndex],t.currentAction){if(t.currentAction.step(e*(t.currentAction._speedMethod?t.currentAction._speed:1)),t.currentAction&&t.currentAction.isDone()){t.currentAction.stop();var r=t.currentAction;t.currentAction=null,this.removeAction(r)}t.currentAction=null}t.lock=!1}0===t.actions.length&&this._deleteHashElement(t)&&n--}}}]),e}(),M7=function(e){function t(){var e,i;Z(this,t);for(var n=arguments.length,r=new Array(n),a=0;a<n;a++)r[a]=arguments[a];return(i=re(this,(e=te(t)).call.apply(e,[this].concat(r)))).actionMgr=new F7,i}return ee(t,NA),J(t,[{key:"postUpdate",value:function(e){this.actionMgr.update(e)}},{key:"ActionManager",get:function(){return this.actionMgr}}]),t}();M7.ID="TWEEN",M7.instance=void 0,_O.on(iO.EVENT_INIT,(function(){var e=new M7;M7.instance=e,_O.registerSystem(M7.ID,e,100)}));var I7=function(){function e(){Z(this,e),this.originalTarget=null,this.target=null,this.tag=e.TAG_INVALID}return J(e,[{key:"clone",value:function(){var t=new e;return t.originalTarget=null,t.target=null,t.tag=this.tag,t}},{key:"isDone",value:function(){return!0}},{key:"startWithTarget",value:function(e){this.originalTarget=e,this.target=e}},{key:"stop",value:function(){this.target=null}},{key:"step",value:function(e){v(1006)}},{key:"update",value:function(e){v(1007)}},{key:"getTarget",value:function(){return this.target}},{key:"setTarget",value:function(e){this.target=e}},{key:"getOriginalTarget",value:function(){return this.originalTarget}},{key:"setOriginalTarget",value:function(e){this.originalTarget=e}},{key:"getTag",value:function(){return this.tag}},{key:"setTag",value:function(e){this.tag=e}},{key:"reverse",value:function(){return v(1008),null}},{key:"retain",value:function(){}},{key:"release",value:function(){}}]),e}();I7.TAG_INVALID=-1;var P7=function(e){function t(){var e,i;Z(this,t);for(var n=arguments.length,r=new Array(n),a=0;a<n;a++)r[a]=arguments[a];return(i=re(this,(e=te(t)).call.apply(e,[this].concat(r))))._duration=0,i._timesForRepeat=1,i}return ee(t,I7),J(t,[{key:"getDuration",value:function(){return this._duration*(this._timesForRepeat||1)}},{key:"setDuration",value:function(e){this._duration=e}},{key:"clone",value:function(){return new t}}]),t}(),L7=function(e){function t(){return Z(this,t),re(this,te(t).apply(this,arguments))}return ee(t,P7),J(t,[{key:"isDone",value:function(){return!0}},{key:"step",value:function(e){this.update(1)}},{key:"update",value:function(e){}},{key:"reverse",value:function(){return this.clone()}},{key:"clone",value:function(){return new t}}]),t}(),D7=function(e){function t(){return Z(this,t),re(this,te(t).apply(this,arguments))}return ee(t,L7),J(t,[{key:"update",value:function(e){for(var t=this.target.getComponentsInChildren(Hp),i=0;i<t.length;++i){t[i].enabled=!0}}},{key:"reverse",value:function(){return new N7}},{key:"clone",value:function(){return new t}}]),t}();var N7=function(e){function t(){return Z(this,t),re(this,te(t).apply(this,arguments))}return ee(t,L7),J(t,[{key:"update",value:function(e){for(var t=this.target.getComponentsInChildren(Hp),i=0;i<t.length;++i){t[i].enabled=!1}}},{key:"reverse",value:function(){return new D7}},{key:"clone",value:function(){return new t}}]),t}();var z7=function(e){function t(e){var i;return Z(this,t),(i=re(this,te(t).call(this)))._isNeedCleanUp=!0,void 0!==e&&i.init(e),i}return ee(t,L7),J(t,[{key:"update",value:function(e){this.target.removeFromParent(),this._isNeedCleanUp&&this.target.destroy()}},{key:"init",value:function(e){return this._isNeedCleanUp=e,!0}},{key:"reverse",value:function(){return new t(this._isNeedCleanUp)}},{key:"clone",value:function(){return new t(this._isNeedCleanUp)}}]),t}();var B7=function(e){function t(e,i,n){var r;return Z(this,t),(r=re(this,te(t).call(this)))._selectorTarget=null,r._function=null,r._data=null,r.initWithFunction(e,i,n),r}return ee(t,L7),J(t,[{key:"initWithFunction",value:function(e,t,i){return e&&(this._function=e),t&&(this._selectorTarget=t),void 0!==i&&(this._data=i),!0}},{key:"execute",value:function(){this._function&&this._function.call(this._selectorTarget,this.target,this._data)}},{key:"update",value:function(e){this.execute()}},{key:"getTargetCallback",value:function(){return this._selectorTarget}},{key:"setTargetCallback",value:function(e){e!==this._selectorTarget&&(this._selectorTarget&&(this._selectorTarget=null),this._selectorTarget=e)}},{key:"clone",value:function(){var e=new t;return e.initWithFunction(this._function,this._selectorTarget,this._data),e}}]),t}();var G7=function(e){function t(e){var i;return Z(this,t),(i=re(this,te(t).call(this))).MAX_VALUE=2,i._elapsed=0,i._firstTick=!1,i._easeList=[],i._speed=1,i._repeatForever=!1,i._repeatMethod=!1,i._speedMethod=!1,void 0===e||isNaN(e)||i.initWithDuration(e),i}return ee(t,P7),J(t,[{key:"getElapsed",value:function(){return this._elapsed}},{key:"initWithDuration",value:function(e){return this._duration=0===e?cu.FLT_EPSILON:e,this._elapsed=0,this._firstTick=!0,!0}},{key:"isDone",value:function(){return this._elapsed>=this._duration}},{key:"_cloneDecoration",value:function(e){e._repeatForever=this._repeatForever,e._speed=this._speed,e._timesForRepeat=this._timesForRepeat,e._easeList=this._easeList,e._speedMethod=this._speedMethod,e._repeatMethod=this._repeatMethod}},{key:"_reverseEaseList",value:function(e){if(this._easeList){e._easeList=[];for(var t=0;t<this._easeList.length;t++)e._easeList.push(this._easeList[t])}}},{key:"clone",value:function(){var e=new t(this._duration);return this._cloneDecoration(e),e}},{key:"easing",value:function(e){this._easeList?this._easeList.length=0:this._easeList=[];for(var t=0;t<arguments.length;t++)this._easeList.push(arguments[t]);return this}},{key:"_computeEaseTime",value:function(e){return e}},{key:"step",value:function(e){this._firstTick?(this._firstTick=!1,this._elapsed=0):this._elapsed+=e;var t=this._elapsed/(this._duration>1.192092896e-7?this._duration:1.192092896e-7);t=1>t?t:1,this.update(t>0?t:0),this._repeatMethod&&this._timesForRepeat>1&&this.isDone()&&(this._repeatForever||this._timesForRepeat--,this.startWithTarget(this.target),this.step(this._elapsed-this._duration))}},{key:"startWithTarget",value:function(e){I7.prototype.startWithTarget.call(this,e),this._elapsed=0,this._firstTick=!0}},{key:"reverse",value:function(){return v(1010),this}},{key:"setAmplitudeRate",value:function(e){v(1011)}},{key:"getAmplitudeRate",value:function(){return v(1012),0}},{key:"speed",value:function(e){return e<=0?(v(1013),this):(this._speedMethod=!0,this._speed*=e,this)}},{key:"getSpeed",value:function(){return this._speed}},{key:"setSpeed",value:function(e){return this._speed=e,this}},{key:"repeat",value:function(e){return e=Math.round(e),isNaN(e)||e<1?(v(1014),this):(this._repeatMethod=!0,this._timesForRepeat*=e,this)}},{key:"repeatForever",value:function(){return this._repeatMethod=!0,this._timesForRepeat=this.MAX_VALUE,this._repeatForever=!0,this}}]),t}(),U7=function(e){function t(e){var i;Z(this,t),(i=re(this,te(t).call(this)))._actions=[],i._split=0,i._last=0,i._reversed=!1;var n=e instanceof Array?e:arguments;if(1===n.length)return b(1019),re(i);var r=n.length-1;if(r>=0&&null==n[r]&&v(1015),r>=0){for(var a,o=n[0],s=1;s<r;s++)n[s]&&(a=o,o=t._actionOneTwo(a,n[s]));i.initWithTwoActions(o,n[r])}return i}return ee(t,G7),J(t,[{key:"initWithTwoActions",value:function(e,t){if(!e||!t)return b(1025),!1;var i=e._duration,n=t._duration,r=(i*=e._repeatMethod?e._timesForRepeat:1)+(n*=t._repeatMethod?t._timesForRepeat:1);return this.initWithDuration(r),this._actions[0]=e,this._actions[1]=t,!0}},{key:"clone",value:function(){var e=new t;return this._cloneDecoration(e),e.initWithTwoActions(this._actions[0].clone(),this._actions[1].clone()),e}},{key:"startWithTarget",value:function(e){G7.prototype.startWithTarget.call(this,e),this._split=this._actions[0]._duration/this._duration,this._split*=this._actions[0]._repeatMethod?this._actions[0]._timesForRepeat:1,this._last=-1}},{key:"stop",value:function(){-1!==this._last&&this._actions[this._last].stop(),I7.prototype.stop.call(this)}},{key:"update",value:function(e){var t,i,n=0,r=this._split,a=this._actions,o=this._last;(e=this._computeEaseTime(e))<r?(t=0!==r?e/r:1,0===n&&1===o&&this._reversed&&(a[1].update(0),a[1].stop())):(n=1,t=1===r?1:(e-r)/(1-r),-1===o&&(a[0].startWithTarget(this.target),a[0].update(1),a[0].stop()),0===o&&(a[0].update(1),a[0].stop())),i=a[n],o===n&&i.isDone()||(o!==n&&i.startWithTarget(this.target),t*=i._timesForRepeat,i.update(t>1?t%1:t),this._last=n)}},{key:"reverse",value:function(){var e=t._actionOneTwo(this._actions[1].reverse(),this._actions[0].reverse());return this._cloneDecoration(e),this._reverseEaseList(e),e._reversed=!0,e}}]),t}();function X7(e){var t=e instanceof Array?e:arguments;if(1===t.length)return b(1019),null;var i=t.length-1;i>=0&&null==t[i]&&v(1015);var n=null;if(i>=0){n=t[0];for(var r=1;r<=i;r++)t[r]&&(n=U7._actionOneTwo(n,t[r]))}return n}U7._actionOneTwo=function(e,t){var i=new U7;return i.initWithTwoActions(e,t),i};var V7=function(e){function t(e,i){var n;return Z(this,t),(n=re(this,te(t).call(this)))._times=0,n._total=0,n._nextDt=0,n._actionInstant=!1,n._innerAction=null,void 0!==i&&n.initWithAction(e,i),n}return ee(t,G7),J(t,[{key:"initWithAction",value:function(e,t){var i=e._duration*t;return!!this.initWithDuration(i)&&(this._times=t,this._innerAction=e,e instanceof L7&&(this._actionInstant=!0,this._times-=1),this._total=0,!0)}},{key:"clone",value:function(){var e=new t;return this._cloneDecoration(e),e.initWithAction(this._innerAction.clone(),this._times),e}},{key:"startWithTarget",value:function(e){this._total=0,this._nextDt=this._innerAction._duration/this._duration,G7.prototype.startWithTarget.call(this,e),this._innerAction.startWithTarget(e)}},{key:"stop",value:function(){this._innerAction.stop(),I7.prototype.stop.call(this)}},{key:"update",value:function(e){e=this._computeEaseTime(e);var t=this._innerAction,i=this._duration,n=this._times,r=this._nextDt;if(e>=r){for(;e>r&&this._total<n;)t.update(1),this._total++,t.stop(),t.startWithTarget(this.target),r+=t._duration/i,this._nextDt=r>1?1:r;e>=1&&this._total<n&&(t.update(1),this._total++),this._actionInstant||(this._total===n?t.stop():t.update(e-(r-t._duration/i)))}else t.update(e*n%1)}},{key:"isDone",value:function(){return this._total===this._times}},{key:"reverse",value:function(){var e=new t(this._innerAction.reverse(),this._times);return this._cloneDecoration(e),this._reverseEaseList(e),e}},{key:"setInnerAction",value:function(e){this._innerAction!==e&&(this._innerAction=e)}},{key:"getInnerAction",value:function(){return this._innerAction}}]),t}();var H7=function(e){function t(e){var i;return Z(this,t),(i=re(this,te(t).call(this)))._innerAction=null,e&&i.initWithAction(e),i}return ee(t,G7),J(t,[{key:"initWithAction",value:function(e){return e?(this._innerAction=e,!0):(b(1026),!1)}},{key:"clone",value:function(){var e=new t;return this._cloneDecoration(e),e.initWithAction(this._innerAction.clone()),e}},{key:"startWithTarget",value:function(e){G7.prototype.startWithTarget.call(this,e),this._innerAction.startWithTarget(e)}},{key:"step",value:function(e){var t=this._innerAction;t.step(e),t.isDone()&&(t.startWithTarget(this.target),t.step(t.getElapsed()-t._duration))}},{key:"isDone",value:function(){return!1}},{key:"reverse",value:function(){var e=new t(this._innerAction.reverse());return this._cloneDecoration(e),this._reverseEaseList(e),e}},{key:"setInnerAction",value:function(e){this._innerAction!==e&&(this._innerAction=e)}},{key:"getInnerAction",value:function(){return this._innerAction}}]),t}();var W7=function(e){function t(e){var i;Z(this,t),(i=re(this,te(t).call(this)))._one=null,i._two=null;var n=e instanceof Array?e:arguments;if(1===n.length)return b(1020),re(i);var r=n.length-1;if(r>=0&&null==n[r]&&v(1015),r>=0){for(var a,o=n[0],s=1;s<r;s++)n[s]&&(a=o,o=t._actionOneTwo(a,n[s]));i.initWithTwoActions(o,n[r])}return i}return ee(t,G7),J(t,[{key:"initWithTwoActions",value:function(e,t){if(!e||!t)return b(1027),!1;var i=!1,n=e._duration,r=t._duration;return this.initWithDuration(Math.max(n,r))&&(this._one=e,this._two=t,n>r?this._two=U7._actionOneTwo(t,Y7(n-r)):n<r&&(this._one=U7._actionOneTwo(e,Y7(r-n))),i=!0),i}},{key:"clone",value:function(){var e=new t;return this._cloneDecoration(e),e.initWithTwoActions(this._one.clone(),this._two.clone()),e}},{key:"startWithTarget",value:function(e){G7.prototype.startWithTarget.call(this,e),this._one.startWithTarget(e),this._two.startWithTarget(e)}},{key:"stop",value:function(){this._one.stop(),this._two.stop(),I7.prototype.stop.call(this)}},{key:"update",value:function(e){e=this._computeEaseTime(e),this._one&&this._one.update(e),this._two&&this._two.update(e)}},{key:"reverse",value:function(){var e=t._actionOneTwo(this._one.reverse(),this._two.reverse());return this._cloneDecoration(e),this._reverseEaseList(e),e}}]),t}();function j7(e){var t=e instanceof Array?e:arguments;if(1===t.length)return b(1020),null;t.length>0&&null==t[t.length-1]&&v(1015);for(var i=t[0],n=1;n<t.length;n++)null!=t[n]&&(i=W7._actionOneTwo(i,t[n]));return i}W7._actionOneTwo=function(e,t){var i=new W7;return i.initWithTwoActions(e,t),i};var q7=function(e){function t(){return Z(this,t),re(this,te(t).apply(this,arguments))}return ee(t,G7),J(t,[{key:"update",value:function(e){}},{key:"reverse",value:function(){var e=new t(this._duration);return this._cloneDecoration(e),this._reverseEaseList(e),e}},{key:"clone",value:function(){var e=new t;return this._cloneDecoration(e),e.initWithDuration(this._duration),e}}]),t}();function Y7(e){return new q7(e)}var K7=function(e){function t(e){var i;return Z(this,t),(i=re(this,te(t).call(this)))._other=null,e&&i.initWithAction(e),i}return ee(t,G7),J(t,[{key:"initWithAction",value:function(e){return e?e===this._other?(b(1029),!1):!!G7.prototype.initWithDuration.call(this,e._duration)&&(this._other=e,!0):(b(1028),!1)}},{key:"clone",value:function(){var e=new t;return this._cloneDecoration(e),e.initWithAction(this._other.clone()),e}},{key:"startWithTarget",value:function(e){G7.prototype.startWithTarget.call(this,e),this._other.startWithTarget(e)}},{key:"update",value:function(e){e=this._computeEaseTime(e),this._other&&this._other.update(1-e)}},{key:"reverse",value:function(){return this._other.clone()}},{key:"stop",value:function(){this._other.stop(),I7.prototype.stop.call(this)}}]),t}();var Z7=function(e){function t(e,i,n){var r;if(Z(this,t),(r=re(this,te(t).call(this)))._opts=void 0,r._props=void 0,r._originProps=void 0,null==n)n=Object.create(null);else if(function(e){var t=" [Tween:] ",i=" option is not support in v"+cc.ENGINE_VERSION;e.delay&&c(t+"delay"+i),e.repeat&&c(t+"repeat"+i),e.repeatDelay&&c(t+"repeatDelay"+i),e.interpolation&&c(t+"interpolation"+i),e.onStop&&c(t+"onStop"+i)}(n),n.easing&&"string"==typeof n.easing&&(n.easing=function(e){var t=e.charAt(0);if(/[A-Z]/.test(t)){var i=(e=e.replace(t,t.toLowerCase())).split("-");if(2==i.length){var n=i[0];if("linear"==n)e="linear";else{var r=i[1];switch(n){case"quadratic":e="quad"+r;break;case"quartic":e="quart"+r;break;case"quintic":e="quint"+r;break;case"sinusoidal":e="sine"+r;break;case"exponential":e="expo"+r;break;case"circular":e="circ"+r;break;default:e=n+r}}}}return e}(n.easing)),n.progress||(n.progress=r.progress),n.easing&&"string"==typeof n.easing){var a=n.easing;n.easing=cI[a],n.easing||g(1031,a)}for(var o in r._opts=n,r._props=Object.create(null),i){var s=i[o],l=void 0,u=void 0;void 0!==s.value&&(s.easing||s.progress)&&("string"==typeof s.easing?!(l=l[s.easing])&&g(1031,s.easing):l=s.easing,u=s.progress,s=s.value);var h=Object.create(null);h.value=s,h.easing=l,h.progress=u,r._props[o]=h}return r._originProps=i,r.initWithDuration(e),r}return ee(t,G7),J(t,[{key:"clone",value:function(){var e=new t(this._duration,this._originProps,this._opts);return this._cloneDecoration(e),e}},{key:"startWithTarget",value:function(e){G7.prototype.startWithTarget.call(this,e);var t=!!this._opts.relative,i=this._props;for(var n in i){var r=e[n];if(void 0!==r){var a=i[n],o=a.value;if("number"==typeof r)a.start=r,a.current=r,a.end=t?r+o:o;else if("object"===K(r))for(var s in null==a.start&&(a.start={},a.current={},a.end={}),o)a.start[s]=r[s],a.current[s]=r[s],a.end[s]=t?r[s]+o[s]:o[s]}}this._opts.onStart&&this._opts.onStart(this.target)}},{key:"update",value:function(e){var t=this.target;if(t){var i=this._props,n=this._opts,r=e;n.easing&&(r=n.easing(e));var a=n.progress;for(var o in i){var s=i[o],l=s.easing?s.easing(e):r,u=s.progress?s.progress:a,c=s.start,h=s.end;if("number"==typeof c)s.current=u(c,h,s.current,l);else if("object"===K(c))for(var p in c)s.current[p]=u(c[p],h[p],s.current[p],l);t[o]=s.current}n.onUpdate&&n.onUpdate(this.target,e),1==e&&n.onComplete&&n.onComplete(this.target)}}},{key:"progress",value:function(e,t,i,n){return e+(t-e)*n}}]),t}(),Q7=function(e){function t(e){var i;return Z(this,t),(i=re(this,te(t).call(this)))._props=void 0,i._props={},void 0!==e&&i.init(e),i}return ee(t,L7),J(t,[{key:"init",value:function(e){for(var t in e)this._props[t]=e[t];return!0}},{key:"update",value:function(){var e=this._props,t=this.target;for(var i in e)t[i]=e[i]}},{key:"clone",value:function(){var e=new t;return e.init(this._props),e}}]),t}(),J7=function(){function e(t){Z(this,e),this._actions=[],this._finalAction=null,this._target=null,this._target=void 0===t?null:t,this._target&&this._target instanceof tg&&this._target.on(exports.SystemEventType.NODE_DESTROYED,this._destroy,this)}return J(e,[{key:"then",value:function(e){return e instanceof I7?this._actions.push(e.clone()):this._actions.push(e._union()),this}},{key:"target",value:function(e){return this._target&&this._target instanceof tg&&this._target.off(exports.SystemEventType.NODE_DESTROYED,this._destroy,this),this._target=e,this._target&&this._target instanceof tg&&this._target.on(exports.SystemEventType.NODE_DESTROYED,this._destroy,this),this}},{key:"start",value:function(){return this._target?(this._finalAction&&M7.instance.ActionManager.removeAction(this._finalAction),this._finalAction=this._union(),M7.instance.ActionManager.addAction(this._finalAction,this._target,!1),this):(c("Please set target to tween first"),this)}},{key:"stop",value:function(){return this._finalAction&&M7.instance.ActionManager.removeAction(this._finalAction),this}},{key:"clone",value:function(e){var t=this._union();return $7(e).then(t.clone())}},{key:"union",value:function(){var e=this._union();return this._actions.length=0,this._actions.push(e),this}},{key:"to",value:function(e,t,i){(i=i||Object.create(null)).relative=!1;var n=new Z7(e,t,i);return this._actions.push(n),this}},{key:"by",value:function(e,t,i){(i=i||Object.create(null)).relative=!0;var n=new Z7(e,t,i);return this._actions.push(n),this}},{key:"set",value:function(e){var t=new Q7(e);return this._actions.push(t),this}},{key:"delay",value:function(e){var t=Y7(e);return this._actions.push(t),this}},{key:"call",value:function(e){var t,i,n=new B7(e,t,i);return this._actions.push(n),this}},{key:"sequence",value:function(){var t=e._wrappedSequence.apply(e,arguments);return this._actions.push(t),this}},{key:"parallel",value:function(){var t=e._wrappedParallel.apply(e,arguments);return this._actions.push(t),this}},{key:"repeat",value:function(t,i){if(t==1/0)return this.repeatForever(i);var n,r=this._actions;return n=i instanceof e?i._union():r.pop(),r.push(function(e,t){return new V7(e,t)}(n,t)),this}},{key:"repeatForever",value:function(t){var i,n=this._actions;return i=t instanceof e?t._union():n.pop(),n.push(function(e){return new H7(e)}(i)),this}},{key:"reverseTime",value:function(t){var i,n=this._actions;return i=t instanceof e?t._union():n.pop(),n.push(function(e){return new K7(e)}(i)),this}},{key:"hide",value:function(){var e=new N7;return this._actions.push(e),this}},{key:"show",value:function(){var e=new D7;return this._actions.push(e),this}},{key:"removeSelf",value:function(){var e=new z7(!1);return this._actions.push(e),this}},{key:"_union",value:function(){var e=this._actions;return 1===e.length?e[0]:X7(e)}},{key:"_destroy",value:function(){this.stop()}}],[{key:"_wrappedSequence",value:function(){var t=e._tmp_args;t.length=0;for(var i=arguments.length,n=0;n<i;n++){var r=t[n]=n<0||arguments.length<=n?void 0:arguments[n];r instanceof e&&(t[n]=r._union())}return X7.apply(X7,t)}},{key:"_wrappedParallel",value:function(){var t=e._tmp_args;t.length=0;for(var i=arguments.length,n=0;n<i;n++){var r=t[n]=n<0||arguments.length<=n?void 0:arguments[n];r instanceof e&&(t[n]=r._union())}return j7.apply(j7,t)}}]),e}();function $7(e){return new J7(e)}function e9(e){return c("tweenUtil' is deprecated, please use 'tween' instead "),new J7(e)}J7._tmp_args=[],cc.Tween=J7,cc.tween=$7,cc.tweenUtil=e9;var t9,i9,n9,r9,a9,o9,s9,l9,u9,c9,h9,p9,_9,f9,d9,m9,v9,y9,g9,x9,b9,T9,S9,E9,w9,C9,A9,O9,k9,R9,F9,M9,I9,P9,L9,D9=function(){function e(t,i){Z(this,e),this.data=new Uint16Array,this.w=0,this.h=0,this.w=t,this.h=i,this.data=new Uint16Array(t*i);for(var n=0;n<t*i;++n)this.data[n]=0}return J(e,[{key:"set",value:function(e,t,i){this.data[t*this.w+e]=i}},{key:"get",value:function(e,t){return this.data[t*this.w+e]}},{key:"getClamp",value:function(e,t){return e=pi(e,0,this.w-1),t=pi(t,0,this.h-1),this.get(e,t)}},{key:"getAt",value:function(e,t){var i=e,n=t,r=Math.floor(i),a=Math.floor(n),o=r+1,s=a+1,l=i-r,u=n-a;r=pi(r,0,this.w-1),a=pi(a,0,this.h-1),o=pi(o,0,this.w-1),s=pi(s,0,this.h-1);var c=this.get(r,a),h=this.get(o,a),p=this.get(r,s),_=this.get(o,s),f=.5*(h+p);return l+u<=1?_=f+(f-c):c=f+(f-_),(c*(1-l)+h*l)*(1-u)+(p*(1-l)+_*l)*u}}]),e}(),N9=function(){function e(){Z(this,e),this.length=0,this.buffer=new Uint8Array(2048),this._buffView=new DataView(this.buffer.buffer),this._seekPos=0}return J(e,[{key:"reserve",value:function(e){if(!(this.buffer.byteLength>e)){for(var t=this.buffer.byteLength;t<e;)t+=t;for(var i=new Uint8Array(t),n=0;n<this.length;++n)i[n]=this.buffer[n];this.buffer=i,this._buffView=new DataView(this.buffer.buffer)}}},{key:"assign",value:function(e){this.buffer=e,this.length=e.length,this._seekPos=e.byteOffset,this._buffView=new DataView(e.buffer)}},{key:"writeInt8",value:function(e){this.reserve(this.length+1),this._buffView.setInt8(this.length,e),this.length+=1}},{key:"writeInt16",value:function(e){this.reserve(this.length+2),this._buffView.setInt16(this.length,e,!0),this.length+=2}},{key:"writeInt32",value:function(e){this.reserve(this.length+4),this._buffView.setInt32(this.length,e,!0),this.length+=4}},{key:"writeIntArray",value:function(e){this.reserve(this.length+4*e.length);for(var t=0;t<e.length;++t)this._buffView.setInt32(this.length+4*t,e[t],!0);this.length+=4*e.length}},{key:"writeFloat",value:function(e){this.reserve(this.length+4),this._buffView.setFloat32(this.length,e,!0),this.length+=4}},{key:"writeFloatArray",value:function(e){this.reserve(this.length+4*e.length);for(var t=0;t<e.length;++t)this._buffView.setFloat32(this.length+4*t,e[t],!0);this.length+=4*e.length}},{key:"writeString",value:function(e){this.reserve(this.length+e.length+4),this._buffView.setInt32(this.length,e.length,!0);for(var t=0;t<e.length;++t)this._buffView.setInt8(this.length+4+t,e.charCodeAt(t));this.length+=e.length+4}},{key:"readInt8",value:function(){var e=this._buffView.getInt8(this._seekPos);return this._seekPos+=1,e}},{key:"readInt16",value:function(){var e=this._buffView.getInt16(this._seekPos,!0);return this._seekPos+=2,e}},{key:"readInt",value:function(){var e=this._buffView.getInt32(this._seekPos,!0);return this._seekPos+=4,e}},{key:"readIntArray",value:function(e){for(var t=0;t<e.length;++t)e[t]=this._buffView.getInt32(this._seekPos+4*t,!0);return this._seekPos+=4*e.length,e}},{key:"readFloat",value:function(){var e=this._buffView.getFloat32(this._seekPos,!0);return this._seekPos+=4,e}},{key:"readFloatArray",value:function(e){for(var t=0;t<e.length;++t)e[t]=this._buffView.getFloat32(this._seekPos+4*t,!0);return this._seekPos+=4*e.length,e}},{key:"readString",value:function(){for(var e=this.readInt(),t="",i=0;i<e;++i)t+=String.fromCharCode(this.readInt8());return t}}]),e}(),z9=function e(){Z(this,e),this.slot=0,this.tileSize=1,this.detailMap=""},B9=Yo("cc.TerrainAsset")(t9=function(e){function t(){var e;return Z(this,t),(e=re(this,te(t).call(this)))._data=null,e._tileSize=1,e._blockCount=[1,1],e._weightMapSize=128,e._lightMapSize=128,e._heights=new Uint16Array,e._weights=new Uint8Array,e._layerBuffer=[-1,-1,-1,-1],e._layerInfos=[],e.loaded=!1,e}return ee(t,zl),J(t,[{key:"getLayer",value:function(e,t,i){var n=4*(t*this.blockCount[0]+e)+i;return e<this.blockCount[0]&&t<this.blockCount[1]&&n<this._layerBuffer.length?this._layerBuffer[n]:-1}},{key:"_setNativeData",value:function(e){this._data=e}},{key:"_loadNativeData",value:function(e){var t=new N9;t.assign(e);var i=t.readInt();if(16843025===i)return!0;if(16842753!==i&&16842754!==i&&16842755!==i)return!1;this.tileSize=t.readFloat(),t.readIntArray(this._blockCount),this.weightMapSize=t.readInt16(),this.lightMapSize=t.readInt16();var n=t.readInt();this.heights=new Uint16Array(n);for(var r=0;r<this.heights.length;++r)this.heights[r]=t.readInt16();var a=t.readInt();this.weights=new Uint8Array(a);for(var o=0;o<this.weights.length;++o)this.weights[o]=t.readInt8();if(i>=16842754){var s=t.readInt();this.layerBuffer=new Array(s);for(var l=0;l<this.layerBuffer.length;++l)this.layerBuffer[l]=t.readInt16()}if(i>=16842755){var u=t.readInt();this.layerInfos=new Array(u);for(var c=0;c<this.layerInfos.length;++c)this.layerInfos[c]=new z9,this.layerInfos[c].slot=t.readInt(),this.layerInfos[c].tileSize=t.readFloat(),this.layerInfos[c].detailMap=t.readString()}return!0}},{key:"_exportNativeData",value:function(){var e=new N9;e.writeInt32(16842755),e.writeFloat(this.tileSize),e.writeIntArray(this._blockCount),e.writeInt16(this.weightMapSize),e.writeInt16(this.lightMapSize),e.writeInt32(this.heights.length);for(var t=0;t<this.heights.length;++t)e.writeInt16(this.heights[t]);e.writeInt32(this.weights.length);for(var i=0;i<this.weights.length;++i)e.writeInt8(this.weights[i]);e.writeInt32(this.layerBuffer.length);for(var n=0;n<this.layerBuffer.length;++n)e.writeInt16(this.layerBuffer[n]);e.writeInt32(this.layerInfos.length);for(var r=0;r<this.layerInfos.length;++r)e.writeInt32(this.layerInfos[r].slot),e.writeFloat(this.layerInfos[r].tileSize),e.writeString(this.layerInfos[r].detailMap);return e.buffer}},{key:"_exportDefaultNativeData",value:function(){var e=new N9;return e.writeInt32(16843025),e.buffer}},{key:"_nativeAsset",get:function(){return this._data.buffer},set:function(e){this._data&&this._data.byteLength===e.byteLength?(this._data.set(new Uint8Array(e)),cc.loader._cache[this.nativeUrl]&&(cc.loader._cache[this.nativeUrl].content=this._data.buffer)):this._data=new Uint8Array(e),this._loadNativeData(this._data),this.loaded=!0,this.emit("load")}},{key:"tileSize",set:function(e){this._tileSize=e},get:function(){return this._tileSize}},{key:"blockCount",set:function(e){this._blockCount=e},get:function(){return this._blockCount}},{key:"lightMapSize",set:function(e){this._lightMapSize=e},get:function(){return this._lightMapSize}},{key:"weightMapSize",set:function(e){this._weightMapSize=e},get:function(){return this._weightMapSize}},{key:"heights",set:function(e){this._heights=e},get:function(){return this._heights}},{key:"weights",set:function(e){this._weights=e},get:function(){return this._weights}},{key:"layerBuffer",set:function(e){this._layerBuffer=e},get:function(){return this._layerBuffer}},{key:"layerInfos",set:function(e){this._layerInfos=e},get:function(){return this._layerInfos}}]),t}())||t9,G9=Yo("cc.TerrainInfo")((r9=de((n9=function(){function e(){Z(this,e),fe(this,"tileSize",r9,this),fe(this,"blockCount",a9,this),fe(this,"weightMapSize",o9,this),fe(this,"lightMapSize",s9,this)}return J(e,[{key:"size",get:function(){var e=new en(0,0);return e.width=32*this.blockCount[0]*this.tileSize,e.height=32*this.blockCount[1]*this.tileSize,e}},{key:"tileCount",get:function(){var e=[0,0];return e[0]=32*this.blockCount[0],e[1]=32*this.blockCount[1],e}},{key:"vertexCount",get:function(){var e=this.tileCount;return e[0]+=1,e[1]+=1,e}}]),e}()).prototype,"tileSize",[Ko],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return 1}}),a9=de(n9.prototype,"blockCount",[Ko],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return[1,1]}}),o9=de(n9.prototype,"weightMapSize",[Ko],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return 128}}),s9=de(n9.prototype,"lightMapSize",[Ko],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return 128}}),i9=n9))||i9,U9=Yo("cc.TerrainLayer")((c9=de((u9=function e(){Z(this,e),fe(this,"detailMap",c9,this),fe(this,"tileSize",h9,this)}).prototype,"detailMap",[Ko],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return null}}),h9=de(u9.prototype,"tileSize",[Ko],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return 1}}),l9=u9))||l9,X9=function(e){function t(){var e,i;Z(this,t);for(var n=arguments.length,r=new Array(n),a=0;a<n;a++)r[a]=arguments[a];return(i=re(this,(e=te(t)).call.apply(e,[this].concat(r))))._model=null,i._meshData=null,i._brushMaterial=null,i._currentMaterial=null,i._currentMaterialLayers=0,i}return ee(t,Hp),J(t,[{key:"destroy",value:function(){null!=this._model&&(cc.director.root.destroyModel(this._model),this._model=null),oe(te(t.prototype),"destroy",this).call(this)}},{key:"_invalidMaterial",value:function(){null!=this._currentMaterial&&(this._clearMaterials(),this._currentMaterial=null,null!=this._model&&(this._model.enabled=!1))}},{key:"_updateMaterial",value:function(e,t){if(null!=this._meshData&&null!=this._model){var i=e.getMaxLayer();if(null==this._currentMaterial||i!==this._currentMaterialLayers){if(this._currentMaterial=new Bh,this._currentMaterial.initialize({effectAsset:cc.EffectAsset.get("builtin-terrain"),defines:e._getMaterialDefines(i)}),null!==this._brushMaterial)this._currentMaterial.passes.push(this._brushMaterial.passes[0]);t&&this._model.initSubModel(0,this._meshData,this._currentMaterial),this.setMaterial(this._currentMaterial,0),this._currentMaterialLayers=i,this._model.enabled=!0}}}},{key:"_onMaterialModified",value:function(e,t){null!=this._model&&this._onRebuildPSO(e,t||this._getBuiltinMaterial())}},{key:"_onRebuildPSO",value:function(e,t){this._model&&this._model.setSubModelMaterial(e,t)}},{key:"_clearMaterials",value:function(){null!=this._model&&this._onMaterialModified(0,null)}},{key:"_getBuiltinMaterial",value:function(){return Pc.get("missing-material")}}]),t}(),V9=Yo("cc.TerrainBlockInfo")((f9=de((_9=function e(){Z(this,e),fe(this,"layers",f9,this)}).prototype,"layers",[Ko],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return[-1,-1,-1,-1]}}),p9=_9))||p9,H9=Yo("cc.TerrainBlockLightmapInfo")((v9=de((m9=function e(){Z(this,e),fe(this,"texture",v9,this),fe(this,"UOff",y9,this),fe(this,"VOff",g9,this),fe(this,"UScale",x9,this),fe(this,"VScale",b9,this)}).prototype,"texture",[Ko],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return null}}),y9=de(m9.prototype,"UOff",[Ko],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return 0}}),g9=de(m9.prototype,"VOff",[Ko],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return 0}}),x9=de(m9.prototype,"UScale",[Ko],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return 0}}),b9=de(m9.prototype,"VScale",[Ko],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return 0}}),d9=m9))||d9,W9=function(){function e(t,i,n){Z(this,e),this._terrain=void 0,this._info=void 0,this._node=void 0,this._renderable=void 0,this._index=[1,1],this._weightMap=null,this._lightmapInfo=null,this._terrain=t,this._info=t.getBlockInfo(i,n),this._index[0]=i,this._index[1]=n,this._lightmapInfo=t._getLightmapInfo(i,n),this._node=new ix(""),this._node.setParent(this._terrain.node),this._node._objFlags|=cc.Object.Flags.DontSave,this._renderable=this._node.addComponent(X9)}return J(e,[{key:"build",value:function(){for(var e=_O.root.device,t=new Float32Array(8712),i=0,n=0;n<33;++n)for(var r=0;r<33;++r){var a=32*this._index[0]+r,o=32*this._index[1]+n,s=this._terrain.getPosition(a,o),l=this._terrain.getNormal(a,o),u=new ki(r/32,n/32);t[i++]=s.x,t[i++]=s.y,t[i++]=s.z,t[i++]=l.x,t[i++]=l.y,t[i++]=l.z,t[i++]=u.x,t[i++]=u.y}var c=e.createBuffer({usage:exports.GFXBufferUsageBit.VERTEX|exports.GFXBufferUsageBit.TRANSFER_DST,memUsage:exports.GFXMemoryUsageBit.HOST|exports.GFXMemoryUsageBit.DEVICE,size:8*Float32Array.BYTES_PER_ELEMENT*33*33,stride:8*Float32Array.BYTES_PER_ELEMENT});c.update(t);var h=[{name:exports.GFXAttributeName.ATTR_POSITION,format:exports.GFXFormat.RGB32F},{name:exports.GFXAttributeName.ATTR_NORMAL,format:exports.GFXFormat.RGB32F},{name:exports.GFXAttributeName.ATTR_TEX_COORD,format:exports.GFXFormat.RG32F}];(this._renderable._meshData=new tc([c],h,exports.GFXPrimitiveMode.TRIANGLE_LIST)).indexBuffer=this._terrain._getSharedIndexBuffer()||void 0,this._renderable._model=cc.director.root.createModel(ah),this._renderable._model.initialize(this._node),this._renderable._getRenderScene().addModel(this._renderable._model),this._updateWeightMap(),this._updateMaterial(!0)}},{key:"rebuild",value:function(){this._updateHeight(),this._updateWeightMap(),this._renderable._invalidMaterial(),this._updateMaterial(!1)}},{key:"destroy",value:function(){null!=this._renderable&&this._renderable.destroy(),null!=this._node&&this._node.destroy(),null!=this._weightMap&&this._weightMap.destroy()}},{key:"update",value:function(){this._updateMaterial(!1);var e=this._renderable._currentMaterial;if(null!=e){var t=this.getMaxLayer(),i=new Ni(1,1,1,1);if(0===t)if(-1!==this.layers[0]){var n=this._terrain.getLayer(this.layers[0]);null!=n&&(i.x=1/n.tileSize),e.setProperty("detailMap0",null!=n?n.detailMap:null)}else e.setProperty("detailMap0",cc.builtinResMgr.get("default-texture"));else if(1===t){var r=this._terrain.getLayer(this.layers[0]),a=this._terrain.getLayer(this.layers[1]);null!=r&&(i.x=1/r.tileSize),null!=a&&(i.y=1/a.tileSize),e.setProperty("weightMap",this._weightMap),e.setProperty("detailMap0",null!=r?r.detailMap:null),e.setProperty("detailMap1",null!=a?a.detailMap:null)}else if(2===t){var o=this._terrain.getLayer(this.layers[0]),s=this._terrain.getLayer(this.layers[1]),l=this._terrain.getLayer(this.layers[2]);null!=o&&(i.x=1/o.tileSize),null!=s&&(i.y=1/s.tileSize),null!=l&&(i.z=1/l.tileSize),e.setProperty("weightMap",this._weightMap),e.setProperty("detailMap0",null!=o?o.detailMap:null),e.setProperty("detailMap1",null!=s?s.detailMap:null),e.setProperty("detailMap2",null!=l?l.detailMap:null)}else if(3===t){var u=this._terrain.getLayer(this.layers[0]),c=this._terrain.getLayer(this.layers[1]),h=this._terrain.getLayer(this.layers[2]),p=this._terrain.getLayer(this.layers[3]);null!=u&&(i.x=1/u.tileSize),null!=c&&(i.y=1/c.tileSize),null!=h&&(i.z=1/h.tileSize),null!=p&&(i.z=1/p.tileSize),e.setProperty("weightMap",this._weightMap),e.setProperty("detailMap0",null!=u?u.detailMap:null),e.setProperty("detailMap1",null!=c?c.detailMap:null),e.setProperty("detailMap2",null!=h?h.detailMap:null),e.setProperty("detailMap3",null!=p?p.detailMap:null)}e.setProperty("UVScale",i),null!=this.lightmap&&(e.setProperty("lightMap",this.lightmap),e.setProperty("lightMapUVParam",this.lightmapUVParam))}}},{key:"setBrushMaterial",value:function(e){this._renderable._brushMaterial!==e&&(this._renderable._brushMaterial=e,this._renderable._invalidMaterial())}},{key:"getTerrain",value:function(){return this._terrain}},{key:"getIndex",value:function(){return this._index}},{key:"getRect",value:function(){var e=new nn;return e.x=32*this._index[0],e.y=32*this._index[1],e.width=32,e.height=32,e}},{key:"setLayer",value:function(e,t){this.layers[e]!==t&&(this.layers[e]=t,this._renderable._invalidMaterial(),this._updateMaterial(!1))}},{key:"getLayer",value:function(e){return this.layers[e]}},{key:"getMaxLayer",value:function(){return this.layers[3]>=0?3:this.layers[2]>=0?2:this.layers[1]>=0?1:0}},{key:"_getMaterialDefines",value:function(e){if(null!=this.lightmap){if(0===e)return{LAYERS:1,LIGHT_MAP:1};if(1===e)return{LAYERS:2,LIGHT_MAP:1};if(2===e)return{LAYERS:3,LIGHT_MAP:1};if(3===e)return{LAYERS:4,LIGHT_MAP:1}}else{if(0===e)return{LAYERS:1};if(1===e)return{LAYERS:2};if(2===e)return{LAYERS:3};if(3===e)return{LAYERS:4}}return{LAYERS:0}}},{key:"_invalidMaterial",value:function(){this._renderable._invalidMaterial()}},{key:"_updateMaterial",value:function(e){this._renderable._updateMaterial(this,e)}},{key:"_updateHeight",value:function(){if(null!=this._renderable._meshData){for(var e=new Float32Array(8712),t=0,i=0;i<33;++i)for(var n=0;n<33;++n){var r=32*this._index[0]+n,a=32*this._index[1]+i,o=this._terrain.getPosition(r,a),s=this._terrain.getNormal(r,a),l=new ki(n/33,i/33);e[t++]=o.x,e[t++]=o.y,e[t++]=o.z,e[t++]=s.x,e[t++]=s.y,e[t++]=s.z,e[t++]=l.x,e[t++]=l.y}this._renderable._meshData.vertexBuffers[0].update(e)}}},{key:"_updateWeightMap",value:function(){if(0!==this.getMaxLayer()){null==this._weightMap&&(this._weightMap=new gu,this._weightMap.create(this._terrain.weightMapSize,this._terrain.weightMapSize,Ol.RGBA8888),this._weightMap.setFilters(Rl.LINEAR,Rl.LINEAR),this._weightMap.setWrapMode(kl.CLAMP_TO_EDGE,kl.CLAMP_TO_EDGE));for(var e=new Uint8Array(this._terrain.weightMapSize*this._terrain.weightMapSize*4),t=0,i=0;i<this._terrain.weightMapSize;++i)for(var n=0;n<this._terrain.weightMapSize;++n){var r=this._index[0]*this._terrain.weightMapSize+n,a=this._index[1]*this._terrain.weightMapSize+i,o=this._terrain.getWeight(r,a);e[4*t+0]=Math.floor(255*o.x),e[4*t+1]=Math.floor(255*o.y),e[4*t+2]=Math.floor(255*o.z),e[4*t+3]=Math.floor(255*o.w),t+=1}this._weightMap.uploadData(e)}else null!=this._weightMap&&(this._weightMap.destroy(),this._weightMap=null)}},{key:"_updateLightmap",value:function(e){this._lightmapInfo=e,this._invalidMaterial()}},{key:"layers",get:function(){return this._info.layers}},{key:"lightmap",get:function(){return this._lightmapInfo?this._lightmapInfo.texture:null}},{key:"lightmapUVParam",get:function(){return null!=this._lightmapInfo?new Ni(this._lightmapInfo.UOff,this._lightmapInfo.VOff,this._lightmapInfo.UScale,this._lightmapInfo.VScale):new Ni(0,0,0,0)}}]),e}(),j9=(T9=Yo("cc.Terrain"),S9=os("i18n:cc.TerrainComponent"),E9=Ko({type:B9,visible:!1,animatable:!1}),w9=Ko({type:U9,visible:!0,animatable:!1}),C9=Ko({visible:!1,animatable:!1}),A9=Ko({visible:!1,animatable:!1}),O9=Ko({type:B9,visible:!0}),k9=Ko({type:G9,visible:!0}),T9(R9=S9(R9=Jo(R9=is((M9=de((F9=function(e){function t(){var e;Z(this,t),fe(e=re(this,te(t).call(this)),"__asset",M9,ne(e)),fe(e,"_layers",I9,ne(e)),fe(e,"_blockInfos",P9,ne(e)),fe(e,"_lightmapInfos",L9,ne(e)),e._tileSize=1,e._blockCount=[1,1],e._weightMapSize=128,e._lightMapSize=128,e._heights=new Uint16Array,e._weights=new Uint8Array,e._normals=[],e._blocks=[],e._sharedIndexBuffer=null;for(var i=0;i<256;++i)e._layers.push(null);return e}return ee(t,rp),J(t,[{key:"build",value:function(e){return this._tileSize=e.tileSize,this._blockCount[0]=e.blockCount[0],this._blockCount[1]=e.blockCount[1],this._weightMapSize=e.weightMapSize,this._lightMapSize=e.lightMapSize,this._buildImp()}},{key:"rebuild",value:function(e){for(var t=[],i=0;i<e.blockCount[0]*e.blockCount[1];++i)t.push(new V9);for(var n=Math.min(this._blockCount[0],e.blockCount[0]),r=Math.min(this._blockCount[1],e.blockCount[1]),a=0;a<r;++a)for(var o=0;o<n;++o){var s=a*e.blockCount[0]+o,l=a*this.blockCount[0]+o;t[s]=this._blockInfos[l]}this._blockInfos=t;for(var u,c=_e(this._blocks);!(u=c()).done;){u.value.destroy()}this._blocks=[],this._rebuildHeights(e),this._rebuildWeights(e),this._tileSize=e.tileSize,this._blockCount[0]=e.blockCount[0],this._blockCount[1]=e.blockCount[1],this._weightMapSize=e.weightMapSize,this._lightMapSize=e.lightMapSize,this._buildNormals();for(var h=0;h<this._blockCount[1];++h)for(var p=0;p<this._blockCount[0];++p)this._blocks.push(new W9(this,p,h));for(var _,f=_e(this._blocks);!(_=f()).done;){_.value.build()}}},{key:"importHeightField",value:function(e,t){for(var i=0,n=0;n<this.vertexCount[1];++n)for(var r=0;r<this.vertexCount[0];++r){var a=r/this.tileCount[0],o=n/this.tileCount[1],s=e.getAt(a*e.w,o*e.h)*t;this._heights[i++]=s}this._buildNormals();for(var l,u=_e(this._blocks);!(l=u()).done;){l.value._updateHeight()}}},{key:"exportHeightField",value:function(e,t){for(var i=0,n=0;n<e.h;++n)for(var r=0;r<e.w;++r){var a=r/(e.w-1),o=n/(e.h-1),s=a*this.size.width,l=o*this.size.height,u=this.getHeightAt(s,l);null!=u&&(e.data[i++]=u*t)}}},{key:"exportAsset",value:function(){var e=new B9;e.tileSize=this.tileSize,e.blockCount=this.blockCount,e.lightMapSize=this.lightMapSize,e.weightMapSize=this.weightMapSize,e.heights=this.heights,e.weights=this.weights,e.layerBuffer=new Array(4*this._blocks.length);for(var t=0;t<this._blocks.length;++t)e.layerBuffer[4*t+0]=this._blocks[t].layers[0],e.layerBuffer[4*t+1]=this._blocks[t].layers[1],e.layerBuffer[4*t+2]=this._blocks[t].layers[2],e.layerBuffer[4*t+3]=this._blocks[t].layers[3];for(var i=0;i<this._layers.length;++i){var n=this._layers[i];if(n&&n.detailMap&&ul(n.detailMap)){var r=new z9;r.slot=i,r.tileSize=n.tileSize,r.detailMap=n.detailMap._uuid,e.layerInfos.push(r)}}return e}},{key:"onLoad",value:function(){for(var e=cc.director.root.device,t=new Uint16Array(6144),i=0,n=0;n<32;++n)for(var r=0;r<32;++r){var a=33*n+r,o=33*n+r+1,s=33*(n+1)+r,l=33*(n+1)+r+1;t[i++]=a,t[i++]=s,t[i++]=o,t[i++]=o,t[i++]=s,t[i++]=l}this._sharedIndexBuffer=e.createBuffer({usage:exports.GFXBufferUsageBit.INDEX|exports.GFXBufferUsageBit.TRANSFER_DST,memUsage:exports.GFXMemoryUsageBit.HOST|exports.GFXMemoryUsageBit.DEVICE,size:32*Uint16Array.BYTES_PER_ELEMENT*32*6,stride:Uint16Array.BYTES_PER_ELEMENT}),this._sharedIndexBuffer.update(t)}},{key:"onEnable",value:function(){0===this._blocks.length&&this._buildImp()}},{key:"onDisable",value:function(){for(var e,t=_e(this._blocks);!(e=t()).done;){e.value.destroy()}this._blocks=[]}},{key:"onDestroy",value:function(){for(var e=0;e<this._layers.length;++e)this._layers[e]=null;null!=this._sharedIndexBuffer&&this._sharedIndexBuffer.destroy()}},{key:"onRestore",value:function(){this.onDisable(),this.onLoad(),this._buildImp(!0)}},{key:"update",value:function(e){for(var t,i=_e(this._blocks);!(t=i()).done;){t.value.update()}}},{key:"addLayer",value:function(e){for(var t=0;t<this._layers.length;++t)if(null==this._layers[t])return this._layers[t]=e,t;return-1}},{key:"setLayer",value:function(e,t){this._layers[e]=t}},{key:"removeLayer",value:function(e){this._layers[e]=null}},{key:"getLayer",value:function(e){return-1===e?null:this._layers[e]}},{key:"getPosition",value:function(e,t){var i=e*this._tileSize,n=t*this._tileSize,r=this.getHeight(e,t);return new Ii(i,r,n)}},{key:"getHeightField",value:function(){return this._heights}},{key:"setHeight",value:function(e,t,i){i=pi(i,-64,1/512*32767),this._heights[t*this.vertexCount[0]+e]=32768+i/(1/512)}},{key:"getHeight",value:function(e,t){return(this._heights[t*this.vertexCount[0]+e]-32768)*(1/512)}},{key:"getHeightClamp",value:function(e,t){return e=pi(e,0,this.vertexCount[0]-1),t=pi(t,0,this.vertexCount[1]-1),this.getHeight(e,t)}},{key:"getHeightAt",value:function(e,t){var i=e/this.tileSize,n=t/this.tileSize,r=Math.floor(i),a=Math.floor(n),o=r+1,s=a+1,l=i-r,u=n-a;if(r<0||r>this.vertexCount[0]-1||a<0||a>this.vertexCount[1]-1)return null;r=pi(r,0,this.vertexCount[0]-1),a=pi(a,0,this.vertexCount[1]-1),o=pi(o,0,this.vertexCount[0]-1),s=pi(s,0,this.vertexCount[1]-1);var c=this.getHeight(r,a),h=this.getHeight(o,a),p=this.getHeight(r,s),_=this.getHeight(o,s),f=.5*(h+p);return l+u<=1?_=f+(f-c):c=f+(f-_),(c*(1-l)+h*l)*(1-u)+(p*(1-l)+_*l)*u}},{key:"_setNormal",value:function(e,t,i){var n=t*this.vertexCount[0]+e;this._normals[3*n+0]=i.x,this._normals[3*n+1]=i.y,this._normals[3*n+2]=i.z}},{key:"getNormal",value:function(e,t){var i=t*this.vertexCount[0]+e,n=new Ii;return n.x=this._normals[3*i+0],n.y=this._normals[3*i+1],n.z=this._normals[3*i+2],n}},{key:"getNormalAt",value:function(e,t){var i=e/this.tileSize,n=t/this.tileSize,r=Math.floor(i),a=Math.floor(n),o=r+1,s=a+1,l=i-r,u=n-a;if(r<0||r>this.vertexCount[0]-1||a<0||a>this.vertexCount[1]-1)return null;r=pi(r,0,this.vertexCount[0]-1),a=pi(a,0,this.vertexCount[1]-1),o=pi(o,0,this.vertexCount[0]-1),s=pi(s,0,this.vertexCount[1]-1);var c=this.getNormal(r,a),h=this.getNormal(o,a),p=this.getNormal(r,s),_=this.getNormal(o,s),f=new Ii;Ii.add(f,h,p).multiplyScalar(.5),l+u<=1?(_.set(f),_.subtract(c),_.add(f)):(c.set(f),c.subtract(_),c.add(f));var d=new Ii,m=new Ii,v=new Ii;return Ii.lerp(d,c,h,l),Ii.lerp(m,p,_,l),Ii.lerp(v,d,m,u),v}},{key:"setWeight",value:function(e,t,i){var n=t*this._weightMapSize*this._blockCount[0]+e;this._weights[4*n+0]=255*i.x,this._weights[4*n+1]=255*i.y,this._weights[4*n+2]=255*i.z,this._weights[4*n+3]=255*i.w}},{key:"getWeight",value:function(e,t){var i=t*this._weightMapSize*this._blockCount[0]+e,n=new Ni;return n.x=this._weights[4*i+0]/255,n.y=this._weights[4*i+1]/255,n.z=this._weights[4*i+2]/255,n.w=this._weights[4*i+3]/255,n}},{key:"getWeightAt",value:function(e,t){var i=e/this.tileSize,n=t/this.tileSize,r=Math.floor(i),a=Math.floor(n),o=r+1,s=a+1,l=i-r,u=n-a;if(r<0||r>this.vertexCount[0]-1||a<0||a>this.vertexCount[1]-1)return null;r=pi(r,0,this.vertexCount[0]-1),a=pi(a,0,this.vertexCount[1]-1),o=pi(o,0,this.vertexCount[0]-1),s=pi(s,0,this.vertexCount[1]-1);var c=this.getWeight(r,a),h=this.getWeight(o,a),p=this.getWeight(r,s),_=this.getWeight(o,s),f=new Ni;Ni.add(f,h,p).multiplyScalar(.5),l+u<=1?(_=new Ni,Ni.subtract(_,f,c).add(f)):(c=new Ni,Ni.subtract(c,f,_).add(f));var d=new Ni,m=new Ni,v=new Ni;return Ni.lerp(d,c,h,l),Ni.lerp(m,p,_,l),Ni.lerp(v,d,m,u),v}},{key:"getBlockInfo",value:function(e,t){return this._blockInfos[t*this._blockCount[0]+e]}},{key:"getBlock",value:function(e,t){return this._blocks[t*this._blockCount[0]+e]}},{key:"getBlocks",value:function(){return this._blocks}},{key:"rayCheck",value:function(e,t,i){var n=!(arguments.length>3&&void 0!==arguments[3])||arguments[3],r=2e3,a=e;n&&Ii.subtract(a,e,this.node.getWorldPosition());var o=new Ii;o.set(t),o.multiplyScalar(i);var s=null;if(t.equals(new Ii(0,1,0))){var l=this.getHeightAt(a.x,a.z);null!=l&&a.y<=l&&(s=new Ii(a.x,l,a.z))}else if(t.equals(new Ii(0,-1,0))){var u=this.getHeightAt(a.x,a.z);null!=u&&a.y>=u&&(s=new Ii(a.x,u,a.z))}else{for(var c=0;c++<r;){var h=this.getHeightAt(a.x,a.z);if(null!=h&&a.y<=h)break;a.add(t)}for(;c++<r;){var p=this.getHeightAt(a.x,a.z);if(null!=p&&a.y<=p){s=new Ii(a.x,p,a.z);break}a.add(o)}}return s}},{key:"_getSharedIndexBuffer",value:function(){return this._sharedIndexBuffer}},{key:"_resetLightmap",value:function(e){if(this._lightmapInfos.length=0,e)for(var t=0;t<this._blockCount[0]*this._blockCount[1];++t)this._lightmapInfos.push(new H9)}},{key:"_updateLightmap",value:function(e,t,i,n,r,a){this._lightmapInfos[e].texture=t,this._lightmapInfos[e].UOff=i,this._lightmapInfos[e].VOff=n,this._lightmapInfos[e].UScale=r,this._lightmapInfos[e].VScale=a,this._blocks[e]._updateLightmap(this._lightmapInfos[e])}},{key:"_getLightmapInfo",value:function(e,t){var i=t*this._blockCount[0]+e;return i<this._lightmapInfos.length?this._lightmapInfos[i]:null}},{key:"_calcNormal",value:function(e,t){var i,n,r=1,a=this.getPosition(e,t);e<this.vertexCount[0]-1?i=this.getPosition(e+1,t):(r*=-1,i=this.getPosition(e-1,t)),t<this.vertexCount[1]-1?n=this.getPosition(e,t+1):(r*=-1,n=this.getPosition(e,t-1)),i.subtract(a),n.subtract(a);var o=new Ii;return o.set(n),o.cross(i),o.multiplyScalar(r),o.normalize(),o}},{key:"_buildNormals",value:function(){for(var e=0,t=0;t<this.vertexCount[1];++t)for(var i=0;i<this.vertexCount[0];++i){var n=this._calcNormal(i,t);this._normals[3*e+0]=n.x,this._normals[3*e+1]=n.y,this._normals[3*e+2]=n.z,e+=1}}},{key:"_buildImp",value:function(){var e=this,t=arguments.length>0&&void 0!==arguments[0]&&arguments[0];if(this.valid)return!0;if(!t&&null!=this.__asset){this._tileSize=this.__asset.tileSize,this._blockCount=this.__asset.blockCount,this._weightMapSize=this.__asset.weightMapSize,this._lightMapSize=this.__asset.lightMapSize,this._heights=this.__asset.heights,this._weights=this.__asset.weights;for(var i=!0,n=0;n<this._layers.length;++n)null!=this._layers[n]&&(i=!1);if(i&&null!=this._asset)for(var r,a=function(){var t=r.value,i=new U9;i.tileSize=t.tileSize,cc.loader.loadRes(t.detailMap,gu,(function(e,t){i.detailMap=t})),e._layers[t.slot]=i},o=_e(this._asset.layerInfos);!(r=o()).done;)a()}if(0===this._blockCount[0]||0===this._blockCount[1])return!1;var s=this.vertexCount[0]*this.vertexCount[1];if(null===this._heights||this._heights.length!==s){this._heights=new Uint16Array(s),this._normals=new Array(3*s);for(var l=0;l<s;++l)this._heights[l]=32768,this._normals[3*l+0]=0,this._normals[3*l+1]=1,this._normals[3*l+2]=0}else this._normals=new Array(3*s),this._buildNormals();var u=this._weightMapSize*this._blockCount[0],c=this._weightMapSize*this._blockCount[1];if(this._weights.length!==u*c*4){this._weights=new Uint8Array(u*c*4);for(var h=0;h<u*c;++h)this._weights[4*h+0]=255,this._weights[4*h+1]=0,this._weights[4*h+2]=0,this._weights[4*h+3]=0}if(this._blockInfos.length!==this._blockCount[0]*this._blockCount[1]){this._blockInfos=[];for(var p=0;p<this._blockCount[1];++p)for(var _=0;_<this._blockCount[0];++_){var f=new V9;null!=this._asset&&(f.layers[0]=this._asset.getLayer(_,p,0),f.layers[1]=this._asset.getLayer(_,p,1),f.layers[1]===f.layers[0]&&(f.layers[1]=-1),f.layers[2]=this._asset.getLayer(_,p,2),f.layers[2]===f.layers[0]&&(f.layers[2]=-1),f.layers[3]=this._asset.getLayer(_,p,3),f.layers[3]===f.layers[0]&&(f.layers[3]=-1)),this._blockInfos.push(f)}}for(var d=0;d<this._blockCount[1];++d)for(var m=0;m<this._blockCount[0];++m)this._blocks.push(new W9(this,m,d));for(var v,y=_e(this._blocks);!(v=y()).done;){var g=v.value;g.build()}}},{key:"_rebuildHeights",value:function(e){if(this.vertexCount[0]===e.vertexCount[0]&&this.vertexCount[1]===e.vertexCount[1])return!1;for(var t=new Uint16Array(e.vertexCount[0]*e.vertexCount[1]),i=0;i<t.length;++i)t[i]=32768;for(var n=Math.min(this.vertexCount[0],e.vertexCount[0]),r=Math.min(this.vertexCount[1],e.vertexCount[1]),a=0;a<r;++a)for(var o=0;o<n;++o){var s=a*e.vertexCount[0]+o,l=a*this.vertexCount[0]+o;t[s]=this._heights[l]}return this._heights=t,!0}},{key:"_rebuildWeights",value:function(e){var t=this,i=this._weightMapSize,n=this._weightMapSize*this._blockCount[0],r=this._weightMapSize*this._blockCount[1],a=e.weightMapSize*e.blockCount[0],o=e.weightMapSize*e.blockCount[1];if(a===n&&o===r)return!1;for(var s=new Uint8Array(a*o*4),l=0;l<a*o;++l)s[4*l+0]=255,s[4*l+1]=0,s[4*l+2]=0,s[4*l+3]=0;for(var u=Math.min(e.blockCount[0],this._blockCount[0]),c=Math.min(e.blockCount[1],this._blockCount[1]),h=function(e,t,i){var r=t*n+e,a=new Ni;return a.x=i[4*r+0]/255,a.y=i[4*r+1]/255,a.z=i[4*r+2]/255,a.w=i[4*r+3]/255,a},p=function(e,i,n,r,a){var o=Math.floor(e),s=Math.floor(i),l=o+1,u=s+1,c=e-o,p=i-s,_=h(o+n,s+r,t._weights),f=h(l+n,s+r,t._weights),d=h(o+n,u+r,t._weights),m=h(l+n,u+r,t._weights),v=new Ni;Ni.add(v,f,d).multiplyScalar(.5),c+p<=1?(m.set(v),m.subtract(_),m.add(v)):(_.set(v),_.subtract(m),_.add(v));var y=new Ni,g=new Ni,x=new Ni;return Ni.lerp(y,_,f,c),Ni.lerp(g,d,m,c),Ni.lerp(x,y,g,p),x},_=0;_<c;++_)for(var f=0;f<u;++f)for(var d=f*i,m=_*i,v=0;v<e.weightMapSize;++v)for(var y=0;y<e.weightMapSize;++y){var g=void 0;if(e.weightMapSize===i)g=h(y+d,v+m,this._weights);else g=p(y/(e.weightMapSize-1)*(i-1),v/(e.weightMapSize-1)*(i-1),d,m,this._weights);var x=f*e.weightMapSize+y,b=(_*e.weightMapSize+v)*a+x;s[4*b+0]=255*g.x,s[4*b+1]=255*g.y,s[4*b+2]=255*g.z,s[4*b+3]=255*g.w}return this._weights=s,!0}},{key:"_asset",set:function(e){if(this.__asset!==e&&(this.__asset=e,null!=this.__asset&&this.valid)){for(var t,i=_e(this._blocks);!(t=i()).done;){t.value.destroy()}this._blocks=[],this._blockInfos=[],this._buildImp()}},get:function(){return this.__asset}},{key:"size",get:function(){var e=new en(0,0);return e.width=32*this.blockCount[0]*this.tileSize,e.height=32*this.blockCount[1]*this.tileSize,e}},{key:"tileSize",get:function(){return this._tileSize}},{key:"tileCount",get:function(){return[32*this.blockCount[0],32*this.blockCount[1]]}},{key:"vertexCount",get:function(){var e=this.tileCount;return e[0]+=1,e[1]+=1,e}},{key:"blockCount",get:function(){return this._blockCount}},{key:"lightMapSize",get:function(){return this._lightMapSize}},{key:"weightMapSize",get:function(){return this._weightMapSize}},{key:"heights",get:function(){return this._heights}},{key:"weights",get:function(){return this._weights}},{key:"valid",get:function(){return this._blocks.length>0}},{key:"info",get:function(){var e=new G9;return e.tileSize=this.tileSize,e.blockCount[0]=this.blockCount[0],e.blockCount[1]=this.blockCount[1],e.weightMapSize=this.weightMapSize,e.lightMapSize=this.lightMapSize,e}}]),t}()).prototype,"__asset",[E9],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return null}}),I9=de(F9.prototype,"_layers",[w9],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return[]}}),P9=de(F9.prototype,"_blockInfos",[C9],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return[]}}),L9=de(F9.prototype,"_lightmapInfos",[A9],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return[]}}),de(F9.prototype,"_asset",[O9],Object.getOwnPropertyDescriptor(F9.prototype,"_asset"),F9.prototype),de(F9.prototype,"info",[k9],Object.getOwnPropertyDescriptor(F9.prototype,"info"),F9.prototype),R9=F9))||R9)||R9)||R9)||R9);exports.Acceleration=YS,exports.AffineTransform=$i,exports.AnimCurve=_I,exports.AnimationManager=dP,exports.AnimationState=qI,exports.Asset=zl,exports.AssetLibrary=kd,exports.AudioSourceComponent=O7,exports.BASELINE_RATIO=.26,exports.BaseNode=wy,exports.BatchedSkinningModelComponent=$R,exports.BatchingUtility=Yp,exports.BillboardComponent=vQ,exports.BitMask=gt,exports.BitmapFont=jd,exports.BlockInputEventsComponent=ak,exports.BoxColliderComponent=$8,exports.ButtonComponent=_N,exports.CCBoolean=Mt,exports.CCClass=ni,exports.CCFloat=Ft,exports.CCInteger=Rt,exports.CCObject=sl,exports.CCString=It,exports.CachedArray=Eo,exports.CanvasComponent=qk,exports.CanvasPool=tz,exports.CapsuleColliderComponent=r7,exports.ColliderComponent=J8,exports.Color=an,exports.CompactValueTypeArray=N_,exports.Component=rp,exports.ComponentModifier=KP,exports.ConstantForce=l7,exports.CubicSplineNumberValue=xM,exports.CubicSplineQuatValue=gM,exports.CubicSplineVec2Value=mM,exports.CubicSplineVec3Value=vM,exports.CubicSplineVec4Value=yM,exports.CurveRange=SQ,exports.CurveValueAdapter=ZP,exports.CylinderColliderComponent=a7,exports.DirectionalLightComponent=YF,exports.Director=iO,exports.Downloader=bm,exports.EPSILON=ui,exports.EditBoxComponent=VB,exports.EffectAsset=Lh,exports.Enum=xt,exports.Event=al,exports.EventAcceleration=Sv,exports.EventHandler=fO,exports.EventInfo=fI,exports.EventKeyboard=Ev,exports.EventMouse=bv,exports.EventTarget=gl,exports.EventTouch=Tv,exports.Eventify=vl,exports.Font=Ld,exports.ForwardFlow=FS,exports.ForwardPipeline=GS,exports.ForwardStage=RS,exports.GFXBindingLayout=Yr,exports.GFXBindingUnit=function e(){Z(this,e),this.binding=0,this.type=exports.GFXBindingType.UNKNOWN,this.name="",this.buffer=null,this.texView=null,this.sampler=null},exports.GFXBlendState=Dr,exports.GFXBlendTarget=Lr,exports.GFXBuffer=Ar,exports.GFXBufferTextureCopy=vr,exports.GFXColorAttachment=function e(){Z(this,e),this.format=exports.GFXFormat.UNKNOWN,this.loadOp=exports.GFXLoadOp.CLEAR,this.storeOp=exports.GFXStoreOp.STORE,this.sampleCount=1,this.beginLayout=exports.GFXTextureLayout.COLOR_ATTACHMENT_OPTIMAL,this.endLayout=exports.GFXTextureLayout.COLOR_ATTACHMENT_OPTIMAL},exports.GFXCommandAllocator=Kr,exports.GFXCommandBuffer=Or,exports.GFXDepthStencilAttachment=function e(){Z(this,e),this.format=exports.GFXFormat.UNKNOWN,this.depthLoadOp=exports.GFXLoadOp.CLEAR,this.depthStoreOp=exports.GFXStoreOp.STORE,this.stencilLoadOp=exports.GFXLoadOp.CLEAR,this.stencilStoreOp=exports.GFXStoreOp.STORE,this.sampleCount=1,this.beginLayout=exports.GFXTextureLayout.DEPTH_STENCIL_ATTACHMENT_OPTIMAL,this.endLayout=exports.GFXTextureLayout.DEPTH_STENCIL_ATTACHMENT_OPTIMAL},exports.GFXDepthStencilState=Pr,exports.GFXDevice=kr,exports.GFXFormatInfos=yr,exports.GFXFormatSize=gr,exports.GFXFormatSurfaceSize=xr,exports.GFXFramebuffer=Rr,exports.GFXGetTypeSize=Tr,exports.GFXInputAssembler=Fr,exports.GFXInputState=Nr,exports.GFXObject=_r,exports.GFXPipelineLayout=Mr,exports.GFXPipelineState=zr,exports.GFXQueue=Br,exports.GFXRasterizerState=Ir,exports.GFXRenderPass=Gr,exports.GFXSampler=Xr,exports.GFXSamplerState=Ur,exports.GFXShader=Vr,exports.GFXTexture=jr,exports.GFXTextureCopy=mr,exports.GFXTextureSubres=dr,exports.GFXTextureView=qr,exports.GFXUniform=function e(){Z(this,e),this.name="",this.type=exports.GFXType.UNKNOWN,this.count=1},exports.GFXUniformBlock=function e(){Z(this,e),this.binding=-1,this.name="",this.members=[]},exports.GFXUniformSampler=function e(){Z(this,e),this.binding=-1,this.name="",this.type=exports.GFXType.UNKNOWN,this.count=1},exports.GFXWindow=Zr,exports.GFX_DRAW_INFO_SIZE=56,exports.GFX_MAX_ATTACHMENTS=4,exports.GFX_MAX_BUFFER_BINDINGS=24,exports.GFX_MAX_TEXTURE_UNITS=16,exports.GFX_MAX_VERTEX_ATTRIBUTES=16,exports.Game=ZS,exports.GraphicsComponent=BG,exports.HeightField=D9,exports.HierachyModifier=YP,exports.HtmlTextParser=No,exports.ImageAsset=Gl,exports.IsPowerOf2=Hr,exports.JavaScript=Uh,exports.JsonAsset=Cf,exports.LabelAtlas=qd,exports.LabelComponent=iz,exports.LabelOutlineComponent=jU,exports.Layers=bu,exports.LayoutComponent=bG,exports.LineComponent=UJ,exports.Loader=Gm,exports.LoadingItems=Zf,exports.MaskComponent=cU,exports.Mat3=Bi,exports.Mat4=Ki,exports.Material=Bh,exports.Mesh=rc,exports.MeshBuffer=jA,exports.MeshColliderComponent=o7,exports.MissingScript=__,exports.Node=tg,exports.NodeActivator=Db,exports.NodePool=wL,exports.PageViewComponent=Mj,exports.PageViewIndicatorComponent=vj,exports.ParticleSystemComponent=W5,exports.ParticleUtils=j5,exports.PhysicMaterial=g8,exports.PhysicsRayResult=x8,exports.PhysicsSystem=b8,exports.Pipeline=$f,exports.Pool=To,exports.Prefab=_f,exports.PrefabInfo=xs,exports.PrivateNode=ix,exports.Profiler=hL,exports.ProgressBarComponent=bU,exports.Quat=Xi,exports.RatioSampler=pI,exports.RawAsset=Al,exports.Rect=nn,exports.RecyclePool=So,exports.RenderFlow=BT,exports.RenderPipeline=jT,exports.RenderPipelineAsset=qT,exports.RenderStage=AT,exports.RenderTexture=gc,exports.RenderView=QT,exports.RenderableComponent=Hp,exports.ResolutionPolicy=iE,exports.RichTextComponent=pX,exports.RigidBodyComponent=s7,exports.Scene=$g,exports.SceneAsset=vf,exports.Scheduler=VA,exports.Script=Gh,exports.ScrollBarComponent=xX,exports.ScrollViewComponent=TV,exports.Size=en,exports.SkelAnimDataHub=RE,exports.SkeletalAnimationComponent=qP,exports.SkeletalAnimationState=zP,exports.Skeleton=uv,exports.SkinningModelComponent=jR,exports.SkinningModelUnit=ZR,exports.SliderComponent=LV,exports.Socket=BP,exports.SphereColliderComponent=e6,exports.SphereLightComponent=KF,exports.SpotLightComponent=ZF,exports.SpriteAtlas=bf,exports.SpriteComponent=LA,exports.SpriteFrame=Ac,exports.StencilManager=qA,exports.SubContextView=DA,exports.System=NA,exports.SystemEvent=lE,exports.TERRAIN_BLOCK_TILE_COMPLEXITY=32,exports.TERRAIN_BLOCK_VERTEX_COMPLEXITY=33,exports.TERRAIN_BLOCK_VERTEX_SIZE=8,exports.TERRAIN_DATA_VERSION=16842753,exports.TERRAIN_DATA_VERSION2=16842754,exports.TERRAIN_DATA_VERSION3=16842755,exports.TERRAIN_DATA_VERSION_DEFAULT=16843025,exports.TERRAIN_EAST_INDEX=3,exports.TERRAIN_HEIGHT_BASE=32768,exports.TERRAIN_HEIGHT_FACTORY=1/512,exports.TERRAIN_HEIGHT_FMAX=1/512*32767,exports.TERRAIN_HEIGHT_FMIN=-64,exports.TERRAIN_MAX_BLEND_LAYERS=4,exports.TERRAIN_MAX_LAYER_COUNT=256,exports.TERRAIN_MAX_LEVELS=4,exports.TERRAIN_NORTH_INDEX=0,exports.TERRAIN_SOUTH_INDEX=1,exports.TERRAIN_WEST_INDEX=2,exports.TTFFont=Hd,exports.Terrain=j9,exports.TerrainAsset=B9,exports.TerrainBlock=W9,exports.TerrainBlockInfo=V9,exports.TerrainBlockLightmapInfo=H9,exports.TerrainInfo=G9,exports.TerrainLayer=U9,exports.TerrainLayerInfo=z9,exports.TextAsset=wf,exports.Texture2D=gu,exports.TextureCube=Oc,exports.ToggleComponent=nH,exports.ToggleContainerComponent=eH,exports.ToneMapFlow=PS,exports.ToneMapStage=IS,exports.Touch=VS,exports.Tween=J7,exports.TweenSystem=M7,exports.TypeScript=tp,exports.UIComponent=jC,exports.UICoordinateTrackerComponent=oM,exports.UIModelComponent=sH,exports.UIOpacityComponent=Nj,exports.UIRenderComponent=wA,exports.UIReorderComponent=LW,exports.UIStaticBatchComponent=Dj,exports.UITransformComponent=Iy,exports.UIVertexFormat=$A,exports.UniformCurveValueAdapter=QP,exports.ValueType=Tt,exports.Vec2=ki,exports.Vec3=Ii,exports.Vec4=Ni,exports.View=$S,exports.ViewGroupComponent=QX,exports.WebviewComponent=cW,exports.WorldNode3DToLocalNodeUI=Zp,exports.WorldNode3DToWorldNodeUI=Qp,exports._decorator=gs,exports.absMax=Oi,exports.absMaxComponent=Ai,exports.animation=bM,exports.approx=hi,exports.assert=p,exports.assertID=E,exports.barFilled=$K,exports.bezier=SM,exports.bezierByTime=RM,exports.bits=Y,exports.bmfont=AY,exports.builtinResMgr=Pc,exports.ccenum=bt,exports.cclegacy=CL,exports.clamp=pi,exports.clamp01=_i,exports.color=on,exports.computeRatioByType=mI,exports.convertUtils=h_,exports.deserialize=v_,exports.director=_O,exports.easing=cI,exports.effects=Mc,exports.equals=ci,exports.error=h,exports.errorID=b,exports.eventManager=Pv,exports.find=ex,exports.fragmentText=Po,exports.game=QS,exports.geometry=bo,exports.getPathFromRoot=function(e,t){for(var i=e,n="";null!==i&&i!==t;)n="".concat(i.name,"/").concat(n),i=i.parent;return n.slice(0,-1)},exports.getTypedArrayConstructor=Sr,exports.getWorldTransformUntilRoot=IE,exports.graphics=qq,exports.graphicsAssembler=Yq,exports.instantiate=M_,exports.inverseLerp=Ci,exports.isCustomTargetModifier=eL,exports.isDisplayStats=C,exports.isElementModifier=$P,exports.isPropertyModifier=JP,exports.isUnicodeCJK=Fo,exports.isUnicodeSpace=Mo,exports.isValid=ul,exports.js=nt,exports.labelAssembler=WK,exports.lerp=fi,exports.letter=dK,exports.loader=Ym,exports.log=u,exports.logID=v,exports.macro=cu,exports.mask=qK,exports.maskEnd=YK,exports.mat4=Ji,exports.math=_n,exports.memop=wo,exports.misc=yt,exports.murmurhash2_32_gc=rl,exports.nextPow2=Si,exports.path=X,exports.pingPong=wi,exports.pipeline=US,exports.primitives=jw,exports.profiler=pL,exports.pseudoRandom=xi,exports.pseudoRandomRange=bi,exports.pseudoRandomRangeInt=Ti,exports.quat=Yi,exports.radialFilled=pZ,exports.random=vi,exports.randomRange=yi,exports.randomRangeInt=gi,exports.rect=rn,exports.renderer=WC,exports.repeat=Ei,exports.safeMeasureText=Io,exports.sampleAnimationCurve=dI,exports.screen=cE,exports.setDefaultLogTimes=function(e){e>0&&(cn=e)},exports.setDisplayStats=A,exports.simple=dZ,exports.size=tn,exports.sliced=yZ,exports.spriteAssembler=zZ,exports.sys=Cs,exports.systemEvent=uE,exports.textureUtil=lv,exports.toDegree=mi,exports.toRadian=di,exports.ttf=HK,exports.tween=$7,exports.tweenUtil=e9,exports.url=Mf,exports.utils=gw,exports.v2=Mi,exports.v3=Di,exports.v4=zi,exports.view=nE,exports.warn=c,exports.warnID=g,exports.widgetManager=jj;
//# sourceMappingURL=f22c138356e00e1a379dc6509adb1208.map
